<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 System description | The Fabric of Interactive Visualization</title>
  <meta name="description" content="7 System description | The Fabric of Interactive Visualization" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="7 System description | The Fabric of Interactive Visualization" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 System description | The Fabric of Interactive Visualization" />
  
  
  

<meta name="author" content="Adam Bartonicek" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="goals.html"/>
<link rel="next" href="applied-example.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="acknowledgements.html"><a href="acknowledgements.html"><i class="fa fa-check"></i><b>2</b> Acknowledgements</a></li>
<li class="chapter" data-level="3" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>3</b> Introduction</a></li>
<li class="chapter" data-level="4" data-path="background.html"><a href="background.html"><i class="fa fa-check"></i><b>4</b> Background</a>
<ul>
<li class="chapter" data-level="4.1" data-path="background.html"><a href="background.html#brief-history"><i class="fa fa-check"></i><b>4.1</b> Brief history of interactive data visualization</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="background.html"><a href="background.html#static-visualization"><i class="fa fa-check"></i><b>4.1.1</b> Static data visualization: From ancient times to the space age</a></li>
<li class="chapter" data-level="4.1.2" data-path="background.html"><a href="background.html#early-interactive"><i class="fa fa-check"></i><b>4.1.2</b> Early interactive data visualization: By statisticians for statisticians</a></li>
<li class="chapter" data-level="4.1.3" data-path="background.html"><a href="background.html#web-based"><i class="fa fa-check"></i><b>4.1.3</b> Interactive data visualization and the internet: Web-based interactivity</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="background.html"><a href="background.html#what-is-interactive-visualization"><i class="fa fa-check"></i><b>4.2</b> What even is interactive data visualization?</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="background.html"><a href="background.html#interactive-interacting"><i class="fa fa-check"></i><b>4.2.1</b> Interactive vs.Â interacting with</a></li>
<li class="chapter" data-level="4.2.2" data-path="background.html"><a href="background.html#interactive-enough"><i class="fa fa-check"></i><b>4.2.2</b> Interactive <em>enough</em>?</a></li>
<li class="chapter" data-level="4.2.3" data-path="background.html"><a href="background.html#complexity-of-features"><i class="fa fa-check"></i><b>4.2.3</b> Complexity of interactive features</a></li>
<li class="chapter" data-level="4.2.4" data-path="background.html"><a href="background.html#working-definition"><i class="fa fa-check"></i><b>4.2.4</b> Working definition</a></li>
<li class="chapter" data-level="4.2.5" data-path="background.html"><a href="background.html#common-features"><i class="fa fa-check"></i><b>4.2.5</b> Common interactive features</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="background.html"><a href="background.html#overview-of-broader-data-visualization-topics"><i class="fa fa-check"></i><b>4.3</b> Overview of broader data visualization topics</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="background.html"><a href="background.html#visualization-goals"><i class="fa fa-check"></i><b>4.3.1</b> Visualization goals</a></li>
<li class="chapter" data-level="4.3.2" data-path="background.html"><a href="background.html#visual-perception"><i class="fa fa-check"></i><b>4.3.2</b> Visual perception</a></li>
<li class="chapter" data-level="4.3.3" data-path="background.html"><a href="background.html#scales-measurement"><i class="fa fa-check"></i><b>4.3.3</b> Scales and measurement</a></li>
<li class="chapter" data-level="4.3.4" data-path="background.html"><a href="background.html#graphics-formats"><i class="fa fa-check"></i><b>4.3.4</b> Graphics formats</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="background.html"><a href="background.html#summary"><i class="fa fa-check"></i><b>4.4</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="problems.html"><a href="problems.html"><i class="fa fa-check"></i><b>5</b> Challenges</a>
<ul>
<li class="chapter" data-level="5.0.1" data-path="problems.html"><a href="problems.html#the-structure-of-this-chapter-data-visualization-pipeline"><i class="fa fa-check"></i><b>5.0.1</b> The structure of this chapter: Data visualization pipeline</a></li>
<li class="chapter" data-level="5.1" data-path="problems.html"><a href="problems.html#partitioning"><i class="fa fa-check"></i><b>5.1</b> Partitioning</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="problems.html"><a href="problems.html#show-all-data"><i class="fa fa-check"></i><b>5.1.1</b> Showing the full data</a></li>
<li class="chapter" data-level="5.1.2" data-path="problems.html"><a href="problems.html#comparison-disjointness"><i class="fa fa-check"></i><b>5.1.2</b> Comparison and disjointness</a></li>
<li class="chapter" data-level="5.1.3" data-path="problems.html"><a href="problems.html#plots-as-partitions"><i class="fa fa-check"></i><b>5.1.3</b> Plots as partitions</a></li>
<li class="chapter" data-level="5.1.4" data-path="problems.html"><a href="problems.html#hierarchy"><i class="fa fa-check"></i><b>5.1.4</b> Partitions, hierarchy, and preorders</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="problems.html"><a href="problems.html#aggregation"><i class="fa fa-check"></i><b>5.2</b> Aggregation</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="problems.html"><a href="problems.html#the-relationship-between-graphics-and-statistics"><i class="fa fa-check"></i><b>5.2.1</b> The relationship between graphics and statistics</a></li>
<li class="chapter" data-level="5.2.2" data-path="problems.html"><a href="problems.html#aggregation-category-theory"><i class="fa fa-check"></i><b>5.2.2</b> Stackable summaries: A brief journey into Category Theory</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="problems.html"><a href="problems.html#scaling"><i class="fa fa-check"></i><b>5.3</b> Scaling and encoding</a></li>
<li class="chapter" data-level="5.4" data-path="problems.html"><a href="problems.html#rendering"><i class="fa fa-check"></i><b>5.4</b> Rendering</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="problems.html"><a href="problems.html#frames"><i class="fa fa-check"></i><b>5.4.1</b> Frames</a></li>
<li class="chapter" data-level="5.4.2" data-path="problems.html"><a href="problems.html#geoms"><i class="fa fa-check"></i><b>5.4.2</b> Geoms</a></li>
<li class="chapter" data-level="5.4.3" data-path="problems.html"><a href="problems.html#auxiliary-elements"><i class="fa fa-check"></i><b>5.4.3</b> Auxiliary graphical elements</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="problems.html"><a href="problems.html#summary-1"><i class="fa fa-check"></i><b>5.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="goals.html"><a href="goals.html"><i class="fa fa-check"></i><b>6</b> Goals</a>
<ul>
<li class="chapter" data-level="6.1" data-path="goals.html"><a href="goals.html#user-profile"><i class="fa fa-check"></i><b>6.1</b> User profile</a></li>
<li class="chapter" data-level="6.2" data-path="goals.html"><a href="goals.html#programming-interface"><i class="fa fa-check"></i><b>6.2</b> Programming interface</a></li>
<li class="chapter" data-level="6.3" data-path="goals.html"><a href="goals.html#user-interface"><i class="fa fa-check"></i><b>6.3</b> User interface</a></li>
<li class="chapter" data-level="6.4" data-path="goals.html"><a href="goals.html#interactive-features"><i class="fa fa-check"></i><b>6.4</b> Interactive features</a></li>
<li class="chapter" data-level="6.5" data-path="goals.html"><a href="goals.html#summary-2"><i class="fa fa-check"></i><b>6.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="system.html"><a href="system.html"><i class="fa fa-check"></i><b>7</b> System description</a>
<ul>
<li class="chapter" data-level="7.1" data-path="system.html"><a href="system.html#core-requirements"><i class="fa fa-check"></i><b>7.1</b> Core requirements</a></li>
<li class="chapter" data-level="7.2" data-path="system.html"><a href="system.html#high-level-api"><i class="fa fa-check"></i><b>7.2</b> High-level API (<code>plotscaper</code>)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="system.html"><a href="system.html#api-design"><i class="fa fa-check"></i><b>7.2.1</b> API design</a></li>
<li class="chapter" data-level="7.2.2" data-path="system.html"><a href="system.html#basic-example"><i class="fa fa-check"></i><b>7.2.2</b> Basic example</a></li>
<li class="chapter" data-level="7.2.3" data-path="system.html"><a href="system.html#scene-and-schema"><i class="fa fa-check"></i><b>7.2.3</b> The scene and the schema</a></li>
<li class="chapter" data-level="7.2.4" data-path="system.html"><a href="system.html#client-server"><i class="fa fa-check"></i><b>7.2.4</b> Client-server communication</a></li>
<li class="chapter" data-level="7.2.5" data-path="system.html"><a href="system.html#html-embedding"><i class="fa fa-check"></i><b>7.2.5</b> HTML embedding</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="system.html"><a href="system.html#overview-of-the-system-model"><i class="fa fa-check"></i><b>7.3</b> Overview of the system model</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="system.html"><a href="system.html#model-pipeline"><i class="fa fa-check"></i><b>7.3.1</b> The interactive data visualization pipeline</a></li>
<li class="chapter" data-level="7.3.2" data-path="system.html"><a href="system.html#scene-model"><i class="fa fa-check"></i><b>7.3.2</b> Scene model</a></li>
<li class="chapter" data-level="7.3.3" data-path="system.html"><a href="system.html#plot-model"><i class="fa fa-check"></i><b>7.3.3</b> Plot model</a></li>
<li class="chapter" data-level="7.3.4" data-path="system.html"><a href="system.html#hierarchical-data-summaries-computation-transformation-and-encoding"><i class="fa fa-check"></i><b>7.3.4</b> Hierarchical data summaries: computation, transformation, and encoding</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="system.html"><a href="system.html#low-level-implementation"><i class="fa fa-check"></i><b>7.4</b> Low-level implementation (<code>plotscape</code>)</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="system.html"><a href="system.html#programming-paradigm"><i class="fa fa-check"></i><b>7.4.1</b> Programming paradigm</a></li>
<li class="chapter" data-level="7.4.2" data-path="system.html"><a href="system.html#row-column"><i class="fa fa-check"></i><b>7.4.2</b> Data representation: Row-oriented vs.Â column-oriented</a></li>
<li class="chapter" data-level="7.4.3" data-path="system.html"><a href="system.html#reactivity"><i class="fa fa-check"></i><b>7.4.3</b> Reactivity</a></li>
<li class="chapter" data-level="7.4.4" data-path="system.html"><a href="system.html#components"><i class="fa fa-check"></i><b>7.4.4</b> System components</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="applied-example.html"><a href="applied-example.html"><i class="fa fa-check"></i><b>8</b> Applied example</a>
<ul>
<li class="chapter" data-level="8.1" data-path="applied-example.html"><a href="applied-example.html#exploration-of-the-long-term-care-data-set"><i class="fa fa-check"></i><b>8.1</b> Exploration of the Long-term Care Data Set</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="applied-example.html"><a href="applied-example.html#about-the-data-set"><i class="fa fa-check"></i><b>8.1.1</b> About the data set</a></li>
<li class="chapter" data-level="8.1.2" data-path="applied-example.html"><a href="applied-example.html#interactive-exploration"><i class="fa fa-check"></i><b>8.1.2</b> Interactive exploration</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="applied-example.html"><a href="applied-example.html#summary-3"><i class="fa fa-check"></i><b>8.2</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="discussion.html"><a href="discussion.html"><i class="fa fa-check"></i><b>9</b> Discussion</a>
<ul>
<li class="chapter" data-level="9.1" data-path="discussion.html"><a href="discussion.html#theoretical-model"><i class="fa fa-check"></i><b>9.1</b> Theoretical model</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="discussion.html"><a href="discussion.html#why-the-model-is-necessary"><i class="fa fa-check"></i><b>9.1.1</b> Why the model is necessary</a></li>
<li class="chapter" data-level="9.1.2" data-path="discussion.html"><a href="discussion.html#disjointness"><i class="fa fa-check"></i><b>9.1.2</b> Disjointness</a></li>
<li class="chapter" data-level="9.1.3" data-path="discussion.html"><a href="discussion.html#associativity-unitality"><i class="fa fa-check"></i><b>9.1.3</b> Associativity and unitality</a></li>
<li class="chapter" data-level="9.1.4" data-path="discussion.html"><a href="discussion.html#discussion-groups-inverses"><i class="fa fa-check"></i><b>9.1.4</b> Groups and inverses</a></li>
<li class="chapter" data-level="9.1.5" data-path="discussion.html"><a href="discussion.html#additional-properties-monotonicity-commutativity-and-others"><i class="fa fa-check"></i><b>9.1.5</b> Additional properties: Monotonicity, commutativity, and others</a></li>
<li class="chapter" data-level="9.1.6" data-path="discussion.html"><a href="discussion.html#model-constraints"><i class="fa fa-check"></i><b>9.1.6</b> Model constraints</a></li>
<li class="chapter" data-level="9.1.7" data-path="discussion.html"><a href="discussion.html#potential-future-directions"><i class="fa fa-check"></i><b>9.1.7</b> Potential future directions</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="discussion.html"><a href="discussion.html#delivered-software"><i class="fa fa-check"></i><b>9.2</b> Delivered software</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="discussion.html"><a href="discussion.html#scope-and-features"><i class="fa fa-check"></i><b>9.2.1</b> Scope and features</a></li>
<li class="chapter" data-level="9.2.2" data-path="discussion.html"><a href="discussion.html#declarative-schemas"><i class="fa fa-check"></i><b>9.2.2</b> Declarative schemas and extensibility</a></li>
<li class="chapter" data-level="9.2.3" data-path="discussion.html"><a href="discussion.html#performance"><i class="fa fa-check"></i><b>9.2.3</b> Performance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><b>10</b> Conclusion</a></li>
<li class="chapter" data-level="11" data-path="appendix-glossary.html"><a href="appendix-glossary.html"><i class="fa fa-check"></i><b>11</b> Appendix: Glossary</a></li>
<li class="chapter" data-level="12" data-path="math.html"><a href="math.html"><i class="fa fa-check"></i><b>12</b> Appendix: Mathematical theory</a></li>
<li class="chapter" data-level="13" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>13</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The Fabric of Interactive Visualization</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="system" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">7</span> System description<a href="system.html#system" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This section contains a detailed description of the two software packages developed as part of this doctoral project: (<a href="https://github.com/bartonicek/plotscape">plotscape</a> and <a href="https://github.com/bartonicek/plotscaper">plotscaper</a>):</p>
<ul>
<li><code>plotscape</code>: Written in TypeScript/JavaScript, provides a âlow-levelâ interactive visualization framework and utilities</li>
<li><code>plotscaper</code>: Written in R, provides a âhigh-levelâ wrapper/API for R users</li>
</ul>
<p>A couple of quick general notes. Firstly, the low-level platform (<code>plotscape</code>) was written with client-side web technology stack: JavaScript, HTML, and CSS. Web technologies provide a simple and portable platform for making interactive apps in R and have become the de facto standard, thanks to good integration via packages such as <code>htmlwidgets</code> <span class="citation">(<a href="#ref-htmlwidgets2021">Vaidyanathan et al. 2021</a>)</span> and Shiny <span class="citation">(<a href="#ref-sievert2020">Sievert 2020</a>)</span>. Second, functionality was split across two packages out of practical concerns. To achieve optimal performance and fine-grained control, <code>plotscape</code> was implemented from scratch in TypeScript/JavaScript rather than relying on some JS-in-R wrapper library. <code>plotscaper</code> was then developed to provide a user-friendly R wrapper around <code>plotscape</code>âs functionalities.</p>
<p>As of the time of writing, <code>plotscape</code> comprises of about 6,400 significant lines of code (SLOC; un-minified, primarily TypeScript but also some CSS, includes tests, etcâ¦), and <code>plotscaper</code> contains about 500 SLOC of R code (both counted using <a href="https://github.com/AlDanial/cloc"><code>cloc</code></a>). The unpacked size of all (minified) files is about 200 kilobytes for <code>plotscape</code> and 460 kilobytes for <code>plotscaper</code>, a fairly modest size compared to other interactive data visualization options for R<a href="#fn10" class="footnote-ref" id="fnref10"><sup>10</sup></a>. Both packages have fairly minimal dependencies, which should hopefully make them easy to maintain and extend going forward.</p>
<p>Since the two packages address fairly well-separable concerns - high-level API design vs.Â low-level interactive visualization utilites - I decided to organize this section accordingly. Specifically, I first discuss general, high-level API concerns alongside <code>plotscaper</code>. Then I delve into the low-level implementation details alongside <code>plotscape</code>. There are of course cross-cutting concerns and those will be addressed towards ends of the respective sections. However, first, letâs briefly review the core requirement of the package(s).</p>
<div id="core-requirements" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Core requirements<a href="system.html#core-requirements" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To re-iterate, from Section <a href="goals.html#goals">6</a>, the core requirements for the high-level API (<code>plotscaper</code>) were:</p>
<ul>
<li>Facilitate creation and manipulation of interactive figures for data exploration</li>
<li>Be accessible to a wide range of users with varying levels of experience</li>
<li>Integrate well with popular tools within the R ecosystem</li>
</ul>
<p>These overarching goals, explored further in Section <a href="system.html#high-level-api">7.2</a>, translated into more requirements:</p>
<ul>
<li>Simple and intuitive API for creating and manipulating multi-panel interactive figures (see e.g.Â Sections <a href="system.html#figure-plot">7.2.2.1</a>, <a href="system.html#variables-encodings">7.2.2.3</a>, and <a href="system.html#scene-and-schema">7.2.3</a>)</li>
<li>Support for interactive features such as generalized linked selection, parameter manipulation and representation switching, and other standard features like zooming, panning, and querying (discussed throughout)</li>
<li>Two-way communication between figures and interactive R sessions (see Section <a href="system.html#client-server">7.2.4</a>)</li>
<li>Static embedding capabilities for R Markdown/Quarto documents (see Section <a href="system.html#html-embedding">7.2.5</a>)</li>
</ul>
<p>To realize these goals, it was necessary to design the low-level platform (<code>plotscape</code>) which could support them. The primary purpose of <code>plotscape</code> was to provide utilities for the interactive data visualization pipeline:</p>
<ul>
<li>Splitting the data into a hierarchy of partitions</li>
<li>Computing and transforming summary statistics (e.g.Â stacking, normalizing)</li>
<li>Mapping these summaries to visual encodings (e.g.Â x- and y-axis position, width, height, and area)</li>
<li>Rendering geometric objects and auxiliary graphical elements</li>
<li>Responding to user input and server requests, propagating any required updates throughout the pipeline (reactivity)</li>
</ul>
<p>Section <a href="system.html#low-level-implementation">7.4</a> focuses on the concerns surrounding these more fine-grained implementation details. Specifically, it discusses:</p>
<ul>
<li>The programming paradigm used in <code>plotscape</code> (Section <a href="system.html#programming-paradigm">7.4.1</a>)</li>
<li>Row vs.Â column based data representation (Section <a href="system.html#row-column">7.4.2</a>)</li>
<li>Reactivity (Section <a href="system.html#reactivity">7.4.3</a>)</li>
<li>Specific components of the system and their relations (Section <a href="system.html#components">7.4.4</a>)</li>
</ul>
<p>Note that the most granular implementation details of <code>plotscape</code> are discussed in Section <a href="system.html#components">7.4.4</a> (along with concrete code examples), so some readers may find it easier to start with this section.</p>
</div>
<div id="high-level-api" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> High-level API (<code>plotscaper</code>)<a href="system.html#high-level-api" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In Section <a href="goals.html#goals">6</a>, I already discussed some broad, theoretical ideas related to the packageâs functionality. Here, I focus more on the concrete API - what <code>plotscaper</code> code looks like, how are the users supposed to understand it, and why was the package designed this way. The goal is to provide a rationale for key design decisions and choices.</p>
<div id="api-design" class="section level3 hasAnchor" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> API design<a href="system.html#api-design" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As mentioned in Section <a href="goals.html#goals">6</a>, a primary inspiration for <code>plotscaper</code>âs API was the popular R package <code>ggplot2</code>. In <code>ggplot2</code>, plots are created by chaining together a series of function calls, each adding or modifying a component of an immutable plot schema:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="system.html#cb36-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb36-2"><a href="system.html#cb36-2" tabindex="-1"></a></span>
<span id="cb36-3"><a href="system.html#cb36-3" tabindex="-1"></a><span class="co"># Plots are created by chaining a series of function calls</span></span>
<span id="cb36-4"><a href="system.html#cb36-4" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(wt, mpg)) <span class="sc">+</span></span>
<span id="cb36-5"><a href="system.html#cb36-5" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span>   <span class="co"># The overloaded `+` serves as pipe operator</span></span>
<span id="cb36-6"><a href="system.html#cb36-6" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>))</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="system.html#cb37-1" tabindex="-1"></a><span class="co"># The ggplot() call creates an immutable plot schema</span></span>
<span id="cb37-2"><a href="system.html#cb37-2" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(wt, mpg))</span>
<span id="cb37-3"><a href="system.html#cb37-3" tabindex="-1"></a><span class="fu">names</span>(plot1)</span></code></pre></div>
<pre><code> [1] &quot;data&quot;        &quot;layers&quot;      &quot;scales&quot;      &quot;guides&quot;     
 [5] &quot;mapping&quot;     &quot;theme&quot;       &quot;coordinates&quot; &quot;facet&quot;      
 [9] &quot;plot_env&quot;    &quot;layout&quot;      &quot;labels&quot;     </code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="system.html#cb39-1" tabindex="-1"></a><span class="fu">length</span>(plot1<span class="sc">$</span>layers)</span></code></pre></div>
<pre><code>[1] 0</code></pre>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="system.html#cb41-1" tabindex="-1"></a><span class="co"># Adding components such as geoms or scales returns a new schema</span></span>
<span id="cb41-2"><a href="system.html#cb41-2" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(wt, mpg)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span>
<span id="cb41-3"><a href="system.html#cb41-3" tabindex="-1"></a><span class="fu">names</span>(plot2)</span></code></pre></div>
<pre><code> [1] &quot;data&quot;        &quot;layers&quot;      &quot;scales&quot;      &quot;guides&quot;     
 [5] &quot;mapping&quot;     &quot;theme&quot;       &quot;coordinates&quot; &quot;facet&quot;      
 [9] &quot;plot_env&quot;    &quot;layout&quot;      &quot;labels&quot;     </code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="system.html#cb43-1" tabindex="-1"></a><span class="fu">length</span>(plot2<span class="sc">$</span>layers)</span></code></pre></div>
<pre><code>[1] 1</code></pre>
<p><code>ggplot2</code> is well-loved by R users, as evidenced by the packageâs popularity. However, its API presents certain limitations when building interactive figures. Specifically:</p>
<ul>
<li>Its design primarily centers around individual plots. While facetting does make it possible to create multi-panel figures consisting of repeats of the same plot type <span class="citation">(see <code>facet_wrap()</code> and <code>facet_grid()</code>, <a href="#ref-wickham2016">Wickham 2016</a>)</span>, creating mixed plot-type multi-panel figures requires the use of external packages such as <code>gridExtra</code> <span class="citation">(<a href="#ref-auguie2017">Auguie 2017</a>)</span> or <code>patchwork</code> <span class="citation">(<a href="#ref-pedersen2024">Pedersen 2024</a>)</span>. As discussed in Section <a href="background.html#background">4</a>, in interactive graphics, multi-panel figures are essential and should be considered first-class citizens.</li>
<li>While the immutable schema model works well for static graphics, in interactive graphics, the ability to modify an already rendered figure via code can be extremely useful. For example directly setting a histogram binwidth to a precise value via a function call offers superior control compared to using an imprecise widget such as a slider.</li>
<li>Many of the <code>ggplot2</code>âs core functions make heavy use of quotation and non-standard evaluation <span class="citation">(NSE, <a href="#ref-wickham2019">Wickham 2019</a>)</span>. While this style is fairly popular within the R ecosystem and does offer syntactic conciseness, it also complicates programmatic use <span class="citation">(<a href="#ref-wickham2019">Wickham 2019</a>)</span>. For instance, in <code>ggplot2</code>, to plot all pairwise combinations of the variables in a dataframe, we cannot simply loop over their names and supply these as arguments to the default <code>aes</code> function - instead, we have to parse the names within the dataframeâs environment (this is what the specialized <code>aes_string</code> function does). Again, in interactive contexts, the ability to easily manipulate figures with code is often highly useful, and this makes NSE a hindrance (more on this later).<br />
</li>
<li>The package was developed before widespread adoption of the pipe operator <span class="citation">(both <code>%&gt;%</code> from <code>magrittr</code>, <a href="#ref-bache2022">Bache and Wickham 2022</a>; and the native R <code>|&gt;</code> pipe, <a href="#ref-r2024">R Core Team 2024</a>)</span> and its use of the overloaded <code>+</code> operator is a noted design flaw <span class="citation">(see <a href="#ref-wickham2014">Wickham, Hadley 2014</a>)</span>.</li>
</ul>
<p>In <code>plotscaper</code>, I addressed these issues as follows. First, a function-chaining approach similar to <code>ggplot2</code> was adopted, however, with a focus on multi-panel figure composition. Most functions modify the entire figure, however, specialized functions with selectors can also target individual plots (see Sections <a href="system.html#basic-example">7.2.2</a> and <a href="system.html#figure-plot">7.2.2.1</a>. Second, to enable mutable figure modification while retaining the benefits of immutability, most functions can operate on both immutable figure schemas and references to live figures, with the operations being applied homomorphically (this will be discussed in Section <a href="system.html#scene-and-schema">7.2.3</a>). Finally, non-standard evaluation was avoided altogether, and functions can be composed using any valid pipe operator<a href="#fn11" class="footnote-ref" id="fnref11"><sup>11</sup></a>.</p>
</div>
<div id="basic-example" class="section level3 hasAnchor" number="7.2.2">
<h3><span class="header-section-number">7.2.2</span> Basic example<a href="system.html#basic-example" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The code below shows an example of a simple interactive figure created with <code>plotscaper</code>. More advanced and realistic applications are shown in Section <a href="applied-example.html#applied-example">8</a>; this is example is only meant to provide a simple illustration:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="system.html#cb45-1" tabindex="-1"></a><span class="fu">library</span>(plotscaper)</span>
<span id="cb45-2"><a href="system.html#cb45-2" tabindex="-1"></a></span>
<span id="cb45-3"><a href="system.html#cb45-3" tabindex="-1"></a><span class="fu">create_schema</span>(mtcars) <span class="sc">|&gt;</span></span>
<span id="cb45-4"><a href="system.html#cb45-4" tabindex="-1"></a>  <span class="fu">add_scatterplot</span>(<span class="fu">c</span>(<span class="st">&quot;wt&quot;</span>, <span class="st">&quot;mpg&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-5"><a href="system.html#cb45-5" tabindex="-1"></a>  <span class="fu">add_barplot</span>(<span class="fu">c</span>(<span class="st">&quot;cyl&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-6"><a href="system.html#cb45-6" tabindex="-1"></a>  <span class="fu">set_scale</span>(<span class="st">&quot;plot1&quot;</span>, <span class="st">&quot;x&quot;</span>, <span class="at">min =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb45-7"><a href="system.html#cb45-7" tabindex="-1"></a>  <span class="fu">render</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plotscaper-example1"></span>
<iframe src="./figures/plotscaper_example1.html" width="100%" height="400" data-external="1" style="border: none;">
</iframe>
<p class="caption">
Figure 7.1: An example of a simple interactive figure in <code>plotscaper</code>.
</p>
</div>
<p>We first initialize the figure schema by calling <code>create_schema</code> with the input data. Next, we chain a series of <code>add_*</code> calls, adding individual plots. Furthermore, we can manipulate attributes of individual plots by using specialized functions. For instance, in the example above, <code>set_scale</code> is used to set the lower x-axis limit of the scatterplot to zero. When a schema is provided as the first argument, these functions append immutable instructions to the schema, a process which will be detailed in Section <a href="system.html#scene-and-schema">7.2.3</a>. Finally, call to <code>render</code> instantiates the schema, creating an interactive figure. Several aspects of this workflow warrant further explanation which will be provided in the subsequent sections.</p>
<div id="figure-plot" class="section level4 hasAnchor" number="7.2.2.1">
<h4><span class="header-section-number">7.2.2.1</span> Figure vs.Â plot and selectors<a href="system.html#figure-plot" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>First, note that, as discussed in Section <a href="system.html#api-design">7.2.1</a>, all <code>plotscaper</code> functions take as their first argument the entire figure. This differs from <code>ggplot2</code> functions, which typically operate on a single plot (unless facetting is applied). Thus, the primary target of manipulation is the entire figure, rather than a single plot. This design necessitates the use of selectors for targeting individual plots, as seen in the <code>set_scale</code> call above. I decided to use a simple string selector for this purpose. While alternative selection strategies, such as overloading the extraction (<code>$</code>) operator or using a dedicated selector function were also considered, upon considering the inherent trade-offs, I decided to go with the straightforward method of string selectors. This design choice is open to being revisited in future major releases of the package.</p>
</div>
<div id="variable-names" class="section level4 hasAnchor" number="7.2.2.2">
<h4><span class="header-section-number">7.2.2.2</span> Variable names<a href="system.html#variable-names" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Second, <code>plotscaper</code> also uses simple string vectors to specify data variable names. This means that the function arguments are <em>not</em> treated as quoted symbols<a href="#fn12" class="footnote-ref" id="fnref12"><sup>12</sup></a>. For example, we use <code>add_scatterplot(c("x", "y", "z"))</code> instead of <code>add_scatterplot(c(x, y, z))</code>. While this style requires two extra key strokes for each variable and might feel less familiar to some R users, I believe that its suitability for programmatic use makes it a worthwhile trade-off. For instance, a user of <code>plotscaper</code> can easily create an interactive scatterplot matrix (SPLOM) like so:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="system.html#cb46-1" tabindex="-1"></a>column_names <span class="ot">&lt;-</span> <span class="fu">names</span>(mtcars)[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>)]</span>
<span id="cb46-2"><a href="system.html#cb46-2" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="fu">create_schema</span>(mtcars)</span>
<span id="cb46-3"><a href="system.html#cb46-3" tabindex="-1"></a></span>
<span id="cb46-4"><a href="system.html#cb46-4" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> column_names) {</span>
<span id="cb46-5"><a href="system.html#cb46-5" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> column_names) {</span>
<span id="cb46-6"><a href="system.html#cb46-6" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> j) schema <span class="ot">&lt;-</span> <span class="fu">add_histogram</span>(schema, <span class="fu">c</span>(i))</span>
<span id="cb46-7"><a href="system.html#cb46-7" tabindex="-1"></a>    <span class="cf">else</span> schema <span class="ot">&lt;-</span> <span class="fu">add_scatterplot</span>(schema, <span class="fu">c</span>(i, j))</span>
<span id="cb46-8"><a href="system.html#cb46-8" tabindex="-1"></a>  }</span>
<span id="cb46-9"><a href="system.html#cb46-9" tabindex="-1"></a>}</span>
<span id="cb46-10"><a href="system.html#cb46-10" tabindex="-1"></a></span>
<span id="cb46-11"><a href="system.html#cb46-11" tabindex="-1"></a>schema <span class="sc">|&gt;</span> <span class="fu">render</span>()</span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plotscaper-example2"></span>
<iframe src="./figures/plotscaper-example2.html" width="100%" height="800" data-external="1" style="border: none;">
</iframe>
<p class="caption">
Figure 7.2: An example of a programmatically-created scatterplot matrix (SPLOM).
</p>
</div>
<p>While this scatterplot matrix could be also recreated with quotation/NSE using functions like <code>substitute</code> from base R <span class="citation">(<a href="#ref-r2024">R Core Team 2024</a>)</span> or <code>enquo</code> from <code>rlang</code> <span class="citation">(<a href="#ref-rlang2024">Henry and Wickham 2024</a>)</span>, doing so requires the knowledge of quasiquotation which is part of <a href="https://adv-r.hadley.nz/quasiquotation.html#quasiquotation">advanced R</a>. Many R users may be familiar with calling functions using ânakedâ variable names, however, actual proficiency with using quotation effectively may be less common. Furthemore, Râs NSE is a form of metaprogramming <span class="citation">(<a href="#ref-wickham2019">Wickham 2019</a>)</span>. While powerful, over-reliance on metaprogramming is often discouraged in modern developer circles, due to it potential to impact performance, safety, and readability <span class="citation">(see e.g. <a href="#ref-phung2009">Phung, Sands, and Chudnov 2009</a>; the discussion at <a href="#ref-handmadehero2025">Handmade Hero 2025</a>)</span>. Thus, to promote simplicity and programmatic use, I chose simple string vectors over quoted function arguments in <code>plotscaper</code>.</p>
</div>
<div id="variables-encodings" class="section level4 hasAnchor" number="7.2.2.3">
<h4><span class="header-section-number">7.2.2.3</span> Variables and encodings<a href="system.html#variables-encodings" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Third, note that, in <code>plotscaper</code>, variable names are <em>not</em> meant to map directly to aesthetics such as x- or y-axis position or size. In other words, unlike <code>ggplot2</code>, <code>plotscaper</code> does not try to establish a direct correspondence between original data variables and the visual encodings/aesthetics. The reasoning behind this choice is that, in many common plot types, aesthetics do not actually represent variables found in the original data, but instead derived or computed variables. Take, for instance, the following <code>ggplot</code> call:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="system.html#cb47-1" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(<span class="at">x =</span> mpg)) <span class="sc">+</span> </span>
<span id="cb47-2"><a href="system.html#cb47-2" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code></pre></div>
<p><img src="figures/ggplot-histogram-aes.png" width="100%" height="100%" style="border: none;" style="display: block; margin: auto;" /></p>
<p>Overtly, it may seem as if the <code>aes</code> function maps the <code>mpg</code> variable to the x-axis. This would be the case if, for example, <code>geom_point</code> had been used, however, with <code>geom_histogram</code>, this interpretation is incorrect. Specifically, the x-axis actually represents the left and right edges of the histogram bins, a derived variable not found in the original data. Similarly, the y-axis shows bin counts, another derived variable. Setting custom histogram breaks makes this lack of a direct correspondence even clearer:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="system.html#cb48-1" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(<span class="at">x =</span> mpg)) <span class="sc">+</span> </span>
<span id="cb48-2"><a href="system.html#cb48-2" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">35</span>))</span></code></pre></div>
<p><img src="figures/ggplot-histogram-aes2.png" width="100%" height="100%" style="border: none;" style="display: block; margin: auto;" /></p>
<p>Now it is easier to see that what gets mapped to the x-axis is <em>not</em> the <code>mpg</code> variable. Instead, it is the variable representing the histogram breaks. The <code>mpg</code> variable gets mapped to the plot only implicitly, as the summarized counts within the bins (the y-axis variable). Thus, in <code>ggplot</code> call, the semantics of <code>aes(x = mpg, ...)</code> are fundamentally different in <code>geom_histogram</code> as compared to, for example, <code>geom_scatter</code>.</p>
<p>While this lack of a direct correspondence between data and aesthetics may seem like a minor detail, it is in fact a fundamental design gap. As discussed in Section <a href="problems.html#problems">5</a>, <code>ggplot2</code> is based on the Grammar of Graphics model <span class="citation">(<a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>, which centers around the idea of composing plots out of independent, modular components. The fact that the semantics of <code>aes</code> are tied to <code>geom</code>s (and <code>stat</code>s) means that these classes of <code>ggplot2</code> functions are not truly independent. This issue is even further amplified in interactive graphics. For instance, when switching the representation of histogram to spinogram, we use the same underlying data but the aesthetic mappings are completely different. The expression <code>aes(x = mpg)</code> would be meaningless in a spinogram, since both the x- and y-axes display binned counts - <code>mpg</code> only facilitates binning and is not displayed anywhere in the plot directly.</p>
<p>So what to do? To be perfectly frank, I have not found a perfect solution. In Section <a href="problems.html#problems">5</a>, I proved that, in the general case involving transformations like stacking, <code>stats</code> and <code>geoms</code> <em>cannot</em> be truly independent. Barring that, the problem with specifying aesthetics in plots like histograms is that, in some sense, we are putting the cart before the horse: ultimately, we want to plot derived variables, so we should specify these in the call to <code>aes</code>, however, we do not know what the derived variables will be before we compute them (requiring the knowledge of <code>stat</code>s and <code>geom</code>s). So perhaps the schema creation process should organized in a different way. As per Section <a href="problems.html#problems">5</a>, we could mirror the data visualization pipeline by structuring the code like:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="system.html#cb49-1" tabindex="-1"></a>data <span class="sc">|&gt;</span> </span>
<span id="cb49-2"><a href="system.html#cb49-2" tabindex="-1"></a>  <span class="fu">partition</span>(...) <span class="sc">|&gt;</span> </span>
<span id="cb49-3"><a href="system.html#cb49-3" tabindex="-1"></a>  <span class="fu">aggregate</span>(...) <span class="sc">|&gt;</span> </span>
<span id="cb49-4"><a href="system.html#cb49-4" tabindex="-1"></a>  <span class="fu">encode</span>(...) <span class="sc">|&gt;</span> </span>
<span id="cb49-5"><a href="system.html#cb49-5" tabindex="-1"></a>  <span class="fu">render</span>(...)</span></code></pre></div>
<p>In broad strokes, this is how the data visualization pipeline is implemented in <code>plotscape</code> (see Section <a href="system.html#low-level-implementation">7.4</a>). However, this model does have one important downside: it does not lend itself easily to a simple declarative schema like that of <code>ggplot2</code>. Despite several attempts, and some partial successes (see Section <a href="system.html#summaries">7.4.4.6.3</a>), on the whole, I have been unsuccessful in developing a comprehensive way to specify such a schema. The difficulties stem from the hierarchical dependencies between the various pipeline stages, as well as the added complexity of integrating reactivity into the pipeline (see also Section <a href="discussion.html#declarative-schemas">9.2.2</a>).</p>
<p>This difficulty with declarative schemas is why I opted for the more traditional, nominal style of specifying plots in <code>plotscaper</code>(i.e.Â using functions like <code>add_scatterplot</code> or <code>add_barplot</code>). While this approach may seem less flexible, I hope I have demonstrated that the underlying limitations are <em>not</em> an exclusive to <code>plotscape</code>/<code>plotscaper</code>, but extend to <code>ggplot2</code> and all other GoG-based data visualization systems. I have simply chosen make these limitations more explicit. If a better solution is found, it may be integrated into future releases of the package.</p>
<p>A final point to mention is that it could be argued that one benefit of the <code>ggplot2</code> model where partitioning and aggregation logic (<code>stat</code>s) is implicitly tied to <code>geom</code>s is that it makes it easier to combine several kinds of <code>geom</code>s in one plot. For instance, <code>geom_histogram</code> can be combined with <code>geom_rug</code>, while single-case <code>geom_points</code> can be combined with aggregate summaries computed via <code>stat_summary</code>. Ignoring the conceptual problem of non-independence discussed above, this approach works fine for static graphics, where performance is not a key concern. However, in interactive graphics, computing a separate set of summaries for each <code>geom</code> layer may create unnecessary computational bottlenecks. Therefore, interactive graphics may benefit from sharing aggregated data whenever possible, and this is only possible if the partitioning and aggregation steps of the data visualization pipeline are lifted out of <code>geom</code>s.</p>
</div>
</div>
<div id="scene-and-schema" class="section level3 hasAnchor" number="7.2.3">
<h3><span class="header-section-number">7.2.3</span> The scene and the schema<a href="system.html#scene-and-schema" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A key part of the <code>plotscaper</code> API is the distinction between two classes of objects representing figures: schemas and scenes. Put simply, a <strong>schema</strong> is an immutable ledger or blueprint, specifying how a figure is created, whereas a <strong>scene</strong> is a live, rendered version of the figure which can be directly interacted with. Both can be manipulated using (largely) the same set of functions, implemented as <code>S3</code> methods which dispatch on the underlying class.</p>
<p>As shown before, schema can be created with the <code>create_schema</code> function:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="system.html#cb50-1" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="fu">create_schema</span>(mtcars) <span class="sc">|&gt;</span></span>
<span id="cb50-2"><a href="system.html#cb50-2" tabindex="-1"></a>  <span class="fu">add_scatterplot</span>(<span class="fu">c</span>(<span class="st">&quot;wt&quot;</span>, <span class="st">&quot;mpg&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb50-3"><a href="system.html#cb50-3" tabindex="-1"></a>  <span class="fu">add_barplot</span>(<span class="fu">c</span>(<span class="st">&quot;cyl&quot;</span>))</span>
<span id="cb50-4"><a href="system.html#cb50-4" tabindex="-1"></a></span>
<span id="cb50-5"><a href="system.html#cb50-5" tabindex="-1"></a>schema</span></code></pre></div>
<pre><code>plotscaper schema:
add-plot { type: scatter, variables: c(&quot;wt&quot;, &quot;mpg&quot;) }
add-plot { type: bar, variables: cyl }</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="system.html#cb52-1" tabindex="-1"></a><span class="fu">str</span>(schema<span class="sc">$</span>queue)</span></code></pre></div>
<pre><code>List of 2
 $ :List of 2
  ..$ type: chr &quot;add-plot&quot;
  ..$ data:List of 3
  .. ..$ type     : &#39;scalar&#39; chr &quot;scatter&quot;
  .. ..$ variables: chr [1:2] &quot;wt&quot; &quot;mpg&quot;
  .. ..$ id       : &#39;scalar&#39; chr &quot;f7d38c50-2960-4a0c-9180-1a09683dd5fd&quot;
 $ :List of 2
  ..$ type: chr &quot;add-plot&quot;
  ..$ data:List of 3
  .. ..$ type     : &#39;scalar&#39; chr &quot;bar&quot;
  .. ..$ variables: chr &quot;cyl&quot;
  .. ..$ id       : &#39;scalar&#39; chr &quot;50e5b5ef-cc3e-45ac-8a49-6f6db29a57cc&quot;</code></pre>
<p>As you can see, the object created with <code>create_schema</code> is essentially just a <code>list</code> of messages. Modifying the schema by calling functions such as <code>add_scatterplot</code> or <code>set_scale</code> simply appends a new message to the list, similar to how objects of class <code>ggplot</code> are modified via the <code>+</code> operator <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span>. This makes schemas easy to transport (e.g.Â as JSON) and modify programmatically. Finally, note how rendering the schema requires an explicit call to <code>render</code>. This approach differs from the popular R convention of rendering implicitly via a <code>print</code> method; there is an important reason for this design choice which will be discussed later.</p>
<p>The call to <code>render</code> turns the schema into a live figure that can be interacted with. This happens by constructing an <code>htmlwidgets</code> widget <span class="citation">(<a href="#ref-htmlwidgets2021">Vaidyanathan et al. 2021</a>)</span>, which bundles up the underlying data and <code>plotscape</code> code (JavaScript, HTML, CSS) into a standalone document, which may be served live, such as in RStudio viewer, or statically embedded within another HTML document, such as one produced with RMarkdown. The schema messages get forwarded to the widget and applied sequentially, creating the figure.</p>
<p>Importantly, under this model, the schema merely records state-generating steps, not the state itself. All mutable state lives on the scene (the client-side figure). This design avoids state duplication between the R session (server) and browser-based figure (client), eliminating the need for synchronization.</p>
<p>While this approach deviates from the typical client-server architecture, where most of state tends to reside on the server, it is essential for achieving highly-responsive interactive graphics. Keeping state on the client reduces round-trips to the server, resulting in fast updates in response to user events. For instance, linked selection updates, triggered by mousemove events, are initiated, computed, and rendered directly on the client. This avoids the issues of server-centric frameworks like Shiny <span class="citation">(<a href="#ref-shiny2024">W. Chang et al. 2024</a>)</span>, which struggle with high-frequency interactive events like linked selection. Finally, as will be discussed below, while the R session (server) may occasionally send and receive messages, these are less latency-critical, making a âthinâ server perfectly viable.</p>
</div>
<div id="client-server" class="section level3 hasAnchor" number="7.2.4">
<h3><span class="header-section-number">7.2.4</span> Client-server communication<a href="system.html#client-server" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When inside an interactive R session, creating a <code>plotscaper</code> figure via the call to <code>render</code> also automatically launches a WebSockets server <span class="citation">(using the <code>httpuv</code> package, <a href="#ref-cheng2024">Cheng et al. 2024</a>)</span>, supporting a live, two-way communication between the R session (server) and the figure (client). By assigning the output of the <code>render</code> to a variable, users can save a handle to the server, which can then be used to call methods to modify the figure or query its state. For instance:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="system.html#cb54-1" tabindex="-1"></a><span class="co"># The code below is used for illustration and NOT EVALUATED:</span></span>
<span id="cb54-2"><a href="system.html#cb54-2" tabindex="-1"></a><span class="co"># it can only be run in interactive R sessions,</span></span>
<span id="cb54-3"><a href="system.html#cb54-3" tabindex="-1"></a><span class="co"># not static documents such as this thesis</span></span>
<span id="cb54-4"><a href="system.html#cb54-4" tabindex="-1"></a></span>
<span id="cb54-5"><a href="system.html#cb54-5" tabindex="-1"></a>scene <span class="ot">&lt;-</span> <span class="fu">create_schema</span>(mtcars) <span class="sc">|&gt;</span></span>
<span id="cb54-6"><a href="system.html#cb54-6" tabindex="-1"></a>  <span class="fu">add_scatterplot</span>(<span class="fu">c</span>(<span class="st">&quot;wt&quot;</span>, <span class="st">&quot;mpg&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb54-7"><a href="system.html#cb54-7" tabindex="-1"></a>  <span class="fu">add_barplot</span>(<span class="st">&quot;cyl&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-8"><a href="system.html#cb54-8" tabindex="-1"></a>  <span class="fu">render</span>()</span>
<span id="cb54-9"><a href="system.html#cb54-9" tabindex="-1"></a></span>
<span id="cb54-10"><a href="system.html#cb54-10" tabindex="-1"></a><span class="co"># Render the scene</span></span>
<span id="cb54-11"><a href="system.html#cb54-11" tabindex="-1"></a>scene</span>
<span id="cb54-12"><a href="system.html#cb54-12" tabindex="-1"></a></span>
<span id="cb54-13"><a href="system.html#cb54-13" tabindex="-1"></a><span class="co"># Add a histogram, modifying the figure in-place</span></span>
<span id="cb54-14"><a href="system.html#cb54-14" tabindex="-1"></a>scene <span class="sc">|&gt;</span> <span class="fu">add_histogram</span>(<span class="st">&quot;disp&quot;</span>)</span>
<span id="cb54-15"><a href="system.html#cb54-15" tabindex="-1"></a></span>
<span id="cb54-16"><a href="system.html#cb54-16" tabindex="-1"></a><span class="co"># Set the scatterplot&#39;s lower x-axis limit to 0 (also in-place)</span></span>
<span id="cb54-17"><a href="system.html#cb54-17" tabindex="-1"></a>scene <span class="sc">|&gt;</span> <span class="fu">set_scale</span>(<span class="st">&quot;plot1&quot;</span>, <span class="st">&quot;x&quot;</span>, <span class="at">min =</span> <span class="dv">0</span>)</span>
<span id="cb54-18"><a href="system.html#cb54-18" tabindex="-1"></a></span>
<span id="cb54-19"><a href="system.html#cb54-19" tabindex="-1"></a><span class="co"># Select cases corresponding to rows 1 to 10</span></span>
<span id="cb54-20"><a href="system.html#cb54-20" tabindex="-1"></a>scene <span class="sc">|&gt;</span> <span class="fu">select_cases</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb54-21"><a href="system.html#cb54-21" tabindex="-1"></a></span>
<span id="cb54-22"><a href="system.html#cb54-22" tabindex="-1"></a><span class="co"># Query selected cases retuning a numeric vector</span></span>
<span id="cb54-23"><a href="system.html#cb54-23" tabindex="-1"></a>scene <span class="sc">|&gt;</span> <span class="fu">selected_cases</span>() <span class="co"># [1] 1 2 3 4 5 6 7 8 9 10</span></span></code></pre></div>
<p>As noted earlier, most <code>plotscaper</code> functions are polymorphic <code>S3</code> methods which dispatch on either a schema or a scene. When called dispatched on a schema, they simply append a message, whereas when dispatched on a scene, they send a WebSockets request, which may either cause a live-update or have the client respond with data (while interactive R session). More abstractly, the <code>render</code> function and other methods are a functor/homomorphism, meaning that they preserve composition - we can either first dispatch on a schema and then render, or render and then dispatch on the scene, and the result will be the same (provided no other interaction happens in the meantime). The one exception to this rule are state-querying functions such as <code>selected_cases</code>, <code>assigned_cases</code>, and <code>get_scale</code>. These retrieve the figureâs state and so make little sense to dispatch on the schema<a href="#fn13" class="footnote-ref" id="fnref13"><sup>13</sup></a>.</p>
</div>
<div id="html-embedding" class="section level3 hasAnchor" number="7.2.5">
<h3><span class="header-section-number">7.2.5</span> HTML embedding<a href="system.html#html-embedding" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As <code>htmlwidgets</code> widgets, <code>plotscaper</code> figures are essentially webpages. As such, they can be statically embedded in HTML documents such as those produced by RMarkdown <span class="citation">(<a href="#ref-rmarkdown2024">Allaire et al. 2024</a>)</span> or Quarto <span class="citation">(<a href="#ref-allaire2024">Allaire and Dervieux 2024</a>)</span>. More specifically, when a <code>plotscaper</code> figure is rendered, <code>htmlwidgets</code> <span class="citation">(<a href="#ref-htmlwidgets2021">Vaidyanathan et al. 2021</a>)</span> is used to bundle the underlying HTML, CSS and JavaScript. The resulting widget can then be embedded in any valid HTML document, or saved as a standalone HTML file (using the <code>htlwidgets::saveWidget</code>).<a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a></p>
<p>As mentioned above, since client-server communication requires an active server, statically rendered figures do not support code-based interaction (described in Section <a href="system.html#client-server">7.2.4</a>). However, since within-figure interactive features such as linked selection and querying are entirely client-side, they are always available, even in static documents. This makes <code>plotscaper</code> a good fit for interactive reports, such as those created by RMarkdown <span class="citation">(<a href="#ref-rmarkdown2024">Allaire et al. 2024</a>)</span> or Quarto <span class="citation">(<a href="#ref-allaire2024">Allaire and Dervieux 2024</a>)</span>.</p>
</div>
</div>
<div id="overview-of-the-system-model" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Overview of the system model<a href="system.html#overview-of-the-system-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In Section <a href="problems.html#problems">5</a>, I outlined key concerns that arise when designing interactive data visualization systems, and laid out a rough sketch of the interactive data visualization pipeline and the components it must contain. Here, I will give a broad overview of the implementation of this pipeline in <code>plotscape</code>. I will also begin relating this pipeline to core <code>plotscape</code> components, which will be discussed in more depth later, in Section <a href="system.html#components">7.4.4</a>. Finally, as it is one of the core topics of the present thesis, I will end with a brief discussion of the problem of hierarchical data summaries, in which I will re-iterate some key points from Section <a href="problems.html#problems">5</a>, discuss the constraints they provide for aggregation, transformation, and encoding, and link these to their implementation in <code>plotscape</code>.</p>
<div id="model-pipeline" class="section level3 hasAnchor" number="7.3.1">
<h3><span class="header-section-number">7.3.1</span> The interactive data visualization pipeline<a href="system.html#model-pipeline" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Figure <a href="system.html#fig:model-diagram">7.3</a> summarizes the interactive data visualization pipeline as implemented in <code>plotscape</code>/<code>plotscaper</code>:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:model-diagram"></span>
<img src="figures/model_diagram.png" alt="A diagram of the interactive data visualization pipeline." width="100%" height="100%" style="border: none;" />
<p class="caption">
Figure 7.3: A diagram of the interactive data visualization pipeline.
</p>
</div>
<p>This pipeline describes the data flow that takes places in a single interactive plot. Importantly, the core part of the pipeline is the following (linear) chain of transformations:</p>
<p><span class="math display">\[\text{data} \to \text{partitions} \to \text{summaries} \to \text{encodings}\]</span></p>
<p>Specifically, as discussed throughout Section <a href="problems.html#problems">5</a>, data is first divided into a hierarchy of partitions, which are then aggregated and turned into sets of summaries. These summaries are then transformed and mapped to aesthetic encodings, which are finally rendered as geometric objects (and also used to train the plotsâ scales, among other things).</p>
<p>Interactivity can enter the pipeline in several places. The deepest level of interaction involves the <strong>Marker</strong>, a shared data structure that manages linked selection across multiple plots. When a user engages in linked selection, the Marker updates, triggering a recalculation of data partitions, summaries, and aesthetic encodings. This essentially means the entire pipeline needs to be recomputed. Similarly, altering partitioning parameters like histogram binwidth also leads to the same âdeepâ cascade of updates. A somewhat less deep interaction is representation switching. This merely updates the mapping between summaries and aesthetic <strong>encodings</strong> without necessitating updates to data partitions or the summaries themselves. Finally, the most superficial updates are those involving scales. These do not affect the underlying data at all.</p>
<p>This is a greatly simplified model, however, it does highlight some key features. First, the model allow us to reason about the computational complexity of reactive updates. Updates tend to be the most expensive when they are deep within the pipeline, and as they move âcloser to the surfaceâ, their cost progressively decreases. For instance, updates to the data, Marker, or the partitions require significant recomputation, whereas direct scale updates typically have a fairly isolated impact, affecting the rendered output only. Further, the model also allows us to reason about the complexity of yet-to-be-implemented features. For instance, while, right now, there are no direct interactive updates of summaries (note the absence of an arrow between User Input and Summaries in Figure <a href="system.html#fig:model-diagram">7.3</a>), we could imagine extending the system, such that, for example, we may summarize the data by computing the sum of top <span class="math inline">\(n\)</span> values, with <span class="math inline">\(n\)</span> being a reactive parameter. Then, the complexity of such updates would fall between modifying partitions and switching representations.</p>
<p>Second, as discussed throughout Section <a href="problems.html#problems">5</a>, although the different stages of the pipeline are fairly self-contained, they are <em>not</em> fully independent. At times, the more superficial stages may require information from the deeper levels. For instance, while stacking takes place during the Aesthetic Encoding step of the pipeline, it is not just a graphical operation; it relies on the information about how the summary statistics have been aggregated (see also Section <a href="problems.html#aggregation">5.2</a>). Likewise, at times, we may want to use the neutral element from summarization as the lower limit of the y-axis scale (see Section <a href="problems.html#shifting">5.2.2.10.3</a>). Finally, during querying, while we may superficially work with geometric objects and their aesthetic encodings, we actually want to display the raw, untransformed summary statistics (Summaries). Therefore, throughout the pipeline, it is crucial to retain appropriate metadata and backlinks for use in later stages.</p>
<p>Now I will briefly outline the core software components of <code>plotscape</code>, in more concrete terms. First, I will describe the components the fundamental unit of the system, which is a figure made up of multiple plots: the <a href="system.html#scene">Scene</a>. Then, I will discuss the components which make up individual plots. This overview will be fairly conceptual and the individual components will be discussed in more detail in Section <a href="system.html#components">7.4.4</a>.</p>
</div>
<div id="scene-model" class="section level3 hasAnchor" number="7.3.2">
<h3><span class="header-section-number">7.3.2</span> Scene model<a href="system.html#scene-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As discussed in Section <a href="system.html#high-level-api">7.2</a>, every <code>plotscape</code>/<code>plotscaper</code> figure is composed of one or more interactive plots. Thus, the central component is the so-called <a href="system.html#scene">Scene</a> which represents the entire figure containing the plots (see Figure <a href="system.html#fig:scene-diagram">7.4</a>). To support linked selection (which affects all plots simultaneously), the scene contains a specialized <a href="marker">Marker</a> object. For communication with an external server (R client), a (WebSockets) client object is also included. Lastly, the Scene contains<a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a> an event listener object which coordinates user input and interactions between other components. The relations between the various components are described by the following diagram:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:scene-diagram"></span>
<img src="figures/scene_diagram.png" alt="Diagram of a scene. Solid arrows indicate composition, dashed arrows indicate other kinds of relationships (e.g. event-dispatch, argument passing in method calls)." width="100%" height="100%" style="border: none;" />
<p class="caption">
Figure 7.4: Diagram of a scene. Solid arrows indicate composition, dashed arrows indicate other kinds of relationships (e.g.Â event-dispatch, argument passing in method calls).
</p>
</div>
</div>
<div id="plot-model" class="section level3 hasAnchor" number="7.3.3">
<h3><span class="header-section-number">7.3.3</span> Plot model<a href="system.html#plot-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Further, every <code>plotscape</code>/<code>plotscaper</code> plot is also composed of several different, related components (see Figure <a href="system.html#fig:plot-diagram">7.5</a>). First, in light of Section <a href="system.html#model-pipeline">7.3.1</a>, there are some components which are directly related to the data visualization pipeline. The data is aggregated into a hierarchy of <a href="summaries">Summaries</a>, composed of special <em>reduced</em> variables or <a href="aggregation-summaries">Reduceds</a>. These reduced variables are not simple âflatâ arrays of values, but contain aggregation metadata (<a href="factors">Factors</a> and <a href="reducers">Reducers</a>), as well as pointers to the parent-level values, enabling hierarchy-aware transformations such as stacking or normalization (e.g.Â in spineplot, see e.g.Â Section <a href="background.html#representation-switching">4.2.5.7</a>). The aggregated summaries are translated into aesthetic encodings and used to train the plot <a href="scales">Scales</a>, which are composed of domain and codomain objects of the type (<a href="expanses">Expanse</a>). The translated summaries are also mapped to geometric objects or <em>geoms</em>, which are used in rendering and collision-detection (in linked selection). User input and scene events are again handled by an event listener object. Finally, the data-representing geoms, as well as other, auxiliary kinds of graphical objects (e.g.Â axis labels/titles) are rendered as visual output.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:plot-diagram"></span>
<img src="figures/plot_diagram.png" alt="Diagram of a `plotscape` plot. Solid arrows indicate composition, dashed arrows indicate other kinds of relationships (e.g. event-dispatch, argument passing in method calls)." width="100%" height="100%" style="border: none;" />
<p class="caption">
Figure 7.5: Diagram of a <code>plotscape</code> plot. Solid arrows indicate composition, dashed arrows indicate other kinds of relationships (e.g.Â event-dispatch, argument passing in method calls).
</p>
</div>
</div>
<div id="hierarchical-data-summaries-computation-transformation-and-encoding" class="section level3 hasAnchor" number="7.3.4">
<h3><span class="header-section-number">7.3.4</span> Hierarchical data summaries: computation, transformation, and encoding<a href="system.html#hierarchical-data-summaries-computation-transformation-and-encoding" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As discussed in Section <a href="problems.html#hierarchy">5.1.4</a>, a core problem in the design of interactive data visualization systems supporting linked selection is the presence of hierarchical dependencies within the represented data. Specifically, to draw objects composed of parts, and apply transformations such as stacking and normalization (see Section <a href="problems.html#transforming-summaries">5.2.2.10</a>), it is necessary to encode the hierarchical relationships in the data. However, coming up with a convenient API for describing these relationships is not simple, and so I would like to spend a bit more time discussing it here.</p>
<p>As discussed in Section <a href="problems.html#hierarchy">5.1.4</a>, rendering certain kinds of plots composed of geometric objects with highlighted parts representing selection requires a tree-like structure (see e.g.Â Figure <a href="problems.html#fig:spineplot-tree">5.10</a>). In other words, our system needs to be able to represent a hierarchy of connected data tables of the following shape:</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-47"></span>
<img src="figures/hierarchical_data.png" alt="A diagram of the data partition hierarchy." width="100%" height="100%" style="border: none;" />
<p class="caption">
Figure 7.6: A diagram of the data partition hierarchy.
</p>
</div>
<p>To give a more concrete example, consider the summary statistics we need to compute to draw a spineplot (see e.g.Â Section <a href="background.html#representation-switching">4.2.5.7</a>). We may initially consider computing a simple table of summaries computed over the product of two partitioning variables:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="system.html#cb55-1" tabindex="-1"></a><span class="fu">aggregate</span>(mpg <span class="sc">~</span> cyl <span class="sc">+</span> am, <span class="at">FUN =</span> sum, <span class="at">data =</span> mtcars) <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="system.html#cb55-2" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">cyl</th>
<th align="right">am</th>
<th align="right">mpg</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">4</td>
<td align="right">0</td>
<td align="right">68.7</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">0</td>
<td align="right">76.5</td>
</tr>
<tr class="odd">
<td align="right">8</td>
<td align="right">0</td>
<td align="right">180.6</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">1</td>
<td align="right">224.6</td>
</tr>
<tr class="odd">
<td align="right">6</td>
<td align="right">1</td>
<td align="right">61.7</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">1</td>
<td align="right">30.8</td>
</tr>
</tbody>
</table>
<p>However, such a simple, âflatâ table of summaries is not enough. To compute the heights of the normalized bar segments, we also require parent-level data. One way to add this information is via a join operation <span class="citation">(specifically, a left outer join, see <a href="#ref-codd1970">Codd 1970</a>)</span>:</p>
<div class="example">
<p><span id="exm:spineplot-code" class="example"><strong>Example 7.1  (Naive aggregation for spineplot) </strong></span></p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="system.html#cb56-1" tabindex="-1"></a>parent_data <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(mpg <span class="sc">~</span> cyl, <span class="at">FUN =</span> sum, <span class="at">data =</span> mtcars)</span>
<span id="cb56-2"><a href="system.html#cb56-2" tabindex="-1"></a>child_data <span class="ot">&lt;-</span> <span class="fu">aggregate</span>(mpg <span class="sc">~</span> cyl <span class="sc">+</span> am, <span class="at">FUN =</span> sum, <span class="at">data =</span> mtcars)</span>
<span id="cb56-3"><a href="system.html#cb56-3" tabindex="-1"></a></span>
<span id="cb56-4"><a href="system.html#cb56-4" tabindex="-1"></a>child_data <span class="sc">|&gt;</span></span>
<span id="cb56-5"><a href="system.html#cb56-5" tabindex="-1"></a>  <span class="co"># Join parent-level data</span></span>
<span id="cb56-6"><a href="system.html#cb56-6" tabindex="-1"></a>  <span class="fu">merge</span>(parent_data, <span class="at">by =</span> <span class="st">&quot;cyl&quot;</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb56-7"><a href="system.html#cb56-7" tabindex="-1"></a>  <span class="co"># Compute transformations</span></span>
<span id="cb56-8"><a href="system.html#cb56-8" tabindex="-1"></a>  <span class="fu">within</span>({                 </span>
<span id="cb56-9"><a href="system.html#cb56-9" tabindex="-1"></a>    <span class="co"># Ignores the issue of order</span></span>
<span id="cb56-10"><a href="system.html#cb56-10" tabindex="-1"></a>    stacked <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">sapply</span>(<span class="fu">split</span>(mpg.x, cyl), cumsum)) </span>
<span id="cb56-11"><a href="system.html#cb56-11" tabindex="-1"></a>    normalized <span class="ot">&lt;-</span> mpg.x <span class="sc">/</span> mpg.y</span>
<span id="cb56-12"><a href="system.html#cb56-12" tabindex="-1"></a>    stacked_and_normalized <span class="ot">&lt;-</span> stacked <span class="sc">/</span> mpg.y</span>
<span id="cb56-13"><a href="system.html#cb56-13" tabindex="-1"></a>  }) <span class="sc">|&gt;</span></span>
<span id="cb56-14"><a href="system.html#cb56-14" tabindex="-1"></a>  <span class="co"># Reorder</span></span>
<span id="cb56-15"><a href="system.html#cb56-15" tabindex="-1"></a>  <span class="fu">subset</span>(<span class="at">select =</span> <span class="fu">c</span>(<span class="st">&quot;stacked&quot;</span>, <span class="st">&quot;normalized&quot;</span>, </span>
<span id="cb56-16"><a href="system.html#cb56-16" tabindex="-1"></a>                    <span class="st">&quot;stacked_and_normalized&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb56-17"><a href="system.html#cb56-17" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">stacked</th>
<th align="right">normalized</th>
<th align="right">stacked_and_normalized</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">68.7</td>
<td align="right">0.2342312</td>
<td align="right">0.2342312</td>
</tr>
<tr class="even">
<td align="right">293.3</td>
<td align="right">0.7657688</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="right">76.5</td>
<td align="right">0.5535456</td>
<td align="right">0.5535456</td>
</tr>
<tr class="even">
<td align="right">138.2</td>
<td align="right">0.4464544</td>
<td align="right">1.0000000</td>
</tr>
<tr class="odd">
<td align="right">180.6</td>
<td align="right">0.8543046</td>
<td align="right">0.8543046</td>
</tr>
<tr class="even">
<td align="right">211.4</td>
<td align="right">0.1456954</td>
<td align="right">1.0000000</td>
</tr>
</tbody>
</table>
</div>
<div id="problems-with-naive-joins" class="section level4 hasAnchor" number="7.3.4.1">
<h4><span class="header-section-number">7.3.4.1</span> Problems with naive joins<a href="system.html#problems-with-naive-joins" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The code in Example <a href="system.html#exm:spineplot-code">7.1</a> may seem like a reasonable way to compute the summary data for a spineplot, however, it has a couple of important issues. First, the example models the hierarchical relationship inherent to spineplots (as well as other types of plots, see Section <a href="problems.html#limits-of-flat-products">5.1.3.3</a>) only implicitly. Specifically, there is nothing in the first two lines of Example <a href="system.html#exm:spineplot-code">7.1</a> to indicate that the two aggregated data sets are related. The user may know that <code>parent_data</code> and <code>child_data</code> are hierarchically related, however, in the context of the program, these are two independent variables. This approach is suboptimal and error-prone: a better solution may be to encode the hierarchical relationship explicitly, into the data structure itself.</p>
<p>Second, the naive join method needlessly duplicates information. We want to compute a consistent set of summaries over different levels of granularity, and, as such, most of the code in the first two lines of Example <a href="system.html#exm:spineplot-code">7.1</a> is redundant. Specifically, the only thing that changes are the partitioning variables on the right hand side of the formula (i.e.Â <code>~ cyl</code> and <code>~ cyl + am</code>). Further, since we create the hierarchy of partitions by taking repeated products of the partitioning variables, specifying each level of partitioning explicitly is redundant: we can simply specify the partitioning variables in order and let the system take the products implicitly (i.e.Â instead of <code>~ cyl</code> and <code>~ cyl + am</code>, we can simply specify <code>cyl</code> and <code>am</code>). Finally, when joining the two aggregated data sets (via <code>merge</code>), we have to create new columns and rename existing ones (e.g.Â see the columns <code>mpg.x</code> and <code>mpg.y</code> in the output of Example <a href="system.html#exm:spineplot-code">7.1</a>). This solution can lead to name clashes and also creates unnecessary memory allocations, since the parent-level data has to be repeated for each level of the child partition.</p>
<p>Third, the naive join method does not preserve the appropriate metadata. Specifically, the output of the <code>aggregate</code> function is a simple dataframe, with the aggregated summaries being just a simple <code>numeric</code> column. However, as I argued throughout Section <a href="problems.html#problems">5</a> (in particular, Section <a href="problems.html#stacking-not-graphical">5.2.1.2</a>), to correctly apply operations like stacking, we need to know <em>how</em> the summaries have been computed. Therefore, it is essential to preserve metadata about the summarizing function, as well as the partition over which the result has been computed.</p>
<p>Fourth and final, at times, it may be useful to compute multiple different summary statistics across several different variables. This is not possible with the <code>aggregate</code> function, which takes a single <code>FUN</code> which specifies the summary function (<code>sum</code>) applied to the left-hand side of the formula (<code>mpg</code>). However, to allow for a diverse range of graphics, it may be useful to be able to compute multiple kinds of summaries across the same partitioning scheme, similar to how we can specify multiple aggregation functions within a single SQL <code>SELECT</code> statement <span class="citation">(<a href="#ref-codd1970">Codd 1970</a>)</span>. This could be useful, for example, if we want to map one summary to a barplot barsâ heights and a different summary to the barsâ widths.</p>
</div>
<div id="solution-computing-summaries-in-one-go" class="section level4 hasAnchor" number="7.3.4.2">
<h4><span class="header-section-number">7.3.4.2</span> Solution: Computing summaries in one go<a href="system.html#solution-computing-summaries-in-one-go" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Altogether, I argue that a more effective way to describe the hierarchical summarization process underlying many types of plots is a single operation (function call). This operation takes as its inputs a set of summary statistics to compute and a list of partitions to compute them over, and returns a list of aggregated data sets. To give a simplified example, note the following pseudo-code:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="system.html#cb57-1" tabindex="-1"></a><span class="fu">compute</span>(</span>
<span id="cb57-2"><a href="system.html#cb57-2" tabindex="-1"></a>  <span class="at">data =</span> mtcars,</span>
<span id="cb57-3"><a href="system.html#cb57-3" tabindex="-1"></a>  <span class="at">partition_by =</span> <span class="fu">c</span>(cyl, am),</span>
<span id="cb57-4"><a href="system.html#cb57-4" tabindex="-1"></a>  <span class="at">summaries =</span> <span class="fu">list</span>(<span class="at">stat1 =</span> <span class="fu">sum</span>(mpg), <span class="at">stat2 =</span> <span class="fu">max</span>(wt))</span>
<span id="cb57-5"><a href="system.html#cb57-5" tabindex="-1"></a>  )</span></code></pre></div>
<p>This approach has several key benefits. First, it automatically and concisely encodes the hierarchical structure. By specifying a list of partitioning variables, we can let the system take the partition products and link the different levels together. Second, by specifying a list/dictionary of summaries, we can append the function that has been used to compute the summary function as metadata to the result. For instance, within the body of the <code>compute</code> function, we could append the appropriate metadata as follows:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="system.html#cb58-1" tabindex="-1"></a><span class="fu">attr</span>(result<span class="sc">$</span>stat1, <span class="st">&quot;reducer&quot;</span>) <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb58-2"><a href="system.html#cb58-2" tabindex="-1"></a>  <span class="at">summaryfn =</span> sum, </span>
<span id="cb58-3"><a href="system.html#cb58-3" tabindex="-1"></a>  <span class="at">initialfn =</span> <span class="cf">function</span>() <span class="dv">0</span></span>
<span id="cb58-4"><a href="system.html#cb58-4" tabindex="-1"></a>  )</span>
<span id="cb58-5"><a href="system.html#cb58-5" tabindex="-1"></a></span>
<span id="cb58-6"><a href="system.html#cb58-6" tabindex="-1"></a><span class="fu">attr</span>(result<span class="sc">$</span>stat2, <span class="st">&quot;reducer&quot;</span>) <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb58-7"><a href="system.html#cb58-7" tabindex="-1"></a>  <span class="at">summaryfn =</span> max, </span>
<span id="cb58-8"><a href="system.html#cb58-8" tabindex="-1"></a>  <span class="at">initialfn =</span> <span class="cf">function</span>() <span class="sc">-</span><span class="cn">Inf</span></span>
<span id="cb58-9"><a href="system.html#cb58-9" tabindex="-1"></a>  )</span></code></pre></div>
<p>This gets to the idea of reduced variables and reducers, which will be discussed in more depth in Section <a href="system.html#aggregation-summaries">7.4.4.6</a>.</p>
</div>
<div id="encoding-summaries" class="section level4 hasAnchor" number="7.3.4.3">
<h4><span class="header-section-number">7.3.4.3</span> Encoding summaries<a href="system.html#encoding-summaries" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>After we have computed a hierarchy of summaries (via some hypothetical function like <code>compute</code>), we are left with a list of data sets which represent summaries encoded at different levels of aggregation or granularity. We can then easily map these data sets to aesthetic encodings and apply transformations like stacking (since the aggregated variables contain metadata about how they have been computed). Further, an important thing to note is that the data sets computed at different levels of partitioning can be encoded in different ways and used for different purposes. For instance, for many types of aggregate plots, the most granular data set can be used to encode object segments, which will be rendered via the graphical device, whereas a less granular data set may be used to encode object boundaries, which can be used to train scales and for collision detection during linked selection.</p>
<p>For instance, the following code describes how we may compute and encode data for a barplot:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="system.html#cb59-1" tabindex="-1"></a>summarized_data <span class="ot">&lt;-</span> <span class="fu">compute</span>(</span>
<span id="cb59-2"><a href="system.html#cb59-2" tabindex="-1"></a>  <span class="at">data =</span> mtcars,</span>
<span id="cb59-3"><a href="system.html#cb59-3" tabindex="-1"></a>  <span class="at">partition_by =</span> <span class="fu">c</span>(cyl, am),</span>
<span id="cb59-4"><a href="system.html#cb59-4" tabindex="-1"></a>  <span class="at">summaries =</span> <span class="fu">list</span>(<span class="at">stat =</span> <span class="fu">sum</span>(mpg))</span>
<span id="cb59-5"><a href="system.html#cb59-5" tabindex="-1"></a>  )</span>
<span id="cb59-6"><a href="system.html#cb59-6" tabindex="-1"></a></span>
<span id="cb59-7"><a href="system.html#cb59-7" tabindex="-1"></a><span class="co"># Computed over cyl</span></span>
<span id="cb59-8"><a href="system.html#cb59-8" tabindex="-1"></a>barplot_object_data <span class="ot">&lt;-</span> <span class="fu">encode</span>(</span>
<span id="cb59-9"><a href="system.html#cb59-9" tabindex="-1"></a>  summarized_data[<span class="dv">1</span>],</span>
<span id="cb59-10"><a href="system.html#cb59-10" tabindex="-1"></a>  <span class="at">encodings =</span> <span class="fu">list</span>(<span class="at">x =</span> cyl, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">width =</span> <span class="dv">1</span>, <span class="at">height =</span> stat)</span>
<span id="cb59-11"><a href="system.html#cb59-11" tabindex="-1"></a>)</span>
<span id="cb59-12"><a href="system.html#cb59-12" tabindex="-1"></a></span>
<span id="cb59-13"><a href="system.html#cb59-13" tabindex="-1"></a><span class="co"># Computed over product of cyl and am</span></span>
<span id="cb59-14"><a href="system.html#cb59-14" tabindex="-1"></a>barplot_segment_data <span class="ot">&lt;-</span> <span class="fu">encode</span>(</span>
<span id="cb59-15"><a href="system.html#cb59-15" tabindex="-1"></a>  summarized_data[<span class="dv">2</span>],</span>
<span id="cb59-16"><a href="system.html#cb59-16" tabindex="-1"></a>  <span class="at">encodings =</span> <span class="fu">list</span>(<span class="at">x =</span> cyl, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">width =</span> <span class="dv">1</span>, </span>
<span id="cb59-17"><a href="system.html#cb59-17" tabindex="-1"></a>                   <span class="at">height =</span> <span class="fu">stack</span>(stat))</span>
<span id="cb59-18"><a href="system.html#cb59-18" tabindex="-1"></a>)</span></code></pre></div>
<p>The <code>encoded_object_data</code> data set represents the whole barplot bars and may be used for training scales and collision detection, while the <code>encoded_segment_data</code> data set represents the more granular bar segments, which are actually rendered. Notice how the <code>stack</code> function is only applied to the segment data, since this represents the finest level of partitioning.</p>
<p>In some way, this is similar to how data variables are mapped to aesthetics in <code>ggplot2</code> using the <code>aes()</code> function <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span>. However, as discussed in Section <a href="system.html#model-pipeline">7.3.1</a>, an important difference is that in <code>ggplot2</code>, the aesthetic mapping occurs <em>before</em> the variables are summarized, making the data dependencies more explicit and also making certain interactive operations more efficient. Specifically, separating the summary and encoding step enables simple and efficient representation switching. For instance, to turn the barplot into a spineplot, we could use the same summary data and simply swap the encoding scheme:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="system.html#cb60-1" tabindex="-1"></a>spineplot_object_data <span class="ot">&lt;-</span> <span class="fu">encode</span>(</span>
<span id="cb60-2"><a href="system.html#cb60-2" tabindex="-1"></a>  summarized_data[<span class="dv">1</span>],</span>
<span id="cb60-3"><a href="system.html#cb60-3" tabindex="-1"></a>  <span class="at">encodings =</span> <span class="fu">list</span>(<span class="at">x =</span> cyl, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">width =</span> stat, <span class="at">height =</span> <span class="dv">1</span>)</span>
<span id="cb60-4"><a href="system.html#cb60-4" tabindex="-1"></a>)</span>
<span id="cb60-5"><a href="system.html#cb60-5" tabindex="-1"></a></span>
<span id="cb60-6"><a href="system.html#cb60-6" tabindex="-1"></a>spineplot_segment_data <span class="ot">&lt;-</span> <span class="fu">encode</span>(</span>
<span id="cb60-7"><a href="system.html#cb60-7" tabindex="-1"></a>  summarized_data[<span class="dv">2</span>],</span>
<span id="cb60-8"><a href="system.html#cb60-8" tabindex="-1"></a>  <span class="at">encodings =</span> <span class="fu">list</span>(<span class="at">x =</span> cyl, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">width =</span> stat, </span>
<span id="cb60-9"><a href="system.html#cb60-9" tabindex="-1"></a>                   <span class="at">height =</span> <span class="fu">normalize</span>(<span class="fu">stack</span>(stat)))</span>
<span id="cb60-10"><a href="system.html#cb60-10" tabindex="-1"></a>)</span></code></pre></div>
</div>
</div>
</div>
<div id="low-level-implementation" class="section level2 hasAnchor" number="7.4">
<h2><span class="header-section-number">7.4</span> Low-level implementation (<code>plotscape</code>)<a href="system.html#low-level-implementation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This section describes the actual platform used to produce and manipulate interactive figures, as implemented in <code>plotscape</code>. I begin with the discussion of some broader concerns, specifically the choice of programming paradigm (Section <a href="system.html#programming-paradigm">7.4.1</a>), data representation (Section <a href="system.html#row-column">7.4.2</a>), and reactivity model (Section <a href="system.html#reactivity">7.4.3</a>. Finally, I provide a detailed listing of the systemâs components and their functionality (Section <a href="system.html#components">7.4.4</a>). Some readers may find it easier to start with Section <a href="system.html#components">7.4.4</a>, as this presents the most concrete information.</p>
<p>Key concepts are explained via example code chunks. All are valid TypeScript code, and many are even evaluated, using the <a href="https://bun.sh/">Bun</a> TypeScript/JavaScript runtime <span class="citation">(<a href="#ref-bun2025"><span>â<span>Bun</span>â</span> 2025</a>)</span>. The reason why TypeScript was chosen over R for these examples is that explicit type signatures make many of the concepts much easier to explain. Further, since <code>plotscape</code> is written in TypeScript, many of the examples are taken almost directly from the codebase (with minor adjustments for sake of consistency and conciseness).</p>
<div id="programming-paradigm" class="section level3 hasAnchor" number="7.4.1">
<h3><span class="header-section-number">7.4.1</span> Programming paradigm<a href="system.html#programming-paradigm" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first broad issue worth briefly discussing is the choice of programming paradigm for <code>plotscape</code>. In Section <a href="system.html#high-level-api">7.2</a>, I intentionally omitted discussions of this issue since the material was fairly high level. However, since I will now start delving into implementation details, I believe it it important to give the topic of programming paradigms a brief consideration.</p>
<p>Broadly speaking, a programming paradigm is a set of rules for reasoning about the structure of computer programs, offering guidelines and conventions about common programming concerns, such as data representation, code organization, and control flow. Importantly, while many languages lean towards a single paradigm <span class="citation">(see e.g. <a href="#ref-van2009">Van Roy et al. 2009</a>)</span>, the languages two I chose for my implementation of <code>plotscape</code>/<code>plotscaper</code> - JavaScript/TypeScript and R - are both multi-paradigm <span class="citation">(<a href="#ref-chambers2014">Chambers 2014</a>; <a href="#ref-mdn2024c">MDN 2024e</a>)</span>. As C-inspired languages, they both support classical procedural programming. Further, thanks to first-class function support, they also allow for functional programming style <span class="citation">(<a href="#ref-chambers2014">Chambers 2014</a>; <a href="#ref-mdn2024e">MDN 2024c</a>)</span>. Finally, they also support object-oriented programming, via prototype inheritance in the case of JavaScript <span class="citation">(<a href="#ref-mdn2024d">MDN 2024b</a>)</span> and the S3, S4, and R6 object systems in the case of R <span class="citation">(<a href="#ref-wickham2019">Wickham 2019</a>)</span>. This multiparadigm nature of R and JavaScript made it possible for me to experiment with several approaches.</p>
<p>In the following subsections, I will briefly outline four programming paradigms: object-oriented, functional, and data-oriented programming. I will discuss their key features, trade-offs, and suitability for interactive data visualization systems. Finally, I will provide a rationale for my choice of programming paradigm and discuss my specific use of it in <code>plotscape</code>.</p>
<div id="procedural-programming" class="section level4 hasAnchor" number="7.4.1.1">
<h4><span class="header-section-number">7.4.1.1</span> Procedural programming<a href="system.html#procedural-programming" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Procedural programming, also known as imperative programming<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a>, is perhaps the oldest and most widely-known programming paradigm. Formalized by John Von Neumann in 1945 <span class="citation">(<a href="#ref-von1993">Von Neumann 1993</a>; for a review, see <a href="#ref-knuth1970">Knuth 1970</a>; <a href="#ref-eigenmann1998">Eigenmann and Lilja 1998</a>)</span>, it fundamentally views <strong>programs as linear sequences of discrete operations</strong> modifying some mutable state <span class="citation">(<a href="#ref-frame2014">Frame and Coffey 2014</a>)</span>. While these operations can be grouped into functions or procedures to build larger programs, the core organization remains sequential. This approach closely mirrors how programs are executed on the underlying hardware <span class="citation">(most CPUs execute instructions sequentially, beyond some advanced techniques such as branch prediction and speculative execution, see e.g. <a href="#ref-parihar2015">Parihar 2015</a>; <a href="#ref-raghavan1998">Raghavan, Shachnai, and Yaniv 1998</a>)</span>.</p>
<p>Compared to the other programming paradigms discussed below, procedural programming is generally a lot less opinionated. It primarily serves as a framework for classifying basic programming constructs like variables, functions, and loops, offering little guidance on best practices or how to structure programs. Because most programming languages include at least some procedural constructs, many programs are, as a consequence, at least partly procedural.</p>
<p>As for the suitability of procedural programming for interactive data visualization, there are some pros and cons. Since programs written in procedural style map fairly closely onto CPU instructions, they tend to be, in general, highly performant; for example, it is generally considered good practice to use procedural (imperative) code in performance-critical âhotâ code paths such as large loops <span class="citation">(see e.g. <a href="#ref-acton2014">Acton 2014</a>)</span>. However, a purely procedural style can introduce challenges when developing larger systems. Because this style imposes few restrictions on the program structure, it can, without careful management, lead to code complex and hard-to-extend code.</p>
</div>
<div id="functional" class="section level4 hasAnchor" number="7.4.1.2">
<h4><span class="header-section-number">7.4.1.2</span> Functional programming<a href="system.html#functional" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Functional programming is another fairly well-known and mature programming paradigm. With roots in the lambda calculus of Alonzo Church <span class="citation">(<a href="#ref-church1936">Church 1936</a>, <a href="#ref-church1940">1940</a>; for a brief overview, see e.g. <a href="#ref-abelson2022">Abelson and Sussman 2022</a>; <a href="#ref-frisby2025">Lonsdorf 2025</a>)</span>, the central idea of functional programming is function composition. Programs are built from <strong>pure functions</strong> without side-effects, which operate on immutable data. Further, functions are treated as <strong>first-class citizens</strong>, allowing functions to take other functions as arguments or return them (leading to âhigher-order functionsâ). Ultimately, under this paradigm, programs are modeled as data pipelines, transforming input to output without altering mutable state.</p>
<p>A key benefit of the functional approach is <strong>referential transparency</strong> <span class="citation">(see e.g. <a href="#ref-abelson2022">Abelson and Sussman 2022</a>; <a href="#ref-frisby2025">Lonsdorf 2025</a>; <a href="#ref-milewski2018">Milewski 2018</a>; <a href="#ref-stepanov2009">Stepanov and McJones 2009</a>)</span>. Because pure functions have no side effects, expressions can always be substituted with their values and vice versa. For instance, just as the expression <code>1 + 2</code> can always be replaced by the value <code>3</code>, so can the call to the function <code>function add(x, y) { return x + y; }</code> be replaced with the expression <code>x + y</code>. This property is incredibly useful as it allows us to reason about individual functions in isolation, without needing to consider the programâs state. However, referential transparency only holds as long as the function does not modify any mutable state; assigning to non-local variables or performing I/O operations breaks this property, forcing us to consider the programâs state.</p>
<p>Relevant to this thesis, functional programming also has close ties to mathematics, particularly category theory <span class="citation">(see <a href="#ref-milewski2018">Milewski 2018</a>)</span>. Many algebraic concepts discussed in Section <a href="problems.html#problems">5</a> â including preorders, functors, and monoids â have direct counterparts in functional programming. More specifically, these are often implemented as polymorphic type classes: for instance, in Haskell <span class="citation">(<a href="#ref-haskell1970">Haskell.org 1970</a>)</span>, users can define an arbitrary monoid type class which then supports list aggregation <span class="citation">(<a href="#ref-haskell2019">HaskellWiki 2019</a>)</span>.</p>
<p>As before, when it comes to interactive data visualization, functional programming presents some key trade-offs. While properties like referential transparency are attractive, all data visualization systems must ultimately manage mutable state, specifically the graphical device. User interaction introduces further complexity which is challenging to model in a purely functional manner (although it is certainly possible; see Section <a href="system.html#streams">7.4.3.2</a>). This might explain why purely functional interactive data visualization libraries are scarce, despite the presence of functional libraries for static visualization <span class="citation">(see e.g. <a href="#ref-petricek2021">Petricek 2021</a>)</span>. Nevertheless, many functional programming concepts are valuable even outside of purely functional programs. For example, a system may work with mutable state while remaining largely composed of pure functions, by âseparating calculating from doingâ <span class="citation">(see <a href="#ref-normand2021">Normand 2021</a>; <a href="#ref-vaneerd2024">Van Eerd 2024</a>)</span>.</p>
</div>
<div id="oop" class="section level4 hasAnchor" number="7.4.1.3">
<h4><span class="header-section-number">7.4.1.3</span> Object-oriented programming<a href="system.html#oop" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Compared to the two previous paradigms, object oriented programming (OOP) is a more recent, yet also highly mature and widely-adopted, framework. Emerging in the late 1950âs and early 1960âs with languages like Simula and Smalltalk it grew to prominence in the 1980âs and 1990âs and eventually become an industry standard in many domains <span class="citation">(<a href="#ref-black2013">Black 2013</a>)</span>.</p>
<p>The core OOP concept is the <strong>object</strong>. Objects are self-contained units of code which own hidden, private state, exposing only a limited public interface, interacting with each other via messages <span class="citation">(<a href="#ref-meyer1997">Meyer 1997</a>)</span>. This design was directly inspired by communication patterns found in the networks of biological cells <span class="citation">(as reported by <a href="#ref-kay1996">Kay 1996</a>, one of the creators of Smalltalk)</span>. Beyond that, concrete interpretations of OOP often differ, however, nevertheless, there are several ideas which tend to be shared across most OOP implementations.</p>
<p>These central ideas of OOP are: abstraction, encapsulation, polymorphism, and inheritance <span class="citation">(<a href="#ref-booch2008">Booch et al. 2008</a>)</span>. First, <strong>abstraction</strong> means objects should be usable without the knowledge of their internals. Users should rely solely on the public interface (behavior) of an object, simplifying reasoning and reducing complexity <span class="citation">(<a href="#ref-black2013">Black 2013</a>; <a href="#ref-meyer1997">Meyer 1997</a>)</span>. Second, <strong>encapsulation</strong> means that internal data should be kept private, and the surface area of an object should be as small as possible <span class="citation">(<a href="#ref-booch2008">Booch et al. 2008</a>)</span>. Users should not access or depend on this hidden data <span class="citation">(<a href="#ref-meyer1997">Meyer 1997</a>)</span>. The primary goal of encapsulation is continuity, allowing developers to modify an objectâs implementation without affecting the public interface <span class="citation">(<a href="#ref-booch2008">Booch et al. 2008</a>; <a href="#ref-meyer1997">Meyer 1997</a>)</span>. Third, <strong>polymorphism</strong> means that objects supporting the same operations should be interchangeable at runtime <span class="citation">(<a href="#ref-booch2008">Booch et al. 2008</a>)</span>. Polymorphism is intended to facilitate extensibility, allowing users to construct new objects which may be integrated into an existing system. Finally, <strong>inheritance</strong> is a mechanism used for code reuse and implementing polymorphism, where objects may inherit properties and behavior from other objects.</p>
<p>It is also important to briefly mention the model-view-controller (MVC) architecture <span class="citation">(see e.g. <a href="#ref-krasner1988">Krasner, Pope, et al. 1988</a>; <a href="#ref-leff2001">Leff and Rayfield 2001</a>)</span>. This popular OOP pattern divides the application into three parts, where the model manages the applicationâs state, the view represents it graphically, and the controller orchestrates updates between the two as well as handles user input. The aim of this pattern is to encourage separation of concerns and reusability, such that, for example, one model may be displayed by several views <span class="citation">(for example, the same data may be displayed as a graph and a table, see <a href="#ref-krasner1988">Krasner, Pope, et al. 1988</a>)</span>.</p>
<p>Object-oriented programming (OOP) has seen widespread adoption, especially in GUIs, which might suggest it as a natural fit for interactive data visualization systems <span class="citation">(see also <a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>. Furthermore, the MVC architecture has been used in interactive data visualization <span class="citation">(see e.g. <a href="#ref-xie2014">Xie, Hofmann, and Cheng 2014</a>)</span>, and OOPâs claimed benefits of continuity and extensibility appear highly attractive for library design. However, more recently, traditional OOP style has also faced some criticisms. First, while encouraging extensibility and reducing complexity via abstraction, encapsulation, and polymorphism seems attractive, real-world OOP implementations do not always achieve these goals. For instance, a common OOP practice is for objects to communicate by sending pointers to each other. This however breaks encapsulation and causes objects to become entangled, creating âincidental data structuresâ <span class="citation">(<a href="#ref-hickey2011">Hickey 2011</a>; <a href="#ref-parent2015">Parent 2015</a>; <a href="#ref-will2016">Will 2016</a>)</span>. Further, by its nature, OOP heavily encourages abstraction. While good abstractions are undeniably useful, they take long time to develop. Poor abstractions tend to appear first, and, once in place, are difficult to extricate <span class="citation">(<a href="#ref-meyer1997">Meyer 1997</a>)</span>. This can lead to overly complex and bloated systems <span class="citation">(<a href="#ref-vaneerd2024">Van Eerd 2024</a>)</span>. Finally, OOP can also negatively impact performance. Objects frequently hold more data than any single method requires, and, to support runtime polymorphism, they must store pointers to virtual method tables. Consequently, arrays of objects almost always take up more memory than equivalent arrays of plain values, resulting in more cache misses and decreased performance <span class="citation">(<a href="#ref-acton2014">Acton 2014</a>)</span>.</p>
</div>
<div id="dop" class="section level4 hasAnchor" number="7.4.1.4">
<h4><span class="header-section-number">7.4.1.4</span> Data-oriented programming<a href="system.html#dop" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Data-oriented programming (DOP) is a newer and less well-known programming paradigm. In fact, due to its recency, the term is used in multiple ways across different contexts, however, there are primarily two broad sets of ideas it encompasses. First, DOP sometimes refers to a more abstract paradigm, concerned with structure and organization of code. Inspired by the Clojure style of programming <span class="citation">(<a href="#ref-hickey2011">Hickey 2011</a>, <a href="#ref-hickey2018">2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>; <a href="#ref-parlog2024">Parlog 2024</a>)</span>, it also shares some similarities with the generic programming paradigm and value semantics popularized by Alexander Stepanov and popular the C++ community <span class="citation">(<a href="#ref-stepanov2009">Stepanov and McJones 2009</a>; <a href="#ref-stepanov2013">Stepanov 2013</a>; <a href="#ref-parent2013">Parent 2013</a>, <a href="#ref-parent2015">2015</a>, <a href="#ref-parent2018">2018</a>; <a href="#ref-vaneerd2023">Van Eerd 2023</a>; there are even some direct ties, see <a href="#ref-vaneerd2024">Van Eerd 2024</a>)</span>. Second, DOP (or âdata oriented designâ, DOD) also sometimes refers to a more concrete set of optimization techniques and ideas. Originating in video-game development, these primarily tend to focus on low-level details like memory layout and CPU cache line utilization <span class="citation">(<a href="#ref-acton2014">Acton 2014</a>; <a href="#ref-bayliss2022">Bayliss 2022</a>; <a href="#ref-kelley2023">Kelley 2023</a>; <a href="#ref-nikolov2018">Nikolov 2018</a>; <a href="#ref-fabian2018">Fabian 2018</a>)</span>. Interestingly, despite their distinct uses, both interpretations of âdata-oriented programmingâ converge on many similar ideas about the structure and organization of computer programs. As such, I believe it is justified to discuss them here as a single paradigm.</p>
<p>The core idea of DOP is a data-first perspective: programs should be viewed as transformations of data, nothing more, nothing less <span class="citation">(<a href="#ref-acton2014">Acton 2014</a>; <a href="#ref-fabian2018">Fabian 2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>)</span>. This idea has several important consequences. First, to truly elevate data to first-class status, it must be kept separate from code (behavior) <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>; <a href="#ref-vaneerd2024">Van Eerd 2024</a>)</span>. It should be represented by plain data structures, composed of primitives, arrays, and dictionaries <span class="citation">(a typical example would be <a href="appendix-glossary.html#JSON">JSON</a>, <a href="#ref-hickey2011">Hickey 2011</a>, <a href="#ref-hickey2018">2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>)</span>, which can be trivially copied and behave like values <span class="citation">(see <a href="#ref-stepanov2009">Stepanov and McJones 2009</a>; <a href="#ref-stepanov2013">Stepanov 2013</a>)</span>. Furthermore, it should be organized in a way that is convenient and efficient; there is no obligation for it to model abstract or real-world entities <span class="citation">(<a href="#ref-acton2014">Acton 2014</a>; the fundamental blueprint is that of the relational model, <a href="#ref-codd1970">Codd 1970</a>; <a href="#ref-moseley2006">Moseley and Marks 2006</a>; <a href="#ref-fabian2018">Fabian 2018</a>)</span>. Code, on the other hand, should live inside modules composed of stateless functions <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>)</span>. The primary benefit of this approach is that, by keeping data and code separate, we can reason about both in isolation, without entanglement <span class="citation">(<a href="#ref-vaneerd2024">Van Eerd 2024</a>)</span>. It also allows us to introduce abstraction gradually, by initially relying on generic data manipulation functions <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>)</span>. Finally, it also enables good performance: by storing plain data values and organizing them in a suitable format (for example, structure of arrays, see Section <a href="system.html#row-column">7.4.2</a>), we can ensure optimal cache line utilization [<span class="citation">Acton (<a href="#ref-acton2014">2014</a>)</span>; <span class="citation">Fabian (<a href="#ref-fabian2018">2018</a>)</span>; <span class="citation">Kelley (<a href="#ref-kelley2023">2023</a>)</span>;].</p>
<p>As might be apparent, data oriented programming shares some similarities with procedural and functional programming, but there are also some key differences. Compared to the lasseiz-faire approach of procedural programming, DOP tends to be a lot more opinionated about the structure of programs. Furthermore, while its focus on stateless functions might suggest a resemblance to functional programming, DOP generally does not prohibit mutation, and its emphasis on plain data over abstract behavior contrasts with the often highly abstract nature of purely functional code. As such, in my view, the ideas in DOP represent a distinct and fully-formed programming paradigm.</p>
<p>While DOP is a novel programming paradigm, there is a precedence for similar ideas in data visualization systems. Specifically, the popular tendency of defining plots via declarative schemas (see e.g.Â Section <a href="system.html#variables-encodings">7.2.2.3</a>) seems to align well with DOP principles. While this generally tends to be a feature of the packagesâ public facing APIs, not necessarily the implementation code, the popularity of JSON-like schemas might suggest that this style might be useful in designing data visualization packages more broadly.</p>
</div>
<div id="final-choice-of-programming-paradigm-and-rationale" class="section level4 hasAnchor" number="7.4.1.5">
<h4><span class="header-section-number">7.4.1.5</span> Final choice of programming paradigm and rationale<a href="system.html#final-choice-of-programming-paradigm-and-rationale" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Thanks to TypeScript/JavaScript (and R) being a multi-paradigm programming language, I was able to experiment with several programming paradigms. During initial prototyping, I used primarily procedural style, but I also explored some functional programming concepts. Later, I completely rewrote the package using traditional OOP style, but found some aspects of it frustrating and challenging. Particularly, with multiple communicating objects, I found it difficult to cleanly separate concerns and reason about complex interactive behavior. Eventually, I discovered DOP and ultimately settled on that style, finding that the plain data model greatly simplified a lot of the problems I had.</p>
<p>In my view, the primary advantage of DOP was the ability to reason about data and behavior separately. Many parts of the system, such as dataframes and scales (see Sections <a href="system.html#dataframe">7.4.4.3</a> and <a href="system.html#scales">7.4.4.7</a>), make sense to think about as primarily composed of plain data. Modeling them this way helps avoid much of the entanglement which is arguably inherent to traditional OOP objects. Specifically, plain data structures composed of primitives, arrays, and dictionaries naturally tend to form simple tree-like structures, rather than more complex graphs with potential circular references, simplifying reasoning <span class="citation">(<a href="#ref-parent2013">Parent 2013</a>, <a href="#ref-parent2015">2015</a>; <a href="#ref-vaneerd2024">Van Eerd 2024</a>)</span><a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>. Further, defining behavior in pure function modules made it much easier to refactor and test. I also believe it encouraged a more conservative coding style: the requirement to pass all data explicitly as arguments, rather than relying on implicit class properties (members), made me more disciplined, by encouraging me to pass on only the necessary data and nothing more. Finally, it greatly simplified scenarios requiring double (multiple) dispatch; instead of deciding which class a method should belong to and which it should dispatch on, I could simply write a free function dispatching on both.</p>
<p>The only place where I found myself reverting to OOP-like idioms was in the several areas requiring polymorphism. Specifically, while for most of the system, polymorphism is pure overhead (in my opinion), for certain components like scales, the ability to dispatch based on the underlying data type is desirable. Further, giving the users the ability to extend the system by implementing their own components is of course useful. However, instead of using classes, I implemented a custom dispatch mechanism myself. While, hypothetically, traditional OOP classes may be a decent solution here, I found that maintaining consistent style with the rest of the codebase was preferable.</p>
<p>While I did not attempt a purely (or even largely) functional implementation of <code>plotscape</code>, I believe there are several reasons why it might not be the optimal choice either. First, as mentioned in Section <a href="system.html#functional">7.4.1.2</a>, data visualization inherently requires dealing with significant amount of mutable state (the graphical device). Further, user interaction adds another element that is challenging to model in a purely functional style. While techniques for handling both do exist <span class="citation">(see e.g. <a href="#ref-abelson2022">Abelson and Sussman 2022</a>; <a href="#ref-frisby2025">Lonsdorf 2025</a>)</span>, and so do functional programming data visualization libraries <span class="citation">(see e.g. <a href="#ref-petricek2021">Petricek 2021</a>)</span>, I personally question whether the increased complexity is worthwhile. Second, similar to OOP, a purely functional style tends to introduce a high amount of abstraction. While good abstractions are incredibly powerful, I found that, generally, refactoring poorly-organized plain data containers was much easier than refactoring abstract constructs, be they classes or higher-kinded types.</p>
<p>Finally, while my preference for DOP might also be partly due to the fact that, over the course of the project, I naturally improved as a programmer, I do not believe that this is the full explanation. Even after settling on DOP, I have experimented with other paradigms but consistently find myself returning to DOP. While there are of course many less-than-perfectly-tidy areas of the <code>plotscape</code> codebase that could be refactored, I still believe that this less programming paradigm allowed me, a solo developer with limited time, to go further and develop more features without becoming overwhelmed by inherent complexity. Therefore, I felt it necessary to explain my choice of programming paradigm.</p>
</div>
<div id="style-used-in-code-examples" class="section level4 hasAnchor" number="7.4.1.6">
<h4><span class="header-section-number">7.4.1.6</span> Style used in code examples<a href="system.html#style-used-in-code-examples" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Another part of the reason why I spent time discussing the choice of the programming paradigm used in <code>plotscape</code> is because it is reflected in many of the code examples used throughout the rest of this chapter. Specifically, in these examples, I typically define a data container as a TypeScript <code>interface</code> and a collection of related functions in a <code>namespace</code> of the same name. Since TypeScript transpiles to JavaScript, and all of the type information is compile-time only, type (<code>interface</code>) and value (<code>namespace</code>) overloading like this is perfectly valid.</p>
<p>In some ways, this interface-namespace style might seem like object-oriented programming (OOP) with extra steps, i.e.Â where someone might write <code>const foo = new Foo(); const bar = foo.bar()</code>, I write <code>const foo = Foo.create(); const bar = Foo.bar(foo)</code>, however, there are a couple of important differences. First, unlike a class that tightly couples data and behavior, the interface-defined type is solely a data container, and the namespace is merely a container for free functions. As such, both can be reasoned about in isolation. Second, TypeScriptâs structural typing enables calling the namespace functions with <em>any</em> variable matching the type signature, not just class instances, significantly improving code reusability. Finally, unlike classes, the interface-defined types are simple data containers without polymorphism, and this eliminates the need for dynamic dispatch (in the general case), potentially improving performance. Overall, the style aligns with the data-oriented programming principles discussed in Section <a href="system.html#dop">7.4.1.4</a>.</p>
</div>
</div>
<div id="row-column" class="section level3 hasAnchor" number="7.4.2">
<h3><span class="header-section-number">7.4.2</span> Data representation: Row-oriented vs.Â column-oriented<a href="system.html#row-column" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Data visualization is fundamentally about the data; however, the same data can often be represented in multiple ways. This is important as different data representations have can offer different trade-offs, including ease of use and performance. In most data analytic applications, the fundamental data model is that of a two-dimensional table or dataframe. However, because computer memory is inherently one-dimensional, a choice must be made: should these tables be stored as arrays of heterogeneous records (rows) or as a dictionaries of homogeneous arrays (columns)?</p>
<p>In popular, in-memory data analytics applications, the column-store seems to be the prevaling model. This model organizes tables as dictionaries of columns, such that each column is a homogeneous array containing values of the same type. Unlike a matrix, however, different columns can store values of different types (e.g.Â floats, integers, or strings). Dataframe objects may also store optional metadata, such as row names, column labels, or grouping structures <span class="citation">(<a href="#ref-r2024">R Core Team 2024</a>; <a href="#ref-bouchet-valat2023">Bouchet-Valat and KamiÅski 2023</a>)</span>. Popular examples of this design include the S3 <code>data.frame</code> class in base R <span class="citation">(<a href="#ref-r2024">R Core Team 2024</a>)</span>, the <code>tbl_df</code> S3 class in the <code>tibble</code> package <span class="citation">(<a href="#ref-muller2023">MÃ¼ller and Wickham 2023</a>)</span>, the <code>DataFrame</code> class in the Python <code>pandas</code> <span class="citation">(<a href="#ref-pandas2024">Pandas Core Team 2024</a>)</span>, the <code>DataFrame</code> class in the <code>polars</code> <span class="citation">(<a href="#ref-polars2024">Team 2024</a>)</span>, or the <code>DataFrame</code> type in the Julia <code>DataFrame.jl</code> package <span class="citation">(<a href="#ref-bouchet-valat2023">Bouchet-Valat and KamiÅski 2023</a>)</span>.</p>
<p>However, there are also some fairly well-known examples of row-oriented systems. Particularly, the popular JavaScript data visualization and transformation library D3 <span class="citation">(<a href="#ref-bostock2022">Mike Bostock 2022</a>)</span> models data frames as arrays of rows, with each row being a JavaScript object. Likewise, row-stores are also highly popular in databases, particularly in online transaction processing (OLTP) systems such as PostgreSQL, SQLite, or MySQL, where tables are generally stored as arrays of records, both in memory and on disk <span class="citation">(see e.g. <a href="#ref-petrov2019">Petrov 2019</a>; <a href="#ref-abadi2013">Abadi et al. 2013</a>; <a href="#ref-pavlo2024">Pavlo 2024</a>)</span>.</p>
<p>Finally, within the broader programming context, the two data models are also known as the struct-of-arrays (SoA) and array-of-structs (AoS) layouts, corresponding roughly to the column- and row-store, respectively <span class="citation">(see e.g. <a href="#ref-acton2014">Acton 2014</a>; <a href="#ref-kelley2023">Kelley 2023</a>)</span>. Here, the distinction is a bit more nuanced, since the stored data may be interpreted as more than just plain values, making either representation more or less natural in certain programming paradigms (see Section <a href="system.html#programming-paradigm">7.4.1</a>). For example, in object-oriented programming (OOP), the fundamental unit of code is an object (see Section <a href="system.html#oop">7.4.1.3</a>). Since objects are meant to encapsulate their properties - both data and behaviour (via a pointer to a virtual method table) - the AoS layout, which keeps object properties adjacent in memory, is the more natural choice in OOP <span class="citation">(see e.g. <a href="#ref-bayliss2022">Bayliss 2022</a>)</span>.</p>
<div id="ease-of-use" class="section level4 hasAnchor" number="7.4.2.1">
<h4><span class="header-section-number">7.4.2.1</span> Ease of use<a href="system.html#ease-of-use" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When it comes to user experience, the row-oriented (AoS) model may be slightly easier for novice users; however, this difference is probably fairly minor. While many data analysis workflows involve row-oriented operations, which, in the row-oriented model, can be performed by indexing the array of rows once (rather than requiring indexing across multiple columns), many column-oriented applications also provide support for row operations, either through library functionality <span class="citation">(e.g., pandas, <a href="#ref-pandas2024">Pandas Core Team 2024</a>)</span>, or directly at the language level <span class="citation">(e.g., R, <a href="#ref-r2024">R Core Team 2024</a>)</span>. Furthermore, the prevalence of column-oriented workflows within the data science ecosystem means that many users will be already familiar with this layout. Therefore, on balance, I believe that, in terms of user experience, there is little difference between the two data layouts.</p>
</div>
<div id="row-column-performance" class="section level4 hasAnchor" number="7.4.2.2">
<h4><span class="header-section-number">7.4.2.2</span> Performance<a href="system.html#row-column-performance" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A key factor determining the performance of row-oriented vs.Â column-oriented storage is the intended use. Specifically, depending on how the store is intended to be used, one layout may provide better performance characteristics than the other.</p>
<p>The column-oriented (SoA) layout tends to be the more performant option for storage and operations across multiple rows, particularly aggregation <span class="citation">(see e.g. <a href="#ref-acton2014">Acton 2014</a>; <a href="#ref-kelley2023">Kelley 2023</a>; <a href="#ref-pavlo2024">Pavlo 2024</a>)</span>. This is due to the fact that it benefits from better memory alignment and, as a result, improved cache locality. Because all values within a column share the same size, this eliminates the need for padding, often resulting in a significantly smaller memory footprint <span class="citation">(see e.g. <a href="#ref-rentzsch2005">Rentzsch 2005</a>; <a href="#ref-kelley2023">Kelley 2023</a>; <a href="#ref-pavlo2024">Pavlo 2024</a>)</span>. Furthermore, this uniform sizing also facilitates easier pre-fetching of values during column-wise operations. Specifically, the CPU can cache contiguous chunks of values, often leading to greatly improved performance for operations such as summing a long list of values <span class="citation">(<a href="#ref-abadi2013">Abadi et al. 2013</a>; <a href="#ref-acton2014">Acton 2014</a>; <a href="#ref-kelley2023">Kelley 2023</a>; <a href="#ref-pavlo2024">Pavlo 2024</a>)</span>. This has made the column-oriented layout the preferred solution in online analytical processing (OLAP) databases <span class="citation">(<a href="#ref-abadi2013">Abadi et al. 2013</a>; <a href="#ref-pavlo2024">Pavlo 2024</a>)</span>.</p>
<p>In contrast, the row-oriented (AoS) layout performs better at single-row read and write operations. Because all values for a record are stored contiguously, they can be retrieved without needing to be fetched and assembled from disparate memory locations. Similarly, writes are faster as only a single memory location needs to be modified. These characteristics have made the row-oriented layout the traditional choice in OLTP databases <span class="citation">(<a href="#ref-abadi2013">Abadi et al. 2013</a>; <a href="#ref-pavlo2024">Pavlo 2024</a>)</span>.</p>
<p>An important point to mention is that, in high-level languages like JavaScript, the underlying memory representation may differ significantly from the apparent structure. For instance, to optimize key access, the V8 engine stores JavaScript objects (dictionaries) as âhidden classesâ: essentially a pointer to the objectâs shape and an array of values <span class="citation">(<a href="#ref-bruni2017">Bruni 2017</a>; <a href="#ref-veight2024">V8 Core Team 2024</a>)</span>. Nevertheless, objects are still allocated on the heap, unlike packed arrays of small integers (SMIs) or floats, which consequently tend to offer much better performance characteristics <span class="citation">(see e.g. <a href="#ref-veight2017">V8 Core Team 2017</a>; <a href="#ref-bruni2017">Bruni 2017</a>; <a href="#ref-stange2024">Stange 2024</a>)</span>.</p>
</div>
<div id="final-choice-of-data-representation-and-rationale" class="section level4 hasAnchor" number="7.4.2.3">
<h4><span class="header-section-number">7.4.2.3</span> Final choice of data representation and rationale<a href="system.html#final-choice-of-data-representation-and-rationale" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As an interactive data visualization system, plotscape needed to support fast data transformations. Particularly, for linked selection, efficient aggregations were key. As such, the column-oriented data layout was chosen. While this approach differs from that of the most popular web-based data visualization framework [D3, Bostock, 2022], it aligns with the majority of other data analytic languages and libraries.</p>
</div>
</div>
<div id="reactivity" class="section level3 hasAnchor" number="7.4.3">
<h3><span class="header-section-number">7.4.3</span> Reactivity<a href="system.html#reactivity" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A key implementation detail of all interactive applications is reactivity: how a system responds to input and propagates changes. However, despite the fact that interactive user interfaces (UIs) have been around for a long time, there still exist many different, competing approaches to handling reactivity. A particularly famous<a href="#fn18" class="footnote-ref" id="fnref18"><sup>18</sup></a> example of this is the web ecosystem, where new UI frameworks seem to keep emerging all the time, each offering its unique spin on reactivity <span class="citation">(see e.g. <a href="#ref-ollila2022">Ollila, MÃ¤kitalo, and Mikkonen 2022</a>)</span>. This makes choosing the right reactivity model challenging.</p>
<p>Furthermore, reactivity is paramount in interactive data visualization systems due to many user interactions having cascading effects. For instance, when a user changes the binwidth of an interactive histogram, the counts within the bins need to be recomputed, which in turn means that scales may need to be updated, which in turn means that the entire figure may need to be re-rendered, and so on. Also, unlike other types of UI applications, interactive data visualizations have no upper bound on the number of UI elements - the more data the user can visualize the better. This makes efficient updates crucial. While re-rendering a button twice may not be a big deal for a simple webpage or GUI application, unnecessary re-renders of a scatterplot with tens-of-thousands of data points may cripple an interactive data visualization system.</p>
<p>Because of the reasons outlined above, reactivity was key concern for <code>plotscape</code>. While developing the package, I had evaluated and tried out several different reactivity models, before finally settling on a solution. Given the time and effort invested in this process, I believe it is valuable to give a brief overview of these models and discuss their inherent advantages and disadvantages, before presenting my chosen approach in Section <a href="system.html#reactivity-solution">7.4.3.5</a>.</p>
<div id="observer" class="section level4 hasAnchor" number="7.4.3.1">
<h4><span class="header-section-number">7.4.3.1</span> Observer pattern<a href="system.html#observer" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One of the simplest and most well-known methods for modeling reactivity is the Observer pattern <span class="citation">(<a href="#ref-gamma1995">Gamma et al. 1995</a>)</span>. Hereâs a simple implementation:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb61-1"><a href="system.html#cb61-1" tabindex="-1"></a><span class="co">// Observer.ts</span></span>
<span id="cb61-2"><a href="system.html#cb61-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Observer</span> {</span>
<span id="cb61-3"><a href="system.html#cb61-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">create</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T)<span class="op">:</span> T <span class="op">&amp;</span> Observer {</span>
<span id="cb61-4"><a href="system.html#cb61-4" tabindex="-1"></a>    <span class="cf">return</span> { <span class="op">...</span>x<span class="op">,</span> listeners<span class="op">:</span> {} }<span class="op">;</span></span>
<span id="cb61-5"><a href="system.html#cb61-5" tabindex="-1"></a>  }</span>
<span id="cb61-6"><a href="system.html#cb61-6" tabindex="-1"></a></span>
<span id="cb61-7"><a href="system.html#cb61-7" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">listen</span>(x<span class="op">:</span> Observer<span class="op">,</span> event<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> </span>
<span id="cb61-8"><a href="system.html#cb61-8" tabindex="-1"></a>                         cb<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dt">void</span>) {</span>
<span id="cb61-9"><a href="system.html#cb61-9" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>]) x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb61-10"><a href="system.html#cb61-10" tabindex="-1"></a>    x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>]<span class="op">.</span><span class="fu">push</span>(cb)<span class="op">;</span></span>
<span id="cb61-11"><a href="system.html#cb61-11" tabindex="-1"></a>  }</span>
<span id="cb61-12"><a href="system.html#cb61-12" tabindex="-1"></a></span>
<span id="cb61-13"><a href="system.html#cb61-13" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">dispatch</span>(x<span class="op">:</span> Observer<span class="op">,</span> event<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb61-14"><a href="system.html#cb61-14" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>]) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb61-15"><a href="system.html#cb61-15" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> cb <span class="kw">of</span> x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>]) <span class="fu">cb</span>()<span class="op">;</span></span>
<span id="cb61-16"><a href="system.html#cb61-16" tabindex="-1"></a>  }</span>
<span id="cb61-17"><a href="system.html#cb61-17" tabindex="-1"></a>}</span>
<span id="cb61-18"><a href="system.html#cb61-18" tabindex="-1"></a></span>
<span id="cb61-19"><a href="system.html#cb61-19" tabindex="-1"></a><span class="kw">const</span> person <span class="op">=</span> Observer<span class="op">.</span><span class="fu">create</span>({ name<span class="op">:</span> <span class="vs">`Joe`</span><span class="op">,</span> age<span class="op">:</span> <span class="dv">25</span> })<span class="op">;</span></span>
<span id="cb61-20"><a href="system.html#cb61-20" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">listen</span>(person<span class="op">,</span> <span class="vs">`age-increased`</span><span class="op">,</span> () <span class="kw">=&gt;</span></span>
<span id="cb61-21"><a href="system.html#cb61-21" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>person<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> is now </span><span class="sc">${</span>person<span class="op">.</span><span class="at">age</span><span class="sc">}</span><span class="vs"> years old.`</span>)</span>
<span id="cb61-22"><a href="system.html#cb61-22" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb61-23"><a href="system.html#cb61-23" tabindex="-1"></a></span>
<span id="cb61-24"><a href="system.html#cb61-24" tabindex="-1"></a>person<span class="op">.</span><span class="at">age</span> <span class="op">=</span> <span class="dv">26</span><span class="op">;</span></span>
<span id="cb61-25"><a href="system.html#cb61-25" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">dispatch</span>(person<span class="op">,</span> <span class="vs">`age-increased`</span>)<span class="op">;</span></span></code></pre></div>
<pre><code>Joe is now 26 years old.</code></pre>
<p>Internally, an <code>Observer</code> object stores a dictionary where the keys are the events that the object can dispatch or notify its listeners of, and values are arrays of callbacks<a href="#fn19" class="footnote-ref" id="fnref19"><sup>19</sup></a>. Listeners listen (or âsubscribeâ) to specific events by adding their callbacks to the relevant array. When an event occurs, the callbacks in the appropriate array are iterated through and executed in order.</p>
<p>The <code>Observer</code> pattern easy to implement and understand, and, compared to alternatives, also tends to be fairly performant. However, a key downside is that the listeners have to subscribe to the <code>Observer</code> manually. In other words, whenever client code uses <code>Observer</code> values, it needs to be aware of this fact and subscribe to them in order to avoid becoming stale. Further, the logic for synchronizing updates has to be implemented manually as well. For instance, by default, there is no mechanism for handling dispatch order: the listeners who were subscribed earlier in the code are called first<a href="#fn20" class="footnote-ref" id="fnref20"><sup>20</sup></a>. Moreover, shared dependencies can cause glitches and these have to be resolved manually as well. See for instance the following example:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb63-1"><a href="system.html#cb63-1" tabindex="-1"></a><span class="im">import</span> { Observer } <span class="im">from</span> <span class="st">&quot;./Observer&quot;</span></span>
<span id="cb63-2"><a href="system.html#cb63-2" tabindex="-1"></a></span>
<span id="cb63-3"><a href="system.html#cb63-3" tabindex="-1"></a><span class="kw">function</span> <span class="fu">update</span>(x<span class="op">:</span> { name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span> value<span class="op">:</span> <span class="dt">number</span> } <span class="op">&amp;</span> Observer<span class="op">,</span> </span>
<span id="cb63-4"><a href="system.html#cb63-4" tabindex="-1"></a>                value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb63-5"><a href="system.html#cb63-5" tabindex="-1"></a>  x<span class="op">.</span><span class="at">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb63-6"><a href="system.html#cb63-6" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>x<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> updated to`</span><span class="op">,</span> x<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb63-7"><a href="system.html#cb63-7" tabindex="-1"></a>  Observer<span class="op">.</span><span class="fu">dispatch</span>(x<span class="op">,</span> <span class="vs">`updated`</span>)<span class="op">;</span></span>
<span id="cb63-8"><a href="system.html#cb63-8" tabindex="-1"></a>}</span>
<span id="cb63-9"><a href="system.html#cb63-9" tabindex="-1"></a></span>
<span id="cb63-10"><a href="system.html#cb63-10" tabindex="-1"></a><span class="kw">const</span> A <span class="op">=</span> Observer<span class="op">.</span><span class="fu">create</span>({ name<span class="op">:</span> <span class="vs">`A`</span><span class="op">,</span> value<span class="op">:</span> <span class="dv">1</span> })<span class="op">;</span></span>
<span id="cb63-11"><a href="system.html#cb63-11" tabindex="-1"></a><span class="kw">const</span> B <span class="op">=</span> Observer<span class="op">.</span><span class="fu">create</span>({ name<span class="op">:</span> <span class="vs">`B`</span><span class="op">,</span> value<span class="op">:</span> A<span class="op">.</span><span class="at">value</span> <span class="op">*</span> <span class="dv">10</span> })<span class="op">;</span></span>
<span id="cb63-12"><a href="system.html#cb63-12" tabindex="-1"></a><span class="kw">const</span> C <span class="op">=</span> Observer<span class="op">.</span><span class="fu">create</span>({ name<span class="op">:</span> <span class="vs">`C`</span><span class="op">,</span> value<span class="op">:</span> A<span class="op">.</span><span class="at">value</span> <span class="op">+</span> B<span class="op">.</span><span class="at">value</span> })<span class="op">;</span></span>
<span id="cb63-13"><a href="system.html#cb63-13" tabindex="-1"></a></span>
<span id="cb63-14"><a href="system.html#cb63-14" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">listen</span>(A<span class="op">,</span> <span class="vs">`updated`</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="fu">update</span>(B<span class="op">,</span> A<span class="op">.</span><span class="at">value</span> <span class="op">*</span> <span class="dv">10</span>))<span class="op">;</span></span>
<span id="cb63-15"><a href="system.html#cb63-15" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">listen</span>(A<span class="op">,</span> <span class="vs">`updated`</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="fu">update</span>(C<span class="op">,</span> A<span class="op">.</span><span class="at">value</span> <span class="op">+</span> B<span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb63-16"><a href="system.html#cb63-16" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">listen</span>(B<span class="op">,</span> <span class="vs">`updated`</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="fu">update</span>(C<span class="op">,</span> A<span class="op">.</span><span class="at">value</span> <span class="op">+</span> B<span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb63-17"><a href="system.html#cb63-17" tabindex="-1"></a></span>
<span id="cb63-18"><a href="system.html#cb63-18" tabindex="-1"></a><span class="fu">update</span>(A<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span> <span class="co">// C will get updated twice</span></span></code></pre></div>
<pre><code>Joe is now 26 years old.
A updated to 2
B updated to 20
C updated to 22
C updated to 22</code></pre>
<p>The example above shows the so-called diamond problem in reactive programming<a href="#fn21" class="footnote-ref" id="fnref21"><sup>21</sup></a>. We have three reactive variables <code>A</code>, <code>B</code>, and <code>C</code>, such that <code>B</code> depends on <code>A</code>, and <code>C</code> depends simultaneously on <code>A</code> and <code>B</code>. Since <code>C</code> depends on <code>A</code> and <code>B</code>, it has to subscribe to both. However, <code>C</code> is not aware of the global context of the reactive graph: it does not know that <code>B</code> will update any time <code>A</code> does. As such, an update to <code>A</code> will trigger <em>two</em> updates to <code>C</code> despite the fact that, intuitively, it should only cause one.</p>
<p>Without careful management of dependencies, this reactive graph myopia that the <code>Observer</code> pattern exhibits can create computational bottlenecks, particularly in high-throughput UIs such as interactive data visualizations. Consider an interactive histogram where users can either modify binwidth or directly set breaks. If both are implemented as reactive parameters, a poorly managed dependency graph (e.g., breaks dependent on binwidth, and rendering dependent on both) will result in unnecessary re-renders, impacting performance at high data volumes.</p>
</div>
<div id="streams" class="section level4 hasAnchor" number="7.4.3.2">
<h4><span class="header-section-number">7.4.3.2</span> Streams<a href="system.html#streams" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A radically different approach to reactivity is offered by streams <span class="citation">(see e.g. <a href="#ref-abelson2022">Abelson and Sussman 2022</a>)</span>. Instead of events directly modifying data state, streams separate event generation from event processing, modeling the latter as pure, primarily side-effect-free transformations. These transformations can then be composed via usual function composition to build arbitrarily complex processing logic. Finally, due to the separation between the stateful event producers and stateless event transformations, this approach aligns closely with methods such as generators/iterators as well as functional programming more broadly <span class="citation">(<a href="#ref-abelson2022">Abelson and Sussman 2022</a>; <a href="#ref-fogus2013">Fogus 2013</a>)</span>, and has implementations in numerous functional programming languages and libraries, most notably the polyglot Reactive Extensions library <span class="citation">(also known as ReactiveX, <a href="#ref-reactive2024">Rxteam 2024</a>)</span>.</p>
<p>Consider the following implementation of a stream which produces values at 200-millisecond intervals and stops after 1 second:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb65-1"><a href="system.html#cb65-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">intervalSteam</span>(milliseconds<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> stopTime<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb65-2"><a href="system.html#cb65-2" tabindex="-1"></a>  <span class="kw">let</span> streamfn <span class="op">=</span> (x<span class="op">:</span> <span class="dt">unknown</span>) <span class="kw">=&gt;</span> x<span class="op">;</span></span>
<span id="cb65-3"><a href="system.html#cb65-3" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> { pipe }<span class="op">;</span></span>
<span id="cb65-4"><a href="system.html#cb65-4" tabindex="-1"></a></span>
<span id="cb65-5"><a href="system.html#cb65-5" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pipe</span>(fn<span class="op">:</span> (x<span class="op">:</span> <span class="dt">any</span>) <span class="kw">=&gt;</span> <span class="dt">unknown</span>) {</span>
<span id="cb65-6"><a href="system.html#cb65-6" tabindex="-1"></a>    <span class="kw">const</span> oldStreamfn <span class="op">=</span> streamfn<span class="op">;</span></span>
<span id="cb65-7"><a href="system.html#cb65-7" tabindex="-1"></a>    streamfn <span class="op">=</span> (x<span class="op">:</span> <span class="dt">unknown</span>) <span class="kw">=&gt;</span> <span class="fu">fn</span>(<span class="fu">oldStreamfn</span>(x))<span class="op">;</span></span>
<span id="cb65-8"><a href="system.html#cb65-8" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb65-9"><a href="system.html#cb65-9" tabindex="-1"></a>  }</span>
<span id="cb65-10"><a href="system.html#cb65-10" tabindex="-1"></a></span>
<span id="cb65-11"><a href="system.html#cb65-11" tabindex="-1"></a>  <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb65-12"><a href="system.html#cb65-12" tabindex="-1"></a>  <span class="kw">let</span> time <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb65-13"><a href="system.html#cb65-13" tabindex="-1"></a></span>
<span id="cb65-14"><a href="system.html#cb65-14" tabindex="-1"></a>  <span class="kw">const</span> interval <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb65-15"><a href="system.html#cb65-15" tabindex="-1"></a>    time <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb65-16"><a href="system.html#cb65-16" tabindex="-1"></a>    <span class="kw">const</span> diff <span class="op">=</span> time <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb65-17"><a href="system.html#cb65-17" tabindex="-1"></a>    <span class="cf">if</span> (diff <span class="op">&gt;=</span> stopTime) <span class="pp">clearInterval</span>(interval)<span class="op">;</span></span>
<span id="cb65-18"><a href="system.html#cb65-18" tabindex="-1"></a>    <span class="fu">streamfn</span>(diff)<span class="op">;</span></span>
<span id="cb65-19"><a href="system.html#cb65-19" tabindex="-1"></a>  }<span class="op">,</span> milliseconds)<span class="op">;</span></span>
<span id="cb65-20"><a href="system.html#cb65-20" tabindex="-1"></a></span>
<span id="cb65-21"><a href="system.html#cb65-21" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb65-22"><a href="system.html#cb65-22" tabindex="-1"></a>}</span>
<span id="cb65-23"><a href="system.html#cb65-23" tabindex="-1"></a></span>
<span id="cb65-24"><a href="system.html#cb65-24" tabindex="-1"></a><span class="kw">const</span> stream <span class="op">=</span> <span class="fu">intervalSteam</span>(<span class="dv">200</span><span class="op">,</span> <span class="dv">1000</span>)</span>
<span id="cb65-25"><a href="system.html#cb65-25" tabindex="-1"></a></span>
<span id="cb65-26"><a href="system.html#cb65-26" tabindex="-1"></a></span>
<span id="cb65-27"><a href="system.html#cb65-27" tabindex="-1"></a>stream</span>
<span id="cb65-28"><a href="system.html#cb65-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">pipe</span>((x) <span class="kw">=&gt;</span> [x<span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>((x <span class="op">/</span> <span class="dv">7</span>) <span class="op">*</span> <span class="dv">100</span>) <span class="op">/</span> <span class="dv">100</span>])</span>
<span id="cb65-29"><a href="system.html#cb65-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">pipe</span>((x) <span class="kw">=&gt;</span></span>
<span id="cb65-30"><a href="system.html#cb65-30" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(</span>
<span id="cb65-31"><a href="system.html#cb65-31" tabindex="-1"></a>      <span class="vs">`</span><span class="sc">${</span>x[<span class="dv">0</span>]<span class="sc">}</span><span class="vs"> milliseconds has elapsed`</span></span>
<span id="cb65-32"><a href="system.html#cb65-32" tabindex="-1"></a>      <span class="op">+</span> <span class="vs">`(</span><span class="sc">${</span>x[<span class="dv">1</span>]<span class="sc">}</span><span class="vs"> milliseconds in dog years)`</span></span>
<span id="cb65-33"><a href="system.html#cb65-33" tabindex="-1"></a>    )</span>
<span id="cb65-34"><a href="system.html#cb65-34" tabindex="-1"></a>  )<span class="op">;</span></span></code></pre></div>
<pre><code>201 milliseconds has elapsed(28.71 milliseconds in dog years)
401 milliseconds has elapsed(57.29 milliseconds in dog years)
602 milliseconds has elapsed(86 milliseconds in dog years)
803 milliseconds has elapsed(114.71 milliseconds in dog years)
1004 milliseconds has elapsed(143.43 milliseconds in dog years)</code></pre>
<p>As can be seen, the event producer (stream) is defined separately from the event processing logic, which is constructed by piping the result of one operation into the next. Because of the associativity of function composition, the stream actually exhibits properties of a functor, meaning that the order of composition - either through direct function composition or <code>.pipe</code> chaining - does not affect the result. Additionally, while the stream transformations themselves are (generally) stateless, they can still produce useful side-effects (as can be seen on the example of the <code>console.log</code> call above). Further, because of this fact, they also lend themselves well to modeling asynchronous or even infinite data sequences <span class="citation">(<a href="#ref-abelson2022">Abelson and Sussman 2022</a>; <a href="#ref-fogus2013">Fogus 2013</a>)</span>.</p>
<p>While streams can be extremely useful in specific circumstances, their utility as a general model for complex UIs (beyond asynchronous operations) is debatable. Specifically, the inherent statefulness of UIs conflicts with the stateless nature of streams: stateless computations inside the stream have to leak into the rest of the application <em>somewhere</em>. Delineating which parts of the logic should go into streams versus which should be bound to UI components adds unnecessary complexity for little real benefit. Consequently, streams are likely not the optimal choice for interactive data visualization, where some mutable state is unavoidable.</p>
</div>
<div id="virtual-dom" class="section level4 hasAnchor" number="7.4.3.3">
<h4><span class="header-section-number">7.4.3.3</span> Virtual DOM<a href="system.html#virtual-dom" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Within the web ecosystem, a popular way of handling reactivity involves something called the virtual DOM (VDOM). This approach, popularized by web frameworks such as React <span class="citation">(<a href="#ref-react2024">Meta 2024</a>)</span> and Vue <span class="citation">(<a href="#ref-vue2024">Evan You and the Vue Core Team 2024</a>)</span>, involves constructing an independent, in-memory data structure which provides a virtual representation of the UI in the form of a tree. Reactive events are bound to nodes or âcomponentsâ of this tree, and, whenever an event occurs, changes cascade throughout the VDOM, starting with the associated component and propagating down through its children. Finally, the VDOM is compared or âdiffedâ against the actual UI, and only the necessary updates are applied. Note that, despite being named after the webâs DOM, the VDOM represents a general concept, not tied to any specific programming environment.</p>
<p>The VDOM provides a straightforward solution to reactive graph challenges such as the diamond problem described in Section <a href="system.html#observer">7.4.3.1</a>. It can work very well in specific circumstances, as evidenced by the massive popularity of web frameworks such as React or Vue. However, compared to alternatives, it also comes with some significant performance trade-offs. Specifically, events near the root component trigger a cascade of updates which propagates throughout a large portion of the tree, even when there is no direct dependence between these events and the child components. Moreover, since the only way for two components to share a piece of state is through their parent, the model naturally encourages a top-heavy hierarchy, further compounding the issue. Finally, depending on the nature and implementation of the UI, the diffing process may be more trouble than its worth: while in a webpage, updating a single button or a div element is a relatively fast operation, in a data visualization system, it may be more efficient to re-render an entire plot from scratch rather than trying to selectively update it.</p>
</div>
<div id="signals" class="section level4 hasAnchor" number="7.4.3.4">
<h4><span class="header-section-number">7.4.3.4</span> Signals<a href="system.html#signals" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Another approach to reactivity that has been steadily gaining traction over the recent years, particularly within the web ecosystem, are signals (also known as fine-grained reactivity). Popularized by frameworks such Knockout <span class="citation">(<a href="#ref-knockout2019">knockoutjs 2019</a>)</span> and more recently Solid JS <span class="citation">(<a href="#ref-solid2024">Solid Core Team 2025</a>)</span>, this approach has recently seen a wave adoptions by many other frameworks including Svelte <span class="citation">(<a href="#ref-svelte2024">Rich Harris and the Svelte Core Team 2024</a>)</span> and Angular <span class="citation">(<a href="#ref-angular2025">Google 2025</a>)</span>, and has even seen adoption outside of the JavaScript ecosystem, such as in the Rust-based framework Leptos <span class="citation">(<a href="#ref-leptos2025">Leptos Core Team 2025</a>)</span>.</p>
<p>Signal-based reactivity is built around a core pair of primitives: signals and effects. Signals are reactive values which keep track of their listeners, similar to the <code>Observer</code> pattern (Section <a href="system.html#observer">7.4.3.1</a>). However, unlike <code>Observer</code>s, signals do not need to be subscribed to manually. Instead, listeners automatically subscribe to signals by accessing them, which is where effects come in. Effects are side-effect-causing functions which respond to signal changes, typically by updating the UI, and play a key role in the signal-based automatic subscription model.</p>
<p>While signal-based reactivity might appear complex, its basic implementation is surprisingly straightforward. The following example is based on a presentation by Ryan Carniato, the creator of Solid JS <span class="citation">(<a href="#ref-carniato2023">2023</a>)</span>:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb67-1"><a href="system.html#cb67-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Signal</span> {</span>
<span id="cb67-2"><a href="system.html#cb67-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">create</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T)<span class="op">:</span> [() <span class="kw">=&gt;</span> T<span class="op">,</span> (value<span class="op">:</span> T) <span class="kw">=&gt;</span> <span class="dt">void</span>] {</span>
<span id="cb67-3"><a href="system.html#cb67-3" tabindex="-1"></a>    <span class="co">// A set of listeners, similar to Observable</span></span>
<span id="cb67-4"><a href="system.html#cb67-4" tabindex="-1"></a>    <span class="kw">const</span> listeners <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span><span class="op">&lt;</span>() <span class="kw">=&gt;</span> <span class="dt">void</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb67-5"><a href="system.html#cb67-5" tabindex="-1"></a></span>
<span id="cb67-6"><a href="system.html#cb67-6" tabindex="-1"></a>    <span class="kw">function</span> <span class="kw">get</span>()<span class="op">:</span> T {</span>
<span id="cb67-7"><a href="system.html#cb67-7" tabindex="-1"></a>      listeners<span class="op">.</span><span class="fu">add</span>(Effect<span class="op">.</span><span class="fu">getCurrent</span>())<span class="op">;</span></span>
<span id="cb67-8"><a href="system.html#cb67-8" tabindex="-1"></a>      <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb67-9"><a href="system.html#cb67-9" tabindex="-1"></a>    }</span>
<span id="cb67-10"><a href="system.html#cb67-10" tabindex="-1"></a></span>
<span id="cb67-11"><a href="system.html#cb67-11" tabindex="-1"></a>    <span class="kw">function</span> <span class="kw">set</span>(value<span class="op">:</span> T) {</span>
<span id="cb67-12"><a href="system.html#cb67-12" tabindex="-1"></a>      x <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb67-13"><a href="system.html#cb67-13" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> l <span class="kw">of</span> listeners) <span class="fu">l</span>()<span class="op">;</span></span>
<span id="cb67-14"><a href="system.html#cb67-14" tabindex="-1"></a>    }</span>
<span id="cb67-15"><a href="system.html#cb67-15" tabindex="-1"></a></span>
<span id="cb67-16"><a href="system.html#cb67-16" tabindex="-1"></a>    <span class="co">// Returns a getter-setter pair</span></span>
<span id="cb67-17"><a href="system.html#cb67-17" tabindex="-1"></a>    <span class="cf">return</span> [<span class="kw">get</span><span class="op">,</span> <span class="kw">set</span>]<span class="op">;</span></span>
<span id="cb67-18"><a href="system.html#cb67-18" tabindex="-1"></a>  }</span>
<span id="cb67-19"><a href="system.html#cb67-19" tabindex="-1"></a>}</span>
<span id="cb67-20"><a href="system.html#cb67-20" tabindex="-1"></a></span>
<span id="cb67-21"><a href="system.html#cb67-21" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Effect</span> {</span>
<span id="cb67-22"><a href="system.html#cb67-22" tabindex="-1"></a>  <span class="kw">const</span> effectStack <span class="op">=</span> [] <span class="im">as</span> (() <span class="kw">=&gt;</span> <span class="dt">void</span>)[]<span class="op">;</span> <span class="co">// A stack of effects</span></span>
<span id="cb67-23"><a href="system.html#cb67-23" tabindex="-1"></a></span>
<span id="cb67-24"><a href="system.html#cb67-24" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">getCurrent</span>()<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dt">void</span> {</span>
<span id="cb67-25"><a href="system.html#cb67-25" tabindex="-1"></a>    <span class="cf">return</span> effectStack[effectStack<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb67-26"><a href="system.html#cb67-26" tabindex="-1"></a>  }</span>
<span id="cb67-27"><a href="system.html#cb67-27" tabindex="-1"></a></span>
<span id="cb67-28"><a href="system.html#cb67-28" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">create</span>(effectfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dt">void</span>) {</span>
<span id="cb67-29"><a href="system.html#cb67-29" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">execute</span>() {</span>
<span id="cb67-30"><a href="system.html#cb67-30" tabindex="-1"></a>      effectStack<span class="op">.</span><span class="fu">push</span>(execute)<span class="op">;</span>  <span class="co">// Pushes itself onto the stack</span></span>
<span id="cb67-31"><a href="system.html#cb67-31" tabindex="-1"></a>      <span class="fu">effectfn</span>()<span class="op">;</span>                 <span class="co">// Runs the effect</span></span>
<span id="cb67-32"><a href="system.html#cb67-32" tabindex="-1"></a>      effectStack<span class="op">.</span><span class="fu">pop</span>()<span class="op">;</span>          <span class="co">// Pops itself off the stack</span></span>
<span id="cb67-33"><a href="system.html#cb67-33" tabindex="-1"></a>    }</span>
<span id="cb67-34"><a href="system.html#cb67-34" tabindex="-1"></a></span>
<span id="cb67-35"><a href="system.html#cb67-35" tabindex="-1"></a>    <span class="fu">execute</span>()<span class="op">;</span></span>
<span id="cb67-36"><a href="system.html#cb67-36" tabindex="-1"></a>  }</span>
<span id="cb67-37"><a href="system.html#cb67-37" tabindex="-1"></a>}</span>
<span id="cb67-38"><a href="system.html#cb67-38" tabindex="-1"></a></span>
<span id="cb67-39"><a href="system.html#cb67-39" tabindex="-1"></a><span class="kw">const</span> [price<span class="op">,</span> setPrice] <span class="op">=</span> Signal<span class="op">.</span><span class="fu">create</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb67-40"><a href="system.html#cb67-40" tabindex="-1"></a><span class="kw">const</span> [tax<span class="op">,</span> setTax] <span class="op">=</span> Signal<span class="op">.</span><span class="fu">create</span>(<span class="fl">0.15</span>)<span class="op">;</span></span>
<span id="cb67-41"><a href="system.html#cb67-41" tabindex="-1"></a></span>
<span id="cb67-42"><a href="system.html#cb67-42" tabindex="-1"></a><span class="co">// Round to two decimal places</span></span>
<span id="cb67-43"><a href="system.html#cb67-43" tabindex="-1"></a><span class="kw">const</span> round <span class="op">=</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(x <span class="op">*</span> <span class="dv">100</span>) <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb67-44"><a href="system.html#cb67-44" tabindex="-1"></a><span class="kw">const</span> priceWithTax <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="fu">round</span>(<span class="fu">price</span>() <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fu">tax</span>()))<span class="op">;</span></span>
<span id="cb67-45"><a href="system.html#cb67-45" tabindex="-1"></a><span class="co">// ^ Derived values automatically become signals as well</span></span>
<span id="cb67-46"><a href="system.html#cb67-46" tabindex="-1"></a></span>
<span id="cb67-47"><a href="system.html#cb67-47" tabindex="-1"></a>Effect<span class="op">.</span><span class="fu">create</span>(() <span class="kw">=&gt;</span></span>
<span id="cb67-48"><a href="system.html#cb67-48" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(</span>
<span id="cb67-49"><a href="system.html#cb67-49" tabindex="-1"></a>    <span class="vs">`The current price is`</span> <span class="op">+</span> <span class="vs">` `</span> <span class="op">+</span></span>
<span id="cb67-50"><a href="system.html#cb67-50" tabindex="-1"></a>      <span class="vs">`</span><span class="sc">${</span><span class="fu">priceWithTax</span>()<span class="sc">}</span><span class="vs">`</span> <span class="op">+</span> <span class="vs">` `</span> <span class="op">+</span></span>
<span id="cb67-51"><a href="system.html#cb67-51" tabindex="-1"></a>      <span class="vs">`(</span><span class="sc">${</span><span class="fu">price</span>()<span class="sc">}</span><span class="vs"> before </span><span class="sc">${</span><span class="fu">tax</span>() <span class="op">*</span> <span class="dv">100</span><span class="sc">}</span><span class="vs">% tax)`</span></span>
<span id="cb67-52"><a href="system.html#cb67-52" tabindex="-1"></a>  )</span>
<span id="cb67-53"><a href="system.html#cb67-53" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb67-54"><a href="system.html#cb67-54" tabindex="-1"></a></span>
<span id="cb67-55"><a href="system.html#cb67-55" tabindex="-1"></a><span class="fu">setPrice</span>(<span class="dv">200</span>)<span class="op">;</span></span>
<span id="cb67-56"><a href="system.html#cb67-56" tabindex="-1"></a><span class="fu">setTax</span>(<span class="fl">0.12</span>)<span class="op">;</span></span></code></pre></div>
<pre><code>The current price is 115 (100 before 15% tax)
The current price is 230 (200 before 15% tax)
The current price is 224 (200 before 12% tax)</code></pre>
<p>The key detail to notice is the presence of the global stack of effects. Whenever an effect is called, it first pushes itself onto the stack. It then executes, accessing any signals it needs along the way. These signals in turn register the effect as a listener, by accessing it as the top-most element of the effect stack. When the effect is done executing, it pops itself off the stack. Now, whenever one of the accessed signals changes, the effect re-runs again. Crucially, making a derived reactive value is as simple as writing a callback: if an effect calls a function using a signal, it also automatically subscribes to that signal (see the example of <code>priceWithTax</code> above). Importantly, the effect subscribes <em>only</em> to this signal and not the derived value itself. In other words, effects only ever subscribe to the leaf nodes of the reactive graph (signals). Derived values computed on the fly (and, if necessary, can be easily memoized<a href="#fn22" class="footnote-ref" id="fnref22"><sup>22</sup></a>), and event ordering is simply managed via the runtime call stack.</p>
<p>Signals provide an elegant solution to many problems with reactivity. They automate subscription to events, prevent unnecessary updates, ensure correct update order, and, due to their fine-grained nature, are generally highly performant compared to more cumbersome methods like the virtual DOM. However, again, signals do also introduce their own set of trade-offs. Chief among these, signalâs reliance on the call stack for event ordering necessitates their implementation as functions (getter-setter pairs), rather than plain data values. While techniques like object getters/setters or templating <span class="citation">(as seen in SolidJS, <a href="#ref-solid2024">Solid Core Team 2025</a>)</span> can be used to hide this fact, it does nevertheless add an extra layer of complexity. Similarly, many features important for performance, like memoization and batching, also require treating signals as distinct from plain data. Having code consist of two sets of entities - plain data and signals - ultimately impacts developer ergonomics.</p>
</div>
<div id="reactivity-solution" class="section level4 hasAnchor" number="7.4.3.5">
<h4><span class="header-section-number">7.4.3.5</span> Reactivity in <code>plotscape</code> and final thoughts<a href="system.html#reactivity-solution" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>At the start of the project, I had used the <code>Observer</code> pattern for modeling reactivity. However, I had the idea of letting the users to define reactive parameters that could be used at arbitrary points in the data visualization pipeline. This had led me to explore the various models of reactivity described above, and even do a full rewrite of <code>plotscape</code> with signals at one point.</p>
<p>However, eventually, I ended up reverting back to the <code>Observer</code> pattern. The primary reason was developer ergonomics. While many properties of signals like the automatic event subscription were appealing, the need to manage both data and signals as distinct entities proved cumbersome. Specifically, deciding which components of my system and their properties should be plain data versus signals added an additional overhead and complicated refactoring. With a bit of practice and careful design, I found that I was able to use the <code>Observer</code> pattern without introducing unnecessary re-renders. Moreover, I also found that, in the interactive data visualization pipeline, reactivity can be aligned with the four discrete stages: partitioning, aggregation, scaling, and rendering. Specifically, reactive values can be introduced in batch right at the start of each of these four steps, greatly simplifying the reactive graph. Introducing reactivity at other points seem to offer limited practical benefit. Thus, despite the limitations of the <code>Observer</code> pattern, the structured nature of the problem (interactive data visualization pipelines) ultimately makes it a decent solution in my eyes.</p>
</div>
</div>
<div id="components" class="section level3 hasAnchor" number="7.4.4">
<h3><span class="header-section-number">7.4.4</span> System components<a href="system.html#components" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This section discusses the core components of <code>plotscape</code>, detailing their functionality, implementation, and interconnections. The goal is to give an overview and provide a rationale for the design of key parts of the system. As before, TypeScript code examples are provided, and, in general, these map fairly closely to the real codebase.</p>
<div id="indexable" class="section level4 hasAnchor" number="7.4.4.1">
<h4><span class="header-section-number">7.4.4.1</span> Indexable<a href="system.html#indexable" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One of the fundamental considerations when implementing a data visualization system is how to represent a data variable: a generalized sequence of related values. Clearly, the ability to handle fixed-length arrays is essential, however, we may also want to be able to treat constants or derived values as variables. To give an example, in a typical barplot, the y-axis base is a constant, typically zero. While we could hypothetically append an array of zeroes to our data, it is much more convenient and memory efficient to simply use a constant (<code>0</code>) or a callback/thunk (<code>() =&gt; 0</code>). Similarly, at times, arrays of repeated values can be more optimally represented as two arrays: a short array of âlabelsâ and a long array of integer indices (i.e.Â what base Râs <code>factor</code> class does). Thus, representing data effectively calls for a generalization of a data âcolumnâ which can encompass data types beyond fixed-length arrays.</p>
<p>The type <code>Indexable&lt;T&gt;</code> represents such a generalization of a data column. It is simply a union of three simple types:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb69-1"><a href="system.html#cb69-1" tabindex="-1"></a>Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> T <span class="op">|</span> T[] <span class="op">|</span> ((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T)</span></code></pre></div>
<p>In plain words, an <code>Indexable&lt;T&gt;</code> can be one of the following three objects:</p>
<ul>
<li>A simple (scalar) value <code>T</code></li>
<li>A fixed-length array of <code>T</code>âs (<code>T[]</code>)</li>
<li>A function which takes an index as an argument and returns a <code>T</code></li>
</ul>
<p>That is, <code>Indexable</code>s generalize arrays, providing value access via an index. Arrays behave as expected, scalar values are always returned regardless of the index, and functions are invoked with the index as the first argument (this functionality is provided by <a href="system.html#getter"><code>Getter</code></a>s). As a final note, <code>Indexable</code>s are somewhat similar to Leland Wilkinsonâs idea of data functions <span class="citation">(see <a href="#ref-wilkinson2012">Wilkinson 2012, 42</a>)</span>, although there are some differences (Wilkinsonâs data functions are defined more broadly).</p>
</div>
<div id="getter" class="section level4 hasAnchor" number="7.4.4.2">
<h4><span class="header-section-number">7.4.4.2</span> Getter<a href="system.html#getter" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A <code>Getter&lt;T&gt;</code> is used to provide a uniform interface to accessing values from an <code>Indexable&lt;T&gt;</code>. It is simply a function which takes an index and returns a value of type <code>T</code>. To construct a <code>Getter&lt;T&gt;</code>, we take an <code>Indexable&lt;T&gt;</code> and dispatch on the underlying subtype. For illustration purposes, here is a simplified implementation:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb70-1"><a href="system.html#cb70-1" tabindex="-1"></a><span class="co">// Getter.ts</span></span>
<span id="cb70-2"><a href="system.html#cb70-2" tabindex="-1"></a><span class="im">export type</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb70-3"><a href="system.html#cb70-3" tabindex="-1"></a></span>
<span id="cb70-4"><a href="system.html#cb70-4" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Getter</span> {</span>
<span id="cb70-5"><a href="system.html#cb70-5" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">create</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb70-6"><a href="system.html#cb70-6" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">typeof</span> x <span class="op">===</span> <span class="vs">`function`</span>) <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb70-7"><a href="system.html#cb70-7" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(x)) <span class="cf">return</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> x[index]<span class="op">;</span></span>
<span id="cb70-8"><a href="system.html#cb70-8" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">return</span> () <span class="kw">=&gt;</span> x<span class="op">;</span></span>
<span id="cb70-9"><a href="system.html#cb70-9" tabindex="-1"></a>  }</span>
<span id="cb70-10"><a href="system.html#cb70-10" tabindex="-1"></a>}</span></code></pre></div>
<p>we can then create and use <code>Getter</code>s like so:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb71-1"><a href="system.html#cb71-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb71-2"><a href="system.html#cb71-2" tabindex="-1"></a></span>
<span id="cb71-3"><a href="system.html#cb71-3" tabindex="-1"></a><span class="kw">const</span> getter1 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">create</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb71-4"><a href="system.html#cb71-4" tabindex="-1"></a><span class="kw">const</span> getter2 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">create</span>(<span class="dv">99</span>)<span class="op">;</span></span>
<span id="cb71-5"><a href="system.html#cb71-5" tabindex="-1"></a><span class="kw">const</span> getter3 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">create</span>((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> index <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb71-6"><a href="system.html#cb71-6" tabindex="-1"></a></span>
<span id="cb71-7"><a href="system.html#cb71-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter1</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb71-8"><a href="system.html#cb71-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter2</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb71-9"><a href="system.html#cb71-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter3</span>(<span class="dv">0</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>1
99
-1</code></pre>
<p>Note that, by definition, every <code>Getter&lt;T&gt;</code> is also automatically an <code>Indexable&lt;T&gt;</code> (since it is a function of the form <code>(index: number) =&gt; T</code>). This means that we can use <code>Getter</code>s to create new <code>Getter</code>s. There are also several utility functions for working with <code>Getter</code>s. The first is <code>Getter.constant</code> which takes in a value <code>T</code> and returns a thunk returning <code>T</code> (i.e.Â <code>() =&gt; T</code>). This is useful, for example, when <code>T</code> is an array and we always want to return the whole array (not just a single element):</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb73-1"><a href="system.html#cb73-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb73-2"><a href="system.html#cb73-2" tabindex="-1"></a></span>
<span id="cb73-3"><a href="system.html#cb73-3" tabindex="-1"></a><span class="kw">const</span> getter4 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">constant</span>([<span class="vs">`A`</span><span class="op">,</span> <span class="vs">`B`</span><span class="op">,</span> <span class="vs">`C`</span>])</span>
<span id="cb73-4"><a href="system.html#cb73-4" tabindex="-1"></a></span>
<span id="cb73-5"><a href="system.html#cb73-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter4</span>(<span class="dv">0</span>))</span>
<span id="cb73-6"><a href="system.html#cb73-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter4</span>(<span class="dv">1</span>))</span></code></pre></div>
<pre><code>[ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ]
[ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ]</code></pre>
<p>Another useful utility function is <code>Getter.proxy</code>, which takes a <code>Getter</code> and an array of indices as input and returns a new <code>Getter</code> which routes the access to the original values through the indices:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb75-1"><a href="system.html#cb75-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb75-2"><a href="system.html#cb75-2" tabindex="-1"></a></span>
<span id="cb75-3"><a href="system.html#cb75-3" tabindex="-1"></a><span class="kw">const</span> getter5 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">proxy</span>([<span class="vs">`A`</span><span class="op">,</span> <span class="vs">`B`</span><span class="op">,</span> <span class="vs">`C`</span>]<span class="op">,</span> [<span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb75-4"><a href="system.html#cb75-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">.</span><span class="fu">map</span>(getter5))</span></code></pre></div>
<pre><code>[ &quot;C&quot;, &quot;B&quot;, &quot;B&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A&quot; ]</code></pre>
<p>This function becomes particularly useful when implementing other data structures such as <code>Factor</code>s.</p>
</div>
<div id="dataframe" class="section level4 hasAnchor" number="7.4.4.3">
<h4><span class="header-section-number">7.4.4.3</span> Dataframe<a href="system.html#dataframe" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In many data analytic workflows, a fundamental data structure is that of a two-dimensional table or dataframe. As discussed in Section <a href="system.html#row-column">7.4.2</a>, we can represent this data structure as either a dictionary of columns or a list of rows, with the column-wise representation having some advantages for analytical workflows. As such, in <code>plotscape</code>, I chose to represent <code>Dataframe</code> as a dictionary columns. Furthermore, in <code>plotscape</code>, a key difference is that all columns are not required to be fixed-length arrays; instead, they can be any <a href="system.html#indexable"><code>Indexable</code></a>s:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb77-1"><a href="system.html#cb77-1" tabindex="-1"></a><span class="kw">interface</span> Dataframe {</span>
<span id="cb77-2"><a href="system.html#cb77-2" tabindex="-1"></a>  [key<span class="op">:</span> <span class="dt">string</span>]<span class="op">:</span> Indexable</span>
<span id="cb77-3"><a href="system.html#cb77-3" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, hereâs how a <code>plotscape</code> data set can look like:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb78-1"><a href="system.html#cb78-1" tabindex="-1"></a><span class="im">import</span> { Dataframe } <span class="im">from</span> <span class="st">&quot;./Dataframe&quot;</span></span>
<span id="cb78-2"><a href="system.html#cb78-2" tabindex="-1"></a></span>
<span id="cb78-3"><a href="system.html#cb78-3" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> {</span>
<span id="cb78-4"><a href="system.html#cb78-4" tabindex="-1"></a>  name<span class="op">:</span> [<span class="vs">`john`</span><span class="op">,</span> <span class="vs">`jenny`</span><span class="op">,</span> <span class="vs">`michael`</span>]<span class="op">,</span></span>
<span id="cb78-5"><a href="system.html#cb78-5" tabindex="-1"></a>  age<span class="op">:</span> [<span class="dv">17</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> <span class="dv">21</span>]<span class="op">,</span></span>
<span id="cb78-6"><a href="system.html#cb78-6" tabindex="-1"></a>  isStudent<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb78-7"><a href="system.html#cb78-7" tabindex="-1"></a>  canDrive<span class="op">:</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> data<span class="op">.</span><span class="at">age</span>[index] <span class="op">&gt;</span> <span class="dv">18</span><span class="op">,</span></span>
<span id="cb78-8"><a href="system.html#cb78-8" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb78-9"><a href="system.html#cb78-9" tabindex="-1"></a></span>
<span id="cb78-10"><a href="system.html#cb78-10" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(Dataframe<span class="op">.</span><span class="fu">rows</span>(data))</span></code></pre></div>
<pre><code>[
  {
    name: &quot;john&quot;,
    age: 17,
    isStudent: true,
    canDrive: false,
  }, {
    name: &quot;jenny&quot;,
    age: 24,
    isStudent: true,
    canDrive: true,
  }, {
    name: &quot;michael&quot;,
    age: 21,
    isStudent: true,
    canDrive: true,
  }
]</code></pre>
<p>It is important to mention that, typically, it is not necessary to materialize individual rows like the in example above; I used <code>Dataframe.rows</code> helper function<a href="#fn23" class="footnote-ref" id="fnref23"><sup>23</sup></a> to simply better visualize the implied structure of the data.</p>
<p>One other important thing to mention is that, since the <code>Dataframe</code> columns can be different <code>Indexable</code> subtypes, we need to make sure that we can actually find the number of rows and that these do not conflict across columns. That, at least one column needs to be a fixed-length array, and all fixed-length arrays in the data need to have the same length (or that the variable-length columns carry appropriate metadata).</p>
<p>In a classical OOP style, these length constraints might be enforced by a class invariant, however, <code>plotscape</code> adopts a looser approach. The length constraints are checked dynamically, at runtime, whenever the integrity of a <code>Dataframe</code> becomes a key concern, for instance, when initializing a <a href="system.html#scene"><code>Scene</code></a> or rendering. This loose approach is more in line with JavaScriptâs dynamic nature: in JavaScript, everything except for primitives is a mutable object, which may be manipulated at runtime (even class instances). As such, this approach is safer. Furthermore, with <code>Dataframe</code>s of typical dimensionality (fewer columns than rows, <span class="math inline">\(p &lt;&lt; n\)</span>), the performance cost of checking columnâs length is usually negligible when compared to row-wise operations, such as computing summary statistics or rendering. If performance were to become an issue for high-dimensional datasets (<span class="math inline">\(p &gt;&gt; n\)</span>), the approach could always be made more efficient, for example, with memoization.</p>
</div>
<div id="factors" class="section level4 hasAnchor" number="7.4.4.4">
<h4><span class="header-section-number">7.4.4.4</span> Factors<a href="system.html#factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As discussed in Section <a href="problems.html#problems">5</a>, when visualizing, we often need to split our data into a set of disjoint subsets, representing data partitions. Further, as mentioned in Section <a href="problems.html#hierarchy">5.1.4</a>, these partitions may be organized hierarchically, such that multiple subsets in one partition may be combined together to form another subset within a coarser, parent partition.</p>
<p><code>Factor</code>s provide a way to represent such data partitions and the associated metadata. They are similar to base Râs <code>factor</code> S3 class, although there are some important differences (which will be discussed below). <code>Factor</code> has the following interface:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb80-1"><a href="system.html#cb80-1" tabindex="-1"></a><span class="kw">interface</span> Factor<span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span> {</span>
<span id="cb80-2"><a href="system.html#cb80-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb80-3"><a href="system.html#cb80-3" tabindex="-1"></a>  indices<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb80-4"><a href="system.html#cb80-4" tabindex="-1"></a>  parent<span class="op">?:</span> Factor<span class="op">;</span></span>
<span id="cb80-5"><a href="system.html#cb80-5" tabindex="-1"></a>  data<span class="op">:</span> T</span>
<span id="cb80-6"><a href="system.html#cb80-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Here, <code>cardinality</code> represents the number of unique parts that the factor/partition represents (e.g.Â 2 for a binary variable, 3 for a categorical variable with 3 levels, and so on). Data points or cases map to the parts via a <em>dense</em> array of <code>indices</code>, which take on values in <code>0 ... cardinality - 1</code> and have length equal to the length of the data<a href="#fn24" class="footnote-ref" id="fnref24"><sup>24</sup></a>. Each case is identified by its position in the array. For example, take the following array of indices:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb81-1"><a href="system.html#cb81-1" tabindex="-1"></a>[<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span>]</span></code></pre></div>
<p>Keeping in mind JavaScriptâs zero-based indexing, these indices identify the first part/level (<code>0</code>) as consisting of cases one, four, and six, the second part (<code>1</code>) as consisting of cases two and three, and the third part (<code>2</code>) as consisting of only a single case - five.</p>
<p>The data associated with factorâs levels is stored in the <code>data</code> property, which is composed of arrays/<code>Indexables</code>, with length as the factorâs cardinality. For instance, if a factor is created from a categorical variable with three levels - <code>A</code>, <code>B</code>, and <code>C</code> - then <code>data</code> may look something like this:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb82-1"><a href="system.html#cb82-1" tabindex="-1"></a>{ labels<span class="op">:</span> [<span class="st">&quot;A&quot;</span><span class="op">,</span> <span class="st">&quot;B&quot;</span><span class="op">,</span> <span class="st">&quot;C&quot;</span>] }</span>
<span id="cb82-2"><a href="system.html#cb82-2" tabindex="-1"></a><span class="co">// In row-oriented form: [{ label: &quot;A&quot; }, { label: &quot;B&quot; }, ... ]</span></span></code></pre></div>
<p>Finally, the optional <code>parent</code> property is a pointer to the factor representing the parent partition.</p>
<p>There are a couple of important things to discuss. First, <code>cardinality</code> technically duplicates information, since it is simply the number of unique values in <code>indices</code>. However, for many operations on <code>Factor</code>s, it is beneficial to be able to quickly access cardinality, in constant <span class="math inline">\(O(1)\)</span> time. Such is the case, for example, when constructing <a href="system.html#product-factors">product factors</a> or when initializing arrays of summaries. Of course, this means that the relationship between <code>cardinality</code> and <code>indices</code> is an invariant that has to be maintained under any factor transformations.</p>
<p>Second, the metadata associated with the parts is stored in the <code>data</code> property of type <a href="system.html#dataframe"><code>Dataframe</code></a>. This represents a departure from e.g.Â base Râs <code>factor</code> class, where all metadata is stored as a flat vector of levels (which may be tuples). For instance:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="system.html#cb83-1" tabindex="-1"></a><span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>))</span></code></pre></div>
<pre><code> [1] (0,5]  (0,5]  (0,5]  (0,5]  (0,5]  (5,10] (5,10] (5,10]
 [9] (5,10] (5,10]
Levels: (0,5] (5,10]</code></pre>
<p>With <code>Factor</code>, the same information would be represented as:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb85-1"><a href="system.html#cb85-1" tabindex="-1"></a><span class="kw">const</span> factor<span class="op">:</span> Factor <span class="op">=</span> {</span>
<span id="cb85-2"><a href="system.html#cb85-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb85-3"><a href="system.html#cb85-3" tabindex="-1"></a>  indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb85-4"><a href="system.html#cb85-4" tabindex="-1"></a>  data<span class="op">:</span> {</span>
<span id="cb85-5"><a href="system.html#cb85-5" tabindex="-1"></a>    binMin<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">,</span></span>
<span id="cb85-6"><a href="system.html#cb85-6" tabindex="-1"></a>    binMax<span class="op">:</span> [<span class="dv">5</span><span class="op">,</span> <span class="dv">10</span>]<span class="op">,</span></span>
<span id="cb85-7"><a href="system.html#cb85-7" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb85-8"><a href="system.html#cb85-8" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>I contend that, compared to a flat vector/array, storing <code>Factor</code> metadata in a <code>Dataframe</code> offers several distinct advantages. First, when partitioning data, we often want to store multiple metadata attributes. For instance, when binning numeric variable (as in the example above), we want to store the lower and upper bound of each bin. The approach used in <code>cut</code> is to store multiple (two) pieces of metadata as a tuple, however, this becomes cumbersome as the dimensionality of the metadata grows. Further, if metadata is stored in a <code>Dataframe</code>, it becomes far easier to combine when taking <a href="system.html#product-factors">a product of two factors</a>. Since factor product is a fundamental operation in <code>plotscape</code>, underpinning features such as linked brushing, I argue that it is sensible to store metadata on <code>Factor</code> in a full <code>Dataframe</code> form.</p>
<p>Finally, while all <code>Factor</code>s share the same fundamental structure - a data partition with associated metadata - factors can be created using various constructor functions. These constructor functions differ in what data they take as input and what metadata they store on the ouput, giving rise to several distinct <code>Factor</code> subtypes. These will be the subject of the next few sections.</p>
<div id="bijection-and-constant-factors" class="section level5 hasAnchor" number="7.4.4.4.1">
<h5><span class="header-section-number">7.4.4.4.1</span> Bijection and constant factors<a href="system.html#bijection-and-constant-factors" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><code>Factor.bijection</code> and <code>Factor.constant</code> are two fairly trival factor constructors. <code>Factor.bijection</code> creates the finest possible data partition by assigning every case its own part/level, whereas <code>Factor.constant</code> does the opposite by assigning all cases to a single part/level. The names reflect the mathematical index mapping functions: the bijective function <span class="math inline">\(f(i) = i\)</span> for <code>Factor.bijection</code> and the constant function <span class="math inline">\(f(i) = 0\)</span> for <code>Factor.constant</code>. Consequently, the cardinality of <code>Factor.bijection</code> is always equal to the length of the data, while the cardinality of <code>Factor.constant</code> is always one. Both can be assigned arbitrary metadata (which must have length equal to the cardinality).</p>
<p>The two factor constructor functions have the same signature:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb86-1"><a href="system.html#cb86-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bijection</span><span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span>(n<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> data<span class="op">?:</span> T)<span class="op">:</span> </span>
<span id="cb86-2"><a href="system.html#cb86-2" tabindex="-1"></a>  Factor<span class="op">&lt;</span>T<span class="op">&gt;</span></span>
<span id="cb86-3"><a href="system.html#cb86-3" tabindex="-1"></a>  </span>
<span id="cb86-4"><a href="system.html#cb86-4" tabindex="-1"></a><span class="kw">function</span> <span class="fu">constant</span><span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span>(n<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> data<span class="op">?:</span> T)<span class="op">:</span> </span>
<span id="cb86-5"><a href="system.html#cb86-5" tabindex="-1"></a>  Factor<span class="op">&lt;</span>T<span class="op">&gt;</span> </span></code></pre></div>
<p>In either case, <code>n</code> represents the length of the data (the number of cases), and <code>data</code> represents some arbitrary metadata, of equal length as <code>n</code>. The variable <code>n</code> is used to construct an array of <code>indices</code>, which in the case of <code>Factor.bijection</code> is an increasing sequence starting at zero (<code>[0, 1, 2, 3, ..., n - 1]</code>), whereas in the case of <code>Factor.constant</code> it is simply an array of zeroes (<code>[0, 0, 0, 0, ..., 0]</code>).</p>
<p>Technically, storing explicit arrays of indices is not strictly necessary, and we could implement much of the same functionality via a callback (i.e.Â <code>(index: number) =&gt; index</code> for <code>Factor.bijection</code> and <code>(index: number) =&gt; 0</code> for <code>Factor.constant</code>). However, for many operations involving factors, the length of the data (<code>n</code>) is also important. While it would be possible to define a separate <code>n</code>/<code>length</code> property on <code>Factor</code>, I found it more straightforward to simply allocate the corresponding array. While this does incur a small memory cost, there is no computational overhead, since, by definition, partitions represented by bijective or constant factors do not change<a href="#fn25" class="footnote-ref" id="fnref25"><sup>25</sup></a>.</p>
<p>While fairly trivial, <code>Factor.bijection</code> and <code>Factor.constant</code> have important use cases. <code>Factor.bijection</code> represents a one-to-one mapping such as that seen in scatterplots and parallel coordinate plots. In contrast, <code>Factor.constant</code> represent a constant mapping which assigns all cases to a single part. This is useful for computing summaries across the entirety of the data, such as is required for spinogram<a href="#fn26" class="footnote-ref" id="fnref26"><sup>26</sup></a>.</p>
<p>As a brief final aside, both <code>Factor.bijection</code> and <code>Factor.constant</code> can be interpreted through the lense of category theory as terminal and initial objects within the category/preorder of data partitions, ordered by products (see Section <a href="problems.html#preorders-categories">5.2.2.2</a>). That is, the product of a bijective partition with any other factor is always another bijective partition, whereas the product of constant partition with any other factor is always the other factor.</p>
</div>
<div id="discrete-factors" class="section level5 hasAnchor" number="7.4.4.4.2">
<h5><span class="header-section-number">7.4.4.4.2</span> Discrete factors<a href="system.html#discrete-factors" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Another fairly straightforward factor constructor is <code>Factor.from</code>. It simply takes an array of values which can be coerced to strings (i.e.Â have the JavaScript <code>.toString()</code> method) and creates a discrete factor by treating each unique string as a part/level (similar to base Râs <code>factor</code> class behavior). This gives rise to the following function signature:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb87-1"><a href="system.html#cb87-1" tabindex="-1"></a><span class="kw">type</span> Stringable <span class="op">=</span> { <span class="fu">toString</span>()<span class="op">:</span> <span class="dt">string</span> }<span class="op">;</span></span>
<span id="cb87-2"><a href="system.html#cb87-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">from</span>(x<span class="op">:</span> Stringable[]<span class="op">,</span> options<span class="op">?:</span> { labels<span class="op">:</span> <span class="dt">string</span>[] })<span class="op">:</span> </span>
<span id="cb87-3"><a href="system.html#cb87-3" tabindex="-1"></a>  Factor<span class="op">&lt;</span>{ label<span class="op">:</span> <span class="dt">string</span>[] }<span class="op">&gt;</span> </span></code></pre></div>
<p>After calling <code>Factor.from</code>, the length of the resulting factor will match the length of input array <code>x</code>. To compute the factor <code>indices</code>, we need to provide an array of <code>labels</code> or these will be computed from <code>x</code> directly (by calling the <code>.toString()</code> method and finding all unique values). Assigning the indices requires looping through the <span class="math inline">\(n\)</span> values of <code>x</code> finding the index corresponding to one of the <span class="math inline">\(k\)</span> <code>labels</code>, resulting in <span class="math inline">\(O(n)\)</span> time complexity (assuming <span class="math inline">\(k\)</span> is constant with respect to the size of the data). The factor metadata simply contains the array of <code>label</code>s, such that each index in <code>indices</code> maps to one <code>label</code>.</p>
<p>The typical use case of <code>Factor.from</code> is the barplot. Here, we take an array of values, coerce these to string labels (if not in string form already), find all unique values (labels), and finally create an array of indices mapping each case to a label. The indices are then used when computing summary statistics, such as those underpinning the barsâ heights.</p>
</div>
<div id="binned-factors" class="section level5 hasAnchor" number="7.4.4.4.3">
<h5><span class="header-section-number">7.4.4.4.3</span> Binned factors<a href="system.html#binned-factors" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Arrays of continuous values can be turned into factors by binning via <code>Factor.bin</code>, which has the following signature:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb88-1"><a href="system.html#cb88-1" tabindex="-1"></a><span class="kw">type</span> BinOptions <span class="op">=</span> { </span>
<span id="cb88-2"><a href="system.html#cb88-2" tabindex="-1"></a>  breaks<span class="op">?:</span> <span class="dt">number</span>[]<span class="op">;</span> </span>
<span id="cb88-3"><a href="system.html#cb88-3" tabindex="-1"></a>  nBins<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span> </span>
<span id="cb88-4"><a href="system.html#cb88-4" tabindex="-1"></a>  width<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span> </span>
<span id="cb88-5"><a href="system.html#cb88-5" tabindex="-1"></a>  anchor<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span> </span>
<span id="cb88-6"><a href="system.html#cb88-6" tabindex="-1"></a>}</span>
<span id="cb88-7"><a href="system.html#cb88-7" tabindex="-1"></a></span>
<span id="cb88-8"><a href="system.html#cb88-8" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bin</span>(x<span class="op">:</span> <span class="dt">number</span>[]<span class="op">,</span> options<span class="op">?:</span> BinOptions)<span class="op">:</span> </span>
<span id="cb88-9"><a href="system.html#cb88-9" tabindex="-1"></a>  Factor<span class="op">&lt;</span>{ binMin<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span> binMax<span class="op">:</span> <span class="dt">number</span>[] }<span class="op">&gt;;</span></span></code></pre></div>
<p>Again, as in the case of <code>Factor.from</code>, the length of the factor created with <code>Factor.bin</code> will match the length of <code>x</code>. To compute the factor <code>indices</code>, the values in <code>x</code> need to be assigned to histogram bins delimited by breaks. The breaks are computed based on either default values or the optional list of parameters (<code>options</code>) provided to the construct function<a href="#fn27" class="footnote-ref" id="fnref27"><sup>27</sup></a>. The metadata stored on the <code>Factor.bin</code> output includes the limits of each bin <code>binMin</code> and <code>binMax</code>, giving the lower and upper bound of each bin, respectively.</p>
<p>Indices are assigned to bins using a half-open intervals on breaks of the form <code>(l, u]</code>, such that a value <code>v</code> is assigned to to a bin given by <code>(l, u]</code> if it is the case that <code>l &lt; v &lt;= u</code>. Assigning indices to bins requires looping through the <span class="math inline">\(n\)</span> values of <code>x</code>, and further looping through <span class="math inline">\(k\)</span> <code>breaks</code><a href="#fn28" class="footnote-ref" id="fnref28"><sup>28</sup></a>, resulting in <span class="math inline">\(O(n)\)</span> time complexity (assuming <span class="math inline">\(k\)</span> is fixed with respect to the size of the data).
An important point to mention is that a naive approach of assigning bins to cases may lead to some bins being left empty, resulting in <code>cardinality</code> which is less than the number of bins and âsparseâ <code>indices</code> (gaps in index values). For instance, binning the values <code>[1, 2, 6, 1, 5]</code> with breaks <code>[0, 2, 4, 6]</code> leaves the second bin (<code>(2, 4]</code>) empty, and hence the corresponding index value (<code>1</code>) will be absent from <code>indices</code>. To address this, <code>plotscape</code> performs an additional <span class="math inline">\(O(n)\)</span> computation to âcleanâ the indices and ensure that the array is dense (i.e.Â <code>indices</code> take on values in <code>0 ... cardinality - 1</code>, and each value appears at least once). While this additional computation may not be strictly necessary (i.e.Â some other systems may use âsparseâ factor representation), I found the dense arrays of indices much easier to work with, particularly when it comes to operations like combining factors via products and subsetting the corresponding data. Further, even though this approach necessitates looping over <code>indices</code> twice, the combined operation still maintains an <span class="math inline">\(O(n)\)</span> complexity.</p>
</div>
<div id="product-factors" class="section level5 hasAnchor" number="7.4.4.4.4">
<h5><span class="header-section-number">7.4.4.4.4</span> Product factors<a href="system.html#product-factors" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>As discussed in Section <a href="problems.html#products-of-partitions">5.1.3.2</a>, a fundamental operation that underpins many popular types of visualizations, particularly when linked selection is involved, is the Cartesian product of two partitions. That is, assuming we have two <code>Factor</code>s which partition our data into parts, we can create a new <code>Factor</code> consists of all unique intersections of those parts.</p>
<p>To illustrate this idea better, take two factors represented by the following data (the <code>data</code> property is omitted for conciseness):</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb89-1"><a href="system.html#cb89-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>] }<span class="op">;</span></span>
<span id="cb89-2"><a href="system.html#cb89-2" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>] }<span class="op">;</span></span></code></pre></div>
<p>If we take their product, we should end up with the following factor<a href="#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a>:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb90-1"><a href="system.html#cb90-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">4</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>] }<span class="op">;</span></span></code></pre></div>
<p>There are a couple of things to note here. First, note that the cardinality of the product factor (4) is greater than either of the cardinalities of the constituent factors (2, 3), but less than the product of the cardinalities (<span class="math inline">\(2 \cdot 3 = 6\)</span>). This will generally be the case: if the first factor has cardinality <span class="math inline">\(a\)</span> and the second cardinality <span class="math inline">\(b\)</span>, the product will have cardinality <span class="math inline">\(c\)</span>, such that:</p>
<ul>
<li><span class="math inline">\(c \geq a\)</span> and <span class="math inline">\(c \geq a\)</span><a href="#fn30" class="footnote-ref" id="fnref30"><sup>30</sup></a></li>
<li><span class="math inline">\(c \leq a \cdot b\)</span><a href="#fn31" class="footnote-ref" id="fnref31"><sup>31</sup></a></li>
</ul>
<p>This is all fairly intuitive, however, actually computing the indices of a product factor presents some challenges. A naive idea might be to simply sum/multiply pairs of indices element-wise, however, this approach does not work: the sum/product of two different pairs of indices might produce the same value (e.g.Â in a product of two factors with cardinalities of <span class="math inline">\(2\)</span> and <span class="math inline">\(3\)</span>, there are two different ways to get <span class="math inline">\(4\)</span> as the sum of indices: <span class="math inline">\(1 + 3\)</span> and <span class="math inline">\(2 + 2\)</span>). Further, when taking the product of two factors, we may want to preserve the factor order, in the sense that cases associated with lower values of the first factor should get assigned lower indices. Because sums and products are commutative, this does not work.</p>
<p>One crude solution shown in Section <a href="problems.html#products-of-partitions">5.1.3.2</a> is to treat the factor indices as strings and concatenate them elementwise. This works, but produces an unnecessary computational overhead. There is a better way. Assuming we have two factors with cardinalities <span class="math inline">\(c_1\)</span> and <span class="math inline">\(c_2\)</span>, and two indices <span class="math inline">\(i_1\)</span> and <span class="math inline">\(i_2\)</span> corresponding to the same case, we can compute the product index <span class="math inline">\(i_{\text{product}}\)</span> via the following formula:</p>
<p><span class="math display" id="eq:product-indices">\[\begin{align}
k &amp;= \max(c_1, c_2) \\
i_{\text{product}} &amp;= k \cdot i_{\text{1}} + i_{\text{2}}
\tag{7.1}
\end{align}\]</span></p>
<p>This formula is similar to one discussed in <span class="citation">Wickham (<a href="#ref-wickham2013">2013</a>)</span>. Since <span class="math inline">\(i_1\)</span> and <span class="math inline">\(i_2\)</span> take values in <span class="math inline">\(0 \ldots c_1 - 1\)</span> and <span class="math inline">\(0 \ldots c_2 - 1\)</span>, respectively<a href="#fn32" class="footnote-ref" id="fnref32"><sup>32</sup></a>, the product index is guaranteed to be unique: if <span class="math inline">\(i_1 = 0\)</span> then <span class="math inline">\(i_{\text{product}} = i_2\)</span>, if <span class="math inline">\(i_1 = 1\)</span> then <span class="math inline">\(i_{\text{product}} = k + i_2\)</span>, if <span class="math inline">\(i_1 = 2\)</span> then <span class="math inline">\(i_{\text{product}} = 2k + i_2\)</span>, and so on. Further, since the the index corresponding to the first factor is multiplied by <span class="math inline">\(k\)</span>, it intuitively gets assigned a greater âweightâ and the relative order of the two factors is preserved. See for example Table <a href="system.html#tab:product-indices">7.1</a> of product indices of two factors with cardinalities 2 and 3:</p>
<table>
<caption><span id="tab:product-indices">Table 7.1: </span>An example of product indices computed across two factors.</caption>
<thead>
<tr class="header">
<th align="right">Factor 1 index</th>
<th align="right">Factor 2 index</th>
<th align="right">Product index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">0</td>
<td align="right">2</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">2</td>
<td align="right">5</td>
</tr>
</tbody>
</table>
<p>Finally, given a product index <span class="math inline">\(i_{\text{product}}\)</span>, we can also recover the original indices (assuming <span class="math inline">\(k\)</span> is known):</p>
<p><span class="math display">\[\begin{align}
i_1 &amp;= \lfloor i_{\text{product}} / k \rfloor \\
i_2 &amp;= i_{\text{product}} \mod k
\end{align}\]</span></p>
<p>This is useful when constructing the product factor data: we need to take all unique product indices and use them to proxy the data of the original two factors.</p>
<p>It should be mentioned that, as with binning, computing product indices based on Equation <a href="system.html#eq:product-indices">(7.1)</a> creates gaps. Again, <code>plotscape</code> solves this by keeping track of the unique product indices and looping over the indices again to âcleanâ them, in <span class="math inline">\(O(n)\)</span> time. Further, since we want to retain factor order, <code>plotscape</code> also sorts the unique product indices before running the second loop. Hypothetically, with <span class="math inline">\(n\)</span> data points, there can be up <span class="math inline">\(n\)</span> unique product indices (even when <span class="math inline">\(c_1, c_2 &lt; n\)</span> both), and therefore this sorting operation makes creating and updating product indices have <span class="math inline">\(O(n \cdot \log n)\)</span> worst-case time complexity. However, I contend that, in the average case, the length of the unique product indices will be some smaller fraction of the length of the data. Further, profiling during development did not identify this operation as a performance bottleneck. However, if this sorting procedure did turn out to be a bottleneck at some point, there may be other more performant algorithms/data structures available<a href="#fn33" class="footnote-ref" id="fnref33"><sup>33</sup></a>.</p>
<p>Finally, <code>Factor.product</code> is the only factor constructor which actually assigns to the <code>parent</code> property of the output <code>Factor</code>. Specifically, the first factor always gets assigned as the parent of the product, creating a hierarchical structure. Technically, there are situations where a product of two factors is simply a âflatâ product and not a hierarchy. This is the case, for example, when taking the product of two binned variables in a 2D histogram - the two factors are conceptually equal. However, in practice, this distinction rarely matters. Any computation involving a flat product can simply ignore the <code>parent</code> property, and the data is for all other intents and purposes equivalent. This similarity of flat and hierarchical products was also noted by Wilkinson, who used the terminology of cross and nest operators <span class="citation">(<a href="#ref-wilkinson2012">Wilkinson 2012, 61</a>)</span>.</p>
</div>
</div>
<div id="marker" class="section level4 hasAnchor" number="7.4.4.5">
<h4><span class="header-section-number">7.4.4.5</span> Marker<a href="system.html#marker" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>An important component which also serves the function of a <code>Factor</code> but deserves its own section is the <code>Marker</code>. <code>Marker</code> is used to represent group assignment during linked selection, making it a key component of <code>plotscape</code>. Moreover, while most of the components discussed so far can exist within the context of a single plot, <code>Marker</code> further differs by the fact that it is shared by all plots within the same figure.</p>
<p><code>Marker</code> has the following <code>Factor</code>-like interface which will be gradually explained below<a href="#fn34" class="footnote-ref" id="fnref34"><sup>34</sup></a>:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb91-1"><a href="system.html#cb91-1" tabindex="-1"></a><span class="kw">interface</span> Marker {</span>
<span id="cb91-2"><a href="system.html#cb91-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb91-3"><a href="system.html#cb91-3" tabindex="-1"></a>  indices<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb91-4"><a href="system.html#cb91-4" tabindex="-1"></a>  data<span class="op">:</span> { layer<span class="op">:</span> <span class="dt">number</span>[] }<span class="op">;</span></span>
<span id="cb91-5"><a href="system.html#cb91-5" tabindex="-1"></a>  transientIndices<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb91-6"><a href="system.html#cb91-6" tabindex="-1"></a>}</span></code></pre></div>
<p>However, before delving into this interface, letâs first discuss some important theoretical concepts related to <code>Marker</code>.</p>
<div id="transient-persistent" class="section level5 hasAnchor" number="7.4.4.5.1">
<h5><span class="header-section-number">7.4.4.5.1</span> Transient vs.Â persistent selection<a href="system.html#transient-persistent" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>A key concept related to <code>Marker</code> is the distinction between transient and persistent selection <span class="citation">(see also <a href="#ref-urbanek2011">Urbanek 2011</a>)</span>. By default, all <code>plotscape</code> plots are in transient selection mode, meaning that linked selection operations (e.g.Â clicking, clicking-and-dragging) assign cases transient selection status. This transient selection status is cleared by subsequent selection events, as well as many other interactions including panning, zooming, representation switching, and change of parameters. To make the results of selection persist, the user can assign cases to persistent selection groups (currently, this is done by holding down a numeric key and performing regular selection). Persistent selections are removed only by a dedicated action (double-click).</p>
<p>Importantly, a single data point can be simultaneously assigned to a persistent group <em>and</em> also be selected transiently. For example, a data point may belong to the base (unselected) group, transiently selected base group, persistent group one, transiently selected persistent group one, and so on. In other words, <code>plotscape</code> implements a very basic version of selection operators <span class="citation">(see <a href="#ref-unwin1996">Unwin et al. 1996</a>; <a href="#ref-theus2002">Theus 2002</a>)</span>: transient and persistent selection are automatically combined via intersection (the <code>AND</code> operator). While a full range of selection operators would provide much greater flexibility, I contend that this simple transient-persistent model already provides a lot of practical utility. Specifically, it enables the following interactive data visualization workflow: after marking an interesting trend with persistent selection, a user may inquire about how the trend changes when conditioning on <em>another</em> (<code>AND</code>) subset of the data, via transient selection. The transient-persistent model makes such workflow possible, without introducing the cognitive overhead having to learn multiple selection operators.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:transient-persistent-product"></span>
<img src="figures/transient-persisent-product.png" alt="A screenshot of a `plotscaper` figure showing five different selection group assignments: base/no selection (light blue), group one (light green), group two (light red/pink), transiently selected group one (dark green), and transiently selected group two (dark red). The three remaining group assignments - transiently selected base, group three, transiently selected group three - are not shown (to prevent the figure from becoming too busy). Finally, note that, in the barplot (right), the transiently selected bar segments appear at the base of the bars." width="100%" height="100%" style="border: none;" />
<p class="caption">
Figure 7.7: A screenshot of a <code>plotscaper</code> figure showing five different selection group assignments: base/no selection (light blue), group one (light green), group two (light red/pink), transiently selected group one (dark green), and transiently selected group two (dark red). The three remaining group assignments - transiently selected base, group three, transiently selected group three - are not shown (to prevent the figure from becoming too busy). Finally, note that, in the barplot (right), the transiently selected bar segments appear at the base of the bars.
</p>
</div>
<p>Final thing to note is that, during rendering, selection status is represented by paired colour shades, see Figure <a href="system.html#fig:transient-persistent-product">7.7</a>. That is, each persistent selection group is assigned a unique hue, and transient selection is indicated by a darker shade of the same hue. This colour pairing clearly visually differentiates the two selection modes, while preserving the relatedness of the persistent groups.</p>
</div>
<div id="group-indices" class="section level5 hasAnchor" number="7.4.4.5.2">
<h5><span class="header-section-number">7.4.4.5.2</span> Group assignment indices<a href="system.html#group-indices" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The key responsibility of <code>Marker</code> is to manage linked selection status (the transient-persistent model discussed in Section <a href="system.html#transient-persistent">7.4.4.5.1</a> above). It does this very similarly to a <code>Factor</code>, by maintaining an array of group assignment <code>indices</code>. Currently, in <code>pltotscape</code>, each data point can be assigned one of four primary persistent groups based on linked selection: base (no selection), persistent selection group one, persistent selection group two, and persistent selection group three. Further, as also discusssed above, each of those groups can be further split in two based on transient selection state (selected or unselected), resulting in <span class="math inline">\(4 \times 2 = 8\)</span> distinct group assignments. These group assignments are coded into indices as follows:</p>
<table>
<caption><span id="tab:index-table">Table 7.2: </span>Mappings between groups assignment and <code>Marker</code> indices.</caption>
<thead>
<tr class="header">
<th align="left">group</th>
<th align="right">index</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Base</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">Group one</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="left">Group two</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">Group three</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">Transient base</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Transient group one</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">Transient group two</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Transient group three</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>As you can see from Table <a href="system.html#tab:index-table">7.2</a>, selection groups are mapped to indices in reverse order. Transient group indices have lower values than persistent ones, and persistent groups are sorted in descending order. This reverse ordering is designed to simplify stacking operations. Group assignment inherently implies importance or salience, and, and during stacking, we often want the more âimportantâ selected groups have to higher precedence than less significant, unselected ones <span class="citation">(see also <a href="#ref-urbanek2011">Urbanek 2011</a>)</span>. For instance, in stacked barplots, the visually salient highlighted bar segments are generally placed at the base (y-axis intercept), and likewise, in dotplots, the highlighted circles are placed at the center, meaning that both have to come first in the aggregation order. Having the group indices coded in reverse order eliminates the need for sorting during later stages of the data visualization pipeline.</p>
<p>With four persistent groups (including base), many operations involving transient selection can be efficiently implemented using the third bit of the index. Specifically, as can be seen in Table <a href="system.html#tab:index-table">7.2</a>, persistent indices range from 0 to 3 and transient indices range from 4 to 7. Thus, to determine whether a case is selected, we can do a simple bitwise check of the third bit. Likewise, to add or remove transient selection, we can set the third bit appropriately.</p>
<p>Currently, transient selection is hardcoded to use the third bit, however, it should not be too difficult to raise the index to a higher bit so that more persistent selection groups can be included. For instance, raising the index up to fourth bit would enable up to eight persistent groups, raising it to the fifth bit would enable up to sixteen persistent groups, and so on. The cardinality of <code>Marker</code> would then have to be set to <span class="math inline">\(2^k\)</span> where <span class="math inline">\(k\)</span> represents the index of the transient bit. There is something to be said for keeping the number of persistent groups at <span class="math inline">\(2^k / 2\)</span>, since this preserves a correspondence between the <code>Marker</code>âs cardinality and the group assignment indices: when the number of persistent groups is <span class="math inline">\(2^k / 2\)</span>, then all indices from 0 to <code>cardinality - 1 = 2^k - 1</code> are valid (this also makes the <code>Marker</code>âs behavior more consistent with that of a <code>Factor</code>). On a different note, having too many persistent groups could also have some drawbacks. Since transient selection effectively doubles the number of colors, high numerosity of selection groups could overtax the userâs visual system, and, with too many hues, finding a paired color palette with good visual properties could become difficult. Either way, more persistent selection groups may be implemened in future versions of <code>plotscape</code>, however, this has not been a priority up to this point.</p>
</div>
<div id="updating-group-assignment-indices" class="section level5 hasAnchor" number="7.4.4.5.3">
<h5><span class="header-section-number">7.4.4.5.3</span> Updating group assignment indices<a href="system.html#updating-group-assignment-indices" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>As may be already apparent, key operations that marker has to support have to do with updating the group assignment indices. The <code>Marker</code> namespace exports the following three functions for this very purpose:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb92-1"><a href="system.html#cb92-1" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Marker</span> {</span>
<span id="cb92-2"><a href="system.html#cb92-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">clearAll</span>(marker<span class="op">:</span> Marker)<span class="op">:</span> <span class="dt">void</span> {}</span>
<span id="cb92-3"><a href="system.html#cb92-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">clearTransient</span>(marker<span class="op">:</span> Marker)<span class="op">:</span> <span class="dt">void</span> {}</span>
<span id="cb92-4"><a href="system.html#cb92-4" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">update</span>(marker<span class="op">:</span> Marker<span class="op">,</span> group<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> </span>
<span id="cb92-5"><a href="system.html#cb92-5" tabindex="-1"></a>                         selectedIndices<span class="op">:</span> <span class="dt">number</span>[])<span class="op">:</span> <span class="dt">void</span> {}</span>
<span id="cb92-6"><a href="system.html#cb92-6" tabindex="-1"></a>}</span></code></pre></div>
<p><code>Marker.clearAll</code> clears all group assignments by setting them all indices to the base value (<code>7</code>). <code>Marker.clearTransient</code> clears transient indices only. This is also where the <code>transientIndices</code> property on the <code>Marker</code> interface becomes useful. Since transient selection is removed by <em>any</em> selection group assignment, we know that the indices that were last assigned to transient selection are <em>all</em> the transient indices there are. As such, we can optimize the removal of transient selection by simply keeping track of which indices were assigned to transient selection last, and once <code>Marker.clearTransient</code> is called, simply iterating through these indices (instead of the whole array of indices).</p>
<p>Finally, the <code>Marker.update</code> is the key function for <code>Marker</code>. It changes behavior based on the <code>group</code> argument. When <code>group</code> is one of the persistent groups, it simply iterates through <code>selectedIndices</code>, setting each corresponding index in the markerâs <code>indices</code> array to the <code>group</code>âs value. When <code>group</code> has the special transient selection value, it instead adds the transient selection status to each marker index, using the bitwise operation described in Section <a href="system.html#group-indices">7.4.4.5.2</a>. Finally, it should be mentioned that, since any new selection automatically removes transient selection, <code>Marker.update</code> always first calls <code>Marker.clearTransient</code>.</p>
</div>
</div>
<div id="aggregation-summaries" class="section level4 hasAnchor" number="7.4.4.6">
<h4><span class="header-section-number">7.4.4.6</span> Aggregation: Reducers, reduceds, and summaries<a href="system.html#aggregation-summaries" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As discussed in Section <a href="problems.html#aggregation">5.2</a>, a key challenge when computing statistical summaries in interactive data visualization systems is doing so in a way that preserves the inherent hierarchy in the data. For instance, when stacking bar segments in a barplot that has been partitioned via linked selection, we want the stacking operation to respect the inherent hierarchical relationships between the segments and the bars. Further, as also demonstrated in Section <a href="problems.html#aggregation">5.2</a>, this setup suggests particular algebraic structures: groups and monoids.</p>
<p><code>Reducer</code>s and associated data structures and procedures provide a way of addressing this challenge.</p>
<div id="reducers" class="section level5 hasAnchor" number="7.4.4.6.1">
<h5><span class="header-section-number">7.4.4.6.1</span> Reducers<a href="system.html#reducers" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>A <code>Reducer&lt;T&gt;</code> is simply a data container that stores functionality and metadata associated with a monoid on type <code>T</code>. It has the following interface:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb93-1"><a href="system.html#cb93-1" tabindex="-1"></a><span class="kw">interface</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb93-2"><a href="system.html#cb93-2" tabindex="-1"></a>  name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb93-3"><a href="system.html#cb93-3" tabindex="-1"></a>  initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb93-4"><a href="system.html#cb93-4" tabindex="-1"></a>  reducefn<span class="op">:</span> (prev<span class="op">:</span> T<span class="op">,</span> next<span class="op">:</span> T) <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb93-5"><a href="system.html#cb93-5" tabindex="-1"></a>}</span></code></pre></div>
<p>That is, a <code>Reducer&lt;T&gt;</code> has a name, a zero-argument function (or a âthunkâ) producing a value of type <code>T</code>, and a binary function which takes two values of type <code>T</code> and produces another <code>T</code>. The <code>Reducer</code> namespace exports these <code>Reducer</code>s. Here are a couple of examples:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb94-1"><a href="system.html#cb94-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Reducer</span> {</span>
<span id="cb94-2"><a href="system.html#cb94-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">const</span> sum<span class="op">:</span> Reducer<span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb94-3"><a href="system.html#cb94-3" tabindex="-1"></a>    name<span class="op">:</span> <span class="vs">`sum`</span><span class="op">,</span></span>
<span id="cb94-4"><a href="system.html#cb94-4" tabindex="-1"></a>    initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb94-5"><a href="system.html#cb94-5" tabindex="-1"></a>    reducefn<span class="op">:</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y<span class="op">,</span></span>
<span id="cb94-6"><a href="system.html#cb94-6" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb94-7"><a href="system.html#cb94-7" tabindex="-1"></a></span>
<span id="cb94-8"><a href="system.html#cb94-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">const</span> product<span class="op">:</span> Reducer<span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb94-9"><a href="system.html#cb94-9" tabindex="-1"></a>    name<span class="op">:</span> <span class="vs">`product`</span><span class="op">,</span></span>
<span id="cb94-10"><a href="system.html#cb94-10" tabindex="-1"></a>    initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb94-11"><a href="system.html#cb94-11" tabindex="-1"></a>    reducefn<span class="op">:</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">*</span> y<span class="op">,</span></span>
<span id="cb94-12"><a href="system.html#cb94-12" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb94-13"><a href="system.html#cb94-13" tabindex="-1"></a></span>
<span id="cb94-14"><a href="system.html#cb94-14" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">const</span> max<span class="op">:</span> Reducer<span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb94-15"><a href="system.html#cb94-15" tabindex="-1"></a>    name<span class="op">:</span> <span class="vs">`max`</span><span class="op">,</span></span>
<span id="cb94-16"><a href="system.html#cb94-16" tabindex="-1"></a>    initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="op">-</span><span class="kw">Infinity</span><span class="op">,</span></span>
<span id="cb94-17"><a href="system.html#cb94-17" tabindex="-1"></a>    reducefn<span class="op">:</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(x<span class="op">,</span> y)<span class="op">,</span></span>
<span id="cb94-18"><a href="system.html#cb94-18" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb94-19"><a href="system.html#cb94-19" tabindex="-1"></a></span>
<span id="cb94-20"><a href="system.html#cb94-20" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">const</span> concat<span class="op">:</span> Reducer<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb94-21"><a href="system.html#cb94-21" tabindex="-1"></a>    name<span class="op">:</span> <span class="vs">`concat`</span><span class="op">,</span></span>
<span id="cb94-22"><a href="system.html#cb94-22" tabindex="-1"></a>    initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="vs">``</span><span class="op">,</span></span>
<span id="cb94-23"><a href="system.html#cb94-23" tabindex="-1"></a>    reducefn<span class="op">:</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y<span class="op">,</span></span>
<span id="cb94-24"><a href="system.html#cb94-24" tabindex="-1"></a>    <span class="co">// (string concatenation also uses `+` operator in JavaScript)</span></span>
<span id="cb94-25"><a href="system.html#cb94-25" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb94-26"><a href="system.html#cb94-26" tabindex="-1"></a>}</span></code></pre></div>
<p>For reasons discussed in Section <a href="problems.html#aggregation">5.2</a>, a <code>Reducer</code> <em>should</em> be a monoid, meaning that the operation represented by <code>reducefn</code> should be associative, and unital (with respect to <code>initialfn</code>). That is, the following should hold:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb95-1"><a href="system.html#cb95-1" tabindex="-1"></a><span class="fu">reducefn</span>(<span class="fu">reducefn</span>(a<span class="op">,</span> b)<span class="op">,</span> c) <span class="op">===</span> <span class="fu">reducefn</span>(a<span class="op">,</span> <span class="fu">reducefn</span>(b<span class="op">,</span> c))</span>
<span id="cb95-2"><a href="system.html#cb95-2" tabindex="-1"></a><span class="fu">reducefn</span>(a<span class="op">,</span> <span class="fu">initialfn</span>()) <span class="op">===</span> <span class="fu">reducefn</span>(<span class="fu">initialfn</span>()<span class="op">,</span> a) <span class="op">===</span> a</span></code></pre></div>
<p>These constraints are not actually enforced by the system: as discussed in Section <a href="problems.html#programming-with-monoids">5.2.2.7</a>, they would need to be checked with <em>all possible inputs</em>, which is not practical for large input domains such as floating point numbers or strings. However, to users familiar with functional programming, the <code>Reducer</code> interface should hopefully be evocative of monoids.</p>
</div>
<div id="reduced" class="section level5 hasAnchor" number="7.4.4.6.2">
<h5><span class="header-section-number">7.4.4.6.2</span> Reduced<a href="system.html#reduced" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We can use a <code>Reducer&lt;T&gt;</code> to aggregate or fold an array of values of type <code>T</code> (<code>T[]</code>) over a <code>Factor</code>, resulting in an array of values of type <code>T</code> of the same length as the <code>Factor</code>âs cardinality. The underlying procedure is fairly straightforward and looks something like this:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb96-1"><a href="system.html#cb96-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">reduce</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T[]<span class="op">,</span> factor<span class="op">:</span> Factor<span class="op">,</span> </span>
<span id="cb96-2"><a href="system.html#cb96-2" tabindex="-1"></a>                   reducer<span class="op">:</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> T[] {</span>
<span id="cb96-3"><a href="system.html#cb96-3" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="bu">Array</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(factor<span class="op">.</span><span class="at">cardinality</span>)<span class="op">;</span></span>
<span id="cb96-4"><a href="system.html#cb96-4" tabindex="-1"></a>  </span>
<span id="cb96-5"><a href="system.html#cb96-5" tabindex="-1"></a>  <span class="co">// Initialize values</span></span>
<span id="cb96-6"><a href="system.html#cb96-6" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> factor<span class="op">.</span><span class="at">cardinality</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb96-7"><a href="system.html#cb96-7" tabindex="-1"></a>    result[j] <span class="op">=</span> reducer<span class="op">.</span><span class="fu">initialfn</span>()<span class="op">;</span></span>
<span id="cb96-8"><a href="system.html#cb96-8" tabindex="-1"></a>  }</span>
<span id="cb96-9"><a href="system.html#cb96-9" tabindex="-1"></a>  </span>
<span id="cb96-10"><a href="system.html#cb96-10" tabindex="-1"></a>  <span class="co">// Aggregate</span></span>
<span id="cb96-11"><a href="system.html#cb96-11" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> factor<span class="op">.</span><span class="at">indices</span><span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb96-12"><a href="system.html#cb96-12" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> factor<span class="op">.</span><span class="at">indices</span>[i]<span class="op">;</span></span>
<span id="cb96-13"><a href="system.html#cb96-13" tabindex="-1"></a>    result[index] <span class="op">=</span> reducer<span class="op">.</span><span class="fu">reducefn</span>(result[index]<span class="op">,</span> x[i])<span class="op">;</span></span>
<span id="cb96-14"><a href="system.html#cb96-14" tabindex="-1"></a>  }</span>
<span id="cb96-15"><a href="system.html#cb96-15" tabindex="-1"></a>  </span>
<span id="cb96-16"><a href="system.html#cb96-16" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb96-17"><a href="system.html#cb96-17" tabindex="-1"></a>}</span></code></pre></div>
<p>After we apply this operation, we could just return the result array <code>T[]</code> as in the example above, however, in the general case, this approach would discard important information. Specifically, as discussed in Section <a href="problems.html#aggregation">5.2</a>, in a data visualization system, we rarely want to treat summaries as a simple âflatâ array of values; instead, to be able to apply transformation such as stacking or normalization, we need to retain the information about <em>how</em> these values have been produced (<code>Reducer</code>), over which partition (<code>Factor</code>), and <em>which</em> other arrays of summaries they relate to. This is what the <code>Reduced</code> data type is for<a href="#fn35" class="footnote-ref" id="fnref35"><sup>35</sup></a>:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb97-1"><a href="system.html#cb97-1" tabindex="-1"></a><span class="kw">interface</span> Reduced<span class="op">&lt;</span>T <span class="op">=</span> <span class="dt">unknown</span><span class="op">&gt;</span> <span class="kw">extends</span> <span class="bu">Array</span><span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb97-2"><a href="system.html#cb97-2" tabindex="-1"></a>  factor<span class="op">:</span> Factor<span class="op">&lt;</span>T<span class="op">&gt;,</span></span>
<span id="cb97-3"><a href="system.html#cb97-3" tabindex="-1"></a>  reducer<span class="op">:</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;,</span></span>
<span id="cb97-4"><a href="system.html#cb97-4" tabindex="-1"></a>  parent<span class="op">?:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span></span>
<span id="cb97-5"><a href="system.html#cb97-5" tabindex="-1"></a>  original<span class="op">?:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span></span>
<span id="cb97-6"><a href="system.html#cb97-6" tabindex="-1"></a>}</span></code></pre></div>
<p>The way we use <code>Reduced</code> is that we replace the return type of the <code>reduce</code> function, and then, inside the functionâs body, we simply assign the <code>Factor</code> and <code>Reducer&lt;T&gt;</code> arguments as the <code>factor</code> and <code>reducer</code> properties to the <code>result</code>, after itâs been computed:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb98-1"><a href="system.html#cb98-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">reduce</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T[]<span class="op">,</span> factor<span class="op">:</span> Factor<span class="op">,</span> </span>
<span id="cb98-2"><a href="system.html#cb98-2" tabindex="-1"></a>                   reducer<span class="op">:</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb98-3"><a href="system.html#cb98-3" tabindex="-1"></a>  </span>
<span id="cb98-4"><a href="system.html#cb98-4" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb98-5"><a href="system.html#cb98-5" tabindex="-1"></a>  </span>
<span id="cb98-6"><a href="system.html#cb98-6" tabindex="-1"></a>  result<span class="op">.</span><span class="at">factor</span> <span class="op">=</span> factor<span class="op">;</span></span>
<span id="cb98-7"><a href="system.html#cb98-7" tabindex="-1"></a>  result<span class="op">.</span><span class="at">reducer</span> <span class="op">=</span> reducer<span class="op">;</span></span>
<span id="cb98-8"><a href="system.html#cb98-8" tabindex="-1"></a>  </span>
<span id="cb98-9"><a href="system.html#cb98-9" tabindex="-1"></a>  <span class="cf">return</span> result</span>
<span id="cb98-10"><a href="system.html#cb98-10" tabindex="-1"></a>}</span></code></pre></div>
<p>That is, now we have the <code>factor</code> and <code>reducer</code> stored directly alongside array of summaries for future use when applying later transformations like stacking and normalization. This is also where the optional <code>parent</code> and <code>original</code> properties come in. The <code>parent</code> property refers to an array of summaries on the parent partition/<code>Factor</code>, whereas <code>original</code> refers to the original array of summaries, before any transformations like stacking/normalization have been applied (this is primarily useful when querying).</p>
<p>Speaking of stacking and normalization, the <code>Reduced</code> namespace also exposes the <code>stack</code>, <code>normalize</code>, and <code>shiftLeft</code> functions with the following type signatures:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb99-1"><a href="system.html#cb99-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Reduced</span> {</span>
<span id="cb99-2"><a href="system.html#cb99-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">stack</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(reduced<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span> {}</span>
<span id="cb99-3"><a href="system.html#cb99-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(reduced<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;,</span> </span>
<span id="cb99-4"><a href="system.html#cb99-4" tabindex="-1"></a>                               normalizefn<span class="op">:</span> (x<span class="op">:</span> T<span class="op">,</span> y<span class="op">:</span> T) <span class="kw">=&gt;</span> T)<span class="op">:</span> </span>
<span id="cb99-5"><a href="system.html#cb99-5" tabindex="-1"></a>                                  Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span> {}</span>
<span id="cb99-6"><a href="system.html#cb99-6" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">shiftLeft</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(reduced<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span> {}</span>
<span id="cb99-7"><a href="system.html#cb99-7" tabindex="-1"></a>}</span></code></pre></div>
<p>These functions all take <code>Reduced</code> as the first argument and compute transformations that make use of the <code>factor</code>, <code>reducer</code>, and <code>parent</code> properties, returning a new <code>Reduced</code>. For instance, the <code>stack</code> function computes a new array of stacked values, using the <code>factor</code>, <code>parent</code>, and <code>reduced</code> properties. Similarly, the <code>normalize</code> also creates and populates it with normalized values which are created by dividing the values in the original array by their corresponding <code>parent</code> values<a href="#fn36" class="footnote-ref" id="fnref36"><sup>36</sup></a>. The <code>shiftLeft</code> function creates a new array where the values are shifted by one, such that the first element is the monoidal unit (<code>reducer.initialfn()</code>), and the last element is the second to last element of the original array (the primary use-case of this is the spineplot).</p>
</div>
<div id="summaries" class="section level5 hasAnchor" number="7.4.4.6.3">
<h5><span class="header-section-number">7.4.4.6.3</span> Summaries<a href="system.html#summaries" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>With the building blocks of <code>Indexable</code>s, <code>Factor</code>s, <code>Reducer</code>s and <code>Reduced</code>s, we now have everything we need to compute the hierarchy of summaries described in Section <a href="problems.html#aggregation">5.2</a> and more specifically Section <a href="problems.html#aggregation-functor">5.2.2.4</a>. This is the exact purpose of the constructor function exported from the <code>Summaries</code> namespace:<a href="#fn37" class="footnote-ref" id="fnref37"><sup>37</sup></a>:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb100-1"><a href="system.html#cb100-1" tabindex="-1"></a><span class="kw">type</span> ReducerTuple<span class="op">&lt;</span>T <span class="op">=</span> <span class="dt">unknown</span><span class="op">&gt;</span> <span class="op">=</span> [Indexable<span class="op">&lt;</span>T<span class="op">&gt;,</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;</span>]<span class="op">;</span></span>
<span id="cb100-2"><a href="system.html#cb100-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">create</span>(summaries<span class="op">:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> ReducerTuple<span class="op">&gt;,</span> </span>
<span id="cb100-3"><a href="system.html#cb100-3" tabindex="-1"></a>                factors<span class="op">:</span> Factor[])<span class="op">:</span> Dataframe[]</span></code></pre></div>
<p>The <code>Summaries.create</code> function takes in a dictionary of <code>Indexable-Reducer</code> pairs with matching generic and an array of <code>Factor</code>s. It then repeatedly combines the factors pair-wise using <code>Factor.product</code> and then computes summaries for each new product factor using the <code>Indexable-Reducer</code> pairs in <code>summaries</code>. This results in an array of <code>Dataframe</code>s with equal length as <code>factors</code>, holding the combined data. For example:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb101-1"><a href="system.html#cb101-1" tabindex="-1"></a><span class="kw">const</span> factor1 <span class="op">=</span> Factor<span class="op">.</span><span class="fu">from</span>([<span class="vs">`a`</span><span class="op">,</span> <span class="vs">`a`</span><span class="op">,</span> <span class="vs">`b`</span><span class="op">,</span> <span class="vs">`a`</span><span class="op">,</span> <span class="vs">`b`</span><span class="op">,</span> <span class="vs">`c`</span>])</span>
<span id="cb101-2"><a href="system.html#cb101-2" tabindex="-1"></a><span class="kw">const</span> factor2 <span class="op">=</span> Factor<span class="op">.</span><span class="fu">from</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>])</span>
<span id="cb101-3"><a href="system.html#cb101-3" tabindex="-1"></a><span class="kw">const</span> factor3 <span class="op">=</span> Factor<span class="op">.</span><span class="fu">product</span>(factor1<span class="op">,</span> factor2)</span>
<span id="cb101-4"><a href="system.html#cb101-4" tabindex="-1"></a><span class="kw">const</span> summaries <span class="op">=</span> { stat<span class="op">:</span> [[<span class="dv">10</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">11</span><span class="op">,</span> <span class="dv">10</span>]<span class="op">,</span> Reducer<span class="op">.</span><span class="at">sum</span>] }</span>
<span id="cb101-5"><a href="system.html#cb101-5" tabindex="-1"></a></span>
<span id="cb101-6"><a href="system.html#cb101-6" tabindex="-1"></a><span class="kw">const</span> summarized <span class="op">=</span> Summaries<span class="op">.</span><span class="fu">create</span>(summaries<span class="op">,</span> [factor1<span class="op">,</span> factor3])</span>
<span id="cb101-7"><a href="system.html#cb101-7" tabindex="-1"></a>Dataframe<span class="op">.</span><span class="fu">rows</span>(summarized[<span class="dv">0</span>]) </span>
<span id="cb101-8"><a href="system.html#cb101-8" tabindex="-1"></a><span class="co">// [ { label: `a`, stat: 37 }, </span></span>
<span id="cb101-9"><a href="system.html#cb101-9" tabindex="-1"></a><span class="co">//   { label: `b`, stat: 20 }, </span></span>
<span id="cb101-10"><a href="system.html#cb101-10" tabindex="-1"></a><span class="co">//   { label: `c`, stat: 10 } ]</span></span>
<span id="cb101-11"><a href="system.html#cb101-11" tabindex="-1"></a></span>
<span id="cb101-12"><a href="system.html#cb101-12" tabindex="-1"></a>Dataframe<span class="op">.</span><span class="fu">rows</span>(summarized[<span class="dv">1</span>]) </span>
<span id="cb101-13"><a href="system.html#cb101-13" tabindex="-1"></a><span class="co">// [ { label: `a`, label$: `0`, stat: 22 }, </span></span>
<span id="cb101-14"><a href="system.html#cb101-14" tabindex="-1"></a><span class="co">//   { label: `a`, label$: `1`, stat: 15 }, </span></span>
<span id="cb101-15"><a href="system.html#cb101-15" tabindex="-1"></a><span class="co">//   ... ]</span></span></code></pre></div>
<p>Thus, the overt behavior of the <code>Summaries.create()</code> is to compute summaries using <code>Reducer</code>s and combine the resulting data with the corresponding <code>Factor</code> data. However, under the hood, the function also does a couple more things. First, it links all reduced variables created from <code>summaries</code> with their parent-data counterpart (by assigning the <code>parent</code> property on the <code>Reduced</code>s). It also sets up a reactive graph, such that when a factor is updated, its corresponding data is updated, and so are its child factors and their corresponding data.</p>
<p>Finally, to actually render the summarized data, the summaries need to be translated to aesthetic mappings. This happens via the <code>Summaries.translate()</code> function. Again, overtly, this function simply maps the array of <code>Dataframe</code>s, however, under the hood it also manages reactivity. For instance, the following is a translating function in the definition of a histogram, taken almost directly from the codebase:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb102-1"><a href="system.html#cb102-1" tabindex="-1"></a><span class="kw">const</span> zero <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb102-2"><a href="system.html#cb102-2" tabindex="-1"></a><span class="kw">const</span> coordinates <span class="op">=</span> Summaries<span class="op">.</span><span class="fu">translate</span>(summarized<span class="op">,</span> [</span>
<span id="cb102-3"><a href="system.html#cb102-3" tabindex="-1"></a>  (d) <span class="kw">=&gt;</span> d<span class="op">,</span></span>
<span id="cb102-4"><a href="system.html#cb102-4" tabindex="-1"></a>  (d) <span class="kw">=&gt;</span> ({</span>
<span id="cb102-5"><a href="system.html#cb102-5" tabindex="-1"></a>      x0<span class="op">:</span> d<span class="op">.</span><span class="at">binMin</span><span class="op">,</span></span>
<span id="cb102-6"><a href="system.html#cb102-6" tabindex="-1"></a>      y0<span class="op">:</span> zero<span class="op">,</span></span>
<span id="cb102-7"><a href="system.html#cb102-7" tabindex="-1"></a>      x1<span class="op">:</span> d<span class="op">.</span><span class="at">binMax</span><span class="op">,</span></span>
<span id="cb102-8"><a href="system.html#cb102-8" tabindex="-1"></a>      y1<span class="op">:</span> d<span class="op">.</span><span class="at">stat</span><span class="op">,</span></span>
<span id="cb102-9"><a href="system.html#cb102-9" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb102-10"><a href="system.html#cb102-10" tabindex="-1"></a>  (d) <span class="kw">=&gt;</span> ({</span>
<span id="cb102-11"><a href="system.html#cb102-11" tabindex="-1"></a>    x0<span class="op">:</span> d<span class="op">.</span><span class="at">binMin</span><span class="op">,</span></span>
<span id="cb102-12"><a href="system.html#cb102-12" tabindex="-1"></a>    y0<span class="op">:</span> zero<span class="op">,</span></span>
<span id="cb102-13"><a href="system.html#cb102-13" tabindex="-1"></a>    x1<span class="op">:</span> d<span class="op">.</span><span class="at">binMax</span><span class="op">,</span></span>
<span id="cb102-14"><a href="system.html#cb102-14" tabindex="-1"></a>    y1<span class="op">:</span> Reduced<span class="op">.</span><span class="fu">stack</span>(d<span class="op">.</span><span class="at">stat</span>)<span class="op">,</span></span>
<span id="cb102-15"><a href="system.html#cb102-15" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb102-16"><a href="system.html#cb102-16" tabindex="-1"></a>])<span class="op">;</span></span></code></pre></div>
<p>Notice that the translating function actually maps three data sets. The first, representing a summary on the whole data set, is not used directly in histograms but its utility will be explained below. The second, representing summaries across histogram bins (whole bars), is used for axis limits and collision detection during selection. The third, representing summaries across the product of histogram bins and <code>Marker</code> status (bar segments), is used for rendering. Notice that, in the case of the <code>y1</code> variable in the third data set, we use the <code>Reduced.stack()</code> function to stack the bar segments on top of each other, within the appropriate factor level and using the associated <code>Reducer</code>.</p>
<p>The reason why the histogram data is summarized across three partitions - constant, bins, bins and marker - is to facilitate seamless transition between histograms and spinograms. Histograms and spinograms represent largely the same underlying data (summaries computed across bins), however, spinograms additionally require a whole-dataset summary to establish the upper (right) x-axis limit. By pre-computing summaries on the constant partition, we enable switching between histograms and spinograms without having to re-calculate the summaries, requiring only change in translation/aesthetic mapping. For illustration, hereâs how the translation of the same underlying data into a spinogram looks like in <code>plotscape</code>:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb103-1"><a href="system.html#cb103-1" tabindex="-1"></a><span class="kw">const</span> coordinates <span class="op">=</span> Summaries<span class="op">.</span><span class="fu">translate</span>(summarized<span class="op">,</span> [</span>
<span id="cb103-2"><a href="system.html#cb103-2" tabindex="-1"></a>  (d) <span class="kw">=&gt;</span> d<span class="op">,</span></span>
<span id="cb103-3"><a href="system.html#cb103-3" tabindex="-1"></a>  (d) <span class="kw">=&gt;</span> ({</span>
<span id="cb103-4"><a href="system.html#cb103-4" tabindex="-1"></a>    x0<span class="op">:</span> Reduced<span class="op">.</span><span class="fu">shiftLeft</span>(Reduced<span class="op">.</span><span class="fu">stack</span>(d<span class="op">.</span><span class="at">stat</span>))<span class="op">,</span></span>
<span id="cb103-5"><a href="system.html#cb103-5" tabindex="-1"></a>    y0<span class="op">:</span> zero<span class="op">,</span></span>
<span id="cb103-6"><a href="system.html#cb103-6" tabindex="-1"></a>    x1<span class="op">:</span> Reduced<span class="op">.</span><span class="fu">stack</span>(d<span class="op">.</span><span class="at">stat</span>)<span class="op">,</span></span>
<span id="cb103-7"><a href="system.html#cb103-7" tabindex="-1"></a>    y1<span class="op">:</span> one<span class="op">,</span></span>
<span id="cb103-8"><a href="system.html#cb103-8" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb103-9"><a href="system.html#cb103-9" tabindex="-1"></a>  (d) <span class="kw">=&gt;</span> ({</span>
<span id="cb103-10"><a href="system.html#cb103-10" tabindex="-1"></a>    x0<span class="op">:</span> Reduced<span class="op">.</span><span class="fu">shiftLeft</span>(Reduced<span class="op">.</span><span class="fu">stack</span>(Reduced<span class="op">.</span><span class="fu">parent</span>(d<span class="op">.</span><span class="at">stat</span>)))<span class="op">,</span></span>
<span id="cb103-11"><a href="system.html#cb103-11" tabindex="-1"></a>    y0<span class="op">:</span> zero<span class="op">,</span></span>
<span id="cb103-12"><a href="system.html#cb103-12" tabindex="-1"></a>    x1<span class="op">:</span> Reduced<span class="op">.</span><span class="fu">stack</span>(Reduced<span class="op">.</span><span class="fu">parent</span>(d<span class="op">.</span><span class="at">stat</span>))<span class="op">,</span></span>
<span id="cb103-13"><a href="system.html#cb103-13" tabindex="-1"></a>    y1<span class="op">:</span> Reduced<span class="op">.</span><span class="fu">normalize</span>(Reduced<span class="op">.</span><span class="fu">stack</span>(d<span class="op">.</span><span class="at">stat</span>)<span class="op">,</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">/</span> y)<span class="op">,</span></span>
<span id="cb103-14"><a href="system.html#cb103-14" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb103-15"><a href="system.html#cb103-15" tabindex="-1"></a>])<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="scales" class="section level4 hasAnchor" number="7.4.4.7">
<h4><span class="header-section-number">7.4.4.7</span> Scales<a href="system.html#scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As discussed in Section <a href="problems.html#scaling">5.3</a>, to visualize data, we need to translate values from the domain of the data to the domain of the graphical device (computer screen). In many data visualization packages, this work is done by specialized components called scales. The theoretical model of scales <code>plotscape</code> uses was already discussed in Section <a href="problems.html#scaling">5.3</a>, with the key takeway being that a scales are fundamentally composed of two components: its domain and codomain. In Section <a href="problems.html#scales-comparison">5.3.0.4</a>, I briefly discussed the fact that many popular data visualization systems treat the domain and codomain as fundamentally different entities. I argued that this creates unnecessary complexity, and instead suggested a unified model where both the domain and codomain are represented by the same types. In this section, I will discuss the <code>plotscape</code>âs implementation of scales, <code>Scale</code>.</p>
<p>In Section <a href="problems.html#scaling">5.3</a>, I mentioned that a key idea for creating a generic model of scales involves conceptualizing scales as composed of two components, each translating values to and from their respective domain and the real numbers <span class="math inline">\(\mathbb{R}\)</span>. In <code>plotscape</code>, these components are called <code>Expanse</code>s and will be discussed later, in Section <a href="system.html#expanses">7.4.4.8</a>. However, for now, assume we have some generic type <code>Expanse&lt;T&gt;</code> and a corresponding namespace which exposes two functions:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb104-1"><a href="system.html#cb104-1" tabindex="-1"></a><span class="kw">interface</span> Expanse<span class="op">&lt;</span>T <span class="op">=</span> <span class="dt">unknown</span><span class="op">&gt;</span> {}</span>
<span id="cb104-2"><a href="system.html#cb104-2" tabindex="-1"></a></span>
<span id="cb104-3"><a href="system.html#cb104-3" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Expanse</span> {</span>
<span id="cb104-4"><a href="system.html#cb104-4" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> </span>
<span id="cb104-5"><a href="system.html#cb104-5" tabindex="-1"></a>                               x<span class="op">:</span> T)<span class="op">:</span> <span class="dt">number</span> {}</span>
<span id="cb104-6"><a href="system.html#cb104-6" tabindex="-1"></a>  </span>
<span id="cb104-7"><a href="system.html#cb104-7" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> </span>
<span id="cb104-8"><a href="system.html#cb104-8" tabindex="-1"></a>                                 x<span class="op">:</span> <span class="dt">number</span>)<span class="op">:</span> T {}</span>
<span id="cb104-9"><a href="system.html#cb104-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, assuming we have some type and namespace <code>Expanse</code> that behaves this way, we can define the <code>Scale</code> interface as follows:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb105-1"><a href="system.html#cb105-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>T<span class="op">,</span> U<span class="op">&gt;</span> {</span>
<span id="cb105-2"><a href="system.html#cb105-2" tabindex="-1"></a>  domain<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;;</span></span>
<span id="cb105-3"><a href="system.html#cb105-3" tabindex="-1"></a>  codomain<span class="op">:</span> Expanse<span class="op">&lt;</span>U<span class="op">&gt;;</span></span>
<span id="cb105-4"><a href="system.html#cb105-4" tabindex="-1"></a></span>
<span id="cb105-5"><a href="system.html#cb105-5" tabindex="-1"></a>  zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb105-6"><a href="system.html#cb105-6" tabindex="-1"></a>  one<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb105-7"><a href="system.html#cb105-7" tabindex="-1"></a>  direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb105-8"><a href="system.html#cb105-8" tabindex="-1"></a>  scale<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb105-9"><a href="system.html#cb105-9" tabindex="-1"></a>  mult<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb105-10"><a href="system.html#cb105-10" tabindex="-1"></a>}</span></code></pre></div>
<p>The two primary properties of <code>Scale</code> are <code>domain</code> and <code>codomain</code>, both of type <code>Expanse</code>. The utility of the other properties relates to concepts discussed in Section <a href="problems.html#scaling-intermediate">5.3.0.3.2</a> and will be discussed later. However, for now, we can focus solely on <code>domain</code> and <code>codomain</code>. These two properties are sufficient to implement the core functionality of <code>Scale</code>: the <code>pushforward</code> and <code>pullback</code> functions. To explain what these functions do, it may be easiest to just show the code:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb106-1"><a href="system.html#cb106-1" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb106-2"><a href="system.html#cb106-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>T<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>T<span class="op">,</span> V<span class="op">&gt;,</span> x<span class="op">:</span> T)<span class="op">:</span> V {</span>
<span id="cb106-3"><a href="system.html#cb106-3" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb106-4"><a href="system.html#cb106-4" tabindex="-1"></a>    <span class="kw">const</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> x)</span>
<span id="cb106-5"><a href="system.html#cb106-5" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)<span class="op">;</span></span>
<span id="cb106-6"><a href="system.html#cb106-6" tabindex="-1"></a>  }</span>
<span id="cb106-7"><a href="system.html#cb106-7" tabindex="-1"></a></span>
<span id="cb106-8"><a href="system.html#cb106-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>T<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>T<span class="op">,</span> V<span class="op">&gt;,</span> x<span class="op">:</span> V)<span class="op">:</span> T {</span>
<span id="cb106-9"><a href="system.html#cb106-9" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb106-10"><a href="system.html#cb106-10" tabindex="-1"></a>    <span class="kw">const</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(codomain<span class="op">,</span> x)</span>
<span id="cb106-11"><a href="system.html#cb106-11" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(domain<span class="op">,</span> normalized)</span>
<span id="cb106-12"><a href="system.html#cb106-12" tabindex="-1"></a>  }</span>
<span id="cb106-13"><a href="system.html#cb106-13" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>Scale.pushforward</code> function takes as its arguments a <code>Scale&lt;T, U&gt;</code> and a value of type <code>T</code> (corresponding to the scaleâs domain). It then converts this value to a <code>number</code>, using <code>Expanse.normalize</code> with <code>domain</code> as the first argument. Finally, it converts this number back to the value of type <code>V</code> (corresponding to the scaleâs codomain), using <code>Expanse.unnormalize</code>, with the <code>codomain</code> as the first argument. Conversely, the <code>Scale.pullback</code> function performs the reverse operation: it first normalizes the value within codomain and then unnormalizes it within the domain. In this way, <code>Scale.pullback</code> acts as an inverse mapping of the type discussed in Section <a href="problems.html#scaling-inverses">5.3.0.3.4</a>. Put simply, the <code>Scale</code> acts as just a kind of connector or âplumbingâ between its corresponding <code>domain</code> and <code>codomain</code>, converting values from one space to the other.</p>
<p>Thus, most of the heavy lifting related to scaling is done by the <code>domain</code> and <code>codomain</code> properties, both of type <code>Expanse</code>. However, before we go on to discuss <code>Expanse</code>, we should explore the remaining <code>Scale</code> properties.</p>
<div id="scale-properties" class="section level5 hasAnchor" number="7.4.4.7.1">
<h5><span class="header-section-number">7.4.4.7.1</span> Scale properties<a href="system.html#scale-properties" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Besides <code>domain</code> and <code>codomain</code>, scale also has five numeric properties: <code>zero</code>, <code>one</code>, <code>direction</code>, <code>scale</code>, and <code>mult</code>. These properties act as parameters of the (implicit) intermediate domain. They facilitate a range of domain-and-codomain-agnostic scale operations, including zooming, panning, growing/shrinking, and reversing, and are applied during calls to <code>Scale.pushforward</code> or <code>Scale.pullback</code>. For instance, hereâs how a âmore fullâ<a href="#fn38" class="footnote-ref" id="fnref38"><sup>38</sup></a> implementation of <code>Scale.pushforward</code> looks like:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb107-1"><a href="system.html#cb107-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>T<span class="op">,</span> U<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>T<span class="op">,</span> U<span class="op">&gt;,</span> x<span class="op">:</span> T)<span class="op">:</span> U {</span>
<span id="cb107-2"><a href="system.html#cb107-2" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> zero<span class="op">,</span> one<span class="op">,</span> direction<span class="op">,</span> scale<span class="op">,</span> mult } <span class="op">=</span> scale</span>
<span id="cb107-3"><a href="system.html#cb107-3" tabindex="-1"></a>  </span>
<span id="cb107-4"><a href="system.html#cb107-4" tabindex="-1"></a>  <span class="co">// Normalize to [0, 1]</span></span>
<span id="cb107-5"><a href="system.html#cb107-5" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> x)<span class="op">;</span>  </span>
<span id="cb107-6"><a href="system.html#cb107-6" tabindex="-1"></a>  <span class="co">// Grow/shrink</span></span>
<span id="cb107-7"><a href="system.html#cb107-7" tabindex="-1"></a>  normalized <span class="op">=</span> normalized <span class="op">*</span> scale <span class="op">*</span> mult<span class="op">;</span>         </span>
<span id="cb107-8"><a href="system.html#cb107-8" tabindex="-1"></a>  <span class="co">// Apply margins</span></span>
<span id="cb107-9"><a href="system.html#cb107-9" tabindex="-1"></a>  normalized <span class="op">=</span> zero <span class="op">+</span> normalized <span class="op">*</span> (one <span class="op">-</span> zero)<span class="op">;</span>  </span>
<span id="cb107-10"><a href="system.html#cb107-10" tabindex="-1"></a>  <span class="co">// Apply direction</span></span>
<span id="cb107-11"><a href="system.html#cb107-11" tabindex="-1"></a>  normalized <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> direction) <span class="op">+</span> direction <span class="op">*</span> normalized<span class="op">;</span>  </span>
<span id="cb107-12"><a href="system.html#cb107-12" tabindex="-1"></a>  </span>
<span id="cb107-13"><a href="system.html#cb107-13" tabindex="-1"></a>  <span class="cf">return</span> codomain<span class="op">.</span><span class="fu">unnormalize</span>(normalized)<span class="op">;</span></span>
<span id="cb107-14"><a href="system.html#cb107-14" tabindex="-1"></a>}</span></code></pre></div>
<p>Letâs break down how these properties affect <code>Scale.pushforward</code>. First, normalized values get multiplied by the <code>scale</code> and <code>mult</code>:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb108-1"><a href="system.html#cb108-1" tabindex="-1"></a>normalized <span class="op">=</span> normalized <span class="op">*</span> scale <span class="op">*</span> mult<span class="op">;</span></span></code></pre></div>
<p>Together, these <code>scale</code> and <code>mult</code> jointly define a multiplicative factor that gets applied to all values during scaling. The reason for separating them into two properties is to allow for both default and interactive scaling. Often, we want to apply a default scaling factor (<code>scale</code>) while still enabling users to dynamically adjust the overall magnitude of multiplication (<code>mult</code>). For instance, in a barplot, bars might have a default maximum width corresponding to a fraction of the total plot width (<code>scale</code>), but users should still be able to interactively resize them (via <code>mult</code>).</p>
<p>Second, as discussed in Section <a href="problems.html#scaling-intermediate">5.3.0.3.2</a>, the <code>zero</code> and <code>one</code> properties apply proportional margins to the normalized values:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb109-1"><a href="system.html#cb109-1" tabindex="-1"></a>normalized <span class="op">=</span> zero <span class="op">+</span> normalized <span class="op">*</span> (one <span class="op">-</span> zero)<span class="op">;</span></span></code></pre></div>
<p>For instance, assuming that by <code>Expanse.normalize</code> maps the âminimumâ and âmaximumâ values of the domain to 0 and 1, respectively, setting <code>zero</code> to 0.1 and <code>one</code> to 0.9 expands the scale and applies a symmetric 10% margin on both ends. Importantly, this expansion is consistent across all concrete <code>Expanse</code> subtypes used for the <code>domain</code> and <code>codomain</code>. Further, as also discussed in Section <a href="problems.html#scaling-intermediate">5.3.0.3.2</a>, incrementing both values by the same amount effectively shifts the scale. Consequently, the implementation of panning is as simple as:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb110-1"><a href="system.html#cb110-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>)<span class="op">:</span> <span class="dt">void</span> {</span>
<span id="cb110-2"><a href="system.html#cb110-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">zero</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb110-3"><a href="system.html#cb110-3" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">one</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb110-4"><a href="system.html#cb110-4" tabindex="-1"></a>}</span></code></pre></div>
<p>Again, this implementation of panning is also domain-and-codomain-agnostic. Further, it can result in <code>zero</code> and <code>one</code> values outside of <span class="math inline">\([0, 1]\)</span>, which is fine since, as mentioned in Section <a href="problems.html#scaling-intermediate">5.3.0.3.2</a>, at times we may want to map points outside of the codomain (e.g.Â scatterplot points with x- and y- coordinates outside of the plot but with plot-overlapping radius). Finally, we can also use the <code>zero</code> and <code>one</code> properties to zoom into a specific region of the scale, using the <code>Scale.expand</code> function. The logic of this function is a bit more complicated, but can be understood with careful application of (highschool) algebra:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb111-1"><a href="system.html#cb111-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">invertRange</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb111-2"><a href="system.html#cb111-2" tabindex="-1"></a>  <span class="kw">const</span> rangeInverse <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> (max <span class="op">-</span> min)<span class="op">;</span></span>
<span id="cb111-3"><a href="system.html#cb111-3" tabindex="-1"></a>    <span class="cf">return</span> [<span class="op">-</span>min <span class="op">*</span> rangeInverse<span class="op">,</span> (<span class="dv">1</span> <span class="op">-</span> min) <span class="op">*</span> rangeInverse]<span class="op">;</span></span>
<span id="cb111-4"><a href="system.html#cb111-4" tabindex="-1"></a>}</span>
<span id="cb111-5"><a href="system.html#cb111-5" tabindex="-1"></a></span>
<span id="cb111-6"><a href="system.html#cb111-6" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">expand</span>(scale<span class="op">:</span> Scale<span class="op">,</span> </span>
<span id="cb111-7"><a href="system.html#cb111-7" tabindex="-1"></a>                       zero<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> one<span class="op">:</span> <span class="dt">number</span>)<span class="op">:</span> <span class="dt">void</span> {</span>
<span id="cb111-8"><a href="system.html#cb111-8" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">:</span> currentZero<span class="op">,</span> one<span class="op">:</span> currentOne<span class="op">,</span> direction } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb111-9"><a href="system.html#cb111-9" tabindex="-1"></a>  <span class="kw">const</span> currentRange <span class="op">=</span> currentOne <span class="op">-</span> currentZero<span class="op">;</span></span>
<span id="cb111-10"><a href="system.html#cb111-10" tabindex="-1"></a></span>
<span id="cb111-11"><a href="system.html#cb111-11" tabindex="-1"></a>  <span class="co">// Reflect if direction is backwards</span></span>
<span id="cb111-12"><a href="system.html#cb111-12" tabindex="-1"></a>  <span class="cf">if</span> (direction <span class="op">===</span> <span class="op">-</span><span class="dv">1</span>) [zero<span class="op">,</span> one] <span class="op">=</span> [<span class="dv">1</span> <span class="op">-</span> zero<span class="op">,</span> <span class="dv">1</span> <span class="op">-</span> one]<span class="op">;</span></span>
<span id="cb111-13"><a href="system.html#cb111-13" tabindex="-1"></a></span>
<span id="cb111-14"><a href="system.html#cb111-14" tabindex="-1"></a>  <span class="kw">const</span> normalizeCurr <span class="op">=</span> (x) <span class="kw">=&gt;</span> (x <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb111-15"><a href="system.html#cb111-15" tabindex="-1"></a>  <span class="co">// Normalize the zoom values within the current range</span></span>
<span id="cb111-16"><a href="system.html#cb111-16" tabindex="-1"></a>  [zero<span class="op">,</span> one] <span class="op">=</span> [zero<span class="op">,</span> one]<span class="op">.</span><span class="fu">map</span>(normalizeCurr)<span class="op">;</span></span>
<span id="cb111-17"><a href="system.html#cb111-17" tabindex="-1"></a>  [zero<span class="op">,</span> one] <span class="op">=</span> <span class="fu">invertRange</span>(zero<span class="op">,</span> one)<span class="op">;</span></span>
<span id="cb111-18"><a href="system.html#cb111-18" tabindex="-1"></a></span>
<span id="cb111-19"><a href="system.html#cb111-19" tabindex="-1"></a>  <span class="co">// Reflect back</span></span>
<span id="cb111-20"><a href="system.html#cb111-20" tabindex="-1"></a>  <span class="cf">if</span> (direction <span class="op">===</span> <span class="op">-</span><span class="dv">1</span>) [zero<span class="op">,</span> one] <span class="op">=</span> [<span class="dv">1</span> <span class="op">-</span> zero<span class="op">,</span> <span class="dv">1</span> <span class="op">-</span> one]<span class="op">;</span></span>
<span id="cb111-21"><a href="system.html#cb111-21" tabindex="-1"></a>    </span>
<span id="cb111-22"><a href="system.html#cb111-22" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">zero</span> <span class="op">=</span> zero</span>
<span id="cb111-23"><a href="system.html#cb111-23" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">one</span> <span class="op">=</span> one</span>
<span id="cb111-24"><a href="system.html#cb111-24" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>Scale.expand</code> function zooms into a proportional region of the scale, using the two numeric arguments as boundaries of this region. For instance, <code>Expand.scale(scale, 0.25, 0.75)</code> zooms into the middle 50% of the scale. The key part of this operation is the <code>invertRange</code> function. This takes a numeric interval given by <span class="math inline">\([\min, \max]\)</span> and inverts this, such that, when the simple linear normalizing function <span class="math inline">\(n(x) = (x - \min) / (\max - \min)\)</span> is applied to 0 and 1 with the new values, the result will be <span class="math inline">\(n(0) = a\)</span> and <span class="math inline">\(n(1) = b\)</span>, respectively. The rest of the <code>Scale.expand</code> function is just book-keeping, handling the case where <code>zero</code>, <code>one</code>, and <code>direction</code> have been set to non-default values.</p>
<p>Third and finally, the <code>direction</code> property gets applied to the normalized values in the following way:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb112-1"><a href="system.html#cb112-1" tabindex="-1"></a>normalized <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> direction) <span class="op">+</span> direction <span class="op">*</span> normalized<span class="op">;</span></span></code></pre></div>
<p>The line of code above is essentially a branchless conditional. When <code>direction</code> is 1, then the first term in the sum evaluates to zero and the result is just the value <code>normalized</code>. Conversely, when <code>direction</code> is -1, the first term evaluates to one and the result is <code>1 - normalized</code>, effectively reversing the normalized value. This approach avoids explicit branching, which can be expensive, particularly when the branches are unpredictable. Although the JavaScript engine may be able to optimize a simple <code>if/else</code> statement if it was used here, and branch prediction would likely be accurate within long-running loops, this micro-optimization may nevertheless be useful since scaling represents a âhotâ code path: it has to occur during any rendering/selection.</p>
<p>With this detailed explanation, the behavior of <code>Scale.pushforward</code> should be clear. The <code>Scale.pullback</code> function follows a similar pattern, but with inverse transformations applied in reverse order (i.e.Â <code>direction</code> first, then <code>zero</code> and <code>one</code>, and finally <code>scale</code> and <code>mult</code>). This concludes our examination of the <code>Scale</code> class. We will now proceed to discuss the type and behavior of its <code>domain</code> and <code>codomain</code> components: <code>Expanse</code>s.</p>
</div>
</div>
<div id="expanses" class="section level4 hasAnchor" number="7.4.4.8">
<h4><span class="header-section-number">7.4.4.8</span> Expanses<a href="system.html#expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As discussed in the previous section, a <code>Scale</code> maps values between two spaces, defined by the <code>domain</code> and <code>codomain</code> properties, both of type <code>Expanse</code>. In other words, a <code>Scale</code> primarily acts as a sort of a connector, while the <code>Expanse</code> properties handle the core underlying transformations. Specifically, <code>Expanse&lt;T&gt;</code> is a generic type designed to convert values of type <code>T</code> to and from numerical representations, a process facilitated by the previously mentioned <code>normalize</code> and <code>unnormalize</code> functions. Beyond these core functions, it may be also beneficial to have additional generic functionality on each <code>Expanse&lt;T&gt;</code> subtype, namely the ability to âtrainâ the expanse on new values and return a list of potential axis breaks. This leads to the following interface:</p>
<p>Note that, up until this point, <code>interface</code>s have been used to define components as a plain data containers, however, with <code>Expanse&lt;T&gt;</code>, it is now used differently: to define abstract functionality. The reason for this is that <code>Expanse&lt;T&gt;</code> is the first component of the system which absolutely requires runtime polymorphism. Specifically, the implementation of <code>normalize</code> and <code>unnormalize</code> has to vary significantly across different <code>Expanse&lt;T&gt;</code> subtypes, by necessity. For instance, converting numbers to numbers is a fundamentally different task than converting strings to numbers. Further, even when the same generic type <code>T</code> is used, there may be use cases for different implementations of the conversion process (as we will explore later). This makes polymorphism necessary. In current version of <code>plotscape</code>, I maintain the data-oriented approach of separate data-behaviour containers and hand-roll the polymorphism by dispatching on a type property, however, a case could be made for adopting object-oriented principles here and writing expanse subtypes as classes which implement the <code>Expanse&lt;T&gt;</code> interface (or even implementing <code>Expanse&lt;T&gt;</code> as an abstract class).</p>
<p>This is really all there is to say about the <code>Expanse&lt;T&gt;</code> interface. The real functionality lies within its subtypes, which we will now explore.</p>
</div>
<div id="continuous-expanses" class="section level4 hasAnchor" number="7.4.4.9">
<h4><span class="header-section-number">7.4.4.9</span> Continuous expanses<a href="system.html#continuous-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The most straightforward type of expanse is <code>ExpanseContinuous</code>, implementing an interface of <code>Expanse&lt;number&gt;</code>. It generalizes the linear mapping discussed in Section <a href="problems.html#scales-as-functions">5.3.0.1</a>, values to and from a range given by <code>[min, max]</code>. Typically (but not always), this amounts to mapping a data value equal to <code>min</code> to zero and data value equal to <code>max</code> to 1, with intermediate values interpolated to <code>(0, 1)</code>. Here is a simplified interface for the <code>ExpanseContinuous</code> data container:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb113-1"><a href="system.html#cb113-1" tabindex="-1"></a><span class="kw">interface</span> ExpanseContinuous {</span>
<span id="cb113-2"><a href="system.html#cb113-2" tabindex="-1"></a>  min<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb113-3"><a href="system.html#cb113-3" tabindex="-1"></a>  max<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb113-4"><a href="system.html#cb113-4" tabindex="-1"></a>  offset<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb113-5"><a href="system.html#cb113-5" tabindex="-1"></a>  trans<span class="op">:</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb113-6"><a href="system.html#cb113-6" tabindex="-1"></a>  inv<span class="op">:</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb113-7"><a href="system.html#cb113-7" tabindex="-1"></a>  ratio<span class="op">:</span> <span class="dt">boolean</span><span class="op">;</span></span>
<span id="cb113-8"><a href="system.html#cb113-8" tabindex="-1"></a>}</span></code></pre></div>
<p>As mentioned above, the <code>min</code> and <code>max</code> denote the lower and upper bound of the data range, respectively. The <code>offset</code> property allows us to shift the data values by some pre-specified constant. This is useful, for example, when we want to ensure that the width of a spineplot bar is exactly 1 pixel less than the available space. The <code>trans</code> and <code>inv</code> properties allow us to apply non-linear transformations; they should, intuitively, be inverses of each other, and by default, they are set to the identity function (<code>(x) =&gt; x</code>). Finally, the <code>ratio</code> property, a boolean flag, indicates if the expanse is part of a ratio scale (see Section <a href="background.html#scales-measurement">4.3.3</a>). If <code>ratio</code> is <code>true</code>, the <code>min</code> value is fixed at zero and cannot be modified, even by training on new data.</p>
<p>The <code>normalize</code> and <code>unnormalize</code> functions in the <code>ExpanseContinuous</code> namespace are generalizations of the linear map:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb114-1"><a href="system.html#cb114-1" tabindex="-1"></a><span class="co">// ExpanseContinuous.ts</span></span>
<span id="cb114-2"><a href="system.html#cb114-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpanseContinuous</span> {</span>
<span id="cb114-3"><a href="system.html#cb114-3" tabindex="-1"></a>    <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpanseContinuous<span class="op">,</span> </span>
<span id="cb114-4"><a href="system.html#cb114-4" tabindex="-1"></a>                              x<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb114-5"><a href="system.html#cb114-5" tabindex="-1"></a>      <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> offset<span class="op">,</span> trans } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb114-6"><a href="system.html#cb114-6" tabindex="-1"></a>      <span class="cf">return</span> (<span class="fu">trans</span>(x <span class="op">-</span> offset) <span class="op">-</span> <span class="fu">trans</span>(min)) <span class="op">/</span> </span>
<span id="cb114-7"><a href="system.html#cb114-7" tabindex="-1"></a>        (<span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min))<span class="op">;</span></span>
<span id="cb114-8"><a href="system.html#cb114-8" tabindex="-1"></a>  }</span>
<span id="cb114-9"><a href="system.html#cb114-9" tabindex="-1"></a></span>
<span id="cb114-10"><a href="system.html#cb114-10" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpanseContinuous<span class="op">,</span> </span>
<span id="cb114-11"><a href="system.html#cb114-11" tabindex="-1"></a>                              value<span class="op">:</span> x) {</span>
<span id="cb114-12"><a href="system.html#cb114-12" tabindex="-1"></a>      <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> offset<span class="op">,</span> trans<span class="op">,</span> inv } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb114-13"><a href="system.html#cb114-13" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">inv</span>(<span class="fu">trans</span>(min) <span class="op">+</span> x <span class="op">*</span> (<span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min))) <span class="op">+</span> </span>
<span id="cb114-14"><a href="system.html#cb114-14" tabindex="-1"></a>        offset<span class="op">;</span></span>
<span id="cb114-15"><a href="system.html#cb114-15" tabindex="-1"></a>  }</span>
<span id="cb114-16"><a href="system.html#cb114-16" tabindex="-1"></a>}</span></code></pre></div>
<p>Note that these functions take into account the non-linear transformations (<code>trans</code>, <code>inv</code>) and the <code>offset</code>. First, <code>offset</code> is applied to the value immediately, before normalization (or after, in the case of <code>unnormalize</code>). Second, the non-linear transformations are applied to the expanseâs limits as well as to the value, i.e.Â the value is <code>normalize</code>d within the transformed space. The <code>unnormalize</code> function reverses this process, and also has to apply the inverse function. In mathematical notation:</p>
<p><span class="math display">\[\begin{align}
p = n(x) &amp;= [f(x - \text{offset}) - f(\min)] / [f(\max) - f(\min)] \\
x = u(p) &amp;= f^{-1} \big[ f(\min) + x \cdot (f(\max) - f(\min)) \big] + \text{offset}
\end{align}\]</span></p>
<p>One can easily check that <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> are inverses of each other by taking one equation and solving for <span class="math inline">\(x\)</span> or <span class="math inline">\(p\)</span>, respectively (assuming that <span class="math inline">\(f^{-1}\)</span> exists).</p>
<p>Back to code. The <code>ExpanseContinuous.normalize</code> and <code>ExpanseContinuous.unnormalize</code> work as expected:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb115-1"><a href="system.html#cb115-1" tabindex="-1"></a><span class="im">import</span> { ExpanseContinuous } <span class="im">from</span> <span class="st">&quot;./ExpanseContinuous&quot;</span></span>
<span id="cb115-2"><a href="system.html#cb115-2" tabindex="-1"></a></span>
<span id="cb115-3"><a href="system.html#cb115-3" tabindex="-1"></a><span class="kw">const</span> identity <span class="op">=</span> (x) <span class="kw">=&gt;</span> x<span class="op">;</span></span>
<span id="cb115-4"><a href="system.html#cb115-4" tabindex="-1"></a><span class="kw">const</span> expanse <span class="op">=</span> { </span>
<span id="cb115-5"><a href="system.html#cb115-5" tabindex="-1"></a>  min<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> max<span class="op">:</span> <span class="dv">16</span><span class="op">,</span> offset<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb115-6"><a href="system.html#cb115-6" tabindex="-1"></a>  trans<span class="op">:</span> identity<span class="op">,</span> inv<span class="op">:</span> identity </span>
<span id="cb115-7"><a href="system.html#cb115-7" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb115-8"><a href="system.html#cb115-8" tabindex="-1"></a></span>
<span id="cb115-9"><a href="system.html#cb115-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(ExpanseContinuous<span class="op">.</span><span class="fu">normalize</span>(expanse<span class="op">,</span> <span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb115-10"><a href="system.html#cb115-10" tabindex="-1"></a><span class="co">// Technically, we should now also set inverse to square</span></span>
<span id="cb115-11"><a href="system.html#cb115-11" tabindex="-1"></a>expanse<span class="op">.</span><span class="at">trans</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span><span class="op">;</span> </span>
<span id="cb115-12"><a href="system.html#cb115-12" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(ExpanseContinuous<span class="op">.</span><span class="fu">normalize</span>(expanse<span class="op">,</span> <span class="dv">4</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>0.25
0.5</code></pre>
<p>Finally, the <code>ExpanseContinuous</code> namespace also exports a <code>train</code> and <code>breaks</code> functions. The train functions simply finds a minimum and maximum value of an array of numbers and sets these as the new <code>min</code> and <code>max</code> (or just sets the <code>max</code>, if <code>ratio</code> is <code>true</code>). Breaks returns a list of âniceâ axis breaks which are by computed via an algorithm inspired by base Râs <code>pretty</code> function <span class="citation">(<a href="#ref-r2024">R Core Team 2024</a>)</span>.</p>
</div>
<div id="point-expanses" class="section level4 hasAnchor" number="7.4.4.10">
<h4><span class="header-section-number">7.4.4.10</span> Point expanses<a href="system.html#point-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><code>ExpansePoint</code> is the simpler of two types of discrete expanses, implementing an interface of <code>Expanse&lt;string&gt;</code>. It maps string values to equidistant positions within the <span class="math inline">\([0,1]\)</span> interval, based on an ordered array of labels. Here is a simplified interface for its data container:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb117-1"><a href="system.html#cb117-1" tabindex="-1"></a><span class="kw">interface</span> ExpansePoint {</span>
<span id="cb117-2"><a href="system.html#cb117-2" tabindex="-1"></a>    labels<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb117-3"><a href="system.html#cb117-3" tabindex="-1"></a>    order<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb117-4"><a href="system.html#cb117-4" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>labels</code> array stores the unique string values present in the data, sorted alphabetically. The <code>order</code> array is a simple array of indices of equal length as <code>labels</code> representing the order in which the labels get assigned to points in the <span class="math inline">\([0, 1]\)</span> interval. By default, it is simply the increasing sequence <code>0 ... labels.length - 1</code>.</p>
<p>The <code>normalize</code> and <code>unnormalize</code> functions the <code>ExpansePoint</code> namespace exports simply map labels to equidistant point in the <code>[0, 1]</code> interval or vice versa, while respecting the <code>order</code>:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb118-1"><a href="system.html#cb118-1" tabindex="-1"></a><span class="co">// ExpansePoint.ts</span></span>
<span id="cb118-2"><a href="system.html#cb118-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpansePoint</span> {</span>
<span id="cb118-3"><a href="system.html#cb118-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpansePoint<span class="op">,</span> x<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb118-4"><a href="system.html#cb118-4" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb118-5"><a href="system.html#cb118-5" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> order[labels<span class="op">.</span><span class="fu">indexOf</span>(x)]<span class="op">;</span></span>
<span id="cb118-6"><a href="system.html#cb118-6" tabindex="-1"></a>    <span class="cf">if</span> (index <span class="op">===</span> <span class="op">-</span><span class="dv">1</span>) <span class="cf">return</span> index<span class="op">;</span></span>
<span id="cb118-7"><a href="system.html#cb118-7" tabindex="-1"></a>    <span class="cf">return</span> index <span class="op">/</span> (labels<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb118-8"><a href="system.html#cb118-8" tabindex="-1"></a>  }</span>
<span id="cb118-9"><a href="system.html#cb118-9" tabindex="-1"></a></span>
<span id="cb118-10"><a href="system.html#cb118-10" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpansePoint<span class="op">,</span> x<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb118-11"><a href="system.html#cb118-11" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb118-12"><a href="system.html#cb118-12" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(x <span class="op">*</span> (labels<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb118-13"><a href="system.html#cb118-13" tabindex="-1"></a>    <span class="cf">return</span> labels[order[index]]<span class="op">;</span></span>
<span id="cb118-14"><a href="system.html#cb118-14" tabindex="-1"></a>  }</span>
<span id="cb118-15"><a href="system.html#cb118-15" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>normalize</code> function maps a label to <code>[0, 1]</code> based on its position within the <code>labels</code> array (which may be shuffled by <code>order</code>), whereas the <code>unnormalize</code> function finds the closest label corresponding to numeric position by reversing the process. This works largely as we would expect:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb119-1"><a href="system.html#cb119-1" tabindex="-1"></a><span class="im">import</span> { ExpansePoint } <span class="im">from</span> <span class="st">&quot;./ExpansePoint&quot;</span></span>
<span id="cb119-2"><a href="system.html#cb119-2" tabindex="-1"></a></span>
<span id="cb119-3"><a href="system.html#cb119-3" tabindex="-1"></a><span class="kw">const</span> cities <span class="op">=</span> [<span class="st">&quot;Berlin&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]</span>
<span id="cb119-4"><a href="system.html#cb119-4" tabindex="-1"></a><span class="kw">const</span> expanse <span class="op">=</span> { labels<span class="op">:</span> cities<span class="op">,</span> order<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>] }<span class="op">;</span></span>
<span id="cb119-5"><a href="system.html#cb119-5" tabindex="-1"></a></span>
<span id="cb119-6"><a href="system.html#cb119-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cities<span class="op">.</span><span class="fu">map</span>((city) <span class="kw">=&gt;</span> {</span>
<span id="cb119-7"><a href="system.html#cb119-7" tabindex="-1"></a>  <span class="cf">return</span> ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(expanse<span class="op">,</span> city)</span>
<span id="cb119-8"><a href="system.html#cb119-8" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb119-9"><a href="system.html#cb119-9" tabindex="-1"></a></span>
<span id="cb119-10"><a href="system.html#cb119-10" tabindex="-1"></a>expanse<span class="op">.</span><span class="at">order</span>[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Swap the order of the first two values</span></span>
<span id="cb119-11"><a href="system.html#cb119-11" tabindex="-1"></a>expanse<span class="op">.</span><span class="at">order</span>[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb119-12"><a href="system.html#cb119-12" tabindex="-1"></a></span>
<span id="cb119-13"><a href="system.html#cb119-13" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cities<span class="op">.</span><span class="fu">map</span>((city) <span class="kw">=&gt;</span> {</span>
<span id="cb119-14"><a href="system.html#cb119-14" tabindex="-1"></a>  <span class="cf">return</span> ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(expanse<span class="op">,</span> city)</span>
<span id="cb119-15"><a href="system.html#cb119-15" tabindex="-1"></a>}))<span class="op">;</span></span></code></pre></div>
<pre><code>[ 0, 0.5, 1 ]
[ 0.5, 0, 1 ]</code></pre>
<p>However, it is important to note that, due to the fact that there is a finite number of <code>labels</code>, the <code>unnormalize</code> function is <em>not</em> a full, two-sided inverse of <code>normalize</code>, merely a one-sided inverse or retraction <span class="citation">(see e.g. <a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>)</span>. That is, while composing <code>unnormalize</code> with <code>normalize</code> results in the identity function, the converse is not true. For instance:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb121-1"><a href="system.html#cb121-1" tabindex="-1"></a><span class="im">import</span> { ExpansePoint } <span class="im">from</span> <span class="st">&quot;./ExpansePoint&quot;</span></span>
<span id="cb121-2"><a href="system.html#cb121-2" tabindex="-1"></a></span>
<span id="cb121-3"><a href="system.html#cb121-3" tabindex="-1"></a><span class="kw">const</span> cities <span class="op">=</span> [<span class="st">&quot;Berlin&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]</span>
<span id="cb121-4"><a href="system.html#cb121-4" tabindex="-1"></a><span class="kw">const</span> expanse <span class="op">=</span> { labels<span class="op">:</span> cities<span class="op">,</span> order<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>] }<span class="op">;</span></span>
<span id="cb121-5"><a href="system.html#cb121-5" tabindex="-1"></a></span>
<span id="cb121-6"><a href="system.html#cb121-6" tabindex="-1"></a><span class="co">// Unnormalize works as a one-way inverse (retraction)</span></span>
<span id="cb121-7"><a href="system.html#cb121-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(</span>
<span id="cb121-8"><a href="system.html#cb121-8" tabindex="-1"></a>  cities<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> {</span>
<span id="cb121-9"><a href="system.html#cb121-9" tabindex="-1"></a>    <span class="cf">return</span> ExpansePoint<span class="op">.</span><span class="fu">unnormalize</span>(</span>
<span id="cb121-10"><a href="system.html#cb121-10" tabindex="-1"></a>      expanse<span class="op">,</span></span>
<span id="cb121-11"><a href="system.html#cb121-11" tabindex="-1"></a>      ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(expanse<span class="op">,</span> x)</span>
<span id="cb121-12"><a href="system.html#cb121-12" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb121-13"><a href="system.html#cb121-13" tabindex="-1"></a>  })</span>
<span id="cb121-14"><a href="system.html#cb121-14" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb121-15"><a href="system.html#cb121-15" tabindex="-1"></a></span>
<span id="cb121-16"><a href="system.html#cb121-16" tabindex="-1"></a><span class="co">// But not the other way around</span></span>
<span id="cb121-17"><a href="system.html#cb121-17" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(</span>
<span id="cb121-18"><a href="system.html#cb121-18" tabindex="-1"></a>  ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(</span>
<span id="cb121-19"><a href="system.html#cb121-19" tabindex="-1"></a>    expanse<span class="op">,</span> ExpansePoint<span class="op">.</span><span class="fu">unnormalize</span>(expanse<span class="op">,</span> <span class="fl">0.6</span>)</span>
<span id="cb121-20"><a href="system.html#cb121-20" tabindex="-1"></a>  )</span>
<span id="cb121-21"><a href="system.html#cb121-21" tabindex="-1"></a>)<span class="op">;</span></span></code></pre></div>
<pre><code>[ &quot;Berlin&quot;, &quot;Prague&quot;, &quot;Vienna&quot; ]
0.5</code></pre>
<p>Finally, like <code>ExpanseContinuous</code>, the <code>ExpansePoint</code> namespace also contains a <code>train</code> function, which loops through a string array, finds all unique values, and assigns these to labels, as well as a <code>breaks</code> function, which simply returns the array of <code>labels</code> (ordered by <code>order</code>). Further, the namespace also contains a <code>reorder</code> function which modifies the <code>order</code> property based on a new array indices, allowing the labels to be shuffled.</p>
</div>
<div id="band-expanses" class="section level4 hasAnchor" number="7.4.4.11">
<h4><span class="header-section-number">7.4.4.11</span> Band expanses<a href="system.html#band-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>While <code>ExpansePoint</code> places values at equidistant points along <span class="math inline">\([0, 1]\)</span>, <code>ExpanseBand</code> places values at the midpoints of bands of which may be assigned variable widths or âweightsâ. The simplified interface of <code>ExpanseBand</code> is the following:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb123-1"><a href="system.html#cb123-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">interface</span> ExpanseBand {</span>
<span id="cb123-2"><a href="system.html#cb123-2" tabindex="-1"></a>  labels<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb123-3"><a href="system.html#cb123-3" tabindex="-1"></a>  order<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb123-4"><a href="system.html#cb123-4" tabindex="-1"></a>  weights<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb123-5"><a href="system.html#cb123-5" tabindex="-1"></a>  cumulativeWeights<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb123-6"><a href="system.html#cb123-6" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>labels</code> and <code>order</code> properties match those of <code>ExpansePoint</code>. The additional <code>weights</code> and <code>cumulativeWeights</code> are numeric arrays which record the width of each band. <code>weights</code> store the individual band widths, whereas <code>cumulativeWeights</code> stores their cumulative sums. The reason why <code>cumulativeWeights</code> are stored is that, by having the bands have variable widths, we can no longer rely on the label index to correctly identify position. To give an example, with weights <code>1</code>, <code>1</code>, and <code>2</code>, the second band takes up quarter of the available space and the correct normalized value should be 0.375 (halfway between 0.25 and 0.5). However, to compute this value, the cumulative sum of the preceding weights as well as the total sum of all weights are required. While we could compute cumulative sum of weights on each <code>normalize</code> or <code>unnormalize</code> call, this would introduce performance overhead. As such, it is better to store <code>cumulativeWeights</code> and only recompute them each time <code>weights</code> or <code>order</code> changes.</p>
<p>The <code>normalize</code> and <code>unnormalize</code> functions in the <code>ExpanseBand</code> namespace map labels to and from the midpoint of their corresponding bands:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb124-1"><a href="system.html#cb124-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpanseBand</span> {</span>
<span id="cb124-2"><a href="system.html#cb124-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> x<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb124-3"><a href="system.html#cb124-3" tabindex="-1"></a>    <span class="kw">const</span> { labels } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb124-4"><a href="system.html#cb124-4" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> labels<span class="op">.</span><span class="fu">indexOf</span>(x)<span class="op">;</span></span>
<span id="cb124-5"><a href="system.html#cb124-5" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">getMidpoint</span>(expanse<span class="op">,</span> index)<span class="op">;</span></span>
<span id="cb124-6"><a href="system.html#cb124-6" tabindex="-1"></a>  }</span>
<span id="cb124-7"><a href="system.html#cb124-7" tabindex="-1"></a>  </span>
<span id="cb124-8"><a href="system.html#cb124-8" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">getMidpoint</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> index<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb124-9"><a href="system.html#cb124-9" tabindex="-1"></a>    <span class="kw">const</span> { order<span class="op">,</span> cumulativeWeights } <span class="op">=</span> expanse<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb124-10"><a href="system.html#cb124-10" tabindex="-1"></a>    index <span class="op">=</span> order[index]<span class="op">;</span></span>
<span id="cb124-11"><a href="system.html#cb124-11" tabindex="-1"></a></span>
<span id="cb124-12"><a href="system.html#cb124-12" tabindex="-1"></a>    <span class="kw">const</span> lower <span class="op">=</span> cumulativeWeights[index <span class="op">-</span> <span class="dv">1</span>] <span class="op">??</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb124-13"><a href="system.html#cb124-13" tabindex="-1"></a>    <span class="kw">const</span> upper <span class="op">=</span> cumulativeWeights[index]<span class="op">;</span></span>
<span id="cb124-14"><a href="system.html#cb124-14" tabindex="-1"></a>    <span class="kw">const</span> max <span class="op">=</span> <span class="fu">last</span>(cumulativeWeights)<span class="op">;</span></span>
<span id="cb124-15"><a href="system.html#cb124-15" tabindex="-1"></a></span>
<span id="cb124-16"><a href="system.html#cb124-16" tabindex="-1"></a>    <span class="cf">return</span> (lower <span class="op">+</span> upper) <span class="op">/</span> <span class="dv">2</span> <span class="op">/</span> max<span class="op">;</span></span>
<span id="cb124-17"><a href="system.html#cb124-17" tabindex="-1"></a>  }</span>
<span id="cb124-18"><a href="system.html#cb124-18" tabindex="-1"></a></span>
<span id="cb124-19"><a href="system.html#cb124-19" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> x<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb124-20"><a href="system.html#cb124-20" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order<span class="op">,</span> cumulativeWeights } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb124-21"><a href="system.html#cb124-21" tabindex="-1"></a></span>
<span id="cb124-22"><a href="system.html#cb124-22" tabindex="-1"></a>    <span class="kw">const</span> weight <span class="op">=</span> x <span class="op">*</span> <span class="fu">last</span>(cumulativeWeights)<span class="op">;</span></span>
<span id="cb124-23"><a href="system.html#cb124-23" tabindex="-1"></a>    <span class="kw">let</span> index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb124-24"><a href="system.html#cb124-24" tabindex="-1"></a></span>
<span id="cb124-25"><a href="system.html#cb124-25" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;</span> cumulativeWeights<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb124-26"><a href="system.html#cb124-26" tabindex="-1"></a>      <span class="cf">if</span> (cumulativeWeights[index] <span class="op">&gt;=</span> weight) <span class="cf">break</span><span class="op">;</span></span>
<span id="cb124-27"><a href="system.html#cb124-27" tabindex="-1"></a>      index<span class="op">++;</span></span>
<span id="cb124-28"><a href="system.html#cb124-28" tabindex="-1"></a>    }</span>
<span id="cb124-29"><a href="system.html#cb124-29" tabindex="-1"></a></span>
<span id="cb124-30"><a href="system.html#cb124-30" tabindex="-1"></a>    <span class="cf">return</span> labels[order[index]]<span class="op">;</span></span>
<span id="cb124-31"><a href="system.html#cb124-31" tabindex="-1"></a>  }</span>
<span id="cb124-32"><a href="system.html#cb124-32" tabindex="-1"></a></span>
<span id="cb124-33"><a href="system.html#cb124-33" tabindex="-1"></a>}</span></code></pre></div>
<p>Compared to <code>ExpansePoint</code>, the logic of <code>normalize</code> and <code>unnormalize</code> is a bit more complicated. To <code>normalize</code> a label, we need to first find the index of the label and then return the corresponding midpoint of the band, taking <code>weights</code> and <code>order</code> into account. To <code>unnormalize</code>, we actually have to loop through the array of <code>cumulativeWeights</code> to find the first weight that is smaller than the position: as far as I know, there is no way to determine which bin a normalized value belongs to in <span class="math inline">\(O(1)\)</span> time<a href="#fn39" class="footnote-ref" id="fnref39"><sup>39</sup></a>.</p>
<div id="compound-and-split-expanses" class="section level5 hasAnchor" number="7.4.4.11.1">
<h5><span class="header-section-number">7.4.4.11.1</span> Compound and split expanses<a href="system.html#compound-and-split-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The final two <code>Expanse</code> subtypes, <code>ExpanseCompound</code> and <code>ExpanseSplit</code>, represent a significant departure from the scalar-valued <code>Expanse</code> subtypes discussed earlier. Unlike the others, these subtypes are designed to handle array-valued data. While their implementation logic is relatively straightforward, a detailed discussion would significantly complicate the general explanation of <code>Expanse</code> type and behavior. Additionally, their current use-case in <code>plotscape</code> is fairly limited (albeit important) - they are used for parallel coordinate plots only. Therefore, I will only provide a brief, conceptual explanation. Interested readers are encouraged to explore the <code>plotscape</code> codebase for a deeper understanding.</p>
<p><code>ExpanseCompound</code> is designed to handle heterogeneous arrays (tuples) of values by applying <code>normalize</code> and <code>unnormalize</code> functions in parallel, using an internal array of <code>Expanse</code>s. That is, to construct <code>ExpanseCompound</code>, we need to provide an array of <code>Expanse</code>s, and when calling <code>normalize</code>, we need to make sure that we call it with an array of values which match the underlying <code>Expanse</code> types. <code>ExpanseSplit</code> instead uses a single <code>Expanse</code> to <code>normalize</code>/<code>unnormalize</code> a homogeneous array of values. Finally, when either <code>ExpanseCompound</code> or <code>ExpanseSplit</code> is used as <code>domain</code> and <code>codomain</code> of a <code>Scale</code>, the arrity of the other <code>Expanse</code> must match.</p>
<p>As was briefly mentioned above, <code>ExpanseCompound</code> and <code>ExpanseSplit</code> are used in parallel coordinate plots. Specifically, <code>ExpanseCompound</code> is used as the <code>domain</code> of the y-axis scale, such that values of several different variables can be normalized in parallel. Further, because of the genericity <code>Expanse</code> interface, it is easy to mix continuous and discrete expanse subtypes. Additionally, when all expanses constituting the <code>ExpanseCompound</code> are continuous, it is also possible to set them to the same limits (by finding the minimum and maximum values across all <code>Expanse</code> objects). Finally,<code>ExpanseSplit</code> is used as the <code>codomain</code>, mapping the array of normalized values produced by the <code>domain</code> to the plotâs y-axis coordinates.</p>
</div>
</div>
<div id="plot" class="section level4 hasAnchor" number="7.4.4.12">
<h4><span class="header-section-number">7.4.4.12</span> Plot<a href="system.html#plot" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Another key component of <code>plotscape</code> is, of course, the <code>Plot</code>. <code>Plot</code>s are responsible for rendering data and handling user-initiated interactive events. Thus, using the lense of the model-view-controller architecture <span class="citation">(MVC, see e.g. <a href="#ref-xie2014">Xie, Hofmann, and Cheng 2014</a>)</span>, <code>Plot</code> serves as a fundamental view-controller component, alongside <code>Scene</code> (see Section <a href="system.html#scene">7.4.4.15</a>)<a href="#fn40" class="footnote-ref" id="fnref40"><sup>40</sup></a>. While <code>Plot</code> logic is fairly substantial (over 700 SLOC, at the time of writing), much of it consists of somewhat arbitrary implementation details, which are likely not as interesting as those of the previously discussed parts of the system. For this reason, I decided to keep the discussion of <code>Plot</code> fairly brief and conceptual. Interested readers are encouraged to explore <code>Plot</code>âs definition in the <code>plotscape</code> codebase.</p>
<p>As a final general note, <code>Plot</code> is also a component where an object-oriented programming (OOP) approach might be useful. Unlike with <code>Expanse</code>, this is not primarily due to polymorphism (though some subcomponents of <code>Plot</code> could benefit from polymorphism, as we will discuss later), but because <code>Plot</code> is tightly coupled to the user interface (UI). Representing <code>Plot</code> as a class instance that encapsulates state rather than plain data container decoupled from functionality might represent a more ergonomic design decision within the context of the UI. For consistency reasons, I have maintained the decoupled data-oriented approach here, but I may reconsider this in future versions of the package.</p>
<div id="plot-data" class="section level5 hasAnchor" number="7.4.4.12.1">
<h5><span class="header-section-number">7.4.4.12.1</span> Data<a href="system.html#plot-data" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The primary responsibility of each <code>Plot</code> is to render data. As discussed in Section <a href="system.html#aggregation-summaries">7.4.4.6</a>, before being assigned to the <code>Plot</code>, this data is pre-aggregated and mapped to aesthetic coordinates. Thus, <code>Plot</code> is only responsible for actions involving the data, such as rendering and selection, but not the data itself.</p>
<p>Importantly, data is not a single <code>Dataframe</code>, but instead an array of <code>Dataframes</code>, each representing a different level of partitioning. This allows <code>Plot</code> to leverage varying data granularities for tasks like selection and rendering. For instance, when rendering, we typically want to use the finest data partition (e.g.Â bar segments, partitioned by selection status). On the other hand, linked selection can be implemented more efficiently by relying on the coarser data set representing whole objects (e.g.Â bars), reducing the number of objects that need to be iterated through.</p>
</div>
<div id="plot-scales" class="section level5 hasAnchor" number="7.4.4.12.2">
<h5><span class="header-section-number">7.4.4.12.2</span> Scales<a href="system.html#plot-scales" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>To actually render data, data values need to be mapped to <code>Plot</code> coordinates via scales. The <code>Scale</code> type and functionality has already been introduced in Section <a href="system.html#scales">7.4.4.7</a>: here, <code>scales</code> are just a dictionary with aesthetic mappings as keys and <code>Scale</code>s as values.</p>
<p>Currently, each <code>Plot</code> in <code>plotscape</code> uses the following list of aesthetic mappings and corresponding <code>Scale</code>s:</p>
<ul>
<li>x</li>
<li>y</li>
<li>size</li>
<li>width</li>
<li>height</li>
<li>area</li>
<li>area percentage (<code>areaPct</code>)</li>
</ul>
<p>Most of these are fairly self-explanatory. The <em>x</em> and <em>y</em> scales map data to the plotâs x and y coordinates, respectively. Their <code>codomain</code> maxima correspond to the plotâs width and height (ignoring margins). The <em>size</em> scale maps values to sizes of glyphs such as scatterplot points. By default, it is a ratio scale (minimum is fixed at zero, for both <code>domain</code> and <code>codomain</code>), with a square-root transformation and a fixed maximum<a href="#fn41" class="footnote-ref" id="fnref41"><sup>41</sup></a>. The <em>width</em> and <em>height</em> scales are derived from the plotâs dimensions, similar to x and y scales, however, their minima are fixed at zero and both margins are instead subtracted from the maxima. They are used, for instance, to scale the width and height of barplot bars, semi-independently of position<a href="#fn42" class="footnote-ref" id="fnref42"><sup>42</sup></a>. The <code>area</code> scale is based on the minimum of <code>width</code> and <code>height</code> and also has a square-root transformation applied to it. Finally, the <code>areaPct</code> scale is a scale used for scaling the area of fixed-coordinate objects (e.g.Â for growing/shrinking rectangles in a 2D histogram).</p>
<p>Most scales (excluding <code>size</code> and <code>areaPct</code>) are automatically adjusted when the plot is resized. They may be also modified by user events such as zooming, panning, or shrinking/growing the size of objects (these typically affect the <code>zero</code> and <code>one</code> parameters of the scale - see Section <a href="system.html#scales">7.4.4.7</a>). All scales are also provided with default values upon initialization, and these are reverted to when reset event is triggered.</p>
<p>Finally, it is important to note that in many plot types, scales are trained on data computed at a coarser partition level (representing whole objects), rather than the finest partition level (representing object segments). For instance, in histograms, scales for the x- and y-axes are trained on data corresponding to whole bins, not the product of bins and <code>Marker</code> status. This approach is more efficient, as scale and axis updates are only required when, for instance, bin widths change, rather than each time selection occurs. As discussed in Section <a href="problems.html#aggregation-category-theory">5.2.2</a>, this requires making certain algebraic assumptions, namely that the computed summaries are monoidal and monotonic. While this is currently a hard-coded requirement, in the future, a potential direction could be to provide a fallback mechanism such that the scale updates would be based on the finest partition when the summaries are not monoidal monotones.</p>
</div>
<div id="plot-rendering" class="section level5 hasAnchor" number="7.4.4.12.3">
<h5><span class="header-section-number">7.4.4.12.3</span> Rendering<a href="system.html#plot-rendering" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Intuitively, every <code>Plot</code> needs a dedicated space to render the data and auxiliary graphical elements such as axis labels and titles. This requires the ability to render basic geometric objects, such as points, lines, rectangles, and text. Furthermore, as discussed in Section <a href="problems.html#frames">5.4.1</a>, rendering can be simplified and optimized by organizing objects into vertical layers (z-indices). Therefore, our <code>Plot</code> implementation should support this layering capability.</p>
<p>Currently, <code>Plot</code> utilizes a dictionary of <code>Frame</code> subcomponents for rendering. A <code>Frame</code> is essentially a wrapper around the HTML <code>canvas</code> element, providing additional utility functions related resizing, clipping, and rendering of graphical primitives. During data rendering, the appropriate <code>Frame</code> is selected based on a provided layer value, and the data is rendered accordingly. Finally, each <code>Frame</code> can also have associated attributes, such as color (for selection groups), margins, or opacity.</p>
<p>While the current <code>canvas</code>-based rendering approach has served well during <code>plotscape</code>âs development, it lacks genericity. Specifically, in the future, it could be interesting to explore alternative rendering strategies, such as GPU-based rendering using WebGL <span class="citation">(<a href="#ref-webgl2025">MDN 2025b</a>)</span>. Unfortunately, the current hard-wired nature of the rendering approach does not make this easy. Therefore, to allow users to define custom rendering backends, a useful approach could be to refactor the <code>Plot</code> class to use a generic <code>Renderer</code> interface supporting runtime polymorphism (OOP-based or otherwise). This could prove highly beneficial, since, based on profiling, rendering is the main computational bottleneck of the system (and thus GPU-based rendering could potentially lead to great improvements in performance).</p>
</div>
</div>
<div id="events-and-interactive-features" class="section level4 hasAnchor" number="7.4.4.13">
<h4><span class="header-section-number">7.4.4.13</span> Events and interactive features<a href="system.html#events-and-interactive-features" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>This sections details interactive events dispatched directly on <code>Plot</code>, and the interactive features associated with them.</p>
<div id="activation-and-deactivation" class="section level5 hasAnchor" number="7.4.4.13.1">
<h5><span class="header-section-number">7.4.4.13.1</span> Activation and deactivation<a href="system.html#activation-and-deactivation" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The simplest events on a <code>Plot</code> are activation and deactivation. A <code>Plot</code> is activated by a click, with other plots being automatically deactivated (as discussed in Section <a href="system.html#scene">7.4.4.15</a>). When active, a <code>Plot</code> actively listens to and dispatches plot-specific events, such as events related to mouse movement and specific keyboard key presses. Conversely, a deactivated <code>Plot</code> ignores these plot-specific events but may still responds to other events like calls to re-render or resize, as well as global events tied to mouse-clicks or keyboard presses (e.g.Â the reset event).</p>
</div>
<div id="growingshrinking-objects" class="section level5 hasAnchor" number="7.4.4.13.2">
<h5><span class="header-section-number">7.4.4.13.2</span> Growing/shrinking objects<a href="system.html#growingshrinking-objects" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>When a plot is active, it may receive grow and shrink events that trigger adjustments to the <code>width</code>, <code>height</code>, <code>size</code>, <code>area</code>, and <code>areaPct</code> scales. The response to these events may be adjusted in specific plot types. The response to these events is customizable for specific plot types. For example, in a histogram, grow/shrink events should modify the size of rectangles by adjusting histogram bins, rather than directly altering the scales. Therefore, we override the default event handlers to achieve this specialized behavior.</p>
</div>
<div id="plot-mousemove" class="section level5 hasAnchor" number="7.4.4.13.3">
<h5><span class="header-section-number">7.4.4.13.3</span> Mouse-move interaction: selection, panning, and zooming<a href="system.html#plot-mousemove" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Each <code>Plot</code> supports three mouse-move interaction modes: select, pan, or query. While a plot is active, mouse-move events are dispatched appropriately based on the active mode. Briefly, select mode is the default, and selection is initiated with a left-click. Panning mode is activated by clicking and holding down the right mouse button. Querying is triggered by pressing a designated keyboard key (<code>Q</code>) and hovering over objects.</p>
<div id="selection" class="section level7" number="7.4.4.13.3.0.1">
<p class="heading"><span class="header-section-number">7.4.4.13.3.0.1</span> Selection</p>
<p>The primary interactive feature in <code>plotscape</code> is linked selection. As discussed in Section <a href="goals.html#goals">6</a>, one of the primary goals of <code>plotscape</code> was to implement generic linked selection, such that any plot can simultaneously dispatch and display selection events. This requires that all rendered data objects can be selected.</p>
<p>To perform selection, we have to iterate through a list of coordinates of geometric objects and identify the corresponding cases. As discussed in Section <a href="system.html#plot-data">7.4.4.12.1</a>, for aggregate plots, this process can be optimized by iterating over <em>whole</em> objects rather than their <em>parts</em>. For instance, when selecting bars in a stacked barplot, we can iterate through the coordinates of the entire bars, rather than the (more numerous) coordinates of individual bar segments, which are used for rendering. During the iteration loop, whenever we determine that an object is inside the selection (or overlaps it) using dedicated collision-detection functions, we add its corresponding cases to a list (the cases are stored as part of <code>Factor</code> data). Finally, an update event to the <code>Marker</code> with the list of cases as data.</p>
<p>Currently, <code>plotscape</code> loops through all of the rendered objects each time selection happens. This process could be made more efficient by employing dedicated data structures such as quadtrees to quickly isolate objects with non-zero chance of being in the selection region. However, as mentioned in Section <a href="system.html#plot-rendering">7.4.4.12.3</a>, the main computational bottleneck seems to be rendering, and, as such, currently, optimizing selection may yield only marginal benefits.</p>
</div>
<div id="panning-1" class="section level7" number="7.4.4.13.3.0.2">
<p class="heading"><span class="header-section-number">7.4.4.13.3.0.2</span> Panning</p>
<p>As briefly mentioned in section <a href="system.html#plot-scales">7.4.4.12.2</a>, plot scales can be manipulated by panning. Specifically, when a user right-clicks and drags, the panning mode is engaged, resulting in the update of the x and y-axis scales. These scale updates are performed using the logic described in Section <a href="system.html#scales">7.4.4.7</a>, and the rest of the implementation is fairly straightforward.</p>
</div>
<div id="querying-1" class="section level7" number="7.4.4.13.3.0.3">
<p class="heading"><span class="header-section-number">7.4.4.13.3.0.3</span> Querying</p>
<p>Querying is the last of the three interactive mouse-move modes. It is activated via the <code>Q</code> keyboard key (by default). When a users presses and holds the <code>Q</code> key and mouses over a geometric object in the plot, a pop-up table will show up, displaying the underlying summary statistics related to the object.</p>
<p>Similar to selection, object querying involves iterating through the list of objects to identify the one corresponding to the mouse coordinates. However, unlike selection, which must examine all candidates, querying can terminate early upon finding the first match. While overplotting (e.g., in scatterplots) could technically result in multiple matches, this poses no issue for default query statistics, as these are based on aesthetics and will be identical for all overplotted objects. The issue becomes more complicated with custom querying statistics, a feature which <code>plotscape</code> supports, as these, unlike aesthetics, may not be identical across overplotted objects. Since custom query statistics are a fairly advanced feature that may be used by only a fraction of the users, I did not spend time implementing a reconciliation mechanism which would address this, however, this could be improved in future versions of the package.</p>
<p>As a final note, the query results table is implemented as a separate HTML <code>table</code> element, rather than being rendered in a plot <code>Frame</code> (<code>canvas</code> element) directly. This allows us to leverage HTML and CSS for styling and formatting, simplifying implementation. Additionally, it also means that querying does not cause the data layers to re-render, improving performance.</p>
</div>
</div>
</div>
<div id="zooming-1" class="section level4 hasAnchor" number="7.4.4.14">
<h4><span class="header-section-number">7.4.4.14</span> Zooming<a href="system.html#zooming-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Another useful interactive feature is zooming. Again, this feature is implemented through functionality discussed in Section <a href="system.html#scales">7.4.4.7</a>, and can be triggered via the zoom action (the <code>Z</code> key, by default).</p>
<p>Importantly, zooming in <code>plotscape</code> is intentionally integrated with selection. Specifically, after a user transiently selects objects in a (rectangular) region, they can initiate the zoom action to zoom into that region. This design is meant to take advantage of the conceptual link between selection and zooming: a selected region inherently signifies a region of interest, making it a logical zoom target. Furthermore, by zooming into a visible, highlighted region, the user can more easily maintain awareness of the change in plot coordinates. One drawback of this approach is that, compared to symmetric zoom methods like zooming onto a point, zooming into non-square selection regions necessarily distorts the plot aspect ratio. However, while this change in aspect ratios can be potentially disorienting when the difference is large, it can also be considered a useful feature when a different aspect ratio is actually desired. To provide users with greater flexibility, future versions of the package could implement symmetrical zooming as a compatible alternative to selection-region-based zooming.</p>
<p>Additionally, every <code>Plot</code> can be zoomed into multiple levels deep. This nested zooming is implemented by maintaining a stack of zoom coordinates. At any point, the user may pop one level of zoom, reverting to the previous zoom level. Alternatively, they can trigger the plot reset event (<code>R</code> key by default), reverting back to the default zoom level.</p>
</div>
<div id="scene" class="section level4 hasAnchor" number="7.4.4.15">
<h4><span class="header-section-number">7.4.4.15</span> Scene<a href="system.html#scene" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As discussed in Section <a href="system.html#api-design">7.2.1</a>, a key part of an interactive system design is the ability to create and manage figures composed of multiple (connected) interactive plots. In <code>plotscape</code>, this responsibility is handled by the <code>Scene</code> component. Thus, like <code>Plot</code>, <code>Scene</code> is a view-controller type component but more high-level (see Section <a href="system.html#plot">7.4.4.12</a>). Again, as with the <code>Plot</code> component, the design involves a number of implementation details which will only be glossed over in this section; an interested reader is refered to the <code>plotscape</code> codebase. Finally, similar to <code>Plot</code>, due to its direct link to UI, <code>Scene</code> is another component that may make sense to be implemented as an OOP class.</p>
<div id="plots" class="section level5 hasAnchor" number="7.4.4.15.1">
<h5><span class="header-section-number">7.4.4.15.1</span> Plots<a href="system.html#plots" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>The primary responsibility of <code>Scene</code> is to serve as a container for <code>Plot</code>, storing them in a dynamic array for efficient iteration and a dictionary of arrays for quick lookups (as JavaScript objects, both are stored as references). Currently, the dictionary is organized by plot type, such that, e.g., all histograms are stored under the <code>histo</code> key of the dictionary. New plots added to <code>Scene</code> are appended to both the array and the dictionary, and automatically subscribed to <code>Scene</code> events.</p>
<p>On the DOM side, the <code>Scene</code> has a <code>container</code> property into which the HTML elements of individual plots are placed. This container is a simple <code>div</code> element which uses the CSS <code>grid</code> layout by default. When new plots are added, the dimensions of the layout are automatically adjusted to preserve a roughly square shape, using the following formulas to calculate the number of rows and columns:</p>
<ul>
<li><span class="math inline">\(\text{number of columns} = \lceil \sqrt{ \text{number of plots}}  \rceil\)</span></li>
<li><span class="math inline">\(\text{number of rows} = \lceil (\text{number of plots}) / (\text{number of columns}) \rceil\)</span></li>
</ul>
<p>This results in a column-first oriented layout, with columns expanding before rows when the plot count exceeds the number of available grid cells. The users may also set the layout manually (such as via the <code>set_layout</code> <code>plotscaper</code> function).</p>
</div>
<div id="marker-1" class="section level5 hasAnchor" number="7.4.4.15.2">
<h5><span class="header-section-number">7.4.4.15.2</span> Marker<a href="system.html#marker-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>As mentioned before in Section <a href="system.html#marker">7.4.4.5</a>, the <code>Marker</code> is shared between plots and as such is stored as a property on the <code>Scene</code> object. The <code>Scene</code> manages the dispatching of <code>Marker</code>-related events and their propagation to plots.</p>
</div>
<div id="websockets-client" class="section level5 hasAnchor" number="7.4.4.15.3">
<h5><span class="header-section-number">7.4.4.15.3</span> WebSockets client<a href="system.html#websockets-client" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>To facilitate two-way communication with an external server, the <code>Scene</code> also contains a WebSockets client object <span class="citation">(<a href="#ref-mdn2024g">MDN 2025a</a>)</span>. This client is initialized and connects to the server using a provided URL upon <code>Scene</code> initialization. The <code>Scene</code> subscribes to this client and manages all incoming and outgoing messages via dedicated handler functions. All messages are JSON-encoded and contain metadata such as the sender, target, event type, and additional data.</p>
</div>
<div id="events-and-keybindings" class="section level5 hasAnchor" number="7.4.4.15.4">
<h5><span class="header-section-number">7.4.4.15.4</span> Events and Keybindings<a href="system.html#events-and-keybindings" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><code>Scene</code> additionally handles listening to and forwarding of events from multiple sources. These include events from the plots, the <code>Marker</code>, the WebSockets client, and global user inputs (particularly keyboard events). The <code>Scene</code> is responsible for propagating and synchronizing these events across its members.</p>
<p>The list of events managed by the <code>Scene</code> includes the following, categorized for clarity:</p>
<ul>
<li><strong>Layout management</strong>: set dimensions, set layout, clear layout, resize (scene and all plots)</li>
<li><strong>Selection</strong>: clear all selection, clear transient selection, set transient indices, assign permanent indices, query transient indices, query permanent indices (both return an array)</li>
<li><strong>Plot management</strong>: add/remove a plot, pop the array of plots (remove the last added plot), activate/deactivate a specific plot, deactivate all plots, reset all plots to default values, zoom into a specific region of a plot, normalize a plot (e.g.Â barplot to spineplot), query a plotâs scale (returns a JSON)</li>
</ul>
<p>Further, some of these events are tied to <code>KeyboardEvent</code>s on the <code>window</code> object. While default keybindings are provided, users can interactively reassign them using a keybindings widget located in the top-right corner of the <code>Scene</code> container.</p>

</div>
</div>
</div>
</div>
</div>
<h3> References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-abadi2013" class="csl-entry">
Abadi, Daniel, Peter Boncz, Stavros Harizopoulos, Stratos Idreos, Samuel Madden, et al. 2013. <span>âThe Design and Implementation of Modern Column-Oriented Database Systems.â</span> <em>Foundations and Trends<span></span> in Databases</em> 5 (3): 197â280.
</div>
<div id="ref-abelson2022" class="csl-entry">
Abelson, Harold, and Gerald Jay Sussman. 2022. <em>Structure and Interpretation of Computer Programs: JavaScript Edition</em>. MIT Press.
</div>
<div id="ref-acton2014" class="csl-entry">
Acton, Mike. 2014. <span>âData-Oriented Design and c++.â</span> <em>Luento. CppCon</em>. <a href="https://www.youtube.com/watch?v=rX0ItVEVjHc">https://www.youtube.com/watch?v=rX0ItVEVjHc</a>.
</div>
<div id="ref-allaire2024" class="csl-entry">
Allaire, JJ, and Christophe Dervieux. 2024. <em>Quarto: R Interface to âQuartoâ Markdown Publishing System</em>. <a href="https://CRAN.R-project.org/package=quarto">https://CRAN.R-project.org/package=quarto</a>.
</div>
<div id="ref-rmarkdown2024" class="csl-entry">
Allaire, JJ, Yihui Xie, Christophe Dervieux, Jonathan McPherson, Javier Luraschi, Kevin Ushey, Aron Atkins, et al. 2024. <em>Rmarkdown: Dynamic Documents for r</em>. <a href="https://github.com/rstudio/rmarkdown">https://github.com/rstudio/rmarkdown</a>.
</div>
<div id="ref-auguie2017" class="csl-entry">
Auguie, Baptiste. 2017. <em>gridExtra: Miscellaneous Functions for "Grid" Graphics</em>. <a href="https://CRAN.R-project.org/package=gridExtra">https://CRAN.R-project.org/package=gridExtra</a>.
</div>
<div id="ref-bache2022" class="csl-entry">
Bache, Stefan Milton, and Hadley Wickham. 2022. <em>Magrittr: A Forward-Pipe Operator for r</em>. <a href="https://CRAN.R-project.org/package=magrittr">https://CRAN.R-project.org/package=magrittr</a>.
</div>
<div id="ref-bayliss2022" class="csl-entry">
Bayliss, Jessica D. 2022. <span>âThe Data-Oriented Design Process for Game Development.â</span> <em>Computer</em> 55 (5): 31â38.
</div>
<div id="ref-black2013" class="csl-entry">
Black, Andrew P. 2013. <span>âObject-Oriented Programming: Some History, and Challenges for the Next Fifty Years.â</span> <em>Information and Computation</em> 231: 3â20.
</div>
<div id="ref-booch2008" class="csl-entry">
Booch, Grady, Robert A Maksimchuk, Michael W Engle, Bobbi J Young, Jim Connallen, and Kelli A Houston. 2008. <span>âObject-Oriented Analysis and Design with Applications.â</span> <em>ACM SIGSOFT Software Engineering Notes</em> 33 (5): 29â29.
</div>
<div id="ref-bostock2022" class="csl-entry">
Bostock, Mike. 2022. <span>âD3.js - Data-Driven Documents.â</span> <a href="https://d3js.org">https://d3js.org</a>.
</div>
<div id="ref-bouchet-valat2023" class="csl-entry">
Bouchet-Valat, Milan, and BogumiÅ KamiÅski. 2023. <span>âDataFrames.jl: Flexible and Fast Tabular Data in Julia.â</span> <em>Journal of Statistical Software</em> 107 (September): 1â32. <a href="https://doi.org/10.18637/jss.v107.i04">https://doi.org/10.18637/jss.v107.i04</a>.
</div>
<div id="ref-bruni2017" class="csl-entry">
Bruni, Camilo. 2017. <span>âFast Properties in V8.â</span> <a href="https://v8.dev/blog/fast-properties">https://v8.dev/blog/fast-properties</a>.
</div>
<div id="ref-bun2025" class="csl-entry">
<span>â<span>Bun</span>.â</span> 2025. <em>Bun</em>. <a href="https://bun.sh">https://bun.sh</a>.
</div>
<div id="ref-chambers2014" class="csl-entry">
Chambers, John M. 2014. <span>âObject-Oriented Programming, Functional Programming and r.â</span> <em>Statistical Science</em> 29 (2): 167â80. <a href="https://doi.org/10.1214/13-STS452">https://doi.org/10.1214/13-STS452</a>.
</div>
<div id="ref-shiny2024" class="csl-entry">
Chang, Winston, Joe Cheng, JJ Allaire, Carson Sievert, Barret Schloerke, Yihui Xie, Jeff Allen, Jonathan McPherson, Alan Dipert, and Barbara Borges. 2024. <em>Shiny: Web Application Framework for r</em>. <a href="https://CRAN.R-project.org/package=shiny">https://CRAN.R-project.org/package=shiny</a>.
</div>
<div id="ref-cheng2024" class="csl-entry">
Cheng, Joe, Winston Chang, Steve Reid, James Brown, Bob Trower, and Alexander Peslyak. 2024. <em>Httpuv: HTTP and WebSocket Server Library</em>. <a href="https://CRAN.R-project.org/package=httpuv">https://CRAN.R-project.org/package=httpuv</a>.
</div>
<div id="ref-church1936" class="csl-entry">
Church, Alonzo. 1936. <span>âAn Unsolvable Problem of Elementary Number Theory.â</span> <em>American Journal of Mathematics</em> 58 (2): 345â63.
</div>
<div id="ref-church1940" class="csl-entry">
âââ. 1940. <span>âA Formulation of the Simple Theory of Types.â</span> <em>The Journal of Symbolic Logic</em> 5 (2): 56â68.
</div>
<div id="ref-codd1970" class="csl-entry">
Codd, Edgar F. 1970. <span>âA Relational Model of Data for Large Shared Data Banks.â</span> <em>Communications of the ACM</em> 13 (6): 377â87.
</div>
<div id="ref-cormen2022" class="csl-entry">
Cormen, Thomas H, Charles E Leiserson, Ronald L Rivest, and Clifford Stein. 2022. <em>Introduction to Algorithms</em>. MIT press.
</div>
<div id="ref-eigenmann1998" class="csl-entry">
Eigenmann, Rudolf, and David J Lilja. 1998. <span>âVon Neumann Computers.â</span> <em>Wiley Encyclopedia of Electrical and Electronics Engineering</em> 23: 387â400.
</div>
<div id="ref-vue2024" class="csl-entry">
Evan You and the Vue Core Team. 2024. <span>âVue.js.â</span> <a href="https://vuejs.org">https://vuejs.org</a>.
</div>
<div id="ref-fabian2018" class="csl-entry">
Fabian, Richard. 2018. <span>âData-Oriented Design.â</span> <em>Framework</em> 21: 1â7.
</div>
<div id="ref-fogus2013" class="csl-entry">
Fogus, Michael. 2013. <em>Functional JavaScript: Introducing Functional Programming with Underscore. Js</em>. " OâReilly Media, Inc.".
</div>
<div id="ref-frame2014" class="csl-entry">
Frame, Scott, and John W Coffey. 2014. <span>âA Comparison of Functional and Imperative Programming Techniques for Mathematical Software Development.â</span> <em>Journal of Systemics, Cybernetics and Informatics</em> 12 (2): 1â10.
</div>
<div id="ref-gamma1995" class="csl-entry">
Gamma, Erich, Ralph Johnson, Richard Helm, Ralph E Johnson, and John Vlissides. 1995. <em>Design Patterns: Elements of Reusable Object-Oriented Software</em>. Pearson Deutschland GmbH.
</div>
<div id="ref-angular2025" class="csl-entry">
Google. 2025. <span>âAngular.â</span> <a href="https://angular.dev/guide/signals">https://angular.dev/guide/signals</a>.
</div>
<div id="ref-handmadehero2025" class="csl-entry">
Handmade Hero. 2025. <span>â<span class="nocase">Compile-time introspection and metaprogramming</span>.â</span> <em>Handmade Network</em>. <a href="https://handmade.network/fishbowl/metaprogramming">https://handmade.network/fishbowl/metaprogramming</a>.
</div>
<div id="ref-haskell1970" class="csl-entry">
Haskell.org. 1970. <span>â<span>Haskell Language</span>.â</span> <a href="https://www.haskell.org">https://www.haskell.org</a>.
</div>
<div id="ref-haskell2019" class="csl-entry">
HaskellWiki. 2019. <span>â<span>Monoid - HaskellWiki</span>.â</span> <a href="https://wiki.haskell.org/Monoid">https://wiki.haskell.org/Monoid</a>.
</div>
<div id="ref-rlang2024" class="csl-entry">
Henry, Lionel, and Hadley Wickham. 2024. <em>Rlang: Functions for Base Types and Core r and âTidyverseâ Features</em>. <a href="https://CRAN.R-project.org/package=rlang">https://CRAN.R-project.org/package=rlang</a>.
</div>
<div id="ref-hickey2011" class="csl-entry">
Hickey, Rich. 2011. <span>âSimple Made Easy.â</span> <em>Strange Loop</em>. <a href="https://www.youtube.com/watch?v=LKtk3HCgTa8">https://www.youtube.com/watch?v=LKtk3HCgTa8</a>.
</div>
<div id="ref-hickey2018" class="csl-entry">
âââ. 2018. <span>âMaybe Not.â</span> <em>Clojure Conj</em>. <a href="https://www.youtube.com/watch?v=YR5WdGrpoug">https://www.youtube.com/watch?v=YR5WdGrpoug</a>.
</div>
<div id="ref-kay1996" class="csl-entry">
Kay, Alan C. 1996. <span>âThe Early History of Smalltalk.â</span> In <em>History of Programming LanguagesâII</em>, 511â98.
</div>
<div id="ref-kelley2023" class="csl-entry">
Kelley, Andew. 2023. <span>âA Practical Guide to Applying Data Oriented Design (DoD).â</span> <em>Handmade Seattle</em>. <a href="https://www.youtube.com/watch?v=IroPQ150F6c">https://www.youtube.com/watch?v=IroPQ150F6c</a>.
</div>
<div id="ref-knockout2019" class="csl-entry">
knockoutjs. 2019. <span>â<span>Knockout : Home</span>.â</span> <a href="https://knockoutjs.com">https://knockoutjs.com</a>.
</div>
<div id="ref-knuth1970" class="csl-entry">
Knuth, Donald E. 1970. <span>âVon Neumannâs First Computer Program.â</span> <em>ACM Computing Surveys (CSUR)</em> 2 (4): 247â60.
</div>
<div id="ref-krasner1988" class="csl-entry">
Krasner, Glenn E, Stephen T Pope, et al. 1988. <span>âA Description of the Model-View-Controller User Interface Paradigm in the Smalltalk-80 System.â</span> <em>Journal of Object Oriented Programming</em> 1 (3): 26â49.
</div>
<div id="ref-lawvere2009" class="csl-entry">
Lawvere, F William, and Stephen H Schanuel. 2009. <em>Conceptual Mathematics: A First Introduction to Categories</em>. Cambridge University Press.
</div>
<div id="ref-leff2001" class="csl-entry">
Leff, Avraham, and James T Rayfield. 2001. <span>âWeb-Application Development Using the Model/View/Controller Design Pattern.â</span> In <em>Proceedings Fifth Ieee International Enterprise Distributed Object Computing Conference</em>, 118â27. IEEE.
</div>
<div id="ref-leptos2025" class="csl-entry">
Leptos Core Team. 2025. <span>â<span>Home - Leptos</span>.â</span> <a href="https://leptos.dev">https://leptos.dev</a>.
</div>
<div id="ref-frisby2025" class="csl-entry">
Lonsdorf, Brian. 2025. <span>â<span class="nocase">Mostly adequate guide to functional programming</span>.â</span> <a href="https://mostly-adequate.gitbook.io/mostly-adequate-guide">https://mostly-adequate.gitbook.io/mostly-adequate-guide</a>.
</div>
<div id="ref-mdn2024d" class="csl-entry">
âââ. 2024b. <span>âClasses - JavaScript <span><span class="math inline">\(\vert\)</span></span> MDN.â</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes</a>.
</div>
<div id="ref-mdn2024e" class="csl-entry">
âââ. 2024c. <span>âFunctions - JavaScript <span><span class="math inline">\(\vert\)</span></span> MDN.â</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions</a>.
</div>
<div id="ref-mdn2024c" class="csl-entry">
âââ. 2024e. <span>âJavaScript Language Overview - JavaScript <span><span class="math inline">\(\vert\)</span></span> MDN.â</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Language_overview">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Language_overview</a>.
</div>
<div id="ref-mdn2024g" class="csl-entry">
âââ. 2025a. <span>â<span>WebSocket - Web APIs <span><span class="math inline">\(\vert\)</span></span> MDN</span>.â</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket">https://developer.mozilla.org/en-US/docs/Web/API/WebSocket</a>.
</div>
<div id="ref-webgl2025" class="csl-entry">
âââ. 2025b. <span>â<span class="nocase">WebGL: 2D and 3D graphics for the web - Web APIs <span><span class="math inline">\(\vert\)</span></span> MDN</span>.â</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API">https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API</a>.
</div>
<div id="ref-react2024" class="csl-entry">
Meta. 2024. <span>âReact.â</span> <a href="https://react.dev">https://react.dev</a>.
</div>
<div id="ref-meyer1997" class="csl-entry">
Meyer, Bertrand. 1997. <em>Object-Oriented Software Construction</em>. Vol. 2. Prentice hall Englewood Cliffs.
</div>
<div id="ref-milewski2018" class="csl-entry">
Milewski, Bartosz. 2018. <em>Category Theory for Programmers</em>. Blurb.
</div>
<div id="ref-moseley2006" class="csl-entry">
Moseley, Ben, and Peter Marks. 2006. <span>âOut of the Tar Pit.â</span> <em>Software Practice Advancement (SPA)</em> 2006.
</div>
<div id="ref-muller2023" class="csl-entry">
MÃ¼ller, Kirill, and Hadley Wickham. 2023. <em>Tibble: Simple Data Frames</em>. <a href="https://CRAN.R-project.org/package=tibble">https://CRAN.R-project.org/package=tibble</a>.
</div>
<div id="ref-nikolov2018" class="csl-entry">
Nikolov, Stoyan. 2018. <span>âOOP Is Dead, Long Live Data-Oriented Design.â</span> <em>CppCon</em>. <a href="https://www.youtube.com/watch?v=yy8jQgmhbAU&amp;t=2810s">https://www.youtube.com/watch?v=yy8jQgmhbAU&amp;t=2810s</a>.
</div>
<div id="ref-normand2021" class="csl-entry">
Normand, Eric. 2021. <em>Grokking Simplicity: Taming Complex Software with Functional Thinking</em>. Simon; Schuster.
</div>
<div id="ref-ollila2022" class="csl-entry">
Ollila, Risto, Niko MÃ¤kitalo, and Tommi Mikkonen. 2022. <span>âModern Web Frameworks: A Comparison of Rendering Performance.â</span> <em>Journal of Web Engineering</em> 21 (3): 789â813.
</div>
<div id="ref-pandas2024" class="csl-entry">
Pandas Core Team. 2024. <span>âDataFrame <span>â</span> Pandas 2.2.3 Documentation.â</span> <a href="https://pandas.pydata.org/docs/reference/frame.html">https://pandas.pydata.org/docs/reference/frame.html</a>.
</div>
<div id="ref-parent2013" class="csl-entry">
Parent, Sean. 2013. <span>âInheritance Is the Base Class of Evil.â</span> <em>GoingNative</em>. Youtube. <a href="https://www.youtube.com/watch?v=2bLkxj6EVoM&amp;list=PLM5v5JsFsgP21eB4z2mIL8upkvT00Tw9B">https://www.youtube.com/watch?v=2bLkxj6EVoM&amp;list=PLM5v5JsFsgP21eB4z2mIL8upkvT00Tw9B</a>.
</div>
<div id="ref-parent2015" class="csl-entry">
âââ. 2015. <span>âBetter Code: Data Structures.â</span> <em>CppCon</em>. Youtube. <a href="https://www.youtube.com/watch?v=sWgDk-o-6ZE">https://www.youtube.com/watch?v=sWgDk-o-6ZE</a>.
</div>
<div id="ref-parent2018" class="csl-entry">
âââ. 2018. <span>â<span>Generic Programming</span>.â</span> Pacific++. <a href="https://www.youtube.com/watch?v=iwJpxWHuZQY">https://www.youtube.com/watch?v=iwJpxWHuZQY</a>.
</div>
<div id="ref-parihar2015" class="csl-entry">
Parihar, Raj. 2015. <span>âBranch Prediction Techniques and Optimizations.â</span> <em>University of Rochester, NY, USA</em>.
</div>
<div id="ref-parlog2024" class="csl-entry">
Parlog, Nicolai. 2024. <span>âData Oriented Programming in Java 21.â</span> Devoxx. <a href="https://www.youtube.com/watch?v=8FRU_aGY4mY">https://www.youtube.com/watch?v=8FRU_aGY4mY</a>.
</div>
<div id="ref-pavlo2024" class="csl-entry">
Pavlo, Andy. 2024. <span>âCMU Intro to Database Systems.â</span> Carnegie Melon University; University lecture series. <a href="https://youtu.be/otE2WvX3XdQ?si=L8OtgteVyH-bDb-y">https://youtu.be/otE2WvX3XdQ?si=L8OtgteVyH-bDb-y</a>.
</div>
<div id="ref-pedersen2024" class="csl-entry">
Pedersen, Thomas Lin. 2024. <em>Patchwork: The Composer of Plots</em>. <a href="https://CRAN.R-project.org/package=patchwork">https://CRAN.R-project.org/package=patchwork</a>.
</div>
<div id="ref-petricek2021" class="csl-entry">
âââ. 2021. <span>âComposable Data Visualizations.â</span> <em>Journal of Functional Programming</em> 31: e13.
</div>
<div id="ref-petrov2019" class="csl-entry">
Petrov, Alex. 2019. <em>Database Internals: A Deep Dive into How Distributed Data Systems Work</em>. OâReilly Media.
</div>
<div id="ref-phung2009" class="csl-entry">
Phung, Phu H, David Sands, and Andrey Chudnov. 2009. <span>âLightweight Self-Protecting JavaScript.â</span> In <em>Proceedings of the 4th International Symposium on Information, Computer, and Communications Security</em>, 47â60.
</div>
<div id="ref-r2024" class="csl-entry">
R Core Team. 2024. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-raghavan1998" class="csl-entry">
Raghavan, P., H. Shachnai, and M. Yaniv. 1998. <span>âDynamic Schemes for Speculative Execution of Code.â</span> In <em>Proceedings. Sixth International Symposium on Modeling, Analysis and Simulation of Computer and Telecommunication Systems (Cat. No.98TB100247)</em>, 24. IEEE. <a href="https://doi.org/10.1109/MASCOT.1998.693711">https://doi.org/10.1109/MASCOT.1998.693711</a>.
</div>
<div id="ref-rentzsch2005" class="csl-entry">
Rentzsch, Jonathan. 2005. <span>âData Alignment: Straighten up and Fly Right.â</span> <em>IBM Developer</em>. <a href="https://developer.ibm.com/articles/pa-dalign">https://developer.ibm.com/articles/pa-dalign</a>.
</div>
<div id="ref-svelte2024" class="csl-entry">
Rich Harris and the Svelte Core Team. 2024. <span>âSvelte.â</span> <a href="https://svelte.dev">https://svelte.dev</a>.
</div>
<div id="ref-reactive2024" class="csl-entry">
Rxteam. 2024. <span>â<span>ReactiveX</span>.â</span> <a href="https://reactivex.io">https://reactivex.io</a>.
</div>
<div id="ref-carniato2023" class="csl-entry">
Ryan Carniato. 2023. <span>â<span>Revolutionary Signals</span>.â</span> <em>YouTube</em>. Youtube. <a href="https://www.youtube.com/watch?v=Jp7QBjY5K34&amp;t">https://www.youtube.com/watch?v=Jp7QBjY5K34&amp;t</a>.
</div>
<div id="ref-sharvit2022" class="csl-entry">
Sharvit, Yehonathan. 2022. <em>Data-Oriented Programming: Reduce Software Complexity</em>. Simon; Schuster.
</div>
<div id="ref-sievert2020" class="csl-entry">
Sievert, Carson. 2020. <em>Interactive Web-Based Data Visualization with r, Plotly, and Shiny</em>. Chapman; Hall/CRC.
</div>
<div id="ref-solid2024" class="csl-entry">
Solid Core Team. 2025. <span>âSolidJS.â</span> <a href="https://www.solidjs.com">https://www.solidjs.com</a>.
</div>
<div id="ref-stange2024" class="csl-entry">
Stange, Markus. 2024. <span>âFast JavaScript with Data-Oriented Design.â</span> <em>FOSDEM</em>. <a href="https://archive.fosdem.org/2024/schedule/event/fosdem-2024-2773-fast-javascript-with-data-oriented-design">https://archive.fosdem.org/2024/schedule/event/fosdem-2024-2773-fast-javascript-with-data-oriented-design</a>.
</div>
<div id="ref-stepanov2013" class="csl-entry">
Stepanov, Alexander A. 2013. <span>âEfficient Programming with Components.â</span> <em>A9</em>. Youtube. <a href="https://www.youtube.com/playlist?list=PLHxtyCq_WDLXryyw91lahwdtpZsmo4BGD">https://www.youtube.com/playlist?list=PLHxtyCq_WDLXryyw91lahwdtpZsmo4BGD</a>.
</div>
<div id="ref-stepanov2009" class="csl-entry">
Stepanov, Alexander A, and Paul McJones. 2009. <em>Elements of Programming</em>. Addison-Wesley Professional.
</div>
<div id="ref-polars2024" class="csl-entry">
Team, Polars Core. 2024. <span>âIndex - Polars User Guide.â</span> <a href="https://docs.pola.rs">https://docs.pola.rs</a>.
</div>
<div id="ref-theus2002" class="csl-entry">
Theus, Martin. 2002. <span>â<span class="nocase">Interactive Data Visualization using Mondrian</span>.â</span> <em>J. Stat. Soft.</em> 7 (November): 1â9. <a href="https://doi.org/10.18637/jss.v007.i11">https://doi.org/10.18637/jss.v007.i11</a>.
</div>
<div id="ref-unwin1996" class="csl-entry">
Unwin, Antony, George Hawkins, Heike Hofmann, and Bernd Siegl. 1996. <span>âInteractive Graphics for Data Sets with Missing ValuesâMANET.â</span> <em>Journal of Computational and Graphical Statistics</em> 5 (2): 113â22.
</div>
<div id="ref-urbanek2011" class="csl-entry">
âââ. 2011. <span>âiPlots eXtreme: Next-Generation Interactive Graphics Design and Implementation of Modern Interactive Graphics.â</span> <em>Computational Statistics</em> 26 (3): 381â93.
</div>
<div id="ref-veight2017" class="csl-entry">
V8 Core Team. 2017. <span>âElements Kinds in V8 <span><span class="math inline">\(\cdot\)</span></span> V8.â</span> <a href="https://v8.dev/blog/elements-kinds">https://v8.dev/blog/elements-kinds</a>.
</div>
<div id="ref-veight2024" class="csl-entry">
âââ. 2024. <span>âMaps (Hidden Classes) in V8.â</span> <a href="https://v8.dev/docs/hidden-classes">https://v8.dev/docs/hidden-classes</a>.
</div>
<div id="ref-htmlwidgets2021" class="csl-entry">
Vaidyanathan, Ramnath, Yihui Xie, JJ Allaire, Joe Cheng, Carson Sievert, and Kenton Russell. 2021. <em>Htmlwidgets: HTML Widgets for r</em>. <a href="https://CRAN.R-project.org/package=htmlwidgets">https://CRAN.R-project.org/package=htmlwidgets</a>.
</div>
<div id="ref-vaneerd2023" class="csl-entry">
Van Eerd, Tony. 2023. <span>âValue Oriented Programming Part 1: You Say You Want to Write a Function.â</span> <em>CppNow</em>. Youtube. <a href="https://www.youtube.com/watch?v=b4p_tcLYDV0">https://www.youtube.com/watch?v=b4p_tcLYDV0</a>.
</div>
<div id="ref-vaneerd2024" class="csl-entry">
âââ. 2024. <span>âValue Oriented Programming Part v - Return of the Values.â</span> <em>CppNow</em>. Youtube. <a href="https://www.youtube.com/watch?v=sc1guyo5Rso">https://www.youtube.com/watch?v=sc1guyo5Rso</a>.
</div>
<div id="ref-van2009" class="csl-entry">
Van Roy, Peter et al. 2009. <span>âProgramming Paradigms for Dummies: What Every Programmer Should Know.â</span> <em>New Computational Paradigms for Computer Music</em> 104: 616â21.
</div>
<div id="ref-von1993" class="csl-entry">
Von Neumann, John. 1993. <span>âFirst Draft of a Report on the EDVAC.â</span> <em>IEEE Annals of the History of Computing</em> 15 (4): 27â75.
</div>
<div id="ref-wickham2013" class="csl-entry">
âââ. 2013. <span>âBin-Summarise-Smooth: A Framework for Visualising Large Data.â</span> <em>Had. Co. Nz, Tech. Rep</em>.
</div>
<div id="ref-wickham2014" class="csl-entry">
Wickham, Hadley. 2014. <span>â<span class="nocase">Iâm Hadley Wickham, Chief Scientist at RStudio and creator of lots of R packages (incl. ggplot2, dplyr, and devtools). I love R, data analysis/science, visualisation: ask me anything! : r/dataisbeautiful</span>.â</span> <a href="https://www.reddit.com/r/dataisbeautiful/comments/3mp9r7/comment/cvi19ly">https://www.reddit.com/r/dataisbeautiful/comments/3mp9r7/comment/cvi19ly</a>.
</div>
<div id="ref-wickham2016" class="csl-entry">
Wickham, Hadley. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis (2e)</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-wickham2019" class="csl-entry">
âââ. 2019. <em>Advanced r</em>. Chapman; Hall/CRC.
</div>
<div id="ref-wilkinson2012" class="csl-entry">
Wilkinson, Leland. 2012. <em>The Grammar of Graphics</em>. Springer.
</div>
<div id="ref-will2016" class="csl-entry">
Will, Brian. 2016. <span>âObject-Oriented Programming Is Bad.â</span> Youtube. <a href="https://www.youtube.com/watch?v=QM1iUe6IofM">https://www.youtube.com/watch?v=QM1iUe6IofM</a>.
</div>
<div id="ref-xie2014" class="csl-entry">
Xie, Yihui, Heike Hofmann, and Xiaoyue Cheng. 2014. <span>âReactive Programming for Interactive Graphics.â</span> <em>Statistical Science</em>, 201â13.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="10">
<li id="fn10"><p>For instance, the <code>plotly</code> package takes up about 7.3 megabytes, over 15x difference.<a href="system.html#fnref10" class="footnote-back">â©ï¸</a></p></li>
<li id="fn11"><p>Throughout the examples in this thesis, I use the base R <code>|&gt;</code> operator, however, the <code>%&gt;%</code> operator from the <code>magrittr</code> package <span class="citation">(<a href="#ref-bache2022">Bache and Wickham 2022</a>)</span> would work equally well.<a href="system.html#fnref11" class="footnote-back">â©ï¸</a></p></li>
<li id="fn12"><p>The terminology here is a bit unfortunate, since the <em>unquoted</em> string arguments <em>are</em> surrounded by quotes.<a href="system.html#fnref12" class="footnote-back">â©ï¸</a></p></li>
<li id="fn13"><p>Of course, the schema <em>could</em> theoretically be parsed to compute the figureâs state. For instance with <code>create_schema(...) |&gt; assign_cases(1:10, 2) |&gt; assign_cases(5:10, 3)</code> we could infer that the first five group indices will belong to group 2 and the second five will belong to group 3. However, since the user has to write the code to modifying the figure in the first place, the utility of such parsing is debatable.<a href="system.html#fnref13" class="footnote-back">â©ï¸</a></p></li>
<li id="fn14"><p>In fact, this is how <code>plotscaper</code> figures are rendered in the present thesis<a href="system.html#fnref14" class="footnote-back">â©ï¸</a></p></li>
<li id="fn15"><p>This could also be implemented by class inheritance, by making the Scene object extend an Observer class.<a href="system.html#fnref15" class="footnote-back">â©ï¸</a></p></li>
<li id="fn16"><p>Some authors consider procedural programming a subset of imperative programming, however, the terms are often used interchangeably.<a href="system.html#fnref16" class="footnote-back">â©ï¸</a></p></li>
<li id="fn17"><p>Technically, in JavaScript, there is no difference on the language level: all array and dictionary (<a href="appendix-glossary.html#JSON">POJO</a>) variables are pointers to (heap-allocated) objects, so they can be referenced in multiple places. However, conceptually, I still found it much easier to think about data structures in the DOP way.<a href="system.html#fnref17" class="footnote-back">â©ï¸</a></p></li>
<li id="fn18"><p>Or perhaps infamous.<a href="system.html#fnref18" class="footnote-back">â©ï¸</a></p></li>
<li id="fn19"><p>In simpler implementations, a single array can be used instead of the dictionary; the listeners are then notified whenever the object âupdatesâ.<a href="system.html#fnref19" class="footnote-back">â©ï¸</a></p></li>
<li id="fn20"><p>This can be solved by adding a priority property to the event callbacks, and sorting the arrays by priority.<a href="system.html#fnref20" class="footnote-back">â©ï¸</a></p></li>
<li id="fn21"><p>Not to be confused with the diamond problem in OOP, which relates to multiple inheritance.<a href="system.html#fnref21" class="footnote-back">â©ï¸</a></p></li>
<li id="fn22"><p>Memoizing a derived value can be done by creating a new signal and an effect that runs when the original value gets updated.<a href="system.html#fnref22" class="footnote-back">â©ï¸</a></p></li>
<li id="fn23"><p>Not actually exported by <code>plotscape</code> but can be easily implemented<a href="system.html#fnref23" class="footnote-back">â©ï¸</a></p></li>
<li id="fn24"><p>The <code>indices</code> indices being <em>dense</em> means that <em>each</em> value in <code>0 ... cardinality - 1</code> appears in the array at least once.<a href="system.html#fnref24" class="footnote-back">â©ï¸</a></p></li>
<li id="fn25"><p>Unless the length of the data changes. I have not implemented data streaming for <code>plotscape</code> yet, however, it would be easy to extend bijection/constant factors in the context of streaming by simply pushing/popping the array of indices.<a href="system.html#fnref25" class="footnote-back">â©ï¸</a></p></li>
<li id="fn26"><p>Other use-cases may be plots involving a single geometric object such as density plots and radar plots, however, these are currently not implemented in <code>plotscape</code>.<a href="system.html#fnref26" class="footnote-back">â©ï¸</a></p></li>
<li id="fn27"><p>Note that the parameters are <em>not</em> orthogonal: for instance, histogram with <code>nBins</code> bins cannot have arbitrary binwidth (<code>width</code>) and vice versa. If a user provides multiple parameters, they are resolved in the following order: <code>breaks</code> &gt; <code>nBins</code> &gt; <code>width</code>.<a href="system.html#fnref27" class="footnote-back">â©ï¸</a></p></li>
<li id="fn28"><p>In the general case where the histogram bins are not necessarily all of equal with; if all bins are known to have the same width, we can compute the bin index in constant <span class="math inline">\(O(1)\)</span> time<a href="system.html#fnref28" class="footnote-back">â©ï¸</a></p></li>
<li id="fn29"><p>Or a factor isomorphic to that one, up to the permutation of indices.<a href="system.html#fnref29" class="footnote-back">â©ï¸</a></p></li>
<li id="fn30"><p>Equality only if either one or both of the factors are constant, or if there exists an isomorphism between the factorsâ indices.<a href="system.html#fnref30" class="footnote-back">â©ï¸</a></p></li>
<li id="fn31"><p>Equality only if all element-wise combinations of indices form a bijection/are unique.<a href="system.html#fnref31" class="footnote-back">â©ï¸</a></p></li>
<li id="fn32"><p>Using zero-based indexing.<a href="system.html#fnref32" class="footnote-back">â©ï¸</a></p></li>
<li id="fn33"><p>For instance, one hypothetical option would be to store the computed product indices in a min-heap <span class="citation">(see e.g. <a href="#ref-cormen2022">Cormen et al. 2022</a>)</span>. Min-heaps have a <span class="math inline">\(O(\log n)\)</span> time complexity for deleting the lowest element, which may seem like an improvement, however, to clean all indices, we would still need to delete all <span class="math inline">\(n\)</span> nodes, which would again result in <span class="math inline">\(O(n \cdot \log n)\)</span> time complexity, and therefore there would be little real advantage over sorting. Another option would be to simply trade time complexity for space complexity and maintain a âholeyâ array of all possible product indices with length <span class="math inline">\(c_1 \cdot c_2\)</span>, which would only need to be compacted once all indices are computed.<a href="system.html#fnref33" class="footnote-back">â©ï¸</a></p></li>
<li id="fn34"><p>The actual implementation in the current version of <code>plotscape</code> differs slightly in several key aspects, however, I chose to use this simplified interface here for clarity.<a href="system.html#fnref34" class="footnote-back">â©ï¸</a></p></li>
<li id="fn35"><p>Note that, in the example below, we assign string key properties to an array. This would be prohibited in many languages but is perfectly valid in JavaScript/TypeScript due to its highly dynamic nature.<a href="system.html#fnref35" class="footnote-back">â©ï¸</a></p></li>
<li id="fn36"><p>Technically, with the way <code>normalize</code> is implemented, the normalizing function can be any arbitrary binary function, not just division. This could be used, for example, in weighted normalization: instead of using standard division <code>(x, y) =&gt; x / y</code>, we could add a transformation e.g.Â <code>(x, y) =&gt; Math.sqrt(x) / Math.sqrt(y)</code>.<a href="system.html#fnref36" class="footnote-back">â©ï¸</a></p></li>
<li id="fn37"><p>Technically, the type signature of the real function as implemented in <code>plotscape</code> is a lot more complicated since it heavily relies on generics to correctly infer the type of the summarized data, however, the basic idea is the same.<a href="system.html#fnref37" class="footnote-back">â©ï¸</a></p></li>
<li id="fn38"><p>This is <em>almost</em> the exact implementation, with the only difference being that in <code>plotscape</code>, <code>domain</code> and <code>codomain</code> can additionally be array-valued, so <code>Scale.pushforward</code> includes logic for handling this.<a href="system.html#fnref38" class="footnote-back">â©ï¸</a></p></li>
<li id="fn39"><p>This is not much of a problem since, right now, <code>ExpanseBand.unnormalize</code> is not actually used anywhere in the system (all scales implemented thus far only use only <code>ExpanseBand.normalize</code>). However, it is important to be mindful of this.<a href="system.html#fnref39" class="footnote-back">â©ï¸</a></p></li>
<li id="fn40"><p>The model part is handled by components like <code>Summaries</code><a href="system.html#fnref40" class="footnote-back">â©ï¸</a></p></li>
<li id="fn41"><p>With respect to the dimensions of the plot; it can still be modified by interaction.<a href="system.html#fnref41" class="footnote-back">â©ï¸</a></p></li>
<li id="fn42"><p>They are not truly independent since e.g.Â zooming affects both.<a href="system.html#fnref42" class="footnote-back">â©ï¸</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="goals.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="applied-example.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": ["_main.pdf"],
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
