<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 System description | The Algebra of Graphics, Statistics, and Interaction</title>
  <meta name="description" content="7 System description | The Algebra of Graphics, Statistics, and Interaction" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="7 System description | The Algebra of Graphics, Statistics, and Interaction" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 System description | The Algebra of Graphics, Statistics, and Interaction" />
  
  
  

<meta name="author" content="Adam Bartonicek" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="high-level-design.html"/>
<link rel="next" href="applied-example.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="background.html"><a href="background.html"><i class="fa fa-check"></i><b>3</b> Background</a>
<ul>
<li class="chapter" data-level="3.1" data-path="background.html"><a href="background.html#brief-history"><i class="fa fa-check"></i><b>3.1</b> Brief history of interactive data visualization</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="background.html"><a href="background.html#static-data-visualization-from-ancient-times-to-the-space-age"><i class="fa fa-check"></i><b>3.1.1</b> Static data visualization: From ancient times to the space age</a></li>
<li class="chapter" data-level="3.1.2" data-path="background.html"><a href="background.html#early-interactive"><i class="fa fa-check"></i><b>3.1.2</b> Early interactive data visualization: By statisticians for statisticians</a></li>
<li class="chapter" data-level="3.1.3" data-path="background.html"><a href="background.html#web-based"><i class="fa fa-check"></i><b>3.1.3</b> Interactive data visualization and the internet: Web-based interactivity</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="background.html"><a href="background.html#what-is-interactive-visualization"><i class="fa fa-check"></i><b>3.2</b> What even is interactive data visualization?</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="background.html"><a href="background.html#interactive-interacting"><i class="fa fa-check"></i><b>3.2.1</b> Interactive vs. interacting with</a></li>
<li class="chapter" data-level="3.2.2" data-path="background.html"><a href="background.html#interactive-enough"><i class="fa fa-check"></i><b>3.2.2</b> Interactive <em>enough</em>?</a></li>
<li class="chapter" data-level="3.2.3" data-path="background.html"><a href="background.html#complexity-of-features"><i class="fa fa-check"></i><b>3.2.3</b> Complexity of interactive features</a></li>
<li class="chapter" data-level="3.2.4" data-path="background.html"><a href="background.html#working-definition"><i class="fa fa-check"></i><b>3.2.4</b> Working definition</a></li>
<li class="chapter" data-level="3.2.5" data-path="background.html"><a href="background.html#common-features"><i class="fa fa-check"></i><b>3.2.5</b> Common interactive features</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="background.html"><a href="background.html#general-data-visualization-theory"><i class="fa fa-check"></i><b>3.3</b> General data visualization theory</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="background.html"><a href="background.html#visualization-goals"><i class="fa fa-check"></i><b>3.3.1</b> Visualization goals</a></li>
<li class="chapter" data-level="3.3.2" data-path="background.html"><a href="background.html#visual-perception"><i class="fa fa-check"></i><b>3.3.2</b> Visual perception</a></li>
<li class="chapter" data-level="3.3.3" data-path="background.html"><a href="background.html#scales-measurement"><i class="fa fa-check"></i><b>3.3.3</b> Scales and measurement</a></li>
<li class="chapter" data-level="3.3.4" data-path="background.html"><a href="background.html#graphics-formats"><i class="fa fa-check"></i><b>3.3.4</b> Graphics formats</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="problems.html"><a href="problems.html"><i class="fa fa-check"></i><b>4</b> Challenges</a>
<ul>
<li class="chapter" data-level="4.1" data-path="problems.html"><a href="problems.html#the-structure-of-this-chapter-data-visualization-pipeline"><i class="fa fa-check"></i><b>4.1</b> The structure of this chapter: Data visualization pipeline</a></li>
<li class="chapter" data-level="4.2" data-path="problems.html"><a href="problems.html#partitioning"><i class="fa fa-check"></i><b>4.2</b> Partitioning</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="problems.html"><a href="problems.html#show-all-data"><i class="fa fa-check"></i><b>4.2.1</b> Showing the full data</a></li>
<li class="chapter" data-level="4.2.2" data-path="problems.html"><a href="problems.html#comparison-disjointness"><i class="fa fa-check"></i><b>4.2.2</b> Comparison and disjointness</a></li>
<li class="chapter" data-level="4.2.3" data-path="problems.html"><a href="problems.html#plots-as-partitions"><i class="fa fa-check"></i><b>4.2.3</b> Plots as partitions</a></li>
<li class="chapter" data-level="4.2.4" data-path="problems.html"><a href="problems.html#hierarchy"><i class="fa fa-check"></i><b>4.2.4</b> Partitions, hierarchy, and preorders</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="problems.html"><a href="problems.html#aggregation"><i class="fa fa-check"></i><b>4.3</b> Aggregation</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="problems.html"><a href="problems.html#the-relationship-between-graphics-and-statistics"><i class="fa fa-check"></i><b>4.3.1</b> The relationship between graphics and statistics</a></li>
<li class="chapter" data-level="4.3.2" data-path="problems.html"><a href="problems.html#stackable-summaries-a-brief-journey-into-category-theory"><i class="fa fa-check"></i><b>4.3.2</b> Stackable summaries: A brief journey into Category Theory</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="problems.html"><a href="problems.html#scaling"><i class="fa fa-check"></i><b>4.4</b> Scaling and encoding</a></li>
<li class="chapter" data-level="4.5" data-path="problems.html"><a href="problems.html#rendering"><i class="fa fa-check"></i><b>4.5</b> Rendering</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="problems.html"><a href="problems.html#frames"><i class="fa fa-check"></i><b>4.5.1</b> Frames</a></li>
<li class="chapter" data-level="4.5.2" data-path="problems.html"><a href="problems.html#graphical-elements"><i class="fa fa-check"></i><b>4.5.2</b> Graphical elements</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="goals.html"><a href="goals.html"><i class="fa fa-check"></i><b>5</b> Goals</a>
<ul>
<li class="chapter" data-level="5.1" data-path="goals.html"><a href="goals.html#user-profile"><i class="fa fa-check"></i><b>5.1</b> User profile</a></li>
<li class="chapter" data-level="5.2" data-path="goals.html"><a href="goals.html#programming-interface"><i class="fa fa-check"></i><b>5.2</b> Programming interface</a></li>
<li class="chapter" data-level="5.3" data-path="goals.html"><a href="goals.html#user-interface"><i class="fa fa-check"></i><b>5.3</b> User interface</a></li>
<li class="chapter" data-level="5.4" data-path="goals.html"><a href="goals.html#interactive-features"><i class="fa fa-check"></i><b>5.4</b> Interactive features</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="high-level-design.html"><a href="high-level-design.html"><i class="fa fa-check"></i><b>6</b> High-level design</a>
<ul>
<li class="chapter" data-level="6.0.1" data-path="high-level-design.html"><a href="high-level-design.html#user-profile-1"><i class="fa fa-check"></i><b>6.0.1</b> User profile</a></li>
<li class="chapter" data-level="6.1" data-path="high-level-design.html"><a href="high-level-design.html#programming-paradigm"><i class="fa fa-check"></i><b>6.1</b> Programming paradigm</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="high-level-design.html"><a href="high-level-design.html#imperative-programming"><i class="fa fa-check"></i><b>6.1.1</b> Imperative programming</a></li>
<li class="chapter" data-level="6.1.2" data-path="high-level-design.html"><a href="high-level-design.html#functional-programming"><i class="fa fa-check"></i><b>6.1.2</b> Functional programming</a></li>
<li class="chapter" data-level="6.1.3" data-path="high-level-design.html"><a href="high-level-design.html#object-oriented-programming"><i class="fa fa-check"></i><b>6.1.3</b> Object oriented programming</a></li>
<li class="chapter" data-level="6.1.4" data-path="high-level-design.html"><a href="high-level-design.html#data-oriented-programming"><i class="fa fa-check"></i><b>6.1.4</b> Data oriented programming</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="high-level-design.html"><a href="high-level-design.html#reactivity"><i class="fa fa-check"></i><b>6.2</b> Reactivity</a></li>
<li class="chapter" data-level="6.3" data-path="high-level-design.html"><a href="high-level-design.html#data-representation"><i class="fa fa-check"></i><b>6.3</b> Data representation</a></li>
<li class="chapter" data-level="6.4" data-path="high-level-design.html"><a href="high-level-design.html#rendering-engine"><i class="fa fa-check"></i><b>6.4</b> Rendering engine</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="system.html"><a href="system.html"><i class="fa fa-check"></i><b>7</b> System description</a>
<ul>
<li class="chapter" data-level="7.1" data-path="system.html"><a href="system.html#core-requirements"><i class="fa fa-check"></i><b>7.1</b> Core requirements</a></li>
<li class="chapter" data-level="7.2" data-path="system.html"><a href="system.html#high-level-api"><i class="fa fa-check"></i><b>7.2</b> High-level API (<code>plotscaper</code>)</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="system.html"><a href="system.html#api-design"><i class="fa fa-check"></i><b>7.2.1</b> API design</a></li>
<li class="chapter" data-level="7.2.2" data-path="system.html"><a href="system.html#basic-example-of-plotscaper-code"><i class="fa fa-check"></i><b>7.2.2</b> Basic example of <code>plotscaper</code> code</a></li>
<li class="chapter" data-level="7.2.3" data-path="system.html"><a href="system.html#scene-and-schema"><i class="fa fa-check"></i><b>7.2.3</b> The scene and the schema</a></li>
<li class="chapter" data-level="7.2.4" data-path="system.html"><a href="system.html#communication"><i class="fa fa-check"></i><b>7.2.4</b> Client-server communication</a></li>
<li class="chapter" data-level="7.2.5" data-path="system.html"><a href="system.html#html-embedding"><i class="fa fa-check"></i><b>7.2.5</b> HTML embedding</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="system.html"><a href="system.html#low-level-implementation"><i class="fa fa-check"></i><b>7.3</b> Low-level implementation (<code>plotscape</code>)</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="system.html"><a href="system.html#reactivity-1"><i class="fa fa-check"></i><b>7.3.1</b> Reactivity</a></li>
<li class="chapter" data-level="7.3.2" data-path="system.html"><a href="system.html#system-components"><i class="fa fa-check"></i><b>7.3.2</b> System components</a></li>
<li class="chapter" data-level="7.3.3" data-path="system.html"><a href="system.html#scales"><i class="fa fa-check"></i><b>7.3.3</b> Scales</a></li>
<li class="chapter" data-level="7.3.4" data-path="system.html"><a href="system.html#expanses"><i class="fa fa-check"></i><b>7.3.4</b> Expanses</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="applied-example.html"><a href="applied-example.html"><i class="fa fa-check"></i><b>8</b> Applied example</a>
<ul>
<li class="chapter" data-level="8.0.1" data-path="applied-example.html"><a href="applied-example.html#about-the-data-set"><i class="fa fa-check"></i><b>8.0.1</b> About the data set</a></li>
<li class="chapter" data-level="8.0.2" data-path="applied-example.html"><a href="applied-example.html#interactive-exploration"><i class="fa fa-check"></i><b>8.0.2</b> Interactive exploration</a></li>
<li class="chapter" data-level="8.1" data-path="applied-example.html"><a href="applied-example.html#summary"><i class="fa fa-check"></i><b>8.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="discussion.html"><a href="discussion.html"><i class="fa fa-check"></i><b>9</b> Discussion</a>
<ul>
<li class="chapter" data-level="9.1" data-path="discussion.html"><a href="discussion.html#limitations-of-the-theoretical-model"><i class="fa fa-check"></i><b>9.1</b> Limitations of the theoretical model</a></li>
<li class="chapter" data-level="9.2" data-path="discussion.html"><a href="discussion.html#limitations-of-the-software-packages"><i class="fa fa-check"></i><b>9.2</b> Limitations of the software packages</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>10</b> Glossary</a></li>
<li class="chapter" data-level="11" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>11</b> Appendix</a>
<ul>
<li class="chapter" data-level="11.1" data-path="appendix.html"><a href="appendix.html#gauss-russian-monoids"><i class="fa fa-check"></i><b>11.1</b> Gauss method and the russian peasant algorithm for monoids</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="mathematical-theory.html"><a href="mathematical-theory.html"><i class="fa fa-check"></i><b>12</b> Mathematical theory</a>
<ul>
<li class="chapter" data-level="12.0.1" data-path="mathematical-theory.html"><a href="mathematical-theory.html#relations"><i class="fa fa-check"></i><b>12.0.1</b> Relations</a></li>
<li class="chapter" data-level="12.0.2" data-path="mathematical-theory.html"><a href="mathematical-theory.html#functions"><i class="fa fa-check"></i><b>12.0.2</b> Functions</a></li>
<li class="chapter" data-level="12.0.3" data-path="mathematical-theory.html"><a href="mathematical-theory.html#partitions"><i class="fa fa-check"></i><b>12.0.3</b> Partitions</a></li>
<li class="chapter" data-level="12.0.4" data-path="mathematical-theory.html"><a href="mathematical-theory.html#preorders"><i class="fa fa-check"></i><b>12.0.4</b> Preorders</a></li>
<li class="chapter" data-level="12.0.5" data-path="mathematical-theory.html"><a href="mathematical-theory.html#monoids"><i class="fa fa-check"></i><b>12.0.5</b> Monoids</a></li>
<li class="chapter" data-level="12.0.6" data-path="mathematical-theory.html"><a href="mathematical-theory.html#groups"><i class="fa fa-check"></i><b>12.0.6</b> Groups</a></li>
<li class="chapter" data-level="12.0.7" data-path="mathematical-theory.html"><a href="mathematical-theory.html#categories"><i class="fa fa-check"></i><b>12.0.7</b> Categories</a></li>
<li class="chapter" data-level="12.0.8" data-path="mathematical-theory.html"><a href="mathematical-theory.html#functors"><i class="fa fa-check"></i><b>12.0.8</b> Functors</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>13</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The Algebra of Graphics, Statistics, and Interaction</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="system" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">7</span> System description<a href="system.html#system" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This section contains a detailed description of the two software packages developed as part of this doctoral project: (<a href="https://github.com/bartonicek/plotscape">plotscape</a> and <a href="https://github.com/bartonicek/plotscaper">plotscaper</a>):</p>
<ul>
<li><code>plotscape</code>: Written in TypeScript/JavaScript, provides “low-level” interactive visualization utilities</li>
<li><code>plotscaper</code>: Written in R, provides a “high-level” wrapper/API for R users</li>
</ul>
<p>Web-technologies were chosen because they provide a simple and portable way to do interactive apps in R, having become the de facto standard thanks to good integration that packages such as <code>htmlwidgets</code> <span class="citation">(<a href="#ref-htmlwidgets2021">Vaidyanathan et al. 2021</a>)</span> and Shiny <span class="citation">(<a href="#ref-sievert2020">Sievert 2020</a>)</span>. The functionality was split across two packages out of practical concerns; rather than relying on some JS-in-R wrapper library, <code>plotscape</code> was implemented in vanilla TypeScript/JavaScript directly, to achieve optimal performance and fine-grained control. <code>plotscaper</code> was then developed to provide a user-friendly R wrapper around <code>plotscape</code>’s functionalities.</p>
<p>As of the time of writing, <code>plotscape</code> comprises of about 6,400 significant lines of code (SLOC; un-minified, primarily TypeScript but also some CSS, includes tests, etc…), and <code>plotscaper</code> contains about 500 SLOC of R code (both counted using <a href="https://github.com/AlDanial/cloc"><code>cloc</code></a>). The unpacked size of all files (including minified JS) is about 200 kilobytes for <code>plotscape</code> and 460 kilobytes for <code>plotscaper</code>, which is fairly modest compared to other interactive data visualization alternatives for R<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. Both packages have fairly minimal dependencies.</p>
<p>Since the two packages address fairly well-separable concerns - high-level API design vs. low-level interactive visualization utilites - I organize this section accordingly. First, I discuss general, high-level API concerns alongside <code>plotscaper</code>. Second, I delve into the low-level implementation details alongside <code>plotscape</code>. There are of course cross-cutting concerns with both packages and those will be addressed towards ends of the respective sections. However, first, let’s briefly review the core requirement of the package(s).</p>
<div id="core-requirements" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Core requirements<a href="system.html#core-requirements" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To re-iterate, from Section <a href="goals.html#goals">5</a>, the core requirements for the high-level API (<code>plotscaper</code>) were:</p>
<ul>
<li>Provide a framework for creating and manipulating interactive figures geared towards data exploration</li>
<li>Be accessible to a wide range of users with varying levels of experience</li>
<li>Integrate well with popular tools within the R ecosystem, such as the RStudio IDE and RMarkdown</li>
</ul>
<p>These will be the subject of Section <a href="system.html#high-level-api">7.2</a>. However, to realize these goals, it was also necessary to design the low-level platform (<code>plotscape</code>) which could support them. The primary purpose of <code>plotscape</code> was to provide utilities for the interactive data visualization pipeline:</p>
<ul>
<li>Splitting the data into a hierarchy of partitions</li>
<li>Computing and transforming summary statistics (e.g. stacking, normalizing)</li>
<li>Mapping these summaries to visual encodings (e.g. x- and y-axis position, width, height, and area)</li>
<li>Rendering geometric objects and auxiliary graphical elements</li>
<li>Responding to user input and server requests, propagating any required updates throughout the pipeline</li>
</ul>
<p>Section <a href="system.html#low-level-implementation">7.3</a> will discuss the above-mentioned tasks, and the data structures and algorithms used to support them.</p>
</div>
<div id="high-level-api" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> High-level API (<code>plotscaper</code>)<a href="system.html#high-level-api" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In Section <a href="goals.html#goals">5</a>, I already discussed some broad, theoretical ideas related to the package’s functionality. Here, I focus more on the concrete API - what <code>plotscaper</code> code looks like, how are users supposed to understand it, and why was the package designed this way. The goal is to provide a rationale for key design decisions and choices.</p>
<div id="api-design" class="section level3 hasAnchor" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> API design<a href="system.html#api-design" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As mentioned in Section <a href="goals.html#goals">5</a>, a primary inspiration for <code>plotscaper</code>’s API was the popular R package <code>ggplot2</code>. In <code>ggplot2</code>, plots are created by chaining together a series of function calls, each adding or modifying a component of an immutable plot schema:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="system.html#cb1-1" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="system.html#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="system.html#cb1-3" tabindex="-1"></a><span class="co"># In ggplot, plots are created by chaining a series of function calls</span></span>
<span id="cb1-4"><a href="system.html#cb1-4" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(wt, mpg)) <span class="sc">+</span></span>
<span id="cb1-5"><a href="system.html#cb1-5" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="co"># The overloaded `+` operator serves to compose these calls</span></span>
<span id="cb1-6"><a href="system.html#cb1-6" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>))</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="system.html#cb2-1" tabindex="-1"></a><span class="co"># The call to ggplot() creates an immutable plot schema object</span></span>
<span id="cb2-2"><a href="system.html#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="system.html#cb2-3" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(wt, mpg))</span>
<span id="cb2-4"><a href="system.html#cb2-4" tabindex="-1"></a><span class="fu">names</span>(plot1)</span></code></pre></div>
<pre><code>##  [1] &quot;data&quot;        &quot;layers&quot;      &quot;scales&quot;      &quot;guides&quot;      &quot;mapping&quot;     &quot;theme&quot;       &quot;coordinates&quot; &quot;facet&quot;       &quot;plot_env&quot;   
## [10] &quot;layout&quot;      &quot;labels&quot;</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="system.html#cb4-1" tabindex="-1"></a><span class="fu">length</span>(plot1<span class="sc">$</span>layers)</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="system.html#cb6-1" tabindex="-1"></a><span class="co"># Adding components such as geoms returns a new schema object</span></span>
<span id="cb6-2"><a href="system.html#cb6-2" tabindex="-1"></a>plot2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(wt, mpg)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span>
<span id="cb6-3"><a href="system.html#cb6-3" tabindex="-1"></a><span class="fu">names</span>(plot2)</span></code></pre></div>
<pre><code>##  [1] &quot;data&quot;        &quot;layers&quot;      &quot;scales&quot;      &quot;guides&quot;      &quot;mapping&quot;     &quot;theme&quot;       &quot;coordinates&quot; &quot;facet&quot;       &quot;plot_env&quot;   
## [10] &quot;layout&quot;      &quot;labels&quot;</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="system.html#cb8-1" tabindex="-1"></a><span class="fu">length</span>(plot2<span class="sc">$</span>layers)</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p><code>ggplot2</code> is well-loved by R users, as evidenced by the package’s popularity. However, its API presents certain limitations when building interactive figures. Specifically:</p>
<ul>
<li>Its design primarily focuses on individual plots. While facetting does make it possible to create multi-panel figures consisting of repeats of the same plot type <span class="citation">(see <code>facet_wrap()</code> and <code>facet_grid()</code>, <a href="#ref-wickham2016">Wickham 2016</a>)</span>, multi-panel figures with mixed plot types require the use of external packages such as <code>gridExtra</code> <span class="citation">(<a href="#ref-auguie2017">Auguie 2017</a>)</span> or <code>patchwork</code> <span class="citation">(<a href="#ref-pedersen2024">Pedersen 2024</a>)</span>. As discussed in Section <a href="background.html#background">3</a>, in interactive graphics, multi-panel figures composed of different plot types are essential, and as such, the single-plot model of <code>ggplot2</code> is not sufficient.</li>
<li>While the immutable schema model works well for static graphics, in interactive graphics, the ability to modify an already rendered figure can be extremely useful. For example, by directly mutating the figure state via a function call, we can easily set an interactive histogram binwidth to a precise value, rather than having to rely on some imprecise widgets/controls such as a slider.<br />
</li>
<li>Many of the <code>ggplot2</code>’s core functions make heavy use of quotation and non-standard evaluation <span class="citation">(NSE, <a href="#ref-wickham2019">Wickham 2019</a>)</span>. While this style is fairly popular within the R ecosystem and does offer certain elegance/syntactic conciseness, it also complicates programmatic use <span class="citation">(<a href="#ref-wickham2019">Wickham 2019</a>)</span>. For instance, in <code>ggplot2</code>, to plot all pairwise combinations of the variables in a dataframe, we cannot simply loop over their names and supply these as arguments to the default <code>aes</code> function - instead, we have to parse the names within the dataframe’s environment (this is what the specialized <code>aes_string</code> function does). Again, in interactive contexts, the ability to easily manipulate figures with code is often highly desirable, and this makes NSE a hindrance (more on this later).<br />
</li>
<li>The package was developed before widespread adoption of the pipe operator <span class="citation">(both <code>%*%</code> from <code>magrittr</code>, <a href="#ref-bache2022">Bache and Wickham 2022</a>; and the native R <code>|&gt;</code> pipe, <a href="#ref-r2024">R Core Team 2024</a>)</span> and its use of the overloaded <code>+</code> operator is a noted design flaw <span class="citation">(see <a href="#ref-wickham2014">Wickham, Hadley 2014</a>)</span>.</li>
</ul>
<p>To address the single-plot focus limitation, a function-chaining approach similar to <code>ggplot2</code> was adopted, however, with a focus on multi-panel figure composition. Functions primarily target the entire figure, adding or removing plots. However, specialized functions with selectors can also be used to modify individual plots. To enable mutable figure modification while retaining the benefits of immutability, most functions accept both immutable schemas and references to live figures (details in the following section). Finally, non-standard evaluation was avoided altogether, and functions can be composed using any valid pipe operator (in my examples, I prefer the base R <code>|&gt;</code> operator).</p>
</div>
<div id="basic-example-of-plotscaper-code" class="section level3 hasAnchor" number="7.2.2">
<h3><span class="header-section-number">7.2.2</span> Basic example of <code>plotscaper</code> code<a href="system.html#basic-example-of-plotscaper-code" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The code below shows a basic example of an interactive figure. More advanced and realistic applications are shown in Section <a href="applied-example.html#applied-example">8</a>; this is example is only meant to provide a simple illustration of how interactive figures are built with <code>plotscaper</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="system.html#cb10-1" tabindex="-1"></a><span class="fu">library</span>(plotscaper)</span>
<span id="cb10-2"><a href="system.html#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="system.html#cb10-3" tabindex="-1"></a><span class="fu">create_schema</span>(mtcars) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="system.html#cb10-4" tabindex="-1"></a>  <span class="fu">add_scatterplot</span>(<span class="fu">c</span>(<span class="st">&quot;wt&quot;</span>, <span class="st">&quot;mpg&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a href="system.html#cb10-5" tabindex="-1"></a>  <span class="fu">add_barplot</span>(<span class="fu">c</span>(<span class="st">&quot;cyl&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a href="system.html#cb10-6" tabindex="-1"></a>  <span class="fu">set_scale</span>(<span class="st">&quot;plot1&quot;</span>, <span class="st">&quot;x&quot;</span>, <span class="at">min =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-7"><a href="system.html#cb10-7" tabindex="-1"></a>  <span class="fu">render</span>()</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:plotscaper-example1"></span>
<iframe src="./figures/plotscaper_example1.html" width="100%" height="400" data-external="1" style="border: none;">
</iframe>
<p class="caption">
Figure 7.1: An example of a simple interactive figure in <code>plotscaper</code>.
</p>
</div>
<p>We first initialize the figure schema by calling <code>create_schema()</code> with the input data. Next, we chain a series of <code>add_*()</code> calls, adding individual plots. Further, we can also manipulate attributes of individual plots, by using, for instance, the <code>set_scale()</code> function to set the lower x-axis limit of the scatterplot to zero. All of these functions append instructions to the schema (more on that later, in Section <a href="system.html#scene-and-schema">7.2.3</a>). Finally, the schema is instantiated into a figure via the call to <code>render()</code>. There are several features of this process that bear explaining.</p>
<div id="figure-vs.-plot-and-selectors" class="section level4 hasAnchor" number="7.2.2.1">
<h4><span class="header-section-number">7.2.2.1</span> Figure vs. plot and selectors<a href="system.html#figure-vs.-plot-and-selectors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>First, note that, as discussed in Section <a href="system.html#api-design">7.2.1</a>, all functions take as their first argument the entire figure and most also manipulate it, unlike in <code>ggplot2</code> where the first argument is typically the schema of a single plot (unless when faceting is used). Thus the fundamental object being manipulated is the entire figure, rather than a single plot. Consequently, this design also necessitates the use of selectors for targeting individual plots, as seen in the <code>set_scale()</code> call above. I decided to use a simple string selector for this purpose. While alternative selection strategies, such as overloading the extraction (<code>$</code>) operator or using a separate selector function were considered, these all presented their own sets of trade-offs. In the end, I found the string selector to be the simplest and most straightforward solution. However, this design choice is open to being revisited in future major releases of the package.</p>
</div>
<div id="variable-names" class="section level4 hasAnchor" number="7.2.2.2">
<h4><span class="header-section-number">7.2.2.2</span> Variable names<a href="system.html#variable-names" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Second, variable names are specified by simple string vectors. Formally, this means that the function arguments are <em>not</em> quoted (which is a bit unfortunate terminology since they <em>are</em> surrounded by quotation marks), i.e. in <code>plotscaper</code> we write <code>add_scatterplot(c("x", "y", "z"))</code> instead of <code>add_scatterplot(c(x, y, z))</code>. While this style may be less familiar to some R users, and it does mean that, generally, specifying an encoding does require two extra key strokes, I believe the simplicity of using <code>plotscaper</code> programmatically makes it a worthwhile trade-off. For instance, in <code>plotscaper</code>, we can easily create an interactive scatterplot matrix (SPLOM) like so:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="system.html#cb11-1" tabindex="-1"></a>column_names <span class="ot">&lt;-</span> <span class="fu">names</span>(mtcars)[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>)]</span>
<span id="cb11-2"><a href="system.html#cb11-2" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="fu">create_schema</span>(mtcars)</span>
<span id="cb11-3"><a href="system.html#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="system.html#cb11-4" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> column_names) {</span>
<span id="cb11-5"><a href="system.html#cb11-5" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> column_names) {</span>
<span id="cb11-6"><a href="system.html#cb11-6" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> j) schema <span class="ot">&lt;-</span> <span class="fu">add_histogram</span>(schema, <span class="fu">c</span>(i))</span>
<span id="cb11-7"><a href="system.html#cb11-7" tabindex="-1"></a>    <span class="cf">else</span> schema <span class="ot">&lt;-</span> <span class="fu">add_scatterplot</span>(schema, <span class="fu">c</span>(i, j))</span>
<span id="cb11-8"><a href="system.html#cb11-8" tabindex="-1"></a>  }</span>
<span id="cb11-9"><a href="system.html#cb11-9" tabindex="-1"></a>}</span>
<span id="cb11-10"><a href="system.html#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="system.html#cb11-11" tabindex="-1"></a>schema <span class="sc">|&gt;</span> <span class="fu">render</span>()</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:plotscaper-example2"></span>
<iframe src="./figures/plotscaper-example2.html" width="100%" height="800" data-external="1" style="border: none;">
</iframe>
<p class="caption">
Figure 7.2: An example of a programmatically-created figure (a scatterplot matrix).
</p>
</div>
<p>While Figure <a href="#plotscaper-example2"><strong>??</strong></a> could also be of course replicated with quotation/NSE, doing so may require knowledge of <a href="https://adv-r.hadley.nz/quasiquotation.html#quasiquotation">advanced R</a>. While it is the case that many R users are used to the style of calling functions with “naked” variable names, a lot fewer likely posses the ability to write and manipulate these functions effectively. Even more fundamentally, R’s NSE is a form of meta-programming <span class="citation">(<a href="#ref-wickham2019">Wickham 2019</a>)</span>, which, despite its power, is often discouraged due to its potential impact on performance, safety, and readability <span class="citation">(see e.g. <a href="#ref-phung2009">Phung, Sands, and Chudnov 2009</a>; the discussion at <a href="#ref-handmadehero2025">Handmade Hero 2025</a>)</span>. To encourage programmatic use of <code>plotscaper</code>, I chose simple string vectors over quoted arguments, as the inherent trade-off just did not seem worth it.</p>
</div>
<div id="variables-and-encodings" class="section level4 hasAnchor" number="7.2.2.3">
<h4><span class="header-section-number">7.2.2.3</span> Variables and encodings<a href="system.html#variables-and-encodings" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Third, note that, unlike in <code>ggplot2</code>, variable names are <em>not</em> meant to map directly to aesthetics such as x- or y-axis position or size. The reason for this is that, unlike <code>ggplot2</code>, <code>plotscaper</code> does not try to establish a direct correspondence between variables in the original data and the visual encodings/aesthetics. This is due to the fact that, in many common plot types, aesthetics do not represent variables found in the original data, but instead ones which have been derived in some way. Take, for instance, the following <code>ggplot()</code> call:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="system.html#cb12-1" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(<span class="at">x =</span> mpg)) <span class="sc">+</span></span>
<span id="cb12-2"><a href="system.html#cb12-2" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-6-1.png" width="100%" height="100%" style="border: none;" /></p>
<p>Overtly, it may seem as if the <code>aes</code> function simply maps the <code>mpg</code> variable to the x-axis. However, this is not correct. Specifically, what is actually mapped to the x-axis are the left and right edges of the histogram bins. These represent derived variables not found in the original data. Likewise, the y-axis variable represents counts within bins which are also a derived variable, and its mapping is created only implicitly. It is easier to see this lack of a direct correspondence when we set custom histogram breaks:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="system.html#cb14-1" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars) <span class="sc">+</span></span>
<span id="cb14-2"><a href="system.html#cb14-2" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> mpg), <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">35</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-7-1.png" width="100%" height="100%" style="border: none;" /></p>
<p>Now it is easier to see that what gets mapped to the x-axis is <em>not</em> the <code>mpg</code> variable, but instead a variable entirely external to the data: the histogram breaks. The <code>mpg</code> variable gets mapped to the plot only implicitly, by providing support for the binning. Thus, in <code>ggplot2</code>, the semantics of <code>aes(x = mpg, ...)</code> are completely different with <code>geom_histogram()</code> as compared to, for example, <code>geom_scatter()</code>.</p>
<p>This may seem like a minor nitpick, however, it is in fact a fundamental gap in the design. As discussed in Section <a href="problems.html#problems">4</a>, <code>ggplot2</code> is based on the Grammar of Graphics model <span class="citation">(<a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>, which centers around the idea of composing plots out of independent, modular components. The fact that the semantics of <code>aes()</code> are tied to the <code>geom</code> (and <code>stat</code>) means that the apparent modularity of <code>ggplot2</code> components is a mere illusion.</p>
<p>So what to do? To be perfectly frank, I do not have a perfect solution. In Section <a href="problems.html#problems">4</a>, I demonstrated that, in the general case involving transformation like stacking, <code>stats</code> and <code>geoms</code> <em>cannot</em> be truly independent. Ignoring that, the problem with specifying the aesthetics in a histogram is that, in some sense, we are putting the cart before the horse: ultimately, we want to plot derived variables, so we should specify these in the call to <code>aes()</code>, however, we do not know what these variables will be before we add <code>geom_histogram()</code>. So the schema should really be organized differently. As per Section <a href="problems.html#problems">4</a>, we could mirror the data visualization pipeline by doing something like:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="system.html#cb15-1" tabindex="-1"></a>data <span class="sc">|&gt;</span> <span class="fu">partition</span>(...) <span class="sc">|&gt;</span> <span class="fu">aggregate</span>(...) <span class="sc">|&gt;</span> <span class="fu">encode</span>(...) <span class="sc">|&gt;</span> <span class="fu">render</span>(...)</span></code></pre></div>
<p>In fact, in broad strokes, this is how the data visualization pipeline is implemented in <code>plotscape</code> (see Section <a href="system.html#low-level-implementation">7.3</a>).</p>
<p>However, this model does have one significant downside: it does not lend itself to a simple declarative schema like that of <code>ggplot2</code>. I have tried to coming up with such a schema, however, my efforts were largely unsuccessful. As a result, I opted in for the more traditional, nominal style of specifying plots in <code>plotscaper</code>, using the various <code>add_*</code> functions. While this style may seem less flexible, I hope I have made the case here that the underlying limitations are <em>not</em> an exclusive to <code>plotscape</code>/<code>plotscaper</code>, but extend to <code>ggplot2</code> and all other GoG-based data visualization systems. I have simply chosen to leave these limitations explicit, and again, if a solution is found, it can be integrated into future releases of the package.</p>
<p>A final point to mention is that, it could be argued that the benefit of the <code>ggplot2</code> model where partitioning and aggregation logic is implicitly tied to the <code>geom</code>s is that it makes it easier to mix different kinds of</p>
</div>
</div>
<div id="scene-and-schema" class="section level3 hasAnchor" number="7.2.3">
<h3><span class="header-section-number">7.2.3</span> The scene and the schema<a href="system.html#scene-and-schema" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A key part of the <code>plotscaper</code> API is the distinction between two classes of objects representing figures: schemas and scenes. Put simply, a schema is an immutable ledger or blueprint, while a scene is a live, rendered version of the figure. Both can be manipulated using (largely) the same set of functions/methods, however, what these functions actually do changes based on their target.</p>
<p>As shown before, schema can be created with the <code>create_schema()</code> function:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="system.html#cb16-1" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="fu">create_schema</span>(mtcars) <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="system.html#cb16-2" tabindex="-1"></a>  <span class="fu">add_scatterplot</span>(<span class="fu">c</span>(<span class="st">&quot;wt&quot;</span>, <span class="st">&quot;mpg&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="system.html#cb16-3" tabindex="-1"></a>  <span class="fu">add_barplot</span>(<span class="fu">c</span>(<span class="st">&quot;cyl&quot;</span>))</span>
<span id="cb16-4"><a href="system.html#cb16-4" tabindex="-1"></a></span>
<span id="cb16-5"><a href="system.html#cb16-5" tabindex="-1"></a>schema</span></code></pre></div>
<pre><code>## plotscaper schema:
## add-plot { type: scatter, variables: c(&quot;wt&quot;, &quot;mpg&quot;) }
## add-plot { type: bar, variables: cyl }</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="system.html#cb18-1" tabindex="-1"></a><span class="fu">str</span>(schema<span class="sc">$</span>queue)</span></code></pre></div>
<pre><code>## List of 2
##  $ :List of 2
##   ..$ type: chr &quot;add-plot&quot;
##   ..$ data:List of 3
##   .. ..$ type     : &#39;scalar&#39; chr &quot;scatter&quot;
##   .. ..$ variables: chr [1:2] &quot;wt&quot; &quot;mpg&quot;
##   .. ..$ id       : &#39;scalar&#39; chr &quot;0342fed7-5d50-4dd2-9a10-42c28381a5a1&quot;
##  $ :List of 2
##   ..$ type: chr &quot;add-plot&quot;
##   ..$ data:List of 3
##   .. ..$ type     : &#39;scalar&#39; chr &quot;bar&quot;
##   .. ..$ variables: chr &quot;cyl&quot;
##   .. ..$ id       : &#39;scalar&#39; chr &quot;b20db2ec-46dd-47e9-9150-a932941fef6a&quot;</code></pre>
<p>As you can see, the object created with <code>create_schema()</code> is essentially just a <code>list()</code> of messages. Modifying the schema by calling functions such as <code>add_scatterplot()</code> or <code>set_scale()</code> simply appends a new message to the list, similar to how objects of class <code>ggplot</code> are modified by the corresponding functions and the <code>+</code> operator in <code>ggplot2</code> <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span>. This design makes the schema easy to transport (e.g. as JSON) and modify programmatically. Finally, rendering the schema into a figure requires an explicit call to <code>render()</code>. Note that this approach is different from the popular style of implicit rendering (used in e.g. <code>ggplot2</code>), where an object is rendered via an overloaded <code>print()</code> method; however, there is a good reason for this which will be discussed later.</p>
<p>The call to <code>render()</code> turns the schema gets turned into a live, interactive figure by constructing an <code>htmlwidgets</code> widget <span class="citation">(<a href="#ref-htmlwidgets2021">Vaidyanathan et al. 2021</a>)</span>. This bundles up the underlying data and <code>plotscape</code> code (JavaScript, HTML, CSS) into a standalone widget which may get rendered inside, for example, RStudio viewer or RMarkdown document. All of the schema messages also get forwarded to the widget and applied sequentially, creating the figure.</p>
<p>Note that, under this model, the schema merely records state-generating steps, not the state itself, and all of the actual state lives on the scene. This design avoids state duplication between the R session (server) and web-browser-based figure (client), eliminating the need for synchronization. While this client-heavy approach deviates from typical client-server architectures, where state predominantly resides on the server, it is essential for achieving responsive interactive visualizations. By keeping most of the state and computation on the client and avoiding round-trips to the server, we can achieve fast updates in response to user interaction <span class="citation">(such as mouse movement during linked selection; this is also why features like linked selection tend to have poor performance in server-centric frameworks like Shiny, <a href="#ref-shiny2024">Chang et al. 2024</a>)</span>. Conversely, as will be discussed below, while the R session (server) may occasionally send and receive messages, these are by comparison much less latency-sensitive, making a “thin” server perfectly viable.</p>
</div>
<div id="communication" class="section level3 hasAnchor" number="7.2.4">
<h3><span class="header-section-number">7.2.4</span> Client-server communication<a href="system.html#communication" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>While inside an interactive R session (e.g., in RStudio IDE <span class="citation">(<a href="#ref-rstudio2024">Posit 2024</a>)</span>), creating a <code>plotscaper</code> figure via calling <code>render()</code> also automatically launches a WebSockets server <span class="citation">(using the <code>httpuv</code> package, <a href="#ref-cheng2024">Cheng et al. 2024</a>)</span>. This server allows for live, two-way communication between the R session (server) and the figure (client). By assigning the output of <code>render()</code> to a variable, users can save a handle to this server, and call functions which query the figure’s state or cause mutable, live updates. For instance:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="system.html#cb20-1" tabindex="-1"></a><span class="co"># The code in this chunk is NOT EVALUATED - </span></span>
<span id="cb20-2"><a href="system.html#cb20-2" tabindex="-1"></a><span class="co"># it only works only inside interactive R sessions,</span></span>
<span id="cb20-3"><a href="system.html#cb20-3" tabindex="-1"></a><span class="co"># not inside static RMarkdown/bookdown documents.</span></span>
<span id="cb20-4"><a href="system.html#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="system.html#cb20-5" tabindex="-1"></a>scene <span class="ot">&lt;-</span> <span class="fu">create_schema</span>(mtcars) <span class="sc">|&gt;</span></span>
<span id="cb20-6"><a href="system.html#cb20-6" tabindex="-1"></a>  <span class="fu">add_scatterplot</span>(<span class="fu">c</span>(<span class="st">&quot;wt&quot;</span>, <span class="st">&quot;mpg&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-7"><a href="system.html#cb20-7" tabindex="-1"></a>  <span class="fu">add_barplot</span>(<span class="fu">c</span>(<span class="st">&quot;cyl&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-8"><a href="system.html#cb20-8" tabindex="-1"></a>  <span class="fu">render</span>()</span>
<span id="cb20-9"><a href="system.html#cb20-9" tabindex="-1"></a></span>
<span id="cb20-10"><a href="system.html#cb20-10" tabindex="-1"></a><span class="co"># Render the scene</span></span>
<span id="cb20-11"><a href="system.html#cb20-11" tabindex="-1"></a>scene</span>
<span id="cb20-12"><a href="system.html#cb20-12" tabindex="-1"></a></span>
<span id="cb20-13"><a href="system.html#cb20-13" tabindex="-1"></a><span class="co"># Add a histogram, modifying the figure in-place</span></span>
<span id="cb20-14"><a href="system.html#cb20-14" tabindex="-1"></a>scene <span class="sc">|&gt;</span> <span class="fu">add_histogram</span>(<span class="fu">c</span>(<span class="st">&quot;disp&quot;</span>))</span>
<span id="cb20-15"><a href="system.html#cb20-15" tabindex="-1"></a></span>
<span id="cb20-16"><a href="system.html#cb20-16" tabindex="-1"></a><span class="co"># Set the scatterplot&#39;s lower x-axis limit to 0 (also in-place)</span></span>
<span id="cb20-17"><a href="system.html#cb20-17" tabindex="-1"></a>scene <span class="sc">|&gt;</span> <span class="fu">set_scale</span>(<span class="st">&quot;plot1&quot;</span>, <span class="st">&quot;x&quot;</span>, <span class="at">min =</span> <span class="dv">0</span>)</span>
<span id="cb20-18"><a href="system.html#cb20-18" tabindex="-1"></a></span>
<span id="cb20-19"><a href="system.html#cb20-19" tabindex="-1"></a><span class="co"># Select cases corresponding to rows 1 to 10</span></span>
<span id="cb20-20"><a href="system.html#cb20-20" tabindex="-1"></a>scene <span class="sc">|&gt;</span> <span class="fu">select_cases</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb20-21"><a href="system.html#cb20-21" tabindex="-1"></a></span>
<span id="cb20-22"><a href="system.html#cb20-22" tabindex="-1"></a><span class="co"># Query selected cases - returns the corresponding</span></span>
<span id="cb20-23"><a href="system.html#cb20-23" tabindex="-1"></a><span class="co"># as a numeric vector which can be used in other</span></span>
<span id="cb20-24"><a href="system.html#cb20-24" tabindex="-1"></a><span class="co"># functions or printed to the console</span></span>
<span id="cb20-25"><a href="system.html#cb20-25" tabindex="-1"></a>scene <span class="sc">|&gt;</span> <span class="fu">selected_cases</span>() <span class="co"># [1] 1 2 3 4 5 6 7 8 9 10</span></span></code></pre></div>
<p>As noted earlier, most <code>plotscaper</code> functions are polymorphic <code>S3</code> methods which can accept either a schema or a scene as the first argument. When called with schema as the first argument, they append a message to the schema, whereas when called with scene as the first argument (and while inside an interactive R session), they send a WebSockets request through the <code>httpuv</code> server, causing a live-update the figure or the server to respond back with data. In more abstract terms, with respect to these functions, the process of rendering a schema is a functor/homomorphism, meaning that we can either call the functions on the schema and then render it, or immediately render the figure and then call the functions, and the result will be the same (provided no user interaction happens in the meantime). The one exception to this rule are state-querying functions such as <code>selected_cases()</code>, <code>assigned_cases()</code>, and <code>get_scale()</code>. These functions send a request to retrieve the rendered figure’s state and so it makes little sense to call them on the schema<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
</div>
<div id="html-embedding" class="section level3 hasAnchor" number="7.2.5">
<h3><span class="header-section-number">7.2.5</span> HTML embedding<a href="system.html#html-embedding" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As <code>htmlwidgets</code> widgets, <code>plotscaper</code> figures are essentially static webpages. As such, they can be statically embedded in HTML documents such as those produced by RMarkdown <span class="citation">(<a href="#ref-rmarkdown2024">Allaire et al. 2024</a>)</span> or Quarto <span class="citation">(<a href="#ref-allaire2024">Allaire and Dervieux 2024</a>)</span>. More specifically, when a <code>plotscaper</code> figure is rendered, <code>htmlwidgets</code> <span class="citation">(<a href="#ref-htmlwidgets2021">Vaidyanathan et al. 2021</a>)</span> is used to bundle the underlying HTML, CSS and JavaScript. The resulting widget can then be statically embedded in any valid HTML document, or saved as a standalone HTML file using the <code>htlwidgets::saveWidget</code> function. This is in fact how <code>plotscaper</code> figures are rendered in the present thesis.</p>
<p>As mentioned above, since client-server communication requires a running server, statically rendered figures cannot be interacted with through code, in the way described in Section <a href="system.html#communication">7.2.4</a>. However, within-figure interactive features such as linked selection and querying are entirely client-side, and as such work perfectly fine in static environments. This makes <code>plotscaper</code> a very useful and convenient tool to use in interactive reports.</p>
</div>
</div>
<div id="low-level-implementation" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Low-level implementation (<code>plotscape</code>)<a href="system.html#low-level-implementation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This section describes the actual platform used to produce and manipulate interactive figures, as implemented in <code>plotscape</code>. I first discuss some key implementation details, including reactivity and rendering. Then I provide a detailed listing of the system’s components and their functionality.</p>
<p>Key concepts are explained via example code chunks. All of these represent valid TypeScript code, and selected examples are even evaluated, using the <a href="https://bun.sh/">Bun</a> runtime <span class="citation">(<a href="#ref-bun2025"><span>“<span>Bun</span>”</span> 2025</a>)</span>. The reason why TypeScript was chosen over R is that many of the examples are much clearer with explicit type signatures. Further, since <code>plotscape</code> is written in TypeScript, many of the examples are taken directly from the codebase, albeit sometimes modified for consistency or conciseness.</p>
<p>A note on the coding style used in the examples. Many of the code examples use TypeScript’s <code>namespace</code> feature to bundle related functionality together, similar to how a class bundles data and behaviour together in object-orient programming (OOP), however, unlike in OOP, the namespace serves purely as a static container unlike a class which has to be instantiated<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>. Further, alongside a given namespace, many examples also include a type (<code>interface</code>) of the same name. TypeScript allows type and value overloading, such that a type (e.g. <code>interface Foo {}</code>) and a runtime variable (<code>const Foo = 123</code>) with the same name can exist simultaneously, within the same scope. Namespaces are runtime variables and so they do not clash with types names.</p>
<p>This type-namespace style may seem like object-oriented programming (OOP) with extra steps, i.e. where someone might write <code>const foo = new Foo(); const bar = foo.bar()</code>, I write <code>const foo = Foo.create(); const bar = Foo.bar(foo)</code>, however, I did choose this style for a reason. First, thanks to TypeScript’s structural typing, the functions exported from a namespace can be called with <em>any</em> variables that match type signature, not just class instances. This greatly increases code reusability. Second, this approach also promotes functions that operate on plain data, which simplifies reasoning: data and code can be considered separately, and one can exist perfectly fine in the absence of the other<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>. Finally, this data-oriented approach also avoids a hidden cost of OOP: to support runtime polymorphism, class instances have to store pointers to virtual method tables, increasing their size and the potential for cache misses. Plain data structures are often more performant when polymorphism is not required, and in the specific situations where it is, alternative runtime dispatch methods can still be implemented. Thus, for these reasons, I chose to use this style when implementing <code>plotscape</code> and use it here as well for consistency.</p>
<div id="reactivity-1" class="section level3 hasAnchor" number="7.3.1">
<h3><span class="header-section-number">7.3.1</span> Reactivity<a href="system.html#reactivity-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A key implementation detail of all interactive applications is reactivity: how a system responds to input and propagates changes. However, despite the fact that interactive user interfaces (UIs) have been around for a long time, there still exist many different, competing approaches to handling reactivity. A particularly famous<a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a> example of this is the web ecosystem, where new UI frameworks seem to keep emerging all the time, each offering its unique spin on reactivity <span class="citation">(see e.g. <a href="#ref-ollila2022">Ollila, Mäkitalo, and Mikkonen 2022</a>)</span>. This makes choosing the right reactivity model challenging.</p>
<p>Furthermore, reactivity is paramount in interactive data visualization systems due to many user interactions having cascading effects. For instance, when a user changes the binwidth of an interactive histogram, the counts within the bins need to be recomputed, which in turn means that scales may need to be updated, which in turn means that the entire figure may need to be re-rendered, and so on. Also, unlike other types of UI applications, interactive data visualizations have no upper bound on the number of UI elements - the more data the user can visualize the better. This makes efficient updates crucial. While re-rendering a button twice may not be a big deal for a simple webpage or GUI application, unnecessary re-renders of a scatterplot with tens-of-thousands of data points may cripple an interactive data visualization system.</p>
<p>Because of the reasons outlined above, reactivity was key concern for <code>plotscape</code>. While developing the package, I had evaluated and tried out several different reactivity models, before finally settling on a solution. Given the time and effort invested in this process, I believe it is valuable to give a brief overview of these models and discuss their inherent advantages and disadvantages, before presenting my chosen approach in Section <a href="system.html#reactivity-solution">7.3.1.5</a>.</p>
<div id="observer" class="section level4 hasAnchor" number="7.3.1.1">
<h4><span class="header-section-number">7.3.1.1</span> Observer pattern<a href="system.html#observer" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One of the simplest and most well-known methods for modeling reactivity is the Observer pattern <span class="citation">(<a href="#ref-gamma1995">Gamma et al. 1995</a>)</span>. Here’s a simple implementation:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb21-1"><a href="system.html#cb21-1" tabindex="-1"></a><span class="co">// Observer.ts</span></span>
<span id="cb21-2"><a href="system.html#cb21-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Observer</span> {</span>
<span id="cb21-3"><a href="system.html#cb21-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">create</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T)<span class="op">:</span> T <span class="op">&amp;</span> Observer {</span>
<span id="cb21-4"><a href="system.html#cb21-4" tabindex="-1"></a>    <span class="cf">return</span> { <span class="op">...</span>x<span class="op">,</span> listeners<span class="op">:</span> {} }<span class="op">;</span></span>
<span id="cb21-5"><a href="system.html#cb21-5" tabindex="-1"></a>  }</span>
<span id="cb21-6"><a href="system.html#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="system.html#cb21-7" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">listen</span>(x<span class="op">:</span> Observer<span class="op">,</span> event<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> callback<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dt">void</span>) {</span>
<span id="cb21-8"><a href="system.html#cb21-8" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>]) x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb21-9"><a href="system.html#cb21-9" tabindex="-1"></a>    x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>]<span class="op">.</span><span class="fu">push</span>(callback)<span class="op">;</span></span>
<span id="cb21-10"><a href="system.html#cb21-10" tabindex="-1"></a>  }</span>
<span id="cb21-11"><a href="system.html#cb21-11" tabindex="-1"></a></span>
<span id="cb21-12"><a href="system.html#cb21-12" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">dispatch</span>(x<span class="op">:</span> Observer<span class="op">,</span> event<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb21-13"><a href="system.html#cb21-13" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span>x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>]) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb21-14"><a href="system.html#cb21-14" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> cb <span class="kw">of</span> x<span class="op">.</span><span class="at">listeners</span>[<span class="bu">event</span>]) <span class="fu">cb</span>()<span class="op">;</span></span>
<span id="cb21-15"><a href="system.html#cb21-15" tabindex="-1"></a>  }</span>
<span id="cb21-16"><a href="system.html#cb21-16" tabindex="-1"></a>}</span>
<span id="cb21-17"><a href="system.html#cb21-17" tabindex="-1"></a></span>
<span id="cb21-18"><a href="system.html#cb21-18" tabindex="-1"></a><span class="kw">const</span> person <span class="op">=</span> Observer<span class="op">.</span><span class="fu">create</span>({ name<span class="op">:</span> <span class="vs">`Joe`</span><span class="op">,</span> age<span class="op">:</span> <span class="dv">25</span> })<span class="op">;</span></span>
<span id="cb21-19"><a href="system.html#cb21-19" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">listen</span>(person<span class="op">,</span> <span class="vs">`age-increased`</span><span class="op">,</span> () <span class="kw">=&gt;</span></span>
<span id="cb21-20"><a href="system.html#cb21-20" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>person<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> is now </span><span class="sc">${</span>person<span class="op">.</span><span class="at">age</span><span class="sc">}</span><span class="vs"> years old.`</span>)</span>
<span id="cb21-21"><a href="system.html#cb21-21" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb21-22"><a href="system.html#cb21-22" tabindex="-1"></a></span>
<span id="cb21-23"><a href="system.html#cb21-23" tabindex="-1"></a>person<span class="op">.</span><span class="at">age</span> <span class="op">=</span> <span class="dv">26</span><span class="op">;</span></span>
<span id="cb21-24"><a href="system.html#cb21-24" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">dispatch</span>(person<span class="op">,</span> <span class="vs">`age-increased`</span>)<span class="op">;</span></span></code></pre></div>
<pre><code>## Joe is now 26 years old.</code></pre>
<p>Internally, an <code>Observer</code> object stores a dictionary where the keys are the events that the object can dispatch or notify its listeners of, and values are arrays of callbacks<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a>. Listeners listen (or “subscribe”) to specific events by adding their callbacks to the relevant array. When an event occurs, the callbacks in the appropriate array are iterated through and executed in order.</p>
<p>The <code>Observer</code> pattern easy to implement and understand, and, compared to alternatives, also tends to be fairly performant. However, a key downside is that the listeners have to subscribe to the <code>Observer</code> manually. In other words, whenever client code uses <code>Observer</code> values, it needs to be aware of this fact and subscribe to them in order to avoid becoming stale. Further, the logic for synchronizing updates has to be implemented manually as well. For instance, by default, there is no mechanism for handling dispatch order: the listeners who were subscribed earlier in the code are called first<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a>. Moreover, shared dependencies can cause glitches and these have to be resolved manually as well. See for instance the following example:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb23-1"><a href="system.html#cb23-1" tabindex="-1"></a><span class="im">import</span> { Observer } <span class="im">from</span> <span class="st">&quot;./Observer&quot;</span></span>
<span id="cb23-2"><a href="system.html#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="system.html#cb23-3" tabindex="-1"></a><span class="kw">function</span> <span class="fu">update</span>(x<span class="op">:</span> { name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span> value<span class="op">:</span> <span class="dt">number</span> } <span class="op">&amp;</span> Observer<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb23-4"><a href="system.html#cb23-4" tabindex="-1"></a>  x<span class="op">.</span><span class="at">value</span> <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb23-5"><a href="system.html#cb23-5" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>x<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> updated to`</span><span class="op">,</span> x<span class="op">.</span><span class="at">value</span>)<span class="op">;</span></span>
<span id="cb23-6"><a href="system.html#cb23-6" tabindex="-1"></a>  Observer<span class="op">.</span><span class="fu">dispatch</span>(x<span class="op">,</span> <span class="vs">`updated`</span>)<span class="op">;</span></span>
<span id="cb23-7"><a href="system.html#cb23-7" tabindex="-1"></a>}</span>
<span id="cb23-8"><a href="system.html#cb23-8" tabindex="-1"></a></span>
<span id="cb23-9"><a href="system.html#cb23-9" tabindex="-1"></a><span class="kw">const</span> A <span class="op">=</span> Observer<span class="op">.</span><span class="fu">create</span>({ name<span class="op">:</span> <span class="vs">`A`</span><span class="op">,</span> value<span class="op">:</span> <span class="dv">1</span> })<span class="op">;</span></span>
<span id="cb23-10"><a href="system.html#cb23-10" tabindex="-1"></a><span class="kw">const</span> B <span class="op">=</span> Observer<span class="op">.</span><span class="fu">create</span>({ name<span class="op">:</span> <span class="vs">`B`</span><span class="op">,</span> value<span class="op">:</span> A<span class="op">.</span><span class="at">value</span> <span class="op">*</span> <span class="dv">10</span> })<span class="op">;</span></span>
<span id="cb23-11"><a href="system.html#cb23-11" tabindex="-1"></a><span class="kw">const</span> C <span class="op">=</span> Observer<span class="op">.</span><span class="fu">create</span>({ name<span class="op">:</span> <span class="vs">`C`</span><span class="op">,</span> value<span class="op">:</span> A<span class="op">.</span><span class="at">value</span> <span class="op">+</span> B<span class="op">.</span><span class="at">value</span> })<span class="op">;</span></span>
<span id="cb23-12"><a href="system.html#cb23-12" tabindex="-1"></a></span>
<span id="cb23-13"><a href="system.html#cb23-13" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">listen</span>(A<span class="op">,</span> <span class="vs">`updated`</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="fu">update</span>(B<span class="op">,</span> A<span class="op">.</span><span class="at">value</span> <span class="op">*</span> <span class="dv">10</span>))<span class="op">;</span></span>
<span id="cb23-14"><a href="system.html#cb23-14" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">listen</span>(A<span class="op">,</span> <span class="vs">`updated`</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="fu">update</span>(C<span class="op">,</span> A<span class="op">.</span><span class="at">value</span> <span class="op">+</span> B<span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb23-15"><a href="system.html#cb23-15" tabindex="-1"></a>Observer<span class="op">.</span><span class="fu">listen</span>(B<span class="op">,</span> <span class="vs">`updated`</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="fu">update</span>(C<span class="op">,</span> A<span class="op">.</span><span class="at">value</span> <span class="op">+</span> B<span class="op">.</span><span class="at">value</span>))<span class="op">;</span></span>
<span id="cb23-16"><a href="system.html#cb23-16" tabindex="-1"></a></span>
<span id="cb23-17"><a href="system.html#cb23-17" tabindex="-1"></a><span class="fu">update</span>(A<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span> <span class="co">// C will get updated twice</span></span></code></pre></div>
<pre><code>## Joe is now 26 years old.
## A updated to 2
## B updated to 20
## C updated to 22
## C updated to 22</code></pre>
<p>The example above shows what is in reactive programming known as the diamond problem. We have three reactive variables <code>A</code>, <code>B</code>, and <code>C</code>, such that <code>B</code> depends on <code>A</code>, and <code>C</code> depends simultaneously on <code>A</code> and <code>B</code>. Since <code>C</code> depends on <code>A</code> and <code>B</code>, it has to subscribe to both. However, <code>C</code> is not aware of the global context of the reactive graph: it does not know that <code>B</code> will update any time <code>A</code> does. As such, an update to <code>A</code> will trigger <em>two</em> updates to <code>C</code> despite the fact that, intuitively, it should only cause one.</p>
<p>Without careful management of dependencies, this reactive graph myopia that the <code>Observer</code> pattern exhibits can create computational bottlenecks, particularly in high-throughput UIs such as interactive data visualizations. Consider an interactive histogram where users can either modify binwidth or directly set breaks. If both are implemented as reactive parameters, a poorly managed dependency graph (e.g., breaks dependent on binwidth, and rendering dependent on both) will result in unnecessary re-renders, impacting performance at high data volumes.</p>
</div>
<div id="streams" class="section level4 hasAnchor" number="7.3.1.2">
<h4><span class="header-section-number">7.3.1.2</span> Streams<a href="system.html#streams" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A radically different approach to reactivity is offered by streams <span class="citation">(see e.g. <a href="#ref-abelson2022">Abelson and Sussman 2022</a>)</span>. Instead of events directly modifying data state, streams separate event generation from event processing, modeling the latter as pure, primarily side-effect-free transformations. These transformations can then be composed via usual function composition to build arbitrarily complex processing logic. Finally, due to the separation between the stateful event producers and stateless event transformations, this approach aligns closely with methods such as generators/iterators as well as functional programming more broadly <span class="citation">(<a href="#ref-abelson2022">Abelson and Sussman 2022</a>; <a href="#ref-fogus2013">Fogus 2013</a>)</span>, and has implementations in numerous functional programming languages and libraries, most notably the polyglot Reactive Extensions library <span class="citation">(also known as ReactiveX, <a href="#ref-reactive2024">Rxteam 2024</a>)</span>.</p>
<p>Consider the following implementation of a stream which produces values at 200-millisecond intervals and stops after 1 second:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb25-1"><a href="system.html#cb25-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">intervalSteam</span>(milliseconds<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> stopTime<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb25-2"><a href="system.html#cb25-2" tabindex="-1"></a>  <span class="kw">let</span> streamfn <span class="op">=</span> (x<span class="op">:</span> <span class="dt">unknown</span>) <span class="kw">=&gt;</span> x<span class="op">;</span></span>
<span id="cb25-3"><a href="system.html#cb25-3" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> { pipe }<span class="op">;</span></span>
<span id="cb25-4"><a href="system.html#cb25-4" tabindex="-1"></a></span>
<span id="cb25-5"><a href="system.html#cb25-5" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pipe</span>(fn<span class="op">:</span> (x<span class="op">:</span> <span class="dt">any</span>) <span class="kw">=&gt;</span> <span class="dt">unknown</span>) {</span>
<span id="cb25-6"><a href="system.html#cb25-6" tabindex="-1"></a>    <span class="kw">const</span> oldStreamfn <span class="op">=</span> streamfn<span class="op">;</span></span>
<span id="cb25-7"><a href="system.html#cb25-7" tabindex="-1"></a>    streamfn <span class="op">=</span> (x<span class="op">:</span> <span class="dt">unknown</span>) <span class="kw">=&gt;</span> <span class="fu">fn</span>(<span class="fu">oldStreamfn</span>(x))<span class="op">;</span></span>
<span id="cb25-8"><a href="system.html#cb25-8" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb25-9"><a href="system.html#cb25-9" tabindex="-1"></a>  }</span>
<span id="cb25-10"><a href="system.html#cb25-10" tabindex="-1"></a></span>
<span id="cb25-11"><a href="system.html#cb25-11" tabindex="-1"></a>  <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb25-12"><a href="system.html#cb25-12" tabindex="-1"></a>  <span class="kw">let</span> time <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb25-13"><a href="system.html#cb25-13" tabindex="-1"></a></span>
<span id="cb25-14"><a href="system.html#cb25-14" tabindex="-1"></a>  <span class="kw">const</span> interval <span class="op">=</span> <span class="pp">setInterval</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb25-15"><a href="system.html#cb25-15" tabindex="-1"></a>    time <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb25-16"><a href="system.html#cb25-16" tabindex="-1"></a>    <span class="kw">const</span> diff <span class="op">=</span> time <span class="op">-</span> startTime<span class="op">;</span></span>
<span id="cb25-17"><a href="system.html#cb25-17" tabindex="-1"></a>    <span class="cf">if</span> (diff <span class="op">&gt;=</span> stopTime) <span class="pp">clearInterval</span>(interval)<span class="op">;</span></span>
<span id="cb25-18"><a href="system.html#cb25-18" tabindex="-1"></a>    <span class="fu">streamfn</span>(diff)<span class="op">;</span></span>
<span id="cb25-19"><a href="system.html#cb25-19" tabindex="-1"></a>  }<span class="op">,</span> milliseconds)<span class="op">;</span></span>
<span id="cb25-20"><a href="system.html#cb25-20" tabindex="-1"></a></span>
<span id="cb25-21"><a href="system.html#cb25-21" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb25-22"><a href="system.html#cb25-22" tabindex="-1"></a>}</span>
<span id="cb25-23"><a href="system.html#cb25-23" tabindex="-1"></a></span>
<span id="cb25-24"><a href="system.html#cb25-24" tabindex="-1"></a><span class="kw">const</span> stream <span class="op">=</span> <span class="fu">intervalSteam</span>(<span class="dv">200</span><span class="op">,</span> <span class="dv">1000</span>)</span>
<span id="cb25-25"><a href="system.html#cb25-25" tabindex="-1"></a></span>
<span id="cb25-26"><a href="system.html#cb25-26" tabindex="-1"></a></span>
<span id="cb25-27"><a href="system.html#cb25-27" tabindex="-1"></a>stream</span>
<span id="cb25-28"><a href="system.html#cb25-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">pipe</span>((x) <span class="kw">=&gt;</span> [x<span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>((x <span class="op">/</span> <span class="dv">7</span>) <span class="op">*</span> <span class="dv">100</span>) <span class="op">/</span> <span class="dv">100</span>])</span>
<span id="cb25-29"><a href="system.html#cb25-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">pipe</span>((x) <span class="kw">=&gt;</span></span>
<span id="cb25-30"><a href="system.html#cb25-30" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(</span>
<span id="cb25-31"><a href="system.html#cb25-31" tabindex="-1"></a>      <span class="vs">`</span><span class="sc">${</span>x[<span class="dv">0</span>]<span class="sc">}</span><span class="vs"> milliseconds has elapsed (</span><span class="sc">${</span>x[<span class="dv">1</span>]<span class="sc">}</span><span class="vs"> milliseconds in dog years)`</span></span>
<span id="cb25-32"><a href="system.html#cb25-32" tabindex="-1"></a>    )</span>
<span id="cb25-33"><a href="system.html#cb25-33" tabindex="-1"></a>  )<span class="op">;</span></span></code></pre></div>
<pre><code>## 202 milliseconds has elapsed (28.86 milliseconds in dog years)
## 401 milliseconds has elapsed (57.29 milliseconds in dog years)
## 602 milliseconds has elapsed (86 milliseconds in dog years)
## 802 milliseconds has elapsed (114.57 milliseconds in dog years)
## 1003 milliseconds has elapsed (143.29 milliseconds in dog years)</code></pre>
<p>As you can see, the event producer (stream) is defined separately from the event processing logic, which is constructed by piping the result of one operation into the next. Because of the associativity of function composition, the stream actually exhibits properties of a functor, meaning that the order of composition - either through direct function composition or <code>.pipe()</code> chaining - does not affect the result. Additionally, while the stream transformations themselves are (generally) stateless, they can still produce useful side-effects (as can be seen on the example of the <code>console.log</code> call above). Further, because of this fact, they also lend themselves well to modeling asynchronous or even infinite data sequences <span class="citation">(<a href="#ref-abelson2022">Abelson and Sussman 2022</a>; <a href="#ref-fogus2013">Fogus 2013</a>)</span>.</p>
<p>While streams can be extremely useful in specific circumstances, their utility as a general model for complex UIs (beyond asynchronous operations) is debatable. Specifically, the inherent statefulness of UIs conflicts with the stateless nature of streams: stateless computations inside the stream have to leak into the rest of the application <em>somewhere</em>. Delineating which parts of the logic should go into streams versus which should be bound to UI components complicates development for little real benefit. Consequently, streams are likely not the optimal choice for interactive data visualization, where some state is unavoidable.</p>
</div>
<div id="virtual-dom" class="section level4 hasAnchor" number="7.3.1.3">
<h4><span class="header-section-number">7.3.1.3</span> Virtual DOM<a href="system.html#virtual-dom" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Within the web ecosystem, a common way of handling reactivity involves something called the virtual DOM (VDOM). This approach, popularized by web frameworks such as React <span class="citation">(<a href="#ref-react2024">Meta 2024</a>)</span> and Vue <span class="citation">(<a href="#ref-vue2024">Evan You and the Vue Core Team 2024</a>)</span>, involves constructing an independent in-memory tree structure which provides a virtual representation of the UI. Reactive events are bound to nodes or “components” of this tree. Whenever an event occurs, changes cascade throughout the VDOM, starting with the associated component and propagating down through its children. Finally, the VDOM is compared or “diffed” against the actual UI, and only the necessary updates are applied. Note that, despite being named after the web’s DOM, the VDOM is a general concept, not tied to any specific programming environment.</p>
<p>The VDOM provides a simple and convenient solution to reactive graph challenges such as the diamond problem described in Section <a href="system.html#observer">7.3.1.1</a>, as evidenced by the massive popularity of web frameworks such as React or Vue. However, compared to alternatives, it also presents some significant performance trade-offs. Specifically, events near the root component trigger a cascade of updates which propagates throughout a large portion of the tree, even when there is no direct dependence between these events and the child components. Moreover, since the only way for two components to share a piece of state is through their parent, the model naturally encourages a top-heavy hierarchy, further compounding the issue. Finally, depending on the nature and implementation of the UI, the diffing process may be more trouble than its worth: while in a webpage, updating a button or two is a fast operation, in a data visualization system, it may be more efficient to re-render an entire scatterplot from scratch rather than trying to update select few points.</p>
</div>
<div id="signals" class="section level4 hasAnchor" number="7.3.1.4">
<h4><span class="header-section-number">7.3.1.4</span> Signals<a href="system.html#signals" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Another approach to reactivity that has been steadily gaining traction over the recent years, particularly within the web ecosystem, are signals (also known as fine-grained reactivity). Popularized by frameworks such Knockout <span class="citation">(<a href="#ref-knockout2019">knockoutjs 2019</a>)</span> and more recently Solid JS <span class="citation">(<a href="#ref-solid2024">Solid Core Team 2025</a>)</span>, this approach has recently seen a wave adoptions by many other frameworks including Svelte <span class="citation">(<a href="#ref-svelte2024">Rich Harris and the Svelte Core Team 2024</a>)</span> and Angular <span class="citation">(<a href="#ref-angular2025">Google 2025</a>)</span>, and has even seen adoption outside of the JavaScript ecosystem, such as in the Rust-based framework Leptos <span class="citation">(<a href="#ref-leptos2025">Leptos Core Team 2025</a>)</span>.</p>
<p>Signal-based reactivity is built around a core pair of primitives: signals and effects. Signals are reactive values which keep track of their listeners, similar to the <code>Observer</code> pattern (Section <a href="system.html#observer">7.3.1.1</a>). However, unlike <code>Observer</code>s, signals do not need to be subscribed to manually. Instead, listeners automatically subscribe to signals by accessing them, which is where effects come in. Effects are side-effect-causing functions which respond to signal changes, typically by updating the UI, and play a key role in the signal-based automatic subscription model.</p>
<p>While signal-based reactivity might appear complex, its basic implementation is surprisingly straightforward. The following example is based on a presentation by Ryan Carniato, the creator of Solid JS <span class="citation">(<a href="#ref-carniato2023">2023</a>)</span>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb27-1"><a href="system.html#cb27-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Signal</span> {</span>
<span id="cb27-2"><a href="system.html#cb27-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">create</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T)<span class="op">:</span> [() <span class="kw">=&gt;</span> T<span class="op">,</span> (value<span class="op">:</span> T) <span class="kw">=&gt;</span> <span class="dt">void</span>] {</span>
<span id="cb27-3"><a href="system.html#cb27-3" tabindex="-1"></a>    <span class="co">// A set of listeners, similar to Observable</span></span>
<span id="cb27-4"><a href="system.html#cb27-4" tabindex="-1"></a>    <span class="kw">const</span> listeners <span class="op">=</span> <span class="kw">new</span> <span class="bu">Set</span><span class="op">&lt;</span>() <span class="kw">=&gt;</span> <span class="dt">void</span><span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb27-5"><a href="system.html#cb27-5" tabindex="-1"></a></span>
<span id="cb27-6"><a href="system.html#cb27-6" tabindex="-1"></a>    <span class="kw">function</span> <span class="kw">get</span>()<span class="op">:</span> T {</span>
<span id="cb27-7"><a href="system.html#cb27-7" tabindex="-1"></a>      listeners<span class="op">.</span><span class="fu">add</span>(Effect<span class="op">.</span><span class="fu">getCurrent</span>())<span class="op">;</span></span>
<span id="cb27-8"><a href="system.html#cb27-8" tabindex="-1"></a>      <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb27-9"><a href="system.html#cb27-9" tabindex="-1"></a>    }</span>
<span id="cb27-10"><a href="system.html#cb27-10" tabindex="-1"></a></span>
<span id="cb27-11"><a href="system.html#cb27-11" tabindex="-1"></a>    <span class="kw">function</span> <span class="kw">set</span>(value<span class="op">:</span> T) {</span>
<span id="cb27-12"><a href="system.html#cb27-12" tabindex="-1"></a>      x <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb27-13"><a href="system.html#cb27-13" tabindex="-1"></a>      <span class="cf">for</span> (<span class="kw">const</span> l <span class="kw">of</span> listeners) <span class="fu">l</span>()<span class="op">;</span></span>
<span id="cb27-14"><a href="system.html#cb27-14" tabindex="-1"></a>    }</span>
<span id="cb27-15"><a href="system.html#cb27-15" tabindex="-1"></a></span>
<span id="cb27-16"><a href="system.html#cb27-16" tabindex="-1"></a>    <span class="co">// Returns a getter-setter pair</span></span>
<span id="cb27-17"><a href="system.html#cb27-17" tabindex="-1"></a>    <span class="cf">return</span> [<span class="kw">get</span><span class="op">,</span> <span class="kw">set</span>]<span class="op">;</span></span>
<span id="cb27-18"><a href="system.html#cb27-18" tabindex="-1"></a>  }</span>
<span id="cb27-19"><a href="system.html#cb27-19" tabindex="-1"></a>}</span>
<span id="cb27-20"><a href="system.html#cb27-20" tabindex="-1"></a></span>
<span id="cb27-21"><a href="system.html#cb27-21" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Effect</span> {</span>
<span id="cb27-22"><a href="system.html#cb27-22" tabindex="-1"></a>  <span class="kw">const</span> effectStack <span class="op">=</span> [] <span class="im">as</span> (() <span class="kw">=&gt;</span> <span class="dt">void</span>)[]<span class="op">;</span> <span class="co">// A stack of effects</span></span>
<span id="cb27-23"><a href="system.html#cb27-23" tabindex="-1"></a></span>
<span id="cb27-24"><a href="system.html#cb27-24" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">getCurrent</span>()<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dt">void</span> {</span>
<span id="cb27-25"><a href="system.html#cb27-25" tabindex="-1"></a>    <span class="cf">return</span> effectStack[effectStack<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb27-26"><a href="system.html#cb27-26" tabindex="-1"></a>  }</span>
<span id="cb27-27"><a href="system.html#cb27-27" tabindex="-1"></a></span>
<span id="cb27-28"><a href="system.html#cb27-28" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">create</span>(effectfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dt">void</span>) {</span>
<span id="cb27-29"><a href="system.html#cb27-29" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">execute</span>() {</span>
<span id="cb27-30"><a href="system.html#cb27-30" tabindex="-1"></a>      effectStack<span class="op">.</span><span class="fu">push</span>(execute)<span class="op">;</span>  <span class="co">// Pushes itself onto the stack</span></span>
<span id="cb27-31"><a href="system.html#cb27-31" tabindex="-1"></a>      <span class="fu">effectfn</span>()<span class="op">;</span>                 <span class="co">// Runs the effect</span></span>
<span id="cb27-32"><a href="system.html#cb27-32" tabindex="-1"></a>      effectStack<span class="op">.</span><span class="fu">pop</span>()<span class="op">;</span>          <span class="co">// Pops itself off the stack</span></span>
<span id="cb27-33"><a href="system.html#cb27-33" tabindex="-1"></a>    }</span>
<span id="cb27-34"><a href="system.html#cb27-34" tabindex="-1"></a></span>
<span id="cb27-35"><a href="system.html#cb27-35" tabindex="-1"></a>    <span class="fu">execute</span>()<span class="op">;</span></span>
<span id="cb27-36"><a href="system.html#cb27-36" tabindex="-1"></a>  }</span>
<span id="cb27-37"><a href="system.html#cb27-37" tabindex="-1"></a>}</span>
<span id="cb27-38"><a href="system.html#cb27-38" tabindex="-1"></a></span>
<span id="cb27-39"><a href="system.html#cb27-39" tabindex="-1"></a><span class="kw">const</span> [price<span class="op">,</span> setPrice] <span class="op">=</span> Signal<span class="op">.</span><span class="fu">create</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb27-40"><a href="system.html#cb27-40" tabindex="-1"></a><span class="kw">const</span> [tax<span class="op">,</span> setTax] <span class="op">=</span> Signal<span class="op">.</span><span class="fu">create</span>(<span class="fl">0.15</span>)<span class="op">;</span></span>
<span id="cb27-41"><a href="system.html#cb27-41" tabindex="-1"></a><span class="kw">const</span> priceWithTax <span class="op">=</span> () <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(<span class="fu">price</span>() <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fu">tax</span>()) <span class="op">*</span> <span class="dv">100</span>) <span class="op">/</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb27-42"><a href="system.html#cb27-42" tabindex="-1"></a><span class="co">// ^ Derived values automatically become signals as well</span></span>
<span id="cb27-43"><a href="system.html#cb27-43" tabindex="-1"></a></span>
<span id="cb27-44"><a href="system.html#cb27-44" tabindex="-1"></a>Effect<span class="op">.</span><span class="fu">create</span>(() <span class="kw">=&gt;</span></span>
<span id="cb27-45"><a href="system.html#cb27-45" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(</span>
<span id="cb27-46"><a href="system.html#cb27-46" tabindex="-1"></a>    <span class="vs">`The current price is`</span> <span class="op">+</span></span>
<span id="cb27-47"><a href="system.html#cb27-47" tabindex="-1"></a>      <span class="vs">`</span><span class="sc">${</span><span class="fu">priceWithTax</span>()<span class="sc">}</span><span class="vs">`</span> <span class="op">+</span></span>
<span id="cb27-48"><a href="system.html#cb27-48" tabindex="-1"></a>      <span class="vs">`(</span><span class="sc">${</span><span class="fu">price</span>()<span class="sc">}</span><span class="vs"> before </span><span class="sc">${</span><span class="fu">tax</span>() <span class="op">*</span> <span class="dv">100</span><span class="sc">}</span><span class="vs">% tax)`</span></span>
<span id="cb27-49"><a href="system.html#cb27-49" tabindex="-1"></a>  )</span>
<span id="cb27-50"><a href="system.html#cb27-50" tabindex="-1"></a>)<span class="op">;</span></span>
<span id="cb27-51"><a href="system.html#cb27-51" tabindex="-1"></a></span>
<span id="cb27-52"><a href="system.html#cb27-52" tabindex="-1"></a><span class="fu">setPrice</span>(<span class="dv">200</span>)<span class="op">;</span></span>
<span id="cb27-53"><a href="system.html#cb27-53" tabindex="-1"></a><span class="fu">setTax</span>(<span class="fl">0.12</span>)<span class="op">;</span></span></code></pre></div>
<pre><code>## The current price is115(100 before 15% tax)
## The current price is230(200 before 15% tax)
## The current price is224(200 before 12% tax)</code></pre>
<p>The key detail to notice is the presence of the global stack of effects. Whenever an effect is called, it first pushes itself onto the stack. It then executes, accessing any signals it needs along the way. These signals in turn register the effect as a listener, by accessing it as the top-most element of the effect stack. When the effect is done executing, it pops itself off the stack. Now, whenever one of the accessed signals changes, the effect re-runs again. Crucially, making a derived reactive value is as simple as writing a callback: if an effect calls a function using a signal, it also automatically subscribes to that signal (see the example of <code>priceWithTax()</code> above). Importantly, the effect subscribes <em>only</em> to this signal and not the derived value itself. In other words, effects only ever subscribe to the leaf nodes of the reactive graph (signals). Derived values computed on the fly (and, if necessary, can be easily memoized<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a>), and event ordering is simply managed via the runtime call stack.</p>
<p>Signals provide an elegant solution to many problems with reactivity. They automate subscription to events, prevent unnecessary updates, ensure correct update order, and, due to their fine-grained nature, are generally highly performant compared to more cumbersome methods like the virtual DOM. However, again, signals do also introduce their own set of trade-offs. Chief among these, signal’s reliance on the call stack for event ordering necessitates their implementation as functions (getter-setter pairs), rather than plain data values. While techniques like object getters/setters or templating <span class="citation">(as seen in SolidJS, <a href="#ref-solid2024">Solid Core Team 2025</a>)</span> can be used to hide this fact, it does nevertheless add an extra layer of complexity. Similarly, many features important for performance, like memoization and batching, also require treating signals as distinct from plain data. Having code consist of two sets of entities - plain data and signals - ultimately impacts developer ergonomics.</p>
</div>
<div id="reactivity-solution" class="section level4 hasAnchor" number="7.3.1.5">
<h4><span class="header-section-number">7.3.1.5</span> Choice of reactivity model and final thoughts<a href="system.html#reactivity-solution" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>At the start of the project, I had used the <code>Observer</code> pattern for modeling reactivity. However, I had this idea of letting the users to define reactive parameters that could be used at arbitrary points in the data visualization pipeline. This had led me to explore the various models of reactivity described above, and even do a full rewrite of <code>plotscape</code> with signals at one point.</p>
<p>However, eventually, I ended up going back to the <code>Observer</code> pattern. The primary reason was developer ergonomics. While many properties of signals like automatic subscription seemed appealing, the need to manage both data and signals as distinct entities proved cumbersome. Deciding which components of my system and their properties should be plain data versus signals added an additional developer overhead and complicated refactoring. Furthemore, I also found that, in the interactive data visualization pipeline, reactivity could be aligned with the four discrete steps: partitioning, aggregation, scaling, and rendering. Specifically, reactive values could be introduced in batch right at the start of each of these four steps, simplifying the reactive graph as well as the overall mental model. Introducing reactivity at other points seem to offer limited practical benefit. Thus, despite the limitations of the <code>Observer</code> pattern, the structured nature of the problem (interactive data visualization pipelines) ultimately makes it a good solution in my eyes.</p>
</div>
</div>
<div id="system-components" class="section level3 hasAnchor" number="7.3.2">
<h3><span class="header-section-number">7.3.2</span> System components<a href="system.html#system-components" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This section details the code components of <code>plotscape</code>.</p>
<div id="Indexable" class="section level4 hasAnchor" number="7.3.2.1">
<h4><span class="header-section-number">7.3.2.1</span> Indexable<a href="system.html#Indexable" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One of the first considerations when implementing a data visualization system is how to represent data. Clearly, we want the ability to handle fixed-length arrays of values, however, we may also want to be able to work with constants and derived values as well. For instance, in a typical barplot, the y-axis base is a constant (typically zero). Rather than appending an array of zeros to the data, using a constant (<code>0</code>) or a thunk (<code>() =&gt; 0</code>) is simpler and more memory-efficient. Similarly, arrays of repeated values can be optimized by using two arrays: a short array of unique values or “labels,” and a long array of indices (i.e. what base R’s <code>factor</code> class does). Thus, representing data effectively calls for a generalization of a data “column” which can encompass data types beyond fixed-length arrays.</p>
<p>The generic type <code>Indexable&lt;T&gt;</code> represents such a generalization of a data column. It is simply a union of three basic types:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb29-1"><a href="system.html#cb29-1" tabindex="-1"></a>Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> T <span class="op">|</span> T[] <span class="op">|</span> ((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T)</span></code></pre></div>
<p>In plain words, an <code>Indexable&lt;T&gt;</code> can be one of three things:</p>
<ul>
<li>A simple (scalar) value <code>T</code></li>
<li>A fixed-length array of <code>T</code>’s</li>
<li>A function which takes an index as an argument and returns a <code>T</code>.</li>
</ul>
<p>This is somewhat similar to Leland Wilkinson’s idea of data functions <span class="citation">(see <a href="#ref-wilkinson2012">Wilkinson 2012, 42</a>)</span>, although somewhat more constrained. The key functionality which is abstracted over is indexed access to values. A uniform interface for this functionality is provided by provided by <a href="system.html#Getter"><code>Getter</code></a>s.</p>
</div>
<div id="Getter" class="section level4 hasAnchor" number="7.3.2.2">
<h4><span class="header-section-number">7.3.2.2</span> Getter<a href="system.html#Getter" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A <code>Getter&lt;T&gt;</code> is used to provide a uniform interface to accessing values from an <code>Indexable&lt;T&gt;</code>. It is simply a function which takes an index and returns a value of type <code>T</code>. To construct a <code>Getter&lt;T&gt;</code>, we take an <code>Indexable&lt;T&gt;</code> and dispatch on the underlying subtype. For illustration purposes, here is a simplified implementation:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb30-1"><a href="system.html#cb30-1" tabindex="-1"></a><span class="co">// Getter.ts</span></span>
<span id="cb30-2"><a href="system.html#cb30-2" tabindex="-1"></a><span class="im">export type</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb30-3"><a href="system.html#cb30-3" tabindex="-1"></a></span>
<span id="cb30-4"><a href="system.html#cb30-4" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Getter</span> {</span>
<span id="cb30-5"><a href="system.html#cb30-5" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">of</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb30-6"><a href="system.html#cb30-6" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">typeof</span> x <span class="op">===</span> <span class="vs">`function`</span>) <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb30-7"><a href="system.html#cb30-7" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(x)) <span class="cf">return</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> x[index]<span class="op">;</span></span>
<span id="cb30-8"><a href="system.html#cb30-8" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">return</span> () <span class="kw">=&gt;</span> x<span class="op">;</span></span>
<span id="cb30-9"><a href="system.html#cb30-9" tabindex="-1"></a>  }</span>
<span id="cb30-10"><a href="system.html#cb30-10" tabindex="-1"></a>}</span></code></pre></div>
<p>we can then create and use <code>Getter</code>s like so:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb31-1"><a href="system.html#cb31-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb31-2"><a href="system.html#cb31-2" tabindex="-1"></a></span>
<span id="cb31-3"><a href="system.html#cb31-3" tabindex="-1"></a><span class="kw">const</span> getter1 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb31-4"><a href="system.html#cb31-4" tabindex="-1"></a><span class="kw">const</span> getter2 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>(<span class="dv">99</span>)<span class="op">;</span></span>
<span id="cb31-5"><a href="system.html#cb31-5" tabindex="-1"></a><span class="kw">const</span> getter3 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> index <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb31-6"><a href="system.html#cb31-6" tabindex="-1"></a></span>
<span id="cb31-7"><a href="system.html#cb31-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter1</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb31-8"><a href="system.html#cb31-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter2</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb31-9"><a href="system.html#cb31-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter3</span>(<span class="dv">0</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 1
## 99
## -1</code></pre>
<p>Note that, by definition, every <code>Getter&lt;T&gt;</code> is also automatically an <code>Indexable&lt;T&gt;</code> (since it is a callback <code>(index: number) =&gt; T</code>). This means that we can create new getters out of other getters.</p>
<p>There are also several utility functions for working with and constructing <code>Getter</code>s. The first is <code>Getter.constant</code> which takes in a value <code>T</code> and returns a thunk which always returns <code>T</code> (i.e. <code>() =&gt; T</code>). This is useful, for example, when <code>T</code> is an array and we always want to return the whole array (not just a single element):</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb33-1"><a href="system.html#cb33-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb33-2"><a href="system.html#cb33-2" tabindex="-1"></a></span>
<span id="cb33-3"><a href="system.html#cb33-3" tabindex="-1"></a><span class="kw">const</span> getter4 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">constant</span>([<span class="vs">`A`</span><span class="op">,</span> <span class="vs">`B`</span><span class="op">,</span> <span class="vs">`C`</span>])</span>
<span id="cb33-4"><a href="system.html#cb33-4" tabindex="-1"></a></span>
<span id="cb33-5"><a href="system.html#cb33-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter4</span>(<span class="dv">0</span>))</span>
<span id="cb33-6"><a href="system.html#cb33-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter4</span>(<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ]
## [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ]</code></pre>
<p>Another useful utility function is <code>Getter.proxy</code>, which takes a <code>Getter</code> and an array of indices as input and returns a new <code>Getter</code> which routes the access to the original values through the indices:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb35-1"><a href="system.html#cb35-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb35-2"><a href="system.html#cb35-2" tabindex="-1"></a></span>
<span id="cb35-3"><a href="system.html#cb35-3" tabindex="-1"></a><span class="kw">const</span> proxyGetter <span class="op">=</span> Getter<span class="op">.</span><span class="fu">proxy</span>([<span class="vs">`A`</span><span class="op">,</span> <span class="vs">`B`</span><span class="op">,</span> <span class="vs">`C`</span>]<span class="op">,</span> [<span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb35-4"><a href="system.html#cb35-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">.</span><span class="fu">map</span>(proxyGetter))</span></code></pre></div>
<pre><code>## [ &quot;C&quot;, &quot;B&quot;, &quot;B&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A&quot; ]</code></pre>
<p>This function becomes particularly useful when implementing other data structures such as <code>Factor</code>s.</p>
</div>
<div id="dataframe" class="section level4 hasAnchor" number="7.3.2.3">
<h4><span class="header-section-number">7.3.2.3</span> Dataframe<a href="system.html#dataframe" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In many data analytic workflows, a fundamental data structure is a dataframe or a two-dimensional table. As mentioned in Section [REFERENCE], we can represent this data structure as either a dictionary of columns or a list of rows, with the column-wise representation having some advantages for analytical workflows. Thus, in <code>plotscape</code>, a <code>Dataframe</code> is a dictionary columns, with the extra twist that the columns don’t have to be fixed-length arrays but instead <a href="system.html#Indexable"><code>Indexable</code></a>s:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb37-1"><a href="system.html#cb37-1" tabindex="-1"></a><span class="kw">interface</span> Dataframe {</span>
<span id="cb37-2"><a href="system.html#cb37-2" tabindex="-1"></a>  [key<span class="op">:</span> <span class="dt">string</span>]<span class="op">:</span> Indexable</span>
<span id="cb37-3"><a href="system.html#cb37-3" tabindex="-1"></a>}</span></code></pre></div>
<p>For example, the following is a valid instance of a <code>Dataframe</code>:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb38-1"><a href="system.html#cb38-1" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> {</span>
<span id="cb38-2"><a href="system.html#cb38-2" tabindex="-1"></a>  name<span class="op">:</span> [<span class="vs">`john`</span><span class="op">,</span> <span class="vs">`jenny`</span><span class="op">,</span> <span class="vs">`michael`</span>]<span class="op">,</span></span>
<span id="cb38-3"><a href="system.html#cb38-3" tabindex="-1"></a>  age<span class="op">:</span> [<span class="dv">17</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> <span class="dv">21</span>]<span class="op">,</span></span>
<span id="cb38-4"><a href="system.html#cb38-4" tabindex="-1"></a>  isStudent<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb38-5"><a href="system.html#cb38-5" tabindex="-1"></a>  canDrive<span class="op">:</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> data<span class="op">.</span><span class="at">age</span>[index] <span class="op">&gt;</span> <span class="dv">18</span><span class="op">,</span></span>
<span id="cb38-6"><a href="system.html#cb38-6" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>Most functions in <code>plotscape</code> operate column-wise, however, here’s how the dataframe above would look like as a list of rows if we materialized using a hypothetical <code>Dataframe.rows()</code> function:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb39-1"><a href="system.html#cb39-1" tabindex="-1"></a><span class="im">import</span> { Dataframe } <span class="im">from</span> <span class="st">&quot;./Dataframe&quot;</span></span>
<span id="cb39-2"><a href="system.html#cb39-2" tabindex="-1"></a></span>
<span id="cb39-3"><a href="system.html#cb39-3" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> {</span>
<span id="cb39-4"><a href="system.html#cb39-4" tabindex="-1"></a>  name<span class="op">:</span> [<span class="vs">`john`</span><span class="op">,</span> <span class="vs">`jenny`</span><span class="op">,</span> <span class="vs">`michael`</span>]<span class="op">,</span></span>
<span id="cb39-5"><a href="system.html#cb39-5" tabindex="-1"></a>  age<span class="op">:</span> [<span class="dv">17</span><span class="op">,</span> <span class="dv">24</span><span class="op">,</span> <span class="dv">21</span>]<span class="op">,</span></span>
<span id="cb39-6"><a href="system.html#cb39-6" tabindex="-1"></a>  isStudent<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb39-7"><a href="system.html#cb39-7" tabindex="-1"></a>  canDrive<span class="op">:</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> data<span class="op">.</span><span class="at">age</span>[index] <span class="op">&gt;</span> <span class="dv">18</span><span class="op">,</span></span>
<span id="cb39-8"><a href="system.html#cb39-8" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb39-9"><a href="system.html#cb39-9" tabindex="-1"></a></span>
<span id="cb39-10"><a href="system.html#cb39-10" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(Dataframe<span class="op">.</span><span class="fu">rows</span>(data))</span></code></pre></div>
<pre><code>## [
##   {
##     name: &quot;john&quot;,
##     age: 17,
##     isStudent: true,
##     canDrive: false,
##   }, {
##     name: &quot;jenny&quot;,
##     age: 24,
##     isStudent: true,
##     canDrive: true,
##   }, {
##     name: &quot;michael&quot;,
##     age: 21,
##     isStudent: true,
##     canDrive: true,
##   }
## ]</code></pre>
<p>One important thing to mention is that, since a <code>Dataframe</code> can contain different <code>Indexable</code> subtypes as columns, we need to make sure that information about the number of rows is present and non-conflicting. That is, all fixed-length arrays in the data must have the same length, and, if there are non-fixed length variables (constants, derived variables/functions) present, we need to make sure that either at least one fixed-length array is included in the data or the non-fixed length arrays carry appropriate metadata.</p>
<p>While in a traditional OOP style, these length constraints might be enforced as a class invariant during instantiation and within methods, my system adopts a more dynamic approach. Since a <code>Dataframe</code> is a simple dictionary, the length constraints are checked dynamically (via a <code>Dataframe.checkLength()</code> utility function). This occurs whenever the integrity of a <code>Dataframe</code> becomes a key concern, such as when initializing a <a href="#Scene"><code>Scene</code></a> or when rendering. This style is more in line with JavaScript’s dynamic nature: in JavaScript, class instances are just objects, and there is nothing preventing the users from adding or removing properties at runtime. Further, dataframes with typical dimensionality (fewer columns than rows, <span class="math inline">\(p &lt;&lt; n\)</span>), the performance cost of checking column’s length is negligible when compared to row-wise operations, such as rendering or summary statistics calculations. If performance were to become an issue for high-dimensional datasets (<span class="math inline">\(p &gt;&gt; n\)</span>), the system could always be enhanced with memoization or caching.</p>
</div>
<div id="factors" class="section level4 hasAnchor" number="7.3.2.4">
<h4><span class="header-section-number">7.3.2.4</span> Factors<a href="system.html#factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As discussed in Section <a href="problems.html#problems">4</a>, when visualizing, we often need to split our data into a set of disjoint subsets organized into partitions. Further, as mentioned in Section <a href="problems.html#hierarchy">4.2.4</a>, these partitions may be organized in a hierarchy, such that multiple subsets in one partition may be unioned together to form another subset in a coarser, parent partition.</p>
<p><code>Factor</code>s provide a way to represent such data partitions and the associated metadata. They are similar to base R’s <code>factor</code> S3 class, although there are some important differences which will be discussed below. <code>Factor</code> has the following interface:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb41-1"><a href="system.html#cb41-1" tabindex="-1"></a><span class="kw">interface</span> Factor<span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span> {</span>
<span id="cb41-2"><a href="system.html#cb41-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb41-3"><a href="system.html#cb41-3" tabindex="-1"></a>  indices<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb41-4"><a href="system.html#cb41-4" tabindex="-1"></a>  data<span class="op">:</span> T</span>
<span id="cb41-5"><a href="system.html#cb41-5" tabindex="-1"></a>  parent<span class="op">?:</span> Factor<span class="op">;</span></span>
<span id="cb41-6"><a href="system.html#cb41-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Here, <code>cardinality</code> represents the number of unique parts that a partitions consists of (e.g. 2 for a binary variable, 3 for a categorical variable with 3 levels, and so on). Data points map to the parts via a “dense” array of <code>indices</code>, which take on values in <code>0 ... cardinality - 1</code> and have length equal to the length of the data<a href="#fn9" class="footnote-ref" id="fnref9"><sup>9</sup></a>. For instance, the following array of indices - <code>[0, 1, 1, 0, 2, 0]</code> - should be interpreted as meaning that the first part is composed of cases one, four, and six, the second part is composed of cases two and three, and the third part is composed of the case five (keeping in mind JavaScript’s zero-based indexing). The data associated with factor’s levels is stored in the <code>data</code> property, which is composed of arrays/<code>Indexables</code> with length equal to the factor’s cardinality. For instance, if a factor is created from a categorical variable with three levels - <code>A</code>, <code>B</code>, and <code>C</code>, then the rows the the <code>data</code> may look something like this: <code>[{ label: "A" }, { label: "B" }, { label: "C" }]</code>. Finally, the optional <code>parent</code> property denotes a factor representing the parent partition.</p>
<p>There are a couple of important things to discuss. First, <code>cardinality</code> technically represents the same information as could be obtained by counting the number of unique values in <code>indices</code>, however, for many operations on <code>Factor</code>s, it is beneficial to be able to access the cardinality in constant <span class="math inline">\(O(1)\)</span> rather than linear <span class="math inline">\(O(n)\)</span> time that would result from having to loop through the <code>indices</code>. Such is the case, for example, when constructing <a href="#Product%20factors">product factors</a> or when initializing arrays of summaries. Of course, care must be taken to ensure that <code>cardinality</code> and <code>indices</code> stay synchronized under factor transformations.</p>
<p>Second, the part’s metadata is stored in the <code>data</code> of type <a href="#Dataframe"><code>Dataframe</code></a>. This represents a departure from e.g. base R’s <code>factor</code> class, where all metadata is stored as a flat vector of levels. For instance:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="system.html#cb42-1" tabindex="-1"></a><span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>))</span></code></pre></div>
<pre><code>##  [1] (0,5]  (0,5]  (0,5]  (0,5]  (0,5]  (5,10] (5,10] (5,10] (5,10] (5,10]
## Levels: (0,5] (5,10]</code></pre>
<p>With <code>Factor</code>, the same information would be represented as:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb44-1"><a href="system.html#cb44-1" tabindex="-1"></a><span class="kw">const</span> factor<span class="op">:</span> Factor <span class="op">=</span> {</span>
<span id="cb44-2"><a href="system.html#cb44-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb44-3"><a href="system.html#cb44-3" tabindex="-1"></a>  indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb44-4"><a href="system.html#cb44-4" tabindex="-1"></a>  data<span class="op">:</span> {</span>
<span id="cb44-5"><a href="system.html#cb44-5" tabindex="-1"></a>    binMin<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">,</span></span>
<span id="cb44-6"><a href="system.html#cb44-6" tabindex="-1"></a>    binMax<span class="op">:</span> [<span class="dv">5</span><span class="op">,</span> <span class="dv">10</span>]<span class="op">,</span></span>
<span id="cb44-7"><a href="system.html#cb44-7" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb44-8"><a href="system.html#cb44-8" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>Storing <code>Factor</code> metadata in a <code>Dataframe</code> offers several advantages as opposed to a flat vector/array. First, when partitioning data, we often want to store several distinct pieces of metadata. For example, when we bin numeric variable, like in the example above, we want to store both the lower and upper bound of each part’s bin. <code>cut</code> stores the multiple (two) pieces of metadata as a tuple, however, this approach becomes cumbersome when the dimensionality of the metadata grows. Further, metadata stored in a <code>Dataframe</code> becomes far easier to combine when taking <a href="#Product%20factors">a product of two factors</a>. Since taking products of factors is a fundamental operation, underpinning features such as linked brushing, it makes sense to use metadata representation which facilitates this operation.</p>
<p>While all <code>Factor</code>s share the same fundamental structure - a data partition with associated metadata - factors can be created using various constructor functions. These constructor functions differ in what data they take as input and what metadata they store on the ouput, giving rise to several distinct <code>Factor</code> subtypes. These will be the subject of the next few sections.</p>
<div id="bijection-and-constant-factors" class="section level5 hasAnchor" number="7.3.2.4.1">
<h5><span class="header-section-number">7.3.2.4.1</span> Bijection and constant factors<a href="system.html#bijection-and-constant-factors" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p><code>Factor.bijection</code> and <code>Factor.constant</code> are two fairly trival factor constructor. <code>Factor.bijection</code> creates the finest possible data partition by assigning every case to its own part, whereas <code>Factor.constant</code> does the opposite and assigns all cases to a single part. The names of the reflect the mathematical index mapping functions: the bijective function <span class="math inline">\(f(i) = i\)</span> for <code>Factor.bijection</code> and the constant function <span class="math inline">\(f(i) = 0\)</span> for <code>Factor.constant</code>. Consequently, the cardinality of <code>Factor.bijection</code> is equal to the length of the data, while the cardinality of <code>Factor.constant</code> is always one. Both can be assigned arbitrary metadata, which must have length equal to the cardinality.</p>
<p>Both functions have essentially the same signature:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb45-1"><a href="system.html#cb45-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bijection</span><span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span>(n<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> data<span class="op">?:</span> T)<span class="op">:</span> Factor<span class="op">&lt;</span>T<span class="op">&gt;</span> </span>
<span id="cb45-2"><a href="system.html#cb45-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">constant</span><span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span>(n<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> data<span class="op">?:</span> T)<span class="op">:</span> Factor<span class="op">&lt;</span>T<span class="op">&gt;</span> </span></code></pre></div>
<p>In both cases, <code>n</code> represents the length of the data (the number of cases) and data represents arbitrary metadata. The variable <code>n</code> is used to construct an array of <code>indices</code>, which in the case of <code>Factor.bijection</code> is an increasing sequence starting at zero (<code>[0, 1, 2, 3, ..., n - 1]</code>) whereas in the case of <code>Factor.constant</code> it is simply an array of zeroes (<code>[0, 0, 0, 0, ..., 0]</code>). Technically, in this case, having an explicit array of indices is not necessary, and we could implement much of the same functionality via a callback (i.e. <code>(index: number) =&gt; index</code> for <code>Factor.bijection</code> and <code>(index: number) =&gt; 0</code> for <code>Factor.constant</code>). However, for many operations involving factors, it is necessary to store the length of the data (<code>n</code>), and while it would be possible to define a separate <code>n</code>/<code>length</code> property on <code>Factor</code>, in the context of other factor types, I found it simpler to allocate the corresponding array. While this does have some small memory cost, there is no computational cost involved, since, by definition, the partition represented by a bijection or constant factor does not change<a href="#fn10" class="footnote-ref" id="fnref10"><sup>10</sup></a>.</p>
<p><code>Factor.bijection</code> and <code>Factor.constant</code> their own specific use cases. <code>Factor.bijection</code> represents a one-to-one mapping and this makes it suitable for scatterplots and parallel coordinate plots. In contrast, <code>Factor.constant</code> is useful when we want to compute summaries across the entirety of the data, such as is the case for spinogram<a href="#fn11" class="footnote-ref" id="fnref11"><sup>11</sup></a>.</p>
<p>As a final interesting side-note, both <code>Factor.bijection</code> and <code>Factor.constant</code> can be interpreted through the lense of category theory, as terminal and initial objects within the category of data partitions, with morphisms representing products between partitions. That is, the product of any factor with a <code>Factor.bijection</code> always yields another <code>Factor.bijection</code> (making this a terminal object), whereas the product of any factor with <code>Factor.constant</code> will simply yield that factor (making this an initial object).</p>
</div>
<div id="discrete-factors" class="section level5 hasAnchor" number="7.3.2.4.2">
<h5><span class="header-section-number">7.3.2.4.2</span> Discrete factors<a href="system.html#discrete-factors" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Another fairly intuitive factor constructor is <code>Factor.from</code>. It simply takes an array of values which can be coerced to string labels (i.e. have the <code>.toString()</code> method) and creates a discrete factor by treating each unique label as a factor level (this is essentially what base R’s <code>factor</code> class does). This gives rise to the following function signature:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb46-1"><a href="system.html#cb46-1" tabindex="-1"></a><span class="kw">type</span> Stringable <span class="op">=</span> { <span class="fu">toString</span>()<span class="op">:</span> <span class="dt">string</span> }<span class="op">;</span></span>
<span id="cb46-2"><a href="system.html#cb46-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">from</span>(x<span class="op">:</span> Stringable[]<span class="op">,</span> options<span class="op">?:</span> { labels<span class="op">:</span> <span class="dt">string</span>[] })<span class="op">:</span> Factor<span class="op">&lt;</span>{ label<span class="op">:</span> <span class="dt">string</span>[] }<span class="op">&gt;</span> </span></code></pre></div>
<p>When creating a discrete factor with <code>Factor.from</code>, the resulting factor’s length matches the input array <code>x</code>. To compute the factor <code>indices</code>, the constructor needs to be either provided with an array of <code>labels</code> or these will be computed from <code>x</code> directly (by calling the <code>.toString()</code> method and finding all unique values). Assigning indices requires looping through the <span class="math inline">\(n\)</span> values <code>x</code> and further looping through <span class="math inline">\(k\)</span> <code>labels</code>, resulting in <span class="math inline">\(O(n)\)</span> time complexity (assuming <span class="math inline">\(k\)</span> is constant with respect to the size of the data). The factor metadata simply contains this array of <code>label</code>s (singular form <code>label</code> is used since it is the name of a dataframe column). Each index in <code>indices</code> then simply maps to one <code>label</code>. Finally, for easier inspection, <code>label</code>s may be sorted alphanumerically, though this does not affect computation in any way.</p>
<p>The typical use case for <code>Factor.from</code> is the barplot. Here, we take an array of values, coerce these to string labels (if the values were not strings already), find all unique values, and then create an array of indices mapping the array values to the unique labels. The indices can then be used to subset data when computing summary statistics corresponding to the barplot bars.</p>
</div>
<div id="binned-factors" class="section level5 hasAnchor" number="7.3.2.4.3">
<h5><span class="header-section-number">7.3.2.4.3</span> Binned factors<a href="system.html#binned-factors" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Arrays of continuous values can be turned into factors by binning. <code>Factor.bin</code> is the constructor function used to perform this binning. It has the following signature:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb47-1"><a href="system.html#cb47-1" tabindex="-1"></a><span class="kw">type</span> BinOptions <span class="op">=</span> { breaks<span class="op">?:</span> <span class="dt">number</span>[]<span class="op">;</span> nBins<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span> width<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span> anchor<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span> }</span>
<span id="cb47-2"><a href="system.html#cb47-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bin</span>(x<span class="op">:</span> <span class="dt">number</span>[]<span class="op">,</span> options<span class="op">?:</span> BinOptions)<span class="op">:</span> Factor<span class="op">&lt;</span>{ binMin<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span> binMax<span class="op">:</span> <span class="dt">number</span>[] }<span class="op">&gt;;</span></span></code></pre></div>
<p>Again, as in the case of <code>Factor.from</code>, the length of the factor created with <code>Factor.bin</code> will match the length of <code>x</code>. To compute the factor <code>indices</code>, the values in <code>x</code> need to be assigned to histogram bins delimited by breaks. The breaks are computed based on either default values or the optional list of parameters (<code>options</code>) provided to the construct function. Note that the parameters are not orthogonal: for instance, histogram with a given number of bins (<code>nBins</code>) cannot have an arbitrary binwidth (<code>width</code>) and vice versa. Thus, if a user provides multiple conflicting parameters, they are resolved in the following order: <code>breaks</code> &gt; <code>nBins</code> &gt; <code>width</code>. Finally, the metadata stored on the <code>Factor.bin</code> output includes the limits of each bin <code>binMin</code> and <code>binMax</code>, giving the lower and upper bound of each bin, respectively.</p>
<p>Indices are assigned to bins using a half-open intervals on breaks of the form <code>(l, u]</code>, such that a value <code>v</code> is assigned to to a bin given by <code>(l, u]</code> if it is the case that <code>l &lt; v &lt;= u</code>. Assigning indices to bins requires looping through the <span class="math inline">\(n\)</span> values of <code>x</code>, and further looping through <span class="math inline">\(k\)</span> <code>breaks</code><a href="#fn12" class="footnote-ref" id="fnref12"><sup>12</sup></a>, resulting in <span class="math inline">\(O(n)\)</span> time complexity (assuming <span class="math inline">\(k\)</span> is fixed with respect to the size of the data).</p>
<p>An important point to mention is that a naive approach of assigning bins to cases may lead to some bins being left empty, resulting in <code>cardinality</code> which is less than the number of bins and “sparse” <code>indices</code> (gaps in index values). For instance, binning the values <code>[1, 2, 6, 1, 5]</code> with breaks <code>[0, 2, 4, 6]</code> leaves the second bin (<code>(2, 4]</code>) empty, and hence the corresponding index value (<code>1</code>) will be absent from <code>indices</code>. To address this, <code>plotscape</code> performs an additional <span class="math inline">\(O(n)\)</span> computation to “clean” the indices and ensure that the array is dense (i.e. <code>indices</code> take on values in <code>0 ... cardinality - 1</code>, and each value appears at least once). While this additional computation may not be strictly necessary (i.e. some other systems may use “sparse” factor representation), I found the dense arrays of indices much easier to work with, particularly when it comes to operations like combining factors via products and subsetting the corresponding data. Further, even though this approach necessitates looping over <code>indices</code> twice, the combined operation still maintains an <span class="math inline">\(O(n)\)</span> complexity.</p>
</div>
<div id="product-factors" class="section level5 hasAnchor" number="7.3.2.4.4">
<h5><span class="header-section-number">7.3.2.4.4</span> Product factors<a href="system.html#product-factors" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>As discussed in Section <a href="problems.html#products-of-partitions">4.2.3.2</a>, a fundamental operation that underpins many popular types of visualizations, particularly when linked selection is involved, is the Cartesian product of two partitions. That is, assuming we have two <code>Factor</code>s which partition our data into parts, we can create a new <code>Factor</code> consists of all unique intersections of those parts.</p>
<p>To illustrate this idea better, take two factors represented by the following data (the <code>data</code> property is omitted for conciseness):</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb48-1"><a href="system.html#cb48-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>] }<span class="op">;</span></span>
<span id="cb48-2"><a href="system.html#cb48-2" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>] }<span class="op">;</span></span></code></pre></div>
<p>If we take their product, we should end up with the following factor<a href="#fn13" class="footnote-ref" id="fnref13"><sup>13</sup></a>:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb49-1"><a href="system.html#cb49-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">4</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>] }<span class="op">;</span></span></code></pre></div>
<p>There are a couple of things to note here. First, note that the cardinality of the product factor (4) is greater than either of the cardinalities of the constituent factors (2, 3), but less than the product of the cardinalities (<span class="math inline">\(2 \cdot 3 = 6\)</span>). This will generally be the case: if the first factor has cardinality <span class="math inline">\(a\)</span> and the second cardinality <span class="math inline">\(b\)</span>, the product will have cardinality <span class="math inline">\(c\)</span>, such that:</p>
<ul>
<li><span class="math inline">\(c \geq a\)</span> and <span class="math inline">\(c \geq a\)</span><a href="#fn14" class="footnote-ref" id="fnref14"><sup>14</sup></a></li>
<li><span class="math inline">\(c \leq a \cdot b\)</span><a href="#fn15" class="footnote-ref" id="fnref15"><sup>15</sup></a></li>
</ul>
<p>This is all fairly intuitive, however, actually computing the indices of a product factor presents some challenges. A naive idea might be to simply sum/multiply pairs of indices element-wise, however, this approach does not work: the sum/product of two different pairs of indices might produce the same value (e.g. in a product of two factors with cardinalities of <span class="math inline">\(2\)</span> and <span class="math inline">\(3\)</span>, there are two different ways to get <span class="math inline">\(4\)</span> as the sum of indices: <span class="math inline">\(1 + 3\)</span> and <span class="math inline">\(2 + 2\)</span>). Further, when taking the product of two factors, we may want to preserve the factor order, in the sense that cases associated with lower values of the first factor should get assigned lower indices. Because sums and products are commutative, this does not work.</p>
<p>One crude solution shown in Section <a href="problems.html#products-of-partitions">4.2.3.2</a> is to treat the factor indices as strings and concatenate them elementwise. This works, but produces an unnecessary computational overhead. There is a better way. Assuming we have two factors with cardinalities <span class="math inline">\(c_1\)</span> and <span class="math inline">\(c_2\)</span>, and two indices <span class="math inline">\(i_1\)</span> and <span class="math inline">\(i_2\)</span> corresponding to the same case, we can compute the product index <span class="math inline">\(i_p\)</span> via the following formula:</p>
<p><span class="math display">\[i_{\text{p}} = \max(c_1, c_2) \cdot i_{\text{1}} + i_{\text{2}}\]</span></p>
<p>This formula is similar to one discussed in <span class="citation">Wickham (<a href="#ref-wickham2013">2013</a>)</span>. Since <span class="math inline">\(i_1\)</span> takes values in <span class="math inline">\(0 \ldots c_1 - 1\)</span> and <span class="math inline">\(i_2\)</span> takes values in <span class="math inline">\(0 \ldots c_2 - 1\)</span>, the product index is guaranteed to be unique. Additionally, since the the index corresponding to the first factor gets multiplied by the maximum of the two cardinalities, it gets assigned a greater “weight”, preserving the relative order of the two factors. See for example the following table for product indices of two factors of cardinalities 2 and 3:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="system.html#cb50-1" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">i2 =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">i1 =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb50-2"><a href="system.html#cb50-2" tabindex="-1"></a>tab<span class="sc">$</span>ip <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="sc">*</span> tab<span class="sc">$</span>i1 <span class="sc">+</span> tab<span class="sc">$</span>i2</span>
<span id="cb50-3"><a href="system.html#cb50-3" tabindex="-1"></a></span>
<span id="cb50-4"><a href="system.html#cb50-4" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(tab)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">i2</th>
<th align="right">i1</th>
<th align="right">ip</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="right">2</td>
<td align="right">0</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">0</td>
<td align="right">1</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="right">1</td>
<td align="right">1</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">1</td>
<td align="right">5</td>
</tr>
</tbody>
</table>
<p>As with binning, there is also the issue of products creating gaps in indices. Again, <code>plotscape</code> solves this by keeping track of the unique product indices and looping through them again to “clean” them, in <span class="math inline">\(O(n)\)</span>. Since we want to retain the factor order, we also have to sort the unique product indices, which may hypothetically have worst-case <span class="math inline">\(O(n \cdot \log n)\)</span> time complexity (since even with two factors with cardinalities <span class="math inline">\(c_1, c_2 &lt; n\)</span>, there can be <span class="math inline">\(n\)</span> unique product indices), however, most of the time, the length of the unique product indices will only be a fraction of the length of the data.</p>
<p>Finally, <code>Factor.product</code> is the only factor constructor which actually assigns to the <code>parent</code> property of the output <code>Factor</code>. Specifically, the first factor always gets assigned as the parent of the product, creating a hierarchical structure. Technically, there are situations where a product of two factors is simply a “flat” product and not a hierarchy. This is the case, for example, when taking the product of two binned variables in a 2D histogram - the two factors are conceptually equal. However, in practice, this distinction rarely matters. Any computation involving a flat product can simply ignore the <code>parent</code> property, and the data is for all other intents and purposes equivalent. This similarity of flat and hierarchical products was also noted by Wilkinson, who used the terminology of cross and nest operators <span class="citation">(<a href="#ref-wilkinson2012">Wilkinson 2012, 61</a>)</span>.</p>
</div>
</div>
<div id="reducers" class="section level4 hasAnchor" number="7.3.2.5">
<h4><span class="header-section-number">7.3.2.5</span> Reducers<a href="system.html#reducers" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As discussed in Section <a href="problems.html#aggregation">4.3</a>, a key challenge when computing statistical summaries in interactive data visualization systems is doing so in a way that preserves the inherent hierarchy in the data. For instance, when stacking bar segments in a barplot that has been partitioned via linked selection, we want the stacking operation to respect the inherent hierarchical relationships between the segments and the bars. Further, as also demonstrated in Section <a href="problems.html#aggregation">4.3</a>, this setup suggests particular algebraic structures: groups and monoids.</p>
<p><code>Reducer</code>s and associated data structures and procedures provide a way of addressing this challenge.</p>
<div id="reducers-1" class="section level5 hasAnchor" number="7.3.2.5.1">
<h5><span class="header-section-number">7.3.2.5.1</span> Reducers<a href="system.html#reducers-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>A <code>Reducer&lt;T&gt;</code> is simply a data container that stores functionality and metadata associated with a monoid on type <code>T</code>. It has the following interface:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb51-1"><a href="system.html#cb51-1" tabindex="-1"></a><span class="co">// Reducer.ts</span></span>
<span id="cb51-2"><a href="system.html#cb51-2" tabindex="-1"></a><span class="kw">interface</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb51-3"><a href="system.html#cb51-3" tabindex="-1"></a>  name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb51-4"><a href="system.html#cb51-4" tabindex="-1"></a>  initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb51-5"><a href="system.html#cb51-5" tabindex="-1"></a>  reducefn<span class="op">:</span> (prev<span class="op">:</span> T<span class="op">,</span> next<span class="op">:</span> T) <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb51-6"><a href="system.html#cb51-6" tabindex="-1"></a>}</span></code></pre></div>
<p>That is, a <code>Reducer&lt;T&gt;</code> has a name, a zero-argument function (or a “thunk”) producing a value of type <code>T</code>, and a binary function which takes two values of type <code>T</code> and produces another <code>T</code>. The <code>Reducer</code> namespace exports these <code>Reducer</code>s. Here are a couple of examples:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb52-1"><a href="system.html#cb52-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Reducer</span> {</span>
<span id="cb52-2"><a href="system.html#cb52-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">const</span> sum<span class="op">:</span> Reducer<span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb52-3"><a href="system.html#cb52-3" tabindex="-1"></a>    name<span class="op">:</span> <span class="vs">`sum`</span><span class="op">,</span></span>
<span id="cb52-4"><a href="system.html#cb52-4" tabindex="-1"></a>    initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb52-5"><a href="system.html#cb52-5" tabindex="-1"></a>    reducefn<span class="op">:</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y<span class="op">,</span></span>
<span id="cb52-6"><a href="system.html#cb52-6" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb52-7"><a href="system.html#cb52-7" tabindex="-1"></a></span>
<span id="cb52-8"><a href="system.html#cb52-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">const</span> product<span class="op">:</span> Reducer<span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb52-9"><a href="system.html#cb52-9" tabindex="-1"></a>    name<span class="op">:</span> <span class="vs">`product`</span><span class="op">,</span></span>
<span id="cb52-10"><a href="system.html#cb52-10" tabindex="-1"></a>    initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb52-11"><a href="system.html#cb52-11" tabindex="-1"></a>    reducefn<span class="op">:</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">*</span> y<span class="op">,</span></span>
<span id="cb52-12"><a href="system.html#cb52-12" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb52-13"><a href="system.html#cb52-13" tabindex="-1"></a></span>
<span id="cb52-14"><a href="system.html#cb52-14" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">const</span> max<span class="op">:</span> Reducer<span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb52-15"><a href="system.html#cb52-15" tabindex="-1"></a>    name<span class="op">:</span> <span class="vs">`max`</span><span class="op">,</span></span>
<span id="cb52-16"><a href="system.html#cb52-16" tabindex="-1"></a>    initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="op">-</span><span class="kw">Infinity</span><span class="op">,</span></span>
<span id="cb52-17"><a href="system.html#cb52-17" tabindex="-1"></a>    reducefn<span class="op">:</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>(x<span class="op">,</span> y)<span class="op">,</span></span>
<span id="cb52-18"><a href="system.html#cb52-18" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb52-19"><a href="system.html#cb52-19" tabindex="-1"></a></span>
<span id="cb52-20"><a href="system.html#cb52-20" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">const</span> concat<span class="op">:</span> Reducer<span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span> <span class="op">=</span> {</span>
<span id="cb52-21"><a href="system.html#cb52-21" tabindex="-1"></a>    name<span class="op">:</span> <span class="vs">`concat`</span><span class="op">,</span></span>
<span id="cb52-22"><a href="system.html#cb52-22" tabindex="-1"></a>    initialfn<span class="op">:</span> () <span class="kw">=&gt;</span> <span class="vs">``</span><span class="op">,</span></span>
<span id="cb52-23"><a href="system.html#cb52-23" tabindex="-1"></a>    reducefn<span class="op">:</span> (x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y<span class="op">,</span></span>
<span id="cb52-24"><a href="system.html#cb52-24" tabindex="-1"></a>    <span class="co">// (string concatenation also uses `+` operator in JavaScript)</span></span>
<span id="cb52-25"><a href="system.html#cb52-25" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb52-26"><a href="system.html#cb52-26" tabindex="-1"></a>}</span></code></pre></div>
<p>For reasons discussed in Section <a href="problems.html#aggregation">4.3</a>, a <code>Reducer</code> <em>should</em> be a monoid, meaning that the operation represented by <code>reducefn</code> should be associative, and unital (with respect to <code>initialfn</code>). That is, the following should hold:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb53-1"><a href="system.html#cb53-1" tabindex="-1"></a><span class="fu">reducefn</span>(<span class="fu">reducefn</span>(a<span class="op">,</span> b)<span class="op">,</span> c) <span class="op">===</span> <span class="fu">reducefn</span>(a<span class="op">,</span> <span class="fu">reducefn</span>(b<span class="op">,</span> c))</span>
<span id="cb53-2"><a href="system.html#cb53-2" tabindex="-1"></a><span class="fu">reducefn</span>(a<span class="op">,</span> <span class="fu">initialfn</span>()) <span class="op">===</span> <span class="fu">reducefn</span>(<span class="fu">initialfn</span>()<span class="op">,</span> a) <span class="op">===</span> a</span></code></pre></div>
<p>These constraints are not actually enforced by the system: as discussed in Section <a href="problems.html#programming-with-monoids">4.3.2.6</a>, they would need to be checked with <em>all possible inputs</em>, which is not practical for large input domains such as floating point numbers or strings. However, the <code>Reducer</code> interface should hopefully be evocative of monoids, to users familiar with functional programming.</p>
</div>
<div id="reduced" class="section level5 hasAnchor" number="7.3.2.5.2">
<h5><span class="header-section-number">7.3.2.5.2</span> Reduced<a href="system.html#reduced" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We can use a <code>Reducer&lt;T&gt;</code> to aggregate or fold an array of values of type <code>T</code> (<code>T[]</code>) over a <code>Factor</code>, resulting in an array of values of type <code>T</code> of the same length as the <code>Factor</code>’s cardinality. The underlying procedure is fairly straightforward and looks something like this:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb54-1"><a href="system.html#cb54-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">reduce</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T[]<span class="op">,</span> factor<span class="op">:</span> Factor<span class="op">,</span> reducer<span class="op">:</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> T[] {</span>
<span id="cb54-2"><a href="system.html#cb54-2" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> <span class="bu">Array</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(factor<span class="op">.</span><span class="at">cardinality</span>)<span class="op">;</span></span>
<span id="cb54-3"><a href="system.html#cb54-3" tabindex="-1"></a>  </span>
<span id="cb54-4"><a href="system.html#cb54-4" tabindex="-1"></a>  <span class="co">// Initialize values</span></span>
<span id="cb54-5"><a href="system.html#cb54-5" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> factor<span class="op">.</span><span class="at">cardinality</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb54-6"><a href="system.html#cb54-6" tabindex="-1"></a>    result[j] <span class="op">=</span> reducer<span class="op">.</span><span class="fu">initialfn</span>()<span class="op">;</span></span>
<span id="cb54-7"><a href="system.html#cb54-7" tabindex="-1"></a>  }</span>
<span id="cb54-8"><a href="system.html#cb54-8" tabindex="-1"></a>  </span>
<span id="cb54-9"><a href="system.html#cb54-9" tabindex="-1"></a>  <span class="co">// Aggregate</span></span>
<span id="cb54-10"><a href="system.html#cb54-10" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> factor<span class="op">.</span><span class="at">indices</span><span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb54-11"><a href="system.html#cb54-11" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> factor<span class="op">.</span><span class="at">indices</span>[i]<span class="op">;</span></span>
<span id="cb54-12"><a href="system.html#cb54-12" tabindex="-1"></a>    result[index] <span class="op">=</span> reducer<span class="op">.</span><span class="fu">reducefn</span>(result[index]<span class="op">,</span> x[i])<span class="op">;</span></span>
<span id="cb54-13"><a href="system.html#cb54-13" tabindex="-1"></a>  }</span>
<span id="cb54-14"><a href="system.html#cb54-14" tabindex="-1"></a>  </span>
<span id="cb54-15"><a href="system.html#cb54-15" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb54-16"><a href="system.html#cb54-16" tabindex="-1"></a>}</span></code></pre></div>
<p>After we apply this operation, we could just return the result array <code>T[]</code> as in the example above, however, this is limited. Specifically, as discussed in Section <a href="problems.html#aggregation">4.3</a>, in a data visualization system, we rarely want to treat summaries as a simple “flat” array of values. Instead, in order to correctly apply operations like stacking and normalizing, it is necessary for the summaries to “remember” <em>how</em> they have been summarized, over <em>what</em> partition, and <em>which</em> other summaries they relate to, within the hierarchy of summaries. This is what the <code>Reduced</code> data type is for<a href="#fn16" class="footnote-ref" id="fnref16"><sup>16</sup></a>:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb55-1"><a href="system.html#cb55-1" tabindex="-1"></a><span class="kw">interface</span> Reduced<span class="op">&lt;</span>T <span class="op">=</span> <span class="dt">unknown</span><span class="op">&gt;</span> <span class="kw">extends</span> <span class="bu">Array</span><span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb55-2"><a href="system.html#cb55-2" tabindex="-1"></a>  factor<span class="op">:</span> Factor<span class="op">&lt;</span>T<span class="op">&gt;,</span></span>
<span id="cb55-3"><a href="system.html#cb55-3" tabindex="-1"></a>  reducer<span class="op">:</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;,</span></span>
<span id="cb55-4"><a href="system.html#cb55-4" tabindex="-1"></a>  parent<span class="op">?:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span></span>
<span id="cb55-5"><a href="system.html#cb55-5" tabindex="-1"></a>  original<span class="op">?:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span></span>
<span id="cb55-6"><a href="system.html#cb55-6" tabindex="-1"></a>}</span></code></pre></div>
<p>The way we use <code>Reduced</code> is that we replace the return type of the <code>reduce</code> function, and then, inside the function’s body, we simply assign the <code>Factor</code> and <code>Reducer&lt;T&gt;</code> arguments as the <code>factor</code> and <code>reducer</code> properties to the <code>result</code>, after it’s been computed:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb56-1"><a href="system.html#cb56-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">reduce</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T[]<span class="op">,</span> factor<span class="op">:</span> Factor<span class="op">,</span> reducer<span class="op">:</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb56-2"><a href="system.html#cb56-2" tabindex="-1"></a>  </span>
<span id="cb56-3"><a href="system.html#cb56-3" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb56-4"><a href="system.html#cb56-4" tabindex="-1"></a>  </span>
<span id="cb56-5"><a href="system.html#cb56-5" tabindex="-1"></a>  result<span class="op">.</span><span class="at">factor</span> <span class="op">=</span> factor<span class="op">;</span></span>
<span id="cb56-6"><a href="system.html#cb56-6" tabindex="-1"></a>  result<span class="op">.</span><span class="at">reducer</span> <span class="op">=</span> reducer<span class="op">;</span></span>
<span id="cb56-7"><a href="system.html#cb56-7" tabindex="-1"></a>  </span>
<span id="cb56-8"><a href="system.html#cb56-8" tabindex="-1"></a>  <span class="cf">return</span> result</span>
<span id="cb56-9"><a href="system.html#cb56-9" tabindex="-1"></a>}</span></code></pre></div>
<p>That is, now we have the <code>factor</code> and <code>reducer</code> stored directly alongside array of summaries for future use when applying later transformations like stacking and normalization. This is also where the optional <code>parent</code> and <code>original</code> properties come in. The <code>parent</code> property refers to an array of summaries on the parent partition/<code>Factor</code>, whereas <code>original</code> refers to the original array of summaries, before any transformations like stacking/normalization have been applied (this is primarily useful when querying).</p>
<p>Speaking of stacking and normalization, the <code>Reduced</code> namespace also exposes the <code>stack</code>, <code>normalize</code>, and <code>shiftLeft</code> functions with the following type signatures:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb57-1"><a href="system.html#cb57-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">stack</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(reduced<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span></span>
<span id="cb57-2"><a href="system.html#cb57-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(reduced<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;,</span> normalizefn<span class="op">:</span> (x<span class="op">:</span> T<span class="op">,</span> y<span class="op">:</span> T) <span class="kw">=&gt;</span> T)<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span></span>
<span id="cb57-3"><a href="system.html#cb57-3" tabindex="-1"></a><span class="kw">function</span> <span class="fu">shiftLeft</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(reduced<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Reduced<span class="op">&lt;</span>T<span class="op">&gt;</span></span></code></pre></div>
<p>These functions all take <code>Reduced</code> as the first argument and compute transformations that make use of the <code>factor</code>, <code>reducer</code>, and <code>parent</code> properties, returning a new <code>Reduced</code>. For instance, the <code>stack</code> function uses the <code>factor</code> property and its corresponding <code>parent</code> property to create an array of indices over which to “stack” the <code>Reduced</code> values, and then does exactly this, using the <code>reducer</code>. Similarly, the <code>normalize</code> function also creates a parent-factor dependent array of indices, and applies a binary function using the values of <code>Reduced</code> and <code>parent</code>, for instance, dividing each value by its parent values (such as is the case in a spineplot or spinogram). The <code>shiftLeft</code> function simply appends the neutral element (<code>reducer.initialfn()</code>) as the first element and removes the last element of <code>Reduced</code>, essentially “shifting” the values leftwards (again, this is used in a spinogram).</p>
</div>
<div id="summaries" class="section level5 hasAnchor" number="7.3.2.5.3">
<h5><span class="header-section-number">7.3.2.5.3</span> Summaries<a href="system.html#summaries" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>With the building blocks of <code>Indexable</code>s, <code>Factor</code>s, <code>Reducer</code>s and <code>Reduced</code>s, we now have everything we need to compute the hierarchy of summaries described in Section <a href="problems.html#aggregation">4.3</a> and more specifically Section <a href="problems.html#aggregation-functor">4.3.2.3</a>. The <code>Summaries.of</code> function exported from the <code>Summaries</code> namespace does exactly this:<a href="#fn17" class="footnote-ref" id="fnref17"><sup>17</sup></a>:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb58-1"><a href="system.html#cb58-1" tabindex="-1"></a><span class="kw">type</span> ReducerTuple<span class="op">&lt;</span>T <span class="op">=</span> <span class="dt">unknown</span><span class="op">&gt;</span> <span class="op">=</span> [Indexable<span class="op">&lt;</span>T<span class="op">&gt;,</span> Reducer<span class="op">&lt;</span>T<span class="op">&gt;</span>]<span class="op">;</span></span>
<span id="cb58-2"><a href="system.html#cb58-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">of</span>(summaries<span class="op">:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> ReducerTuple<span class="op">&gt;,</span> factors<span class="op">:</span> Factor[])<span class="op">:</span> Dataframe[]</span></code></pre></div>
<p>The <code>Summaries.of</code> function takes in a dictionary of <code>Indexable-Reducer</code> pairs with matching generic and an array of <code>Factor</code>s. It then repeatedly combines the factors pair-wise using <code>Factor.product</code> and then computes summaries for each new product factor using the <code>Indexable-Reducer</code> pairs in <code>summaries</code>. This results in an array of <code>Dataframe</code>s with equal length as <code>factors</code>, holding the combined data. For example:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb59-1"><a href="system.html#cb59-1" tabindex="-1"></a><span class="kw">const</span> factor1 <span class="op">=</span> Factor<span class="op">.</span><span class="fu">from</span>([<span class="vs">`a`</span><span class="op">,</span> <span class="vs">`a`</span><span class="op">,</span> <span class="vs">`b`</span><span class="op">,</span> <span class="vs">`a`</span><span class="op">,</span> <span class="vs">`b`</span><span class="op">,</span> <span class="vs">`c`</span>])</span>
<span id="cb59-2"><a href="system.html#cb59-2" tabindex="-1"></a><span class="kw">const</span> factor2 <span class="op">=</span> Factor<span class="op">.</span><span class="fu">product</span>(factor1<span class="op">,</span> Factor<span class="op">.</span><span class="fu">from</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>]))</span>
<span id="cb59-3"><a href="system.html#cb59-3" tabindex="-1"></a><span class="kw">const</span> summaries <span class="op">=</span> { stat<span class="op">:</span> [[<span class="dv">10</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">15</span><span class="op">,</span> <span class="dv">11</span><span class="op">,</span> <span class="dv">10</span>]<span class="op">,</span> Reducer<span class="op">.</span><span class="at">sum</span>] }</span>
<span id="cb59-4"><a href="system.html#cb59-4" tabindex="-1"></a></span>
<span id="cb59-5"><a href="system.html#cb59-5" tabindex="-1"></a><span class="kw">const</span> s <span class="op">=</span> Summaries<span class="op">.</span><span class="fu">of</span>(summaries<span class="op">,</span> [factor1<span class="op">,</span> factor2])</span>
<span id="cb59-6"><a href="system.html#cb59-6" tabindex="-1"></a>Dataframe<span class="op">.</span><span class="fu">rows</span>(s[<span class="dv">0</span>]) <span class="co">// [ { label: `a`, stat: 37 }, { label: `b`, stat: 20 }, { label: `c`, stat: 10 } ]</span></span>
<span id="cb59-7"><a href="system.html#cb59-7" tabindex="-1"></a>Dataframe<span class="op">.</span><span class="fu">rows</span>(s[<span class="dv">1</span>]) <span class="co">// [ { label: `a`, label$: `0`, stat: 22 }, { label: `a`, label$: `1`, stat: 15 }, ... ]</span></span></code></pre></div>
<p>This is the overt behavior of the <code>Summaries.of</code> function; however, it also does a couple more things under the hood. First, it links all reduced variables created from <code>summaries</code> with their counterpart on the parent data (i.e. assinging the <code>parent</code> property on the <code>Reduced</code>s). It also sets up a reactive graph, such that when a factor is updated, its corresponding data is updated as well and so are its child factors and their corresponding data.</p>
</div>
</div>
<div id="motivation" class="section level4 hasAnchor" number="7.3.2.6">
<h4><span class="header-section-number">7.3.2.6</span> Motivation<a href="system.html#motivation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When we visualize, we draw summary statistics computed on different parts of the data. For example, when drawing a typical barplot, we split the data based on the levels of some categorical variable, count up the number of cases in each part, and then draw bars of corresponding heights.</p>
<p>In the preceding section, I discussed the component used to represent partitioning of the data into parts: <a href="#Factors">factors</a>. Now it is time to discuss the process of actually computing the statistical summaries representing these parts. Interestingly, while all visualizations rely on this process in one way or another, designing a generic pipeline for doing this presents some surprising challenges.</p>
<p>One such important challenge is displaying coherent visualization. This topic has been discussed in the introduction, in Section [ADD REFERENCE]. Briefly, in order to be a valid representation of the data, an interactive data visualization system should compute and render statistics in such a way that the resulting visualization has correct algebraic properties. As was discussed previously, monoids and groups present a framework for ensuring this, and as such should serve as the backbone of our system.</p>
<p>Another challenge is the hierarchical nature of graphics. In interactive data visualization, it is often desirable to be able to convert one specific plot type into a different representation. For example, a typical barplot represents counts along the y-axis. This is useful for comparing absolute counts, however, it is less useful for comparing proportions. As such, some interactive data visualization systems offer the feature of turning a barplot into a spineplot, a normalized version of the plot where the counts are instead presented along the x-axis, in a stacked order, and the y-axis represents proportion of counts, see Figure <a href="system.html#fig:barspine">7.3</a>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:barspine"></span>
<img src="figures/barplot-spineplot.png" alt="While barplot and spineplot represent the same underlying summaries, each makes it easier to see different aspects of our data. Barplot (left) makes it easier to compare absolute counts, whereas spineplot (right) makes it easier to compare proportions. Notice that the spineplot makes it much easier to see that the proportions of blue cases in categories B and C are exactly the same." width="100%" height="100%" style="border: none;" />
<p class="caption">
Figure 7.3: While barplot and spineplot represent the same underlying summaries, each makes it easier to see different aspects of our data. Barplot (left) makes it easier to compare absolute counts, whereas spineplot (right) makes it easier to compare proportions. Notice that the spineplot makes it much easier to see that the proportions of blue cases in categories B and C are exactly the same.
</p>
</div>
<p>However, despite the fact that both barplots and spineplots represent the same underlying summaries (counts), turning one into the other is not always a trivial exercise. For example, in <code>ggplot2</code>, it is easy to create a barplot using simple declarative syntax, however, there is no such simple recipe for spineplots - creating the right plot in Figure <a href="system.html#fig:barspine">7.3</a> took over 10 lines of external data wrangling code (using standard <code>dplyr</code> syntax).</p>
<p>What is so complicated about spineplots? First of all, both the x- and y-axes represent the same variable: counts. However, the way the variable is used is different:</p>
<ul>
<li>Along the x-axis, we stack counts <em>within the levels of a single factor</em></li>
<li>Along the y-axis, we stack counts <em>within the levels of a product of two factors</em> and normalize them by the counts <em>within the levels of the parent factor</em>.</li>
</ul>
<p>In other words, the spineplot forces us to confront the fact that the summaries in our plots form a hierarchy. When we compute the summaries underlying a stacked barplot or spineplot, we are not merely computing a matrix of values where the rows and the columns have no underlying meaning - instead, we are implicitly saying that objects along the x-axis (whole bars) represent a coarser level of partitioning compared with the objects (stacked segments) along the y-axis. The only difference between a barplot and spineplot is, in the barplot, we can get away with treating the two factors as if they were independent (had the same “weight”), whereas in the spineplot this is no longer possible.</p>
<p>This is why in declarative data visualization systems such as <code>ggplot2</code>, certain types of plots like spineplots are difficult to express. In these systems, the data is implicitly partitioned as a “flat” product of the factor variables. This representation is convenient (e.g. for defining aesthetics via a single call to <code>aes()</code>) but makes it impossible to express hierarchical structures such as the one encoded in spineplot.</p>
<p>Thus, ideally, our system should make it easy specify a pipeline where we compute monoidal summaries of our data within a hierarchy of partitions represented by one or more factor variables, apply some transformations to these summaries (possibly across the levels of the hierarchy), and finally map the summaries to some visual attributes.</p>
</div>
</div>
<div id="scales" class="section level3 hasAnchor" number="7.3.3">
<h3><span class="header-section-number">7.3.3</span> Scales<a href="system.html#scales" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To visualize data, we need to be able to translate values from the space of the data to the space of the graphical device (computer screen). In most data visualization systems, this is done by specialized components called scales or coordinate systems <span class="citation">(see e.g. <a href="#ref-murrell2005">Murrell 2005</a>; <a href="#ref-wickham2016">Wickham 2016</a>; <a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>. Scales serve as a bridge between what we have (data) and what we see (visual attributes), allowing us to cross from one domain to the other.</p>
<p>There exists is a fair research on the theoretical properties of scales and how they relate to the mechanisms of visual perception <span class="citation">(see e.g. <a href="#ref-krzywinski2013">Krzywinski 2013</a>; <a href="#ref-michell1986">Michell 1986</a>; <a href="#ref-wilkinson2012">Wilkinson 2012</a>; <a href="#ref-stevens1946">Stevens 1946</a>)</span>. However, when it comes to applying this knowledge and implementing scales in concrete data visualization systems, a lot less information is available. And, even when such information is available, it is it is often quite high-level of abstract <span class="citation">(for some rare counter-examples, see e.g. <a href="#ref-murrell2005">Murrell 2005</a>; <a href="#ref-ziemkiewicz2009">Ziemkiewicz and Kosara 2009</a>)</span>. Thus, the following section is based largely on how scales have been implemented in existing data visualization codebases, such as the <code>ggplot2</code> R package <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span> or <code>d3-scale</code> module of D3 <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>; also used by Vega <a href="#ref-satyanarayan2015">Satyanarayan et al. 2015</a>)</span>, as well as on personal insights gained while implementing the package.</p>
<div id="overview" class="section level4 hasAnchor" number="7.3.3.1">
<h4><span class="header-section-number">7.3.3.1</span> Overview<a href="system.html#overview" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>From a high-level perspective, a scale is just a function <span class="math inline">\(s: D \to V\)</span> which translates values of the data <span class="math inline">\(d \in D\)</span> to values of some visual attribute <span class="math inline">\(v \in V\)</span>, such as the x- and y-position, length, area, radius, or color <span class="citation">(<a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>. This function may or may not be invertible, such that, at times, each value of the visual attribute may be identified with a unique data value (but this is not always the case).</p>
<p>One of the most common and typical cases is a scale where both <span class="math inline">\(D\)</span> and <span class="math inline">\(V\)</span> are subsets of the real numbers:</p>
<p><span class="math display">\[s: [d_{min}, d_{max}] \to [v_{min}, v_{max}] \qquad d_{min}, d_{max}, v_{min}, v_{max} \in \mathbb{R}\]</span></p>
<p>For example, suppose our data takes values in the range from 1 to 10 and we want to plot it along the x-axis, within a 800 pixels wide plotting region. Then, our scale is simply:</p>
<p><span class="math display">\[s_x: [1, 10] \to [0, 800]\]</span></p>
<p>Now, there is an infinite number of functions that fit this signature. However, one particularly nice and simple candidate is the following function:</p>
<div class="definition">
<p><span id="def:linear-mapping" class="definition"><strong>Definition 7.1  (Simple linear mapping) </strong></span><span class="math display">\[s(d) = v_{max} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
</div>
<p>if we substitute the concrete values into the formula, this becomes:</p>
<p><span class="math display">\[s_x(d) = 0 + \frac{d - 1}{10 - 1} \cdot (800 - 0) = [(d - 1) / 9] \cdot 800\]</span></p>
<p>The function acts on the data in the following way:</p>
<ul>
<li><span class="math inline">\(s_x(1) = (1 - 1) / 9 \cdot 800 = 0\)</span></li>
<li><span class="math inline">\(s_x(10) = (10 - 1) / 9 \cdot 800 = 800\)</span></li>
<li><span class="math inline">\(s_x(d) \in (0, 800)\)</span> for any <span class="math inline">\(d \in (1, 10)\)</span></li>
</ul>
<p>That is, the function maps the data value 1 to pixel 0 (left border of the plotting region), value 10 to to pixel 800 (right border of the plotting region), and any value in between 1 and 10 inside the interval 0 to 800, proportionally to where in the data range it is located.</p>
<p>It is relatively simple to translate the formula in <a href="system.html#def:linear-mapping">7.1</a> to code:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb60-1"><a href="system.html#cb60-1" tabindex="-1"></a><span class="co">// simpleScale.ts</span></span>
<span id="cb60-2"><a href="system.html#cb60-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale</span>(</span>
<span id="cb60-3"><a href="system.html#cb60-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb60-4"><a href="system.html#cb60-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb60-5"><a href="system.html#cb60-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb60-6"><a href="system.html#cb60-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb60-7"><a href="system.html#cb60-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb60-8"><a href="system.html#cb60-8" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb60-9"><a href="system.html#cb60-9" tabindex="-1"></a>  <span class="cf">return</span> vmin <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb60-10"><a href="system.html#cb60-10" tabindex="-1"></a>}</span></code></pre></div>
<p>And indeed, this function works the way we would expect:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb61-1"><a href="system.html#cb61-1" tabindex="-1"></a><span class="im">import</span> { simpleScale } <span class="im">from</span> <span class="st">&quot;./simpleScale.ts&quot;</span></span>
<span id="cb61-2"><a href="system.html#cb61-2" tabindex="-1"></a></span>
<span id="cb61-3"><a href="system.html#cb61-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb61-4"><a href="system.html#cb61-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb61-5"><a href="system.html#cb61-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0
## 400
## 800</code></pre>
</div>
<div id="simple-scale-limits" class="section level4 hasAnchor" number="7.3.3.2">
<h4><span class="header-section-number">7.3.3.2</span> Limits of modeling scales as simple functions<a href="problems.html#simple-scale-limits" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Simple scale functions like the one above can work fine for basic data visualization systems. However, once we begin adding more features, this design becomes prohibitive. Consider, for example, what happens if we want to:</p>
<ul>
<li>Expand the scale limits</li>
<li>Scale discrete data</li>
<li>Apply non-linear transformations</li>
<li>Pan, zoom, reverse, reorder, or otherwise modify the scale interactively</li>
</ul>
<p>Let’s take the first point as a motivating example. Consider what happens to data points at the limits of the data range under the simple linear mapping:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="system.html#cb63-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb63-2"><a href="system.html#cb63-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb63-3"><a href="system.html#cb63-3" tabindex="-1"></a>col <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="st">&quot;indianred&quot;</span>, <span class="st">&quot;grey80&quot;</span>)</span>
<span id="cb63-4"><a href="system.html#cb63-4" tabindex="-1"></a></span>
<span id="cb63-5"><a href="system.html#cb63-5" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>, <span class="at">xaxs =</span> <span class="st">&quot;i&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-46-1.png" width="100%" height="100%" style="border: none;" style="display: block; margin: auto;" /></p>
<p>The plot above shows values scaled using the simple linear mapping along the x-axis, that is, <span class="math inline">\(s: [1, 10] \to [0, 800]\)</span> (effect of the <code>xaxs = "i"</code> argument). Notice that, since the position of the points representing the values 1 and 10 (highlighted in red) gets mapped to pixel values 0 and 800 (the left and right border of the plot), only half of each point is visible. This is quite undesirable - a fundamental principles of graphical integrity is that our graphics should not arbitrarily downplay or hide certain data points <span class="citation">(<a href="#ref-tufte2001">Tufte 2001</a>)</span>. The points at the axis limits are represented by only 1/2 of the area (or less, if at the limits of both axes), making them less salient, and this is especially pernicious since they are likely to be outliers.</p>
<p>To address this problem, most data visualization systems automatically expand the range of the domain by some pre-specified percentage:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="system.html#cb64-1" tabindex="-1"></a><span class="co"># By default, the plot() function automatically expands the x- and y-axis</span></span>
<span id="cb64-2"><a href="system.html#cb64-2" tabindex="-1"></a><span class="co"># limits by approximately 4% on each end, see `xaxs` in ?graphics::par</span></span>
<span id="cb64-3"><a href="system.html#cb64-3" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-47-1.png" width="100%" height="100%" style="border: none;" style="display: block; margin: auto;" /></p>
<p>We <em>could</em> achieve similar effect by modifying the simple linear mapping we have defined above and adding an additional argument:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb65-1"><a href="system.html#cb65-1" tabindex="-1"></a><span class="co">// simpleScale2.ts</span></span>
<span id="cb65-2"><a href="system.html#cb65-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale2</span>(</span>
<span id="cb65-3"><a href="system.html#cb65-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb65-4"><a href="system.html#cb65-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb65-5"><a href="system.html#cb65-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb65-6"><a href="system.html#cb65-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb65-7"><a href="system.html#cb65-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb65-8"><a href="system.html#cb65-8" tabindex="-1"></a>  exp<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> <span class="co">// Extra argument</span></span>
<span id="cb65-9"><a href="system.html#cb65-9" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb65-10"><a href="system.html#cb65-10" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb65-11"><a href="system.html#cb65-11" tabindex="-1"></a>    vmin <span class="op">+</span> (exp <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> exp)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)</span>
<span id="cb65-12"><a href="system.html#cb65-12" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb65-13"><a href="system.html#cb65-13" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, if we set the <code>exp</code> argument to some positive value, the scaled values get mapped closer to the center of the plotting region. For example, setting <code>exp</code> to 0.2 moves each of the data limits 10% closer to the center of the plotting region:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb66-1"><a href="system.html#cb66-1" tabindex="-1"></a><span class="im">import</span> { simpleScale2 } <span class="im">from</span> <span class="st">&quot;./simpleScale2.ts&quot;</span></span>
<span id="cb66-2"><a href="system.html#cb66-2" tabindex="-1"></a></span>
<span id="cb66-3"><a href="system.html#cb66-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span>
<span id="cb66-4"><a href="system.html#cb66-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span>
<span id="cb66-5"><a href="system.html#cb66-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 80
## 400
## 720</code></pre>
<p>However, notice that this argument is applied symmetrically. At times, we may want to apply a different margin to each end of the scale. We could solve this by adding two arguments instead of one, e.g. <code>expLeft</code> and <code>expRight</code>, however, at this point, the function signature starts to become unwieldy. If we have to call the function in multiple places, it may become difficult to remember what each individual argument represents. Further, note that by adding arguments, the logic inside the function’s body becomes denser and less readable. Finally, we may want to persist or modify some of the arguments during runtime (such as when panning or zooming). For all of these reasons, it may be a good idea to take a more structured approach and break the function down into several smaller components.</p>
</div>
<div id="two-component-scales" class="section level4 hasAnchor" number="7.3.3.3">
<h4><span class="header-section-number">7.3.3.3</span> Solution: Two-component scales<a href="system.html#two-component-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The linear mapping formula in <a href="system.html#def:linear-mapping">7.1</a> can guide us in decomposing the scale function into smaller, more manageable parts. Let’s look at it again:</p>
<p><span class="math display">\[s(d) = v_{min} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
<p>If we look closely, we may be able to see that there are two parts to the function:</p>
<!-- $$s(d) = \color{steelblue}{v_{min} +} \color{indianred}{\frac{\color{black}{d} - d_{min}}{d_{max} - d_{min}}} \color{steelblue}{\cdot (v_{max} - v_{min})}$$ -->
<p>That is, the linear mapping is composed of two simpler functions:</p>
<!-- - $\color{indianred}{n(d) = (d - d_{min}) / (d_{max} - d_{min})}$ takes a data value $d \in D$ and maps it to the interval $[0, 1]$ -->
<!-- - $\color{steelblue}{u(p) = v_{min} + p \cdot (v_{max} - v_{min})}$ takes a value in $[0, 1]$ and maps it to a visual attribute value $v \in V$  -->
<p>This leads us to the following definition of a scale:</p>
<div class="definition">
<p><span id="def:scale" class="definition"><strong>Definition 7.2  (Scale as composition of two functions) </strong></span>A scale <span class="math inline">\(s\)</span> can be created by composing:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(n: D \to [0, 1]\)</span>, mapping data to the interval <span class="math inline">\([0, 1]\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(u: [0, 1] \to V\)</span>, mapping value in <span class="math inline">\([0, 1]\)</span> to the visual attribute codomain</li>
</ul>
<p>Such that:</p>
<p><span class="math display">\[s(d) = u(n(d))\]</span></p>
</div>
<p>Note that the terms <em>normalize</em> and <em>unnormalize</em> are arbitrary, however, I think they make for useful labels. They represent 1-D equivalent of vector normalization, mapping a value in the domain to and from a unit interval <span class="math inline">\([0, 1]\)</span>.</p>
<p>For the case of the linear mapping, we could rewrite this in code as follows:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb68-1"><a href="system.html#cb68-1" tabindex="-1"></a><span class="co">// LinearMap.ts</span></span>
<span id="cb68-2"><a href="system.html#cb68-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">LinearMap</span> {</span>
<span id="cb68-3"><a href="system.html#cb68-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb68-4"><a href="system.html#cb68-4" tabindex="-1"></a>    <span class="cf">return</span> (d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)<span class="op">;</span></span>
<span id="cb68-5"><a href="system.html#cb68-5" tabindex="-1"></a>  }</span>
<span id="cb68-6"><a href="system.html#cb68-6" tabindex="-1"></a></span>
<span id="cb68-7"><a href="system.html#cb68-7" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb68-8"><a href="system.html#cb68-8" tabindex="-1"></a>    <span class="cf">return</span> vmin <span class="op">+</span> p <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb68-9"><a href="system.html#cb68-9" tabindex="-1"></a>  }</span>
<span id="cb68-10"><a href="system.html#cb68-10" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb69"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb69-1"><a href="system.html#cb69-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb69-2"><a href="system.html#cb69-2" tabindex="-1"></a></span>
<span id="cb69-3"><a href="system.html#cb69-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>))</span>
<span id="cb69-4"><a href="system.html#cb69-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb69-5"><a href="system.html#cb69-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0.5
## 400
## 400</code></pre>
<p>This two component system allows for a clean separation of concerns. Specifically, the normalize function only needs to know how to map the data values to <span class="math inline">\([0, 1]\)</span>. It does not need to be aware of where these normalized data values will be mapped to. Conversely, the unnormalize function only needs to understand how to translate values from <span class="math inline">\([0, 1]\)</span> to the space of the visual attribute (such as x-axis position).</p>
<div id="beyond-linear-maps" class="section level5 hasAnchor" number="7.3.3.3.1">
<h5><span class="header-section-number">7.3.3.3.1</span> Beyond linear maps<a href="system.html#beyond-linear-maps" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Another big advantage of the two-component scale system is that the functions <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> do not need to be a simple linear maps anymore. For example, suppose that our data <span class="math inline">\(D\)</span> takes form of a set of discrete labels, such as <span class="math inline">\(D = \{ Prague,  Vienna, Munich, Salzburg \}\)</span>. We can then replace <span class="math inline">\(n\)</span> with a surjective function <span class="math inline">\(n: D \to [0, 1]\)</span> such that:</p>
<p><span class="math display">\[n(d) = \begin{cases}  
0.2 &amp; \text{if } d = Munich
\\ 0.4 &amp; \text{if } d = Prague
\\ 0.6 &amp; \text{if } d = Salzburg
\\ 0.8 &amp; \text{if } d = Vienna
\end{cases}\]</span></p>
<p>In other words, <span class="math inline">\(n\)</span> will place values of <span class="math inline">\(D\)</span> at equidistant points along <span class="math inline">\([0, 1]\)</span>, ordered alphabetically. We can implement this function in code as follows:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb71-1"><a href="system.html#cb71-1" tabindex="-1"></a><span class="co">// PointMap.ts</span></span>
<span id="cb71-2"><a href="system.html#cb71-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">PointMap</span> {</span>
<span id="cb71-3"><a href="system.html#cb71-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb71-4"><a href="system.html#cb71-4" tabindex="-1"></a>    <span class="cf">return</span> (dlabels<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb71-5"><a href="system.html#cb71-5" tabindex="-1"></a>  }</span>
<span id="cb71-6"><a href="system.html#cb71-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Since the codomain of <span class="math inline">\(n\)</span> is still <span class="math inline">\([0, 1]\)</span>, we can compose it with a simple linear mapping <span class="math inline">\(u\)</span> just as easily as before:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb72-1"><a href="system.html#cb72-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb72-2"><a href="system.html#cb72-2" tabindex="-1"></a><span class="im">import</span> { PointMap } <span class="im">from</span> <span class="st">&quot;./PointMap.ts&quot;</span></span>
<span id="cb72-3"><a href="system.html#cb72-3" tabindex="-1"></a></span>
<span id="cb72-4"><a href="system.html#cb72-4" tabindex="-1"></a><span class="kw">const</span> labels <span class="op">=</span> [<span class="st">&quot;Munich&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Salzburg&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]<span class="op">;</span></span>
<span id="cb72-5"><a href="system.html#cb72-5" tabindex="-1"></a></span>
<span id="cb72-6"><a href="system.html#cb72-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Munich&quot;</span><span class="op">,</span> labels))<span class="op">;</span></span>
<span id="cb72-7"><a href="system.html#cb72-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Munich&quot;</span><span class="op">,</span> labels)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))<span class="op">;</span></span>
<span id="cb72-8"><a href="system.html#cb72-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Prague&quot;</span><span class="op">,</span> labels)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 0.2
## 160
## 320</code></pre>
</div>
<div id="inverses-1" class="section level5 hasAnchor" number="7.3.3.3.2">
<h5><span class="header-section-number">7.3.3.3.2</span> Inverses<a href="system.html#inverses-1" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Additionally, another property of the two-component scale system that can be useful is that, if both <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> are invertible, then so is <span class="math inline">\(s\)</span>. That is, we can easily obtain the inverse scale function by inverting the definition from <a href="system.html#def:scale">7.2</a>:</p>
<div class="definition">
<p><span id="def:scale-inverse" class="definition"><strong>Definition 7.3  (Scale inverse) </strong></span>If a scale <span class="math inline">\(s\)</span> is composed of invertible functions <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span>, then <span class="math inline">\(s\)</span> is invertible:</p>
<p><span class="math display">\[s^{-1}(v) = n^{-1}(u^{-1}(v))\]</span></p>
</div>
<p>This is the case for the simple linear map: the normalize and unnormalize functions are actually inverses of each other:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb74-1"><a href="system.html#cb74-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb74-2"><a href="system.html#cb74-2" tabindex="-1"></a></span>
<span id="cb74-3"><a href="system.html#cb74-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="dv">300</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">500</span>))</span></code></pre></div>
<pre><code>## 300</code></pre>
<p>However, the inverse may not always exist. In practice, this is often the case when the domain of the data <span class="math inline">\(D\)</span> is smaller than the codomain <span class="math inline">\([0, 1]\)</span>. Take, for example, the discrete point mapping. Since <span class="math inline">\(D\)</span> is finite but <span class="math inline">\([0, 1]\)</span> has infinitely many values, there will always be some values in <span class="math inline">\([0, 1]\)</span> that no <span class="math inline">\(d \in D\)</span> maps to. For example, if <span class="math inline">\(D = \{ Munich, Prague, Salzburg, Vienna \}\)</span> and <span class="math inline">\(Munich\)</span> maps to 0.2, <span class="math inline">\(Prague\)</span> maps to <span class="math inline">\(0.4\)</span>, and <span class="math inline">\(Salzburg\)</span> maps to <span class="math inline">\(0.8\)</span>, then there are no cities which map to 0.9, 0.444, or 0.123456789. Conversely, if we get given those numeric values, then there is no obvious way to map them back to the cities.</p>
<p>One thing we can do is to replace the inverse/unnormalize function with a weaker form of inverse, called retraction <span class="citation">(<a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>)</span>. Specifically, if we have a normalize function <span class="math inline">\(n: D \to [0, 1]\)</span>, then an unnormalize retraction <span class="math inline">\(u^*\)</span> will have the property that:</p>
<p><span class="math display">\[u^*(n(d)) = d \qquad \forall d \in D\]</span></p>
<p>However, the converse doesn’t necessarily hold:</p>
<p><span class="math display">\[\neg \big[ n(u^*(v)) = v \qquad \forall v \in V \big]\]</span></p>
<p>For example, for the discrete point mapping, a retraction may map a value in <span class="math inline">\([0, 1]\)</span> to the closest data value <span class="math inline">\(d \in D\)</span>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb76-1"><a href="system.html#cb76-1" tabindex="-1"></a><span class="co">// PointMap.ts</span></span>
<span id="cb76-2"><a href="system.html#cb76-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">PointMap</span> {</span>
<span id="cb76-3"><a href="system.html#cb76-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb76-4"><a href="system.html#cb76-4" tabindex="-1"></a>    <span class="cf">return</span> (dlabels<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb76-5"><a href="system.html#cb76-5" tabindex="-1"></a>  }</span>
<span id="cb76-6"><a href="system.html#cb76-6" tabindex="-1"></a>  </span>
<span id="cb76-7"><a href="system.html#cb76-7" tabindex="-1"></a>  <span class="co">// Retraction - find the closest label</span></span>
<span id="cb76-8"><a href="system.html#cb76-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb76-9"><a href="system.html#cb76-9" tabindex="-1"></a>    <span class="kw">const</span> k <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(p <span class="op">*</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb76-10"><a href="system.html#cb76-10" tabindex="-1"></a>    <span class="cf">return</span> dlabels[k]</span>
<span id="cb76-11"><a href="system.html#cb76-11" tabindex="-1"></a>  }</span>
<span id="cb76-12"><a href="system.html#cb76-12" tabindex="-1"></a>}</span>
<span id="cb76-13"><a href="system.html#cb76-13" tabindex="-1"></a></span>
<span id="cb76-14"><a href="system.html#cb76-14" tabindex="-1"></a><span class="kw">const</span> labels <span class="op">=</span> [<span class="st">&quot;Munich&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Salzburg&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]<span class="op">;</span></span>
<span id="cb76-15"><a href="system.html#cb76-15" tabindex="-1"></a></span>
<span id="cb76-16"><a href="system.html#cb76-16" tabindex="-1"></a><span class="kw">const</span> [prague<span class="op">,</span> munich] <span class="op">=</span> [<span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Munich&quot;</span>]<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> PointMap<span class="op">.</span><span class="fu">normalize</span>(x<span class="op">,</span> labels))</span>
<span id="cb76-17"><a href="system.html#cb76-17" tabindex="-1"></a><span class="kw">const</span> midpoint <span class="op">=</span> (prague <span class="op">+</span> munich) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb76-18"><a href="system.html#cb76-18" tabindex="-1"></a></span>
<span id="cb76-19"><a href="system.html#cb76-19" tabindex="-1"></a><span class="co">// Helper function for stripping away floating point error </span></span>
<span id="cb76-20"><a href="system.html#cb76-20" tabindex="-1"></a><span class="kw">const</span> strip <span class="op">=</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="pp">parseFloat</span>(x<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">12</span>))</span>
<span id="cb76-21"><a href="system.html#cb76-21" tabindex="-1"></a></span>
<span id="cb76-22"><a href="system.html#cb76-22" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Midpoint between Munich and Prague: `</span><span class="op">,</span> <span class="fu">strip</span>(midpoint))</span>
<span id="cb76-23"><a href="system.html#cb76-23" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`unnormalize(0.2999): `</span><span class="op">,</span> PointMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.2999</span><span class="op">,</span> labels))</span>
<span id="cb76-24"><a href="system.html#cb76-24" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`unnormalize(3): `</span><span class="op">,</span> PointMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.3</span><span class="op">,</span> labels))</span></code></pre></div>
<pre><code>## Midpoint between Munich and Prague:  0.3
## unnormalize(0.2999):  Munich
## unnormalize(3):  Prague</code></pre>
<p>While inverses are always unique <span class="citation">(<a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>; <a href="#ref-fong2019">Fong and Spivak 2019</a>)</span>, we may be able to come up with many different retractions for any given function. For example, with the discrete point map above, we could use the floor function instead of rounding and assign label to a value in <span class="math inline">\([0, 1]\)</span> if it is less than the value of the normalized label (but more than the preceding labels).</p>
<p>The non-uniqueness of retractions presents a bit of a dilemma. How do we decide which retraction to use? And, if a certain retractive implementation of <code>unnormalize</code> returns a value, how do we decide if it is the “correct one”?</p>
<p>However, in practice, this is not much of a problem. While developing the package, I found that I’ve only ever had to use the <code>unnormalize</code> function with continuous data (<code>LinearMap</code>), and so the inverse was always well-defined. This is probably also why packages like <code>ggplot2</code> and <code>D3</code> can get by without this functionality. However, I still find it helpful to include the <code>unnormalize</code> function as a first class citizen (instead of it being relegated to some special case), both in terms of the mental model and also for debugging.</p>
</div>
<div id="some-other-remarks-about-the-two-component-scale-system" class="section level5 hasAnchor" number="7.3.3.3.3">
<h5><span class="header-section-number">7.3.3.3.3</span> Some other remarks about the two-component scale system<a href="system.html#some-other-remarks-about-the-two-component-scale-system" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>It is worth noting that there is nothing inherently special about the interval <span class="math inline">\([0, 1]\)</span> as the intermediate domain: any finite subset of <span class="math inline">\(\mathbb{R}\)</span> would do. However, the interval <span class="math inline">\([0, 1]\)</span> is convenient, both in terms of interpretation as well as for implementation, as we will see later.</p>
<p>Finally, so far I have discussed scales as <em>functions</em>: the scale function, the normalize function, and unnormalize function. Framing scales as composition of functions leads to a nice correspondence between the mathematical definition and the code. However, in practice, it may be more convenient to implement the domain and codomain as <em>objects</em> or <em>classes</em>, as we will also see in the following section. The important point is that, no matter how the two components are represented, each is responsible for translating values from/to its domain and the interval <span class="math inline">\([0, 1]\)</span>.</p>
</div>
</div>
<div id="past-implementations-of-scales" class="section level4 hasAnchor" number="7.3.3.4">
<h4><span class="header-section-number">7.3.3.4</span> Past implementations of scales<a href="system.html#past-implementations-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Two-component scale systems such as the one sketched out above are fairly standard across data visualization libraries. For example, in <code>D3</code> <span class="citation">(<a href="#ref-bostock2011">Bostock, Ogievetsky, and Heer 2011</a>)</span>, scales are implemented in a functional style, such that the data domain and the visual attribute codomain are passed as tuples or arrays of values to a higher-order <code>scale*</code> function (such as <code>scaleLinear</code>, <code>scalePoint</code>, or <code>scaleBand</code>), which then returns a new function that can be used for scaling. The domain and codomain can also be changed at a later point, by using the <code>scale*.domain</code> and <code>scale*.range</code> methods respectively (JavaScript functions are objects and can have other functions/methods attached to them).</p>
<p>For illustration, here is an example from the official documentation <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>)</span>:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb78-1"><a href="system.html#cb78-1" tabindex="-1"></a><span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">960</span>])<span class="op">;</span></span>
<span id="cb78-2"><a href="system.html#cb78-2" tabindex="-1"></a><span class="fu">x</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// 80</span></span>
<span id="cb78-3"><a href="system.html#cb78-3" tabindex="-1"></a><span class="kw">const</span> color <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span> [<span class="st">&quot;brown&quot;</span><span class="op">,</span> <span class="st">&quot;steelblue&quot;</span>])<span class="op">;</span></span>
<span id="cb78-4"><a href="system.html#cb78-4" tabindex="-1"></a><span class="fu">color</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// &quot;rgb(154, 52, 57)&quot;</span></span>
<span id="cb78-5"><a href="system.html#cb78-5" tabindex="-1"></a><span class="co">// The domain and codomain can be changed after initialization</span></span>
<span id="cb78-6"><a href="system.html#cb78-6" tabindex="-1"></a><span class="kw">const</span> y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>])<span class="op">;</span> </span></code></pre></div>
<p>Internally, the <code>scale*</code> functions rely on other specialized functions to translate from its domain to the codomain (such as the <code>normalize()</code> and <code>scale()</code> functions for continuous and discrete/ordinal domains, respectively, and various <code>interpolate()</code> functions for codomains).</p>
<p>Similarly, in <code>ggplot2</code> <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span>, scales are built upon the <code>Scale</code> class, with each subtype implementing <code>limits</code> and <code>palette</code> properties. The <code>limits</code> property is a vector which corresponds to the data domain and the <code>palette</code> property is a function which corresponds roughly to the visual codomain (the x- and y-position behave slightly differently, due to being transformed via coordinate systems). Internally, the package uses the <code>rescale</code> function from the <code>scales</code> package <span class="citation">(<a href="#ref-wickham2023">Wickham, Pedersen, and Seidel 2023</a>)</span> to map data values to <span class="math inline">\([0, 1]\)</span> and then the <code>palette</code> function is responsible for mapping these normalized values to the visual attribute. For illustration, here’s the full definition of the <code>map</code> method on the <code>ScaleContinuous</code> class (I’ve added comments for clarity):</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="system.html#cb79-1" tabindex="-1"></a>map <span class="ot">=</span> <span class="cf">function</span>(self, x, <span class="at">limits =</span> self<span class="sc">$</span><span class="fu">get_limits</span>()) {</span>
<span id="cb79-2"><a href="system.html#cb79-2" tabindex="-1"></a>  <span class="co"># Limits are just a tuple, rescale maps x to [0, 1]</span></span>
<span id="cb79-3"><a href="system.html#cb79-3" tabindex="-1"></a>  x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">rescale</span>(self<span class="sc">$</span><span class="fu">oob</span>(x, <span class="at">range =</span> limits), limits) </span>
<span id="cb79-4"><a href="system.html#cb79-4" tabindex="-1"></a></span>
<span id="cb79-5"><a href="system.html#cb79-5" tabindex="-1"></a>  uniq <span class="ot">&lt;-</span> <span class="fu">unique0</span>(x)</span>
<span id="cb79-6"><a href="system.html#cb79-6" tabindex="-1"></a>  <span class="co"># Palette is a function which returns a vector of attribute values</span></span>
<span id="cb79-7"><a href="system.html#cb79-7" tabindex="-1"></a>  pal <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">palette</span>(uniq) </span>
<span id="cb79-8"><a href="system.html#cb79-8" tabindex="-1"></a>  scaled <span class="ot">&lt;-</span> pal[<span class="fu">match</span>(x, uniq)]</span>
<span id="cb79-9"><a href="system.html#cb79-9" tabindex="-1"></a></span>
<span id="cb79-10"><a href="system.html#cb79-10" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(scaled), scaled, self<span class="sc">$</span>na.value)</span>
<span id="cb79-11"><a href="system.html#cb79-11" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="proposed-model-of-scales" class="section level4 hasAnchor" number="7.3.3.5">
<h4><span class="header-section-number">7.3.3.5</span> Proposed model of scales<a href="system.html#proposed-model-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One feature that the models of scales that <code>D3</code> and <code>ggplot2</code> rely on is that they both treat the data domain and the visual attribute codomain as different types. In <code>D3</code>, fundamentally different functions are used to translate from <span class="math inline">\(D \to [0, 1]\)</span> and from <span class="math inline">\([0, 1] \to V\)</span>, and in <code>ggplot2</code>, <code>limits</code> is a simple vector/tuple whereas <code>palette</code> is a function. While these approaches may have some benefits, such as perhaps offering greater flexibility, they also add additional complexity. Specifically, we have to use two different mental models: one when considering the domain and another when considering the codomain. Further, these models of scales only work in one direction: mapping values <span class="math inline">\(D \to V\)</span>. For going the the other way, i.e. mapping <span class="math inline">\(V \to D\)</span>, other specialized functions have to be used.</p>
<p>I propose a model of scales which implements both the domain and the codomain as components of the same type: <code>Expanse</code>. Fundamentally, this makes it so that the only difference between the data domain and the visual attribute codomain is which property of the scale they are assigned to.</p>
<p>Here is a (slightly) simplified version of the <code>Scale</code> interface:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb80-1"><a href="system.html#cb80-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb80-2"><a href="system.html#cb80-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb80-3"><a href="system.html#cb80-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb80-4"><a href="system.html#cb80-4" tabindex="-1"></a>}</span></code></pre></div>
<p><code>D</code> and <code>V</code> represent the data domain and the visual attribute codomain, respectively.</p>
<p>The two fundamental functions connected to <code>Scale</code> are:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb81-1"><a href="system.html#cb81-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span></span>
<span id="cb81-2"><a href="system.html#cb81-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span></span></code></pre></div>
<p>The <code>pushforward</code> function <em>pushes values forward</em> through the scale, first through its domain and then its codomain, and the <code>pullback</code> function <em>pulls values back</em>, first through its codomain and then through its domain. The <code>ValueOf</code> type helper just identifies the type associated with the expanse’s data (e.g. <code>number</code> for a continuous <code>Expanse</code>, <code>string</code> for a discrete <code>Expanse</code>, etc…). I’ve omitted the generic type parameter constraint (<code>&lt;D extends Expanse, V extends Expanse&gt;</code>) for brevity.</p>
<p>Here is a simplified implementation of the two functions:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb82-1"><a href="system.html#cb82-1" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb82-2"><a href="system.html#cb82-2" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span> {</span>
<span id="cb82-3"><a href="system.html#cb82-3" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb82-4"><a href="system.html#cb82-4" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value))<span class="op">;</span></span>
<span id="cb82-5"><a href="system.html#cb82-5" tabindex="-1"></a>  }</span>
<span id="cb82-6"><a href="system.html#cb82-6" tabindex="-1"></a></span>
<span id="cb82-7"><a href="system.html#cb82-7" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span> {</span>
<span id="cb82-8"><a href="system.html#cb82-8" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb82-9"><a href="system.html#cb82-9" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(domain<span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(codomain<span class="op">,</span> value))</span>
<span id="cb82-10"><a href="system.html#cb82-10" tabindex="-1"></a>  }</span>
<span id="cb82-11"><a href="system.html#cb82-11" tabindex="-1"></a>}</span></code></pre></div>
<p>We can see that most of the work is done by the two <code>Expanse</code> components: we use <code>domain</code> to translates <span class="math inline">\(D \to [0, 1]\)</span> and codomain to translate <span class="math inline">\([0, 1] \to V\)</span>. <code>Scale</code> only serves as plumbing, connecting the two together.</p>
<p>I argue that this model provides several benefits. First of all, it makes the code easier to reason about. Since both the <code>domain</code> and <code>codomain</code> are of the same type, we only need to keep a single mental model in mind. Second, if <code>domain</code> and <code>codomain</code> provide inverse functions (<code>unnormalize</code>), we get the inverse scale function <span class="math inline">\(V \to D\)</span> for free (this is just the <code>pullback</code> function).</p>
<p>However, before we discuss <code>Expanse</code>, there are also some important functionalities that we may want to implement on <code>Scale</code> directly. There are two main reasons for this. First, we may want these functionalities to apply generally, across the various <code>Expanse</code> subtypes. Second, by implementing them on <code>Scale</code>, we can keep the <code>Expanse</code> interface cleaner. These general functionalities will be the subject of the next few sections.</p>
<div id="zero-and-one" class="section level5 hasAnchor" number="7.3.3.5.1">
<h5><span class="header-section-number">7.3.3.5.1</span> Zero and one<a href="system.html#zero-and-one" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Recall how in Section <a href="problems.html#simple-scale-limits">4.4.0.2</a>, we discussed the problem of expanding axis limits to display margins. Clearly, this is something that we also want to be able to do with our two-component scales. However, since we are designing an interactive data visualization system, we also want to be able to do more with axis limits: we want to be able to manipulate them dynamically during runtime, to implement features such as zooming and panning.</p>
<p>In Section <a href="problems.html#simple-scale-limits">4.4.0.2</a>, we solved the problem of expanding axis limits by adding an additional argument to the <code>simpleScale</code> function. However, as was discussed previously, this approach does not scale well for more featureful implementations of scales. So how should we go about implementing dynamic axis limits in the context of the two-component scale system?</p>
<p>Suppose we want to add margins to a scale where both the domain or codomain are continuous, such as the x-axis in a typical scatterplot. To implement margins, we could either expand the range of the data (the domain) or shrink the range of the visual attribute (the codomain). However, expanding the domain seems like a bad idea - this only works if the domain is continuous, and, clearly, we may want to add margins to discrete scales too, such the the x-axis of a barplot. Shrinking the range of the codomain could work (most visual attributes are continuous), however, we would need to implement some custom logic for when the plot gets resized. Also, by treating codomain differently than the codomain, we would be breaking away from our intention of representing both with the same generic <code>Expanse</code> type.</p>
<p>So what can we do? As was foreshadowed at end of the previous section, we can put the functionality for expanding axis limits directly onto <code>Scale</code>. Specifically, notice that any values passing through a scale are first converted to the interval <span class="math inline">\([0, 1]\)</span> and then back to the space of either the domain or codomain:</p>
<p><span class="math display">\[D \to [0, 1] \to V\]</span></p>
<p>If we re-normalize these normalized values in <span class="math inline">\([0, 1]\)</span>, we effectively expand or shrink axis limits without having to touch either the domain or codomain. To give a metaphor, if we imagine <code>Scale</code> as a pipe connecting the <code>domain</code> and <code>codomain</code>, we can manipulate axis limits by stretching or squeezing this pipe, allowing more or less water to flow through.</p>
<p>To actually implement this, we can add two additional parameters to <code>Scale</code>, <code>zero</code> and <code>one</code>:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb83-1"><a href="system.html#cb83-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb83-2"><a href="system.html#cb83-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb83-3"><a href="system.html#cb83-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb83-4"><a href="system.html#cb83-4" tabindex="-1"></a>  props<span class="op">:</span> { <span class="co">// A dictionary of properties</span></span>
<span id="cb83-5"><a href="system.html#cb83-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb83-6"><a href="system.html#cb83-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb83-7"><a href="system.html#cb83-7" tabindex="-1"></a>  }</span>
<span id="cb83-8"><a href="system.html#cb83-8" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we can use these two parameters to implement a new version of the <code>pushforward</code> function:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb84-1"><a href="system.html#cb84-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> D)<span class="op">:</span> V {</span>
<span id="cb84-2"><a href="system.html#cb84-2" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> props } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb84-3"><a href="system.html#cb84-3" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">,</span> one } <span class="op">=</span> props</span>
<span id="cb84-4"><a href="system.html#cb84-4" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)</span>
<span id="cb84-5"><a href="system.html#cb84-5" tabindex="-1"></a>  normalized <span class="op">=</span> zero <span class="op">+</span> normalized <span class="op">*</span> (one <span class="op">-</span> zero) <span class="co">// Re-normalize</span></span>
<span id="cb84-6"><a href="system.html#cb84-6" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)</span>
<span id="cb84-7"><a href="system.html#cb84-7" tabindex="-1"></a>}</span></code></pre></div>
<p>The new function’s body is a bit more dense, however, the only real change is in the line with the comment. When we re-normalize, we scale the normalized value by the <code>(zero - one)</code> range and increment it by <code>zero</code>. In other words, <code>zero</code> tells us the proportion of the codomain range that the minimum data value gets mapped to, and <code>one</code> tells us the proportion of the codomain range that the maximum data value gets mapped to.</p>
<p>For example, suppose we set <code>zero</code> to 0.1 and <code>one</code> to 0.9. Then we have effectively implemented 10% margins on either side of the scale. If our scale has a <span class="math inline">\([1, 10]\)</span> domain and <span class="math inline">\([0, 800]\)</span> codomain, this will result in the following mapping:</p>
<ul>
<li>The “minimum” data value (1) gets mapped to 10% of the codomain range (80)
<ul>
<li>Because <code>zero + 0 * (one - zero) = zero = 0.1</code></li>
</ul></li>
<li>The “maximum” data value (10) gets mapped to 90% of the codomain range (720)
<ul>
<li>Because <code>zero + 1 * (one - zero) = one = 0.9</code></li>
</ul></li>
</ul>
<p>Note the quotation marks around the words “minimum” and “maximum” - there is no requirement for the data to be continuous. For example, if the domain is a discrete <code>Expanse</code> which maps the string value <code>"A"</code> to zero, then the <code>pushforward</code> function will map <code>"A"</code> to 10% of the codomain range, just as it did in the case of the continuous domain. Likewise, the codomain could also be discrete - we could use this to implement scales for binned versions of visual attributes such as color or size.</p>
<p>Thus, we can use <code>zero</code> and <code>one</code> to implement margins. However, there is much more we can do with these parameters. First, despite the names, <code>zero</code> and <code>one</code> can both take values <em>less</em> than zero and <em>more</em> than one. For example, suppose we increment both <code>zero</code> and <code>one</code> by the same amount, e.g. we set <code>zero</code> to 0.1 and <code>one</code> to 1.1. Then, the minimum data value will get mapped to the 10% of the codomain range, and the maximum data value will get mapped to 110% of the codomain range (which may lie outside the space representable by the graphic device). If the codomain represents the x-axis position, then we have shifted all of the geometric objects 10% to the right. We have effectively implemented <em>panning</em>:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb85-1"><a href="system.html#cb85-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb85-2"><a href="system.html#cb85-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">zero</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb85-3"><a href="system.html#cb85-3" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">one</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb85-4"><a href="system.html#cb85-4" tabindex="-1"></a>}</span></code></pre></div>
<p>That’s it. We have implemented a functionality for panning which will work no matter if <code>domain</code> translates numbers, strings, or some other more complex data types.</p>
<p>We can also stretch or shrink <code>zero</code> and <code>one</code> in opposite directions. For example, by setting <code>zero</code> to -0.5 and <code>one</code> to 1.5, then the minimum and maximum data values will get mapped 50% below and 50% above the limits of the codomain range, respectively, and the 25 and 75 data percentiles will get mapped to the minimum and maximum of the codomain range. If we apply this to the x- or y-axes, we’ve just implemented <em>zooming</em>.</p>
<p>To be perfectly honest, there’s a bit more ceremony involved with zooming. Specifically, if we don’t start from <code>zero = 0</code> and <code>one = 1</code> (e.g. if our plot already has margins or if we’re zooming in multiple levels deep), then we need to re-normalize within these values. This took me a bit of time to nail down, however, it’s just (highschool) algebra:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb86-1"><a href="system.html#cb86-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rangeInverse</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb86-2"><a href="system.html#cb86-2" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (max <span class="op">-</span> min)<span class="op">;</span></span>
<span id="cb86-3"><a href="system.html#cb86-3" tabindex="-1"></a>}</span>
<span id="cb86-4"><a href="system.html#cb86-4" tabindex="-1"></a></span>
<span id="cb86-5"><a href="system.html#cb86-5" tabindex="-1"></a><span class="kw">function</span> <span class="fu">invertRange</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb86-6"><a href="system.html#cb86-6" tabindex="-1"></a>  <span class="kw">const</span> ri <span class="op">=</span> <span class="fu">rangeInverse</span>(min<span class="op">,</span> max)<span class="op">;</span></span>
<span id="cb86-7"><a href="system.html#cb86-7" tabindex="-1"></a>  <span class="cf">return</span> [<span class="op">-</span>min <span class="op">*</span> ri<span class="op">,</span> ri <span class="op">-</span> min <span class="op">*</span> ri]<span class="op">;</span></span>
<span id="cb86-8"><a href="system.html#cb86-8" tabindex="-1"></a>}</span>
<span id="cb86-9"><a href="system.html#cb86-9" tabindex="-1"></a></span>
<span id="cb86-10"><a href="system.html#cb86-10" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb86-11"><a href="system.html#cb86-11" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">expand</span>(</span>
<span id="cb86-12"><a href="system.html#cb86-12" tabindex="-1"></a>    scale<span class="op">:</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span> one<span class="op">:</span> <span class="dt">number</span> } }<span class="op">,</span></span>
<span id="cb86-13"><a href="system.html#cb86-13" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb86-14"><a href="system.html#cb86-14" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb86-15"><a href="system.html#cb86-15" tabindex="-1"></a>  ) {</span>
<span id="cb86-16"><a href="system.html#cb86-16" tabindex="-1"></a>    <span class="kw">const</span> { zero<span class="op">:</span> currentZero<span class="op">,</span> one<span class="op">:</span> currentOne } <span class="op">=</span> scale<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb86-17"><a href="system.html#cb86-17" tabindex="-1"></a>    <span class="kw">const</span> currentRange <span class="op">=</span> currentOne <span class="op">-</span> currentZero<span class="op">;</span></span>
<span id="cb86-18"><a href="system.html#cb86-18" tabindex="-1"></a>    </span>
<span id="cb86-19"><a href="system.html#cb86-19" tabindex="-1"></a>    <span class="co">// Re-normalize within current values</span></span>
<span id="cb86-20"><a href="system.html#cb86-20" tabindex="-1"></a>    zero <span class="op">=</span> (zero <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb86-21"><a href="system.html#cb86-21" tabindex="-1"></a>    one <span class="op">=</span> (one <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb86-22"><a href="system.html#cb86-22" tabindex="-1"></a></span>
<span id="cb86-23"><a href="system.html#cb86-23" tabindex="-1"></a>    <span class="co">// Invert</span></span>
<span id="cb86-24"><a href="system.html#cb86-24" tabindex="-1"></a>    [zero<span class="op">,</span> one] <span class="op">=</span> <span class="fu">invertRange</span>(zero<span class="op">,</span> one)<span class="op">;</span></span>
<span id="cb86-25"><a href="system.html#cb86-25" tabindex="-1"></a></span>
<span id="cb86-26"><a href="system.html#cb86-26" tabindex="-1"></a>    scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">zero</span> <span class="op">=</span> zero<span class="op">;</span></span>
<span id="cb86-27"><a href="system.html#cb86-27" tabindex="-1"></a>    scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">one</span> <span class="op">=</span> one<span class="op">;</span></span>
<span id="cb86-28"><a href="system.html#cb86-28" tabindex="-1"></a>  }</span>
<span id="cb86-29"><a href="system.html#cb86-29" tabindex="-1"></a>}</span>
<span id="cb86-30"><a href="system.html#cb86-30" tabindex="-1"></a></span>
<span id="cb86-31"><a href="system.html#cb86-31" tabindex="-1"></a><span class="kw">const</span> scale1 <span class="op">=</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> one<span class="op">:</span> <span class="dv">1</span> } }<span class="op">;</span> <span class="co">// Mock of default scale</span></span>
<span id="cb86-32"><a href="system.html#cb86-32" tabindex="-1"></a><span class="kw">const</span> scale2 <span class="op">=</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="fl">0.1</span><span class="op">,</span> one<span class="op">:</span> <span class="fl">0.9</span> } }<span class="op">;</span> <span class="co">// Mock of scale with margins</span></span>
<span id="cb86-33"><a href="system.html#cb86-33" tabindex="-1"></a></span>
<span id="cb86-34"><a href="system.html#cb86-34" tabindex="-1"></a><span class="co">// Zoom into the middle 50% of either scale</span></span>
<span id="cb86-35"><a href="system.html#cb86-35" tabindex="-1"></a>Scale<span class="op">.</span><span class="fu">expand</span>(scale1<span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb86-36"><a href="system.html#cb86-36" tabindex="-1"></a>Scale<span class="op">.</span><span class="fu">expand</span>(scale2<span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb86-37"><a href="system.html#cb86-37" tabindex="-1"></a></span>
<span id="cb86-38"><a href="system.html#cb86-38" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Zoomed in scale with no margins`</span><span class="op">,</span> scale1<span class="op">.</span><span class="at">props</span>)<span class="op">;</span></span>
<span id="cb86-39"><a href="system.html#cb86-39" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Zoomed in scale with 10% margins`</span><span class="op">,</span> scale2<span class="op">.</span><span class="at">props</span>)<span class="op">;</span></span></code></pre></div>
<pre><code>## Zoomed in scale with no margins {
##   zero: -0.5,
##   one: 1.5,
## }
## Zoomed in scale with 10% margins {
##   zero: -0.3,
##   one: 1.3,
## }</code></pre>
<p>As you can see, zooming into the middle 50% of a scale that already includes margins has a smaller effect on <code>zero</code> and <code>one</code>, since the margins have effectively expand the space we’re zooming into (i.e., a scale with margins is already <em>zoomed out</em>, in a way).</p>
</div>
<div id="direction" class="section level5 hasAnchor" number="7.3.3.5.2">
<h5><span class="header-section-number">7.3.3.5.2</span> Direction<a href="system.html#direction" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In the same way we can think about expanding/shrinking axis limits in a way that is not coupled to any particular data representation or visual attribute, it may also be helpful to make direction a property of <code>Scale</code> rather than either of the <code>Expanse</code> components.</p>
<p>We <em>could</em> do this by manipulating the <code>zero</code> and <code>one</code> properties. For example, by setting <code>zero</code> to 1 and <code>one</code> to 0, we could effectively reverse the direction of the scale. However, in practice, this would complicate our logic and make it harder for someone to interpret the <code>Scale</code> properties. It is a better idea to add an explicit <code>direction</code> parameter instead:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb88-1"><a href="system.html#cb88-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb88-2"><a href="system.html#cb88-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb88-3"><a href="system.html#cb88-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb88-4"><a href="system.html#cb88-4" tabindex="-1"></a>  props<span class="op">:</span> {</span>
<span id="cb88-5"><a href="system.html#cb88-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb88-6"><a href="system.html#cb88-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb88-7"><a href="system.html#cb88-7" tabindex="-1"></a>    direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span> <span class="co">// Extra parameter</span></span>
<span id="cb88-8"><a href="system.html#cb88-8" tabindex="-1"></a>  }</span>
<span id="cb88-9"><a href="system.html#cb88-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Like with <code>zero</code> and <code>one</code>, <code>direction</code> acts on the normalized values in <span class="math inline">\([0, 1]\)</span>. This means that we need to apply it in any transformations that use these values. For example, here’s an updated version of the <code>move</code> function:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb89-1"><a href="system.html#cb89-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb89-2"><a href="system.html#cb89-2" tabindex="-1"></a>  <span class="kw">let</span> { direction<span class="op">,</span> zero<span class="op">,</span> one } <span class="op">=</span> scale<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb89-3"><a href="system.html#cb89-3" tabindex="-1"></a>  zero <span class="op">+=</span> direction <span class="op">*</span> amount<span class="op">;</span></span>
<span id="cb89-4"><a href="system.html#cb89-4" tabindex="-1"></a>  one <span class="op">+=</span> direction <span class="op">*</span> amount<span class="op">;</span></span>
<span id="cb89-5"><a href="system.html#cb89-5" tabindex="-1"></a>}</span></code></pre></div>
<p>Likewise, the <code>pushforward</code>, <code>pullback</code>, and <code>expand</code> functions also need to take <code>direction</code> into account. Either way, with this functionality in place, it becomes trivial to flip or reverse a scale:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb90-1"><a href="system.html#cb90-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">flip</span>(scale<span class="op">:</span> Scale) {</span>
<span id="cb90-2"><a href="system.html#cb90-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">direction</span> <span class="op">-=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb90-3"><a href="system.html#cb90-3" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="multipliers" class="section level5 hasAnchor" number="7.3.3.5.3">
<h5><span class="header-section-number">7.3.3.5.3</span> Multipliers<a href="system.html#multipliers" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Finally, it may also be helpful to have the ability to shrink/expand the normalized values by some constant without having to modify properties of either the <code>domain</code> or <code>codomain</code>. Again, this could be done by using the <code>zero</code> and <code>one</code> properties, however, it’s better to define separate properties instead. Specifically, we can add <em>two</em> additional parameters:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb91-1"><a href="system.html#cb91-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb91-2"><a href="system.html#cb91-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb91-3"><a href="system.html#cb91-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb91-4"><a href="system.html#cb91-4" tabindex="-1"></a>  props<span class="op">:</span> {</span>
<span id="cb91-5"><a href="system.html#cb91-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb91-6"><a href="system.html#cb91-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb91-7"><a href="system.html#cb91-7" tabindex="-1"></a>    direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb91-8"><a href="system.html#cb91-8" tabindex="-1"></a>    scale<span class="op">:</span> <span class="dt">number</span> <span class="co">// Extra parameter</span></span>
<span id="cb91-9"><a href="system.html#cb91-9" tabindex="-1"></a>    mult<span class="op">:</span> <span class="dt">number</span> <span class="co">// And another one</span></span>
<span id="cb91-10"><a href="system.html#cb91-10" tabindex="-1"></a>  }</span>
<span id="cb91-11"><a href="system.html#cb91-11" tabindex="-1"></a>}</span></code></pre></div>
<p>The reason it is better to have two multiplier parameters instead of just one is that there are different reasons for why we may want to multiply values by a constant. First, we may want to multiply the values by some constant that remains fairly static throughout the lifetime of the program/visualization. That is the job of the <code>scale</code> parameter. Conversely, we may want to also dynamically manipulate the constant by which the values are multiplied. That is what <code>mult</code> is for. Having two multipliers makes it easier to reason about the scale’s behavior, as well as to apply changes such as restoring to defaults.</p>
<p>A good example of this is the barplot. In a typical barplot, all bars share the same width, which is some fraction of the width of the entire plotting region. Clearly, this fraction needs to depend on the number of bars in the plot, such that, with <span class="math inline">\(k\)</span> categories/bars, the bar width will be proportional to <span class="math inline">\(k\)</span>. However, we may also want to be able to make the bars wider/narrower interactively, e.g. by pressing the <code>+\-</code> keys. Thus, the width of the bars is proportional to <span class="math inline">\(c \cdot k\)</span> where <span class="math inline">\(k\)</span> is the static part of the constant (<code>scale</code>) and <span class="math inline">\(c\)</span> is the dynamic part of the constant (<code>mult</code>).</p>
<p>We apply the constant to the normalized value each time we push/pull a value through a scale:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb92-1"><a href="system.html#cb92-1" tabindex="-1"></a><span class="co">// This will be included in the body of pushforward(); see below for full example</span></span>
<span id="cb92-2"><a href="system.html#cb92-2" tabindex="-1"></a><span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)</span>
<span id="cb92-3"><a href="system.html#cb92-3" tabindex="-1"></a>normalized <span class="op">=</span> normalized <span class="op">*</span> scale <span class="op">*</span> mult</span></code></pre></div>
<p>Finally, we could hypothetically extend this idea to an entire array of different multipliers, that we could reduce into a single constant each time we push a value through a scale. This could be useful in some circumstances, however, in my application, I found that having two parameters was enough to solve all of my scaling problems. Additionally, having an array of multipliers might make the scaling functions slightly less performant, if we have to reduce the array each time we <code>pushforward</code>/<code>pullback</code>, or it might make keeping track of the state of the <code>Scale</code> object slightly more complicated, if we roll these multipliers into one constant each time we update the array. We would also lose the semantic distinction that we have with <code>scale</code> and <code>mult</code>. This might be a perfectly fine trade-off if our scales require more multipliers, however, I did not find this to be the case in my implementation.</p>
</div>
<div id="the-full-monty" class="section level5 hasAnchor" number="7.3.3.5.4">
<h5><span class="header-section-number">7.3.3.5.4</span> The Full Monty<a href="system.html#the-full-monty" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>With all of the pieces in place, we can put together the full implementation of the <code>pushforward</code> function.</p>
<p>It may be helpful to define two helper function for applying the <code>Scale</code> properties to a normalized value. First, the <code>applyDirection</code> function simply applies the <code>direction</code> property, such that <code>applyDirection(x, 1)</code> is simply the identity whereas <code>applyDirection(x, -1)</code> returns <code>1 - x</code> (i.e. moving from <code>one</code> down):</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb93-1"><a href="system.html#cb93-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyDirection</span>(x<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb93-2"><a href="system.html#cb93-2" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> direction) <span class="op">+</span> direction <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb93-3"><a href="system.html#cb93-3" tabindex="-1"></a>}</span>
<span id="cb93-4"><a href="system.html#cb93-4" tabindex="-1"></a></span>
<span id="cb93-5"><a href="system.html#cb93-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">0.75</span><span class="op">,</span> <span class="dv">1</span>))</span>
<span id="cb93-6"><a href="system.html#cb93-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">0.75</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb93-7"><a href="system.html#cb93-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">1.25</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 0.75
## 0.25
## -0.25</code></pre>
<p>Second, we can define the <code>applyPropsForward</code> function which takes a normalized value and applies all of the <code>Scale</code> properties to it:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb95-1"><a href="system.html#cb95-1" tabindex="-1"></a><span class="kw">type</span> Props <span class="op">=</span> {</span>
<span id="cb95-2"><a href="system.html#cb95-2" tabindex="-1"></a>  zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb95-3"><a href="system.html#cb95-3" tabindex="-1"></a>  one<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb95-4"><a href="system.html#cb95-4" tabindex="-1"></a>  direction<span class="op">:</span> <span class="op">-</span><span class="dv">1</span> <span class="op">|</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb95-5"><a href="system.html#cb95-5" tabindex="-1"></a>  scale<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb95-6"><a href="system.html#cb95-6" tabindex="-1"></a>  mult<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb95-7"><a href="system.html#cb95-7" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb95-8"><a href="system.html#cb95-8" tabindex="-1"></a></span>
<span id="cb95-9"><a href="system.html#cb95-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyPropsForward</span>(x<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> props<span class="op">:</span> Props) {</span>
<span id="cb95-10"><a href="system.html#cb95-10" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">,</span> one<span class="op">,</span> direction<span class="op">,</span> scale<span class="op">,</span> mult } <span class="op">=</span> props<span class="op">;</span></span>
<span id="cb95-11"><a href="system.html#cb95-11" tabindex="-1"></a>  x <span class="op">=</span> x <span class="op">*</span> scale <span class="op">*</span> mult<span class="op">;</span></span>
<span id="cb95-12"><a href="system.html#cb95-12" tabindex="-1"></a>  x <span class="op">=</span> zero <span class="op">+</span> x <span class="op">*</span> (one <span class="op">-</span> zero)<span class="op">;</span></span>
<span id="cb95-13"><a href="system.html#cb95-13" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">applyDirection</span>(x<span class="op">,</span> direction)<span class="op">;</span></span>
<span id="cb95-14"><a href="system.html#cb95-14" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we ready to define the full <code>pushforward</code> function. As one final note, we should probably be able to handle the case where the <code>domain</code> and <code>codomain</code> work on arrays of values rather than scalars (this can be helpful, for example, in the case of a parallel coordinates plot). As such, we can add an <code>if</code> block to check where the normalized value is an array and handle appropriately. In total:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb96-1"><a href="system.html#cb96-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>T <span class="kw">extends</span> Expanse<span class="op">,</span> U <span class="kw">extends</span> Expanse<span class="op">&gt;</span>(</span>
<span id="cb96-2"><a href="system.html#cb96-2" tabindex="-1"></a>  scale<span class="op">:</span> Scale<span class="op">&lt;</span>T<span class="op">,</span> U<span class="op">&gt;,</span></span>
<span id="cb96-3"><a href="system.html#cb96-3" tabindex="-1"></a>  value<span class="op">:</span> Expanse<span class="op">.</span><span class="at">Value</span><span class="op">&lt;</span>T<span class="op">&gt;,</span></span>
<span id="cb96-4"><a href="system.html#cb96-4" tabindex="-1"></a>)<span class="op">:</span> Expanse<span class="op">.</span><span class="at">Value</span><span class="op">&lt;</span>U<span class="op">&gt;</span> {</span>
<span id="cb96-5"><a href="system.html#cb96-5" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> props } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb96-6"><a href="system.html#cb96-6" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb96-7"><a href="system.html#cb96-7" tabindex="-1"></a></span>
<span id="cb96-8"><a href="system.html#cb96-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(normalized)) {</span>
<span id="cb96-9"><a href="system.html#cb96-9" tabindex="-1"></a>    normalized <span class="op">=</span> normalized<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> <span class="fu">applyPropsForward</span>(x<span class="op">,</span> props))<span class="op">;</span></span>
<span id="cb96-10"><a href="system.html#cb96-10" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb96-11"><a href="system.html#cb96-11" tabindex="-1"></a>    normalized <span class="op">=</span> <span class="fu">applyPropsForward</span>(normalized<span class="op">,</span> props)<span class="op">;</span></span>
<span id="cb96-12"><a href="system.html#cb96-12" tabindex="-1"></a>  }</span>
<span id="cb96-13"><a href="system.html#cb96-13" tabindex="-1"></a></span>
<span id="cb96-14"><a href="system.html#cb96-14" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)<span class="op">;</span></span>
<span id="cb96-15"><a href="system.html#cb96-15" tabindex="-1"></a>}</span></code></pre></div>
<p>This is the full definition of the <code>pushforward</code> function in <code>plotscape</code> as of 2025-03-15. The implementation for <code>pullback</code> function is very similar, with the only differences being that the order of the <code>domain</code> and <code>codomain</code> arguments reversed, and it uses the <code>applyPropsBackward</code> function, which is not too difficult to derive.</p>
</div>
</div>
</div>
<div id="expanses" class="section level3 hasAnchor" number="7.3.4">
<h3><span class="header-section-number">7.3.4</span> Expanses<a href="system.html#expanses" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>So far, we have discussed scales, and described them as a sort of bridge between two properties of type <code>Expanse</code> - the domain and the codomain. However, we have left the precise nature of the <code>Expanse</code> type vague. Now it is finally time to discuss <code>Expanse</code> and its various subtypes concretely.</p>
<p>As mentioned previously, the job of the <code>Expanse&lt;T&gt;</code> is to translate values of type <code>T</code> (its domain) to and from the interval <span class="math inline">\([0, 1]^n\)</span>. This makes <code>Expanse</code> similar to the maps discussed in Section <a href="system.html#two-component-scales">7.3.3.3</a>. The reason why the normalized interval is identified as <span class="math inline">\([0, 1]^n\)</span> instead of the one-dimensional interval <span class="math inline">\([0, 1]\)</span> is because, sometimes, we may want to map multi-dimensional values. For example, in the parallel-coordinates plot, we want to map values of several different variables to the y-axis. Typically, the dimensionality of the normalized values will be the same as that of <code>T</code>, however, we could imagine a situation where it might not be so, for example, we could imagine mapping 3-dimensional vectors to their (normalized) length.</p>
<p>Most of the functionality is implemented by the specific subtypes of <code>Expanse</code>, however, there is also some shared behavior. The simplified interface of <code>Expanse</code> is:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb97-1"><a href="system.html#cb97-1" tabindex="-1"></a><span class="kw">interface</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb97-2"><a href="system.html#cb97-2" tabindex="-1"></a>  value<span class="op">:</span> T<span class="op">;</span></span>
<span id="cb97-3"><a href="system.html#cb97-3" tabindex="-1"></a>  normalized<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[]</span>
<span id="cb97-4"><a href="system.html#cb97-4" tabindex="-1"></a>}</span></code></pre></div>
<p>Here, the <code>value</code> and <code>normalized</code> properties are opaque types (used on type-level only), which simply indicate the domain type <code>T</code> and the dimensionality of the normalized values (<code>number | number[]</code>).</p>
<p>Each namespace corresponding to a subtype of <code>Expanse&lt;T&gt;</code> exports two important functions:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(n: T \to [0, 1]^n\)</span>, mapping values from <span class="math inline">\(T\)</span> to <span class="math inline">\([0, 1]^n\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(u: [0, 1]^n \to T\)</span>, mapping values from <span class="math inline">\([0, 1]^n\)</span> to <span class="math inline">\(T\)</span></li>
</ul>
<p>There are two other important methods that each <code>Expanse</code> subtype must export: <code>train</code> and <code>breaks</code>. The <code>train</code> function allows the expanse to train on new data (for example, after a histogram binwidth has been changed). The <code>breaks</code> function simply returns an array of breaks of type <code>T</code>. Thus, each subtype of <code>Expanse</code> implements the following polymorphic methods:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb98-1"><a href="system.html#cb98-1" tabindex="-1"></a><span class="kw">interface</span> ExpanseMethods<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb98-2"><a href="system.html#cb98-2" tabindex="-1"></a>  <span class="fu">normalize</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> value<span class="op">:</span> T)<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb98-3"><a href="system.html#cb98-3" tabindex="-1"></a>  <span class="fu">unnormalize</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> value<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[])<span class="op">:</span> T<span class="op">;</span></span>
<span id="cb98-4"><a href="system.html#cb98-4" tabindex="-1"></a>  <span class="fu">train</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> values<span class="op">:</span> T[]<span class="op">,</span> options<span class="op">?:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">any</span><span class="op">&gt;</span>)<span class="op">:</span> <span class="dt">void</span><span class="op">;</span></span>
<span id="cb98-5"><a href="system.html#cb98-5" tabindex="-1"></a>  <span class="fu">breaks</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> zero<span class="op">?:</span> <span class="dt">number</span><span class="op">,</span> one<span class="op">?:</span> <span class="dt">number</span>)<span class="op">:</span> T[] <span class="op">|</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb98-6"><a href="system.html#cb98-6" tabindex="-1"></a>}</span></code></pre></div>
<div id="continuous-expanses" class="section level4 hasAnchor" number="7.3.4.1">
<h4><span class="header-section-number">7.3.4.1</span> Continuous expanses<a href="system.html#continuous-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A continuous expanse is a generalization of the linear mapping discussed in Section <a href="system.html#two-component-scales">7.3.3.3</a>. That is, it translates values to and from a continuous interval given (roughly) by <span class="math inline">\([\text{min}, \text{max}]\)</span>. Here is a simplified interface:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb99-1"><a href="system.html#cb99-1" tabindex="-1"></a><span class="kw">interface</span> ExpanseContinuous {</span>
<span id="cb99-2"><a href="system.html#cb99-2" tabindex="-1"></a>  min<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb99-3"><a href="system.html#cb99-3" tabindex="-1"></a>  max<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb99-4"><a href="system.html#cb99-4" tabindex="-1"></a>  offset<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb99-5"><a href="system.html#cb99-5" tabindex="-1"></a>  trans<span class="op">:</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb99-6"><a href="system.html#cb99-6" tabindex="-1"></a>  inv<span class="op">:</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb99-7"><a href="system.html#cb99-7" tabindex="-1"></a>  ratio<span class="op">:</span> <span class="dt">boolean</span><span class="op">;</span></span>
<span id="cb99-8"><a href="system.html#cb99-8" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>min</code> and <code>max</code> properties are fairly self-explanatory - they denote the minimum and maximum of the data. The <code>offset</code> property allows us to move values by some constant, either before they have been normalized or after they have been unnormalized. This is useful, for example, when we want to ensure that the width of a spineplot bar is exactly 1 pixel less than the available space. The <code>trans</code> and <code>inv</code> properties allow us to perform non-linear transformations (they should, intuitively, be inverses of each other). By default, they are both set to the identity function (<code>(x) =&gt; x</code>). Finally, the <code>ratio</code> property is a simple boolean flag which indicates whether the expanse is part of a ratio scale. If this flag is set to <code>true</code>, then the <code>min</code> value of the expanse must always be zero and we cannot change it by, for example, training on new data.</p>
<p>The normalize and unnormalize functions in the <code>ExpanseContinuous</code> namespace are generalizations of the linear map:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb100-1"><a href="system.html#cb100-1" tabindex="-1"></a><span class="co">// ExpanseContinuous.ts</span></span>
<span id="cb100-2"><a href="system.html#cb100-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpanseContinuous</span> {</span>
<span id="cb100-3"><a href="system.html#cb100-3" tabindex="-1"></a>    <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpanseContinuous<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb100-4"><a href="system.html#cb100-4" tabindex="-1"></a>    <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> offset<span class="op">,</span> trans } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb100-5"><a href="system.html#cb100-5" tabindex="-1"></a>    <span class="cf">return</span> (<span class="fu">trans</span>(value <span class="op">-</span> offset) <span class="op">-</span> <span class="fu">trans</span>(min)) <span class="op">/</span> (<span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min))<span class="op">;</span></span>
<span id="cb100-6"><a href="system.html#cb100-6" tabindex="-1"></a>  }</span>
<span id="cb100-7"><a href="system.html#cb100-7" tabindex="-1"></a></span>
<span id="cb100-8"><a href="system.html#cb100-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpanseContinuous<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb100-9"><a href="system.html#cb100-9" tabindex="-1"></a>    <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> offset<span class="op">,</span> trans<span class="op">,</span> inv } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb100-10"><a href="system.html#cb100-10" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">inv</span>(<span class="fu">trans</span>(min) <span class="op">+</span> value <span class="op">*</span> (<span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min))) <span class="op">+</span> offset<span class="op">;</span></span>
<span id="cb100-11"><a href="system.html#cb100-11" tabindex="-1"></a>  }</span>
<span id="cb100-12"><a href="system.html#cb100-12" tabindex="-1"></a>}</span></code></pre></div>
<p>And these work as we would expect:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb101-1"><a href="system.html#cb101-1" tabindex="-1"></a><span class="im">import</span> { ExpanseContinuous } <span class="im">from</span> <span class="st">&quot;./ExpanseContinuous&quot;</span></span>
<span id="cb101-2"><a href="system.html#cb101-2" tabindex="-1"></a></span>
<span id="cb101-3"><a href="system.html#cb101-3" tabindex="-1"></a><span class="kw">const</span> identity <span class="op">=</span> (x) <span class="kw">=&gt;</span> x<span class="op">;</span></span>
<span id="cb101-4"><a href="system.html#cb101-4" tabindex="-1"></a><span class="co">// I could have defined a proper constructor above but opted not to to save lines</span></span>
<span id="cb101-5"><a href="system.html#cb101-5" tabindex="-1"></a><span class="kw">const</span> exp <span class="op">=</span> { min<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> max<span class="op">:</span> <span class="dv">16</span><span class="op">,</span> offset<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> trans<span class="op">:</span> identity<span class="op">,</span> inv<span class="op">:</span> identity }<span class="op">;</span></span>
<span id="cb101-6"><a href="system.html#cb101-6" tabindex="-1"></a></span>
<span id="cb101-7"><a href="system.html#cb101-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(ExpanseContinuous<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> <span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb101-8"><a href="system.html#cb101-8" tabindex="-1"></a>exp<span class="op">.</span><span class="at">trans</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span><span class="op">;</span> <span class="co">// Technically, we should also set inverse to square</span></span>
<span id="cb101-9"><a href="system.html#cb101-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(ExpanseContinuous<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> <span class="dv">4</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 0.2
## 0.3333333333333333</code></pre>
<p>Finally, the <code>ExpanseContinuous</code> namespace also export a <code>train</code> function, which goes through an array values and updates the min and max properties (max only if <code>ratio</code> is set to <code>true</code>), and a <code>breaks</code> function which returns a list of breaks, using an algorithm inspired by base R’s <code>pretty</code> function.</p>
</div>
<div id="point-expanses" class="section level4 hasAnchor" number="7.3.4.2">
<h4><span class="header-section-number">7.3.4.2</span> Point expanses<a href="system.html#point-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A point expanse is the simplest type of discrete expanse. It simply places values at equidistant points along the <span class="math inline">\([0, 1]\)</span> interval, based on an ordered array of labels. Here is a simplified interface:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb103-1"><a href="system.html#cb103-1" tabindex="-1"></a><span class="kw">interface</span> ExpansePoint {</span>
<span id="cb103-2"><a href="system.html#cb103-2" tabindex="-1"></a>    labels<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb103-3"><a href="system.html#cb103-3" tabindex="-1"></a>    order<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb103-4"><a href="system.html#cb103-4" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>labels</code> array contains the all of the unique values that data take (strings). The <code>order</code> array is a simple array of indices which represent the order in which the labels get assigned to points in the <span class="math inline">\([0, 1]\)</span> interval.</p>
<p>The normalize and unnormalize functions in the <code>ExpansePoint</code> namespace simply use a label to find the corresponding point in <span class="math inline">\([0, 1]\)</span> or the use a point to find the closest label, while respecting the <code>order</code>:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb104-1"><a href="system.html#cb104-1" tabindex="-1"></a><span class="co">// ExpansePoint.ts</span></span>
<span id="cb104-2"><a href="system.html#cb104-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpansePoint</span> {</span>
<span id="cb104-3"><a href="system.html#cb104-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpansePoint<span class="op">,</span> value<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb104-4"><a href="system.html#cb104-4" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb104-5"><a href="system.html#cb104-5" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> order[labels<span class="op">.</span><span class="fu">indexOf</span>(value)]<span class="op">;</span></span>
<span id="cb104-6"><a href="system.html#cb104-6" tabindex="-1"></a>    <span class="cf">if</span> (index <span class="op">===</span> <span class="op">-</span><span class="dv">1</span>) <span class="cf">return</span> index<span class="op">;</span></span>
<span id="cb104-7"><a href="system.html#cb104-7" tabindex="-1"></a>    <span class="cf">return</span> index <span class="op">/</span> (labels<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb104-8"><a href="system.html#cb104-8" tabindex="-1"></a>  }</span>
<span id="cb104-9"><a href="system.html#cb104-9" tabindex="-1"></a></span>
<span id="cb104-10"><a href="system.html#cb104-10" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpansePoint<span class="op">,</span> index<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb104-11"><a href="system.html#cb104-11" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb104-12"><a href="system.html#cb104-12" tabindex="-1"></a>    index <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(index <span class="op">*</span> (labels<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb104-13"><a href="system.html#cb104-13" tabindex="-1"></a>    <span class="cf">return</span> labels[order[index]]<span class="op">;</span></span>
<span id="cb104-14"><a href="system.html#cb104-14" tabindex="-1"></a>  }</span>
<span id="cb104-15"><a href="system.html#cb104-15" tabindex="-1"></a>}</span></code></pre></div>
<p>Again, these functions work as we would expect:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb105-1"><a href="system.html#cb105-1" tabindex="-1"></a><span class="im">import</span> { ExpansePoint } <span class="im">from</span> <span class="st">&quot;./ExpansePoint&quot;</span></span>
<span id="cb105-2"><a href="system.html#cb105-2" tabindex="-1"></a></span>
<span id="cb105-3"><a href="system.html#cb105-3" tabindex="-1"></a><span class="kw">const</span> cities <span class="op">=</span> [<span class="st">&quot;Berlin&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]</span>
<span id="cb105-4"><a href="system.html#cb105-4" tabindex="-1"></a></span>
<span id="cb105-5"><a href="system.html#cb105-5" tabindex="-1"></a><span class="kw">const</span> exp <span class="op">=</span> {</span>
<span id="cb105-6"><a href="system.html#cb105-6" tabindex="-1"></a>  labels<span class="op">:</span> cities<span class="op">,</span></span>
<span id="cb105-7"><a href="system.html#cb105-7" tabindex="-1"></a>  order<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb105-8"><a href="system.html#cb105-8" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb105-9"><a href="system.html#cb105-9" tabindex="-1"></a></span>
<span id="cb105-10"><a href="system.html#cb105-10" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cities<span class="op">.</span><span class="fu">map</span>(city <span class="kw">=&gt;</span> ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> city)))<span class="op">;</span></span>
<span id="cb105-11"><a href="system.html#cb105-11" tabindex="-1"></a>exp<span class="op">.</span><span class="at">order</span>[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Swap the order of the first two values</span></span>
<span id="cb105-12"><a href="system.html#cb105-12" tabindex="-1"></a>exp<span class="op">.</span><span class="at">order</span>[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb105-13"><a href="system.html#cb105-13" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cities<span class="op">.</span><span class="fu">map</span>(city <span class="kw">=&gt;</span> ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> city)))<span class="op">;</span></span></code></pre></div>
<pre><code>## [ 0, 0.5, 1 ]
## [ 0.5, 0, 1 ]</code></pre>
<p>Like <code>ExpanseContinuous</code>, the <code>ExpansePoint</code> namespace also contains a <code>train</code> function, which loops through an array of labels and finds all of the unique values, as well as a <code>breaks</code> function, which simply returns ordered <code>labels</code>. Further, the namespace also contains a <code>reorder</code> function which mutates the <code>order</code> property based on an array of indices.</p>
</div>
<div id="band-expanses" class="section level4 hasAnchor" number="7.3.4.3">
<h4><span class="header-section-number">7.3.4.3</span> Band expanses<a href="system.html#band-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>While <code>ExpansePoint</code> places values at equidistant points along <span class="math inline">\([0, 1]\)</span>, <code>ExpanseBand</code> places values at the midpoints of corresponding bins or bands. These bands can have variable widths, which is useful, for example, when specifying the x-axis position in a barplot. The simplified interface of <code>ExpanseBand</code> is the following:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb107-1"><a href="system.html#cb107-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">interface</span> ExpanseBand {</span>
<span id="cb107-2"><a href="system.html#cb107-2" tabindex="-1"></a>  labels<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb107-3"><a href="system.html#cb107-3" tabindex="-1"></a>  order<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb107-4"><a href="system.html#cb107-4" tabindex="-1"></a>  weights<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb107-5"><a href="system.html#cb107-5" tabindex="-1"></a>  cumulativeWeights<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb107-6"><a href="system.html#cb107-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Like <code>ExpansePoint</code>, <code>ExpanseBand</code> has the <code>labels</code> and <code>order</code> properties, which work exactly the same way as before. However, additionally, it also has the <code>weights</code> and <code>cumulativeWeights</code> properties, which are numeric arrays that define the width of each band. <code>weights</code> record the width of each band, and <code>cumulativeWeights</code> record the cumulative sums of the weights, which are used in the <code>normalize</code> and <code>unnormalize</code> functions. Thus, each time we update <code>weights</code>, we need to also update <code>cumulativeWeights</code> as well.</p>
<p>The normalize and unnormalize functions in the <code>ExpanseBand</code> namespace map labels to and from the midpoint of their corresponding bands:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb108-1"><a href="system.html#cb108-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpanseBand</span> {</span>
<span id="cb108-2"><a href="system.html#cb108-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> value<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb108-3"><a href="system.html#cb108-3" tabindex="-1"></a>    <span class="kw">const</span> { labels } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb108-4"><a href="system.html#cb108-4" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> labels<span class="op">.</span><span class="fu">indexOf</span>(value)<span class="op">;</span></span>
<span id="cb108-5"><a href="system.html#cb108-5" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">getMidpoint</span>(expanse<span class="op">,</span> index)<span class="op">;</span></span>
<span id="cb108-6"><a href="system.html#cb108-6" tabindex="-1"></a>  }</span>
<span id="cb108-7"><a href="system.html#cb108-7" tabindex="-1"></a></span>
<span id="cb108-8"><a href="system.html#cb108-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb108-9"><a href="system.html#cb108-9" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order<span class="op">,</span> cumulativeWeights } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb108-10"><a href="system.html#cb108-10" tabindex="-1"></a></span>
<span id="cb108-11"><a href="system.html#cb108-11" tabindex="-1"></a>    <span class="kw">const</span> weight <span class="op">=</span> value <span class="op">*</span> <span class="fu">last</span>(cumulativeWeights)<span class="op">;</span></span>
<span id="cb108-12"><a href="system.html#cb108-12" tabindex="-1"></a>    <span class="kw">let</span> index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb108-13"><a href="system.html#cb108-13" tabindex="-1"></a></span>
<span id="cb108-14"><a href="system.html#cb108-14" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;</span> cumulativeWeights<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb108-15"><a href="system.html#cb108-15" tabindex="-1"></a>      <span class="cf">if</span> (cumulativeWeights[index] <span class="op">&gt;=</span> weight) <span class="cf">break</span><span class="op">;</span></span>
<span id="cb108-16"><a href="system.html#cb108-16" tabindex="-1"></a>      index<span class="op">++;</span></span>
<span id="cb108-17"><a href="system.html#cb108-17" tabindex="-1"></a>    }</span>
<span id="cb108-18"><a href="system.html#cb108-18" tabindex="-1"></a></span>
<span id="cb108-19"><a href="system.html#cb108-19" tabindex="-1"></a>    <span class="cf">return</span> labels[order[index]]<span class="op">;</span></span>
<span id="cb108-20"><a href="system.html#cb108-20" tabindex="-1"></a>  }</span>
<span id="cb108-21"><a href="system.html#cb108-21" tabindex="-1"></a></span>
<span id="cb108-22"><a href="system.html#cb108-22" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">getMidpoint</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> index<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb108-23"><a href="system.html#cb108-23" tabindex="-1"></a>    <span class="kw">const</span> { order<span class="op">,</span> cumulativeWeights } <span class="op">=</span> expanse<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb108-24"><a href="system.html#cb108-24" tabindex="-1"></a>    index <span class="op">=</span> order[index]<span class="op">;</span></span>
<span id="cb108-25"><a href="system.html#cb108-25" tabindex="-1"></a></span>
<span id="cb108-26"><a href="system.html#cb108-26" tabindex="-1"></a>    <span class="kw">const</span> lower <span class="op">=</span> cumulativeWeights[index <span class="op">-</span> <span class="dv">1</span>] <span class="op">??</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb108-27"><a href="system.html#cb108-27" tabindex="-1"></a>    <span class="kw">const</span> upper <span class="op">=</span> cumulativeWeights[index]<span class="op">;</span></span>
<span id="cb108-28"><a href="system.html#cb108-28" tabindex="-1"></a>    <span class="kw">const</span> max <span class="op">=</span> <span class="fu">last</span>(cumulativeWeights)<span class="op">;</span></span>
<span id="cb108-29"><a href="system.html#cb108-29" tabindex="-1"></a></span>
<span id="cb108-30"><a href="system.html#cb108-30" tabindex="-1"></a>    <span class="cf">return</span> (lower <span class="op">+</span> upper) <span class="op">/</span> <span class="dv">2</span> <span class="op">/</span> max<span class="op">;</span></span>
<span id="cb108-31"><a href="system.html#cb108-31" tabindex="-1"></a>  }</span>
<span id="cb108-32"><a href="system.html#cb108-32" tabindex="-1"></a>}</span></code></pre></div>
<p>Notice that, because of the cumulative nature of the bands, the logic in the functions’ bodies is a bit more complicated. First, to <code>normalize</code> a label, we need to first find the index of the label and then return the corresponding midpoint of the band, taking <code>weights</code> and <code>order</code> into account. Second, to <code>unnormalize</code>, we actually have to loop through the array of <code>cumulativeWeights</code> - there is no way to determine which bin a normalized value belongs to in <span class="math inline">\(O(1)\)</span> time (as far as I am aware). This is not much of a problem since the <code>ExpanseBand.unnormalize</code> is not used anywhere in the system (all scales implemented thus far use only <code>ExpanseBand.normalize</code>), however, it is important to be mindful of this.</p>
<!-- Notice that, whereas before we had considered *normalize* as mapping between $D \to [0, 1]$ and *unnormalize* as mapping between $[0, 1] \to V$, we now consider both as mapping between $[0, 1]$ and an arbitrary domain $X$. This domain can represent the data or the visual attribute - the expanse is agnostic about this. -->
<!-- Also, while before we have discussed domains as subsets of $\mathbb{R}$, we can now start thinking about them as arbitrary sets. While subsets of $\mathbb{R}$ and sets of strings are really the only types of domains used in `plotscaper`, the model should readily extends to other sets, as long as a mapping to and from $[0, 1]$ can be provided. -->
<!-- How `normalize` and `unnormalize` are implemented will depend largely on the subtype of `Expanse`, as well as on the desired behavior. For example, as will be discussed later, in `plotscaper`, the normalize and unnormalize methods implemented for `ExpanseContinuous` (subtype of `Expanse<number>`) work largely the same way as in section [SECTION]. However, while `ExpansePoint` and `ExpanseBand` are both subtypes of `Expanse<string>`, they behave differently - `ExpansePoint` maps strings (factor levels) to equidistant points along $[0, 1]$, whereas `ExpanseBand` maps the strings into the middle of "buckets" along $[0, 1]$.    -->
<!-- However, there is also some behavior that we may want to apply the same way across the different expanse subtypes. For example, it seems reasonable that the user should be able to zoom, pan, or reverse axes, regardless of whether a plot shows discrete or continuous data. As such, there may be some properties and functions common to the `Expanse` type. I will discuss these first. -->
<!-- #### Zero and one -->
<!-- The maps may also take in and return values outside of $D^*$ and $[0, 1]$, if adjustments have been made. For instance, in most data visualization packages, x- and y-axis limits are by default expanded some percentage beyond the range of the observed data to avoid the maximum and minimum datapoints from overlapping with the limits. For example, in base R: -->
<!-- ```{r} -->
<!-- #| fig-height: 4 -->
<!-- #| fig-cap: "Expanding axes. By default, axes in base R `plot()` function are expanded 4% beyond the range of the data (left). Otherwise, datapoints on the limits of their respective scales end up overlapping with the plot borders (right)." -->
<!-- set.seed(12345) -->
<!-- x <- rnorm(5) -->
<!-- y <- rnorm(5) -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(x, y)  -->
<!-- plot(x, y, xaxs = 'i', yaxs = 'i')  -->
<!-- ``` -->
<!-- Thus, upon normalizing the minimum and maximum data values, the expanse should return values other than $\{0, 1\}$. Likewise, to support user interactions such as zooming and panning, the expanses may accept and return values outside of $D^*$ and $[0, 1]$.  -->
<!-- Zooming and panning should be orthogonal to the underlying data type, such that user can interact with the plots the same way^[The one exception may be panning barplots and histograms, where the y-axis upper y-axis limit may change but the lower should be fixed at 0, such that panning may shrink or stretch the bars, but not "lift" them up or move them down.], no matter whether their axes are continuous, discrete, or some combination of the two. To this end, I introduce two parameters representing the normalized value ($p$) of the minimum and maximum data point, called *zero* and *one* respectively. These parameters are agnostic to the underlying data type, such that if we have the data type-specific maps $n'$ and $u'$, the complete normalize and unnormalize maps are: -->
<!-- $$n(d) = \text{zero} + n'(d) \cdot (\text{one} - \text{zero})$$ -->
<!-- $$u(p) = u' \bigg(\frac{p - \text{zero}}{\text{one} - \text{zero}} \bigg)$$ -->
<!-- To simplify, here's what effect setting the two parameters to specific values has: -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- tab <- data.frame( -->
<!--   Zero = c(0.05, 0.05, -0.5), -->
<!--   One = c(0.95, 1.05, 1.5), -->
<!--   Effect = c("Expands the margins by ~5% (actually 5.555...% since 0.05 / 0.9 = 0.0555...)", -->
<!--              "Shifts the expanse 'up' by 5% (e.g. moves x-axis 5% right)", -->
<!--              "Zooms into the middle 50% of the expanse (25 percentile goes to 0 and 75th to one)") -->
<!-- ) -->
<!-- knitr::kable(tab) -->
<!-- ``` -->
<!-- #### Expanse Interface -->
<!-- There are also other behaviours that expanses should support. For instance, we may want to be able to reset the expanse to defaults, retrain when the underlying data changes, and return nicely formatted breaks. How these behaviours are implemented, as well as other types of behavior, may be specific to the underlying data type. Overall, expanse interface may look something like this: -->
<!-- ``` -->
<!-- interface Expanse<T> { -->
<!--   normalize(value: T): number -->
<!--   unnormalize(value: number): T -->
<!--   defaultize(): this -->
<!--   setZero(zero: number, default: boolean): this -->
<!--   setOne(one: number, default: boolean): this -->
<!--   freezeZero(): this -->
<!--   freezeOne(): this -->
<!--   move(amount: number): this -->
<!--   expand(zero: number, one: number): this -->
<!--   retrain(values: T[]): this -->
<!--   breaks(n?: number): T[]   -->
<!-- } -->
<!-- ``` -->
<!-- #### Continuous Expanses -->
<!-- The continuous expanse has as its underlying set $[\min, \max] \subseteq \mathbb{R}$. To understand how it works, let's build it step by step.  -->
<!-- We start with the basic normalizing function: -->
<!-- 1. $$n(d) = \frac{d - \min}{\max - \min}$$ -->
<!-- This function takes some data value $d \in [\min, \max]$ and transforms it to $[0, 1]$. Most data visualization systems use a function like this at some step of the scaling processs - see [`scales::rescale`](https://github.com/r-lib/scales/blob/84560bf54e02315477a05384ee67991e9e8fc52c/R/bounds.R#L85) and **D3** [`normalize`](https://github.com/d3/d3-scale/blob/d6904a4bde09e16005e0ad8ca3e25b10ce54fa0d/src/continuous.js#L122).    -->
<!-- This may work well for typical linear scales. However, we may also want to apply some transformation $f$, such as square root or log. Then, to ensure that the observed data values still get normalized to $[0, 1]$, we need to apply the transformation to both $d$ and the limits: -->
<!-- 2. $$\frac{f(d) - f(\min)}{f(\max) - f(\min)}$$ -->
<!-- Finally, as was discussed in [EXPANSES], we want to be able to incorporate the zero and one paramaters, leading to the final normalizing function: -->
<!-- $$n(d) = \text{zero} + \frac{f(d) - f(\min)}{f(\max) - f(\min)} \cdot (\text{zero} - \text{one})$$ -->
<!-- To obtain the unnormalizing function, we can simply invert the normalizing function: -->
<!-- $$u(p) = f^{-1} \bigg\{ f(\min) + \frac{p - \text{zero}}{\text{one} - \text{zero}} \cdot \big[ f(\max) - f(\min) \big] \bigg\}$$ -->
<!-- The function transforms $x$ to a percentage value $p \in [0, 1]$, provided $x$ is within $[\min, \max]$. The value $(\max - \min)$ is also sometimes called the *range* (not to be confused with **D3** `range`).  -->
<!-- We can invert the normalizing function and obtain the unnormalizing function, which is, for some percentage $p \in [0, 1]$: -->
<!-- $$u(p) = \min + p \cdot (\max - \min)$$ -->
<!-- returns a value within the $[\min, \max]$ range, corresponding to the proportion of the maximum possible distance (range) from the origin ($\min$). For example, $u(0.5)$, returns a value that is located halfway between the limits. -->
<!-- We can implement a simple continuous expanse like so: -->
<!-- ```{ts} -->
<!-- function identity<T>(x: T) { -->
<!--   return x; -->
<!-- } -->
<!-- function expanseContinuous(min = 0, max = 1) { -->
<!--   const [zero, one] = [0, 1] -->
<!--   const [trans, inv] = [identity, identity] -->
<!--   return { min, max, zero, one, trans, inv, -->
<!--     range() { -->
<!--       return this.max - this.min; -->
<!--     }, -->
<!--     transRange() { -->
<!--       const { min, max, trans } = this; -->
<!--       return trans(max) - trans(min); -->
<!--     }, -->
<!--     normalize(x: number) { -->
<!--       const { min, zero, one, trans } = this; -->
<!--       const normalized = (trans(x) - trans(min)) / this.transRange(); -->
<!--       return zero + normalized * (one - zero); -->
<!--     }, -->
<!--     unnormalize(p: number) { -->
<!--       const { min, zero, one, trans, inv } = this; -->
<!--       return inv(trans(min) + ((p - zero) / (one - zero)) * this.transRange()); -->
<!--     }, -->
<!--   }; -->
<!-- } -->
<!-- const expanse1 = expanseContinuous(1, 10); -->
<!-- console.log(expanse1.normalize(5)); -->
<!-- console.log(expanse1.unnormalize(0.5)) -->
<!-- ``` -->
<!-- The functions $n, u$ have several interesting properties. First off, they are inverses to each other and form an *isomorphism*, i.e. $u = n^{-1}$ and $n = u^{-1}$ such that $u(n(x)) = x$ and $n(u(p)) = p$. This also means that each function is a 1-to-1 mapping or *bijection*. In plain words, this means that we cannot get the same percentage by normalizing two different values and vice versa. As a result, we can keep switching between the normalized and unnormalized representations without losing any information:   -->
<!-- ```{r} -->
<!-- with(expanse, unnormalize(normalize(5))) -->
<!-- with(expanse, normalize(unnormalize(normalize(unnormalize(0.5))))) -->
<!-- ``` -->
<!-- ##### Linearity -->
<!-- Another important thing to note is that, while these types of normalizing functions are often called "linear" (e.g. `scaleLinear()` in **D3**), since their graphs form a straight line, they should not be confused with "linear functions", since they do not satisfy the properties of linear functions, namely: -->
<!-- - Additivity: $\text{normalize}(x + c) \neq \text{normalize}(x) + \text{normalize}(c)$ -->
<!-- - Homogeneity of degree 1: $\text{normalize}(c \cdot x) \neq c \cdot \text{normalize(x)}$. -->
<!-- To illustrate, additivity does not hold when $\min \neq 0$ because: -->
<!-- $$\frac{(x + c) - \min}{(\max - \min)}$$ -->
<!-- $$= \frac{x - \min}{\max - \min} + \frac{c}{\max - \min}$$ -->
<!-- $$\neq \frac{x - \min}{\max - min} + \frac{c - \min}{\max - \min}$$ -->
<!-- The same can be easily shown for the $\text{unnormalize}$ map and for homogeneity. -->
<!-- Technically, this is due to a confusion between the definition of a "linear function" and a "linear polynomial". The appropriate term to use would actually be "affine transformation."  -->
<!-- Either way, if the minimum is not 0, we cannot expect the following to be equal: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(3) + normalize(2))) -->
<!-- ``` -->
<!-- Or the following to be equal: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(2 * 5), 2 * normalize(5))) -->
<!-- ``` -->
<!-- However, if we keep in mind the fact that the normalizing function calculates the proportion of distance from the origin, we can see that the function in fact behaves linearly within the context of its limits. -->
<!-- For example, consider the range $[1, 10]$. The value $5$ is $4$ units away from the lower limit, i.e. $5 - 1 = 4$, so we can represent it, for example, as the sum of a value that is 3 units away and another that is one unit away, $n(5) = n(4) + n(2)$:  -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(4) + normalize(2))) -->
<!-- ``` -->
<!-- Likewise, again because $5$ represents the distance of $4$ units and $3$ of $2$, we can expect $n(5) = 2 \cdot n(3)$: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), 2 * normalize(3))) -->
<!-- ``` -->
<!-- ##### Transformations -->
<!-- We can apply transformations to continuous expanses by transforming their limits. The outcome of this is that $\min$ and $\max$ still get mapped to $0$ and $1$ however, the graph of the function is no longer linear. Suppose we have non-linear function $f$, along with an inverse $f^{-1}$. Then: -->
<!-- $$n(x) = \frac{f(x) - f(\min)}{f(\max) - f(\min)}$$ -->
<!-- $$u(p) = f^{-1} \bigg\{f(\min) + p \cdot \big[ f(\max) - f(\min) \big] \bigg\}$$ -->
<!-- For example, here's how we could apply the transformation $\bigg( f(x) = \sqrt{x}, \; f^{-1}(x) = x^2 \bigg)$ in code:  -->
<!-- ```{r} -->
<!-- expanse$trans <- sqrt -->
<!-- expanse$inv <- function(x) x^2 -->
<!-- # Need to redefine normalize and unnormalize -->
<!-- expanse$trans_range <- function() with(expanse, trans(max) - trans(min)) -->
<!-- expanse$normalize <- function(x) { -->
<!--   with(expanse, (trans(x) - trans(min)) / trans_range()) -->
<!-- } -->
<!-- expanse$unnormalize <- function(p) { -->
<!--   with(expanse, inv(trans(min) + p * trans_range())) -->
<!-- } -->
<!-- # Normalizing limits still returns c(0, 1) -->
<!-- c(expanse$normalize(c(1, 10))) -->
<!-- # Notice that these return different values from before though -->
<!-- expanse$normalize(5) -->
<!-- expanse$unnormalize(0.5) -->
<!-- x <- seq(1, 10, length = 100) -->
<!-- p <- seq(0, 1, length = 100) -->
<!-- # The graphs are no longer linear -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(x, expanse$normalize(x), type = "l", ylab = "normalize(x)") -->
<!-- plot(p, expanse$unnormalize(p), type = "l", ylab = "unnormalize(p)") -->
<!-- ``` -->
<!-- Transformations such as these can be useful in two ways. First, sometimes we may be able to better see trends in the data when the data has been appropriately transformed. This is the case, for example, when plotting data which varies across orders of magnitude. In this case it may be useful to apply $\log$-transformation. Second, transformations can also be helpful in situations where some graphical attributes are not perceived linearly. For example, when judging differently sized objects, viewers tend judge magnitude based on area rather than side or radius. As such, when drawing objects such as points or squares it can be helpful to apply square root as the inverse transformation. The idea is that, if one point has a data value that is $c$ times bigger than another, it will have $\sqrt{c}$ times bigger radius and $c$ times bigger area. Note that we are talking about the inverse transformation here, i.e. the transformation affecting the unnormalizing function. -->
<!-- One thing to note is that the proportionality of the square-root transformation holds only when $\min = 0$. Otherwise: -->
<!-- $$\sqrt{(\min)^2 + cp \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- $$= \sqrt{c} \cdot \sqrt{(\min)^2/c + p \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- $$\neq \sqrt{c} \cdot \sqrt{(\min)^2 + p \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- This is a problem in the existing packages. For example: -->
<!-- ```{r} -->
<!-- library(scales) -->
<!-- pal <- area_pal(c(1, 5)) -->
<!-- # Comparing cscale to naive implementation -->
<!-- all.equal(cscale(1:5, pal), sqrt((1:5 - 1) / 4) * 4 + 1) -->
<!-- # Should be equal since 3 is twice as far from 1 as 2 is -->
<!-- c(cscale(1:5, pal)[3] / cscale(1:5, pal)[2], -->
<!--   sqrt(2)) -->
<!-- expanse$min <- 1 -->
<!-- expanse$max <- 5 -->
<!-- cscale(1:5, pal) -->
<!-- expanse$unnormalize(1:5 / 5) -->
<!-- expanse -->
<!-- plot(1:5, expanse$unnormalize(1:5 / 5)) -->
<!-- plot(1:5, cscale(1:5, pal)) -->
<!-- ``` -->
<!-- ##  -->
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="system.html#cb109-1" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> <span class="cn">TRUE</span>)</span></code></pre></div>

</div>
</div>
</div>
</div>
<h3> References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-abelson2022" class="csl-entry">
Abelson, Harold, and Gerald Jay Sussman. 2022. <em>Structure and Interpretation of Computer Programs: JavaScript Edition</em>. MIT Press.
</div>
<div id="ref-allaire2024" class="csl-entry">
Allaire, JJ, and Christophe Dervieux. 2024. <em>Quarto: R Interface to ’Quarto’ Markdown Publishing System</em>. <a href="https://CRAN.R-project.org/package=quarto">https://CRAN.R-project.org/package=quarto</a>.
</div>
<div id="ref-rmarkdown2024" class="csl-entry">
Allaire, JJ, Yihui Xie, Christophe Dervieux, Jonathan McPherson, Javier Luraschi, Kevin Ushey, Aron Atkins, et al. 2024. <em>Rmarkdown: Dynamic Documents for r</em>. <a href="https://github.com/rstudio/rmarkdown">https://github.com/rstudio/rmarkdown</a>.
</div>
<div id="ref-auguie2017" class="csl-entry">
Auguie, Baptiste. 2017. <em>gridExtra: Miscellaneous Functions for "Grid" Graphics</em>. <a href="https://CRAN.R-project.org/package=gridExtra">https://CRAN.R-project.org/package=gridExtra</a>.
</div>
<div id="ref-bache2022" class="csl-entry">
Bache, Stefan Milton, and Hadley Wickham. 2022. <em>Magrittr: A Forward-Pipe Operator for r</em>. <a href="https://CRAN.R-project.org/package=magrittr">https://CRAN.R-project.org/package=magrittr</a>.
</div>
<div id="ref-bostock2011" class="csl-entry">
Bostock, Michael, Vadim Ogievetsky, and Jeffrey Heer. 2011. <span>“D<span class="math inline">\(^3\)</span> Data-Driven Documents.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 17 (12): 2301–9.
</div>
<div id="ref-bun2025" class="csl-entry">
<span>“<span>Bun</span>.”</span> 2025. <em>Bun</em>. <a href="https://bun.sh">https://bun.sh</a>.
</div>
<div id="ref-shiny2024" class="csl-entry">
Chang, Winston, Joe Cheng, JJ Allaire, Carson Sievert, Barret Schloerke, Yihui Xie, Jeff Allen, Jonathan McPherson, Alan Dipert, and Barbara Borges. 2024. <em>Shiny: Web Application Framework for r</em>. <a href="https://CRAN.R-project.org/package=shiny">https://CRAN.R-project.org/package=shiny</a>.
</div>
<div id="ref-cheng2024" class="csl-entry">
Cheng, Joe, Winston Chang, Steve Reid, James Brown, Bob Trower, and Alexander Peslyak. 2024. <em>Httpuv: HTTP and WebSocket Server Library</em>. <a href="https://CRAN.R-project.org/package=httpuv">https://CRAN.R-project.org/package=httpuv</a>.
</div>
<div id="ref-vue2024" class="csl-entry">
Evan You and the Vue Core Team. 2024. <span>“Vue.js.”</span> <a href="https://vuejs.org">https://vuejs.org</a>.
</div>
<div id="ref-fogus2013" class="csl-entry">
Fogus, Michael. 2013. <em>Functional JavaScript: Introducing Functional Programming with Underscore. Js</em>. " O’Reilly Media, Inc.".
</div>
<div id="ref-fong2019" class="csl-entry">
Fong, Brendan, and David I Spivak. 2019. <em>An Invitation to Applied Category Theory: Seven Sketches in Compositionality</em>. Cambridge University Press.
</div>
<div id="ref-gamma1995" class="csl-entry">
Gamma, Erich, Ralph Johnson, Richard Helm, Ralph E Johnson, and John Vlissides. 1995. <em>Design Patterns: Elements of Reusable Object-Oriented Software</em>. Pearson Deutschland GmbH.
</div>
<div id="ref-angular2025" class="csl-entry">
Google. 2025. <span>“Angular.”</span> <a href="https://angular.dev/guide/signals">https://angular.dev/guide/signals</a>.
</div>
<div id="ref-handmadehero2025" class="csl-entry">
Handmade Hero. 2025. <span>“<span class="nocase">Compile-time introspection and metaprogramming</span>.”</span> <em>Handmade Network</em>. <a href="https://handmade.network/fishbowl/metaprogramming">https://handmade.network/fishbowl/metaprogramming</a>.
</div>
<div id="ref-knockout2019" class="csl-entry">
knockoutjs. 2019. <span>“<span>Knockout : Home</span>.”</span> <a href="https://knockoutjs.com">https://knockoutjs.com</a>.
</div>
<div id="ref-krzywinski2013" class="csl-entry">
Krzywinski, Martin. 2013. <span>“Axes, Ticks and Grids.”</span> <em>Nature Methods</em> 10 (February): 183. <a href="https://doi.org/10.1038/nmeth.2337">https://doi.org/10.1038/nmeth.2337</a>.
</div>
<div id="ref-lawvere2009" class="csl-entry">
Lawvere, F William, and Stephen H Schanuel. 2009. <em>Conceptual Mathematics: A First Introduction to Categories</em>. Cambridge University Press.
</div>
<div id="ref-leptos2025" class="csl-entry">
Leptos Core Team. 2025. <span>“<span>Home - Leptos</span>.”</span> <a href="https://leptos.dev">https://leptos.dev</a>.
</div>
<div id="ref-react2024" class="csl-entry">
Meta. 2024. <span>“React.”</span> <a href="https://react.dev">https://react.dev</a>.
</div>
<div id="ref-michell1986" class="csl-entry">
Michell, Joel. 1986. <span>“Measurement Scales and Statistics: A Clash of Paradigms.”</span> <em>Psychological Bulletin</em> 100 (3): 398.
</div>
<div id="ref-murrell2005" class="csl-entry">
Murrell, Paul. 2005. <em>R Graphics</em>. Chapman; Hall/CRC.
</div>
<div id="ref-d3-scale2024" class="csl-entry">
Observable. 2024. <span>“D3-Scale <span><span class="math inline">\(\vert\)</span></span> D3 by Observable.”</span> <a href="https://d3js.org/d3-scale">https://d3js.org/d3-scale</a>.
</div>
<div id="ref-ollila2022" class="csl-entry">
Ollila, Risto, Niko Mäkitalo, and Tommi Mikkonen. 2022. <span>“Modern Web Frameworks: A Comparison of Rendering Performance.”</span> <em>Journal of Web Engineering</em> 21 (3): 789–813.
</div>
<div id="ref-pedersen2024" class="csl-entry">
Pedersen, Thomas Lin. 2024. <em>Patchwork: The Composer of Plots</em>. <a href="https://CRAN.R-project.org/package=patchwork">https://CRAN.R-project.org/package=patchwork</a>.
</div>
<div id="ref-phung2009" class="csl-entry">
Phung, Phu H, David Sands, and Andrey Chudnov. 2009. <span>“Lightweight Self-Protecting JavaScript.”</span> In <em>Proceedings of the 4th International Symposium on Information, Computer, and Communications Security</em>, 47–60.
</div>
<div id="ref-rstudio2024" class="csl-entry">
Posit. 2024. <span>“<span>RStudio IDE</span>.”</span> <a href="https://posit.co/products/open-source/rstudio">https://posit.co/products/open-source/rstudio</a>.
</div>
<div id="ref-r2024" class="csl-entry">
R Core Team. 2024. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-svelte2024" class="csl-entry">
Rich Harris and the Svelte Core Team. 2024. <span>“Svelte.”</span> <a href="https://svelte.dev">https://svelte.dev</a>.
</div>
<div id="ref-reactive2024" class="csl-entry">
Rxteam. 2024. <span>“<span>ReactiveX</span>.”</span> <a href="https://reactivex.io">https://reactivex.io</a>.
</div>
<div id="ref-carniato2023" class="csl-entry">
Ryan Carniato. 2023. <span>“<span>Revolutionary Signals</span>.”</span> <em>YouTube</em>. Youtube. <a href="https://www.youtube.com/watch?v=Jp7QBjY5K34&amp;t">https://www.youtube.com/watch?v=Jp7QBjY5K34&amp;t</a>.
</div>
<div id="ref-satyanarayan2015" class="csl-entry">
Satyanarayan, Arvind, Ryan Russell, Jane Hoffswell, and Jeffrey Heer. 2015. <span>“Reactive Vega: A Streaming Dataflow Architecture for Declarative Interactive Visualization.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 22 (1): 659–68.
</div>
<div id="ref-sievert2020" class="csl-entry">
Sievert, Carson. 2020. <em>Interactive Web-Based Data Visualization with r, Plotly, and Shiny</em>. Chapman; Hall/CRC.
</div>
<div id="ref-solid2024" class="csl-entry">
Solid Core Team. 2025. <span>“SolidJS.”</span> <a href="https://www.solidjs.com">https://www.solidjs.com</a>.
</div>
<div id="ref-stevens1946" class="csl-entry">
Stevens, Stanley Smith. 1946. <span>“On the Theory of Scales of Measurement.”</span> <em>Science</em> 103 (2684): 677–80.
</div>
<div id="ref-tufte2001" class="csl-entry">
Tufte, Edward R. 2001. <em>The Visual Display of Quantitative Information</em>. Cheshire, Connecticut: Graphics Press LLC.
</div>
<div id="ref-htmlwidgets2021" class="csl-entry">
Vaidyanathan, Ramnath, Yihui Xie, JJ Allaire, Joe Cheng, Carson Sievert, and Kenton Russell. 2021. <em>Htmlwidgets: HTML Widgets for r</em>. <a href="https://CRAN.R-project.org/package=htmlwidgets">https://CRAN.R-project.org/package=htmlwidgets</a>.
</div>
<div id="ref-wickham2013" class="csl-entry">
Wickham, Hadley. 2013. <span>“Bin-Summarise-Smooth: A Framework for Visualising Large Data.”</span> <em>Had. Co. Nz, Tech. Rep</em>.
</div>
<div id="ref-wickham2014" class="csl-entry">
Wickham, Hadley. 2014. <span>“<span class="nocase">I’m Hadley Wickham, Chief Scientist at RStudio and creator of lots of R packages (incl. ggplot2, dplyr, and devtools). I love R, data analysis/science, visualisation: ask me anything! : r/dataisbeautiful</span>.”</span> <a href="https://www.reddit.com/r/dataisbeautiful/comments/3mp9r7/comment/cvi19ly">https://www.reddit.com/r/dataisbeautiful/comments/3mp9r7/comment/cvi19ly</a>.
</div>
<div id="ref-wickham2016" class="csl-entry">
Wickham, Hadley. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis (2e)</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-wickham2019" class="csl-entry">
———. 2019. <em>Advanced r</em>. Chapman; Hall/CRC.
</div>
<div id="ref-wickham2023" class="csl-entry">
Wickham, Hadley, Thomas Lin Pedersen, and Dana Seidel. 2023. <em>Scales: Scale Functions for Visualization</em>. <a href="https://CRAN.R-project.org/package=scales">https://CRAN.R-project.org/package=scales</a>.
</div>
<div id="ref-wilkinson2012" class="csl-entry">
Wilkinson, Leland. 2012. <em>The Grammar of Graphics</em>. Springer.
</div>
<div id="ref-ziemkiewicz2009" class="csl-entry">
Ziemkiewicz, Caroline, and Robert Kosara. 2009. <span>“Embedding Information Visualization Within Visual Representation.”</span> In <em>Advances in Information and Intelligent Systems</em>, 307–26. Springer.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>For instance, the <code>plotly</code> package takes up about 7.3 megabytes, which amounts to over 15x difference.<a href="system.html#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Of course, we <em>could</em> technically parse the list of messages to retrieve the figure’s state as it will be when the figure gets rendered. For instance with <code>create_schema(...) |&gt; assign_cases(1:10, 2) |&gt; assign_cases(5:10, 3)</code> we could parse the first five indices belonging to group 2 and the second belonging to group 3. However, since the user has to write the code to modify the figure’s state in the first place, the utility of this parsing is not clear.<a href="system.html#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>That is, I use <code>namespace</code>s like a class with all static methods and properties.<a href="system.html#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>This also makes some examples easier to read, since all of the variables used in a function’s body are declared in the signature; one does not have to scroll all the way up to the top of the class declaration to find the properties used inside the method’s body.<a href="system.html#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>Or perhaps infamous.<a href="system.html#fnref5" class="footnote-back">↩︎</a></p></li>
<li id="fn6"><p>In simpler implementations, a single array can be used instead of the dictionary; the listeners are then notified whenever the object “updates”.<a href="system.html#fnref6" class="footnote-back">↩︎</a></p></li>
<li id="fn7"><p>This can be solved by adding a priority property to the event callbacks, and sorting the arrays by priority.<a href="system.html#fnref7" class="footnote-back">↩︎</a></p></li>
<li id="fn8"><p>Memoizing a derived value can be done by creating a new signal and an effect that runs when the original value gets updated.<a href="system.html#fnref8" class="footnote-back">↩︎</a></p></li>
<li id="fn9"><p>The <code>indices</code> indices being “dense” means <em>all</em> values in the range <code>0 ... cardinality - 1</code> appear in the array at least once.<a href="system.html#fnref9" class="footnote-back">↩︎</a></p></li>
<li id="fn10"><p>Unless the length of the data changes. I have not implemented data streaming for <code>plotscape</code> yet, however, it would be easy to extend bijection factor for streaming by simply pushing/popping the array of indices.<a href="system.html#fnref10" class="footnote-back">↩︎</a></p></li>
<li id="fn11"><p>Other use-cases may be plots involving a single geometric object such as density plots and radar plots, however, these are currently not implemented in <code>plotscape</code>.<a href="system.html#fnref11" class="footnote-back">↩︎</a></p></li>
<li id="fn12"><p>In the general case where the histogram bins are not necessarily all of equal with; if all bins are known to have the same width, we can compute the bin index in constant <span class="math inline">\(O(1)\)</span> time<a href="system.html#fnref12" class="footnote-back">↩︎</a></p></li>
<li id="fn13"><p>Or a factor isomorphic to that one, up to the permutation of indices.<a href="system.html#fnref13" class="footnote-back">↩︎</a></p></li>
<li id="fn14"><p>Equality only if either one or both of the factors are constant, or if there exists an isomorphism between the factors’ indices.<a href="system.html#fnref14" class="footnote-back">↩︎</a></p></li>
<li id="fn15"><p>Equality only if all element-wise combinations of indices form a bijection/are unique.<a href="system.html#fnref15" class="footnote-back">↩︎</a></p></li>
<li id="fn16"><p>Note that, in the example below, we assign string key properties to an array. This would be prohibited in many languages but is perfectly valid in JavaScript/TypeScript due to its highly dynamic nature.<a href="system.html#fnref16" class="footnote-back">↩︎</a></p></li>
<li id="fn17"><p>Technically, the type signature of the real function as implemented in <code>plotscape</code> is a lot more complicated since it heavily relies on generics to correctly infer the type of the summarized data, however, the basic idea is the same.<a href="system.html#fnref17" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="high-level-design.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="applied-example.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
