<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3 Design | Fluent Graphics</title>
  <meta name="description" content="3 Design | Fluent Graphics" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="3 Design | Fluent Graphics" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3 Design | Fluent Graphics" />
  
  
  

<meta name="author" content="Adam Bartonicek" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="introduction.html"/>
<link rel="next" href="glossary.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#what-is-interactive-visualization"><i class="fa fa-check"></i><b>2.1</b> What even is interactive data visualization?</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="introduction.html"><a href="introduction.html#brief-history-of-interactive-data-visualization"><i class="fa fa-check"></i><b>2.1.1</b> Brief history of interactive data visualization</a></li>
<li class="chapter" data-level="2.1.2" data-path="introduction.html"><a href="introduction.html#interactive-vs.-interacting-with"><i class="fa fa-check"></i><b>2.1.2</b> Interactive vs. interacting with</a></li>
<li class="chapter" data-level="2.1.3" data-path="introduction.html"><a href="introduction.html#what-counts-as-interactive-enough"><i class="fa fa-check"></i><b>2.1.3</b> What counts as “interactive enough”?</a></li>
<li class="chapter" data-level="2.1.4" data-path="introduction.html"><a href="introduction.html#complexity-of-interactive-features"><i class="fa fa-check"></i><b>2.1.4</b> Complexity of interactive features</a></li>
<li class="chapter" data-level="2.1.5" data-path="introduction.html"><a href="introduction.html#working-definition"><i class="fa fa-check"></i><b>2.1.5</b> Working definition</a></li>
<li class="chapter" data-level="2.1.6" data-path="introduction.html"><a href="introduction.html#list-of-common-interactive-features"><i class="fa fa-check"></i><b>2.1.6</b> List of common interactive features</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#mathematical-theory"><i class="fa fa-check"></i><b>2.2</b> Mathematical theory</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction.html"><a href="introduction.html#past-application-of-category-theory-to-data-visualization"><i class="fa fa-check"></i><b>2.2.1</b> Past Application of Category Theory to Data Visualization</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction.html"><a href="introduction.html#relations"><i class="fa fa-check"></i><b>2.2.2</b> Relations</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction.html"><a href="introduction.html#functions"><i class="fa fa-check"></i><b>2.2.3</b> Functions</a></li>
<li class="chapter" data-level="2.2.4" data-path="introduction.html"><a href="introduction.html#partitions"><i class="fa fa-check"></i><b>2.2.4</b> Partitions</a></li>
<li class="chapter" data-level="2.2.5" data-path="introduction.html"><a href="introduction.html#preorders"><i class="fa fa-check"></i><b>2.2.5</b> Preorders</a></li>
<li class="chapter" data-level="2.2.6" data-path="introduction.html"><a href="introduction.html#monoids"><i class="fa fa-check"></i><b>2.2.6</b> Monoids</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#components-of-a-data-visualization-system"><i class="fa fa-check"></i><b>2.3</b> Components of a data visualization system</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction.html"><a href="introduction.html#scales"><i class="fa fa-check"></i><b>2.3.1</b> Scales</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="design.html"><a href="design.html"><i class="fa fa-check"></i><b>3</b> Design</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="design.html"><a href="design.html#user-profile"><i class="fa fa-check"></i><b>3.0.1</b> User profile</a></li>
<li class="chapter" data-level="3.1" data-path="design.html"><a href="design.html#implementation"><i class="fa fa-check"></i><b>3.1</b> Implementation</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="design.html"><a href="design.html#programming-paradigms"><i class="fa fa-check"></i><b>3.1.1</b> Programming paradigms</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="design.html"><a href="design.html#system-components"><i class="fa fa-check"></i><b>3.2</b> System components</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="design.html"><a href="design.html#factors"><i class="fa fa-check"></i><b>3.2.1</b> Factors</a></li>
<li class="chapter" data-level="3.2.2" data-path="design.html"><a href="design.html#reducers"><i class="fa fa-check"></i><b>3.2.2</b> Reducers</a></li>
<li class="chapter" data-level="3.2.3" data-path="design.html"><a href="design.html#scales-1"><i class="fa fa-check"></i><b>3.2.3</b> Scales</a></li>
<li class="chapter" data-level="3.2.4" data-path="design.html"><a href="design.html#expanses"><i class="fa fa-check"></i><b>3.2.4</b> Expanses</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="design.html"><a href="design.html#section"><i class="fa fa-check"></i><b>3.3</b> </a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>4</b> Glossary</a></li>
<li class="chapter" data-level="5" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>5</b> Appendix</a></li>
<li class="chapter" data-level="6" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>6</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fluent Graphics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="design" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">3</span> Design<a href="design.html#design" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="user-profile" class="section level3 hasAnchor" number="3.0.1">
<h3><span class="header-section-number">3.0.1</span> User profile<a href="design.html#user-profile" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The profile of average user can also differ significantly, across systems and research areas. For example, some areas of interactive data visualization and HCI make no assumptions about the user’s level of experience or motivation, whereas others assume a highly motivated “expert” user with a sufficient level of domain knowledge <span class="citation">(<a href="#ref-dimara2019">Dimara and Perin 2019</a>)</span>.</p>
<p>While designing my system, I have attempted to</p>
</div>
<div id="implementation" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Implementation<a href="design.html#implementation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>The example code chunks in this section are written in both R and TypeScript. The reason for this is that, while I would prefer to use R for everything due to its tight integration with RMarkdown, some of the concepts are much easier to explain in a language with static typing features like TypeScript (particularly, type annotations and interfaces). However, since the examples relate to plotting and some can be improved by showing graphical output/plots, I also wanted to use (base) R for plotting. So, where graphical output is important, the code chunks are written in R, and, where the code itself is the main focus, they are written in TypeScript. I hope this bilingualism is not too confusing and have tried to use only the basic features of each language to make the examples clear.</p>
</blockquote>
<div id="programming-paradigms" class="section level3 hasAnchor" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Programming paradigms<a href="design.html#programming-paradigms" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>It is often the case that the same programming task can be solved in many, often vastly different, ways. Programs solving the same problem can differ in how they decompose the problem, how they represent and manipulate data, how they handle state, how explicit or implicit they are about handling low-level system details versus relying on abstractions, how they structure and organize their constituent components, and so on. Dealing with these concerns, and coming up with a formal set of principles for addressing them is the job of programming paradigms <span class="citation">(<a href="#ref-chambers2014">Chambers 2014</a>; <a href="#ref-jordan2015">Jordan et al. 2015</a>; <a href="#ref-van2009">Van Roy et al. 2009</a>)</span>.</p>
<p>Most programming languages are geared towards one specific style of programming, typically supporting only one or two programming paradigms to a reasonable capacity <span class="citation">(<a href="#ref-van2009">Van Roy et al. 2009</a>)</span>. Fortunately, this is not the case for either JavaScript/TypeScript or R, since both are multiparadigm programming languages <span class="citation">(<a href="#ref-chambers2014">Chambers 2014</a>; <a href="#ref-mdn2024c">MDN 2024f</a>)</span>. Both support object-oriented programming, via prototype inheritance in the case of JavaScript <span class="citation">(<a href="#ref-mdn2024d">MDN 2024b</a>)</span> and the S3, S4, and R6 systems in the case of R <span class="citation">(<a href="#ref-wickham2019">Wickham 2019</a>)</span>, and treat functions as first class citizens, allowing for functional programming style <span class="citation">(<a href="#ref-chambers2014">Chambers 2014</a>; <a href="#ref-mdn2024e">MDN 2024d</a>)</span>. Further, as C based languages, both also support classical imperative/procedural programming style, and also provide some utilities for reflective metaprogramming.</p>
<p>The flexibility of JavaScript and R allowed me to experiment with different programming paradigms while developing <code>plotscaper</code>. I had rewritten the JavaScript side of the package multiple times from scratch, testing out several different programming paradigms and styles in the process. Below, I provide a very broad overview of the paradigms I have tried, as well as an account of my experience of using each paradigm and some thoughts on its suitability towards designing interactive data visualization systems.</p>
<div id="imperative-programming" class="section level4 hasAnchor" number="3.1.1.1">
<h4><span class="header-section-number">3.1.1.1</span> Imperative programming<a href="design.html#imperative-programming" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Imperative programming style is one of the oldest and most classical styles of programming. It conceptualizes the program as a discrete sequence of steps that manipulate some mutable state <span class="citation">(<a href="#ref-frame2014">Frame and Coffey 2014</a>)</span>. In this way, it closely resembles the way CPU executes instructions.</p>
</div>
<div id="data-oriented-programming" class="section level4 hasAnchor" number="3.1.1.2">
<h4><span class="header-section-number">3.1.1.2</span> Data oriented programming<a href="design.html#data-oriented-programming" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Data oriented programming (DOP) and data oriented design (DOD) are two newer programming paradigms that have been slowly gaining prominence in the recent years. While the terms are sometimes used interchangeably, there are some subtle differences: DOP focuses more on high-level principles such as structuring and organizing code, whereas DOD, originating in the world of video-game development, tends to be more concerned with low-level optimization details such as memory layout and CPU access patterns <span class="citation">(<a href="#ref-sharvit2022">Sharvit 2022</a>; c.f. <a href="#ref-acton2014">Acton 2014</a>; <a href="#ref-fabian2018">Fabian 2018</a>)</span>. However, there is a remarkable overlap between the conclusions and high-level concepts of the two programming paradigms. For this reason, I will discuss both here simultaneously and refer to both as “DOP” unless explicitly mentioned otherwise.</p>
<p>The core idea of DOP is a data-first perspective. Under this view, programs should be viewed as transformations of data, nothing less, nothing more. As a result, every program is composed of two sets of components: stateful data and stateless functions that transform this data <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>)</span>. Data should be represented by generic data structures, formed by combining maps/structs, arrays, and primitives <span class="citation">(for example <a href="glossary.html#JSON">JSON</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>)</span>, and it may even be desirable that it adheres to the relational model <span class="citation">(<a href="#ref-codd1970">Codd 1970</a>; <a href="#ref-moseley2006">Moseley and Marks 2006</a>; <a href="#ref-fabian2018">Fabian 2018</a>; note that the data does not actually have to <em>live</em> inside a relational database, just have the shape of a normalized table, with columns represented by generic arrays)</span>. Data and code should be kept separate, with code living in separate modules, composed of stateless functions <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>)</span>. Further, since data is just itself - data - there is no obligation for it to model the real world or any kind of abstract entity and we are free to represent it in any way we want <span class="citation">(<a href="#ref-acton2014">Acton 2014</a>; <a href="#ref-fabian2018">Fabian 2018</a>; an extreme example of this are Entity Component Systems in videogames, <a href="#ref-harkonen2019">Härkönen 2019</a>)</span>. Finally, abstraction should be introduced only gradually, and most of the work should be done by generic data manipulation functions <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>)</span>.</p>
<p>It may seem that many of the DOP principles directly contradict many popular OOP principles, specifically encapsulation, inheritance, polymorphism, and domain driven design. However, many of these principles can either be reconciled with DOP, or DOP in fact provides better alternatives. Below, I go over these principles and provide code examples that further illustrate how DOP works.</p>
<div id="encapsulation" class="section level5 hasAnchor" number="3.1.1.2.1">
<h5><span class="header-section-number">3.1.1.2.1</span> Encapsulation<a href="design.html#encapsulation" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>When it comes to encapsulation in DOP, we have to differentiate between encapsulating data and encapsulating code. Encapsulating code is easy in DOP - we can simply not export certain functions from the code modules. We are then free to modify the signature of these functions without affecting the public interface <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>)</span>. Encapsulating data may require a bit more work. Depending on the language, generic data structures may not have property access modifiers <span class="citation">(although there does seem to be a trend in recent languages to support property access modifiers more generically, see e.g. <a href="#ref-rust2024">Rust Foundation 2024</a>; <a href="#ref-zig2024">Zig Software Foundation 2024</a>)</span>. For instance, in JavaScript, private properties can only be declared as part of a class declaration <span class="citation">(<a href="#ref-mdn2024e">MDN 2024d</a>)</span>. However, in most languages, it is still possible to use other language features and metaprogramming to achieve data encapsulation - for example, in JavaScript, we can use the Proxy class to emulate private property access (<a href="appendix.html#dop-encapsulation">see Appendix</a>).</p>
<p>Thus, encapsulation of data is certainly possible in DOP. However, a question still remains whether it is a good idea. Encapsulation is generally seen as a net positive in OOP, however, in the DOP view, data encapsulation presents trade-offs. While it may provide an additional layer of security, it also makes systems more complex and harder to debug <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>; <a href="#ref-sharvit2022">Sharvit 2022</a>)</span>. , And, even with fully encapsulated data, users may still come to rely on hidden features of the system <span class="citation">(<a href="#ref-fabian2018">Fabian 2018</a>)</span>. Ultimately, it is necessary to weigh the pros and cons of encapsulating data within the context of the specific use-case.</p>
<p>In JavaScript, there is also a third option which I actually found to be a good fit while writing <code>plotscape</code>, and that is a weak form of encapsulation by using symbol keys <span class="citation">(<a href="#ref-mdn2024f">MDN 2024c</a>)</span>. Symbols are builtin primitive that are guaranteed to be unique. By not exporting the symbol value, we can make a property weakly encapsulated in the sense that the user will not be able to access it without using reflection. For example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb1-1"><a href="design.html#cb1-1" tabindex="-1"></a><span class="co">// Meta.ts</span></span>
<span id="cb1-2"><a href="design.html#cb1-2" tabindex="-1"></a><span class="kw">const</span> METADATA <span class="op">=</span> <span class="bu">Symbol</span>(<span class="st">&quot;metadata&quot;</span>)<span class="op">;</span></span>
<span id="cb1-3"><a href="design.html#cb1-3" tabindex="-1"></a><span class="kw">type</span> METADATA <span class="op">=</span> <span class="kw">typeof</span> METADATA<span class="op">;</span></span>
<span id="cb1-4"><a href="design.html#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="design.html#cb1-5" tabindex="-1"></a><span class="im">export</span> <span class="kw">interface</span> Meta<span class="op">&lt;</span>T <span class="kw">extends</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">any</span><span class="op">&gt;</span> <span class="op">=</span> <span class="dt">any</span><span class="op">&gt;</span> {</span>
<span id="cb1-6"><a href="design.html#cb1-6" tabindex="-1"></a>  [METADATA]<span class="op">:</span> T<span class="op">;</span></span>
<span id="cb1-7"><a href="design.html#cb1-7" tabindex="-1"></a>}</span>
<span id="cb1-8"><a href="design.html#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="design.html#cb1-9" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Meta</span> {</span>
<span id="cb1-10"><a href="design.html#cb1-10" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">of</span><span class="op">&lt;</span>T <span class="kw">extends</span> <span class="bu">Object</span><span class="op">&gt;</span>(object<span class="op">:</span> T) {</span>
<span id="cb1-11"><a href="design.html#cb1-11" tabindex="-1"></a>    <span class="cf">return</span> { <span class="op">...</span><span class="kw">object</span><span class="op">,</span> [METADATA]<span class="op">:</span> {} }<span class="op">;</span></span>
<span id="cb1-12"><a href="design.html#cb1-12" tabindex="-1"></a>  }</span>
<span id="cb1-13"><a href="design.html#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="design.html#cb1-14" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">get</span><span class="op">&lt;</span>T <span class="kw">extends</span> Meta<span class="op">&gt;</span>(object<span class="op">:</span> T<span class="op">,</span> key<span class="op">:</span> <span class="kw">keyof</span> T[METADATA]) {</span>
<span id="cb1-15"><a href="design.html#cb1-15" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">object</span>[METADATA][key]<span class="op">;</span></span>
<span id="cb1-16"><a href="design.html#cb1-16" tabindex="-1"></a>  }</span>
<span id="cb1-17"><a href="design.html#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="design.html#cb1-18" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">set</span><span class="op">&lt;</span>T <span class="kw">extends</span> Meta<span class="op">,</span> K <span class="kw">extends</span> <span class="kw">keyof</span> T[METADATA]<span class="op">&gt;</span>(</span>
<span id="cb1-19"><a href="design.html#cb1-19" tabindex="-1"></a>    object<span class="op">:</span> T<span class="op">,</span></span>
<span id="cb1-20"><a href="design.html#cb1-20" tabindex="-1"></a>    key<span class="op">:</span> K<span class="op">,</span></span>
<span id="cb1-21"><a href="design.html#cb1-21" tabindex="-1"></a>    value<span class="op">:</span> T[METADATA][K]</span>
<span id="cb1-22"><a href="design.html#cb1-22" tabindex="-1"></a>  ) {</span>
<span id="cb1-23"><a href="design.html#cb1-23" tabindex="-1"></a>    <span class="kw">object</span>[METADATA][key] <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb1-24"><a href="design.html#cb1-24" tabindex="-1"></a>  }</span>
<span id="cb1-25"><a href="design.html#cb1-25" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we can import the module and use it to add secret metadata to arbitrary data objects:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb2-1"><a href="design.html#cb2-1" tabindex="-1"></a><span class="im">import</span> { Meta } <span class="im">from</span> <span class="st">&quot;./Meta.ts&quot;</span></span>
<span id="cb2-2"><a href="design.html#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="design.html#cb2-3" tabindex="-1"></a><span class="kw">interface</span> User <span class="kw">extends</span> Meta<span class="op">&lt;</span>{ id<span class="op">:</span> <span class="dt">number</span> }<span class="op">&gt;</span> {</span>
<span id="cb2-4"><a href="design.html#cb2-4" tabindex="-1"></a>  name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb2-5"><a href="design.html#cb2-5" tabindex="-1"></a>}</span>
<span id="cb2-6"><a href="design.html#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="design.html#cb2-7" tabindex="-1"></a><span class="kw">const</span> user<span class="op">:</span> User <span class="op">=</span> Meta<span class="op">.</span><span class="fu">of</span>({ name<span class="op">:</span> <span class="st">&quot;Adam&quot;</span> })<span class="op">;</span></span>
<span id="cb2-8"><a href="design.html#cb2-8" tabindex="-1"></a>Meta<span class="op">.</span><span class="fu">set</span>(user<span class="op">,</span> <span class="vs">`id`</span><span class="op">,</span> <span class="dv">1337</span>)<span class="op">;</span></span>
<span id="cb2-9"><a href="design.html#cb2-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(Meta<span class="op">.</span><span class="fu">get</span>(user<span class="op">,</span> <span class="vs">`id`</span>))<span class="op">;</span></span>
<span id="cb2-10"><a href="design.html#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="design.html#cb2-11" tabindex="-1"></a><span class="kw">interface</span> Variable <span class="kw">extends</span> <span class="bu">Array</span><span class="op">&lt;</span><span class="dt">number</span><span class="op">&gt;,</span> Meta<span class="op">&lt;</span>{ min<span class="op">:</span> <span class="dt">number</span><span class="op">;</span> max<span class="op">:</span> <span class="dt">number</span> }<span class="op">&gt;</span> {}</span>
<span id="cb2-12"><a href="design.html#cb2-12" tabindex="-1"></a></span>
<span id="cb2-13"><a href="design.html#cb2-13" tabindex="-1"></a><span class="kw">const</span> values<span class="op">:</span> Variable <span class="op">=</span> Meta<span class="op">.</span><span class="fu">of</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])<span class="op">;</span></span>
<span id="cb2-14"><a href="design.html#cb2-14" tabindex="-1"></a>Meta<span class="op">.</span><span class="fu">set</span>(values<span class="op">,</span> <span class="vs">`min`</span><span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb2-15"><a href="design.html#cb2-15" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(Meta<span class="op">.</span><span class="fu">get</span>(values<span class="op">,</span> <span class="vs">`min`</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 1337
## 0</code></pre>
<p>The user can access and set the metadata values using the <code>Meta.get</code> and <code>Meta.set</code> functions, however, they cannot directly access the metadata property since the value <code>METADATA</code> symbol is not exported. There is a way to access this symbol via the <code>Reflect.ownKeys</code> and <code>Object.getOwnPropertySymbols</code> functions, and so this is not a strong form of encapsulation <span class="citation">(<a href="#ref-mdn2024f">MDN 2024c</a>)</span>. However, arguably, if the user goes as far as to use these functions, and, assuming we are not storing any sensitive data (which is generally not the case in interactive data visualization), it may be reasonable to allow them to access these “private” values and suffer the consequences.</p>
</div>
<div id="inheritance" class="section level5 hasAnchor" number="3.1.1.2.2">
<h5><span class="header-section-number">3.1.1.2.2</span> Inheritance<a href="design.html#inheritance" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In OOP, the primary mechanism for code reuse is inheritance.</p>
<p>In DOP, since data is generic and separate from behavior, we can call functions from any module as long as the data we provide it as arguments adheres to the module’s interface. This makes code reuse trivial. For example, here’s a simplified version of the <code>Reactive</code> interface (Observer pattern) from <code>plotscape</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb4-1"><a href="design.html#cb4-1" tabindex="-1"></a></span>
<span id="cb4-2"><a href="design.html#cb4-2" tabindex="-1"></a><span class="kw">const</span> LISTENERS <span class="op">=</span> <span class="bu">Symbol</span>(<span class="vs">`listeners`</span>)<span class="op">;</span> <span class="co">// A unique symbol, to avoid namespace clashes</span></span>
<span id="cb4-3"><a href="design.html#cb4-3" tabindex="-1"></a><span class="kw">type</span> Dict <span class="op">=</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">any</span><span class="op">&gt;;</span> <span class="co">// Generic dictionary type</span></span>
<span id="cb4-4"><a href="design.html#cb4-4" tabindex="-1"></a><span class="kw">type</span> Callback <span class="op">=</span> (data<span class="op">:</span> Dict) <span class="kw">=&gt;</span> <span class="dt">void</span><span class="op">;</span> <span class="co">// Generic callback function type</span></span>
<span id="cb4-5"><a href="design.html#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="design.html#cb4-6" tabindex="-1"></a><span class="kw">interface</span> Reactive {</span>
<span id="cb4-7"><a href="design.html#cb4-7" tabindex="-1"></a>  [LISTENERS]<span class="op">:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> Callback[]<span class="op">&gt;;</span></span>
<span id="cb4-8"><a href="design.html#cb4-8" tabindex="-1"></a>}</span>
<span id="cb4-9"><a href="design.html#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="design.html#cb4-10" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Reactive</span> {</span>
<span id="cb4-11"><a href="design.html#cb4-11" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">of</span><span class="op">&lt;</span>T <span class="kw">extends</span> <span class="bu">Object</span><span class="op">&gt;</span>(object<span class="op">:</span> T)<span class="op">:</span> T <span class="op">&amp;</span> Reactive {</span>
<span id="cb4-12"><a href="design.html#cb4-12" tabindex="-1"></a>    <span class="cf">return</span> { <span class="op">...</span><span class="kw">object</span><span class="op">,</span> [LISTENERS]<span class="op">:</span> {} }<span class="op">;</span></span>
<span id="cb4-13"><a href="design.html#cb4-13" tabindex="-1"></a>  }</span>
<span id="cb4-14"><a href="design.html#cb4-14" tabindex="-1"></a></span>
<span id="cb4-15"><a href="design.html#cb4-15" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">listen</span>(object<span class="op">:</span> Reactive<span class="op">,</span> event<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> cb<span class="op">:</span> Callback) {</span>
<span id="cb4-16"><a href="design.html#cb4-16" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">object</span>[LISTENERS][<span class="bu">event</span>]) <span class="kw">object</span>[LISTENERS][<span class="bu">event</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb4-17"><a href="design.html#cb4-17" tabindex="-1"></a>    <span class="kw">object</span>[LISTENERS][<span class="bu">event</span>]<span class="op">.</span><span class="fu">push</span>(cb)<span class="op">;</span></span>
<span id="cb4-18"><a href="design.html#cb4-18" tabindex="-1"></a>  }</span>
<span id="cb4-19"><a href="design.html#cb4-19" tabindex="-1"></a></span>
<span id="cb4-20"><a href="design.html#cb4-20" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">dispatch</span>(object<span class="op">:</span> Reactive<span class="op">,</span> event<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> data<span class="op">:</span> Dict) {</span>
<span id="cb4-21"><a href="design.html#cb4-21" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> cb <span class="kw">of</span> <span class="kw">object</span>[LISTENERS][<span class="bu">event</span>] <span class="op">??</span> []) <span class="fu">cb</span>(data)<span class="op">;</span></span>
<span id="cb4-22"><a href="design.html#cb4-22" tabindex="-1"></a>  }</span>
<span id="cb4-23"><a href="design.html#cb4-23" tabindex="-1"></a>}</span>
<span id="cb4-24"><a href="design.html#cb4-24" tabindex="-1"></a></span>
<span id="cb4-25"><a href="design.html#cb4-25" tabindex="-1"></a><span class="kw">interface</span> Dog <span class="kw">extends</span> Reactive {</span>
<span id="cb4-26"><a href="design.html#cb4-26" tabindex="-1"></a>  name<span class="op">:</span> <span class="dt">string</span></span>
<span id="cb4-27"><a href="design.html#cb4-27" tabindex="-1"></a>}</span>
<span id="cb4-28"><a href="design.html#cb4-28" tabindex="-1"></a></span>
<span id="cb4-29"><a href="design.html#cb4-29" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Dog</span> {</span>
<span id="cb4-30"><a href="design.html#cb4-30" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">of</span>(name<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb4-31"><a href="design.html#cb4-31" tabindex="-1"></a>    <span class="cf">return</span> Reactive<span class="op">.</span><span class="fu">of</span>({ name })</span>
<span id="cb4-32"><a href="design.html#cb4-32" tabindex="-1"></a>  }</span>
<span id="cb4-33"><a href="design.html#cb4-33" tabindex="-1"></a>}</span>
<span id="cb4-34"><a href="design.html#cb4-34" tabindex="-1"></a></span>
<span id="cb4-35"><a href="design.html#cb4-35" tabindex="-1"></a><span class="kw">const</span> dog <span class="op">=</span> Dog<span class="op">.</span><span class="fu">of</span>(<span class="vs">`Terry`</span>)</span>
<span id="cb4-36"><a href="design.html#cb4-36" tabindex="-1"></a>Reactive<span class="op">.</span><span class="fu">listen</span>(dog<span class="op">,</span> <span class="vs">`car goes by`</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Woof!`</span>))</span>
<span id="cb4-37"><a href="design.html#cb4-37" tabindex="-1"></a>Reactive<span class="op">.</span><span class="fu">dispatch</span>(dog<span class="op">,</span> <span class="vs">`car goes by`</span>)</span></code></pre></div>
<pre><code>## Woof!</code></pre>
</div>
</div>
</div>
</div>
<div id="system-components" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> System components<a href="design.html#system-components" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="factors" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Factors<a href="design.html#factors" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Factors provide a way to partition the data into multiple disjoint parts.</p>
<div id="product-factors" class="section level4 hasAnchor" number="3.2.1.1">
<h4><span class="header-section-number">3.2.1.1</span> Product factors<a href="design.html#product-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We can combine a factor with <span class="math inline">\(j\)</span> levels and another factor with <span class="math inline">\(k\)</span> levels into a product factor with up to <span class="math inline">\(j \cdot k\)</span> levels.</p>
<p>I independently discovered a formula similar to <span class="citation">(<a href="#ref-wickham2013">Wickham 2013</a>)</span>:</p>
<p><span class="math display">\[i_{\text{product}} = i_1 + i_2 \cdot \max(j, k)\]</span></p>
</div>
</div>
<div id="reducers" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Reducers<a href="design.html#reducers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><span class="citation">(<a href="#ref-gray1997">Gray et al. 1997</a>)</span> came up with OLAP data cube</p>
</div>
<div id="scales-1" class="section level3 hasAnchor" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Scales<a href="design.html#scales-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To visualize data, we need to be able to translate values from the space of the data to space of the graphical device (computer screen). In most data visualization systems, this is done by specialized components called scales. While there exists is a fair amount of literature on the theoretical properties of scales [SEE INTRODUCTION], much less is written about the actual details of implementing scales in concrete data visualization systems. As such, the following section is based largely on how scales have been implemented in other data visualization codebases, such as the <code>ggplot2</code> R package <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span> or <code>d3-scale</code> module of D3 <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>)</span>, as well on personal insights while implementing the package.</p>
<div id="overview" class="section level4 hasAnchor" number="3.2.3.1">
<h4><span class="header-section-number">3.2.3.1</span> Overview<a href="design.html#overview" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>From a high-level perspective, a scale is just a function <span class="math inline">\(s: D \to V\)</span> which translates values of the data <span class="math inline">\(d \in D\)</span> to values of some visual attribute <span class="math inline">\(v \in V\)</span>, such as the x- and y-position, length, area, radius, or color. This function may or may not be invertible, such that each value of the visual attribute can but does not have to be identified with a unique data value.</p>
<p>One of the most common and typical cases is where both <span class="math inline">\(D\)</span> and <span class="math inline">\(V\)</span> are subsets of the real numbers:</p>
<p><span class="math display">\[s: [d_{min}, d_{max}] \to [v_{min}, v_{max}] \qquad d_{min}, d_{max}, v_{min}, v_{max} \in \mathbb{R}\]</span></p>
<p>For example, suppose our data takes values in the range from 1 to 10 and we want to plot it along the x-axis, within a 800 pixels wide plotting region. Then, our scale is simply:</p>
<p><span class="math display">\[s_x: [1, 10] \to [0, 800]\]</span></p>
<p>Now, there is an infinite number of functions that fit this signature. However, one particularly nice and simple candidate is the following function:</p>
<div class="definition">
<p><span id="def:simple" class="definition"><strong>Definition 3.1  (Simple scale function) </strong></span><span class="math display">\[s(d) = v_{max} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
</div>
<p>if we substitute the concrete values into the formula, this becomes:</p>
<p><span class="math display">\[s_x(d) = 0 + \frac{d - 1}{10 - 1} \cdot (800 - 0) = [(d - 1) / 9] \cdot 800\]</span></p>
<p>The function is a simple linear map, which acts on the data in the following way:</p>
<ul>
<li><span class="math inline">\(s_x(1) = (1 - 1) / 9 \cdot 800 = 0\)</span></li>
<li><span class="math inline">\(s_x(10) = (10 - 1) / 9 \cdot 800 = 800\)</span></li>
<li><span class="math inline">\(s_x(d) \in (0, 800)\)</span> for any <span class="math inline">\(d \in (1, 10)\)</span></li>
</ul>
<p>That is, the function maps the data value 1 to pixel 0 (left border of the plotting region), value 10 to to pixel 800 (right border of the plotting region), and any value in between 1 and 10 inside the interval 0 to 800, proportionally to where in the data range it is located.</p>
<p>It is relatively simple to translate the formula in <a href="design.html#def:simple">3.1</a> to code:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb6-1"><a href="design.html#cb6-1" tabindex="-1"></a><span class="co">// simpleScale.ts</span></span>
<span id="cb6-2"><a href="design.html#cb6-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale</span>(</span>
<span id="cb6-3"><a href="design.html#cb6-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb6-4"><a href="design.html#cb6-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb6-5"><a href="design.html#cb6-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb6-6"><a href="design.html#cb6-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb6-7"><a href="design.html#cb6-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb6-8"><a href="design.html#cb6-8" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb6-9"><a href="design.html#cb6-9" tabindex="-1"></a>  <span class="cf">return</span> vmin <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb6-10"><a href="design.html#cb6-10" tabindex="-1"></a>}</span></code></pre></div>
<p>And indeed, this function works the way we would expect:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb7-1"><a href="design.html#cb7-1" tabindex="-1"></a><span class="im">import</span> { simpleScale } <span class="im">from</span> <span class="st">&quot;./simpleScale.ts&quot;</span></span>
<span id="cb7-2"><a href="design.html#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="design.html#cb7-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb7-4"><a href="design.html#cb7-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb7-5"><a href="design.html#cb7-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0
## 400
## 800</code></pre>
</div>
<div id="the-limits-of-modeling-scales-as-simple-functions" class="section level4 hasAnchor" number="3.2.3.2">
<h4><span class="header-section-number">3.2.3.2</span> The limits of modeling scales as simple functions<a href="design.html#the-limits-of-modeling-scales-as-simple-functions" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Simple scale functions like the one above can work fine for basic data visualization systems. However, once we begin adding more features, this design can become prohibitive. Consider, for example, what happens if we want to:</p>
<ul>
<li>Expand the scale limits</li>
<li>Apply non-linear transformations</li>
<li>Pan, zoom, reverse, or otherwise modify the scales interactively</li>
<li>Scale discrete data</li>
</ul>
<p>Let’s take the first point as a motivating example. Consider what happens to data points at the limits of the data range:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="design.html#cb9-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb9-2"><a href="design.html#cb9-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb9-3"><a href="design.html#cb9-3" tabindex="-1"></a>col <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="st">&quot;indianred&quot;</span>, <span class="st">&quot;grey80&quot;</span>)</span>
<span id="cb9-4"><a href="design.html#cb9-4" tabindex="-1"></a></span>
<span id="cb9-5"><a href="design.html#cb9-5" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>, <span class="at">xaxs =</span> <span class="st">&quot;i&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-8-1.png" width="800px" style="display: block; margin: auto;" /></p>
<p>The plot above shows values scaled using the simple linear mapping described above along the x-axis, i.e. <span class="math inline">\(s: [1, 10] \to [0, 800]\)</span>. Notice that, since the position of the points representing the values 1 and 10 get mapped to pixel values 0 and 800 (the left and right border of the plot), resulting in only half of each point being visible.</p>
<p>To address this, most data visualization systems automatically expand the range of the domain by some pre-specified percentage:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="design.html#cb10-1" tabindex="-1"></a><span class="co"># By default, the plot() function automatically expands the x- and y-axis</span></span>
<span id="cb10-2"><a href="design.html#cb10-2" tabindex="-1"></a><span class="co"># scale limits by approximately 4% on each end, see `xaxs` in ?graphics::par</span></span>
<span id="cb10-3"><a href="design.html#cb10-3" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-9-1.png" width="800px" style="display: block; margin: auto;" /></p>
<p>We <em>could</em> achieve similar effect by modifying the scale function and adding an additional argument:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb11-1"><a href="design.html#cb11-1" tabindex="-1"></a><span class="co">// simpleScale2.ts</span></span>
<span id="cb11-2"><a href="design.html#cb11-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale2</span>(</span>
<span id="cb11-3"><a href="design.html#cb11-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb11-4"><a href="design.html#cb11-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb11-5"><a href="design.html#cb11-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb11-6"><a href="design.html#cb11-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb11-7"><a href="design.html#cb11-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb11-8"><a href="design.html#cb11-8" tabindex="-1"></a>  exp<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb11-9"><a href="design.html#cb11-9" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb11-10"><a href="design.html#cb11-10" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb11-11"><a href="design.html#cb11-11" tabindex="-1"></a>    vmin <span class="op">+</span> (exp <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> exp)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)</span>
<span id="cb11-12"><a href="design.html#cb11-12" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb11-13"><a href="design.html#cb11-13" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, if we set the <code>exp</code> argument to some positive value, the scaled values get mapped closer to the center of the plotting region. For example, setting <code>exp</code> to 0.1 moves each of the data limits 5% closer to the center of the plotting region:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb12-1"><a href="design.html#cb12-1" tabindex="-1"></a><span class="im">import</span> { simpleScale2 } <span class="im">from</span> <span class="st">&quot;./simpleScale2.ts&quot;</span></span>
<span id="cb12-2"><a href="design.html#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="design.html#cb12-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.1</span>))<span class="op">;</span></span>
<span id="cb12-4"><a href="design.html#cb12-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.1</span>))<span class="op">;</span></span>
<span id="cb12-5"><a href="design.html#cb12-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.1</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 40
## 400
## 760</code></pre>
<p>However, with many additional arguments, the function can quickly become unwieldy. The logic inside the function’s body gets more complicated, and if we have to call the function in multiple places in our code, it may become difficult to remember the order and identity of the arguments. Further, we may want to persist or modify some of the arguments during runtime (such as when panning or zooming). Therefore, a more structured approach is needed.</p>
</div>
<div id="solution-two-component-scale-system" class="section level4 hasAnchor" number="3.2.3.3">
<h4><span class="header-section-number">3.2.3.3</span> Solution: Two-component scale system<a href="design.html#solution-two-component-scale-system" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The linear mapping formula can guide us in decomposing the scaling function into smaller, more manageable parts. By looking at the formula closely, we may be able to see that it can be expressed as the composition of two simpler functions:</p>
<div class="definition">
<p><span id="def:unlabeled-div-11" class="definition"><strong>Definition 3.2  (Two-component scale system) </strong></span><span class="math display">\[s(d) = \color{steelblue}{v_{min} +} \color{indianred}{\frac{d - d_{min}}{d_{max} - d_{min}}} \color{steelblue}{\cdot (v_{max} - v_{min})}\]</span></p>
<p>where we can interpret <span class="math inline">\(s\)</span> as being composed of:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(\color{indianred}{n: D \to [0, 1], \qquad n(d) = (d - d_{min}) / (d_{max} - d_{min})}\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(\color{steelblue}{u: [0, 1] \to V, \qquad u(p) = v_{min} + p \cdot (v_{max} - v_{min})}\)</span></li>
</ul>
<p>Such that:</p>
<p><span class="math display">\[s(d) = \color{steelblue}{u(} \color{indianred}{n(\color{black}{d})} \color{steelblue}{)}\]</span></p>
</div>
<p>Put simply, the normalize function <span class="math inline">\(n\)</span> translates data values <span class="math inline">\(d \in D\)</span> to a percentage <span class="math inline">\(p \in [0, 1]\)</span>, and the unnormalize function <span class="math inline">\(u\)</span> converts the percentage to the space of the visual attribute <span class="math inline">\(V\)</span>.</p>
<p>In code, we can write this as follows:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb14-1"><a href="design.html#cb14-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb14-2"><a href="design.html#cb14-2" tabindex="-1"></a>  <span class="cf">return</span> (d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)</span>
<span id="cb14-3"><a href="design.html#cb14-3" tabindex="-1"></a>}</span>
<span id="cb14-4"><a href="design.html#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="design.html#cb14-5" tabindex="-1"></a><span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb14-6"><a href="design.html#cb14-6" tabindex="-1"></a> <span class="cf">return</span> vmin <span class="op">+</span> p <span class="op">*</span> (vmax <span class="op">-</span> vmin) </span>
<span id="cb14-7"><a href="design.html#cb14-7" tabindex="-1"></a>}</span>
<span id="cb14-8"><a href="design.html#cb14-8" tabindex="-1"></a></span>
<span id="cb14-9"><a href="design.html#cb14-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>))</span>
<span id="cb14-10"><a href="design.html#cb14-10" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">unnormalize</span>(<span class="fl">0.5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb14-11"><a href="design.html#cb14-11" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">unnormalize</span>(<span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0.5
## 400
## 400</code></pre>
<p>This two component system allows for a clean separation of concerns. Specifically, the normalize function only needs to know how to map the data values to <span class="math inline">\([0, 1]\)</span>. It does not need to be aware of where these normalized data values will be mapped to. Conversely, the unnormalize function only needs to understand how to translate values from <span class="math inline">\([0, 1]\)</span> to the space of the visual attribute (such as x-axis position).</p>
<p>It is worth noting that there is nothing inherently special about the interval <span class="math inline">\([0, 1]\)</span> as the intermediate domain: any finite subset of <span class="math inline">\(\mathbb{R}\)</span> would do. However, the interval <span class="math inline">\([0, 1]\)</span> is convenient, both in terms of interpretation as well as for implementation, as will be discussed later.</p>
<p>Finally, so far I have discussed scales as <em>functions</em>: the scale function, the normalize function, and unnormalize function. Framing scales as composition of functions leads to a nice correspondence between the mathematical definition and the code implementation. However, in practice, it may be more convenient to implement the domain and codomain as <em>objects</em> or <em>classes</em>, as we will see in the following section. The important point is that, no matter what type the two components are, each is responsible for translating values from/to its domain and the interval <span class="math inline">\([0, 1]\)</span>.</p>
</div>
<div id="past-implementations-of-scales" class="section level4 hasAnchor" number="3.2.3.4">
<h4><span class="header-section-number">3.2.3.4</span> Past implementations of scales<a href="design.html#past-implementations-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Implementing scales as composition of two components is fairly standard practice across data visualization packages. For example, the D3 library <span class="citation">(<a href="#ref-bostock2011">Michael Bostock, Ogievetsky, and Heer 2011</a>)</span> implements scales in a functional style, with the values representing the data domain and the visual (co)domain being provided as tuples or arrays of values, either during initialization or at some later point. For illustration, here is an example from the oficial documentation <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>)</span>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb16-1"><a href="design.html#cb16-1" tabindex="-1"></a><span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">960</span>])<span class="op">;</span></span>
<span id="cb16-2"><a href="design.html#cb16-2" tabindex="-1"></a><span class="fu">x</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// 80</span></span>
<span id="cb16-3"><a href="design.html#cb16-3" tabindex="-1"></a><span class="kw">const</span> color <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span> [<span class="st">&quot;brown&quot;</span><span class="op">,</span> <span class="st">&quot;steelblue&quot;</span>])<span class="op">;</span></span>
<span id="cb16-4"><a href="design.html#cb16-4" tabindex="-1"></a><span class="fu">color</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// &quot;rgb(154, 52, 57)&quot;</span></span>
<span id="cb16-5"><a href="design.html#cb16-5" tabindex="-1"></a><span class="co">// The domain and codomain can also be specified separately</span></span>
<span id="cb16-6"><a href="design.html#cb16-6" tabindex="-1"></a><span class="kw">const</span> y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>])<span class="op">;</span> </span></code></pre></div>
<p>Internally, D3 uses specialized functions to translate from the domain to the codomain (such as the <code>normalize()</code> and <code>scale()</code> functions for continuous and discrete/ordinal domains, respectively, and various <code>interpolate()</code> functions for codomains).</p>
<p>Similarly, in <code>ggplot2</code> <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span>, scales are built upon the <code>Scale</code> class, with each subtype implementing <code>limits</code> and <code>palette</code> properties. Similar to D3, the <code>limits</code> property is a vector which corresponds to the data domain and the <code>palette</code> property is a function which corresponds roughly to the visual codomain (the x- and y-position behave slightly differently, due to being passed through coordinate systems). Internally, the package uses the <code>rescale</code> function from the <code>scales</code> package <span class="citation">(<a href="#ref-wickham2023">Wickham, Pedersen, and Seidel 2023</a>)</span> to map data values to <span class="math inline">\([0, 1]\)</span> and then the <code>palette</code> function is responsible for mapping these normalized values to the visual attribute. For illustration, here’s the full definition of the <code>map</code> method on the <code>ScaleContinuous</code> class (I’ve added comments for clarity):</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="design.html#cb17-1" tabindex="-1"></a>map <span class="ot">=</span> <span class="cf">function</span>(self, x, <span class="at">limits =</span> self<span class="sc">$</span><span class="fu">get_limits</span>()) {</span>
<span id="cb17-2"><a href="design.html#cb17-2" tabindex="-1"></a>  <span class="co"># Limits are just a tuple, rescale maps x to [0, 1]</span></span>
<span id="cb17-3"><a href="design.html#cb17-3" tabindex="-1"></a>  x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">rescale</span>(self<span class="sc">$</span><span class="fu">oob</span>(x, <span class="at">range =</span> limits), limits) </span>
<span id="cb17-4"><a href="design.html#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="design.html#cb17-5" tabindex="-1"></a>  uniq <span class="ot">&lt;-</span> <span class="fu">unique0</span>(x)</span>
<span id="cb17-6"><a href="design.html#cb17-6" tabindex="-1"></a>  <span class="co"># Palette is a function which returns a vector of attribute values</span></span>
<span id="cb17-7"><a href="design.html#cb17-7" tabindex="-1"></a>  pal <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">palette</span>(uniq) </span>
<span id="cb17-8"><a href="design.html#cb17-8" tabindex="-1"></a>  scaled <span class="ot">&lt;-</span> pal[<span class="fu">match</span>(x, uniq)]</span>
<span id="cb17-9"><a href="design.html#cb17-9" tabindex="-1"></a></span>
<span id="cb17-10"><a href="design.html#cb17-10" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(scaled), scaled, self<span class="sc">$</span>na.value)</span>
<span id="cb17-11"><a href="design.html#cb17-11" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="proposed-model-of-scales" class="section level4 hasAnchor" number="3.2.3.5">
<h4><span class="header-section-number">3.2.3.5</span> Proposed model of scales<a href="design.html#proposed-model-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One feature that the models of scales that <code>D3</code> and <code>ggplot2</code> rely on is that they both treat the data domain and the visual attribute codomain as different types. In <code>D3</code>, fundamentally different functions are used to translate from <span class="math inline">\(D \to [0, 1]\)</span> and from <span class="math inline">\([0, 1] \to V\)</span>, and, in <code>ggplot2</code>, <code>limits</code> is a simple vector/tuple whereas <code>palette</code> is a function. While this approach may have some benefits, offering greater flexibility, it also does add additional complexity. Specifically, we have to use one mental model when considering the domain and another when considering the codomain. Further, this model of scales only works in one direction: mapping values <span class="math inline">\(D \to V\)</span>. For going the the other way, i.e. mapping <span class="math inline">\(V \to D\)</span>, other specialized functions have to be used.</p>
<p>I propose a model of scales which implements both the domain and the codomain as objects of the same type: <code>Expanse</code>. Fundamentally, this makes it so that the only difference between the data domain and the visual attribute codomain is which property of the scale they are assigned to. I argue that this model has several benefits, including making the code easier to reason about, as well as providing a simple interface for inverting values from <span class="math inline">\(V \to D\)</span>.</p>
<p>Here is a (slightly) simplified version of the <code>Scale</code> interface:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb18-1"><a href="design.html#cb18-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span> {</span>
<span id="cb18-2"><a href="design.html#cb18-2" tabindex="-1"></a>  domain<span class="op">:</span> Expanse<span class="op">&lt;</span>D<span class="op">&gt;</span></span>
<span id="cb18-3"><a href="design.html#cb18-3" tabindex="-1"></a>  codomain<span class="op">:</span> Expanse<span class="op">&lt;</span>V<span class="op">&gt;</span></span>
<span id="cb18-4"><a href="design.html#cb18-4" tabindex="-1"></a>}</span></code></pre></div>
<p><code>D</code> represents the type of the data domain, and <code>V</code> represents the type of the visual attribute codomain.</p>
<p>The main nuts and bolts of the <code>Scale</code> interface are the following two functions:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb19-1"><a href="design.html#cb19-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> D<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> D)<span class="op">:</span> V</span>
<span id="cb19-2"><a href="design.html#cb19-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> V)<span class="op">:</span> D</span></code></pre></div>
<p>The <code>pushforward</code> function <em>pushes values forward</em> through the scale, first through its domain and then its codomain, and the <code>pullback</code> function <em>pulls values back</em>, first through its codomain and then through its domain. For clarity, here is a simplified implementation:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb20-1"><a href="design.html#cb20-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> D)<span class="op">:</span> V {</span>
<span id="cb20-2"><a href="design.html#cb20-2" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(scale<span class="op">.</span><span class="at">codomain</span><span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(scale<span class="op">.</span><span class="at">domain</span><span class="op">,</span> value))</span>
<span id="cb20-3"><a href="design.html#cb20-3" tabindex="-1"></a>}</span>
<span id="cb20-4"><a href="design.html#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="design.html#cb20-5" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> V)<span class="op">:</span> D {</span>
<span id="cb20-6"><a href="design.html#cb20-6" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(scale<span class="op">.</span><span class="at">domain</span><span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(scale<span class="op">.</span><span class="at">codomain</span><span class="op">,</span> value))</span>
<span id="cb20-7"><a href="design.html#cb20-7" tabindex="-1"></a>}</span></code></pre></div>
<p>In plain words, most of the work is done using the two <code>Expanse</code> objects: we use <code>domain</code> to translates <span class="math inline">\(D \to [0, 1]\)</span> and codomain to translate <span class="math inline">\([0, 1] \to V\)</span>. <code>Scale</code> serves as a plumbing, connecting these two expanses together.</p>
<p>However, before diving in to discuss <code>Expanse</code>, there are also a few behaviors we may like to implement on <code>Scale</code>. Specifically,</p>
</div>
</div>
<div id="expanses" class="section level3 hasAnchor" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> Expanses<a href="design.html#expanses" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As was hinted at in the previous section, expanses map values between their domain and the interval <span class="math inline">\([0, 1]\)</span>. To do this, they are equipped with two familiar functions:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(\color{indianred}{n: X \to [0, 1]}\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(\color{steelblue}{u: [0, 1] \to X}\)</span></li>
</ul>
<p>Or, in code:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb21-1"><a href="design.html#cb21-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span><span class="op">&lt;</span>X<span class="op">&gt;</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>X<span class="op">&gt;,</span> value<span class="op">:</span> X)<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb21-2"><a href="design.html#cb21-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">unnnormalize</span><span class="op">&lt;</span>X<span class="op">&gt;</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>X<span class="op">&gt;,</span> value<span class="op">:</span> <span class="dt">number</span>)<span class="op">:</span> X</span></code></pre></div>
<p>Notice that, whereas before we had considered <em>normalize</em> as mapping between <span class="math inline">\(D \to [0, 1]\)</span> and <em>unnormalize</em> as mapping between <span class="math inline">\([0, 1] \to V\)</span>, we now consider both as mapping between <span class="math inline">\([0, 1]\)</span> and an arbitrary domain <span class="math inline">\(X\)</span>. This domain can represent the data or the visual attribute - the expanse is agnostic about this.</p>
<p>Also, while before we have discussed domains as subsets of <span class="math inline">\(\mathbb{R}\)</span>, we can now start thinking about them as arbitrary sets. While subsets of <span class="math inline">\(\mathbb{R}\)</span> and sets of strings are really the only types of domains used in <code>plotscaper</code>, the model should readily extends to other sets, as long as a mapping to and from <span class="math inline">\([0, 1]\)</span> can be provided.</p>
<p>How <code>normalize</code> and <code>unnormalize</code> are implemented will depend largely on the subtype of <code>Expanse</code>, as well as on the desired behavior. For example, as will be discussed later, in <code>plotscaper</code>, the normalize and unnormalize methods implemented for <code>ExpanseContinuous</code> (subtype of <code>Expanse&lt;number&gt;</code>) work largely the same way as in section [SECTION]. However, while <code>ExpansePoint</code> and <code>ExpanseBand</code> are both subtypes of <code>Expanse&lt;string&gt;</code>, they behave differently - <code>ExpansePoint</code> maps strings (factor levels) to equidistant points along <span class="math inline">\([0, 1]\)</span>, whereas <code>ExpanseBand</code> maps the strings into the middle of “buckets” along <span class="math inline">\([0, 1]\)</span>.</p>
<p>However, there is also some behavior that we may want to apply the same way across the different expanse subtypes. For example, it seems reasonable that the user should be able to zoom, pan, or reverse axes, regardless of whether a plot shows discrete or continuous data. As such, there may be some properties and functions common to the <code>Expanse</code> type. I will discuss these first.</p>
<div id="zero-and-one" class="section level4 hasAnchor" number="3.2.4.1">
<h4><span class="header-section-number">3.2.4.1</span> Zero and one<a href="design.html#zero-and-one" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The maps may also take in and return values outside of <span class="math inline">\(D^*\)</span> and <span class="math inline">\([0, 1]\)</span>, if adjustments have been made. For instance, in most data visualization packages, x- and y-axis limits are by default expanded some percentage beyond the range of the observed data to avoid the maximum and minimum datapoints from overlapping with the limits. For example, in base R:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="design.html#cb22-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb22-2"><a href="design.html#cb22-2" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb22-3"><a href="design.html#cb22-3" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb22-4"><a href="design.html#cb22-4" tabindex="-1"></a></span>
<span id="cb22-5"><a href="design.html#cb22-5" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb22-6"><a href="design.html#cb22-6" tabindex="-1"></a><span class="fu">plot</span>(x, y) </span>
<span id="cb22-7"><a href="design.html#cb22-7" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">xaxs =</span> <span class="st">&#39;i&#39;</span>, <span class="at">yaxs =</span> <span class="st">&#39;i&#39;</span>) </span></code></pre></div>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:unnamed-chunk-19"></span>
<img src="_main_files/figure-html/unnamed-chunk-19-1.png" alt="Expanding axes. By default, axes in base R `plot()` function are expanded 4% beyond the range of the data (left). Otherwise, datapoints on the limits of their respective scales end up overlapping with the plot borders (right)." width="672" />
<p class="caption">
Figure 3.1: Expanding axes. By default, axes in base R <code>plot()</code> function are expanded 4% beyond the range of the data (left). Otherwise, datapoints on the limits of their respective scales end up overlapping with the plot borders (right).
</p>
</div>
<p>Thus, upon normalizing the minimum and maximum data values, the expanse should return values other than <span class="math inline">\(\{0, 1\}\)</span>. Likewise, to support user interactions such as zooming and panning, the expanses may accept and return values outside of <span class="math inline">\(D^*\)</span> and <span class="math inline">\([0, 1]\)</span>.</p>
<p>Zooming and panning should be orthogonal to the underlying data type, such that user can interact with the plots the same way<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>, no matter whether their axes are continuous, discrete, or some combination of the two. To this end, I introduce two parameters representing the normalized value (<span class="math inline">\(p\)</span>) of the minimum and maximum data point, called <em>zero</em> and <em>one</em> respectively. These parameters are agnostic to the underlying data type, such that if we have the data type-specific maps <span class="math inline">\(n&#39;\)</span> and <span class="math inline">\(u&#39;\)</span>, the complete normalize and unnormalize maps are:</p>
<p><span class="math display">\[n(d) = \text{zero} + n&#39;(d) \cdot (\text{one} - \text{zero})\]</span>
<span class="math display">\[u(p) = u&#39; \bigg(\frac{p - \text{zero}}{\text{one} - \text{zero}} \bigg)\]</span></p>
<p>To simplify, here’s what effect setting the two parameters to specific values has:</p>
<table>
<colgroup>
<col width="6%" />
<col width="5%" />
<col width="88%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">Zero</th>
<th align="right">One</th>
<th align="left">Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.05</td>
<td align="right">0.95</td>
<td align="left">Expands the margins by ~5% (actually 5.555…% since 0.05 / 0.9 = 0.0555…)</td>
</tr>
<tr class="even">
<td align="right">0.05</td>
<td align="right">1.05</td>
<td align="left">Shifts the expanse ‘up’ by 5% (e.g. moves x-axis 5% right)</td>
</tr>
<tr class="odd">
<td align="right">-0.50</td>
<td align="right">1.50</td>
<td align="left">Zooms into the middle 50% of the expanse (25 percentile goes to 0 and 75th to one)</td>
</tr>
</tbody>
</table>
</div>
<div id="expanse-interface" class="section level4 hasAnchor" number="3.2.4.2">
<h4><span class="header-section-number">3.2.4.2</span> Expanse Interface<a href="design.html#expanse-interface" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>There are also other behaviours that expanses should support. For instance, we may want to be able to reset the expanse to defaults, retrain when the underlying data changes, and return nicely formatted breaks. How these behaviours are implemented, as well as other types of behavior, may be specific to the underlying data type. Overall, expanse interface may look something like this:</p>
<pre><code>interface Expanse&lt;T&gt; {
  normalize(value: T): number
  unnormalize(value: number): T
  defaultize(): this
  
  setZero(zero: number, default: boolean): this
  setOne(one: number, default: boolean): this
  freezeZero(): this
  freezeOne(): this
  
  move(amount: number): this
  expand(zero: number, one: number): this
  
  retrain(values: T[]): this
  breaks(n?: number): T[]  
}</code></pre>
</div>
<div id="continuous-expanses" class="section level4 hasAnchor" number="3.2.4.3">
<h4><span class="header-section-number">3.2.4.3</span> Continuous Expanses<a href="design.html#continuous-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The continuous expanse has as its underlying set <span class="math inline">\([\min, \max] \subseteq \mathbb{R}\)</span>. To understand how it works, let’s build it step by step.</p>
<p>We start with the basic normalizing function:</p>
<ol style="list-style-type: decimal">
<li><span class="math display">\[n(d) = \frac{d - \min}{\max - \min}\]</span></li>
</ol>
<p>This function takes some data value <span class="math inline">\(d \in [\min, \max]\)</span> and transforms it to <span class="math inline">\([0, 1]\)</span>. Most data visualization systems use a function like this at some step of the scaling processs - see <a href="https://github.com/r-lib/scales/blob/84560bf54e02315477a05384ee67991e9e8fc52c/R/bounds.R#L85"><code>scales::rescale</code></a> and <strong>D3</strong> <a href="https://github.com/d3/d3-scale/blob/d6904a4bde09e16005e0ad8ca3e25b10ce54fa0d/src/continuous.js#L122"><code>normalize</code></a>.</p>
<p>This may work well for typical linear scales. However, we may also want to apply some transformation <span class="math inline">\(f\)</span>, such as square root or log. Then, to ensure that the observed data values still get normalized to <span class="math inline">\([0, 1]\)</span>, we need to apply the transformation to both <span class="math inline">\(d\)</span> and the limits:</p>
<ol start="2" style="list-style-type: decimal">
<li><span class="math display">\[\frac{f(d) - f(\min)}{f(\max) - f(\min)}\]</span></li>
</ol>
<p>Finally, as was discussed in <a href="design.html#expanses">EXPANSES</a>, we want to be able to incorporate the zero and one paramaters, leading to the final normalizing function:</p>
<p><span class="math display">\[n(d) = \text{zero} + \frac{f(d) - f(\min)}{f(\max) - f(\min)} \cdot (\text{zero} - \text{one})\]</span></p>
<p>To obtain the unnormalizing function, we can simply invert the normalizing function:</p>
<p><span class="math display">\[u(p) = f^{-1} \bigg\{ f(\min) + \frac{p - \text{zero}}{\text{one} - \text{zero}} \cdot \big[ f(\max) - f(\min) \big] \bigg\}\]</span></p>
<p>The function transforms <span class="math inline">\(x\)</span> to a percentage value <span class="math inline">\(p \in [0, 1]\)</span>, provided <span class="math inline">\(x\)</span> is within <span class="math inline">\([\min, \max]\)</span>. The value <span class="math inline">\((\max - \min)\)</span> is also sometimes called the <em>range</em> (not to be confused with <strong>D3</strong> <code>range</code>).</p>
<p>We can invert the normalizing function and obtain the unnormalizing function, which is, for some percentage <span class="math inline">\(p \in [0, 1]\)</span>:</p>
<p><span class="math display">\[u(p) = \min + p \cdot (\max - \min)\]</span>
returns a value within the <span class="math inline">\([\min, \max]\)</span> range, corresponding to the proportion of the maximum possible distance (range) from the origin (<span class="math inline">\(\min\)</span>). For example, <span class="math inline">\(u(0.5)\)</span>, returns a value that is located halfway between the limits.</p>
<p>We can implement a simple continuous expanse like so:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb24-1"><a href="design.html#cb24-1" tabindex="-1"></a></span>
<span id="cb24-2"><a href="design.html#cb24-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">identity</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T) {</span>
<span id="cb24-3"><a href="design.html#cb24-3" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb24-4"><a href="design.html#cb24-4" tabindex="-1"></a>}</span>
<span id="cb24-5"><a href="design.html#cb24-5" tabindex="-1"></a></span>
<span id="cb24-6"><a href="design.html#cb24-6" tabindex="-1"></a><span class="kw">function</span> <span class="fu">expanseContinuous</span>(min <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> max <span class="op">=</span> <span class="dv">1</span>) {</span>
<span id="cb24-7"><a href="design.html#cb24-7" tabindex="-1"></a>  <span class="kw">const</span> [zero<span class="op">,</span> one] <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]</span>
<span id="cb24-8"><a href="design.html#cb24-8" tabindex="-1"></a>  <span class="kw">const</span> [trans<span class="op">,</span> inv] <span class="op">=</span> [identity<span class="op">,</span> identity]</span>
<span id="cb24-9"><a href="design.html#cb24-9" tabindex="-1"></a>  </span>
<span id="cb24-10"><a href="design.html#cb24-10" tabindex="-1"></a>  <span class="cf">return</span> { min<span class="op">,</span> max<span class="op">,</span> zero<span class="op">,</span> one<span class="op">,</span> trans<span class="op">,</span> inv<span class="op">,</span></span>
<span id="cb24-11"><a href="design.html#cb24-11" tabindex="-1"></a>    <span class="fu">range</span>() {</span>
<span id="cb24-12"><a href="design.html#cb24-12" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">max</span> <span class="op">-</span> <span class="kw">this</span><span class="op">.</span><span class="at">min</span><span class="op">;</span></span>
<span id="cb24-13"><a href="design.html#cb24-13" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb24-14"><a href="design.html#cb24-14" tabindex="-1"></a>    <span class="fu">transRange</span>() {</span>
<span id="cb24-15"><a href="design.html#cb24-15" tabindex="-1"></a>      <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> trans } <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb24-16"><a href="design.html#cb24-16" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min)<span class="op">;</span></span>
<span id="cb24-17"><a href="design.html#cb24-17" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb24-18"><a href="design.html#cb24-18" tabindex="-1"></a>    <span class="fu">normalize</span>(x<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb24-19"><a href="design.html#cb24-19" tabindex="-1"></a>      <span class="kw">const</span> { min<span class="op">,</span> zero<span class="op">,</span> one<span class="op">,</span> trans } <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb24-20"><a href="design.html#cb24-20" tabindex="-1"></a>      <span class="kw">const</span> normalized <span class="op">=</span> (<span class="fu">trans</span>(x) <span class="op">-</span> <span class="fu">trans</span>(min)) <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="fu">transRange</span>()<span class="op">;</span></span>
<span id="cb24-21"><a href="design.html#cb24-21" tabindex="-1"></a>      <span class="cf">return</span> zero <span class="op">+</span> normalized <span class="op">*</span> (one <span class="op">-</span> zero)<span class="op">;</span></span>
<span id="cb24-22"><a href="design.html#cb24-22" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb24-23"><a href="design.html#cb24-23" tabindex="-1"></a>    <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb24-24"><a href="design.html#cb24-24" tabindex="-1"></a>      <span class="kw">const</span> { min<span class="op">,</span> zero<span class="op">,</span> one<span class="op">,</span> trans<span class="op">,</span> inv } <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb24-25"><a href="design.html#cb24-25" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">inv</span>(<span class="fu">trans</span>(min) <span class="op">+</span> ((p <span class="op">-</span> zero) <span class="op">/</span> (one <span class="op">-</span> zero)) <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="fu">transRange</span>())<span class="op">;</span></span>
<span id="cb24-26"><a href="design.html#cb24-26" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb24-27"><a href="design.html#cb24-27" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb24-28"><a href="design.html#cb24-28" tabindex="-1"></a>}</span>
<span id="cb24-29"><a href="design.html#cb24-29" tabindex="-1"></a></span>
<span id="cb24-30"><a href="design.html#cb24-30" tabindex="-1"></a><span class="kw">const</span> expanse1 <span class="op">=</span> <span class="fu">expanseContinuous</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb24-31"><a href="design.html#cb24-31" tabindex="-1"></a></span>
<span id="cb24-32"><a href="design.html#cb24-32" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(expanse1<span class="op">.</span><span class="fu">normalize</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb24-33"><a href="design.html#cb24-33" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(expanse1<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.5</span>))</span></code></pre></div>
<pre><code>## 0.4444444444444444
## 5.5</code></pre>
<p>The functions <span class="math inline">\(n, u\)</span> have several interesting properties. First off, they are inverses to each other and form an <em>isomorphism</em>, i.e. <span class="math inline">\(u = n^{-1}\)</span> and <span class="math inline">\(n = u^{-1}\)</span> such that <span class="math inline">\(u(n(x)) = x\)</span> and <span class="math inline">\(n(u(p)) = p\)</span>. This also means that each function is a 1-to-1 mapping or <em>bijection</em>. In plain words, this means that we cannot get the same percentage by normalizing two different values and vice versa. As a result, we can keep switching between the normalized and unnormalized representations without losing any information:</p>
<!-- ```{r} -->
<!-- with(expanse, unnormalize(normalize(5))) -->
<!-- with(expanse, normalize(unnormalize(normalize(unnormalize(0.5))))) -->
<!-- ``` -->
<div id="linearity" class="section level5 hasAnchor" number="3.2.4.3.1">
<h5><span class="header-section-number">3.2.4.3.1</span> Linearity<a href="design.html#linearity" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Another important thing to note is that, while these types of normalizing functions are often called “linear” (e.g. <code>scaleLinear()</code> in <strong>D3</strong>), since their graphs form a straight line, they should not be confused with “linear functions”, since they do not satisfy the properties of linear functions, namely:</p>
<ul>
<li>Additivity: <span class="math inline">\(\text{normalize}(x + c) \neq \text{normalize}(x) + \text{normalize}(c)\)</span></li>
<li>Homogeneity of degree 1: <span class="math inline">\(\text{normalize}(c \cdot x) \neq c \cdot \text{normalize(x)}\)</span>.</li>
</ul>
<p>To illustrate, additivity does not hold when <span class="math inline">\(\min \neq 0\)</span> because:</p>
<p><span class="math display">\[\frac{(x + c) - \min}{(\max - \min)}\]</span>
<span class="math display">\[= \frac{x - \min}{\max - \min} + \frac{c}{\max - \min}\]</span>
<span class="math display">\[\neq \frac{x - \min}{\max - min} + \frac{c - \min}{\max - \min}\]</span></p>
<p>The same can be easily shown for the <span class="math inline">\(\text{unnormalize}\)</span> map and for homogeneity.</p>
<p>Technically, this is due to a confusion between the definition of a “linear function” and a “linear polynomial”. The appropriate term to use would actually be “affine transformation.”</p>
<p>Either way, if the minimum is not 0, we cannot expect the following to be equal:</p>
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(3) + normalize(2))) -->
<!-- ``` -->
<p>Or the following to be equal:</p>
<!-- ```{r} -->
<!-- with(expanse, c(normalize(2 * 5), 2 * normalize(5))) -->
<!-- ``` -->
<p>However, if we keep in mind the fact that the normalizing function calculates the proportion of distance from the origin, we can see that the function in fact behaves linearly within the context of its limits.</p>
<p>For example, consider the range <span class="math inline">\([1, 10]\)</span>. The value <span class="math inline">\(5\)</span> is <span class="math inline">\(4\)</span> units away from the lower limit, i.e. <span class="math inline">\(5 - 1 = 4\)</span>, so we can represent it, for example, as the sum of a value that is 3 units away and another that is one unit away, <span class="math inline">\(n(5) = n(4) + n(2)\)</span>:</p>
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(4) + normalize(2))) -->
<!-- ``` -->
<p>Likewise, again because <span class="math inline">\(5\)</span> represents the distance of <span class="math inline">\(4\)</span> units and <span class="math inline">\(3\)</span> of <span class="math inline">\(2\)</span>, we can expect <span class="math inline">\(n(5) = 2 \cdot n(3)\)</span>:</p>
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), 2 * normalize(3))) -->
<!-- ``` -->
</div>
<div id="transformations" class="section level5 hasAnchor" number="3.2.4.3.2">
<h5><span class="header-section-number">3.2.4.3.2</span> Transformations<a href="design.html#transformations" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We can apply transformations to continuous expanses by transforming their limits. The outcome of this is that <span class="math inline">\(\min\)</span> and <span class="math inline">\(\max\)</span> still get mapped to <span class="math inline">\(0\)</span> and <span class="math inline">\(1\)</span> however, the graph of the function is no longer linear. Suppose we have non-linear function <span class="math inline">\(f\)</span>, along with an inverse <span class="math inline">\(f^{-1}\)</span>. Then:</p>
<p><span class="math display">\[n(x) = \frac{f(x) - f(\min)}{f(\max) - f(\min)}\]</span>
<span class="math display">\[u(p) = f^{-1} \bigg\{f(\min) + p \cdot \big[ f(\max) - f(\min) \big] \bigg\}\]</span>
For example, here’s how we could apply the transformation <span class="math inline">\(\bigg( f(x) = \sqrt{x}, \; f^{-1}(x) = x^2 \bigg)\)</span> in code:</p>
<!-- ```{r} -->
<!-- expanse$trans <- sqrt -->
<!-- expanse$inv <- function(x) x^2 -->
<!-- # Need to redefine normalize and unnormalize -->
<!-- expanse$trans_range <- function() with(expanse, trans(max) - trans(min)) -->
<!-- expanse$normalize <- function(x) { -->
<!--   with(expanse, (trans(x) - trans(min)) / trans_range()) -->
<!-- } -->
<!-- expanse$unnormalize <- function(p) { -->
<!--   with(expanse, inv(trans(min) + p * trans_range())) -->
<!-- } -->
<!-- # Normalizing limits still returns c(0, 1) -->
<!-- c(expanse$normalize(c(1, 10))) -->
<!-- # Notice that these return different values from before though -->
<!-- expanse$normalize(5) -->
<!-- expanse$unnormalize(0.5) -->
<!-- x <- seq(1, 10, length = 100) -->
<!-- p <- seq(0, 1, length = 100) -->
<!-- # The graphs are no longer linear -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(x, expanse$normalize(x), type = "l", ylab = "normalize(x)") -->
<!-- plot(p, expanse$unnormalize(p), type = "l", ylab = "unnormalize(p)") -->
<!-- ``` -->
<p>Transformations such as these can be useful in two ways. First, sometimes we may be able to better see trends in the data when the data has been appropriately transformed. This is the case, for example, when plotting data which varies across orders of magnitude. In this case it may be useful to apply <span class="math inline">\(\log\)</span>-transformation. Second, transformations can also be helpful in situations where some graphical attributes are not perceived linearly. For example, when judging differently sized objects, viewers tend judge magnitude based on area rather than side or radius. As such, when drawing objects such as points or squares it can be helpful to apply square root as the inverse transformation. The idea is that, if one point has a data value that is <span class="math inline">\(c\)</span> times bigger than another, it will have <span class="math inline">\(\sqrt{c}\)</span> times bigger radius and <span class="math inline">\(c\)</span> times bigger area. Note that we are talking about the inverse transformation here, i.e. the transformation affecting the unnormalizing function.</p>
<p>One thing to note is that the proportionality of the square-root transformation holds only when <span class="math inline">\(\min = 0\)</span>. Otherwise:</p>
<p><span class="math display">\[\sqrt{(\min)^2 + cp \cdot [(\max)^2 - (\min)^2]}\]</span>
<span class="math display">\[= \sqrt{c} \cdot \sqrt{(\min)^2/c + p \cdot [(\max)^2 - (\min)^2]}\]</span>
<span class="math display">\[\neq \sqrt{c} \cdot \sqrt{(\min)^2 + p \cdot [(\max)^2 - (\min)^2]}\]</span></p>
<p>This is a problem in the existing packages. For example:</p>
<!-- ```{r} -->
<!-- library(scales) -->
<!-- pal <- area_pal(c(1, 5))   -->
<!-- # Comparing cscale to naive implementation -->
<!-- all.equal(cscale(1:5, pal), sqrt((1:5 - 1) / 4) * 4 + 1) -->
<!-- # Should be equal since 3 is twice as far from 1 as 2 is -->
<!-- c(cscale(1:5, pal)[3] / cscale(1:5, pal)[2],  -->
<!--   sqrt(2)) -->
<!-- expanse$min <- 1 -->
<!-- expanse$max <- 5 -->
<!-- cscale(1:5, pal) -->
<!-- expanse$unnormalize(1:5 / 5) -->
<!-- expanse -->
<!-- plot(1:5, expanse$unnormalize(1:5 / 5)) -->
<!-- plot(1:5, cscale(1:5, pal)) -->
<!-- ``` -->
</div>
</div>
</div>
</div>
<div id="section" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> </h2>

</div>
</div>
<h3> References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-acton2014" class="csl-entry">
Acton, Mike. 2014. <span>“Data-Oriented Design and c++.”</span> <em>Luento. CppCon</em>.
</div>
<div id="ref-bostock2011" class="csl-entry">
Bostock, Michael, Vadim Ogievetsky, and Jeffrey Heer. 2011. <span>“D<span class="math inline">\(^3\)</span> Data-Driven Documents.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 17 (12): 2301–9.
</div>
<div id="ref-chambers2014" class="csl-entry">
Chambers, John M. 2014. <span>“Object-Oriented Programming, Functional Programming and r.”</span> <em>Statistical Science</em> 29 (2): 167–80. <a href="https://doi.org/10.1214/13-STS452">https://doi.org/10.1214/13-STS452</a>.
</div>
<div id="ref-codd1970" class="csl-entry">
Codd, Edgar F. 1970. <span>“A Relational Model of Data for Large Shared Data Banks.”</span> <em>Communications of the ACM</em> 13 (6): 377–87.
</div>
<div id="ref-dimara2019" class="csl-entry">
Dimara, Evanthia, and Charles Perin. 2019. <span>“What Is Interaction for Data Visualization?”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 26 (1): 119–29.
</div>
<div id="ref-fabian2018" class="csl-entry">
Fabian, Richard. 2018. <span>“Data-Oriented Design.”</span> <em>Framework</em> 21: 1–7.
</div>
<div id="ref-frame2014" class="csl-entry">
Frame, Scott, and John W Coffey. 2014. <span>“A Comparison of Functional and Imperative Programming Techniques for Mathematical Software Development.”</span> <em>Journal of Systemics, Cybernetics and Informatics</em> 12 (2): 1–10.
</div>
<div id="ref-gray1997" class="csl-entry">
Gray, Jim, Surajit Chaudhuri, Adam Bosworth, Andrew Layman, Don Reichart, Murali Venkatrao, Frank Pellow, and Hamid Pirahesh. 1997. <span>“Data Cube: A Relational Aggregation Operator Generalizing Group-by, Cross-Tab, and Sub-Totals.”</span> <em>Data Mining and Knowledge Discovery</em> 1: 29–53.
</div>
<div id="ref-harkonen2019" class="csl-entry">
Härkönen, Toni. 2019. <span>“Advantages and Implementation of Entity-Component-Systems.”</span>
</div>
<div id="ref-jordan2015" class="csl-entry">
Jordan, Howell, Goetz Botterweck, John Noll, Andrew Butterfield, and Rem Collier. 2015. <span>“A Feature Model of Actor, Agent, Functional, Object, and Procedural Programming Languages.”</span> <em>Science of Computer Programming</em> 98: 120–39.
</div>
<div id="ref-mdn2024d" class="csl-entry">
———. 2024b. <span>“Classes - JavaScript <span><span class="math inline">\(\vert\)</span></span> MDN.”</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes</a>.
</div>
<div id="ref-mdn2024f" class="csl-entry">
———. 2024c. <span>“Symbol - JavaScript <span><span class="math inline">\(\vert\)</span></span> MDN.”</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol</a>.
</div>
<div id="ref-mdn2024e" class="csl-entry">
———. 2024d. <span>“Functions - JavaScript <span><span class="math inline">\(\vert\)</span></span> MDN.”</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions</a>.
</div>
<div id="ref-mdn2024c" class="csl-entry">
———. 2024f. <span>“JavaScript Language Overview - JavaScript <span><span class="math inline">\(\vert\)</span></span> MDN.”</span> <em>MDN Web Docs</em>. <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Language_overview">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Language_overview</a>.
</div>
<div id="ref-moseley2006" class="csl-entry">
Moseley, Ben, and Peter Marks. 2006. <span>“Out of the Tar Pit.”</span> <em>Software Practice Advancement (SPA)</em> 2006.
</div>
<div id="ref-d3-scale2024" class="csl-entry">
Observable. 2024. <span>“D3-Scale <span><span class="math inline">\(\vert\)</span></span> D3 by Observable.”</span> <a href="https://d3js.org/d3-scale">https://d3js.org/d3-scale</a>.
</div>
<div id="ref-rust2024" class="csl-entry">
Rust Foundation. 2024. <span>“Pub - Rust.”</span> <a href="https://doc.rust-lang.org/std/keyword.pub.html">https://doc.rust-lang.org/std/keyword.pub.html</a>.
</div>
<div id="ref-sharvit2022" class="csl-entry">
Sharvit, Yehonathan. 2022. <em>Data-Oriented Programming: Reduce Software Complexity</em>. Simon; Schuster.
</div>
<div id="ref-van2009" class="csl-entry">
Van Roy, Peter et al. 2009. <span>“Programming Paradigms for Dummies: What Every Programmer Should Know.”</span> <em>New Computational Paradigms for Computer Music</em> 104: 616–21.
</div>
<div id="ref-wickham2013" class="csl-entry">
Wickham, Hadley. 2013. <span>“Bin-Summarise-Smooth: A Framework for Visualising Large Data.”</span> <em>Had. Co. Nz, Tech. Rep</em>.
</div>
<div id="ref-wickham2016" class="csl-entry">
———. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-wickham2019" class="csl-entry">
———. 2019. <em>Advanced r</em>. Chapman; Hall/CRC.
</div>
<div id="ref-wickham2023" class="csl-entry">
Wickham, Hadley, Thomas Lin Pedersen, and Dana Seidel. 2023. <em>Scales: Scale Functions for Visualization</em>. <a href="https://CRAN.R-project.org/package=scales">https://CRAN.R-project.org/package=scales</a>.
</div>
<div id="ref-zig2024" class="csl-entry">
Zig Software Foundation. 2024. <span>“Documentation - the Zig Programming Language.”</span> <a href="https://ziglang.org/documentation/master">https://ziglang.org/documentation/master</a>.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>The one exception may be panning barplots and histograms, where the y-axis upper y-axis limit may change but the lower should be fixed at 0, such that panning may shrink or stretch the bars, but not “lift” them up or move them down.<a href="design.html#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="glossary.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
