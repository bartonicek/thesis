<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>6 System description | Fluent Graphics</title>
  <meta name="description" content="6 System description | Fluent Graphics" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="6 System description | Fluent Graphics" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="6 System description | Fluent Graphics" />
  
  
  

<meta name="author" content="Adam Bartonicek" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="high-level-principles.html"/>
<link rel="next" href="applied-examples.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="literature-review.html"><a href="literature-review.html"><i class="fa fa-check"></i><b>2</b> Literature review</a>
<ul>
<li class="chapter" data-level="2.1" data-path="literature-review.html"><a href="literature-review.html#brief-history"><i class="fa fa-check"></i><b>2.1</b> Brief history of interactive data visualization</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="literature-review.html"><a href="literature-review.html#static-data-visualization-from-ancient-times-to-the-space-age"><i class="fa fa-check"></i><b>2.1.1</b> Static data visualization: From ancient times to the space age</a></li>
<li class="chapter" data-level="2.1.2" data-path="literature-review.html"><a href="literature-review.html#early-interactive"><i class="fa fa-check"></i><b>2.1.2</b> Early interactive data visualization: By statisticians for statisticians</a></li>
<li class="chapter" data-level="2.1.3" data-path="literature-review.html"><a href="literature-review.html#interactive-data-visualization-and-the-internet-web-based-interactivity"><i class="fa fa-check"></i><b>2.1.3</b> Interactive data visualization and the internet: Web-based interactivity</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="literature-review.html"><a href="literature-review.html#what-is-interactive-visualization"><i class="fa fa-check"></i><b>2.2</b> What even is interactive data visualization?</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="literature-review.html"><a href="literature-review.html#interactive-vs.-interacting-with"><i class="fa fa-check"></i><b>2.2.1</b> Interactive vs. interacting with</a></li>
<li class="chapter" data-level="2.2.2" data-path="literature-review.html"><a href="literature-review.html#what-is-interactive-enough"><i class="fa fa-check"></i><b>2.2.2</b> What is “interactive enough”?</a></li>
<li class="chapter" data-level="2.2.3" data-path="literature-review.html"><a href="literature-review.html#complexity-of-interactive-features"><i class="fa fa-check"></i><b>2.2.3</b> Complexity of interactive features</a></li>
<li class="chapter" data-level="2.2.4" data-path="literature-review.html"><a href="literature-review.html#working-definition"><i class="fa fa-check"></i><b>2.2.4</b> Working definition</a></li>
<li class="chapter" data-level="2.2.5" data-path="literature-review.html"><a href="literature-review.html#common-features"><i class="fa fa-check"></i><b>2.2.5</b> Common interactive features</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="literature-review.html"><a href="literature-review.html#the-highlighting-problem"><i class="fa fa-check"></i><b>2.3</b> The highlighting problem</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="literature-review.html"><a href="literature-review.html#linked-selection-and-stacking"><i class="fa fa-check"></i><b>2.3.1</b> Linked selection and stacking</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="literature-review.html"><a href="literature-review.html#theory-of-data-visualization-systems"><i class="fa fa-check"></i><b>2.4</b> Theory of data visualization systems</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="literature-review.html"><a href="literature-review.html#scales"><i class="fa fa-check"></i><b>2.4.1</b> Scales</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="goals-and-principles.html"><a href="goals-and-principles.html"><i class="fa fa-check"></i><b>3</b> Goals and Principles</a>
<ul>
<li class="chapter" data-level="3.1" data-path="goals-and-principles.html"><a href="goals-and-principles.html#user-profile"><i class="fa fa-check"></i><b>3.1</b> User profile</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="problem-set.html"><a href="problem-set.html"><i class="fa fa-check"></i><b>4</b> Problem Set</a>
<ul>
<li class="chapter" data-level="4.1" data-path="problem-set.html"><a href="problem-set.html#data-visualization-pipeline"><i class="fa fa-check"></i><b>4.1</b> Data visualization pipeline</a></li>
<li class="chapter" data-level="4.2" data-path="problem-set.html"><a href="problem-set.html#partitioning"><i class="fa fa-check"></i><b>4.2</b> Partitioning</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="problem-set.html"><a href="problem-set.html#showing-the-full-data"><i class="fa fa-check"></i><b>4.2.1</b> Showing the full data</a></li>
<li class="chapter" data-level="4.2.2" data-path="problem-set.html"><a href="problem-set.html#disjointness-and-comparison"><i class="fa fa-check"></i><b>4.2.2</b> Disjointness and comparison</a></li>
<li class="chapter" data-level="4.2.3" data-path="problem-set.html"><a href="problem-set.html#plots-as-partitions"><i class="fa fa-check"></i><b>4.2.3</b> Plots as partitions</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="problem-set.html"><a href="problem-set.html#aggregation"><i class="fa fa-check"></i><b>4.3</b> Aggregation</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="problem-set.html"><a href="problem-set.html#graphics-and-statistics-are-not-independent"><i class="fa fa-check"></i><b>4.3.1</b> Graphics and statistics are not independent</a></li>
<li class="chapter" data-level="4.3.2" data-path="problem-set.html"><a href="problem-set.html#stackable-summaries"><i class="fa fa-check"></i><b>4.3.2</b> Stackable summaries</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="problem-set.html"><a href="problem-set.html#scaling"><i class="fa fa-check"></i><b>4.4</b> Scaling</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="problem-set.html"><a href="problem-set.html#theory-of-scales"><i class="fa fa-check"></i><b>4.4.1</b> Theory of scales</a></li>
<li class="chapter" data-level="4.4.2" data-path="problem-set.html"><a href="problem-set.html#scales-in-practice"><i class="fa fa-check"></i><b>4.4.2</b> Scales in practice</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="high-level-principles.html"><a href="high-level-principles.html"><i class="fa fa-check"></i><b>5</b> High-level principles</a>
<ul>
<li class="chapter" data-level="5.0.1" data-path="high-level-principles.html"><a href="high-level-principles.html#user-profile-1"><i class="fa fa-check"></i><b>5.0.1</b> User profile</a></li>
<li class="chapter" data-level="5.1" data-path="high-level-principles.html"><a href="high-level-principles.html#programming-paradigm"><i class="fa fa-check"></i><b>5.1</b> Programming paradigm</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="high-level-principles.html"><a href="high-level-principles.html#imperative-programming"><i class="fa fa-check"></i><b>5.1.1</b> Imperative programming</a></li>
<li class="chapter" data-level="5.1.2" data-path="high-level-principles.html"><a href="high-level-principles.html#functional-programming"><i class="fa fa-check"></i><b>5.1.2</b> Functional programming</a></li>
<li class="chapter" data-level="5.1.3" data-path="high-level-principles.html"><a href="high-level-principles.html#object-oriented-programming"><i class="fa fa-check"></i><b>5.1.3</b> Object oriented programming</a></li>
<li class="chapter" data-level="5.1.4" data-path="high-level-principles.html"><a href="high-level-principles.html#data-oriented-programming"><i class="fa fa-check"></i><b>5.1.4</b> Data oriented programming</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="high-level-principles.html"><a href="high-level-principles.html#reactivity"><i class="fa fa-check"></i><b>5.2</b> Reactivity</a></li>
<li class="chapter" data-level="5.3" data-path="high-level-principles.html"><a href="high-level-principles.html#data-representation"><i class="fa fa-check"></i><b>5.3</b> Data representation</a></li>
<li class="chapter" data-level="5.4" data-path="high-level-principles.html"><a href="high-level-principles.html#rendering-engine"><i class="fa fa-check"></i><b>5.4</b> Rendering engine</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="system-description.html"><a href="system-description.html"><i class="fa fa-check"></i><b>6</b> System description</a>
<ul>
<li class="chapter" data-level="6.1" data-path="system-description.html"><a href="system-description.html#core-requirements"><i class="fa fa-check"></i><b>6.1</b> Core requirements</a></li>
<li class="chapter" data-level="6.2" data-path="system-description.html"><a href="system-description.html#components"><i class="fa fa-check"></i><b>6.2</b> Components</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="system-description.html"><a href="system-description.html#Indexable"><i class="fa fa-check"></i><b>6.2.1</b> Indexable</a></li>
<li class="chapter" data-level="6.2.2" data-path="system-description.html"><a href="system-description.html#Getter"><i class="fa fa-check"></i><b>6.2.2</b> Getter</a></li>
<li class="chapter" data-level="6.2.3" data-path="system-description.html"><a href="system-description.html#dataframe"><i class="fa fa-check"></i><b>6.2.3</b> Dataframe</a></li>
<li class="chapter" data-level="6.2.4" data-path="system-description.html"><a href="system-description.html#reactive"><i class="fa fa-check"></i><b>6.2.4</b> Reactive</a></li>
<li class="chapter" data-level="6.2.5" data-path="system-description.html"><a href="system-description.html#factors"><i class="fa fa-check"></i><b>6.2.5</b> Factors</a></li>
<li class="chapter" data-level="6.2.6" data-path="system-description.html"><a href="system-description.html#reducers"><i class="fa fa-check"></i><b>6.2.6</b> Reducers</a></li>
<li class="chapter" data-level="6.2.7" data-path="system-description.html"><a href="system-description.html#scales-1"><i class="fa fa-check"></i><b>6.2.7</b> Scales</a></li>
<li class="chapter" data-level="6.2.8" data-path="system-description.html"><a href="system-description.html#expanses"><i class="fa fa-check"></i><b>6.2.8</b> Expanses</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="applied-examples.html"><a href="applied-examples.html"><i class="fa fa-check"></i><b>7</b> Applied examples</a></li>
<li class="chapter" data-level="8" data-path="discussion.html"><a href="discussion.html"><i class="fa fa-check"></i><b>8</b> Discussion</a></li>
<li class="chapter" data-level="9" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>9</b> Glossary</a></li>
<li class="chapter" data-level="10" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>10</b> Appendix</a></li>
<li class="chapter" data-level="11" data-path="mathematical-theory.html"><a href="mathematical-theory.html"><i class="fa fa-check"></i><b>11</b> Mathematical theory</a>
<ul>
<li class="chapter" data-level="11.0.1" data-path="mathematical-theory.html"><a href="mathematical-theory.html#relations"><i class="fa fa-check"></i><b>11.0.1</b> Relations</a></li>
<li class="chapter" data-level="11.0.2" data-path="mathematical-theory.html"><a href="mathematical-theory.html#functions"><i class="fa fa-check"></i><b>11.0.2</b> Functions</a></li>
<li class="chapter" data-level="11.0.3" data-path="mathematical-theory.html"><a href="mathematical-theory.html#partitions"><i class="fa fa-check"></i><b>11.0.3</b> Partitions</a></li>
<li class="chapter" data-level="11.0.4" data-path="mathematical-theory.html"><a href="mathematical-theory.html#preorders"><i class="fa fa-check"></i><b>11.0.4</b> Preorders</a></li>
<li class="chapter" data-level="11.0.5" data-path="mathematical-theory.html"><a href="mathematical-theory.html#monoids"><i class="fa fa-check"></i><b>11.0.5</b> Monoids</a></li>
<li class="chapter" data-level="11.0.6" data-path="mathematical-theory.html"><a href="mathematical-theory.html#groups"><i class="fa fa-check"></i><b>11.0.6</b> Groups</a></li>
<li class="chapter" data-level="11.0.7" data-path="mathematical-theory.html"><a href="mathematical-theory.html#categories"><i class="fa fa-check"></i><b>11.0.7</b> Categories</a></li>
<li class="chapter" data-level="11.0.8" data-path="mathematical-theory.html"><a href="mathematical-theory.html#functors"><i class="fa fa-check"></i><b>11.0.8</b> Functors</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>12</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fluent Graphics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="system-description" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">6</span> System description<a href="system-description.html#system-description" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This section contains a description of the concrete system implementation (<a href="https://github.com/bartonicek/plotscape">plotscape</a> and <a href="https://github.com/bartonicek/plotscaper">plotscaper</a>).</p>
<div id="core-requirements" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> Core requirements<a href="system-description.html#core-requirements" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The system needs to be able to:</p>
<ul>
<li>Split the raw data into a hierarchy of parts</li>
<li>Compute summary statistics on the parts</li>
<li>Further transform these summaries in a way that respects the hierarchy (e.g. stacking, normalizing by parent values)</li>
<li>Translate these summaries into visual attributes such as x- and y-position, width, height, area,…</li>
<li>Render geometric objects based on the visual attributes</li>
<li>Do all of the above reactively, in response to user input</li>
</ul>
</div>
<div id="components" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Components<a href="system-description.html#components" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This section contains a detailed listing of the system’s components.</p>
<div id="Indexable" class="section level3 hasAnchor" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Indexable<a href="system-description.html#Indexable" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As discussed in Section <a href="#row-based-or-column-based"><strong>??</strong></a>, when it comes to representing data, the column-based model offer several advantages over the row-based model. In this model, data is stored in a dictionary of contiguous arrays (as in, for example, a CSV file). Thus, I chose to represent the fundamental unit of data as a column, a fixed-length array of values.</p>
<p>However, at times, it may be useful to have additional flexibility. Specifically, it may be useful to to extend our definition of a “column” to non-array-like things, such as derived values and values repeated across all rows. This is where <code>Indexable&lt;T&gt;</code> comes in.</p>
<p>An <code>Indexable&lt;T&gt;</code> represents a single “column” of data, and is just a union of three basic types:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb23-1"><a href="system-description.html#cb23-1" tabindex="-1"></a>Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> T <span class="op">|</span> T[] <span class="op">|</span> ((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T)</span></code></pre></div>
<p>In plain words, an <code>Indexable&lt;T&gt;</code> is one of three things:</p>
<ul>
<li>A variable of type <code>T</code></li>
<li>An array of <code>T</code>s</li>
<li>A callback that takes an index and returns a <code>T</code>.</li>
</ul>
<p>To extract a value from <code>Indexable&lt;T&gt;</code>, we rely on a generalized form of indexed access. The way how this indexed access works depends on the type of the indexable. First, if the indexable is an array, we subset it using the usual square bracket notation. Second, if the indexable is a non-array-like variable (but not a function), we always return it, regardless of the index (we can think of it as the value as being repeated across all rows). Third and finally, if the indexable is a callback, then we call it with the index and take the returned value. A uniform interface for this generalization of indexed access is provided by <a href="system-description.html#Getter"><code>Getter</code></a>s.</p>
<p>Altogether, this is similar to Leland Wilkinson’s idea of a variable function <span class="citation">(<a href="#ref-wilkinson2012">2012</a>)</span>.</p>
<p>The main advantage of <code>Indexable&lt;T&gt;</code> is that, while the raw data will typically come in the form of arrays, there are many places further down the data visualization pipeline where constants and callbacks are useful. For example, in a typical barplot, the base of the y-axis is set to a constant value, typically zero. While we could hypothetically append an array filled with zeros to the rendering data, it is more convenient and memory efficient to instead use a constant (<code>0</code>), or a thunk (<code>() =&gt; 0</code>). As another example, often, if we have an array of several repeated values, it may be convenient to instead represent it as two arrays: a (short) underlying array of unique values or labels and an array of indices (similar to base R’s <code>factor</code> class). When we need the actual values, we can use a callback to subset the array of labels.</p>
</div>
<div id="Getter" class="section level3 hasAnchor" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Getter<a href="system-description.html#Getter" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A <code>Getter&lt;T&gt;</code> is simply a function which takes an index and returns a value of type <code>T</code>. To construct a <code>Getter&lt;T&gt;</code>, we take an <code>Indexable&lt;T&gt;</code> and dispatch on its underlying type. For illustration, here is a (slightly) simplified implementation:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb24-1"><a href="system-description.html#cb24-1" tabindex="-1"></a><span class="co">// Getter.ts</span></span>
<span id="cb24-2"><a href="system-description.html#cb24-2" tabindex="-1"></a><span class="im">export type</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb24-3"><a href="system-description.html#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="system-description.html#cb24-4" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Getter</span> {</span>
<span id="cb24-5"><a href="system-description.html#cb24-5" tabindex="-1"></a>  <span class="co">// Constructor</span></span>
<span id="cb24-6"><a href="system-description.html#cb24-6" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">of</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb24-7"><a href="system-description.html#cb24-7" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">typeof</span> x <span class="op">===</span> <span class="vs">`function`</span>) <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb24-8"><a href="system-description.html#cb24-8" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(x)) <span class="cf">return</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> x[index]<span class="op">;</span></span>
<span id="cb24-9"><a href="system-description.html#cb24-9" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">return</span> () <span class="kw">=&gt;</span> x</span>
<span id="cb24-10"><a href="system-description.html#cb24-10" tabindex="-1"></a>  }</span>
<span id="cb24-11"><a href="system-description.html#cb24-11" tabindex="-1"></a>}</span></code></pre></div>
<p>we can then create and use <code>Getter</code>s like so:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb25-1"><a href="system-description.html#cb25-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb25-2"><a href="system-description.html#cb25-2" tabindex="-1"></a></span>
<span id="cb25-3"><a href="system-description.html#cb25-3" tabindex="-1"></a><span class="kw">const</span> getter1 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb25-4"><a href="system-description.html#cb25-4" tabindex="-1"></a><span class="kw">const</span> getter2 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>(<span class="dv">99</span>)<span class="op">;</span></span>
<span id="cb25-5"><a href="system-description.html#cb25-5" tabindex="-1"></a><span class="kw">const</span> getter3 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> index <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb25-6"><a href="system-description.html#cb25-6" tabindex="-1"></a></span>
<span id="cb25-7"><a href="system-description.html#cb25-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter1</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb25-8"><a href="system-description.html#cb25-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter2</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb25-9"><a href="system-description.html#cb25-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter3</span>(<span class="dv">0</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 1
## 99
## -1</code></pre>
<p>Note that, by definition, every <code>Getter&lt;T&gt;</code> is also automatically an <code>Indexable&lt;T&gt;</code> (since it is a callback <code>(index: number) =&gt; T</code>). This means that we can create new getters out of other getters.</p>
<p>The <code>Getter</code> namespace also includes several other utility functions. One example is <code>Getter.constant</code> which takes in a value <code>T</code> and returns a thunk which always returns <code>T</code> (i.e. <code>() =&gt; T</code>). This is useful, for example, when <code>T</code> is an array and we always want to return the whole array (not just a single element):</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb27-1"><a href="system-description.html#cb27-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb27-2"><a href="system-description.html#cb27-2" tabindex="-1"></a></span>
<span id="cb27-3"><a href="system-description.html#cb27-3" tabindex="-1"></a><span class="kw">const</span> getter4 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">constant</span>([<span class="vs">`A`</span><span class="op">,</span> <span class="vs">`B`</span><span class="op">,</span> <span class="vs">`C`</span>])</span>
<span id="cb27-4"><a href="system-description.html#cb27-4" tabindex="-1"></a></span>
<span id="cb27-5"><a href="system-description.html#cb27-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter4</span>(<span class="dv">0</span>))</span>
<span id="cb27-6"><a href="system-description.html#cb27-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter4</span>(<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ]
## [ &quot;A&quot;, &quot;B&quot;, &quot;C&quot; ]</code></pre>
<p>Another utility function is <code>Getter.proxy</code>, which takes a <code>Getter</code> and an array of indices, and returns a new <code>Getter</code> which proxies the access to the original values through the array of indices:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb29-1"><a href="system-description.html#cb29-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb29-2"><a href="system-description.html#cb29-2" tabindex="-1"></a></span>
<span id="cb29-3"><a href="system-description.html#cb29-3" tabindex="-1"></a><span class="kw">const</span> proxyGetter <span class="op">=</span> Getter<span class="op">.</span><span class="fu">proxy</span>([<span class="vs">`A`</span><span class="op">,</span> <span class="vs">`B`</span><span class="op">,</span> <span class="vs">`C`</span>]<span class="op">,</span> [<span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb29-4"><a href="system-description.html#cb29-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">.</span><span class="fu">map</span>(proxyGetter))</span></code></pre></div>
<pre><code>## [ &quot;C&quot;, &quot;B&quot;, &quot;B&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A&quot; ]</code></pre>
<p>This function becomes particularly useful when implementing <code>Factor</code>s.</p>
</div>
<div id="dataframe" class="section level3 hasAnchor" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> Dataframe<a href="system-description.html#dataframe" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Another fundamental data structure is a <code>Dataframe</code>. A <code>Dataframe</code> is just a record of <a href="system-description.html#Indexable"><code>Indexable</code></a> values:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb31-1"><a href="system-description.html#cb31-1" tabindex="-1"></a><span class="kw">interface</span> Dataframe {</span>
<span id="cb31-2"><a href="system-description.html#cb31-2" tabindex="-1"></a>  [key<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">symbol</span>]<span class="op">:</span> Indexable</span>
<span id="cb31-3"><a href="system-description.html#cb31-3" tabindex="-1"></a>}</span></code></pre></div>
<p>In this way, a <code>Dataframe</code> is essentially just a <a href="glossary.html#SoA">SoA</a> with a bit of extra flexibility. Specifically, while in typical SoA data structures, all properties are usually arrays, in <code>Dataframe</code> they are instances of the <code>Indexable</code> type, so they may also be constants or functions. For example, the following is a valid instance of a <code>Dataframe</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb32-1"><a href="system-description.html#cb32-1" tabindex="-1"></a><span class="kw">const</span> data<span class="op">:</span> Dataframe <span class="op">=</span> {</span>
<span id="cb32-2"><a href="system-description.html#cb32-2" tabindex="-1"></a>  name<span class="op">:</span> [<span class="vs">`foo`</span><span class="op">,</span> <span class="vs">`bar`</span><span class="op">,</span> <span class="vs">`baz`</span>]<span class="op">,</span></span>
<span id="cb32-3"><a href="system-description.html#cb32-3" tabindex="-1"></a>  age<span class="op">:</span> <span class="dv">99</span><span class="op">,</span></span>
<span id="cb32-4"><a href="system-description.html#cb32-4" tabindex="-1"></a>  canDrive<span class="op">:</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> index <span class="op">&lt;</span> <span class="dv">1</span></span>
<span id="cb32-5"><a href="system-description.html#cb32-5" tabindex="-1"></a>}</span></code></pre></div>
<p>The fact that the “columns” of a <code>Dataframe</code> can be constants and functions is useful, for example, when want every row to contain the same value (e.g. 0 for the base of a barplot), or when we want the value be lazily computed based on other values. This is also where the <a href="glossary.html#SoA">SoA</a> representation offers a unique advantage: to achieve the same behavior in <a href="glossary.html#SoA">AoS</a> layout, we would have to have a copy of the value or function pointer in every row.</p>
<p><code>Dataframe</code> should always contain at least one array and all arrays in a <code>Dataframe</code> should have the same length. This is because some operations are impossible if we do not know the length of the <code>Dataframe</code> (the number of rows). For example, when rendering a scatterplot, how do we decide how many points to draw if the x- and y-positions have length 19 and 20, or if they are both constants? Thus, at least of one the dataframe’s columns needs to have a fixed length (i.e. have an underlying array) and there should not be multiple different lengths.</p>
<p>In the current version of the system, these fixed-length constraints are not enforced via a static check (such as during a constructor call), but are instead checked dynamically during runtime, whenever the integrity of a dataframe’s length becomes a key concern (using utility functions such as <code>Dataframe.checkLength</code>). This is the case, for example, when initializing a <a href="#Scene"><code>Scene</code></a> or when rendering.</p>
<p>I found the dynamic fixed-length checks to be the better option, for several reasons. First, they allow us to represent data as a plain JavaScript object (POJO) rather than having to instantiate a class. Second, due to JavaScript’s dynamic nature, this approach is also safer: if, during runtime, the user adds a property to a <code>Dataframe</code> which violates the fixed-length constraints, this approach will catch the error. Third, and finally, for any data sets with typical dimensionality (more rows than columns, <span class="math inline">\(p &lt;&lt; n\)</span>), the tiny performance hit that may be incurred due to having to loop through the columns to find the length dynamically will be minuscule compared with the computational cost of looping through the data set’s rows and doing work such as rendering or computing statistics. For high-dimensional datasets (<span class="math inline">\(p &gt;&gt; n\)</span>), we could always extend the system to memoize the length/number of rows on the <code>Dataframe</code> object (although then we may lose the security of the dynamic runtime checks).</p>
</div>
<div id="reactive" class="section level3 hasAnchor" number="6.2.4">
<h3><span class="header-section-number">6.2.4</span> Reactive<a href="system-description.html#reactive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>By definition, an interactive data visualization system needs to be able to respond to user input and propagate this information wherever it needs to go. <code>Reactive</code> is a fundamental mixin that provides this utility. It is essentially just custom implementation of the Observer/EventEmitter pattern.</p>
<p>Any object can be made <code>Reactive</code> by passing it into the <code>Reactive</code> constructor, and then calling it with functions from the <code>Reactive</code> namespace. Here is a simplified implementation:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb33-1"><a href="system-description.html#cb33-1" tabindex="-1"></a><span class="co">// Reactive.ts</span></span>
<span id="cb33-2"><a href="system-description.html#cb33-2" tabindex="-1"></a><span class="kw">const</span> LISTENERS <span class="op">=</span> <span class="bu">Symbol</span>(<span class="vs">`listeners`</span>)<span class="op">;</span> <span class="co">// A symbol key to emulate private property</span></span>
<span id="cb33-3"><a href="system-description.html#cb33-3" tabindex="-1"></a><span class="kw">type</span> Callback <span class="op">=</span> (data<span class="op">:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">unknown</span><span class="op">&gt;</span>) <span class="kw">=&gt;</span> <span class="dt">void</span><span class="op">;</span></span>
<span id="cb33-4"><a href="system-description.html#cb33-4" tabindex="-1"></a></span>
<span id="cb33-5"><a href="system-description.html#cb33-5" tabindex="-1"></a><span class="im">export</span> <span class="kw">interface</span> Reactive {</span>
<span id="cb33-6"><a href="system-description.html#cb33-6" tabindex="-1"></a>  [LISTENERS]<span class="op">:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> Callback[]<span class="op">&gt;;</span></span>
<span id="cb33-7"><a href="system-description.html#cb33-7" tabindex="-1"></a>}</span>
<span id="cb33-8"><a href="system-description.html#cb33-8" tabindex="-1"></a></span>
<span id="cb33-9"><a href="system-description.html#cb33-9" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Reactive</span> {</span>
<span id="cb33-10"><a href="system-description.html#cb33-10" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">of</span><span class="op">&lt;</span>T <span class="kw">extends</span> <span class="bu">Object</span><span class="op">&gt;</span>(object<span class="op">:</span> T)<span class="op">:</span> T <span class="op">&amp;</span> Reactive {</span>
<span id="cb33-11"><a href="system-description.html#cb33-11" tabindex="-1"></a>    <span class="cf">return</span> { <span class="op">...</span><span class="kw">object</span><span class="op">,</span> [LISTENERS]<span class="op">:</span> {} }<span class="op">;</span></span>
<span id="cb33-12"><a href="system-description.html#cb33-12" tabindex="-1"></a>  }</span>
<span id="cb33-13"><a href="system-description.html#cb33-13" tabindex="-1"></a></span>
<span id="cb33-14"><a href="system-description.html#cb33-14" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">listen</span>(object<span class="op">:</span> Reactive<span class="op">,</span> event<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> cb<span class="op">:</span> Callback) {</span>
<span id="cb33-15"><a href="system-description.html#cb33-15" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">object</span>[LISTENERS][<span class="bu">event</span>]) <span class="kw">object</span>[LISTENERS][<span class="bu">event</span>] <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb33-16"><a href="system-description.html#cb33-16" tabindex="-1"></a>    <span class="kw">object</span>[LISTENERS][<span class="bu">event</span>]<span class="op">.</span><span class="fu">push</span>(cb)<span class="op">;</span></span>
<span id="cb33-17"><a href="system-description.html#cb33-17" tabindex="-1"></a>  }</span>
<span id="cb33-18"><a href="system-description.html#cb33-18" tabindex="-1"></a></span>
<span id="cb33-19"><a href="system-description.html#cb33-19" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">dispatch</span>(</span>
<span id="cb33-20"><a href="system-description.html#cb33-20" tabindex="-1"></a>    object<span class="op">:</span> Reactive<span class="op">,</span></span>
<span id="cb33-21"><a href="system-description.html#cb33-21" tabindex="-1"></a>    event<span class="op">:</span> <span class="dt">string</span><span class="op">,</span></span>
<span id="cb33-22"><a href="system-description.html#cb33-22" tabindex="-1"></a>    data<span class="op">:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">unknown</span><span class="op">&gt;</span> <span class="op">=</span> {}</span>
<span id="cb33-23"><a href="system-description.html#cb33-23" tabindex="-1"></a>  ) {</span>
<span id="cb33-24"><a href="system-description.html#cb33-24" tabindex="-1"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw">object</span>[LISTENERS][<span class="bu">event</span>]) <span class="cf">return</span><span class="op">;</span></span>
<span id="cb33-25"><a href="system-description.html#cb33-25" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">const</span> cb <span class="kw">of</span> <span class="kw">object</span>[LISTENERS][<span class="bu">event</span>]) <span class="fu">cb</span>(data)<span class="op">;</span></span>
<span id="cb33-26"><a href="system-description.html#cb33-26" tabindex="-1"></a>  }</span>
<span id="cb33-27"><a href="system-description.html#cb33-27" tabindex="-1"></a>}</span></code></pre></div>
<p>We can use <code>Reactive</code> like so:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb34-1"><a href="system-description.html#cb34-1" tabindex="-1"></a><span class="im">import</span> { Reactive } <span class="im">from</span> <span class="st">&quot;./Reactive&quot;</span></span>
<span id="cb34-2"><a href="system-description.html#cb34-2" tabindex="-1"></a></span>
<span id="cb34-3"><a href="system-description.html#cb34-3" tabindex="-1"></a><span class="kw">const</span> dog <span class="op">=</span> Reactive<span class="op">.</span><span class="fu">of</span>({ name<span class="op">:</span> <span class="vs">`Terry the Terrier`</span> })</span>
<span id="cb34-4"><a href="system-description.html#cb34-4" tabindex="-1"></a>Reactive<span class="op">.</span><span class="fu">listen</span>(dog<span class="op">,</span> <span class="vs">`car goes by`</span><span class="op">,</span> () <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Woof`</span>))</span>
<span id="cb34-5"><a href="system-description.html#cb34-5" tabindex="-1"></a>Reactive<span class="op">.</span><span class="fu">dispatch</span>(dog<span class="op">,</span> <span class="vs">`car goes by`</span>)</span></code></pre></div>
<pre><code>## Woof</code></pre>
<p>The actual <code>Reactive</code> implementation includes more features, such as the ability to propagate events, throttle them and set their priority (determining the order in which event callbacks execute), remove listeners, and fire only once multiple events have been dispatched. However, the underlying model is the same.</p>
</div>
<div id="factors" class="section level3 hasAnchor" number="6.2.5">
<h3><span class="header-section-number">6.2.5</span> Factors<a href="system-description.html#factors" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When visualizing data, we often need to split our data into several parts. As was discussed in Introduction [ADD REFERENCE], these parts together forms a <a href="#Partitions">partition</a> of the data, and there may be multiple partitions organized in a hierarchy, such that one or more parts in a child partition “add up” to a part in the parent partition.</p>
<p>A <code>Factor</code> provides a way to represent such data partitions and the associated metadata. In this way, it is similar to base R’s <code>factor</code> S3 class, although there are some important differences which will be discussed below.</p>
<p><code>Factor</code> has the following interface:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb36-1"><a href="system-description.html#cb36-1" tabindex="-1"></a><span class="kw">interface</span> Factor<span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span> <span class="kw">extends</span> Reactive {</span>
<span id="cb36-2"><a href="system-description.html#cb36-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb36-3"><a href="system-description.html#cb36-3" tabindex="-1"></a>  indices<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb36-4"><a href="system-description.html#cb36-4" tabindex="-1"></a>  data<span class="op">:</span> T</span>
<span id="cb36-5"><a href="system-description.html#cb36-5" tabindex="-1"></a>  parent<span class="op">?:</span> Factor<span class="op">;</span></span>
<span id="cb36-6"><a href="system-description.html#cb36-6" tabindex="-1"></a>}</span></code></pre></div>
<p><code>cardinality</code> records the number of unique parts (indices) that form the partition represented by the <code>Factor</code>. For example, if the factor represents boolean partitioning of the data into two parts, the cardinality will be 2, if it represents partitioning into three parts, the cardinality will be 3, if it represents a partitionining into all countries in the world, the cardinality will be 195, and so on.</p>
<p><code>indices</code> represent the actual assignment of cases (rows of the data) to the parts. For example, the array of indices <code>[1, 0, 1, 1, 2]</code> represents the following partitioning: the second case (row) is assigned to the first part, the first, third, and fourth case are assigned to the second part, and the fifth case to the third part (keeping in mind JavaScript’s zero-based indexing). As was mentioned above, the number of unique values in <code>indices</code> has to match the factor’s <code>cardinality</code>, and the length of <code>indices</code> has to match the number of rows of the data set that the factor partitions.</p>
<p>Technically, <code>cardinality</code> represents the same information as is contained in <code>indices</code> (the number of unique values). However, for some operations, it is useful to be able to access cardinality directly, in <span class="math inline">\(O(1)\)</span> time, instead of having to loop through the entire array of indices (<span class="math inline">\(O(n)\)</span> time). Such is the case, for example, when constructing <a href="#Product%20factors">product factors</a> or when initializing arrays of summaries.</p>
<p>A factor may have associated metadata stored in the <code>data</code> property. The <code>data</code> property is a <a href="#Dataframe"><code>Dataframe</code></a> with one row for each part (i.e. the number of rows is equal to <code>cardinality</code>). Representing metadata as a dataframe represents a departure from base R’s <code>factor</code> class, which represents all metadata as a flat vector of <code>levels</code>. For instance:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="system-description.html#cb37-1" tabindex="-1"></a><span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>))</span></code></pre></div>
<pre><code>##  [1] (0,5]  (0,5]  (0,5]  (0,5]  (0,5]  (5,10] (5,10] (5,10] (5,10] (5,10]
## Levels: (0,5] (5,10]</code></pre>
<p>With <code>Factor</code>, the same information would be represented as:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb39-1"><a href="system-description.html#cb39-1" tabindex="-1"></a><span class="kw">const</span> factor<span class="op">:</span> Factor <span class="op">=</span> {</span>
<span id="cb39-2"><a href="system-description.html#cb39-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb39-3"><a href="system-description.html#cb39-3" tabindex="-1"></a>  indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb39-4"><a href="system-description.html#cb39-4" tabindex="-1"></a>  data<span class="op">:</span> {</span>
<span id="cb39-5"><a href="system-description.html#cb39-5" tabindex="-1"></a>    binMin<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">,</span></span>
<span id="cb39-6"><a href="system-description.html#cb39-6" tabindex="-1"></a>    binMax<span class="op">:</span> [<span class="dv">5</span><span class="op">,</span> <span class="dv">10</span>]<span class="op">,</span></span>
<span id="cb39-7"><a href="system-description.html#cb39-7" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb39-8"><a href="system-description.html#cb39-8" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>There are several advantages to storing <code>Factor</code> metadata in a <code>Dataframe</code> as opposed to a flat vector/array. First, when partitioning data, we often want to associate several pieces of metadata with each part. For example, if we cut or bin some numeric variable, like in the example above, we want to store both the lower and upper bound of each part’s bin. We could store both pieces of information as a single element (tuple) in an array/vector, the way that <code>cut</code> does it, however, this works well with only few pieces of metadata: once we start storing longer tuples, it becomes hard to tell what each tuple element represents. We could alleviate the problem by naming the tuple elements, but then we are essentially storing the metadata in an array of dictionaries, i.e. the <a href="glossary.html#SoA">AoS</a> data structure. We can do better by storing the metadata in a table.</p>
<p>Second, if we store metadata in a <code>Dataframe</code>, it is easier to combine it when we take <a href="#Product%20factors">a product of two or more factors</a>. Since taking the product of multiple factors is a fundamental operation in an interactive data visualization system, underpinning operations such as linked brushing, it makes sense to use this representation.</p>
<p>There are multiple types of factors which differ semantic meaning as well as the associated metadata. However, all are represented by the same underlying <code>Factor</code> data type. To construct these <code>Factor</code> subtypes, we use different constructor functions which are all exported by the <code>Factor</code> namespace. These will be discussed in the following subsections.</p>
<div id="bijection-factors" class="section level4 hasAnchor" number="6.2.5.1">
<h4><span class="header-section-number">6.2.5.1</span> Bijection factors<a href="system-description.html#bijection-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><code>Factor.bijection</code> is the first of two trivial factor constructors. It assigns each case its individual part, such that the cardinality of the resulting factor is simply equal to the number of cases in the data. The function signature of <code>Factor.bijection</code> is as follows:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb40-1"><a href="system-description.html#cb40-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bijection</span><span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span>(n<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> data<span class="op">?:</span> T)<span class="op">:</span> Factor<span class="op">&lt;</span>T<span class="op">&gt;</span> </span></code></pre></div>
<p>Notice that, when we create a bijection factor, we need to specify the length of the data <code>n</code> (the number of cases). This is used to create <code>indices</code>. Technically speaking, explicitly specifying <code>n</code> is not necessary: we could implement <code>indices</code> as a callback which takes an index and simply returns it back (an identity function). However, since the factors are primarily used to summarize data, and we need to know how many cases to summarize, we do need to store the length of the data <em>somewhere</em>. I found it easier to simply create a dummy array of <code>indices</code>, rather than defining a separate <code>length</code> property on <code>Factor</code>. There is little computational cost associated with this, since, by definition, the partitioning represented by a bijection factor does not change<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<p><code>Factor.bijection</code> can also have associated metadata. This is just a <code>Dataframe</code> of length <code>n</code>.</p>
<p>On an abstract level, a bijection factor represents a terminal object in the <code>Factor</code> category (a category of partitions with intersections as morphism). If we take the product of a bijection factor and any other factor, the result will always be another bijection.</p>
<p>Typical use case of <code>Factor.bijection</code> is the scatterplot. When constructing a scatterplot, we simply take two arrays of equal length (three, if representing size as well) and draw one point per each element of the arrays. Thus, the partitioning <code>Factor</code> has the same cardinality as the length of the arrays and the arrays represent the factor’s metadata. Another use case is the parallel coordinates plot.</p>
</div>
<div id="constant-factors" class="section level4 hasAnchor" number="6.2.5.2">
<h4><span class="header-section-number">6.2.5.2</span> Constant factors<a href="system-description.html#constant-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Constant factors, created with the <code>Factor.mono</code> constructor, are the second trivial factor subtype. They represent the dual of bijection factors, by assigning all cases of the data to a single part. Thus, the labeling function is a constant function (hence the name). The constructor signature is the same as for <a href="#Bijection%20factors">bijection factors</a>:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb41-1"><a href="system-description.html#cb41-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mono</span><span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span>(n<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> data<span class="op">?:</span> T)<span class="op">:</span> Factor<span class="op">&lt;</span>T<span class="op">&gt;</span> </span></code></pre></div>
<p>The metadata associated with constant factors is, intuitively, a <code>Dataframe</code> of length 1, i.e. a dictionary of arrays with one element.</p>
<p>On an abstract level, <code>Factor.mono</code> represents an initial object in the <code>Factor</code> category. That is, if we take the product of a constant factor and any other factor, the result will simply be the other factor (with the constant factor’s metadata repeated in all of the other factor’s partitions’ metadata).</p>
<p>The use cases for constant factors are a bit more obscure. One example is the spinogram. In a spinogram, the upper x-axis limit represents the cumulative sum (count) of all cases in the data. A convenient way to model this is by a constant factor. Another potential use case for constant factors might be plots with a single geometric object, such as a radar plot<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>.</p>
</div>
<div id="string-factors" class="section level4 hasAnchor" number="6.2.5.3">
<h4><span class="header-section-number">6.2.5.3</span> String factors<a href="system-description.html#string-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When we have array of values which can be coerced to strings (using the <code>.toString()</code> method), we can easily turn this into a factor by treating two values as the same level if their string representations match. This is the basis of string factors constructed by <code>Factor.from</code>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb42-1"><a href="system-description.html#cb42-1" tabindex="-1"></a><span class="kw">type</span> Stringable <span class="op">=</span> { <span class="fu">toString</span>()<span class="op">:</span> <span class="dt">string</span> }<span class="op">;</span></span>
<span id="cb42-2"><a href="system-description.html#cb42-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">from</span>(array<span class="op">:</span> Stringable[])<span class="op">:</span> Factor<span class="op">&lt;</span>{ labels<span class="op">:</span> <span class="dt">string</span>[] }<span class="op">&gt;</span> </span></code></pre></div>
<p>The metadata associated with <code>Factor.from</code> is the array of <code>labels</code>, which are simply all of the unique values produced by applying the <code>toString()</code> method to each element in <code>array</code>.</p>
</div>
<div id="binned-factors" class="section level4 hasAnchor" number="6.2.5.4">
<h4><span class="header-section-number">6.2.5.4</span> Binned factors<a href="system-description.html#binned-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When we have an array of numeric values, we can turn this into a factor by assigning the values to (typically equal-sized) bins, as in a histogram. This is what <code>Factor.bin</code> is for. It has the following constructor signature:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb43-1"><a href="system-description.html#cb43-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bin</span>(</span>
<span id="cb43-2"><a href="system-description.html#cb43-2" tabindex="-1"></a>  array<span class="op">:</span> <span class="dt">number</span>[]<span class="op">,</span></span>
<span id="cb43-3"><a href="system-description.html#cb43-3" tabindex="-1"></a>  options<span class="op">:</span> {</span>
<span id="cb43-4"><a href="system-description.html#cb43-4" tabindex="-1"></a>    breaks<span class="op">?:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb43-5"><a href="system-description.html#cb43-5" tabindex="-1"></a>    nBins<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb43-6"><a href="system-description.html#cb43-6" tabindex="-1"></a>    width<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb43-7"><a href="system-description.html#cb43-7" tabindex="-1"></a>    anchor<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb43-8"><a href="system-description.html#cb43-8" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb43-9"><a href="system-description.html#cb43-9" tabindex="-1"></a>)<span class="op">:</span> Factor<span class="op">&lt;</span>{ binMin<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span> binMax<span class="op">:</span> <span class="dt">number</span>[] }<span class="op">&gt;;</span></span></code></pre></div>
<p>Notice that the constructor comes with a list of options which control how the bins are created. If <code>breaks</code> are provided, the constructor uses those as the bins directly. Otherwise it uses <code>nBins</code>, <code>width</code>, and <code>anchor</code> to determine the breaks, in decreasing order of importance.</p>
<p>The metadata that <code>Factor.bin</code> produces are the limits of each bin (<code>binMin</code> and <code>binMax</code>).</p>
</div>
<div id="product-factors" class="section level4 hasAnchor" number="6.2.5.5">
<h4><span class="header-section-number">6.2.5.5</span> Product factors<a href="system-description.html#product-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A fundamental operation that we need to be able to do with factors is to take their Cartesian product. That is, when we have two factors of same length, each with its corresponding array of indices, we need to be able to take the indices, combine them element-wise, and create a new factor that will have as its cardinality the number of unique pairwise combinations of indices.</p>
<p>For example, take two factors represented by the following data (omitting the <code>data</code> property for conciseness):</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb44-1"><a href="system-description.html#cb44-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>] }<span class="op">;</span></span>
<span id="cb44-2"><a href="system-description.html#cb44-2" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>] }<span class="op">;</span></span></code></pre></div>
<p>If we take their product, we should end up with the following factor:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb45-1"><a href="system-description.html#cb45-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">4</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>] }<span class="op">;</span></span></code></pre></div>
<p>Notice that the cardinality of the resulting factor (<span class="math inline">\(4\)</span>) is greater than that of either of the two constituent factors (<span class="math inline">\(2\)</span>, <span class="math inline">\(3\)</span>) but less than than the combined product of their cardinalities (<span class="math inline">\(2 \cdot 3 = 6\)</span>). This will generally be the case: if the first factor has cardinality <span class="math inline">\(a\)</span> and the second cardinality <span class="math inline">\(b\)</span>, the product of the two factors will have cardinality <span class="math inline">\(c\)</span>, such that:</p>
<ul>
<li><span class="math inline">\(c \geq a\)</span> and <span class="math inline">\(c \geq a\)</span> (equality only if one or both of the factors are constant or there is only one unique element-wise index combination)</li>
<li><span class="math inline">\(c \leq a \cdot b\)</span> (equality only if all element-wise index combinations are unique)</li>
</ul>
<p>That is, the product factor will have will be at least as many parts (but most likely more) as either of its constituent, and at most as many parts as the product of the numbers of the constituents’ parts (but most likely fewer). This is a simple fact based on the logic of <a href="#Partitions">partitions</a>.</p>
<div id="computing-product-indices" class="section level5 hasAnchor" number="6.2.5.5.1">
<h5><span class="header-section-number">6.2.5.5.1</span> Computing product indices<a href="system-description.html#computing-product-indices" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>A subtle challenge is how to actually compute indices of a product factor. One naive idea might be to simply sum the constituent factors’ indices element-wise. However, this approach does not work: the sum of two different pairs of indices may produce the same value. For instance, in a product of two factors with cardinality <span class="math inline">\(4\)</span>, there are three different ways to get indices which sum to <span class="math inline">\(4\)</span>: <span class="math inline">\(1 + 3\)</span>, <span class="math inline">\(3 + 1\)</span>, and <span class="math inline">\(2 + 2\)</span>. Additionally, this approach does not preserve order: intuitively, we would want the cases associated with lower values of the first factor’s indices to come first (have lower index).</p>
<p>The way out of this predicament is to use the following formula <span class="citation">(similar to one discussed in <a href="#ref-wickham2013">Wickham 2013</a>)</span> for computing product indices:</p>
<p><span class="math display">\[i_{\text{product}} = \max(a, b) \cdot i_{\text{factor 1}} + i_{\text{factor 2}}\]</span></p>
<p>We multiply the first factor’s index by the greater of the two factors’ cardinalities and add the index of the second factor. Intuitively then, the first factor gets assigned a greater “weight” (represented by the cardinality), and taking the maximum of the two cardinalities ensures that unique pairs of indices always produce a unique product index (since, e.g. with factors of cardinalities 2 and 3, an index pair <code>(0, 2)</code> will produce a product index <code>2</code> and index pair <code>(1, 0)</code> will produce a product index <code>3</code>).</p>
<p>This method works well but there are two issues with it that need to be addressed. First, computing the indices does not tell us the resulting cardinality. Second, the computed indices are not dense. For example, multiplying computing the product indices using the factors above gets us the following:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb46-1"><a href="system-description.html#cb46-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>] }<span class="op">;</span></span>
<span id="cb46-2"><a href="system-description.html#cb46-2" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>] }<span class="op">;</span></span>
<span id="cb46-3"><a href="system-description.html#cb46-3" tabindex="-1"></a></span>
<span id="cb46-4"><a href="system-description.html#cb46-4" tabindex="-1"></a><span class="co">// Product</span></span>
<span id="cb46-5"><a href="system-description.html#cb46-5" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="op">?,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>] }</span></code></pre></div>
<p>Notice that the cardinality is unknown (<code>?</code>) and there are gaps in the indices (for example, we are missing indices <code>2</code> and <code>3</code>).</p>
<p>The issue of cardinality is unavoidable - we cannot infer the cardinality of the product factor from the cardinalities of the constituent factors alone, because we do not know how many unique combinations of indices there will be. However, what we can do is keep track of how many unique product indices we encounter while computing them (using, for example, an array or a hash set), and then use that number after we have finished looping through the indices.</p>
<p>The issue of the gaps in the indices is a bit more complicated. While looping through the indices, we do not know how many unique index combinations we will encounter. There are several options for dealing with this problem. First, hypothetically, we could implement the downstream parts of our system in such a way that the factor indices would only represent relative position, not absolute. I have actually tried this out but found it rather inconvenient.</p>
<p>Second, in a language with first-class support for pointers, another option would be to store the product indices as pointers to a shorter underlying array of “dirty” indices (with gaps), and only clean up this dirty array of indices (by removing the gaps) once we compute the product factor. Unfortunately, in JavaScript, there is no way to represent pointers to primitive types, such as numbers, strings, or booleans.</p>
<p>The third option, and the one I ended up going with, is to simply loop through the product indices again and clean up the gaps this way. That is, the concrete steps taken in my system are:</p>
<ol style="list-style-type: decimal">
<li>Compute product indices, keeping track of unique ones</li>
<li>Sort the unique product indices</li>
<li>Loop through product indices again, replacing them by position in the unique indices array</li>
</ol>
<p>Steps 1. and 3. require looping through the array of same length as the data, i.e. an <span class="math inline">\(O(n)\)</span> complexity. Step 2. has hypothetically <span class="math inline">\(O(n \cdot \log n)\)</span> complexity (using the usual quicksort algorithm), however, the actual required work is likely to be much less, since, unless either of the two factors is a bijection or all of the product indices are unique (which is unlikely), the length of the array of unique indices will only be a fraction of the length of the data. Thus, the combined complexity of all three steps is likely to be <span class="math inline">\(O(n)\)</span>, with <span class="math inline">\(O(n \cdot \log n)\)</span> worst case performance.</p>
<p>Since the operation of computing product factors represents a “hot” code path (it is required, for example, every time linked selection happens), having to loop through an array of the length of the data twice is not ideal. However, in JavaScript, there is likely no better alternative. While we could hypothetically wrap indices in objects, and store the pointers to those, the memory and data access overhead of this approach would most likely result in performance characteristic many times worse. One of the data types JavaScript engines such as V8 are best optimized to handle are packed arrays of small integers <span class="citation">(called “smi’s,” <a href="#ref-veight2017">V8 Core Team 2017</a>)</span>, and so, heuristically, it makes sense to keep the indices in this format. Additionally, compared to the overhead of other operations (such as rendering), the cost of looping through an array of small integers twice is likely to be miniscule. Personally, this is what I have seen while profiling the system.</p>
</div>
</div>
</div>
<div id="reducers" class="section level3 hasAnchor" number="6.2.6">
<h3><span class="header-section-number">6.2.6</span> Reducers<a href="system-description.html#reducers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="motivation" class="section level4 hasAnchor" number="6.2.6.1">
<h4><span class="header-section-number">6.2.6.1</span> Motivation<a href="system-description.html#motivation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>When we visualize, we draw summary statistics computed on different parts of the data. For example, when drawing a typical barplot, we split the data based on the levels of some categorical variable, count up the number of cases in each part, and then draw bars of corresponding heights.</p>
<p>In the preceding section, I discussed the component used to represent partitioning of the data into parts: <a href="#Factors">factors</a>. Now it is time to discuss the process of actually computing the statistical summaries representing these parts. Interestingly, while all visualizations rely on this process in one way or another, designing a generic pipeline for doing this presents some surprising challenges.</p>
<p>One such important challenge is displaying coherent visualization. This topic has been discussed in the introduction, in Section [ADD REFERENCE]. Briefly, in order to be a valid representation of the data, an interactive data visualization system should compute and render statistics in such a way that the resulting visualization has correct algebraic properties. As was discussed previously, monoids and groups present a framework for ensuring this, and as such should serve as the backbone of our system.</p>
<p>Another challenge is the hierarchical nature of graphics. In interactive data visualization, it is often desirable to be able to convert one specific plot type into a different representation. For example, a typical barplot represents counts along the y-axis. This is useful for comparing absolute counts, however, it is less useful for comparing proportions. As such, some interactive data visualization systems offer the feature of turning a barplot into a spineplot, a normalized version of the plot where the counts are instead presented along the x-axis, in a stacked order, and the y-axis represents proportion of counts, see Figure <a href="system-description.html#fig:barspine">6.1</a>.</p>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:kableExtra&#39;:
## 
##     group_rows</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:barspine"></span>
<img src="_main_files/figure-html/barspine-1.png" alt="While barplot and spineplot represent the same underlying summaries, each makes it easier to see different aspects of our data. Barplot (left) makes it easier to compare absolute counts, whereas spineplot (right) makes it easier to compare proportions. Notice that the spineplot makes it much easier to see that the proportions of blue cases in categories B and C are exactly the same." width="672" />
<p class="caption">
Figure 6.1: While barplot and spineplot represent the same underlying summaries, each makes it easier to see different aspects of our data. Barplot (left) makes it easier to compare absolute counts, whereas spineplot (right) makes it easier to compare proportions. Notice that the spineplot makes it much easier to see that the proportions of blue cases in categories B and C are exactly the same.
</p>
</div>
<p>However, despite the fact that both barplots and spineplots represent the same underlying summaries (counts), turning one into the other is not always a trivial exercise. For example, in <code>ggplot2</code>, it is easy to create a barplot using simple declarative syntax, however, there is no such simple recipe for spineplots - creating the right plot in Figure <a href="system-description.html#fig:barspine">6.1</a> took over 10 lines of external data wrangling code (using standard <code>dplyr</code> syntax).</p>
<p>What is so complicated about spineplots? First of all, both the x- and y-axes represent the same variable: counts. However, the way the variable is used is different:</p>
<ul>
<li>Along the x-axis, we stack counts <em>within the levels of a single factor</em></li>
<li>Along the y-axis, we stack counts <em>within the levels of a product of two factors</em> and normalize them by the counts <em>within the levels of the parent factor</em>.</li>
</ul>
<p>In other words, the spineplot forces us to confront the fact that the summaries in our plots form a hierarchy. When we compute the summaries underlying a stacked barplot or spineplot, we are not merely computing a matrix of values where the rows and the columns have no underlying meaning - instead, we are implicitly saying that objects along the x-axis (whole bars) represent a coarser level of partitioning compared with the objects (stacked segments) along the y-axis. The only difference between a barplot and spineplot is, in the barplot, we can get away with treating the two factors as if they were independent (had the same “weight”), whereas in the spineplot this is no longer possible.</p>
<p>This is why in declarative data visualization systems such as <code>ggplot2</code>, certain types of plots like spineplots are difficult to express. In these systems, the data is implicitly partitioned as a “flat” product of the factor variables. This representation is convenient (e.g. for defining aesthetics via a single call to <code>aes()</code>) but makes it impossible to express hierarchical structures such as the one encoded in spineplot.</p>
<p>Thus, ideally, our system should make it easy specify a pipeline where we compute monoidal summaries of our data within a hierarchy of partitions represented by one or more factor variables, apply some transformations to these summaries (possibly across the levels of the hierarchy), and finally map the summaries to some visual attributes.</p>
</div>
</div>
<div id="scales-1" class="section level3 hasAnchor" number="6.2.7">
<h3><span class="header-section-number">6.2.7</span> Scales<a href="system-description.html#scales-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To visualize data, we need to be able to translate values from the space of the data to the space of the graphical device (computer screen). In most data visualization systems, this is done by specialized components called scales or coordinate systems <span class="citation">(see e.g. <a href="#ref-murrell2005">Murrell 2005</a>; <a href="#ref-wickham2016">Wickham 2016</a>; <a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>. Scales serve as a bridge between what we have (data) and what we see (visual attributes), allowing us to cross from one domain to the other.</p>
<p>There exists is a fair research on the theoretical properties of scales and how they relate to the mechanisms of visual perception <span class="citation">(see e.g. <a href="#ref-krzywinski2013">Krzywinski 2013</a>; <a href="#ref-michell1986">Michell 1986</a>; <a href="#ref-wilkinson2012">Wilkinson 2012</a>; <a href="#ref-stevens1946">Stevens 1946</a>)</span>. However, when it comes to applying this knowledge and implementing scales in concrete data visualization systems, a lot less information is available. And, even when such information is available, it is it is often quite high-level of abstract <span class="citation">(for some rare counter-examples, see e.g. <a href="#ref-murrell2005">Murrell 2005</a>; <a href="#ref-ziemkiewicz2009">Ziemkiewicz and Kosara 2009</a>)</span>. Thus, the following section is based largely on how scales have been implemented in existing data visualization codebases, such as the <code>ggplot2</code> R package <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span> or <code>d3-scale</code> module of D3 <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>; also used by Vega <a href="#ref-satyanarayan2015">Satyanarayan et al. 2015</a>)</span>, as well as on personal insights gained while implementing the package.</p>
<div id="overview" class="section level4 hasAnchor" number="6.2.7.1">
<h4><span class="header-section-number">6.2.7.1</span> Overview<a href="system-description.html#overview" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>From a high-level perspective, a scale is just a function <span class="math inline">\(s: D \to V\)</span> which translates values of the data <span class="math inline">\(d \in D\)</span> to values of some visual attribute <span class="math inline">\(v \in V\)</span>, such as the x- and y-position, length, area, radius, or color <span class="citation">(<a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>. This function may or may not be invertible, such that, at times, each value of the visual attribute may be identified with a unique data value (but this is not always the case).</p>
<p>One of the most common and typical cases is a scale where both <span class="math inline">\(D\)</span> and <span class="math inline">\(V\)</span> are subsets of the real numbers:</p>
<p><span class="math display">\[s: [d_{min}, d_{max}] \to [v_{min}, v_{max}] \qquad d_{min}, d_{max}, v_{min}, v_{max} \in \mathbb{R}\]</span></p>
<p>For example, suppose our data takes values in the range from 1 to 10 and we want to plot it along the x-axis, within a 800 pixels wide plotting region. Then, our scale is simply:</p>
<p><span class="math display">\[s_x: [1, 10] \to [0, 800]\]</span></p>
<p>Now, there is an infinite number of functions that fit this signature. However, one particularly nice and simple candidate is the following function:</p>
<div class="definition">
<p><span id="def:linear-mapping" class="definition"><strong>Definition 6.1  (Simple linear mapping) </strong></span><span class="math display">\[s(d) = v_{max} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
</div>
<p>if we substitute the concrete values into the formula, this becomes:</p>
<p><span class="math display">\[s_x(d) = 0 + \frac{d - 1}{10 - 1} \cdot (800 - 0) = [(d - 1) / 9] \cdot 800\]</span></p>
<p>The function acts on the data in the following way:</p>
<ul>
<li><span class="math inline">\(s_x(1) = (1 - 1) / 9 \cdot 800 = 0\)</span></li>
<li><span class="math inline">\(s_x(10) = (10 - 1) / 9 \cdot 800 = 800\)</span></li>
<li><span class="math inline">\(s_x(d) \in (0, 800)\)</span> for any <span class="math inline">\(d \in (1, 10)\)</span></li>
</ul>
<p>That is, the function maps the data value 1 to pixel 0 (left border of the plotting region), value 10 to to pixel 800 (right border of the plotting region), and any value in between 1 and 10 inside the interval 0 to 800, proportionally to where in the data range it is located.</p>
<p>It is relatively simple to translate the formula in <a href="system-description.html#def:linear-mapping">6.1</a> to code:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb51-1"><a href="system-description.html#cb51-1" tabindex="-1"></a><span class="co">// simpleScale.ts</span></span>
<span id="cb51-2"><a href="system-description.html#cb51-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale</span>(</span>
<span id="cb51-3"><a href="system-description.html#cb51-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb51-4"><a href="system-description.html#cb51-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb51-5"><a href="system-description.html#cb51-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb51-6"><a href="system-description.html#cb51-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb51-7"><a href="system-description.html#cb51-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb51-8"><a href="system-description.html#cb51-8" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb51-9"><a href="system-description.html#cb51-9" tabindex="-1"></a>  <span class="cf">return</span> vmin <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb51-10"><a href="system-description.html#cb51-10" tabindex="-1"></a>}</span></code></pre></div>
<p>And indeed, this function works the way we would expect:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb52-1"><a href="system-description.html#cb52-1" tabindex="-1"></a><span class="im">import</span> { simpleScale } <span class="im">from</span> <span class="st">&quot;./simpleScale.ts&quot;</span></span>
<span id="cb52-2"><a href="system-description.html#cb52-2" tabindex="-1"></a></span>
<span id="cb52-3"><a href="system-description.html#cb52-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb52-4"><a href="system-description.html#cb52-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb52-5"><a href="system-description.html#cb52-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0
## 400
## 800</code></pre>
</div>
<div id="simple-scale-limits" class="section level4 hasAnchor" number="6.2.7.2">
<h4><span class="header-section-number">6.2.7.2</span> Limits of modeling scales as simple functions<a href="system-description.html#simple-scale-limits" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Simple scale functions like the one above can work fine for basic data visualization systems. However, once we begin adding more features, this design becomes prohibitive. Consider, for example, what happens if we want to:</p>
<ul>
<li>Expand the scale limits</li>
<li>Scale discrete data</li>
<li>Apply non-linear transformations</li>
<li>Pan, zoom, reverse, reorder, or otherwise modify the scale interactively</li>
</ul>
<p>Let’s take the first point as a motivating example. Consider what happens to data points at the limits of the data range under the simple linear mapping:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="system-description.html#cb54-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb54-2"><a href="system-description.html#cb54-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb54-3"><a href="system-description.html#cb54-3" tabindex="-1"></a>col <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="st">&quot;indianred&quot;</span>, <span class="st">&quot;grey80&quot;</span>)</span>
<span id="cb54-4"><a href="system-description.html#cb54-4" tabindex="-1"></a></span>
<span id="cb54-5"><a href="system-description.html#cb54-5" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>, <span class="at">xaxs =</span> <span class="st">&quot;i&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-58-1.png" width="800px" style="display: block; margin: auto;" /></p>
<p>The plot above shows values scaled using the simple linear mapping along the x-axis, that is, <span class="math inline">\(s: [1, 10] \to [0, 800]\)</span> (effect of the <code>xaxs = "i"</code> argument). Notice that, since the position of the points representing the values 1 and 10 (highlighted in red) gets mapped to pixel values 0 and 800 (the left and right border of the plot), only half of each point is visible. This is quite undesirable - a fundamental principles of graphical integrity is that our graphics should not arbitrarily downplay or hide certain data points <span class="citation">(<a href="#ref-tufte2001">Tufte 2001</a>)</span>. The points at the axis limits are represented by only 1/2 of the area (or less, if at the limits of both axes), making them less salient, and this is especially pernicious since they are likely to be outliers.</p>
<p>To address this problem, most data visualization systems automatically expand the range of the domain by some pre-specified percentage:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="system-description.html#cb55-1" tabindex="-1"></a><span class="co"># By default, the plot() function automatically expands the x- and y-axis</span></span>
<span id="cb55-2"><a href="system-description.html#cb55-2" tabindex="-1"></a><span class="co"># limits by approximately 4% on each end, see `xaxs` in ?graphics::par</span></span>
<span id="cb55-3"><a href="system-description.html#cb55-3" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-59-1.png" width="800px" style="display: block; margin: auto;" /></p>
<p>We <em>could</em> achieve similar effect by modifying the simple linear mapping we have defined above and adding an additional argument:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb56-1"><a href="system-description.html#cb56-1" tabindex="-1"></a><span class="co">// simpleScale2.ts</span></span>
<span id="cb56-2"><a href="system-description.html#cb56-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale2</span>(</span>
<span id="cb56-3"><a href="system-description.html#cb56-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb56-4"><a href="system-description.html#cb56-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb56-5"><a href="system-description.html#cb56-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb56-6"><a href="system-description.html#cb56-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb56-7"><a href="system-description.html#cb56-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb56-8"><a href="system-description.html#cb56-8" tabindex="-1"></a>  exp<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> <span class="co">// Extra argument</span></span>
<span id="cb56-9"><a href="system-description.html#cb56-9" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb56-10"><a href="system-description.html#cb56-10" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb56-11"><a href="system-description.html#cb56-11" tabindex="-1"></a>    vmin <span class="op">+</span> (exp <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> exp)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)</span>
<span id="cb56-12"><a href="system-description.html#cb56-12" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb56-13"><a href="system-description.html#cb56-13" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, if we set the <code>exp</code> argument to some positive value, the scaled values get mapped closer to the center of the plotting region. For example, setting <code>exp</code> to 0.2 moves each of the data limits 10% closer to the center of the plotting region:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb57-1"><a href="system-description.html#cb57-1" tabindex="-1"></a><span class="im">import</span> { simpleScale2 } <span class="im">from</span> <span class="st">&quot;./simpleScale2.ts&quot;</span></span>
<span id="cb57-2"><a href="system-description.html#cb57-2" tabindex="-1"></a></span>
<span id="cb57-3"><a href="system-description.html#cb57-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span>
<span id="cb57-4"><a href="system-description.html#cb57-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span>
<span id="cb57-5"><a href="system-description.html#cb57-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 80
## 400
## 720</code></pre>
<p>However, notice that this argument is applied symmetrically. At times, we may want to apply a different margin to each end of the scale. We could solve this by adding two arguments instead of one, e.g. <code>expLeft</code> and <code>expRight</code>, however, at this point, the function signature starts to become unwieldy. If we have to call the function in multiple places, it may become difficult to remember what each individual argument represents. Further, note that by adding arguments, the logic inside the function’s body becomes denser and less readable. Finally, we may want to persist or modify some of the arguments during runtime (such as when panning or zooming). For all of these reasons, it may be a good idea to take a more structured approach and break the function down into several smaller components.</p>
</div>
<div id="two-component-scales" class="section level4 hasAnchor" number="6.2.7.3">
<h4><span class="header-section-number">6.2.7.3</span> Solution: Two-component scales<a href="system-description.html#two-component-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The linear mapping formula in <a href="system-description.html#def:linear-mapping">6.1</a> can guide us in decomposing the scale function into smaller, more manageable parts. Let’s look at it again:</p>
<p><span class="math display">\[s(d) = v_{min} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
<p>If we look closely, we may be able to see that there are two parts to the function:</p>
<p><span class="math display">\[s(d) = \color{steelblue}{v_{min} +} \color{indianred}{\frac{\color{black}{d} - d_{min}}{d_{max} - d_{min}}} \color{steelblue}{\cdot (v_{max} - v_{min})}\]</span></p>
<p>That is, the linear mapping is composed of two simpler functions:</p>
<ul>
<li><span class="math inline">\(\color{indianred}{n(d) = (d - d_{min}) / (d_{max} - d_{min})}\)</span> takes a data value <span class="math inline">\(d \in D\)</span> and maps it to the interval <span class="math inline">\([0, 1]\)</span></li>
<li><span class="math inline">\(\color{steelblue}{u(p) = v_{min} + p \cdot (v_{max} - v_{min})}\)</span> takes a value in <span class="math inline">\([0, 1]\)</span> and maps it to a visual attribute value <span class="math inline">\(v \in V\)</span></li>
</ul>
<p>This leads us to the following definition of a scale:</p>
<div class="definition">
<p><span id="def:scale" class="definition"><strong>Definition 6.2  (Scale as composition of two functions) </strong></span>A scale <span class="math inline">\(s\)</span> can be created by composing:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(n: D \to [0, 1]\)</span>, mapping data to the interval <span class="math inline">\([0, 1]\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(u: [0, 1] \to V\)</span>, mapping value in <span class="math inline">\([0, 1]\)</span> to the visual attribute codomain</li>
</ul>
<p>Such that:</p>
<p><span class="math display">\[s(d) = u(n(d))\]</span></p>
</div>
<p>Note that the terms <em>normalize</em> and <em>unnormalize</em> are arbitrary, however, I think they make for useful labels. They represent 1-D equivalent of vector normalization, mapping a value in the domain to and from a unit interval <span class="math inline">\([0, 1]\)</span>.</p>
<p>For the case of the linear mapping, we could rewrite this in code as follows:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb59-1"><a href="system-description.html#cb59-1" tabindex="-1"></a><span class="co">// LinearMap.ts</span></span>
<span id="cb59-2"><a href="system-description.html#cb59-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">LinearMap</span> {</span>
<span id="cb59-3"><a href="system-description.html#cb59-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb59-4"><a href="system-description.html#cb59-4" tabindex="-1"></a>    <span class="cf">return</span> (d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)<span class="op">;</span></span>
<span id="cb59-5"><a href="system-description.html#cb59-5" tabindex="-1"></a>  }</span>
<span id="cb59-6"><a href="system-description.html#cb59-6" tabindex="-1"></a></span>
<span id="cb59-7"><a href="system-description.html#cb59-7" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb59-8"><a href="system-description.html#cb59-8" tabindex="-1"></a>    <span class="cf">return</span> vmin <span class="op">+</span> p <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb59-9"><a href="system-description.html#cb59-9" tabindex="-1"></a>  }</span>
<span id="cb59-10"><a href="system-description.html#cb59-10" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb60-1"><a href="system-description.html#cb60-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb60-2"><a href="system-description.html#cb60-2" tabindex="-1"></a></span>
<span id="cb60-3"><a href="system-description.html#cb60-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>))</span>
<span id="cb60-4"><a href="system-description.html#cb60-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb60-5"><a href="system-description.html#cb60-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0.5
## 400
## 400</code></pre>
<p>This two component system allows for a clean separation of concerns. Specifically, the normalize function only needs to know how to map the data values to <span class="math inline">\([0, 1]\)</span>. It does not need to be aware of where these normalized data values will be mapped to. Conversely, the unnormalize function only needs to understand how to translate values from <span class="math inline">\([0, 1]\)</span> to the space of the visual attribute (such as x-axis position).</p>
<div id="beyond-linear-maps" class="section level5 hasAnchor" number="6.2.7.3.1">
<h5><span class="header-section-number">6.2.7.3.1</span> Beyond linear maps<a href="system-description.html#beyond-linear-maps" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Another big advantage of the two-component scale system is that the functions <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> do not need to be a simple linear maps anymore. For example, suppose that our data <span class="math inline">\(D\)</span> takes form of a set of discrete labels, such as <span class="math inline">\(D = \{ Prague,  Vienna, Munich, Salzburg \}\)</span>. We can then replace <span class="math inline">\(n\)</span> with a surjective function <span class="math inline">\(n: D \to [0, 1]\)</span> such that:</p>
<p><span class="math display">\[n(d) = \begin{cases}  
0.2 &amp; \text{if } d = Munich
\\ 0.4 &amp; \text{if } d = Prague
\\ 0.6 &amp; \text{if } d = Salzburg
\\ 0.8 &amp; \text{if } d = Vienna
\end{cases}\]</span></p>
<p>In other words, <span class="math inline">\(n\)</span> will place values of <span class="math inline">\(D\)</span> at equidistant points along <span class="math inline">\([0, 1]\)</span>, ordered alphabetically. We can implement this function in code as follows:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb62-1"><a href="system-description.html#cb62-1" tabindex="-1"></a><span class="co">// PointMap.ts</span></span>
<span id="cb62-2"><a href="system-description.html#cb62-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">PointMap</span> {</span>
<span id="cb62-3"><a href="system-description.html#cb62-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb62-4"><a href="system-description.html#cb62-4" tabindex="-1"></a>    <span class="cf">return</span> (dlabels<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb62-5"><a href="system-description.html#cb62-5" tabindex="-1"></a>  }</span>
<span id="cb62-6"><a href="system-description.html#cb62-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Since the codomain of <span class="math inline">\(n\)</span> is still <span class="math inline">\([0, 1]\)</span>, we can compose it with a simple linear mapping <span class="math inline">\(u\)</span> just as easily as before:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb63-1"><a href="system-description.html#cb63-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb63-2"><a href="system-description.html#cb63-2" tabindex="-1"></a><span class="im">import</span> { PointMap } <span class="im">from</span> <span class="st">&quot;./PointMap.ts&quot;</span></span>
<span id="cb63-3"><a href="system-description.html#cb63-3" tabindex="-1"></a></span>
<span id="cb63-4"><a href="system-description.html#cb63-4" tabindex="-1"></a><span class="kw">const</span> labels <span class="op">=</span> [<span class="st">&quot;Munich&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Salzburg&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]<span class="op">;</span></span>
<span id="cb63-5"><a href="system-description.html#cb63-5" tabindex="-1"></a></span>
<span id="cb63-6"><a href="system-description.html#cb63-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Munich&quot;</span><span class="op">,</span> labels))<span class="op">;</span></span>
<span id="cb63-7"><a href="system-description.html#cb63-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Munich&quot;</span><span class="op">,</span> labels)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))<span class="op">;</span></span>
<span id="cb63-8"><a href="system-description.html#cb63-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Prague&quot;</span><span class="op">,</span> labels)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 0.2
## 160
## 320</code></pre>
</div>
<div id="inverses" class="section level5 hasAnchor" number="6.2.7.3.2">
<h5><span class="header-section-number">6.2.7.3.2</span> Inverses<a href="system-description.html#inverses" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Additionally, another property of the two-component scale system that can be useful is that, if both <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> are invertible, then so is <span class="math inline">\(s\)</span>. That is, we can easily obtain the inverse scale function by inverting the definition from <a href="system-description.html#def:scale">6.2</a>:</p>
<div class="definition">
<p><span id="def:scale-inverse" class="definition"><strong>Definition 6.3  (Scale inverse) </strong></span>If a scale <span class="math inline">\(s\)</span> is composed of invertible functions <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span>, then <span class="math inline">\(s\)</span> is invertible:</p>
<p><span class="math display">\[s^{-1}(v) = n^{-1}(u^{-1}(v))\]</span></p>
</div>
<p>This is the case for the simple linear map: the normalize and unnormalize functions are actually inverses of each other:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb65-1"><a href="system-description.html#cb65-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb65-2"><a href="system-description.html#cb65-2" tabindex="-1"></a></span>
<span id="cb65-3"><a href="system-description.html#cb65-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="dv">300</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">500</span>))</span></code></pre></div>
<pre><code>## 300</code></pre>
<p>However, the inverse may not always exist. In practice, this is often the case when the domain of the data <span class="math inline">\(D\)</span> is smaller than the codomain <span class="math inline">\([0, 1]\)</span>. Take, for example, the discrete point mapping. Since <span class="math inline">\(D\)</span> is finite but <span class="math inline">\([0, 1]\)</span> has infinitely many values, there will always be some values in <span class="math inline">\([0, 1]\)</span> that no <span class="math inline">\(d \in D\)</span> maps to. For example, if <span class="math inline">\(D = \{ Munich, Prague, Salzburg, Vienna \}\)</span> and <span class="math inline">\(Munich\)</span> maps to 0.2, <span class="math inline">\(Prague\)</span> maps to <span class="math inline">\(0.4\)</span>, and <span class="math inline">\(Salzburg\)</span> maps to <span class="math inline">\(0.8\)</span>, then there are no cities which map to 0.9, 0.444, or 0.123456789. Conversely, if we get given those numeric values, then there is no obvious way to map them back to the cities.</p>
<p>One thing we can do is to replace the inverse/unnormalize function with a weaker form of inverse, called retraction <span class="citation">(<a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>)</span>. Specifically, if we have a normalize function <span class="math inline">\(n: D \to [0, 1]\)</span>, then an unnormalize retraction <span class="math inline">\(u^*\)</span> will have the property that:</p>
<p><span class="math display">\[u^*(n(d)) = d \qquad \forall d \in D\]</span></p>
<p>However, the converse doesn’t necessarily hold:</p>
<p><span class="math display">\[\neg \big[ n(u^*(v)) = v \qquad \forall v \in V \big]\]</span></p>
<p>For example, for the discrete point mapping, a retraction may map a value in <span class="math inline">\([0, 1]\)</span> to the closest data value <span class="math inline">\(d \in D\)</span>:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb67-1"><a href="system-description.html#cb67-1" tabindex="-1"></a><span class="co">// PointMap.ts</span></span>
<span id="cb67-2"><a href="system-description.html#cb67-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">PointMap</span> {</span>
<span id="cb67-3"><a href="system-description.html#cb67-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb67-4"><a href="system-description.html#cb67-4" tabindex="-1"></a>    <span class="cf">return</span> (dlabels<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb67-5"><a href="system-description.html#cb67-5" tabindex="-1"></a>  }</span>
<span id="cb67-6"><a href="system-description.html#cb67-6" tabindex="-1"></a>  </span>
<span id="cb67-7"><a href="system-description.html#cb67-7" tabindex="-1"></a>  <span class="co">// Retraction - find the closest label</span></span>
<span id="cb67-8"><a href="system-description.html#cb67-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb67-9"><a href="system-description.html#cb67-9" tabindex="-1"></a>    <span class="kw">const</span> k <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(p <span class="op">*</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb67-10"><a href="system-description.html#cb67-10" tabindex="-1"></a>    <span class="cf">return</span> dlabels[k]</span>
<span id="cb67-11"><a href="system-description.html#cb67-11" tabindex="-1"></a>  }</span>
<span id="cb67-12"><a href="system-description.html#cb67-12" tabindex="-1"></a>}</span>
<span id="cb67-13"><a href="system-description.html#cb67-13" tabindex="-1"></a></span>
<span id="cb67-14"><a href="system-description.html#cb67-14" tabindex="-1"></a><span class="kw">const</span> labels <span class="op">=</span> [<span class="st">&quot;Munich&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Salzburg&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]<span class="op">;</span></span>
<span id="cb67-15"><a href="system-description.html#cb67-15" tabindex="-1"></a></span>
<span id="cb67-16"><a href="system-description.html#cb67-16" tabindex="-1"></a><span class="kw">const</span> [prague<span class="op">,</span> munich] <span class="op">=</span> [<span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Munich&quot;</span>]<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> PointMap<span class="op">.</span><span class="fu">normalize</span>(x<span class="op">,</span> labels))</span>
<span id="cb67-17"><a href="system-description.html#cb67-17" tabindex="-1"></a><span class="kw">const</span> midpoint <span class="op">=</span> (prague <span class="op">+</span> munich) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb67-18"><a href="system-description.html#cb67-18" tabindex="-1"></a></span>
<span id="cb67-19"><a href="system-description.html#cb67-19" tabindex="-1"></a><span class="co">// Helper function for stripping away floating point error </span></span>
<span id="cb67-20"><a href="system-description.html#cb67-20" tabindex="-1"></a><span class="kw">const</span> strip <span class="op">=</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="pp">parseFloat</span>(x<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">12</span>))</span>
<span id="cb67-21"><a href="system-description.html#cb67-21" tabindex="-1"></a></span>
<span id="cb67-22"><a href="system-description.html#cb67-22" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Midpoint between Munich and Prague: `</span><span class="op">,</span> <span class="fu">strip</span>(midpoint))</span>
<span id="cb67-23"><a href="system-description.html#cb67-23" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`unnormalize(0.2999): `</span><span class="op">,</span> PointMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.2999</span><span class="op">,</span> labels))</span>
<span id="cb67-24"><a href="system-description.html#cb67-24" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`unnormalize(3): `</span><span class="op">,</span> PointMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.3</span><span class="op">,</span> labels))</span></code></pre></div>
<pre><code>## Midpoint between Munich and Prague:  0.3
## unnormalize(0.2999):  Munich
## unnormalize(3):  Prague</code></pre>
<p>While inverses are always unique <span class="citation">(<a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>; <a href="#ref-fong2019">Fong and Spivak 2019</a>)</span>, we may be able to come up with many different retractions for any given function. For example, with the discrete point map above, we could use the floor function instead of rounding and assign label to a value in <span class="math inline">\([0, 1]\)</span> if it is less than the value of the normalized label (but more than the preceding labels).</p>
<p>The non-uniqueness of retractions presents a bit of a dilemma. How do we decide which retraction to use? And, if a certain retractive implementation of <code>unnormalize</code> returns a value, how do we decide if it is the “correct one”?</p>
<p>However, in practice, this is not much of a problem. While developing the package, I found that I’ve only ever had to use the <code>unnormalize</code> function with continuous data (<code>LinearMap</code>), and so the inverse was always well-defined. This is probably also why packages like <code>ggplot2</code> and <code>D3</code> can get by without this functionality. However, I still find it helpful to include the <code>unnormalize</code> function as a first class citizen (instead of it being relegated to some special case), both in terms of the mental model and also for debugging.</p>
</div>
<div id="some-other-remarks-about-the-two-component-scale-system" class="section level5 hasAnchor" number="6.2.7.3.3">
<h5><span class="header-section-number">6.2.7.3.3</span> Some other remarks about the two-component scale system<a href="system-description.html#some-other-remarks-about-the-two-component-scale-system" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>It is worth noting that there is nothing inherently special about the interval <span class="math inline">\([0, 1]\)</span> as the intermediate domain: any finite subset of <span class="math inline">\(\mathbb{R}\)</span> would do. However, the interval <span class="math inline">\([0, 1]\)</span> is convenient, both in terms of interpretation as well as for implementation, as we will see later.</p>
<p>Finally, so far I have discussed scales as <em>functions</em>: the scale function, the normalize function, and unnormalize function. Framing scales as composition of functions leads to a nice correspondence between the mathematical definition and the code. However, in practice, it may be more convenient to implement the domain and codomain as <em>objects</em> or <em>classes</em>, as we will also see in the following section. The important point is that, no matter how the two components are represented, each is responsible for translating values from/to its domain and the interval <span class="math inline">\([0, 1]\)</span>.</p>
</div>
</div>
<div id="past-implementations-of-scales" class="section level4 hasAnchor" number="6.2.7.4">
<h4><span class="header-section-number">6.2.7.4</span> Past implementations of scales<a href="system-description.html#past-implementations-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Two-component scale systems such as the one sketched out above are fairly standard across data visualization libraries. For example, in <code>D3</code> <span class="citation">(<a href="#ref-bostock2011">Michael Bostock, Ogievetsky, and Heer 2011</a>)</span>, scales are implemented in a functional style, such that the data domain and the visual attribute codomain are passed as tuples or arrays of values to a higher-order <code>scale*</code> function (such as <code>scaleLinear</code>, <code>scalePoint</code>, or <code>scaleBand</code>), which then returns a new function that can be used for scaling. The domain and codomain can also be changed at a later point, by using the <code>scale*.domain</code> and <code>scale*.range</code> methods respectively (JavaScript functions are objects and can have other functions/methods attached to them).</p>
<p>For illustration, here is an example from the official documentation <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>)</span>:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb69-1"><a href="system-description.html#cb69-1" tabindex="-1"></a><span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">960</span>])<span class="op">;</span></span>
<span id="cb69-2"><a href="system-description.html#cb69-2" tabindex="-1"></a><span class="fu">x</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// 80</span></span>
<span id="cb69-3"><a href="system-description.html#cb69-3" tabindex="-1"></a><span class="kw">const</span> color <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span> [<span class="st">&quot;brown&quot;</span><span class="op">,</span> <span class="st">&quot;steelblue&quot;</span>])<span class="op">;</span></span>
<span id="cb69-4"><a href="system-description.html#cb69-4" tabindex="-1"></a><span class="fu">color</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// &quot;rgb(154, 52, 57)&quot;</span></span>
<span id="cb69-5"><a href="system-description.html#cb69-5" tabindex="-1"></a><span class="co">// The domain and codomain can be changed after initialization</span></span>
<span id="cb69-6"><a href="system-description.html#cb69-6" tabindex="-1"></a><span class="kw">const</span> y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>])<span class="op">;</span> </span></code></pre></div>
<p>Internally, the <code>scale*</code> functions rely on other specialized functions to translate from its domain to the codomain (such as the <code>normalize()</code> and <code>scale()</code> functions for continuous and discrete/ordinal domains, respectively, and various <code>interpolate()</code> functions for codomains).</p>
<p>Similarly, in <code>ggplot2</code> <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span>, scales are built upon the <code>Scale</code> class, with each subtype implementing <code>limits</code> and <code>palette</code> properties. The <code>limits</code> property is a vector which corresponds to the data domain and the <code>palette</code> property is a function which corresponds roughly to the visual codomain (the x- and y-position behave slightly differently, due to being transformed via coordinate systems). Internally, the package uses the <code>rescale</code> function from the <code>scales</code> package <span class="citation">(<a href="#ref-wickham2023">Wickham, Pedersen, and Seidel 2023</a>)</span> to map data values to <span class="math inline">\([0, 1]\)</span> and then the <code>palette</code> function is responsible for mapping these normalized values to the visual attribute. For illustration, here’s the full definition of the <code>map</code> method on the <code>ScaleContinuous</code> class (I’ve added comments for clarity):</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="system-description.html#cb70-1" tabindex="-1"></a>map <span class="ot">=</span> <span class="cf">function</span>(self, x, <span class="at">limits =</span> self<span class="sc">$</span><span class="fu">get_limits</span>()) {</span>
<span id="cb70-2"><a href="system-description.html#cb70-2" tabindex="-1"></a>  <span class="co"># Limits are just a tuple, rescale maps x to [0, 1]</span></span>
<span id="cb70-3"><a href="system-description.html#cb70-3" tabindex="-1"></a>  x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">rescale</span>(self<span class="sc">$</span><span class="fu">oob</span>(x, <span class="at">range =</span> limits), limits) </span>
<span id="cb70-4"><a href="system-description.html#cb70-4" tabindex="-1"></a></span>
<span id="cb70-5"><a href="system-description.html#cb70-5" tabindex="-1"></a>  uniq <span class="ot">&lt;-</span> <span class="fu">unique0</span>(x)</span>
<span id="cb70-6"><a href="system-description.html#cb70-6" tabindex="-1"></a>  <span class="co"># Palette is a function which returns a vector of attribute values</span></span>
<span id="cb70-7"><a href="system-description.html#cb70-7" tabindex="-1"></a>  pal <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">palette</span>(uniq) </span>
<span id="cb70-8"><a href="system-description.html#cb70-8" tabindex="-1"></a>  scaled <span class="ot">&lt;-</span> pal[<span class="fu">match</span>(x, uniq)]</span>
<span id="cb70-9"><a href="system-description.html#cb70-9" tabindex="-1"></a></span>
<span id="cb70-10"><a href="system-description.html#cb70-10" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(scaled), scaled, self<span class="sc">$</span>na.value)</span>
<span id="cb70-11"><a href="system-description.html#cb70-11" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="proposed-model-of-scales" class="section level4 hasAnchor" number="6.2.7.5">
<h4><span class="header-section-number">6.2.7.5</span> Proposed model of scales<a href="system-description.html#proposed-model-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One feature that the models of scales that <code>D3</code> and <code>ggplot2</code> rely on is that they both treat the data domain and the visual attribute codomain as different types. In <code>D3</code>, fundamentally different functions are used to translate from <span class="math inline">\(D \to [0, 1]\)</span> and from <span class="math inline">\([0, 1] \to V\)</span>, and in <code>ggplot2</code>, <code>limits</code> is a simple vector/tuple whereas <code>palette</code> is a function. While these approaches may have some benefits, such as perhaps offering greater flexibility, they also add additional complexity. Specifically, we have to use two different mental models: one when considering the domain and another when considering the codomain. Further, these models of scales only work in one direction: mapping values <span class="math inline">\(D \to V\)</span>. For going the the other way, i.e. mapping <span class="math inline">\(V \to D\)</span>, other specialized functions have to be used.</p>
<p>I propose a model of scales which implements both the domain and the codomain as components of the same type: <code>Expanse</code>. Fundamentally, this makes it so that the only difference between the data domain and the visual attribute codomain is which property of the scale they are assigned to.</p>
<p>Here is a (slightly) simplified version of the <code>Scale</code> interface:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb71-1"><a href="system-description.html#cb71-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb71-2"><a href="system-description.html#cb71-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb71-3"><a href="system-description.html#cb71-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb71-4"><a href="system-description.html#cb71-4" tabindex="-1"></a>}</span></code></pre></div>
<p><code>D</code> and <code>V</code> represent the data domain and the visual attribute codomain, respectively.</p>
<p>The two fundamental functions connected to <code>Scale</code> are:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb72-1"><a href="system-description.html#cb72-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span></span>
<span id="cb72-2"><a href="system-description.html#cb72-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span></span></code></pre></div>
<p>The <code>pushforward</code> function <em>pushes values forward</em> through the scale, first through its domain and then its codomain, and the <code>pullback</code> function <em>pulls values back</em>, first through its codomain and then through its domain. The <code>ValueOf</code> type helper just identifies the type associated with the expanse’s data (e.g. <code>number</code> for a continuous <code>Expanse</code>, <code>string</code> for a discrete <code>Expanse</code>, etc…). I’ve omitted the generic type parameter constraint (<code>&lt;D extends Expanse, V extends Expanse&gt;</code>) for brevity.</p>
<p>Here is a simplified implementation of the two functions:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb73-1"><a href="system-description.html#cb73-1" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb73-2"><a href="system-description.html#cb73-2" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span> {</span>
<span id="cb73-3"><a href="system-description.html#cb73-3" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb73-4"><a href="system-description.html#cb73-4" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value))<span class="op">;</span></span>
<span id="cb73-5"><a href="system-description.html#cb73-5" tabindex="-1"></a>  }</span>
<span id="cb73-6"><a href="system-description.html#cb73-6" tabindex="-1"></a></span>
<span id="cb73-7"><a href="system-description.html#cb73-7" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span> {</span>
<span id="cb73-8"><a href="system-description.html#cb73-8" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb73-9"><a href="system-description.html#cb73-9" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(domain<span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(codomain<span class="op">,</span> value))</span>
<span id="cb73-10"><a href="system-description.html#cb73-10" tabindex="-1"></a>  }</span>
<span id="cb73-11"><a href="system-description.html#cb73-11" tabindex="-1"></a>}</span></code></pre></div>
<p>We can see that most of the work is done by the two <code>Expanse</code> components: we use <code>domain</code> to translates <span class="math inline">\(D \to [0, 1]\)</span> and codomain to translate <span class="math inline">\([0, 1] \to V\)</span>. <code>Scale</code> only serves as plumbing, connecting the two together.</p>
<p>I argue that this model provides several benefits. First of all, it makes the code easier to reason about. Since both the <code>domain</code> and <code>codomain</code> are of the same type, we only need to keep a single mental model in mind. Second, if <code>domain</code> and <code>codomain</code> provide inverse functions (<code>unnormalize</code>), we get the inverse scale function <span class="math inline">\(V \to D\)</span> for free (this is just the <code>pullback</code> function).</p>
<p>However, before we discuss <code>Expanse</code>, there are also some important functionalities that we may want to implement on <code>Scale</code> directly. There are two main reasons for this. First, we may want these functionalities to apply generally, across the various <code>Expanse</code> subtypes. Second, by implementing them on <code>Scale</code>, we can keep the <code>Expanse</code> interface cleaner. These general functionalities will be the subject of the next few sections.</p>
<div id="zero-and-one" class="section level5 hasAnchor" number="6.2.7.5.1">
<h5><span class="header-section-number">6.2.7.5.1</span> Zero and one<a href="system-description.html#zero-and-one" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Recall how in Section <a href="system-description.html#simple-scale-limits">6.2.7.2</a>, we discussed the problem of expanding axis limits to display margins. Clearly, this is something that we also want to be able to do with our two-component scales. However, since we are designing an interactive data visualization system, we also want to be able to do more with axis limits: we want to be able to manipulate them dynamically during runtime, to implement features such as zooming and panning.</p>
<p>In Section <a href="system-description.html#simple-scale-limits">6.2.7.2</a>, we solved the problem of expanding axis limits by adding an additional argument to the <code>simpleScale</code> function. However, as was discussed previously, this approach does not scale well for more featureful implementations of scales. So how should we go about implementing dynamic axis limits in the context of the two-component scale system?</p>
<p>Suppose we want to add margins to a scale where both the domain or codomain are continuous, such as the x-axis in a typical scatterplot. To implement margins, we could either expand the range of the data (the domain) or shrink the range of the visual attribute (the codomain). However, expanding the domain seems like a bad idea - this only works if the domain is continuous, and, clearly, we may want to add margins to discrete scales too, such the the x-axis of a barplot. Shrinking the range of the codomain could work (most visual attributes are continuous), however, we would need to implement some custom logic for when the plot gets resized. Also, by treating codomain differently than the codomain, we would be breaking away from our intention of representing both with the same generic <code>Expanse</code> type.</p>
<p>So what can we do? As was foreshadowed at end of the previous section, we can put the functionality for expanding axis limits directly onto <code>Scale</code>. Specifically, notice that any values passing through a scale are first converted to the interval <span class="math inline">\([0, 1]\)</span> and then back to the space of either the domain or codomain:</p>
<p><span class="math display">\[D \to [0, 1] \to V\]</span></p>
<p>If we re-normalize these normalized values in <span class="math inline">\([0, 1]\)</span>, we effectively expand or shrink axis limits without having to touch either the domain or codomain. To give a metaphor, if we imagine <code>Scale</code> as a pipe connecting the <code>domain</code> and <code>codomain</code>, we can manipulate axis limits by stretching or squeezing this pipe, allowing more or less water to flow through.</p>
<p>To actually implement this, we can add two additional parameters to <code>Scale</code>, <code>zero</code> and <code>one</code>:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb74-1"><a href="system-description.html#cb74-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb74-2"><a href="system-description.html#cb74-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb74-3"><a href="system-description.html#cb74-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb74-4"><a href="system-description.html#cb74-4" tabindex="-1"></a>  props<span class="op">:</span> { <span class="co">// A dictionary of properties</span></span>
<span id="cb74-5"><a href="system-description.html#cb74-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb74-6"><a href="system-description.html#cb74-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb74-7"><a href="system-description.html#cb74-7" tabindex="-1"></a>  }</span>
<span id="cb74-8"><a href="system-description.html#cb74-8" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we can use these two parameters to implement a new version of the <code>pushforward</code> function:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb75-1"><a href="system-description.html#cb75-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> D)<span class="op">:</span> V {</span>
<span id="cb75-2"><a href="system-description.html#cb75-2" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> props } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb75-3"><a href="system-description.html#cb75-3" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">,</span> one } <span class="op">=</span> props</span>
<span id="cb75-4"><a href="system-description.html#cb75-4" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)</span>
<span id="cb75-5"><a href="system-description.html#cb75-5" tabindex="-1"></a>  normalized <span class="op">=</span> zero <span class="op">+</span> normalized <span class="op">*</span> (one <span class="op">-</span> zero) <span class="co">// Re-normalize</span></span>
<span id="cb75-6"><a href="system-description.html#cb75-6" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)</span>
<span id="cb75-7"><a href="system-description.html#cb75-7" tabindex="-1"></a>}</span></code></pre></div>
<p>The new function’s body is a bit more dense, however, the only real change is in the line with the comment. When we re-normalize, we scale the normalized value by the <code>(zero - one)</code> range and increment it by <code>zero</code>. In other words, <code>zero</code> tells us the proportion of the codomain range that the minimum data value gets mapped to, and <code>one</code> tells us the proportion of the codomain range that the maximum data value gets mapped to.</p>
<p>For example, suppose we set <code>zero</code> to 0.1 and <code>one</code> to 0.9. Then we have effectively implemented 10% margins on either side of the scale. If our scale has a <span class="math inline">\([1, 10]\)</span> domain and <span class="math inline">\([0, 800]\)</span> codomain, this will result in the following mapping:</p>
<ul>
<li>The “minimum” data value (1) gets mapped to 10% of the codomain range (80)
<ul>
<li>Because <code>zero + 0 * (one - zero) = zero = 0.1</code></li>
</ul></li>
<li>The “maximum” data value (10) gets mapped to 90% of the codomain range (720)
<ul>
<li>Because <code>zero + 1 * (one - zero) = one = 0.9</code></li>
</ul></li>
</ul>
<p>Note the quotation marks around the words “minimum” and “maximum” - there is no requirement for the data to be continuous. For example, if the domain is a discrete <code>Expanse</code> which maps the string value <code>"A"</code> to zero, then the <code>pushforward</code> function will map <code>"A"</code> to 10% of the codomain range, just as it did in the case of the continuous domain. Likewise, the codomain could also be discrete - we could use this to implement scales for binned versions of visual attributes such as color or size.</p>
<p>Thus, we can use <code>zero</code> and <code>one</code> to implement margins. However, there is much more we can do with these parameters. First, despite the names, <code>zero</code> and <code>one</code> can both take values <em>less</em> than zero and <em>more</em> than one. For example, suppose we increment both <code>zero</code> and <code>one</code> by the same amount, e.g. we set <code>zero</code> to 0.1 and <code>one</code> to 1.1. Then, the minimum data value will get mapped to the 10% of the codomain range, and the maximum data value will get mapped to 110% of the codomain range (which may lie outside the space representable by the graphic device). If the codomain represents the x-axis position, then we have shifted all of the geometric objects 10% to the right. We have effectively implemented <em>panning</em>:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb76-1"><a href="system-description.html#cb76-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb76-2"><a href="system-description.html#cb76-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">zero</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb76-3"><a href="system-description.html#cb76-3" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">one</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb76-4"><a href="system-description.html#cb76-4" tabindex="-1"></a>}</span></code></pre></div>
<p>That’s it. We have implemented a functionality for panning which will work no matter if <code>domain</code> translates numbers, strings, or some other more complex data types.</p>
<p>We can also stretch or shrink <code>zero</code> and <code>one</code> in opposite directions. For example, by setting <code>zero</code> to -0.5 and <code>one</code> to 1.5, then the minimum and maximum data values will get mapped 50% below and 50% above the limits of the codomain range, respectively, and the 25 and 75 data percentiles will get mapped to the minimum and maximum of the codomain range. If we apply this to the x- or y-axes, we’ve just implemented <em>zooming</em>.</p>
<p>To be perfectly honest, there’s a bit more ceremony involved with zooming. Specifically, if we don’t start from <code>zero = 0</code> and <code>one = 1</code> (e.g. if our plot already has margins or if we’re zooming in multiple levels deep), then we need to re-normalize within these values. This took me a bit of time to nail down, however, it’s just (highschool) algebra:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb77-1"><a href="system-description.html#cb77-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rangeInverse</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb77-2"><a href="system-description.html#cb77-2" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (max <span class="op">-</span> min)<span class="op">;</span></span>
<span id="cb77-3"><a href="system-description.html#cb77-3" tabindex="-1"></a>}</span>
<span id="cb77-4"><a href="system-description.html#cb77-4" tabindex="-1"></a></span>
<span id="cb77-5"><a href="system-description.html#cb77-5" tabindex="-1"></a><span class="kw">function</span> <span class="fu">invertRange</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb77-6"><a href="system-description.html#cb77-6" tabindex="-1"></a>  <span class="kw">const</span> ri <span class="op">=</span> <span class="fu">rangeInverse</span>(min<span class="op">,</span> max)<span class="op">;</span></span>
<span id="cb77-7"><a href="system-description.html#cb77-7" tabindex="-1"></a>  <span class="cf">return</span> [<span class="op">-</span>min <span class="op">*</span> ri<span class="op">,</span> ri <span class="op">-</span> min <span class="op">*</span> ri]<span class="op">;</span></span>
<span id="cb77-8"><a href="system-description.html#cb77-8" tabindex="-1"></a>}</span>
<span id="cb77-9"><a href="system-description.html#cb77-9" tabindex="-1"></a></span>
<span id="cb77-10"><a href="system-description.html#cb77-10" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb77-11"><a href="system-description.html#cb77-11" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">expand</span>(</span>
<span id="cb77-12"><a href="system-description.html#cb77-12" tabindex="-1"></a>    scale<span class="op">:</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span> one<span class="op">:</span> <span class="dt">number</span> } }<span class="op">,</span></span>
<span id="cb77-13"><a href="system-description.html#cb77-13" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb77-14"><a href="system-description.html#cb77-14" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb77-15"><a href="system-description.html#cb77-15" tabindex="-1"></a>  ) {</span>
<span id="cb77-16"><a href="system-description.html#cb77-16" tabindex="-1"></a>    <span class="kw">const</span> { zero<span class="op">:</span> currentZero<span class="op">,</span> one<span class="op">:</span> currentOne } <span class="op">=</span> scale<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb77-17"><a href="system-description.html#cb77-17" tabindex="-1"></a>    <span class="kw">const</span> currentRange <span class="op">=</span> currentOne <span class="op">-</span> currentZero<span class="op">;</span></span>
<span id="cb77-18"><a href="system-description.html#cb77-18" tabindex="-1"></a>    </span>
<span id="cb77-19"><a href="system-description.html#cb77-19" tabindex="-1"></a>    <span class="co">// Re-normalize within current values</span></span>
<span id="cb77-20"><a href="system-description.html#cb77-20" tabindex="-1"></a>    zero <span class="op">=</span> (zero <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb77-21"><a href="system-description.html#cb77-21" tabindex="-1"></a>    one <span class="op">=</span> (one <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb77-22"><a href="system-description.html#cb77-22" tabindex="-1"></a></span>
<span id="cb77-23"><a href="system-description.html#cb77-23" tabindex="-1"></a>    <span class="co">// Invert</span></span>
<span id="cb77-24"><a href="system-description.html#cb77-24" tabindex="-1"></a>    [zero<span class="op">,</span> one] <span class="op">=</span> <span class="fu">invertRange</span>(zero<span class="op">,</span> one)<span class="op">;</span></span>
<span id="cb77-25"><a href="system-description.html#cb77-25" tabindex="-1"></a></span>
<span id="cb77-26"><a href="system-description.html#cb77-26" tabindex="-1"></a>    scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">zero</span> <span class="op">=</span> zero<span class="op">;</span></span>
<span id="cb77-27"><a href="system-description.html#cb77-27" tabindex="-1"></a>    scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">one</span> <span class="op">=</span> one<span class="op">;</span></span>
<span id="cb77-28"><a href="system-description.html#cb77-28" tabindex="-1"></a>  }</span>
<span id="cb77-29"><a href="system-description.html#cb77-29" tabindex="-1"></a>}</span>
<span id="cb77-30"><a href="system-description.html#cb77-30" tabindex="-1"></a></span>
<span id="cb77-31"><a href="system-description.html#cb77-31" tabindex="-1"></a><span class="kw">const</span> scale1 <span class="op">=</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> one<span class="op">:</span> <span class="dv">1</span> } }<span class="op">;</span> <span class="co">// Mock of default scale</span></span>
<span id="cb77-32"><a href="system-description.html#cb77-32" tabindex="-1"></a><span class="kw">const</span> scale2 <span class="op">=</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="fl">0.1</span><span class="op">,</span> one<span class="op">:</span> <span class="fl">0.9</span> } }<span class="op">;</span> <span class="co">// Mock of scale with margins</span></span>
<span id="cb77-33"><a href="system-description.html#cb77-33" tabindex="-1"></a></span>
<span id="cb77-34"><a href="system-description.html#cb77-34" tabindex="-1"></a><span class="co">// Zoom into the middle 50% of either scale</span></span>
<span id="cb77-35"><a href="system-description.html#cb77-35" tabindex="-1"></a>Scale<span class="op">.</span><span class="fu">expand</span>(scale1<span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb77-36"><a href="system-description.html#cb77-36" tabindex="-1"></a>Scale<span class="op">.</span><span class="fu">expand</span>(scale2<span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb77-37"><a href="system-description.html#cb77-37" tabindex="-1"></a></span>
<span id="cb77-38"><a href="system-description.html#cb77-38" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Zoomed in scale with no margins`</span><span class="op">,</span> scale1<span class="op">.</span><span class="at">props</span>)<span class="op">;</span></span>
<span id="cb77-39"><a href="system-description.html#cb77-39" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Zoomed in scale with 10% margins`</span><span class="op">,</span> scale2<span class="op">.</span><span class="at">props</span>)<span class="op">;</span></span></code></pre></div>
<pre><code>## Zoomed in scale with no margins {
##   zero: -0.5,
##   one: 1.5,
## }
## Zoomed in scale with 10% margins {
##   zero: -0.3,
##   one: 1.3,
## }</code></pre>
<p>As you can see, zooming into the middle 50% of a scale that already includes margins has a smaller effect on <code>zero</code> and <code>one</code>, since the margins have effectively expand the space we’re zooming into (i.e., a scale with margins is already <em>zoomed out</em>, in a way).</p>
</div>
<div id="direction" class="section level5 hasAnchor" number="6.2.7.5.2">
<h5><span class="header-section-number">6.2.7.5.2</span> Direction<a href="system-description.html#direction" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In the same way we can think about expanding/shrinking axis limits in a way that is not coupled to any particular data representation or visual attribute, it may also be helpful to make direction a property of <code>Scale</code> rather than either of the <code>Expanse</code> components.</p>
<p>We <em>could</em> do this by manipulating the <code>zero</code> and <code>one</code> properties. For example, by setting <code>zero</code> to 1 and <code>one</code> to 0, we could effectively reverse the direction of the scale. However, in practice, this would complicate our logic and make it harder for someone to interpret the <code>Scale</code> properties. It is a better idea to add an explicit <code>direction</code> parameter instead:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb79-1"><a href="system-description.html#cb79-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb79-2"><a href="system-description.html#cb79-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb79-3"><a href="system-description.html#cb79-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb79-4"><a href="system-description.html#cb79-4" tabindex="-1"></a>  props<span class="op">:</span> {</span>
<span id="cb79-5"><a href="system-description.html#cb79-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb79-6"><a href="system-description.html#cb79-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb79-7"><a href="system-description.html#cb79-7" tabindex="-1"></a>    direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span> <span class="co">// Extra parameter</span></span>
<span id="cb79-8"><a href="system-description.html#cb79-8" tabindex="-1"></a>  }</span>
<span id="cb79-9"><a href="system-description.html#cb79-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Like with <code>zero</code> and <code>one</code>, <code>direction</code> acts on the normalized values in <span class="math inline">\([0, 1]\)</span>. This means that we need to apply it in any transformations that use these values. For example, here’s an updated version of the <code>move</code> function:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb80-1"><a href="system-description.html#cb80-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb80-2"><a href="system-description.html#cb80-2" tabindex="-1"></a>  <span class="kw">let</span> { direction<span class="op">,</span> zero<span class="op">,</span> one } <span class="op">=</span> scale<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb80-3"><a href="system-description.html#cb80-3" tabindex="-1"></a>  zero <span class="op">+=</span> direction <span class="op">*</span> amount<span class="op">;</span></span>
<span id="cb80-4"><a href="system-description.html#cb80-4" tabindex="-1"></a>  one <span class="op">+=</span> direction <span class="op">*</span> amount<span class="op">;</span></span>
<span id="cb80-5"><a href="system-description.html#cb80-5" tabindex="-1"></a>}</span></code></pre></div>
<p>Likewise, the <code>pushforward</code>, <code>pullback</code>, and <code>expand</code> functions also need to take <code>direction</code> into account. Either way, with this functionality in place, it becomes trivial to flip or reverse a scale:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb81-1"><a href="system-description.html#cb81-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">flip</span>(scale<span class="op">:</span> Scale) {</span>
<span id="cb81-2"><a href="system-description.html#cb81-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">direction</span> <span class="op">-=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb81-3"><a href="system-description.html#cb81-3" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="multipliers" class="section level5 hasAnchor" number="6.2.7.5.3">
<h5><span class="header-section-number">6.2.7.5.3</span> Multipliers<a href="system-description.html#multipliers" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Finally, it may also be helpful to have the ability to shrink/expand the normalized values by some constant without having to modify properties of either the <code>domain</code> or <code>codomain</code>. Again, this could be done by using the <code>zero</code> and <code>one</code> properties, however, it’s better to define separate properties instead. Specifically, we can add <em>two</em> additional parameters:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb82-1"><a href="system-description.html#cb82-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb82-2"><a href="system-description.html#cb82-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb82-3"><a href="system-description.html#cb82-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb82-4"><a href="system-description.html#cb82-4" tabindex="-1"></a>  props<span class="op">:</span> {</span>
<span id="cb82-5"><a href="system-description.html#cb82-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb82-6"><a href="system-description.html#cb82-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb82-7"><a href="system-description.html#cb82-7" tabindex="-1"></a>    direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb82-8"><a href="system-description.html#cb82-8" tabindex="-1"></a>    scale<span class="op">:</span> <span class="dt">number</span> <span class="co">// Extra parameter</span></span>
<span id="cb82-9"><a href="system-description.html#cb82-9" tabindex="-1"></a>    mult<span class="op">:</span> <span class="dt">number</span> <span class="co">// And another one</span></span>
<span id="cb82-10"><a href="system-description.html#cb82-10" tabindex="-1"></a>  }</span>
<span id="cb82-11"><a href="system-description.html#cb82-11" tabindex="-1"></a>}</span></code></pre></div>
<p>The reason it is better to have two multiplier parameters instead of just one is that there are different reasons for why we may want to multiply values by a constant. First, we may want to multiply the values by some constant that remains fairly static throughout the lifetime of the program/visualization. That is the job of the <code>scale</code> parameter. Conversely, we may want to also dynamically manipulate the constant by which the values are multiplied. That is what <code>mult</code> is for. Having two multipliers makes it easier to reason about the scale’s behavior, as well as to apply changes such as restoring to defaults.</p>
<p>A good example of this is the barplot. In a typical barplot, all bars share the same width, which is some fraction of the width of the entire plotting region. Clearly, this fraction needs to depend on the number of bars in the plot, such that, with <span class="math inline">\(k\)</span> categories/bars, the bar width will be proportional to <span class="math inline">\(k\)</span>. However, we may also want to be able to make the bars wider/narrower interactively, e.g. by pressing the <code>+\-</code> keys. Thus, the width of the bars is proportional to <span class="math inline">\(c \cdot k\)</span> where <span class="math inline">\(k\)</span> is the static part of the constant (<code>scale</code>) and <span class="math inline">\(c\)</span> is the dynamic part of the constant (<code>mult</code>).</p>
<p>We apply the constant to the normalized value each time we push/pull a value through a scale:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb83-1"><a href="system-description.html#cb83-1" tabindex="-1"></a><span class="co">// This will be included in the body of pushforward(); see below for full example</span></span>
<span id="cb83-2"><a href="system-description.html#cb83-2" tabindex="-1"></a><span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)</span>
<span id="cb83-3"><a href="system-description.html#cb83-3" tabindex="-1"></a>normalized <span class="op">=</span> normalized <span class="op">*</span> scale <span class="op">*</span> mult</span></code></pre></div>
<p>Finally, we could hypothetically extend this idea to an entire array of different multipliers, that we could reduce into a single constant each time we push a value through a scale. This could be useful in some circumstances, however, in my application, I found that having two parameters was enough to solve all of my scaling problems. Additionally, having an array of multipliers might make the scaling functions slightly less performant, if we have to reduce the array each time we <code>pushforward</code>/<code>pullback</code>, or it might make keeping track of the state of the <code>Scale</code> object slightly more complicated, if we roll these multipliers into one constant each time we update the array. We would also lose the semantic distinction that we have with <code>scale</code> and <code>mult</code>. This might be a perfectly fine trade-off if our scales require more multipliers, however, I did not find this to be the case in my implementation.</p>
</div>
<div id="the-full-monty" class="section level5 hasAnchor" number="6.2.7.5.4">
<h5><span class="header-section-number">6.2.7.5.4</span> The Full Monty<a href="system-description.html#the-full-monty" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>With all of the pieces in place, we can put together the full implementation of the <code>pushforward</code> function.</p>
<p>It may be helpful to define two helper function for applying the <code>Scale</code> properties to a normalized value. First, the <code>applyDirection</code> function simply applies the <code>direction</code> property, such that <code>applyDirection(x, 1)</code> is simply the identity whereas <code>applyDirection(x, -1)</code> returns <code>1 - x</code> (i.e. moving from <code>one</code> down):</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb84-1"><a href="system-description.html#cb84-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyDirection</span>(x<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb84-2"><a href="system-description.html#cb84-2" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> direction) <span class="op">+</span> direction <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb84-3"><a href="system-description.html#cb84-3" tabindex="-1"></a>}</span>
<span id="cb84-4"><a href="system-description.html#cb84-4" tabindex="-1"></a></span>
<span id="cb84-5"><a href="system-description.html#cb84-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">0.75</span><span class="op">,</span> <span class="dv">1</span>))</span>
<span id="cb84-6"><a href="system-description.html#cb84-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">0.75</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb84-7"><a href="system-description.html#cb84-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">1.25</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 0.75
## 0.25
## -0.25</code></pre>
<p>Second, we can define the <code>applyPropsForward</code> function which takes a normalized value and applies all of the <code>Scale</code> properties to it:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb86-1"><a href="system-description.html#cb86-1" tabindex="-1"></a><span class="kw">type</span> Props <span class="op">=</span> {</span>
<span id="cb86-2"><a href="system-description.html#cb86-2" tabindex="-1"></a>  zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb86-3"><a href="system-description.html#cb86-3" tabindex="-1"></a>  one<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb86-4"><a href="system-description.html#cb86-4" tabindex="-1"></a>  direction<span class="op">:</span> <span class="op">-</span><span class="dv">1</span> <span class="op">|</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb86-5"><a href="system-description.html#cb86-5" tabindex="-1"></a>  scale<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb86-6"><a href="system-description.html#cb86-6" tabindex="-1"></a>  mult<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb86-7"><a href="system-description.html#cb86-7" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb86-8"><a href="system-description.html#cb86-8" tabindex="-1"></a></span>
<span id="cb86-9"><a href="system-description.html#cb86-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyPropsForward</span>(x<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> props<span class="op">:</span> Props) {</span>
<span id="cb86-10"><a href="system-description.html#cb86-10" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">,</span> one<span class="op">,</span> direction<span class="op">,</span> scale<span class="op">,</span> mult } <span class="op">=</span> props<span class="op">;</span></span>
<span id="cb86-11"><a href="system-description.html#cb86-11" tabindex="-1"></a>  x <span class="op">=</span> x <span class="op">*</span> scale <span class="op">*</span> mult<span class="op">;</span></span>
<span id="cb86-12"><a href="system-description.html#cb86-12" tabindex="-1"></a>  x <span class="op">=</span> zero <span class="op">+</span> x <span class="op">*</span> (one <span class="op">-</span> zero)<span class="op">;</span></span>
<span id="cb86-13"><a href="system-description.html#cb86-13" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">applyDirection</span>(x<span class="op">,</span> direction)<span class="op">;</span></span>
<span id="cb86-14"><a href="system-description.html#cb86-14" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we ready to define the full <code>pushforward</code> function. As one final note, we should probably be able to handle the case where the <code>domain</code> and <code>codomain</code> work on arrays of values rather than scalars (this can be helpful, for example, in the case of a parallel coordinates plot). As such, we can add an <code>if</code> block to check where the normalized value is an array and handle appropriately. In total:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb87-1"><a href="system-description.html#cb87-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>T <span class="kw">extends</span> Expanse<span class="op">,</span> U <span class="kw">extends</span> Expanse<span class="op">&gt;</span>(</span>
<span id="cb87-2"><a href="system-description.html#cb87-2" tabindex="-1"></a>  scale<span class="op">:</span> Scale<span class="op">&lt;</span>T<span class="op">,</span> U<span class="op">&gt;,</span></span>
<span id="cb87-3"><a href="system-description.html#cb87-3" tabindex="-1"></a>  value<span class="op">:</span> Expanse<span class="op">.</span><span class="at">Value</span><span class="op">&lt;</span>T<span class="op">&gt;,</span></span>
<span id="cb87-4"><a href="system-description.html#cb87-4" tabindex="-1"></a>)<span class="op">:</span> Expanse<span class="op">.</span><span class="at">Value</span><span class="op">&lt;</span>U<span class="op">&gt;</span> {</span>
<span id="cb87-5"><a href="system-description.html#cb87-5" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> props } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb87-6"><a href="system-description.html#cb87-6" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb87-7"><a href="system-description.html#cb87-7" tabindex="-1"></a></span>
<span id="cb87-8"><a href="system-description.html#cb87-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(normalized)) {</span>
<span id="cb87-9"><a href="system-description.html#cb87-9" tabindex="-1"></a>    normalized <span class="op">=</span> normalized<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> <span class="fu">applyPropsForward</span>(x<span class="op">,</span> props))<span class="op">;</span></span>
<span id="cb87-10"><a href="system-description.html#cb87-10" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb87-11"><a href="system-description.html#cb87-11" tabindex="-1"></a>    normalized <span class="op">=</span> <span class="fu">applyPropsForward</span>(normalized<span class="op">,</span> props)<span class="op">;</span></span>
<span id="cb87-12"><a href="system-description.html#cb87-12" tabindex="-1"></a>  }</span>
<span id="cb87-13"><a href="system-description.html#cb87-13" tabindex="-1"></a></span>
<span id="cb87-14"><a href="system-description.html#cb87-14" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)<span class="op">;</span></span>
<span id="cb87-15"><a href="system-description.html#cb87-15" tabindex="-1"></a>}</span></code></pre></div>
<p>This is the full definition of the <code>pushforward</code> function in <code>plotscape</code> as of 2024-12-17. The implementation for <code>pullback</code> function is very similar, with the only differences being that the order of the <code>domain</code> and <code>codomain</code> arguments reversed, and it uses the <code>applyPropsBackward</code> function, which is not too difficult to derive.</p>
</div>
</div>
</div>
<div id="expanses" class="section level3 hasAnchor" number="6.2.8">
<h3><span class="header-section-number">6.2.8</span> Expanses<a href="system-description.html#expanses" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>So far, we have discussed scales, and described them as a sort of bridge between two properties of type <code>Expanse</code> - the domain and the codomain. However, we have left the precise nature of the <code>Expanse</code> type vague. Now it is finally time to discuss <code>Expanse</code> and its various subtypes concretely.</p>
<p>As mentioned previously, the job of the <code>Expanse&lt;T&gt;</code> is to translate values of type <code>T</code> (its domain) to and from the interval <span class="math inline">\([0, 1]^n\)</span>. This makes <code>Expanse</code> similar to the maps discussed in Section <a href="system-description.html#two-component-scales">6.2.7.3</a>. The reason why the normalized interval is identified as <span class="math inline">\([0, 1]^n\)</span> instead of the one-dimensional interval <span class="math inline">\([0, 1]\)</span> is because, sometimes, we may want to map multi-dimensional values. For example, in the parallel-coordinates plot, we want to map values of several different variables to the y-axis. Typically, the dimensionality of the normalized values will be the same as that of <code>T</code>, however, we could imagine a situation where it might not be so, for example, we could imagine mapping 3-dimensional vectors to their (normalized) length.</p>
<p>Most of the functionality is implemented by the specific subtypes of <code>Expanse</code>, however, there is also some shared behavior. The simplified interface of <code>Expanse</code> is:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb88-1"><a href="system-description.html#cb88-1" tabindex="-1"></a><span class="kw">interface</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb88-2"><a href="system-description.html#cb88-2" tabindex="-1"></a>  value<span class="op">:</span> T<span class="op">;</span></span>
<span id="cb88-3"><a href="system-description.html#cb88-3" tabindex="-1"></a>  normalized<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[]</span>
<span id="cb88-4"><a href="system-description.html#cb88-4" tabindex="-1"></a>}</span></code></pre></div>
<p>Here, the <code>value</code> and <code>normalized</code> properties are opaque types (used on type-level only), which simply indicate the domain type <code>T</code> and the dimensionality of the normalized values (<code>number | number[]</code>).</p>
<p>Each namespace corresponding to a subtype of <code>Expanse&lt;T&gt;</code> exports two important functions:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(n: T \to [0, 1]^n\)</span>, mapping values from <span class="math inline">\(T\)</span> to <span class="math inline">\([0, 1]^n\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(u: [0, 1]^n \to T\)</span>, mapping values from <span class="math inline">\([0, 1]^n\)</span> to <span class="math inline">\(T\)</span></li>
</ul>
<p>There are two other important methods that each <code>Expanse</code> subtype must export: <code>train</code> and <code>breaks</code>. The <code>train</code> function allows the expanse to train on new data (for example, after a histogram binwidth has been changed). The <code>breaks</code> function simply returns an array of breaks of type <code>T</code>. Thus, each subtype of <code>Expanse</code> implements the following polymorphic methods:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb89-1"><a href="system-description.html#cb89-1" tabindex="-1"></a><span class="kw">interface</span> ExpanseMethods<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb89-2"><a href="system-description.html#cb89-2" tabindex="-1"></a>  <span class="fu">normalize</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> value<span class="op">:</span> T)<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb89-3"><a href="system-description.html#cb89-3" tabindex="-1"></a>  <span class="fu">unnormalize</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> value<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[])<span class="op">:</span> T<span class="op">;</span></span>
<span id="cb89-4"><a href="system-description.html#cb89-4" tabindex="-1"></a>  <span class="fu">train</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> values<span class="op">:</span> T[]<span class="op">,</span> options<span class="op">?:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">any</span><span class="op">&gt;</span>)<span class="op">:</span> <span class="dt">void</span><span class="op">;</span></span>
<span id="cb89-5"><a href="system-description.html#cb89-5" tabindex="-1"></a>  <span class="fu">breaks</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> zero<span class="op">?:</span> <span class="dt">number</span><span class="op">,</span> one<span class="op">?:</span> <span class="dt">number</span>)<span class="op">:</span> T[] <span class="op">|</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb89-6"><a href="system-description.html#cb89-6" tabindex="-1"></a>}</span></code></pre></div>
<div id="continuous-expanses" class="section level4 hasAnchor" number="6.2.8.1">
<h4><span class="header-section-number">6.2.8.1</span> Continuous expanses<a href="system-description.html#continuous-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A continuous expanse is a generalization of the linear mapping discussed in Section <a href="system-description.html#two-component-scales">6.2.7.3</a>. That is, it translates values to and from a continuous interval given (roughly) by <span class="math inline">\([\text{min}, \text{max}]\)</span>. Here is a simplified interface:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb90-1"><a href="system-description.html#cb90-1" tabindex="-1"></a><span class="kw">interface</span> ExpanseContinuous {</span>
<span id="cb90-2"><a href="system-description.html#cb90-2" tabindex="-1"></a>  min<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb90-3"><a href="system-description.html#cb90-3" tabindex="-1"></a>  max<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb90-4"><a href="system-description.html#cb90-4" tabindex="-1"></a>  offset<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb90-5"><a href="system-description.html#cb90-5" tabindex="-1"></a>  trans<span class="op">:</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb90-6"><a href="system-description.html#cb90-6" tabindex="-1"></a>  inv<span class="op">:</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb90-7"><a href="system-description.html#cb90-7" tabindex="-1"></a>  ratio<span class="op">:</span> <span class="dt">boolean</span><span class="op">;</span></span>
<span id="cb90-8"><a href="system-description.html#cb90-8" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>min</code> and <code>max</code> properties are fairly self-explanatory - they denote the minimum and maximum of the data. The <code>offset</code> property allows us to move values by some constant, either before they have been normalized or after they have been unnormalized. This is useful, for example, when we want to ensure that the width of a spineplot bar is exactly 1 pixel less than the available space. The <code>trans</code> and <code>inv</code> properties allow us to perform non-linear transformations (they should, intuitively, be inverses of each other). By default, they are both set to the identity function (<code>(x) =&gt; x</code>). Finally, the <code>ratio</code> property is a simple boolean flag which indicates whether the expanse is part of a ratio scale. If this flag is set to <code>true</code>, then the <code>min</code> value of the expanse must always be zero and we cannot change it by, for example, training on new data.</p>
<p>The normalize and unnormalize functions in the <code>ExpanseContinuous</code> namespace are generalizations of the linear map:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb91-1"><a href="system-description.html#cb91-1" tabindex="-1"></a><span class="co">// ExpanseContinuous.ts</span></span>
<span id="cb91-2"><a href="system-description.html#cb91-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpanseContinuous</span> {</span>
<span id="cb91-3"><a href="system-description.html#cb91-3" tabindex="-1"></a>    <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpanseContinuous<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb91-4"><a href="system-description.html#cb91-4" tabindex="-1"></a>    <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> offset<span class="op">,</span> trans } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb91-5"><a href="system-description.html#cb91-5" tabindex="-1"></a>    <span class="cf">return</span> (<span class="fu">trans</span>(value <span class="op">-</span> offset) <span class="op">-</span> <span class="fu">trans</span>(min)) <span class="op">/</span> (<span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min))<span class="op">;</span></span>
<span id="cb91-6"><a href="system-description.html#cb91-6" tabindex="-1"></a>  }</span>
<span id="cb91-7"><a href="system-description.html#cb91-7" tabindex="-1"></a></span>
<span id="cb91-8"><a href="system-description.html#cb91-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpanseContinuous<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb91-9"><a href="system-description.html#cb91-9" tabindex="-1"></a>    <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> offset<span class="op">,</span> trans<span class="op">,</span> inv } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb91-10"><a href="system-description.html#cb91-10" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">inv</span>(<span class="fu">trans</span>(min) <span class="op">+</span> value <span class="op">*</span> (<span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min))) <span class="op">+</span> offset<span class="op">;</span></span>
<span id="cb91-11"><a href="system-description.html#cb91-11" tabindex="-1"></a>  }</span>
<span id="cb91-12"><a href="system-description.html#cb91-12" tabindex="-1"></a>}</span></code></pre></div>
<p>And these work as we would expect:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb92-1"><a href="system-description.html#cb92-1" tabindex="-1"></a><span class="im">import</span> { ExpanseContinuous } <span class="im">from</span> <span class="st">&quot;./ExpanseContinuous&quot;</span></span>
<span id="cb92-2"><a href="system-description.html#cb92-2" tabindex="-1"></a></span>
<span id="cb92-3"><a href="system-description.html#cb92-3" tabindex="-1"></a><span class="kw">const</span> identity <span class="op">=</span> (x) <span class="kw">=&gt;</span> x<span class="op">;</span></span>
<span id="cb92-4"><a href="system-description.html#cb92-4" tabindex="-1"></a><span class="co">// I could have defined a proper constructor above but opted not to to save lines</span></span>
<span id="cb92-5"><a href="system-description.html#cb92-5" tabindex="-1"></a><span class="kw">const</span> exp <span class="op">=</span> { min<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> max<span class="op">:</span> <span class="dv">16</span><span class="op">,</span> offset<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> trans<span class="op">:</span> identity<span class="op">,</span> inv<span class="op">:</span> identity }<span class="op">;</span></span>
<span id="cb92-6"><a href="system-description.html#cb92-6" tabindex="-1"></a></span>
<span id="cb92-7"><a href="system-description.html#cb92-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(ExpanseContinuous<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> <span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb92-8"><a href="system-description.html#cb92-8" tabindex="-1"></a>exp<span class="op">.</span><span class="at">trans</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span><span class="op">;</span> <span class="co">// Technically, we should also set inverse to square</span></span>
<span id="cb92-9"><a href="system-description.html#cb92-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(ExpanseContinuous<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> <span class="dv">4</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 0.2
## 0.3333333333333333</code></pre>
<p>Finally, the <code>ExpanseContinuous</code> namespace also export a <code>train</code> function, which goes through an array values and updates the min and max properties (max only if <code>ratio</code> is set to <code>true</code>), and a <code>breaks</code> function which returns a list of breaks, using an algorithm inspired by base R’s <code>pretty</code> function.</p>
</div>
<div id="point-expanses" class="section level4 hasAnchor" number="6.2.8.2">
<h4><span class="header-section-number">6.2.8.2</span> Point expanses<a href="system-description.html#point-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A point expanse is the simplest type of discrete expanse. It simply places values at equidistant points along the <span class="math inline">\([0, 1]\)</span> interval, based on an ordered array of labels. Here is a simplified interface:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb94-1"><a href="system-description.html#cb94-1" tabindex="-1"></a><span class="kw">interface</span> ExpansePoint {</span>
<span id="cb94-2"><a href="system-description.html#cb94-2" tabindex="-1"></a>    labels<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb94-3"><a href="system-description.html#cb94-3" tabindex="-1"></a>    order<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb94-4"><a href="system-description.html#cb94-4" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>labels</code> array contains the all of the unique values that data take (strings). The <code>order</code> array is a simple array of indices which represent the order in which the labels get assigned to points in the <span class="math inline">\([0, 1]\)</span> interval.</p>
<p>The normalize and unnormalize functions in the <code>ExpansePoint</code> namespace simply use a label to find the corresponding point in <span class="math inline">\([0, 1]\)</span> or the use a point to find the closest label, while respecting the <code>order</code>:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb95-1"><a href="system-description.html#cb95-1" tabindex="-1"></a><span class="co">// ExpansePoint.ts</span></span>
<span id="cb95-2"><a href="system-description.html#cb95-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpansePoint</span> {</span>
<span id="cb95-3"><a href="system-description.html#cb95-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpansePoint<span class="op">,</span> value<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb95-4"><a href="system-description.html#cb95-4" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb95-5"><a href="system-description.html#cb95-5" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> order[labels<span class="op">.</span><span class="fu">indexOf</span>(value)]<span class="op">;</span></span>
<span id="cb95-6"><a href="system-description.html#cb95-6" tabindex="-1"></a>    <span class="cf">if</span> (index <span class="op">===</span> <span class="op">-</span><span class="dv">1</span>) <span class="cf">return</span> index<span class="op">;</span></span>
<span id="cb95-7"><a href="system-description.html#cb95-7" tabindex="-1"></a>    <span class="cf">return</span> index <span class="op">/</span> (labels<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb95-8"><a href="system-description.html#cb95-8" tabindex="-1"></a>  }</span>
<span id="cb95-9"><a href="system-description.html#cb95-9" tabindex="-1"></a></span>
<span id="cb95-10"><a href="system-description.html#cb95-10" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpansePoint<span class="op">,</span> index<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb95-11"><a href="system-description.html#cb95-11" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb95-12"><a href="system-description.html#cb95-12" tabindex="-1"></a>    index <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(index <span class="op">*</span> (labels<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb95-13"><a href="system-description.html#cb95-13" tabindex="-1"></a>    <span class="cf">return</span> labels[order[index]]<span class="op">;</span></span>
<span id="cb95-14"><a href="system-description.html#cb95-14" tabindex="-1"></a>  }</span>
<span id="cb95-15"><a href="system-description.html#cb95-15" tabindex="-1"></a>}</span></code></pre></div>
<p>Again, these functions work as we would expect:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb96-1"><a href="system-description.html#cb96-1" tabindex="-1"></a><span class="im">import</span> { ExpansePoint } <span class="im">from</span> <span class="st">&quot;./ExpansePoint&quot;</span></span>
<span id="cb96-2"><a href="system-description.html#cb96-2" tabindex="-1"></a></span>
<span id="cb96-3"><a href="system-description.html#cb96-3" tabindex="-1"></a><span class="kw">const</span> cities <span class="op">=</span> [<span class="st">&quot;Berlin&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]</span>
<span id="cb96-4"><a href="system-description.html#cb96-4" tabindex="-1"></a></span>
<span id="cb96-5"><a href="system-description.html#cb96-5" tabindex="-1"></a><span class="kw">const</span> exp <span class="op">=</span> {</span>
<span id="cb96-6"><a href="system-description.html#cb96-6" tabindex="-1"></a>  labels<span class="op">:</span> cities<span class="op">,</span></span>
<span id="cb96-7"><a href="system-description.html#cb96-7" tabindex="-1"></a>  order<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb96-8"><a href="system-description.html#cb96-8" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb96-9"><a href="system-description.html#cb96-9" tabindex="-1"></a></span>
<span id="cb96-10"><a href="system-description.html#cb96-10" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cities<span class="op">.</span><span class="fu">map</span>(city <span class="kw">=&gt;</span> ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> city)))<span class="op">;</span></span>
<span id="cb96-11"><a href="system-description.html#cb96-11" tabindex="-1"></a>exp<span class="op">.</span><span class="at">order</span>[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Swap the order of the first two values</span></span>
<span id="cb96-12"><a href="system-description.html#cb96-12" tabindex="-1"></a>exp<span class="op">.</span><span class="at">order</span>[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb96-13"><a href="system-description.html#cb96-13" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cities<span class="op">.</span><span class="fu">map</span>(city <span class="kw">=&gt;</span> ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> city)))<span class="op">;</span></span></code></pre></div>
<pre><code>## [ 0, 0.5, 1 ]
## [ 0.5, 0, 1 ]</code></pre>
<p>Like <code>ExpanseContinuous</code>, the <code>ExpansePoint</code> namespace also contains a <code>train</code> function, which loops through an array of labels and finds all of the unique values, as well as a <code>breaks</code> function, which simply returns ordered <code>labels</code>. Further, the namespace also contains a <code>reorder</code> function which mutates the <code>order</code> property based on an array of indices.</p>
</div>
<div id="band-expanses" class="section level4 hasAnchor" number="6.2.8.3">
<h4><span class="header-section-number">6.2.8.3</span> Band expanses<a href="system-description.html#band-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>While <code>ExpansePoint</code> places values at equidistant points along <span class="math inline">\([0, 1]\)</span>, <code>ExpanseBand</code> places values at the midpoints of corresponding bins or bands. These bands can have variable widths, which is useful, for example, when specifying the x-axis position in a barplot. The simplified interface of <code>ExpanseBand</code> is the following:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb98-1"><a href="system-description.html#cb98-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">interface</span> ExpanseBand {</span>
<span id="cb98-2"><a href="system-description.html#cb98-2" tabindex="-1"></a>  labels<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb98-3"><a href="system-description.html#cb98-3" tabindex="-1"></a>  order<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb98-4"><a href="system-description.html#cb98-4" tabindex="-1"></a>  weights<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb98-5"><a href="system-description.html#cb98-5" tabindex="-1"></a>  cumulativeWeights<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb98-6"><a href="system-description.html#cb98-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Like <code>ExpansePoint</code>, <code>ExpanseBand</code> has the <code>labels</code> and <code>order</code> properties, which work exactly the same way as before. However, additionally, it also has the <code>weights</code> and <code>cumulativeWeights</code> properties, which are numeric arrays that define the width of each band. <code>weights</code> record the width of each band, and <code>cumulativeWeights</code> record the cumulative sums of the weights, which are used in the <code>normalize</code> and <code>unnormalize</code> functions. Thus, each time we update <code>weights</code>, we need to also update <code>cumulativeWeights</code> as well.</p>
<p>The normalize and unnormalize functions in the <code>ExpanseBand</code> namespace map labels to and from the midpoint of their corresponding bands:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb99-1"><a href="system-description.html#cb99-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpanseBand</span> {</span>
<span id="cb99-2"><a href="system-description.html#cb99-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> value<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb99-3"><a href="system-description.html#cb99-3" tabindex="-1"></a>    <span class="kw">const</span> { labels } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb99-4"><a href="system-description.html#cb99-4" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> labels<span class="op">.</span><span class="fu">indexOf</span>(value)<span class="op">;</span></span>
<span id="cb99-5"><a href="system-description.html#cb99-5" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">getMidpoint</span>(expanse<span class="op">,</span> index)<span class="op">;</span></span>
<span id="cb99-6"><a href="system-description.html#cb99-6" tabindex="-1"></a>  }</span>
<span id="cb99-7"><a href="system-description.html#cb99-7" tabindex="-1"></a></span>
<span id="cb99-8"><a href="system-description.html#cb99-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb99-9"><a href="system-description.html#cb99-9" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order<span class="op">,</span> cumulativeWeights } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb99-10"><a href="system-description.html#cb99-10" tabindex="-1"></a></span>
<span id="cb99-11"><a href="system-description.html#cb99-11" tabindex="-1"></a>    <span class="kw">const</span> weight <span class="op">=</span> value <span class="op">*</span> <span class="fu">last</span>(cumulativeWeights)<span class="op">;</span></span>
<span id="cb99-12"><a href="system-description.html#cb99-12" tabindex="-1"></a>    <span class="kw">let</span> index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb99-13"><a href="system-description.html#cb99-13" tabindex="-1"></a></span>
<span id="cb99-14"><a href="system-description.html#cb99-14" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;</span> cumulativeWeights<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb99-15"><a href="system-description.html#cb99-15" tabindex="-1"></a>      <span class="cf">if</span> (cumulativeWeights[index] <span class="op">&gt;=</span> weight) <span class="cf">break</span><span class="op">;</span></span>
<span id="cb99-16"><a href="system-description.html#cb99-16" tabindex="-1"></a>      index<span class="op">++;</span></span>
<span id="cb99-17"><a href="system-description.html#cb99-17" tabindex="-1"></a>    }</span>
<span id="cb99-18"><a href="system-description.html#cb99-18" tabindex="-1"></a></span>
<span id="cb99-19"><a href="system-description.html#cb99-19" tabindex="-1"></a>    <span class="cf">return</span> labels[order[index]]<span class="op">;</span></span>
<span id="cb99-20"><a href="system-description.html#cb99-20" tabindex="-1"></a>  }</span>
<span id="cb99-21"><a href="system-description.html#cb99-21" tabindex="-1"></a></span>
<span id="cb99-22"><a href="system-description.html#cb99-22" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">getMidpoint</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> index<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb99-23"><a href="system-description.html#cb99-23" tabindex="-1"></a>    <span class="kw">const</span> { order<span class="op">,</span> cumulativeWeights } <span class="op">=</span> expanse<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb99-24"><a href="system-description.html#cb99-24" tabindex="-1"></a>    index <span class="op">=</span> order[index]<span class="op">;</span></span>
<span id="cb99-25"><a href="system-description.html#cb99-25" tabindex="-1"></a></span>
<span id="cb99-26"><a href="system-description.html#cb99-26" tabindex="-1"></a>    <span class="kw">const</span> lower <span class="op">=</span> cumulativeWeights[index <span class="op">-</span> <span class="dv">1</span>] <span class="op">??</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb99-27"><a href="system-description.html#cb99-27" tabindex="-1"></a>    <span class="kw">const</span> upper <span class="op">=</span> cumulativeWeights[index]<span class="op">;</span></span>
<span id="cb99-28"><a href="system-description.html#cb99-28" tabindex="-1"></a>    <span class="kw">const</span> max <span class="op">=</span> <span class="fu">last</span>(cumulativeWeights)<span class="op">;</span></span>
<span id="cb99-29"><a href="system-description.html#cb99-29" tabindex="-1"></a></span>
<span id="cb99-30"><a href="system-description.html#cb99-30" tabindex="-1"></a>    <span class="cf">return</span> (lower <span class="op">+</span> upper) <span class="op">/</span> <span class="dv">2</span> <span class="op">/</span> max<span class="op">;</span></span>
<span id="cb99-31"><a href="system-description.html#cb99-31" tabindex="-1"></a>  }</span>
<span id="cb99-32"><a href="system-description.html#cb99-32" tabindex="-1"></a>}</span></code></pre></div>
<p>Notice that, because of the cumulative nature of the bands, the logic in the functions’ bodies is a bit more complicated. First, to <code>normalize</code> a label, we need to first find the index of the label and then return the corresponding midpoint of the band, taking <code>weights</code> and <code>order</code> into account. Second, to <code>unnormalize</code>, we actually have to loop through the array of <code>cumulativeWeights</code> - there is no way to determine which bin a normalized value belongs to in <span class="math inline">\(O(1)\)</span> time (as far as I am aware). This is not much of a problem since the <code>ExpanseBand.unnormalize</code> is not used anywhere in the system (all scales implemented thus far use only <code>ExpanseBand.normalize</code>), however, it is important to be mindful of this.</p>
<!-- Notice that, whereas before we had considered *normalize* as mapping between $D \to [0, 1]$ and *unnormalize* as mapping between $[0, 1] \to V$, we now consider both as mapping between $[0, 1]$ and an arbitrary domain $X$. This domain can represent the data or the visual attribute - the expanse is agnostic about this. -->
<!-- Also, while before we have discussed domains as subsets of $\mathbb{R}$, we can now start thinking about them as arbitrary sets. While subsets of $\mathbb{R}$ and sets of strings are really the only types of domains used in `plotscaper`, the model should readily extends to other sets, as long as a mapping to and from $[0, 1]$ can be provided. -->
<!-- How `normalize` and `unnormalize` are implemented will depend largely on the subtype of `Expanse`, as well as on the desired behavior. For example, as will be discussed later, in `plotscaper`, the normalize and unnormalize methods implemented for `ExpanseContinuous` (subtype of `Expanse<number>`) work largely the same way as in section [SECTION]. However, while `ExpansePoint` and `ExpanseBand` are both subtypes of `Expanse<string>`, they behave differently - `ExpansePoint` maps strings (factor levels) to equidistant points along $[0, 1]$, whereas `ExpanseBand` maps the strings into the middle of "buckets" along $[0, 1]$.    -->
<!-- However, there is also some behavior that we may want to apply the same way across the different expanse subtypes. For example, it seems reasonable that the user should be able to zoom, pan, or reverse axes, regardless of whether a plot shows discrete or continuous data. As such, there may be some properties and functions common to the `Expanse` type. I will discuss these first. -->
<!-- #### Zero and one -->
<!-- The maps may also take in and return values outside of $D^*$ and $[0, 1]$, if adjustments have been made. For instance, in most data visualization packages, x- and y-axis limits are by default expanded some percentage beyond the range of the observed data to avoid the maximum and minimum datapoints from overlapping with the limits. For example, in base R: -->
<!-- ```{r} -->
<!-- #| fig-height: 4 -->
<!-- #| fig-cap: "Expanding axes. By default, axes in base R `plot()` function are expanded 4% beyond the range of the data (left). Otherwise, datapoints on the limits of their respective scales end up overlapping with the plot borders (right)." -->
<!-- set.seed(12345) -->
<!-- x <- rnorm(5) -->
<!-- y <- rnorm(5) -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(x, y)  -->
<!-- plot(x, y, xaxs = 'i', yaxs = 'i')  -->
<!-- ``` -->
<!-- Thus, upon normalizing the minimum and maximum data values, the expanse should return values other than $\{0, 1\}$. Likewise, to support user interactions such as zooming and panning, the expanses may accept and return values outside of $D^*$ and $[0, 1]$.  -->
<!-- Zooming and panning should be orthogonal to the underlying data type, such that user can interact with the plots the same way^[The one exception may be panning barplots and histograms, where the y-axis upper y-axis limit may change but the lower should be fixed at 0, such that panning may shrink or stretch the bars, but not "lift" them up or move them down.], no matter whether their axes are continuous, discrete, or some combination of the two. To this end, I introduce two parameters representing the normalized value ($p$) of the minimum and maximum data point, called *zero* and *one* respectively. These parameters are agnostic to the underlying data type, such that if we have the data type-specific maps $n'$ and $u'$, the complete normalize and unnormalize maps are: -->
<!-- $$n(d) = \text{zero} + n'(d) \cdot (\text{one} - \text{zero})$$ -->
<!-- $$u(p) = u' \bigg(\frac{p - \text{zero}}{\text{one} - \text{zero}} \bigg)$$ -->
<!-- To simplify, here's what effect setting the two parameters to specific values has: -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- tab <- data.frame( -->
<!--   Zero = c(0.05, 0.05, -0.5), -->
<!--   One = c(0.95, 1.05, 1.5), -->
<!--   Effect = c("Expands the margins by ~5% (actually 5.555...% since 0.05 / 0.9 = 0.0555...)", -->
<!--              "Shifts the expanse 'up' by 5% (e.g. moves x-axis 5% right)", -->
<!--              "Zooms into the middle 50% of the expanse (25 percentile goes to 0 and 75th to one)") -->
<!-- ) -->
<!-- knitr::kable(tab) -->
<!-- ``` -->
<!-- #### Expanse Interface -->
<!-- There are also other behaviours that expanses should support. For instance, we may want to be able to reset the expanse to defaults, retrain when the underlying data changes, and return nicely formatted breaks. How these behaviours are implemented, as well as other types of behavior, may be specific to the underlying data type. Overall, expanse interface may look something like this: -->
<!-- ``` -->
<!-- interface Expanse<T> { -->
<!--   normalize(value: T): number -->
<!--   unnormalize(value: number): T -->
<!--   defaultize(): this -->
<!--   setZero(zero: number, default: boolean): this -->
<!--   setOne(one: number, default: boolean): this -->
<!--   freezeZero(): this -->
<!--   freezeOne(): this -->
<!--   move(amount: number): this -->
<!--   expand(zero: number, one: number): this -->
<!--   retrain(values: T[]): this -->
<!--   breaks(n?: number): T[]   -->
<!-- } -->
<!-- ``` -->
<!-- #### Continuous Expanses -->
<!-- The continuous expanse has as its underlying set $[\min, \max] \subseteq \mathbb{R}$. To understand how it works, let's build it step by step.  -->
<!-- We start with the basic normalizing function: -->
<!-- 1. $$n(d) = \frac{d - \min}{\max - \min}$$ -->
<!-- This function takes some data value $d \in [\min, \max]$ and transforms it to $[0, 1]$. Most data visualization systems use a function like this at some step of the scaling processs - see [`scales::rescale`](https://github.com/r-lib/scales/blob/84560bf54e02315477a05384ee67991e9e8fc52c/R/bounds.R#L85) and **D3** [`normalize`](https://github.com/d3/d3-scale/blob/d6904a4bde09e16005e0ad8ca3e25b10ce54fa0d/src/continuous.js#L122).    -->
<!-- This may work well for typical linear scales. However, we may also want to apply some transformation $f$, such as square root or log. Then, to ensure that the observed data values still get normalized to $[0, 1]$, we need to apply the transformation to both $d$ and the limits: -->
<!-- 2. $$\frac{f(d) - f(\min)}{f(\max) - f(\min)}$$ -->
<!-- Finally, as was discussed in [EXPANSES], we want to be able to incorporate the zero and one paramaters, leading to the final normalizing function: -->
<!-- $$n(d) = \text{zero} + \frac{f(d) - f(\min)}{f(\max) - f(\min)} \cdot (\text{zero} - \text{one})$$ -->
<!-- To obtain the unnormalizing function, we can simply invert the normalizing function: -->
<!-- $$u(p) = f^{-1} \bigg\{ f(\min) + \frac{p - \text{zero}}{\text{one} - \text{zero}} \cdot \big[ f(\max) - f(\min) \big] \bigg\}$$ -->
<!-- The function transforms $x$ to a percentage value $p \in [0, 1]$, provided $x$ is within $[\min, \max]$. The value $(\max - \min)$ is also sometimes called the *range* (not to be confused with **D3** `range`).  -->
<!-- We can invert the normalizing function and obtain the unnormalizing function, which is, for some percentage $p \in [0, 1]$: -->
<!-- $$u(p) = \min + p \cdot (\max - \min)$$ -->
<!-- returns a value within the $[\min, \max]$ range, corresponding to the proportion of the maximum possible distance (range) from the origin ($\min$). For example, $u(0.5)$, returns a value that is located halfway between the limits. -->
<!-- We can implement a simple continuous expanse like so: -->
<!-- ```{ts} -->
<!-- function identity<T>(x: T) { -->
<!--   return x; -->
<!-- } -->
<!-- function expanseContinuous(min = 0, max = 1) { -->
<!--   const [zero, one] = [0, 1] -->
<!--   const [trans, inv] = [identity, identity] -->
<!--   return { min, max, zero, one, trans, inv, -->
<!--     range() { -->
<!--       return this.max - this.min; -->
<!--     }, -->
<!--     transRange() { -->
<!--       const { min, max, trans } = this; -->
<!--       return trans(max) - trans(min); -->
<!--     }, -->
<!--     normalize(x: number) { -->
<!--       const { min, zero, one, trans } = this; -->
<!--       const normalized = (trans(x) - trans(min)) / this.transRange(); -->
<!--       return zero + normalized * (one - zero); -->
<!--     }, -->
<!--     unnormalize(p: number) { -->
<!--       const { min, zero, one, trans, inv } = this; -->
<!--       return inv(trans(min) + ((p - zero) / (one - zero)) * this.transRange()); -->
<!--     }, -->
<!--   }; -->
<!-- } -->
<!-- const expanse1 = expanseContinuous(1, 10); -->
<!-- console.log(expanse1.normalize(5)); -->
<!-- console.log(expanse1.unnormalize(0.5)) -->
<!-- ``` -->
<!-- The functions $n, u$ have several interesting properties. First off, they are inverses to each other and form an *isomorphism*, i.e. $u = n^{-1}$ and $n = u^{-1}$ such that $u(n(x)) = x$ and $n(u(p)) = p$. This also means that each function is a 1-to-1 mapping or *bijection*. In plain words, this means that we cannot get the same percentage by normalizing two different values and vice versa. As a result, we can keep switching between the normalized and unnormalized representations without losing any information:   -->
<!-- ```{r} -->
<!-- with(expanse, unnormalize(normalize(5))) -->
<!-- with(expanse, normalize(unnormalize(normalize(unnormalize(0.5))))) -->
<!-- ``` -->
<!-- ##### Linearity -->
<!-- Another important thing to note is that, while these types of normalizing functions are often called "linear" (e.g. `scaleLinear()` in **D3**), since their graphs form a straight line, they should not be confused with "linear functions", since they do not satisfy the properties of linear functions, namely: -->
<!-- - Additivity: $\text{normalize}(x + c) \neq \text{normalize}(x) + \text{normalize}(c)$ -->
<!-- - Homogeneity of degree 1: $\text{normalize}(c \cdot x) \neq c \cdot \text{normalize(x)}$. -->
<!-- To illustrate, additivity does not hold when $\min \neq 0$ because: -->
<!-- $$\frac{(x + c) - \min}{(\max - \min)}$$ -->
<!-- $$= \frac{x - \min}{\max - \min} + \frac{c}{\max - \min}$$ -->
<!-- $$\neq \frac{x - \min}{\max - min} + \frac{c - \min}{\max - \min}$$ -->
<!-- The same can be easily shown for the $\text{unnormalize}$ map and for homogeneity. -->
<!-- Technically, this is due to a confusion between the definition of a "linear function" and a "linear polynomial". The appropriate term to use would actually be "affine transformation."  -->
<!-- Either way, if the minimum is not 0, we cannot expect the following to be equal: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(3) + normalize(2))) -->
<!-- ``` -->
<!-- Or the following to be equal: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(2 * 5), 2 * normalize(5))) -->
<!-- ``` -->
<!-- However, if we keep in mind the fact that the normalizing function calculates the proportion of distance from the origin, we can see that the function in fact behaves linearly within the context of its limits. -->
<!-- For example, consider the range $[1, 10]$. The value $5$ is $4$ units away from the lower limit, i.e. $5 - 1 = 4$, so we can represent it, for example, as the sum of a value that is 3 units away and another that is one unit away, $n(5) = n(4) + n(2)$:  -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(4) + normalize(2))) -->
<!-- ``` -->
<!-- Likewise, again because $5$ represents the distance of $4$ units and $3$ of $2$, we can expect $n(5) = 2 \cdot n(3)$: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), 2 * normalize(3))) -->
<!-- ``` -->
<!-- ##### Transformations -->
<!-- We can apply transformations to continuous expanses by transforming their limits. The outcome of this is that $\min$ and $\max$ still get mapped to $0$ and $1$ however, the graph of the function is no longer linear. Suppose we have non-linear function $f$, along with an inverse $f^{-1}$. Then: -->
<!-- $$n(x) = \frac{f(x) - f(\min)}{f(\max) - f(\min)}$$ -->
<!-- $$u(p) = f^{-1} \bigg\{f(\min) + p \cdot \big[ f(\max) - f(\min) \big] \bigg\}$$ -->
<!-- For example, here's how we could apply the transformation $\bigg( f(x) = \sqrt{x}, \; f^{-1}(x) = x^2 \bigg)$ in code:  -->
<!-- ```{r} -->
<!-- expanse$trans <- sqrt -->
<!-- expanse$inv <- function(x) x^2 -->
<!-- # Need to redefine normalize and unnormalize -->
<!-- expanse$trans_range <- function() with(expanse, trans(max) - trans(min)) -->
<!-- expanse$normalize <- function(x) { -->
<!--   with(expanse, (trans(x) - trans(min)) / trans_range()) -->
<!-- } -->
<!-- expanse$unnormalize <- function(p) { -->
<!--   with(expanse, inv(trans(min) + p * trans_range())) -->
<!-- } -->
<!-- # Normalizing limits still returns c(0, 1) -->
<!-- c(expanse$normalize(c(1, 10))) -->
<!-- # Notice that these return different values from before though -->
<!-- expanse$normalize(5) -->
<!-- expanse$unnormalize(0.5) -->
<!-- x <- seq(1, 10, length = 100) -->
<!-- p <- seq(0, 1, length = 100) -->
<!-- # The graphs are no longer linear -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(x, expanse$normalize(x), type = "l", ylab = "normalize(x)") -->
<!-- plot(p, expanse$unnormalize(p), type = "l", ylab = "unnormalize(p)") -->
<!-- ``` -->
<!-- Transformations such as these can be useful in two ways. First, sometimes we may be able to better see trends in the data when the data has been appropriately transformed. This is the case, for example, when plotting data which varies across orders of magnitude. In this case it may be useful to apply $\log$-transformation. Second, transformations can also be helpful in situations where some graphical attributes are not perceived linearly. For example, when judging differently sized objects, viewers tend judge magnitude based on area rather than side or radius. As such, when drawing objects such as points or squares it can be helpful to apply square root as the inverse transformation. The idea is that, if one point has a data value that is $c$ times bigger than another, it will have $\sqrt{c}$ times bigger radius and $c$ times bigger area. Note that we are talking about the inverse transformation here, i.e. the transformation affecting the unnormalizing function. -->
<!-- One thing to note is that the proportionality of the square-root transformation holds only when $\min = 0$. Otherwise: -->
<!-- $$\sqrt{(\min)^2 + cp \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- $$= \sqrt{c} \cdot \sqrt{(\min)^2/c + p \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- $$\neq \sqrt{c} \cdot \sqrt{(\min)^2 + p \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- This is a problem in the existing packages. For example: -->
<!-- ```{r} -->
<!-- library(scales) -->
<!-- pal <- area_pal(c(1, 5)) -->
<!-- # Comparing cscale to naive implementation -->
<!-- all.equal(cscale(1:5, pal), sqrt((1:5 - 1) / 4) * 4 + 1) -->
<!-- # Should be equal since 3 is twice as far from 1 as 2 is -->
<!-- c(cscale(1:5, pal)[3] / cscale(1:5, pal)[2], -->
<!--   sqrt(2)) -->
<!-- expanse$min <- 1 -->
<!-- expanse$max <- 5 -->
<!-- cscale(1:5, pal) -->
<!-- expanse$unnormalize(1:5 / 5) -->
<!-- expanse -->
<!-- plot(1:5, expanse$unnormalize(1:5 / 5)) -->
<!-- plot(1:5, cscale(1:5, pal)) -->
<!-- ``` -->
<!-- ##  -->

</div>
</div>
</div>
</div>
<h3> References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bostock2011" class="csl-entry">
Bostock, Michael, Vadim Ogievetsky, and Jeffrey Heer. 2011. <span>“D<span class="math inline">\(^3\)</span> Data-Driven Documents.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 17 (12): 2301–9.
</div>
<div id="ref-fong2019" class="csl-entry">
Fong, Brendan, and David I Spivak. 2019. <em>An Invitation to Applied Category Theory: Seven Sketches in Compositionality</em>. Cambridge University Press.
</div>
<div id="ref-krzywinski2013" class="csl-entry">
Krzywinski, Martin. 2013. <span>“Axes, Ticks and Grids.”</span> <em>Nature Methods</em> 10 (February): 183. <a href="https://doi.org/10.1038/nmeth.2337">https://doi.org/10.1038/nmeth.2337</a>.
</div>
<div id="ref-lawvere2009" class="csl-entry">
Lawvere, F William, and Stephen H Schanuel. 2009. <em>Conceptual Mathematics: A First Introduction to Categories</em>. Cambridge University Press.
</div>
<div id="ref-michell1986" class="csl-entry">
Michell, Joel. 1986. <span>“Measurement Scales and Statistics: A Clash of Paradigms.”</span> <em>Psychological Bulletin</em> 100 (3): 398.
</div>
<div id="ref-murrell2005" class="csl-entry">
Murrell, Paul. 2005. <em>R Graphics</em>. Chapman; Hall/CRC.
</div>
<div id="ref-d3-scale2024" class="csl-entry">
Observable. 2024. <span>“D3-Scale <span><span class="math inline">\(\vert\)</span></span> D3 by Observable.”</span> <a href="https://d3js.org/d3-scale">https://d3js.org/d3-scale</a>.
</div>
<div id="ref-satyanarayan2015" class="csl-entry">
Satyanarayan, Arvind, Ryan Russell, Jane Hoffswell, and Jeffrey Heer. 2015. <span>“Reactive Vega: A Streaming Dataflow Architecture for Declarative Interactive Visualization.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 22 (1): 659–68.
</div>
<div id="ref-stevens1946" class="csl-entry">
Stevens, Stanley Smith. 1946. <span>“On the Theory of Scales of Measurement.”</span> <em>Science</em> 103 (2684): 677–80.
</div>
<div id="ref-tufte2001" class="csl-entry">
Tufte, Edward R. 2001. <em>The Visual Display of Quantitative Information</em>. Cheshire, Connecticut: Graphics Press LLC.
</div>
<div id="ref-veight2017" class="csl-entry">
V8 Core Team. 2017. <span>“Elements Kinds in V8 <span><span class="math inline">\(\cdot\)</span></span> V8.”</span> <a href="https://v8.dev/blog/elements-kinds">https://v8.dev/blog/elements-kinds</a>.
</div>
<div id="ref-wickham2013" class="csl-entry">
———. 2013. <span>“Bin-Summarise-Smooth: A Framework for Visualising Large Data.”</span> <em>Had. Co. Nz, Tech. Rep</em>.
</div>
<div id="ref-wickham2016" class="csl-entry">
———. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis (2e)</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-wickham2023" class="csl-entry">
Wickham, Hadley, Thomas Lin Pedersen, and Dana Seidel. 2023. <em>Scales: Scale Functions for Visualization</em>. <a href="https://CRAN.R-project.org/package=scales">https://CRAN.R-project.org/package=scales</a>.
</div>
<div id="ref-wilkinson2012" class="csl-entry">
Wilkinson, Leland. 2012. <em>The Grammar of Graphics</em>. Springer.
</div>
<div id="ref-ziemkiewicz2009" class="csl-entry">
Ziemkiewicz, Caroline, and Robert Kosara. 2009. <span>“Embedding Information Visualization Within Visual Representation.”</span> In <em>Advances in Information and Intelligent Systems</em>, 307–26. Springer.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="2">
<li id="fn2"><p>Unless the length of the data changes. I have not implemented data streaming for plotscape/r yet, however, it would be easy to extend bijection factor for streaming by simply pushing/popping the array of indices.<a href="system-description.html#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Not currently implemented in plotscape/r<a href="system-description.html#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="high-level-principles.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="applied-examples.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
