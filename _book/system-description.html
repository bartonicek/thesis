<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 System description | Fluent Graphics</title>
  <meta name="description" content="4 System description | Fluent Graphics" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="4 System description | Fluent Graphics" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 System description | Fluent Graphics" />
  
  
  

<meta name="author" content="Adam Bartonicek" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="design.html"/>
<link rel="next" href="glossary.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#what-is-interactive-visualization"><i class="fa fa-check"></i><b>2.1</b> What even is interactive data visualization?</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="introduction.html"><a href="introduction.html#brief-history-of-interactive-data-visualization"><i class="fa fa-check"></i><b>2.1.1</b> Brief history of interactive data visualization</a></li>
<li class="chapter" data-level="2.1.2" data-path="introduction.html"><a href="introduction.html#interactive-vs.-interacting-with"><i class="fa fa-check"></i><b>2.1.2</b> Interactive vs. interacting with</a></li>
<li class="chapter" data-level="2.1.3" data-path="introduction.html"><a href="introduction.html#what-counts-as-interactive-enough"><i class="fa fa-check"></i><b>2.1.3</b> What counts as “interactive enough”?</a></li>
<li class="chapter" data-level="2.1.4" data-path="introduction.html"><a href="introduction.html#complexity-of-interactive-features"><i class="fa fa-check"></i><b>2.1.4</b> Complexity of interactive features</a></li>
<li class="chapter" data-level="2.1.5" data-path="introduction.html"><a href="introduction.html#working-definition"><i class="fa fa-check"></i><b>2.1.5</b> Working definition</a></li>
<li class="chapter" data-level="2.1.6" data-path="introduction.html"><a href="introduction.html#list-of-common-interactive-features"><i class="fa fa-check"></i><b>2.1.6</b> List of common interactive features</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#mathematical-theory"><i class="fa fa-check"></i><b>2.2</b> Mathematical theory</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction.html"><a href="introduction.html#past-application-of-category-theory-to-data-visualization"><i class="fa fa-check"></i><b>2.2.1</b> Past Application of Category Theory to Data Visualization</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction.html"><a href="introduction.html#relations"><i class="fa fa-check"></i><b>2.2.2</b> Relations</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction.html"><a href="introduction.html#functions"><i class="fa fa-check"></i><b>2.2.3</b> Functions</a></li>
<li class="chapter" data-level="2.2.4" data-path="introduction.html"><a href="introduction.html#partitions"><i class="fa fa-check"></i><b>2.2.4</b> Partitions</a></li>
<li class="chapter" data-level="2.2.5" data-path="introduction.html"><a href="introduction.html#preorders"><i class="fa fa-check"></i><b>2.2.5</b> Preorders</a></li>
<li class="chapter" data-level="2.2.6" data-path="introduction.html"><a href="introduction.html#monoids"><i class="fa fa-check"></i><b>2.2.6</b> Monoids</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#components-of-a-data-visualization-system"><i class="fa fa-check"></i><b>2.3</b> Components of a data visualization system</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction.html"><a href="introduction.html#scales"><i class="fa fa-check"></i><b>2.3.1</b> Scales</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="design.html"><a href="design.html"><i class="fa fa-check"></i><b>3</b> Design</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="design.html"><a href="design.html#user-profile"><i class="fa fa-check"></i><b>3.0.1</b> User profile</a></li>
<li class="chapter" data-level="3.1" data-path="design.html"><a href="design.html#programming-paradigm"><i class="fa fa-check"></i><b>3.1</b> Programming paradigm</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="design.html"><a href="design.html#imperative-programming"><i class="fa fa-check"></i><b>3.1.1</b> Imperative programming</a></li>
<li class="chapter" data-level="3.1.2" data-path="design.html"><a href="design.html#functional-programming"><i class="fa fa-check"></i><b>3.1.2</b> Functional programming</a></li>
<li class="chapter" data-level="3.1.3" data-path="design.html"><a href="design.html#object-oriented-programming"><i class="fa fa-check"></i><b>3.1.3</b> Object oriented programming</a></li>
<li class="chapter" data-level="3.1.4" data-path="design.html"><a href="design.html#data-oriented-programming"><i class="fa fa-check"></i><b>3.1.4</b> Data oriented programming</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="system-description.html"><a href="system-description.html"><i class="fa fa-check"></i><b>4</b> System description</a>
<ul>
<li class="chapter" data-level="4.1" data-path="system-description.html"><a href="system-description.html#components"><i class="fa fa-check"></i><b>4.1</b> Components</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="system-description.html"><a href="system-description.html#Indexable"><i class="fa fa-check"></i><b>4.1.1</b> Indexable</a></li>
<li class="chapter" data-level="4.1.2" data-path="system-description.html"><a href="system-description.html#Getter"><i class="fa fa-check"></i><b>4.1.2</b> Getter</a></li>
<li class="chapter" data-level="4.1.3" data-path="system-description.html"><a href="system-description.html#reactive"><i class="fa fa-check"></i><b>4.1.3</b> Reactive</a></li>
<li class="chapter" data-level="4.1.4" data-path="system-description.html"><a href="system-description.html#dataframe"><i class="fa fa-check"></i><b>4.1.4</b> Dataframe</a></li>
<li class="chapter" data-level="4.1.5" data-path="system-description.html"><a href="system-description.html#factors"><i class="fa fa-check"></i><b>4.1.5</b> Factors</a></li>
<li class="chapter" data-level="4.1.6" data-path="system-description.html"><a href="system-description.html#reducers"><i class="fa fa-check"></i><b>4.1.6</b> Reducers</a></li>
<li class="chapter" data-level="4.1.7" data-path="system-description.html"><a href="system-description.html#scales-1"><i class="fa fa-check"></i><b>4.1.7</b> Scales</a></li>
<li class="chapter" data-level="4.1.8" data-path="system-description.html"><a href="system-description.html#expanses"><i class="fa fa-check"></i><b>4.1.8</b> Expanses</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="system-description.html"><a href="system-description.html#section"><i class="fa fa-check"></i><b>4.2</b> </a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>5</b> Glossary</a></li>
<li class="chapter" data-level="6" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>6</b> Appendix</a></li>
<li class="chapter" data-level="7" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>7</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fluent Graphics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="system-description" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> System description<a href="system-description.html#system-description" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This section contains a description of the concrete system implementation (<a href="https://github.com/bartonicek/plotscape">plotscape</a> and <a href="https://github.com/bartonicek/plotscaper">plotscaper</a>).</p>
<div id="components" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Components<a href="system-description.html#components" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This section contains a detailed listing of the system’s components.</p>
<div id="Indexable" class="section level3 hasAnchor" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Indexable<a href="system-description.html#Indexable" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Visualizing data involves .</p>
<p>Indexable is one of the most fundamental types. It has the following signature:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb1-1"><a href="system-description.html#cb1-1" tabindex="-1"></a>Indexable<span class="op">&lt;</span>T <span class="op">=</span> <span class="dt">unknown</span><span class="op">&gt;</span> <span class="op">=</span> T <span class="op">|</span> T[] <span class="op">|</span> ((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T)</span></code></pre></div>
<p>In plain words, <code>Indexable&lt;T&gt;</code> represents a variable-like object that we can use to extract values from by subsetting it with an index. It is meant to be used in combination with a <code>Getter</code>, which provides a uniform interface for extracting these values.</p>
<p>The <code>Indexable</code> type is useful because, while our data will typically come in the form of arrays, we also want the flexibility to be able to work with non-array values such as constants and functions. For example, in a typical barplot, the y-axis base is set to a constant value, typically zero. While we could hypothetically append a new array filled with zeros to the data, it is much more convenient and memory efficient to instead represent the data with a constant (<code>0</code>) or a thunk (<code>() =&gt; 0</code>).</p>
</div>
<div id="Getter" class="section level3 hasAnchor" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> Getter<a href="system-description.html#Getter" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A getter takes an <a href="system-description.html#Indexable"><code>Indexable&lt;T&gt;</code></a> and returns a function, which, when given an index, returns a value of type <code>T</code>. Here is a slightly simplified implementation:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb2-1"><a href="system-description.html#cb2-1" tabindex="-1"></a><span class="co">// Getter.ts</span></span>
<span id="cb2-2"><a href="system-description.html#cb2-2" tabindex="-1"></a><span class="im">export type</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb2-3"><a href="system-description.html#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="system-description.html#cb2-4" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Getter</span> {</span>
<span id="cb2-5"><a href="system-description.html#cb2-5" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">of</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb2-6"><a href="system-description.html#cb2-6" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">typeof</span> x <span class="op">===</span> <span class="vs">`function`</span>) <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb2-7"><a href="system-description.html#cb2-7" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(x)) <span class="cf">return</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> x[index]<span class="op">;</span></span>
<span id="cb2-8"><a href="system-description.html#cb2-8" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">return</span> () <span class="kw">=&gt;</span> x</span>
<span id="cb2-9"><a href="system-description.html#cb2-9" tabindex="-1"></a>  }</span>
<span id="cb2-10"><a href="system-description.html#cb2-10" tabindex="-1"></a>}</span></code></pre></div>
<p>we can then create and use <code>Getter</code>s like so:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb3-1"><a href="system-description.html#cb3-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb3-2"><a href="system-description.html#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="system-description.html#cb3-3" tabindex="-1"></a><span class="kw">const</span> getter1 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb3-4"><a href="system-description.html#cb3-4" tabindex="-1"></a><span class="kw">const</span> getter2 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> index <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-5"><a href="system-description.html#cb3-5" tabindex="-1"></a><span class="kw">const</span> getter3 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>(<span class="dv">99</span>)<span class="op">;</span></span>
<span id="cb3-6"><a href="system-description.html#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="system-description.html#cb3-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter1</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-8"><a href="system-description.html#cb3-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter2</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-9"><a href="system-description.html#cb3-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter3</span>(<span class="dv">0</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 1
## -1
## 99</code></pre>
<p>Note that, by its type definition, every <code>Getter&lt;T&gt;</code> is also automatically an <code>Indexable&lt;T&gt;</code> (since it is a function <code>(index: number) =&gt; T</code>). This means that we can create new getters out of other getters.</p>
<p>The <code>Getter</code> namespace also includes some other utility functions. One example is <code>Getter.constant</code> which takes in a value <code>T</code> and returns a thunk which always returns <code>T</code> (i.e. <code>() =&gt; T</code>). This is useful, for example, when <code>T</code> is an array and we always want to return the whole array, not just a single indexed element. Another utility function is <code>Getter.proxy</code>, which takes a <code>Getter</code> and an array of indices, and returns a new <code>Getter</code> which proxies the access to the original values through the array of indices:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb5-1"><a href="system-description.html#cb5-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb5-2"><a href="system-description.html#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="system-description.html#cb5-3" tabindex="-1"></a><span class="kw">const</span> proxyGetter <span class="op">=</span> Getter<span class="op">.</span><span class="fu">proxy</span>([<span class="vs">`A`</span><span class="op">,</span> <span class="vs">`B`</span><span class="op">,</span> <span class="vs">`C`</span>]<span class="op">,</span> [<span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb5-4"><a href="system-description.html#cb5-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">.</span><span class="fu">map</span>(proxyGetter))</span></code></pre></div>
<pre><code>## [ &quot;C&quot;, &quot;B&quot;, &quot;B&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A&quot; ]</code></pre>
<p>The <code>Getter.proxy</code> function becomes particularly useful when using <code>Factor</code>s.</p>
</div>
<div id="reactive" class="section level3 hasAnchor" number="4.1.3">
<h3><span class="header-section-number">4.1.3</span> Reactive<a href="system-description.html#reactive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>Reactive</code> is a fundamental mixin which is used in many parts of the system. It is essentially just an implementation of the Observer pattern with few extra bits.</p>
</div>
<div id="dataframe" class="section level3 hasAnchor" number="4.1.4">
<h3><span class="header-section-number">4.1.4</span> Dataframe<a href="system-description.html#dataframe" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Another fundamental data structure is a <code>Dataframe</code>. A <code>Dataframe</code> is just a record of <a href="system-description.html#Indexable"><code>Indexable</code></a> values:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb7-1"><a href="system-description.html#cb7-1" tabindex="-1"></a><span class="kw">interface</span> Dataframe {</span>
<span id="cb7-2"><a href="system-description.html#cb7-2" tabindex="-1"></a>  [key<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">symbol</span>]<span class="op">:</span> Indexable</span>
<span id="cb7-3"><a href="system-description.html#cb7-3" tabindex="-1"></a>}</span></code></pre></div>
<p>In this way, a <code>Dataframe</code> is essentially just a <a href="glossary.html#SoA">SoA</a> data structure with a little bit of extra flexibility. Specifically, while in SoA data structures, all properties are typically arrays, in <code>Dataframe</code> they are instances of the <code>Indexable</code> type so they may also be constants or functions. For example, the following is a valid instance of a <code>Dataframe</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb8-1"><a href="system-description.html#cb8-1" tabindex="-1"></a><span class="kw">const</span> data<span class="op">:</span> Dataframe <span class="op">=</span> {</span>
<span id="cb8-2"><a href="system-description.html#cb8-2" tabindex="-1"></a>  name<span class="op">:</span> [<span class="vs">`foo`</span><span class="op">,</span> <span class="vs">`bar`</span><span class="op">,</span> <span class="vs">`baz`</span>]<span class="op">,</span></span>
<span id="cb8-3"><a href="system-description.html#cb8-3" tabindex="-1"></a>  age<span class="op">:</span> <span class="dv">99</span><span class="op">,</span></span>
<span id="cb8-4"><a href="system-description.html#cb8-4" tabindex="-1"></a>  canDrive<span class="op">:</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> index <span class="op">&lt;</span> <span class="dv">50</span> </span>
<span id="cb8-5"><a href="system-description.html#cb8-5" tabindex="-1"></a>}</span></code></pre></div>
<p>The fact that the “columns” of a <code>Dataframe</code> can be constants and functions is useful, for example, when want every row to contain the same value (e.g. 0 for the base of a barplot), or when we want the value be lazily computed based on other values. This is also where the <a href="glossary.html#SoA">SoA</a> representation offers a unique advantage: to achieve the same behavior in <a href="glossary.html#SoA">AoS</a> layout, we would have to copy the value or function pointer to every row.</p>
<p><code>Dataframe</code> should always contain at least one array and all arrays in a <code>Dataframe</code> should have the same length. This is necessary to determine the length of the <code>Dataframe</code> (the number of rows). For example, when rendering, we need to know how many objects to draw; as such, at least of one the dataframe’s columns needs to have a fixed length (i.e. have an underlying array).</p>
<p>These fixed-length constraints are not enforced via any static check (such as during a constructor call), but are instead checked dynamically during runtime, whenever the integrity of a dataframe’s length becomes a key concern (using utility functions such as <code>Dataframe.checkLength</code>). This is the case, for example, when initializing a <code>Scene</code> or when rendering.</p>
<p>I found these dynamic fixed-length checks to be the more convenient option. They allow us to represent data as a plain JavaScript object (POJO) rather than having to instantiate a class. Additionally, due to JavaScript’s dynamic nature, this approach is also safer: if, during runtime, the user adds a property to a <code>Dataframe</code> which violates the fixed-length constraints, this approach will catch the error. Finally, for any reasonably-sized data set with typical dimensionality (more rows than columns, <span class="math inline">\(p &lt;&lt; n\)</span>), the tiny performance hit that may be incurred because of having to loop through the columns to find the length dynamically will be minuscule, compared to the cost of looping through the data set’s rows and doing actual work. For high-dimensional datasets (<span class="math inline">\(p &gt;&gt; n\)</span>), we could always extend the system to memoize the length/number of rows on the <code>Dataframe</code> object (although then we may lose the safety of the dynamic runtime checks).</p>
</div>
<div id="factors" class="section level3 hasAnchor" number="4.1.5">
<h3><span class="header-section-number">4.1.5</span> Factors<a href="system-description.html#factors" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Factors provide a way to partition the data into multiple disjoint parts.</p>
<div id="product-factors" class="section level4 hasAnchor" number="4.1.5.1">
<h4><span class="header-section-number">4.1.5.1</span> Product factors<a href="system-description.html#product-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>We can combine a factor with <span class="math inline">\(j\)</span> levels and another factor with <span class="math inline">\(k\)</span> levels into a product factor with up to <span class="math inline">\(j \cdot k\)</span> levels.</p>
<p>I independently discovered a formula similar to <span class="citation">(<a href="#ref-wickham2013">Wickham 2013</a>)</span>:</p>
<p><span class="math display">\[i_{\text{product}} = i_1 + i_2 \cdot \max(j, k)\]</span></p>
</div>
</div>
<div id="reducers" class="section level3 hasAnchor" number="4.1.6">
<h3><span class="header-section-number">4.1.6</span> Reducers<a href="system-description.html#reducers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><span class="citation">(<a href="#ref-gray1997">Gray et al. 1997</a>)</span> came up with OLAP data cube</p>
</div>
<div id="scales-1" class="section level3 hasAnchor" number="4.1.7">
<h3><span class="header-section-number">4.1.7</span> Scales<a href="system-description.html#scales-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To visualize data, we need to be able to translate values from the space of the data to the space of the graphical device (computer screen). In most data visualization systems, this is done by specialized components called scales or coordinate systems. By serving as a bridge between what we have (data) and what we see (visual attributes), scales act as a fundamental building block of all data visualization systems.</p>
<p>There exists is a fair research on the theoretical properties of scales and how they relate to the mechanisms of visual perception <span class="citation">(see e.g. <a href="#ref-krzywinski2013">Krzywinski 2013</a>; <a href="#ref-michell1986">Michell 1986</a>; <a href="#ref-wilkinson2012">Wilkinson 2012</a>; <a href="#ref-stevens1946">Stevens 1946</a>)</span>. However, when it comes to applying this knowledge and implementing scales in concrete data visualization systems, only scant information is available. And, even when such information is available, it is it is often quite abstract or high-level <span class="citation">(for some rare counter-examples, see e.g. <a href="#ref-murrell2005">Murrell 2005</a>; <a href="#ref-ziemkiewicz2009">Ziemkiewicz and Kosara 2009</a>)</span>. Therefore, I thought it could be quite instructive to go into the details of how scales are implemented in my own data visualization system. The following section is based largely on how scales have been implemented in existing data visualization codebases, such as the <code>ggplot2</code> R package <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span> or <code>d3-scale</code> module of D3 <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>; also used by Vega <a href="#ref-satyanarayan2015">Satyanarayan et al. 2015</a>)</span>, as well as on personal insights gained while implementing the package.</p>
<div id="overview" class="section level4 hasAnchor" number="4.1.7.1">
<h4><span class="header-section-number">4.1.7.1</span> Overview<a href="system-description.html#overview" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>From a high-level perspective, a scale is just a function <span class="math inline">\(s: D \to V\)</span> which translates values of the data <span class="math inline">\(d \in D\)</span> to values of some visual attribute <span class="math inline">\(v \in V\)</span>, such as the x- and y-position, length, area, radius, or color <span class="citation">(<a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>. This function may or may not be invertible, such that, at times, each value of the visual attribute may be identified with a unique data value (but this is not always the case).</p>
<p>One of the most common and typical cases is a scale where both <span class="math inline">\(D\)</span> and <span class="math inline">\(V\)</span> are subsets of the real numbers:</p>
<p><span class="math display">\[s: [d_{min}, d_{max}] \to [v_{min}, v_{max}] \qquad d_{min}, d_{max}, v_{min}, v_{max} \in \mathbb{R}\]</span></p>
<p>For example, suppose our data takes values in the range from 1 to 10 and we want to plot it along the x-axis, within a 800 pixels wide plotting region. Then, our scale is simply:</p>
<p><span class="math display">\[s_x: [1, 10] \to [0, 800]\]</span></p>
<p>Now, there is an infinite number of functions that fit this signature. However, one particularly nice and simple candidate is the following function:</p>
<div class="definition">
<p><span id="def:linear-mapping" class="definition"><strong>Definition 4.1  (Simple linear mapping) </strong></span><span class="math display">\[s(d) = v_{max} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
</div>
<p>if we substitute the concrete values into the formula, this becomes:</p>
<p><span class="math display">\[s_x(d) = 0 + \frac{d - 1}{10 - 1} \cdot (800 - 0) = [(d - 1) / 9] \cdot 800\]</span></p>
<p>The function acts on the data in the following way:</p>
<ul>
<li><span class="math inline">\(s_x(1) = (1 - 1) / 9 \cdot 800 = 0\)</span></li>
<li><span class="math inline">\(s_x(10) = (10 - 1) / 9 \cdot 800 = 800\)</span></li>
<li><span class="math inline">\(s_x(d) \in (0, 800)\)</span> for any <span class="math inline">\(d \in (1, 10)\)</span></li>
</ul>
<p>That is, the function maps the data value 1 to pixel 0 (left border of the plotting region), value 10 to to pixel 800 (right border of the plotting region), and any value in between 1 and 10 inside the interval 0 to 800, proportionally to where in the data range it is located.</p>
<p>It is relatively simple to translate the formula in <a href="system-description.html#def:linear-mapping">4.1</a> to code:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb9-1"><a href="system-description.html#cb9-1" tabindex="-1"></a><span class="co">// simpleScale.ts</span></span>
<span id="cb9-2"><a href="system-description.html#cb9-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale</span>(</span>
<span id="cb9-3"><a href="system-description.html#cb9-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb9-4"><a href="system-description.html#cb9-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb9-5"><a href="system-description.html#cb9-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb9-6"><a href="system-description.html#cb9-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb9-7"><a href="system-description.html#cb9-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb9-8"><a href="system-description.html#cb9-8" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb9-9"><a href="system-description.html#cb9-9" tabindex="-1"></a>  <span class="cf">return</span> vmin <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb9-10"><a href="system-description.html#cb9-10" tabindex="-1"></a>}</span></code></pre></div>
<p>And indeed, this function works the way we would expect:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb10-1"><a href="system-description.html#cb10-1" tabindex="-1"></a><span class="im">import</span> { simpleScale } <span class="im">from</span> <span class="st">&quot;./simpleScale.ts&quot;</span></span>
<span id="cb10-2"><a href="system-description.html#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="system-description.html#cb10-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb10-4"><a href="system-description.html#cb10-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb10-5"><a href="system-description.html#cb10-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0
## 400
## 800</code></pre>
</div>
<div id="simple-scale-limits" class="section level4 hasAnchor" number="4.1.7.2">
<h4><span class="header-section-number">4.1.7.2</span> Limits of modeling scales as simple functions<a href="system-description.html#simple-scale-limits" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Simple scale functions like the one above can work fine for basic data visualization systems. However, once we begin adding more features, this design becomes prohibitive. Consider, for example, what happens if we want to:</p>
<ul>
<li>Expand the scale limits</li>
<li>Scale discrete data</li>
<li>Apply non-linear transformations</li>
<li>Pan, zoom, reverse, reorder, or otherwise modify the scales interactively</li>
</ul>
<p>Let’s take the first point as a motivating example. Consider what happens to data points at the limits of the data range under the simple linear mapping:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="system-description.html#cb12-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb12-2"><a href="system-description.html#cb12-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb12-3"><a href="system-description.html#cb12-3" tabindex="-1"></a>col <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="st">&quot;indianred&quot;</span>, <span class="st">&quot;grey80&quot;</span>)</span>
<span id="cb12-4"><a href="system-description.html#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="system-description.html#cb12-5" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>, <span class="at">xaxs =</span> <span class="st">&quot;i&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-10-1.png" width="800px" style="display: block; margin: auto;" /></p>
<p>The plot above shows values scaled using the simple linear mapping along the x-axis, i.e. <span class="math inline">\(s: [1, 10] \to [0, 800]\)</span>. Notice that, since the position of the points representing the values 1 and 10 gets mapped to pixel values 0 and 800 (the left and right border of the plot), only half of each point is visible.</p>
<p>To address this, most data visualization systems automatically expand the range of the domain by some pre-specified percentage:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="system-description.html#cb13-1" tabindex="-1"></a><span class="co"># By default, the plot() automatically expands the x- and y-axis</span></span>
<span id="cb13-2"><a href="system-description.html#cb13-2" tabindex="-1"></a><span class="co"># limits by approximately 4% on each end, see `xaxs` in ?graphics::par</span></span>
<span id="cb13-3"><a href="system-description.html#cb13-3" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-11-1.png" width="800px" style="display: block; margin: auto;" /></p>
<p>We <em>could</em> achieve similar effect by modifying the simple linear mapping and adding an additional argument:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb14-1"><a href="system-description.html#cb14-1" tabindex="-1"></a><span class="co">// simpleScale2.ts</span></span>
<span id="cb14-2"><a href="system-description.html#cb14-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale2</span>(</span>
<span id="cb14-3"><a href="system-description.html#cb14-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb14-4"><a href="system-description.html#cb14-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb14-5"><a href="system-description.html#cb14-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb14-6"><a href="system-description.html#cb14-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb14-7"><a href="system-description.html#cb14-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb14-8"><a href="system-description.html#cb14-8" tabindex="-1"></a>  exp<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> <span class="co">// Extra argument</span></span>
<span id="cb14-9"><a href="system-description.html#cb14-9" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb14-10"><a href="system-description.html#cb14-10" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb14-11"><a href="system-description.html#cb14-11" tabindex="-1"></a>    vmin <span class="op">+</span> (exp <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> exp)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)</span>
<span id="cb14-12"><a href="system-description.html#cb14-12" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb14-13"><a href="system-description.html#cb14-13" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, if we set the <code>exp</code> argument to some positive value, the scaled values get mapped closer to the center of the plotting region. For example, setting <code>exp</code> to 0.2 moves each of the data limits 10% closer to the center of the plotting region:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb15-1"><a href="system-description.html#cb15-1" tabindex="-1"></a><span class="im">import</span> { simpleScale2 } <span class="im">from</span> <span class="st">&quot;./simpleScale2.ts&quot;</span></span>
<span id="cb15-2"><a href="system-description.html#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="system-description.html#cb15-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span>
<span id="cb15-4"><a href="system-description.html#cb15-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span>
<span id="cb15-5"><a href="system-description.html#cb15-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 80
## 400
## 720</code></pre>
<p>However, notice that this argument is applied symmetrically. At times, we may want to apply a different margin to each end of the scale. We could solve this by adding two arguments instead of one, e.g. <code>expLeft</code> and <code>expRight</code>, however, at this point, the function signature starts to become unwieldy. Also, note that the logic inside the function’s body becomes more complicated. If we have to call the function in multiple places, it may become difficult to remember what the each individual argument represents. Further, we may want to persist or modify some of the arguments during runtime (such as when panning or zooming). Therefore, a more structured approach is required.</p>
</div>
<div id="solution-two-component-scales" class="section level4 hasAnchor" number="4.1.7.3">
<h4><span class="header-section-number">4.1.7.3</span> Solution: Two-component scales<a href="system-description.html#solution-two-component-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The linear mapping formula in <a href="system-description.html#def:linear-mapping">4.1</a> can guide us in decomposing the scaling function into smaller, more manageable parts. Let’s look at the formula again:</p>
<p><span class="math display">\[s(d) = v_{min} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
<p>If we look closely, we may be able to see that the linear mapping is composed of two parts:</p>
<p><span class="math display">\[s(d) = \color{steelblue}{v_{min} +} \color{indianred}{\frac{\color{black}{d} - d_{min}}{d_{max} - d_{min}}} \color{steelblue}{\cdot (v_{max} - v_{min})}\]</span></p>
<p>That is, the linear mapping is composed of two simpler functions:</p>
<ul>
<li><span class="math inline">\(\color{indianred}{n(d) = (d - d_{min}) / (d_{max} - d_{min})}\)</span> takes a data value <span class="math inline">\(d \in D\)</span> and maps it to the interval <span class="math inline">\([0, 1]\)</span></li>
<li><span class="math inline">\(\color{steelblue}{u(p) = v_{min} + p \cdot (v_{max} - v_{min})}\)</span> takes a value in <span class="math inline">\([0, 1]\)</span> and maps it to a visual attribute value <span class="math inline">\(v \in V\)</span></li>
</ul>
<p>This leads us to the following definition of a scale:</p>
<div class="definition">
<p><span id="def:scale" class="definition"><strong>Definition 4.2  (Scale as composition of two functions) </strong></span>A scale <span class="math inline">\(s\)</span> can be created by composing:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(n: D \to [0, 1]\)</span>, mapping data to the interval <span class="math inline">\([0, 1]\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(u: [0, 1] \to V\)</span>, mapping value in <span class="math inline">\([0, 1]\)</span> to the visual attribute codomain</li>
</ul>
<p>Such that:</p>
<p><span class="math display">\[s(d) = u(n(d))\]</span></p>
</div>
<p>For the case of the linear mapping, we could rewrite this in code as follows:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb17-1"><a href="system-description.html#cb17-1" tabindex="-1"></a><span class="co">// LinearMap.ts</span></span>
<span id="cb17-2"><a href="system-description.html#cb17-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">LinearMap</span> {</span>
<span id="cb17-3"><a href="system-description.html#cb17-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb17-4"><a href="system-description.html#cb17-4" tabindex="-1"></a>    <span class="cf">return</span> (d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)<span class="op">;</span></span>
<span id="cb17-5"><a href="system-description.html#cb17-5" tabindex="-1"></a>  }</span>
<span id="cb17-6"><a href="system-description.html#cb17-6" tabindex="-1"></a></span>
<span id="cb17-7"><a href="system-description.html#cb17-7" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb17-8"><a href="system-description.html#cb17-8" tabindex="-1"></a>    <span class="cf">return</span> vmin <span class="op">+</span> p <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb17-9"><a href="system-description.html#cb17-9" tabindex="-1"></a>  }</span>
<span id="cb17-10"><a href="system-description.html#cb17-10" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb18-1"><a href="system-description.html#cb18-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb18-2"><a href="system-description.html#cb18-2" tabindex="-1"></a></span>
<span id="cb18-3"><a href="system-description.html#cb18-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>))</span>
<span id="cb18-4"><a href="system-description.html#cb18-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb18-5"><a href="system-description.html#cb18-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0.5
## 400
## 400</code></pre>
<p>This two component system allows for a clean separation of concerns. Specifically, the normalize function only needs to know how to map the data values to <span class="math inline">\([0, 1]\)</span>. It does not need to be aware of where these normalized data values will be mapped to. Conversely, the unnormalize function only needs to understand how to translate values from <span class="math inline">\([0, 1]\)</span> to the space of the visual attribute (such as x-axis position).</p>
<div id="beyond-linear-maps" class="section level5 hasAnchor" number="4.1.7.3.1">
<h5><span class="header-section-number">4.1.7.3.1</span> Beyond linear maps<a href="system-description.html#beyond-linear-maps" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>One big advantage of the two-component scale system is that the functions <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> do not need to be a simple linear maps anymore. For example, suppose that our data <span class="math inline">\(D\)</span> takes form of a set of discrete labels, such as <span class="math inline">\(D = \{ Prague,  Vienna, Munich, Salzburg \}\)</span>. We can then replace <span class="math inline">\(n\)</span> with a surjective function <span class="math inline">\(n: D \to [0, 1]\)</span> such that:</p>
<p><span class="math display">\[n(d) = \begin{cases}  
0.2 &amp; \text{if } d = Munich
\\ 0.4 &amp; \text{if } d = Prague
\\ 0.6 &amp; \text{if } d = Salzburg
\\ 0.8 &amp; \text{if } d = Vienna
\end{cases}\]</span></p>
<p>In other words, <span class="math inline">\(n\)</span> will place values of <span class="math inline">\(D\)</span> at equidistant points along <span class="math inline">\([0, 1]\)</span>, ordered alphabetically. We can implement this function in code as follows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb20-1"><a href="system-description.html#cb20-1" tabindex="-1"></a><span class="co">// PointMap.ts</span></span>
<span id="cb20-2"><a href="system-description.html#cb20-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">PointMap</span> {</span>
<span id="cb20-3"><a href="system-description.html#cb20-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb20-4"><a href="system-description.html#cb20-4" tabindex="-1"></a>    <span class="cf">return</span> (dlabels<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb20-5"><a href="system-description.html#cb20-5" tabindex="-1"></a>  }</span>
<span id="cb20-6"><a href="system-description.html#cb20-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Since the codomain of <span class="math inline">\(n\)</span> is still <span class="math inline">\([0, 1]\)</span>, we can compose it with a simple linear mapping <span class="math inline">\(u\)</span> just as easily as before:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb21-1"><a href="system-description.html#cb21-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb21-2"><a href="system-description.html#cb21-2" tabindex="-1"></a><span class="im">import</span> { PointMap } <span class="im">from</span> <span class="st">&quot;./PointMap.ts&quot;</span></span>
<span id="cb21-3"><a href="system-description.html#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="system-description.html#cb21-4" tabindex="-1"></a><span class="kw">const</span> labels <span class="op">=</span> [<span class="st">&quot;Munich&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Salzburg&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]<span class="op">;</span></span>
<span id="cb21-5"><a href="system-description.html#cb21-5" tabindex="-1"></a></span>
<span id="cb21-6"><a href="system-description.html#cb21-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Munich&quot;</span><span class="op">,</span> labels))<span class="op">;</span></span>
<span id="cb21-7"><a href="system-description.html#cb21-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Munich&quot;</span><span class="op">,</span> labels)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))<span class="op">;</span></span>
<span id="cb21-8"><a href="system-description.html#cb21-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Prague&quot;</span><span class="op">,</span> labels)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 0.2
## 160
## 320</code></pre>
</div>
<div id="inverses" class="section level5 hasAnchor" number="4.1.7.3.2">
<h5><span class="header-section-number">4.1.7.3.2</span> Inverses<a href="system-description.html#inverses" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Another benefit of two-component scale system is that, if both <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> are invertible, then so is <span class="math inline">\(s\)</span>: we can easily obtain the inverse scale function by inverting the definition from <a href="system-description.html#def:scale">4.2</a>:</p>
<div class="definition">
<p><span id="def:scale-inverse" class="definition"><strong>Definition 4.3  (Scale inverse) </strong></span>If a scale <span class="math inline">\(s\)</span> is composed of invertible functions <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span>, then <span class="math inline">\(s\)</span> is invertible:</p>
<p><span class="math display">\[s^{-1}(v) = n^{-1}(u^{-1}(v))\]</span></p>
</div>
<p>This is the case for the simple linear map: the normalize and unnormalize functions are actually inverses of each other:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb23-1"><a href="system-description.html#cb23-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb23-2"><a href="system-description.html#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="system-description.html#cb23-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="dv">300</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">500</span>))</span></code></pre></div>
<pre><code>## 300</code></pre>
<p>However, the inverse may not always exist. In practice, this is often the case when the domain of the data <span class="math inline">\(D\)</span> is smaller than the codomain <span class="math inline">\([0, 1]\)</span>. Take, for example, the discrete point mapping. Since <span class="math inline">\(D\)</span> is finite but <span class="math inline">\([0, 1]\)</span> has infinitely many values, there will always be some values in <span class="math inline">\([0, 1]\)</span> that no <span class="math inline">\(d \in D\)</span> maps to. For example, if <span class="math inline">\(D = \{ Munich, Prague, Salzburg, Vienna \}\)</span> and <span class="math inline">\(Munich\)</span> maps to 0.2, <span class="math inline">\(Prague\)</span> maps to <span class="math inline">\(0.4\)</span>, and <span class="math inline">\(Salzburg\)</span> maps to <span class="math inline">\(0.8\)</span>, then there are no cities which map to 0.9, 0.444, or 0.123456789. Conversely, if we get given those numeric values, then there is no obvious way to map them back to the cities.</p>
<p>One thing we can do is to replace the inverse/unnormalize function with a weaker form of inverse, called retraction <span class="citation">(<a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>)</span>. Specifically, if we have a normalize function <span class="math inline">\(n: D \to [0, 1]\)</span>, then an unnormalize retraction <span class="math inline">\(u^*\)</span> will have the property that:</p>
<p><span class="math display">\[u^*(n(d)) = d \qquad \forall d \in D\]</span></p>
<p>However, the converse doesn’t necessarily hold:</p>
<p><span class="math display">\[\neg \big[ n(u^*(v)) = v \qquad \forall v \in V \big]\]</span></p>
<p>For example, for the discrete point mapping, a retraction may map a value in <span class="math inline">\([0, 1]\)</span> to the closest data value <span class="math inline">\(d \in D\)</span>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb25-1"><a href="system-description.html#cb25-1" tabindex="-1"></a><span class="co">// PointMap.ts</span></span>
<span id="cb25-2"><a href="system-description.html#cb25-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">PointMap</span> {</span>
<span id="cb25-3"><a href="system-description.html#cb25-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb25-4"><a href="system-description.html#cb25-4" tabindex="-1"></a>    <span class="cf">return</span> (dlabels<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb25-5"><a href="system-description.html#cb25-5" tabindex="-1"></a>  }</span>
<span id="cb25-6"><a href="system-description.html#cb25-6" tabindex="-1"></a>  </span>
<span id="cb25-7"><a href="system-description.html#cb25-7" tabindex="-1"></a>  <span class="co">// Retraction - find the closest label</span></span>
<span id="cb25-8"><a href="system-description.html#cb25-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb25-9"><a href="system-description.html#cb25-9" tabindex="-1"></a>    <span class="kw">const</span> k <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(p <span class="op">*</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb25-10"><a href="system-description.html#cb25-10" tabindex="-1"></a>    <span class="cf">return</span> dlabels[k]</span>
<span id="cb25-11"><a href="system-description.html#cb25-11" tabindex="-1"></a>  }</span>
<span id="cb25-12"><a href="system-description.html#cb25-12" tabindex="-1"></a>}</span>
<span id="cb25-13"><a href="system-description.html#cb25-13" tabindex="-1"></a></span>
<span id="cb25-14"><a href="system-description.html#cb25-14" tabindex="-1"></a><span class="kw">const</span> labels <span class="op">=</span> [<span class="st">&quot;Munich&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Salzburg&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]<span class="op">;</span></span>
<span id="cb25-15"><a href="system-description.html#cb25-15" tabindex="-1"></a></span>
<span id="cb25-16"><a href="system-description.html#cb25-16" tabindex="-1"></a><span class="kw">const</span> [prague<span class="op">,</span> munich] <span class="op">=</span> [<span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Munich&quot;</span>]<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> PointMap<span class="op">.</span><span class="fu">normalize</span>(x<span class="op">,</span> labels))</span>
<span id="cb25-17"><a href="system-description.html#cb25-17" tabindex="-1"></a><span class="kw">const</span> midpoint <span class="op">=</span> (prague <span class="op">+</span> munich) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb25-18"><a href="system-description.html#cb25-18" tabindex="-1"></a></span>
<span id="cb25-19"><a href="system-description.html#cb25-19" tabindex="-1"></a><span class="co">// Helper function for stripping away floating point error </span></span>
<span id="cb25-20"><a href="system-description.html#cb25-20" tabindex="-1"></a><span class="kw">const</span> strip <span class="op">=</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="pp">parseFloat</span>(x<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">12</span>))</span>
<span id="cb25-21"><a href="system-description.html#cb25-21" tabindex="-1"></a></span>
<span id="cb25-22"><a href="system-description.html#cb25-22" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Midpoint between Munich and Prague: `</span><span class="op">,</span> <span class="fu">strip</span>(midpoint))</span>
<span id="cb25-23"><a href="system-description.html#cb25-23" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`unnormalize(0.2999): `</span><span class="op">,</span> PointMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.2999</span><span class="op">,</span> labels))</span>
<span id="cb25-24"><a href="system-description.html#cb25-24" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`unnormalize(3): `</span><span class="op">,</span> PointMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.3</span><span class="op">,</span> labels))</span></code></pre></div>
<pre><code>## Midpoint between Munich and Prague:  0.3
## unnormalize(0.2999):  Munich
## unnormalize(3):  Prague</code></pre>
<p>While inverses are always unique <span class="citation">(<a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>; <a href="#ref-fong2019">Fong and Spivak 2019</a>)</span>, we may be able to come up with many different retractions for any given function. For example, with the discrete point map above, we could use the floor function instead of rounding and assign label to a value in <span class="math inline">\([0, 1]\)</span> if it is less than the value of the normalized label (but more than the preceding labels).</p>
<p>The non-uniqueness of retractions presents a bit of a dilemma. How do we decide which retraction to use? And, if a certain retractive implementation of <code>unnormalize</code> returns a value, how do we decide if it is the “correct one”?</p>
<p>However, in practice, this is not much of a problem. While developing the package, I found that I’ve only ever had to use the <code>unnormalize</code> function with continuous data (<code>LinearMap</code>), and so the inverse was always well-defined. This is probably also why packages like <code>ggplot2</code> and <code>D3</code> can get by without this functionality. However, I still find it helpful to include the <code>unnormalize</code> function as a first class citizen (instead of it being relegated to some special case), both in terms of the mental model and also for debugging.</p>
</div>
<div id="some-other-remarks-about-the-two-component-scale-system" class="section level5 hasAnchor" number="4.1.7.3.3">
<h5><span class="header-section-number">4.1.7.3.3</span> Some other remarks about the two-component scale system<a href="system-description.html#some-other-remarks-about-the-two-component-scale-system" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>It is worth noting that there is nothing inherently special about the interval <span class="math inline">\([0, 1]\)</span> as the intermediate domain: any finite subset of <span class="math inline">\(\mathbb{R}\)</span> would do. However, the interval <span class="math inline">\([0, 1]\)</span> is convenient, both in terms of interpretation as well as for implementation, as we will see later.</p>
<p>Finally, so far I have discussed scales as <em>functions</em>: the scale function, the normalize function, and unnormalize function. Framing scales as composition of functions leads to a nice correspondence between the mathematical definition and the code. However, in practice, it may be more convenient to implement the domain and codomain as <em>objects</em> or <em>classes</em>, as we will also see in the following section. The important point is that, no matter how the two components are represented, each is responsible for translating values from/to its domain and the interval <span class="math inline">\([0, 1]\)</span>.</p>
</div>
</div>
<div id="past-implementations-of-scales" class="section level4 hasAnchor" number="4.1.7.4">
<h4><span class="header-section-number">4.1.7.4</span> Past implementations of scales<a href="system-description.html#past-implementations-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Two-component scale systems are fairly standard across data visualization packages. For example, the D3 library <span class="citation">(<a href="#ref-bostock2011">Bostock, Ogievetsky, and Heer 2011</a>)</span> implements scales in a functional style, with the values representing the data domain and the visual (co)domain being provided as tuples or arrays of values, either during initialization or at some later point. For illustration, here is an example from the oficial documentation <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>)</span>:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb27-1"><a href="system-description.html#cb27-1" tabindex="-1"></a><span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">960</span>])<span class="op">;</span></span>
<span id="cb27-2"><a href="system-description.html#cb27-2" tabindex="-1"></a><span class="fu">x</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// 80</span></span>
<span id="cb27-3"><a href="system-description.html#cb27-3" tabindex="-1"></a><span class="kw">const</span> color <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span> [<span class="st">&quot;brown&quot;</span><span class="op">,</span> <span class="st">&quot;steelblue&quot;</span>])<span class="op">;</span></span>
<span id="cb27-4"><a href="system-description.html#cb27-4" tabindex="-1"></a><span class="fu">color</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// &quot;rgb(154, 52, 57)&quot;</span></span>
<span id="cb27-5"><a href="system-description.html#cb27-5" tabindex="-1"></a><span class="co">// The domain and codomain can also be specified separately</span></span>
<span id="cb27-6"><a href="system-description.html#cb27-6" tabindex="-1"></a><span class="kw">const</span> y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>])<span class="op">;</span> </span></code></pre></div>
<p>Internally, D3 uses specialized functions to translate from the domain to the codomain (such as the <code>normalize()</code> and <code>scale()</code> functions for continuous and discrete/ordinal domains, respectively, and various <code>interpolate()</code> functions for codomains).</p>
<p>Similarly, in <code>ggplot2</code> <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span>, scales are built upon the <code>Scale</code> class, with each subtype implementing <code>limits</code> and <code>palette</code> properties. Similar to D3, the <code>limits</code> property is a vector which corresponds to the data domain and the <code>palette</code> property is a function which corresponds roughly to the visual codomain (the x- and y-position behave slightly differently, due to being passed through coordinate systems). Internally, the package uses the <code>rescale</code> function from the <code>scales</code> package <span class="citation">(<a href="#ref-wickham2023">Wickham, Pedersen, and Seidel 2023</a>)</span> to map data values to <span class="math inline">\([0, 1]\)</span> and then the <code>palette</code> function is responsible for mapping these normalized values to the visual attribute. For illustration, here’s the full definition of the <code>map</code> method on the <code>ScaleContinuous</code> class (I’ve added comments for clarity):</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="system-description.html#cb28-1" tabindex="-1"></a>map <span class="ot">=</span> <span class="cf">function</span>(self, x, <span class="at">limits =</span> self<span class="sc">$</span><span class="fu">get_limits</span>()) {</span>
<span id="cb28-2"><a href="system-description.html#cb28-2" tabindex="-1"></a>  <span class="co"># Limits are just a tuple, rescale maps x to [0, 1]</span></span>
<span id="cb28-3"><a href="system-description.html#cb28-3" tabindex="-1"></a>  x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">rescale</span>(self<span class="sc">$</span><span class="fu">oob</span>(x, <span class="at">range =</span> limits), limits) </span>
<span id="cb28-4"><a href="system-description.html#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="system-description.html#cb28-5" tabindex="-1"></a>  uniq <span class="ot">&lt;-</span> <span class="fu">unique0</span>(x)</span>
<span id="cb28-6"><a href="system-description.html#cb28-6" tabindex="-1"></a>  <span class="co"># Palette is a function which returns a vector of attribute values</span></span>
<span id="cb28-7"><a href="system-description.html#cb28-7" tabindex="-1"></a>  pal <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">palette</span>(uniq) </span>
<span id="cb28-8"><a href="system-description.html#cb28-8" tabindex="-1"></a>  scaled <span class="ot">&lt;-</span> pal[<span class="fu">match</span>(x, uniq)]</span>
<span id="cb28-9"><a href="system-description.html#cb28-9" tabindex="-1"></a></span>
<span id="cb28-10"><a href="system-description.html#cb28-10" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(scaled), scaled, self<span class="sc">$</span>na.value)</span>
<span id="cb28-11"><a href="system-description.html#cb28-11" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="proposed-model-of-scales" class="section level4 hasAnchor" number="4.1.7.5">
<h4><span class="header-section-number">4.1.7.5</span> Proposed model of scales<a href="system-description.html#proposed-model-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One feature that the models of scales that <code>D3</code> and <code>ggplot2</code> rely on is that they both treat the data domain and the visual attribute codomain as different types. In <code>D3</code>, fundamentally different functions are used to translate from <span class="math inline">\(D \to [0, 1]\)</span> and from <span class="math inline">\([0, 1] \to V\)</span>, and in <code>ggplot2</code>, <code>limits</code> is a simple vector/tuple whereas <code>palette</code> is a function. While these approaches may have some benefits, such as perhaps offering greater flexibility, they also add additional complexity. Specifically, we have to use two different mental models: one when considering the domain and another when considering the codomain. Further, these models of scales only work in one direction: mapping values <span class="math inline">\(D \to V\)</span>. For going the the other way, i.e. mapping <span class="math inline">\(V \to D\)</span>, other specialized functions have to be used.</p>
<p>I propose a model of scales which implements both the domain and the codomain as components of the same type: <code>Expanse</code>. Fundamentally, this makes it so that the only difference between the data domain and the visual attribute codomain is which property of the scale they are assigned to.</p>
<p>Here is a (slightly) simplified version of the <code>Scale</code> interface:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb29-1"><a href="system-description.html#cb29-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb29-2"><a href="system-description.html#cb29-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb29-3"><a href="system-description.html#cb29-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb29-4"><a href="system-description.html#cb29-4" tabindex="-1"></a>}</span></code></pre></div>
<p><code>D</code> and <code>V</code> represent the data domain and the visual attribute codomain, respectively.</p>
<p>The two fundamental functions connected to <code>Scale</code> are:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb30-1"><a href="system-description.html#cb30-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span></span>
<span id="cb30-2"><a href="system-description.html#cb30-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span></span></code></pre></div>
<p>The <code>pushforward</code> function <em>pushes values forward</em> through the scale, first through its domain and then its codomain, and the <code>pullback</code> function <em>pulls values back</em>, first through its codomain and then through its domain. The <code>ValueOf</code> type helper just identifies the type associated with the expanse’s data (e.g. <code>number</code> for a continuous <code>Expanse</code>, <code>string</code> for a discrete <code>Expanse</code>, etc…). I’ve omitted the generic type parameter constraint (<code>&lt;D extends Expanse, V extends Expanse&gt;</code>) for brevity.</p>
<p>Here is a simplified implementation of the two functions:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb31-1"><a href="system-description.html#cb31-1" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb31-2"><a href="system-description.html#cb31-2" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span> {</span>
<span id="cb31-3"><a href="system-description.html#cb31-3" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb31-4"><a href="system-description.html#cb31-4" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value))<span class="op">;</span></span>
<span id="cb31-5"><a href="system-description.html#cb31-5" tabindex="-1"></a>  }</span>
<span id="cb31-6"><a href="system-description.html#cb31-6" tabindex="-1"></a></span>
<span id="cb31-7"><a href="system-description.html#cb31-7" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span> {</span>
<span id="cb31-8"><a href="system-description.html#cb31-8" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb31-9"><a href="system-description.html#cb31-9" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(domain<span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(codomain<span class="op">,</span> value))</span>
<span id="cb31-10"><a href="system-description.html#cb31-10" tabindex="-1"></a>  }</span>
<span id="cb31-11"><a href="system-description.html#cb31-11" tabindex="-1"></a>}</span></code></pre></div>
<p>We can see that most of the work is done by the two <code>Expanse</code> components: we use <code>domain</code> to translates <span class="math inline">\(D \to [0, 1]\)</span> and codomain to translate <span class="math inline">\([0, 1] \to V\)</span>. <code>Scale</code> only serves as plumbing, connecting the two together.</p>
<p>I argue that this model provides several benefits. First of all, it makes the code easier to reason about. Since both the <code>domain</code> and <code>codomain</code> are of the same type, we only need to keep a single mental model of <code>Expanse</code> in mind. Second, if <code>domain</code> and <code>codomain</code> provide inverse functions (<code>unnormalize</code>), we get the inverse scale function <span class="math inline">\(V \to D\)</span> for free (this is just the <code>pullback</code> function). Finally, there is also some functionalities we can implement on <code>Scale</code> directly, and thus we can keep the interface for <code>Expanse</code> relatively simple. These common functionalities of <code>Scale</code> will be the subject of the next few sections, before we dive into <code>Expanse</code> proper.</p>
<div id="zero-and-one" class="section level5 hasAnchor" number="4.1.7.5.1">
<h5><span class="header-section-number">4.1.7.5.1</span> Zero and one<a href="system-description.html#zero-and-one" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Recall that in Section <a href="system-description.html#simple-scale-limits">4.1.7.2</a>, we ran into the problem of expanding axis limits. We solved the problem by adding an additional argument to the <code>simpleScale</code> function. However, is expanding the axis limits something that we would want to do for continuous scales only?</p>
<p>Clearly, we may want to add margins to axes which do not represent continuous data too, such the the x-axis of a barplot. So, we do not want this functionality to be tied to the scale’s <code>domain</code> (which represents the data). We could add it to the scale’s <code>codomain</code>, however, then we would be breaking with our intention of representing both domain and codomain with the same generic <code>Expanse</code> type. So what can we do?</p>
<p>We can put the functionality for expanding axis limits directly onto <code>Scale</code>. Specifically, notice that any values passing through scale will be first converted to the interval <span class="math inline">\([0, 1]\)</span> and then back to the space of either the domain or codomain:</p>
<p><span class="math display">\[D \to [0, 1] \to V\]</span></p>
<p>If we re-normalize these normalized values in <span class="math inline">\([0, 1]\)</span>, we can achieve the result of expanding or shrinking axis limits. As an analogy, if <code>Scale</code> represents the plumbing between the <code>domain</code> and <code>codomain</code>, we can imagine squeezing or stretching the pipe to allow more or less water to flow through.</p>
<p>To actually do this, we can add two additional parameters to <code>Scale</code>, <code>zero</code> and <code>one</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb32-1"><a href="system-description.html#cb32-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb32-2"><a href="system-description.html#cb32-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb32-3"><a href="system-description.html#cb32-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb32-4"><a href="system-description.html#cb32-4" tabindex="-1"></a>  props<span class="op">:</span> { <span class="co">// A dictionary of properties</span></span>
<span id="cb32-5"><a href="system-description.html#cb32-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb32-6"><a href="system-description.html#cb32-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb32-7"><a href="system-description.html#cb32-7" tabindex="-1"></a>  }</span>
<span id="cb32-8"><a href="system-description.html#cb32-8" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we can implement a new version of the <code>pushforward</code> function:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb33-1"><a href="system-description.html#cb33-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> D)<span class="op">:</span> V {</span>
<span id="cb33-2"><a href="system-description.html#cb33-2" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> props } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb33-3"><a href="system-description.html#cb33-3" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">,</span> one } <span class="op">=</span> props</span>
<span id="cb33-4"><a href="system-description.html#cb33-4" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)</span>
<span id="cb33-5"><a href="system-description.html#cb33-5" tabindex="-1"></a>  normalized <span class="op">=</span> zero <span class="op">+</span> normalized <span class="op">*</span> (one <span class="op">-</span> zero) <span class="co">// Re-normalize</span></span>
<span id="cb33-6"><a href="system-description.html#cb33-6" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)</span>
<span id="cb33-7"><a href="system-description.html#cb33-7" tabindex="-1"></a>}</span></code></pre></div>
<p>The function’s body is bit longer than before, however, the only real change is in the line with the comment. We push the normalized value up by the <code>zero</code> property and scale it by <code>(zero - one)</code> range. In other words, we can interpret <code>zero</code> as the proportion of the codomain range that the minimum data value will get mapped to, and <code>one</code> as the proportion of the codomain range that the maximum data value will get mapped to.</p>
<p>Now we can use <code>zero</code> and <code>one</code> to implement margins. For example, by setting <code>zero</code> to 0.1 and <code>one</code> to 0.9, we can implement 10% margins on either side of the scale. That is, we get the same behavior that we did with the <code>exp</code> argument from Section <a href="system-description.html#simple-scale-limits">4.1.7.2</a>. However, we will get this behavior generically, no matter what subtype of <code>Expanse</code> <code>domain</code> and <code>codomain</code> are. Also, we now have the freedom to manipulate each parameter separately (for example, we could specify just the “left” margin by setting <code>zero</code> to 0.1 and <code>one</code> to 1).</p>
<p>However, there is much more we can do with the <code>zero</code> and <code>one</code> than just margins. Firstly, despite the names being a bit suggestive, <code>zero</code> and <code>one</code> can both take values <em>less</em> than zero and <em>more</em> than one. For example, suppose we increment both <code>zero</code> and <code>one</code> by the same amount, e.g. we set <code>zero</code> to 0.1 and <code>one</code> to 1.1. Then, the minimum data value will get mapped to the 10% of the codomain range, and the maximum data value will get mapped to 110% of the codomain range (which may lie outside the space representable by the graphic device). If the codomain represents the x-axis position, then we have shifted all of the geometric objects 10% to the right. We have effectively implemented <em>panning</em>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb34-1"><a href="system-description.html#cb34-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb34-2"><a href="system-description.html#cb34-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">zero</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb34-3"><a href="system-description.html#cb34-3" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">one</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb34-4"><a href="system-description.html#cb34-4" tabindex="-1"></a>}</span></code></pre></div>
<p>That’s it. We have implemented a functionality for panning which will work no matter if <code>domain</code> is transforms numbers, strings, or some more complicated data.</p>
<p>We can also stretch or shrink <code>zero</code> and <code>one</code> in opposite directions. For example, by setting <code>zero</code> to -0.5 and <code>one</code> to 1.5, then the minimum and maximum data values will get mapped 50% below and 50% above the limits of the codomain range, respectively (hence, they may both become unrepresentable). Further, the 25 and 75 data percentiles will get mapped to the minimum and maximum of the codomain range. If we apply this to the x- or y-axes, we’ve just implemented <em>zooming</em></p>
<p>To be perfectly honest, there’s a bit more ceremony involved with zooming. Specifically, if we don’t start from <code>zero = 0</code> and <code>one = 1</code> (e.g. if our plot already has margins or if we’re zooming in multiple levels deep), then we need to re-normalize within these values. This took me a bit of time to nail down, however, it’s just (highschool) algebra:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb35-1"><a href="system-description.html#cb35-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rangeInverse</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb35-2"><a href="system-description.html#cb35-2" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (max <span class="op">-</span> min)<span class="op">;</span></span>
<span id="cb35-3"><a href="system-description.html#cb35-3" tabindex="-1"></a>}</span>
<span id="cb35-4"><a href="system-description.html#cb35-4" tabindex="-1"></a></span>
<span id="cb35-5"><a href="system-description.html#cb35-5" tabindex="-1"></a><span class="kw">function</span> <span class="fu">invertRange</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb35-6"><a href="system-description.html#cb35-6" tabindex="-1"></a>  <span class="kw">const</span> ri <span class="op">=</span> <span class="fu">rangeInverse</span>(min<span class="op">,</span> max)<span class="op">;</span></span>
<span id="cb35-7"><a href="system-description.html#cb35-7" tabindex="-1"></a>  <span class="cf">return</span> [<span class="op">-</span>min <span class="op">*</span> ri<span class="op">,</span> ri <span class="op">-</span> min <span class="op">*</span> ri]<span class="op">;</span></span>
<span id="cb35-8"><a href="system-description.html#cb35-8" tabindex="-1"></a>}</span>
<span id="cb35-9"><a href="system-description.html#cb35-9" tabindex="-1"></a></span>
<span id="cb35-10"><a href="system-description.html#cb35-10" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb35-11"><a href="system-description.html#cb35-11" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">expand</span>(</span>
<span id="cb35-12"><a href="system-description.html#cb35-12" tabindex="-1"></a>    scale<span class="op">:</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span> one<span class="op">:</span> <span class="dt">number</span> } }<span class="op">,</span></span>
<span id="cb35-13"><a href="system-description.html#cb35-13" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb35-14"><a href="system-description.html#cb35-14" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb35-15"><a href="system-description.html#cb35-15" tabindex="-1"></a>  ) {</span>
<span id="cb35-16"><a href="system-description.html#cb35-16" tabindex="-1"></a>    <span class="kw">const</span> { zero<span class="op">:</span> currentZero<span class="op">,</span> one<span class="op">:</span> currentOne } <span class="op">=</span> scale<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb35-17"><a href="system-description.html#cb35-17" tabindex="-1"></a>    <span class="kw">const</span> currentRange <span class="op">=</span> currentOne <span class="op">-</span> currentZero<span class="op">;</span></span>
<span id="cb35-18"><a href="system-description.html#cb35-18" tabindex="-1"></a>    </span>
<span id="cb35-19"><a href="system-description.html#cb35-19" tabindex="-1"></a>    <span class="co">// Re-normalize within current values</span></span>
<span id="cb35-20"><a href="system-description.html#cb35-20" tabindex="-1"></a>    zero <span class="op">=</span> (zero <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb35-21"><a href="system-description.html#cb35-21" tabindex="-1"></a>    one <span class="op">=</span> (one <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb35-22"><a href="system-description.html#cb35-22" tabindex="-1"></a></span>
<span id="cb35-23"><a href="system-description.html#cb35-23" tabindex="-1"></a>    <span class="co">// Invert</span></span>
<span id="cb35-24"><a href="system-description.html#cb35-24" tabindex="-1"></a>    [zero<span class="op">,</span> one] <span class="op">=</span> <span class="fu">invertRange</span>(zero<span class="op">,</span> one)<span class="op">;</span></span>
<span id="cb35-25"><a href="system-description.html#cb35-25" tabindex="-1"></a></span>
<span id="cb35-26"><a href="system-description.html#cb35-26" tabindex="-1"></a>    scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">zero</span> <span class="op">=</span> zero<span class="op">;</span></span>
<span id="cb35-27"><a href="system-description.html#cb35-27" tabindex="-1"></a>    scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">one</span> <span class="op">=</span> one<span class="op">;</span></span>
<span id="cb35-28"><a href="system-description.html#cb35-28" tabindex="-1"></a>  }</span>
<span id="cb35-29"><a href="system-description.html#cb35-29" tabindex="-1"></a>}</span>
<span id="cb35-30"><a href="system-description.html#cb35-30" tabindex="-1"></a></span>
<span id="cb35-31"><a href="system-description.html#cb35-31" tabindex="-1"></a><span class="kw">const</span> scale1 <span class="op">=</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> one<span class="op">:</span> <span class="dv">1</span> } }<span class="op">;</span> <span class="co">// Mock of default scale</span></span>
<span id="cb35-32"><a href="system-description.html#cb35-32" tabindex="-1"></a><span class="kw">const</span> scale2 <span class="op">=</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="fl">0.1</span><span class="op">,</span> one<span class="op">:</span> <span class="fl">0.9</span> } }<span class="op">;</span> <span class="co">// Mock of scale with margins</span></span>
<span id="cb35-33"><a href="system-description.html#cb35-33" tabindex="-1"></a></span>
<span id="cb35-34"><a href="system-description.html#cb35-34" tabindex="-1"></a><span class="co">// Zoom into the middle 50% of either scale</span></span>
<span id="cb35-35"><a href="system-description.html#cb35-35" tabindex="-1"></a>Scale<span class="op">.</span><span class="fu">expand</span>(scale1<span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb35-36"><a href="system-description.html#cb35-36" tabindex="-1"></a>Scale<span class="op">.</span><span class="fu">expand</span>(scale2<span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb35-37"><a href="system-description.html#cb35-37" tabindex="-1"></a></span>
<span id="cb35-38"><a href="system-description.html#cb35-38" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Zoomed in scale with no margins`</span><span class="op">,</span> scale1<span class="op">.</span><span class="at">props</span>)<span class="op">;</span></span>
<span id="cb35-39"><a href="system-description.html#cb35-39" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Zoomed in scale with 10% margins`</span><span class="op">,</span> scale2<span class="op">.</span><span class="at">props</span>)<span class="op">;</span></span></code></pre></div>
<pre><code>## Zoomed in scale with no margins {
##   zero: -0.5,
##   one: 1.5,
## }
## Zoomed in scale with 10% margins {
##   zero: -0.3,
##   one: 1.3,
## }</code></pre>
<p>As you can see, zooming into the middle 50% of a scale that already includes margins has a smaller effect on <code>zero</code> and <code>one</code>, since the margins have effectively expand the space we’re zooming into (i.e., a scale with margins is already <em>zoomed out</em>, in a way).</p>
</div>
<div id="direction" class="section level5 hasAnchor" number="4.1.7.5.2">
<h5><span class="header-section-number">4.1.7.5.2</span> Direction<a href="system-description.html#direction" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In the same way we can think about expanding/shrinking axis limits in a way that is not coupled to any particular data representation or visual attribute, it may also be helpful to make direction a property of <code>Scale</code> rather than either of the <code>Expanse</code> components.</p>
<p>We <em>could</em> do this by manipulating the <code>zero</code> and <code>one</code> properties. For example, by setting <code>zero</code> to 1 and <code>one</code> to 0, we could effectively reverse the direction of the scale. However, in practice, this would complicate our logic and make it harder for someone to interpret the <code>Scale</code> properties. It is a better idea to add an explicit <code>direction</code> parameter instead:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb37-1"><a href="system-description.html#cb37-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb37-2"><a href="system-description.html#cb37-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb37-3"><a href="system-description.html#cb37-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb37-4"><a href="system-description.html#cb37-4" tabindex="-1"></a>  props<span class="op">:</span> {</span>
<span id="cb37-5"><a href="system-description.html#cb37-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb37-6"><a href="system-description.html#cb37-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb37-7"><a href="system-description.html#cb37-7" tabindex="-1"></a>    direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span> <span class="co">// Extra parameter</span></span>
<span id="cb37-8"><a href="system-description.html#cb37-8" tabindex="-1"></a>  }</span>
<span id="cb37-9"><a href="system-description.html#cb37-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Like with <code>zero</code> and <code>one</code>, <code>direction</code> acts on the normalized values in <span class="math inline">\([0, 1]\)</span>. This means that we need to apply it in any transformations that use these values. For example, here’s an updated version of the <code>move</code> function:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb38-1"><a href="system-description.html#cb38-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb38-2"><a href="system-description.html#cb38-2" tabindex="-1"></a>  <span class="kw">let</span> { direction<span class="op">,</span> zero<span class="op">,</span> one } <span class="op">=</span> scale<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb38-3"><a href="system-description.html#cb38-3" tabindex="-1"></a>  zero <span class="op">+=</span> direction <span class="op">*</span> amount<span class="op">;</span></span>
<span id="cb38-4"><a href="system-description.html#cb38-4" tabindex="-1"></a>  one <span class="op">+=</span> direction <span class="op">*</span> amount<span class="op">;</span></span>
<span id="cb38-5"><a href="system-description.html#cb38-5" tabindex="-1"></a>}</span></code></pre></div>
<p>Likewise, the <code>pushforward</code>, <code>pullback</code>, and <code>expand</code> functions also need to take <code>direction</code> into account. Either way, with this functionality in place, it becomes trivial to flip or reverse a scale:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb39-1"><a href="system-description.html#cb39-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">flip</span>(scale<span class="op">:</span> Scale) {</span>
<span id="cb39-2"><a href="system-description.html#cb39-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">direction</span> <span class="op">-=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb39-3"><a href="system-description.html#cb39-3" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="multipliers" class="section level5 hasAnchor" number="4.1.7.5.3">
<h5><span class="header-section-number">4.1.7.5.3</span> Multipliers<a href="system-description.html#multipliers" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Finally, it may also be helpful to have the ability to shrink/expand the normalized values by some constant without having to modify properties of either the <code>domain</code> or <code>codomain</code>. Again, this could be done by using the <code>zero</code> and <code>one</code> properties, however, it’s better to define explicit properties instead. Specifically, we can add <em>two</em> additional parameters:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb40-1"><a href="system-description.html#cb40-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb40-2"><a href="system-description.html#cb40-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb40-3"><a href="system-description.html#cb40-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb40-4"><a href="system-description.html#cb40-4" tabindex="-1"></a>  props<span class="op">:</span> {</span>
<span id="cb40-5"><a href="system-description.html#cb40-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb40-6"><a href="system-description.html#cb40-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb40-7"><a href="system-description.html#cb40-7" tabindex="-1"></a>    direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb40-8"><a href="system-description.html#cb40-8" tabindex="-1"></a>    scale<span class="op">:</span> <span class="dt">number</span> <span class="co">// Extra parameter</span></span>
<span id="cb40-9"><a href="system-description.html#cb40-9" tabindex="-1"></a>    mult<span class="op">:</span> <span class="dt">number</span> <span class="co">// And another one</span></span>
<span id="cb40-10"><a href="system-description.html#cb40-10" tabindex="-1"></a>  }</span>
<span id="cb40-11"><a href="system-description.html#cb40-11" tabindex="-1"></a>}</span></code></pre></div>
<p>The reason why we want two multiplier parameters instead of just a single one is that there are different reasons for why we may want to multiply values by some constant. Firstly, we may want to multiply the values by some constant value that remains static throughout the lifetime of the program/visualization. That is the job of the <code>scale</code> parameter. Conversely, we may want to also dynamically manipulate the constant by which the values are multiplied. That is what <code>mult</code> is for. Having two multipliers makes it easier to reason about the scale’s behavior, as well as to apply changes such as restoring to defaults.</p>
<p>A good example of this is the barplot. In a typical barplot, all bars have the same width, and this bar width is some fraction of the width of the entire plotting region. Clearly, this fraction needs to depend on the number of bars in the plot, such that, with <span class="math inline">\(k\)</span> categories/bars, the bar width will be proportional to <span class="math inline">\(k\)</span>. However, we may also want to be able to make the bars wider/narrower interactively, e.g. by pressing the <code>+\-</code> keys. Thus, the width of the bars is proportional to <span class="math inline">\(c \cdot k\)</span> where <span class="math inline">\(k\)</span> is the static part of the constant (<code>scale</code>) and <span class="math inline">\(c\)</span> is the dynamic part of the constant (<code>mult</code>).</p>
<p>We apply the constant to the normalized value each time we push/pull a value through a scale:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb41-1"><a href="system-description.html#cb41-1" tabindex="-1"></a><span class="co">// This will be included in the body of pushforward(); see below for full example</span></span>
<span id="cb41-2"><a href="system-description.html#cb41-2" tabindex="-1"></a><span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)</span>
<span id="cb41-3"><a href="system-description.html#cb41-3" tabindex="-1"></a>normalized <span class="op">=</span> normalized <span class="op">*</span> scale <span class="op">*</span> mult</span></code></pre></div>
<p>Finally, we could hypothetically extend this idea of multipliers further and have an entire array of different multipliers, that would be reduced into a single constant each time we pushed a value through a scale. However, I found that having two, <code>scale</code> and <code>mult</code>, was enough to solve all of my scaling problems. Additionally, having an array of multipliers might make the scaling functions slightly less performant, if we have to reduce the array each time we <code>pushforward</code>/<code>pullback</code>, or it might make keeping track of the state of the <code>Scale</code> object slightly more complicated, if we roll these multipliers into one constant each time we update the array. We also lose the semantic distinction that we have with <code>scale</code> and <code>mult</code>. This might be a perfectly fine trade-off if our scales require more multipliers, however, I did not find this to be the case in my implementation.</p>
</div>
<div id="the-full-monty" class="section level5 hasAnchor" number="4.1.7.5.4">
<h5><span class="header-section-number">4.1.7.5.4</span> The Full Monty<a href="system-description.html#the-full-monty" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>With all of the pieces in place, we can put together the full implementation of the <code>pushforward</code> function.</p>
<p>It may be helpful to define two helper function for applying the <code>Scale</code> properties to a normalized value. First, the <code>applyDirection</code> function simply applies the <code>direction</code> property, such that <code>applyDirection(x, 1)</code> is simply the identity whereas <code>applyDirection(x, -1)</code> returns <code>1 - x</code> (i.e. moving from <code>one</code> down):</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb42-1"><a href="system-description.html#cb42-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyDirection</span>(x<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb42-2"><a href="system-description.html#cb42-2" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> direction) <span class="op">+</span> direction <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb42-3"><a href="system-description.html#cb42-3" tabindex="-1"></a>}</span>
<span id="cb42-4"><a href="system-description.html#cb42-4" tabindex="-1"></a></span>
<span id="cb42-5"><a href="system-description.html#cb42-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">0.75</span><span class="op">,</span> <span class="dv">1</span>))</span>
<span id="cb42-6"><a href="system-description.html#cb42-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">0.75</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb42-7"><a href="system-description.html#cb42-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">1.25</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 0.75
## 0.25
## -0.25</code></pre>
<p>Second, we can define the <code>applyPropsForward</code> function which takes a normalized value and applies all of the <code>Scale</code> properties to it:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb44-1"><a href="system-description.html#cb44-1" tabindex="-1"></a><span class="kw">type</span> Props <span class="op">=</span> {</span>
<span id="cb44-2"><a href="system-description.html#cb44-2" tabindex="-1"></a>  zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb44-3"><a href="system-description.html#cb44-3" tabindex="-1"></a>  one<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb44-4"><a href="system-description.html#cb44-4" tabindex="-1"></a>  direction<span class="op">:</span> <span class="op">-</span><span class="dv">1</span> <span class="op">|</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb44-5"><a href="system-description.html#cb44-5" tabindex="-1"></a>  scale<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb44-6"><a href="system-description.html#cb44-6" tabindex="-1"></a>  mult<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb44-7"><a href="system-description.html#cb44-7" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb44-8"><a href="system-description.html#cb44-8" tabindex="-1"></a></span>
<span id="cb44-9"><a href="system-description.html#cb44-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyPropsForward</span>(x<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> props<span class="op">:</span> Props) {</span>
<span id="cb44-10"><a href="system-description.html#cb44-10" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">,</span> one<span class="op">,</span> direction<span class="op">,</span> scale<span class="op">,</span> mult } <span class="op">=</span> props<span class="op">;</span></span>
<span id="cb44-11"><a href="system-description.html#cb44-11" tabindex="-1"></a>  x <span class="op">=</span> x <span class="op">*</span> scale <span class="op">*</span> mult<span class="op">;</span></span>
<span id="cb44-12"><a href="system-description.html#cb44-12" tabindex="-1"></a>  x <span class="op">=</span> zero <span class="op">+</span> x <span class="op">*</span> (one <span class="op">-</span> zero)<span class="op">;</span></span>
<span id="cb44-13"><a href="system-description.html#cb44-13" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">applyDirection</span>(x<span class="op">,</span> direction)<span class="op">;</span></span>
<span id="cb44-14"><a href="system-description.html#cb44-14" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we ready to define the full <code>pushforward</code> function. As one final note, we should probably be able to handle the case where the <code>domain</code> and <code>codomain</code> work on arrays of values rather than scalars (this can be helpful, for example, in the case of a parallel coordinates plot). As such, we can add an <code>if</code> block to check where the normalized value is an array and handle appropriately. In total:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb45-1"><a href="system-description.html#cb45-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>T <span class="kw">extends</span> Expanse<span class="op">,</span> U <span class="kw">extends</span> Expanse<span class="op">&gt;</span>(</span>
<span id="cb45-2"><a href="system-description.html#cb45-2" tabindex="-1"></a>  scale<span class="op">:</span> Scale<span class="op">&lt;</span>T<span class="op">,</span> U<span class="op">&gt;,</span></span>
<span id="cb45-3"><a href="system-description.html#cb45-3" tabindex="-1"></a>  value<span class="op">:</span> Expanse<span class="op">.</span><span class="at">Value</span><span class="op">&lt;</span>T<span class="op">&gt;,</span></span>
<span id="cb45-4"><a href="system-description.html#cb45-4" tabindex="-1"></a>)<span class="op">:</span> Expanse<span class="op">.</span><span class="at">Value</span><span class="op">&lt;</span>U<span class="op">&gt;</span> {</span>
<span id="cb45-5"><a href="system-description.html#cb45-5" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> props } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb45-6"><a href="system-description.html#cb45-6" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb45-7"><a href="system-description.html#cb45-7" tabindex="-1"></a></span>
<span id="cb45-8"><a href="system-description.html#cb45-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(normalized)) {</span>
<span id="cb45-9"><a href="system-description.html#cb45-9" tabindex="-1"></a>    normalized <span class="op">=</span> normalized<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> <span class="fu">applyPropsForward</span>(x<span class="op">,</span> props))<span class="op">;</span></span>
<span id="cb45-10"><a href="system-description.html#cb45-10" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb45-11"><a href="system-description.html#cb45-11" tabindex="-1"></a>    normalized <span class="op">=</span> <span class="fu">applyPropsForward</span>(normalized<span class="op">,</span> props)<span class="op">;</span></span>
<span id="cb45-12"><a href="system-description.html#cb45-12" tabindex="-1"></a>  }</span>
<span id="cb45-13"><a href="system-description.html#cb45-13" tabindex="-1"></a></span>
<span id="cb45-14"><a href="system-description.html#cb45-14" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)<span class="op">;</span></span>
<span id="cb45-15"><a href="system-description.html#cb45-15" tabindex="-1"></a>}</span></code></pre></div>
<p>This is the full definition of the <code>pushforward</code> function in <code>plotscape</code> as of 2024-10-17. The implementation for <code>pullback</code> function is very similar, with the only differences being that the order of the <code>domain</code> and <code>codomain</code> arguments reversed, and it uses the <code>applyPropsBackward</code> function.</p>
</div>
</div>
</div>
<div id="expanses" class="section level3 hasAnchor" number="4.1.8">
<h3><span class="header-section-number">4.1.8</span> Expanses<a href="system-description.html#expanses" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As was hinted at in the previous section, expanses map values between their domain and the interval <span class="math inline">\([0, 1]\)</span>. To do this, they are equipped with two familiar functions:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(\color{indianred}{n: X \to [0, 1]}\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(\color{steelblue}{u: [0, 1] \to X}\)</span></li>
</ul>
<p>foo</p>
<p>Or, in code:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb46-1"><a href="system-description.html#cb46-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span><span class="op">&lt;</span>X<span class="op">&gt;</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>X<span class="op">&gt;,</span> value<span class="op">:</span> X)<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb46-2"><a href="system-description.html#cb46-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">unnnormalize</span><span class="op">&lt;</span>X<span class="op">&gt;</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>X<span class="op">&gt;,</span> value<span class="op">:</span> <span class="dt">number</span>)<span class="op">:</span> X</span></code></pre></div>
<p>Notice that, whereas before we had considered <em>normalize</em> as mapping between <span class="math inline">\(D \to [0, 1]\)</span> and <em>unnormalize</em> as mapping between <span class="math inline">\([0, 1] \to V\)</span>, we now consider both as mapping between <span class="math inline">\([0, 1]\)</span> and an arbitrary domain <span class="math inline">\(X\)</span>. This domain can represent the data or the visual attribute - the expanse is agnostic about this.</p>
<p>Also, while before we have discussed domains as subsets of <span class="math inline">\(\mathbb{R}\)</span>, we can now start thinking about them as arbitrary sets. While subsets of <span class="math inline">\(\mathbb{R}\)</span> and sets of strings are really the only types of domains used in <code>plotscaper</code>, the model should readily extends to other sets, as long as a mapping to and from <span class="math inline">\([0, 1]\)</span> can be provided.</p>
<p>How <code>normalize</code> and <code>unnormalize</code> are implemented will depend largely on the subtype of <code>Expanse</code>, as well as on the desired behavior. For example, as will be discussed later, in <code>plotscaper</code>, the normalize and unnormalize methods implemented for <code>ExpanseContinuous</code> (subtype of <code>Expanse&lt;number&gt;</code>) work largely the same way as in section [SECTION]. However, while <code>ExpansePoint</code> and <code>ExpanseBand</code> are both subtypes of <code>Expanse&lt;string&gt;</code>, they behave differently - <code>ExpansePoint</code> maps strings (factor levels) to equidistant points along <span class="math inline">\([0, 1]\)</span>, whereas <code>ExpanseBand</code> maps the strings into the middle of “buckets” along <span class="math inline">\([0, 1]\)</span>.</p>
<p>However, there is also some behavior that we may want to apply the same way across the different expanse subtypes. For example, it seems reasonable that the user should be able to zoom, pan, or reverse axes, regardless of whether a plot shows discrete or continuous data. As such, there may be some properties and functions common to the <code>Expanse</code> type. I will discuss these first.</p>
<div id="zero-and-one-1" class="section level4 hasAnchor" number="4.1.8.1">
<h4><span class="header-section-number">4.1.8.1</span> Zero and one<a href="system-description.html#zero-and-one-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The maps may also take in and return values outside of <span class="math inline">\(D^*\)</span> and <span class="math inline">\([0, 1]\)</span>, if adjustments have been made. For instance, in most data visualization packages, x- and y-axis limits are by default expanded some percentage beyond the range of the observed data to avoid the maximum and minimum datapoints from overlapping with the limits. For example, in base R:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="system-description.html#cb47-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb47-2"><a href="system-description.html#cb47-2" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb47-3"><a href="system-description.html#cb47-3" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">5</span>)</span>
<span id="cb47-4"><a href="system-description.html#cb47-4" tabindex="-1"></a></span>
<span id="cb47-5"><a href="system-description.html#cb47-5" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb47-6"><a href="system-description.html#cb47-6" tabindex="-1"></a><span class="fu">plot</span>(x, y) </span>
<span id="cb47-7"><a href="system-description.html#cb47-7" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">xaxs =</span> <span class="st">&#39;i&#39;</span>, <span class="at">yaxs =</span> <span class="st">&#39;i&#39;</span>) </span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-38"></span>
<img src="_main_files/figure-html/unnamed-chunk-38-1.png" alt="Expanding axes. By default, axes in base R `plot()` function are expanded 4% beyond the range of the data (left). Otherwise, datapoints on the limits of their respective scales end up overlapping with the plot borders (right)." width="672" />
<p class="caption">
Figure 4.1: Expanding axes. By default, axes in base R <code>plot()</code> function are expanded 4% beyond the range of the data (left). Otherwise, datapoints on the limits of their respective scales end up overlapping with the plot borders (right).
</p>
</div>
<p>Thus, upon normalizing the minimum and maximum data values, the expanse should return values other than <span class="math inline">\(\{0, 1\}\)</span>. Likewise, to support user interactions such as zooming and panning, the expanses may accept and return values outside of <span class="math inline">\(D^*\)</span> and <span class="math inline">\([0, 1]\)</span>.</p>
<p>Zooming and panning should be orthogonal to the underlying data type, such that user can interact with the plots the same way<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>, no matter whether their axes are continuous, discrete, or some combination of the two. To this end, I introduce two parameters representing the normalized value (<span class="math inline">\(p\)</span>) of the minimum and maximum data point, called <em>zero</em> and <em>one</em> respectively. These parameters are agnostic to the underlying data type, such that if we have the data type-specific maps <span class="math inline">\(n&#39;\)</span> and <span class="math inline">\(u&#39;\)</span>, the complete normalize and unnormalize maps are:</p>
<p><span class="math display">\[n(d) = \text{zero} + n&#39;(d) \cdot (\text{one} - \text{zero})\]</span>
<span class="math display">\[u(p) = u&#39; \bigg(\frac{p - \text{zero}}{\text{one} - \text{zero}} \bigg)\]</span></p>
<p>To simplify, here’s what effect setting the two parameters to specific values has:</p>
<table>
<colgroup>
<col width="6%" />
<col width="5%" />
<col width="88%" />
</colgroup>
<thead>
<tr class="header">
<th align="right">Zero</th>
<th align="right">One</th>
<th align="left">Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.05</td>
<td align="right">0.95</td>
<td align="left">Expands the margins by ~5% (actually 5.555…% since 0.05 / 0.9 = 0.0555…)</td>
</tr>
<tr class="even">
<td align="right">0.05</td>
<td align="right">1.05</td>
<td align="left">Shifts the expanse ‘up’ by 5% (e.g. moves x-axis 5% right)</td>
</tr>
<tr class="odd">
<td align="right">-0.50</td>
<td align="right">1.50</td>
<td align="left">Zooms into the middle 50% of the expanse (25 percentile goes to 0 and 75th to one)</td>
</tr>
</tbody>
</table>
</div>
<div id="expanse-interface" class="section level4 hasAnchor" number="4.1.8.2">
<h4><span class="header-section-number">4.1.8.2</span> Expanse Interface<a href="system-description.html#expanse-interface" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>There are also other behaviours that expanses should support. For instance, we may want to be able to reset the expanse to defaults, retrain when the underlying data changes, and return nicely formatted breaks. How these behaviours are implemented, as well as other types of behavior, may be specific to the underlying data type. Overall, expanse interface may look something like this:</p>
<pre><code>interface Expanse&lt;T&gt; {
  normalize(value: T): number
  unnormalize(value: number): T
  defaultize(): this
  
  setZero(zero: number, default: boolean): this
  setOne(one: number, default: boolean): this
  freezeZero(): this
  freezeOne(): this
  
  move(amount: number): this
  expand(zero: number, one: number): this
  
  retrain(values: T[]): this
  breaks(n?: number): T[]  
}</code></pre>
</div>
<div id="continuous-expanses" class="section level4 hasAnchor" number="4.1.8.3">
<h4><span class="header-section-number">4.1.8.3</span> Continuous Expanses<a href="system-description.html#continuous-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The continuous expanse has as its underlying set <span class="math inline">\([\min, \max] \subseteq \mathbb{R}\)</span>. To understand how it works, let’s build it step by step.</p>
<p>We start with the basic normalizing function:</p>
<ol style="list-style-type: decimal">
<li><span class="math display">\[n(d) = \frac{d - \min}{\max - \min}\]</span></li>
</ol>
<p>This function takes some data value <span class="math inline">\(d \in [\min, \max]\)</span> and transforms it to <span class="math inline">\([0, 1]\)</span>. Most data visualization systems use a function like this at some step of the scaling processs - see <a href="https://github.com/r-lib/scales/blob/84560bf54e02315477a05384ee67991e9e8fc52c/R/bounds.R#L85"><code>scales::rescale</code></a> and <strong>D3</strong> <a href="https://github.com/d3/d3-scale/blob/d6904a4bde09e16005e0ad8ca3e25b10ce54fa0d/src/continuous.js#L122"><code>normalize</code></a>.</p>
<p>This may work well for typical linear scales. However, we may also want to apply some transformation <span class="math inline">\(f\)</span>, such as square root or log. Then, to ensure that the observed data values still get normalized to <span class="math inline">\([0, 1]\)</span>, we need to apply the transformation to both <span class="math inline">\(d\)</span> and the limits:</p>
<ol start="2" style="list-style-type: decimal">
<li><span class="math display">\[\frac{f(d) - f(\min)}{f(\max) - f(\min)}\]</span></li>
</ol>
<p>Finally, as was discussed in <a href="system-description.html#expanses">EXPANSES</a>, we want to be able to incorporate the zero and one paramaters, leading to the final normalizing function:</p>
<p><span class="math display">\[n(d) = \text{zero} + \frac{f(d) - f(\min)}{f(\max) - f(\min)} \cdot (\text{zero} - \text{one})\]</span></p>
<p>To obtain the unnormalizing function, we can simply invert the normalizing function:</p>
<p><span class="math display">\[u(p) = f^{-1} \bigg\{ f(\min) + \frac{p - \text{zero}}{\text{one} - \text{zero}} \cdot \big[ f(\max) - f(\min) \big] \bigg\}\]</span></p>
<p>The function transforms <span class="math inline">\(x\)</span> to a percentage value <span class="math inline">\(p \in [0, 1]\)</span>, provided <span class="math inline">\(x\)</span> is within <span class="math inline">\([\min, \max]\)</span>. The value <span class="math inline">\((\max - \min)\)</span> is also sometimes called the <em>range</em> (not to be confused with <strong>D3</strong> <code>range</code>).</p>
<p>We can invert the normalizing function and obtain the unnormalizing function, which is, for some percentage <span class="math inline">\(p \in [0, 1]\)</span>:</p>
<p><span class="math display">\[u(p) = \min + p \cdot (\max - \min)\]</span>
returns a value within the <span class="math inline">\([\min, \max]\)</span> range, corresponding to the proportion of the maximum possible distance (range) from the origin (<span class="math inline">\(\min\)</span>). For example, <span class="math inline">\(u(0.5)\)</span>, returns a value that is located halfway between the limits.</p>
<p>We can implement a simple continuous expanse like so:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb49-1"><a href="system-description.html#cb49-1" tabindex="-1"></a></span>
<span id="cb49-2"><a href="system-description.html#cb49-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">identity</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> T) {</span>
<span id="cb49-3"><a href="system-description.html#cb49-3" tabindex="-1"></a>  <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb49-4"><a href="system-description.html#cb49-4" tabindex="-1"></a>}</span>
<span id="cb49-5"><a href="system-description.html#cb49-5" tabindex="-1"></a></span>
<span id="cb49-6"><a href="system-description.html#cb49-6" tabindex="-1"></a><span class="kw">function</span> <span class="fu">expanseContinuous</span>(min <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> max <span class="op">=</span> <span class="dv">1</span>) {</span>
<span id="cb49-7"><a href="system-description.html#cb49-7" tabindex="-1"></a>  <span class="kw">const</span> [zero<span class="op">,</span> one] <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]</span>
<span id="cb49-8"><a href="system-description.html#cb49-8" tabindex="-1"></a>  <span class="kw">const</span> [trans<span class="op">,</span> inv] <span class="op">=</span> [identity<span class="op">,</span> identity]</span>
<span id="cb49-9"><a href="system-description.html#cb49-9" tabindex="-1"></a>  </span>
<span id="cb49-10"><a href="system-description.html#cb49-10" tabindex="-1"></a>  <span class="cf">return</span> { min<span class="op">,</span> max<span class="op">,</span> zero<span class="op">,</span> one<span class="op">,</span> trans<span class="op">,</span> inv<span class="op">,</span></span>
<span id="cb49-11"><a href="system-description.html#cb49-11" tabindex="-1"></a>    <span class="fu">range</span>() {</span>
<span id="cb49-12"><a href="system-description.html#cb49-12" tabindex="-1"></a>      <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">max</span> <span class="op">-</span> <span class="kw">this</span><span class="op">.</span><span class="at">min</span><span class="op">;</span></span>
<span id="cb49-13"><a href="system-description.html#cb49-13" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb49-14"><a href="system-description.html#cb49-14" tabindex="-1"></a>    <span class="fu">transRange</span>() {</span>
<span id="cb49-15"><a href="system-description.html#cb49-15" tabindex="-1"></a>      <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> trans } <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb49-16"><a href="system-description.html#cb49-16" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min)<span class="op">;</span></span>
<span id="cb49-17"><a href="system-description.html#cb49-17" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb49-18"><a href="system-description.html#cb49-18" tabindex="-1"></a>    <span class="fu">normalize</span>(x<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb49-19"><a href="system-description.html#cb49-19" tabindex="-1"></a>      <span class="kw">const</span> { min<span class="op">,</span> zero<span class="op">,</span> one<span class="op">,</span> trans } <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb49-20"><a href="system-description.html#cb49-20" tabindex="-1"></a>      <span class="kw">const</span> normalized <span class="op">=</span> (<span class="fu">trans</span>(x) <span class="op">-</span> <span class="fu">trans</span>(min)) <span class="op">/</span> <span class="kw">this</span><span class="op">.</span><span class="fu">transRange</span>()<span class="op">;</span></span>
<span id="cb49-21"><a href="system-description.html#cb49-21" tabindex="-1"></a>      <span class="cf">return</span> zero <span class="op">+</span> normalized <span class="op">*</span> (one <span class="op">-</span> zero)<span class="op">;</span></span>
<span id="cb49-22"><a href="system-description.html#cb49-22" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb49-23"><a href="system-description.html#cb49-23" tabindex="-1"></a>    <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb49-24"><a href="system-description.html#cb49-24" tabindex="-1"></a>      <span class="kw">const</span> { min<span class="op">,</span> zero<span class="op">,</span> one<span class="op">,</span> trans<span class="op">,</span> inv } <span class="op">=</span> <span class="kw">this</span><span class="op">;</span></span>
<span id="cb49-25"><a href="system-description.html#cb49-25" tabindex="-1"></a>      <span class="cf">return</span> <span class="fu">inv</span>(<span class="fu">trans</span>(min) <span class="op">+</span> ((p <span class="op">-</span> zero) <span class="op">/</span> (one <span class="op">-</span> zero)) <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="fu">transRange</span>())<span class="op">;</span></span>
<span id="cb49-26"><a href="system-description.html#cb49-26" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb49-27"><a href="system-description.html#cb49-27" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb49-28"><a href="system-description.html#cb49-28" tabindex="-1"></a>}</span>
<span id="cb49-29"><a href="system-description.html#cb49-29" tabindex="-1"></a></span>
<span id="cb49-30"><a href="system-description.html#cb49-30" tabindex="-1"></a><span class="kw">const</span> expanse1 <span class="op">=</span> <span class="fu">expanseContinuous</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb49-31"><a href="system-description.html#cb49-31" tabindex="-1"></a></span>
<span id="cb49-32"><a href="system-description.html#cb49-32" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(expanse1<span class="op">.</span><span class="fu">normalize</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb49-33"><a href="system-description.html#cb49-33" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(expanse1<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.5</span>))</span></code></pre></div>
<pre><code>## 0.4444444444444444
## 5.5</code></pre>
<p>The functions <span class="math inline">\(n, u\)</span> have several interesting properties. First off, they are inverses to each other and form an <em>isomorphism</em>, i.e. <span class="math inline">\(u = n^{-1}\)</span> and <span class="math inline">\(n = u^{-1}\)</span> such that <span class="math inline">\(u(n(x)) = x\)</span> and <span class="math inline">\(n(u(p)) = p\)</span>. This also means that each function is a 1-to-1 mapping or <em>bijection</em>. In plain words, this means that we cannot get the same percentage by normalizing two different values and vice versa. As a result, we can keep switching between the normalized and unnormalized representations without losing any information:</p>
<!-- ```{r} -->
<!-- with(expanse, unnormalize(normalize(5))) -->
<!-- with(expanse, normalize(unnormalize(normalize(unnormalize(0.5))))) -->
<!-- ``` -->
<div id="linearity" class="section level5 hasAnchor" number="4.1.8.3.1">
<h5><span class="header-section-number">4.1.8.3.1</span> Linearity<a href="system-description.html#linearity" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Another important thing to note is that, while these types of normalizing functions are often called “linear” (e.g. <code>scaleLinear()</code> in <strong>D3</strong>), since their graphs form a straight line, they should not be confused with “linear functions”, since they do not satisfy the properties of linear functions, namely:</p>
<ul>
<li>Additivity: <span class="math inline">\(\text{normalize}(x + c) \neq \text{normalize}(x) + \text{normalize}(c)\)</span></li>
<li>Homogeneity of degree 1: <span class="math inline">\(\text{normalize}(c \cdot x) \neq c \cdot \text{normalize(x)}\)</span>.</li>
</ul>
<p>To illustrate, additivity does not hold when <span class="math inline">\(\min \neq 0\)</span> because:</p>
<p><span class="math display">\[\frac{(x + c) - \min}{(\max - \min)}\]</span>
<span class="math display">\[= \frac{x - \min}{\max - \min} + \frac{c}{\max - \min}\]</span>
<span class="math display">\[\neq \frac{x - \min}{\max - min} + \frac{c - \min}{\max - \min}\]</span></p>
<p>The same can be easily shown for the <span class="math inline">\(\text{unnormalize}\)</span> map and for homogeneity.</p>
<p>Technically, this is due to a confusion between the definition of a “linear function” and a “linear polynomial”. The appropriate term to use would actually be “affine transformation.”</p>
<p>Either way, if the minimum is not 0, we cannot expect the following to be equal:</p>
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(3) + normalize(2))) -->
<!-- ``` -->
<p>Or the following to be equal:</p>
<!-- ```{r} -->
<!-- with(expanse, c(normalize(2 * 5), 2 * normalize(5))) -->
<!-- ``` -->
<p>However, if we keep in mind the fact that the normalizing function calculates the proportion of distance from the origin, we can see that the function in fact behaves linearly within the context of its limits.</p>
<p>For example, consider the range <span class="math inline">\([1, 10]\)</span>. The value <span class="math inline">\(5\)</span> is <span class="math inline">\(4\)</span> units away from the lower limit, i.e. <span class="math inline">\(5 - 1 = 4\)</span>, so we can represent it, for example, as the sum of a value that is 3 units away and another that is one unit away, <span class="math inline">\(n(5) = n(4) + n(2)\)</span>:</p>
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(4) + normalize(2))) -->
<!-- ``` -->
<p>Likewise, again because <span class="math inline">\(5\)</span> represents the distance of <span class="math inline">\(4\)</span> units and <span class="math inline">\(3\)</span> of <span class="math inline">\(2\)</span>, we can expect <span class="math inline">\(n(5) = 2 \cdot n(3)\)</span>:</p>
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), 2 * normalize(3))) -->
<!-- ``` -->
</div>
<div id="transformations" class="section level5 hasAnchor" number="4.1.8.3.2">
<h5><span class="header-section-number">4.1.8.3.2</span> Transformations<a href="system-description.html#transformations" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>We can apply transformations to continuous expanses by transforming their limits. The outcome of this is that <span class="math inline">\(\min\)</span> and <span class="math inline">\(\max\)</span> still get mapped to <span class="math inline">\(0\)</span> and <span class="math inline">\(1\)</span> however, the graph of the function is no longer linear. Suppose we have non-linear function <span class="math inline">\(f\)</span>, along with an inverse <span class="math inline">\(f^{-1}\)</span>. Then:</p>
<p><span class="math display">\[n(x) = \frac{f(x) - f(\min)}{f(\max) - f(\min)}\]</span>
<span class="math display">\[u(p) = f^{-1} \bigg\{f(\min) + p \cdot \big[ f(\max) - f(\min) \big] \bigg\}\]</span>
For example, here’s how we could apply the transformation <span class="math inline">\(\bigg( f(x) = \sqrt{x}, \; f^{-1}(x) = x^2 \bigg)\)</span> in code:</p>
<!-- ```{r} -->
<!-- expanse$trans <- sqrt -->
<!-- expanse$inv <- function(x) x^2 -->
<!-- # Need to redefine normalize and unnormalize -->
<!-- expanse$trans_range <- function() with(expanse, trans(max) - trans(min)) -->
<!-- expanse$normalize <- function(x) { -->
<!--   with(expanse, (trans(x) - trans(min)) / trans_range()) -->
<!-- } -->
<!-- expanse$unnormalize <- function(p) { -->
<!--   with(expanse, inv(trans(min) + p * trans_range())) -->
<!-- } -->
<!-- # Normalizing limits still returns c(0, 1) -->
<!-- c(expanse$normalize(c(1, 10))) -->
<!-- # Notice that these return different values from before though -->
<!-- expanse$normalize(5) -->
<!-- expanse$unnormalize(0.5) -->
<!-- x <- seq(1, 10, length = 100) -->
<!-- p <- seq(0, 1, length = 100) -->
<!-- # The graphs are no longer linear -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(x, expanse$normalize(x), type = "l", ylab = "normalize(x)") -->
<!-- plot(p, expanse$unnormalize(p), type = "l", ylab = "unnormalize(p)") -->
<!-- ``` -->
<p>Transformations such as these can be useful in two ways. First, sometimes we may be able to better see trends in the data when the data has been appropriately transformed. This is the case, for example, when plotting data which varies across orders of magnitude. In this case it may be useful to apply <span class="math inline">\(\log\)</span>-transformation. Second, transformations can also be helpful in situations where some graphical attributes are not perceived linearly. For example, when judging differently sized objects, viewers tend judge magnitude based on area rather than side or radius. As such, when drawing objects such as points or squares it can be helpful to apply square root as the inverse transformation. The idea is that, if one point has a data value that is <span class="math inline">\(c\)</span> times bigger than another, it will have <span class="math inline">\(\sqrt{c}\)</span> times bigger radius and <span class="math inline">\(c\)</span> times bigger area. Note that we are talking about the inverse transformation here, i.e. the transformation affecting the unnormalizing function.</p>
<p>One thing to note is that the proportionality of the square-root transformation holds only when <span class="math inline">\(\min = 0\)</span>. Otherwise:</p>
<p><span class="math display">\[\sqrt{(\min)^2 + cp \cdot [(\max)^2 - (\min)^2]}\]</span>
<span class="math display">\[= \sqrt{c} \cdot \sqrt{(\min)^2/c + p \cdot [(\max)^2 - (\min)^2]}\]</span>
<span class="math display">\[\neq \sqrt{c} \cdot \sqrt{(\min)^2 + p \cdot [(\max)^2 - (\min)^2]}\]</span></p>
<p>This is a problem in the existing packages. For example:</p>
<!-- ```{r} -->
<!-- library(scales) -->
<!-- pal <- area_pal(c(1, 5))   -->
<!-- # Comparing cscale to naive implementation -->
<!-- all.equal(cscale(1:5, pal), sqrt((1:5 - 1) / 4) * 4 + 1) -->
<!-- # Should be equal since 3 is twice as far from 1 as 2 is -->
<!-- c(cscale(1:5, pal)[3] / cscale(1:5, pal)[2],  -->
<!--   sqrt(2)) -->
<!-- expanse$min <- 1 -->
<!-- expanse$max <- 5 -->
<!-- cscale(1:5, pal) -->
<!-- expanse$unnormalize(1:5 / 5) -->
<!-- expanse -->
<!-- plot(1:5, expanse$unnormalize(1:5 / 5)) -->
<!-- plot(1:5, cscale(1:5, pal)) -->
<!-- ``` -->
</div>
</div>
</div>
</div>
<div id="section" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> </h2>

</div>
</div>
<h3> References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bostock2011" class="csl-entry">
Bostock, Michael, Vadim Ogievetsky, and Jeffrey Heer. 2011. <span>“D<span class="math inline">\(^3\)</span> Data-Driven Documents.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 17 (12): 2301–9.
</div>
<div id="ref-fong2019" class="csl-entry">
Fong, Brendan, and David I Spivak. 2019. <em>An Invitation to Applied Category Theory: Seven Sketches in Compositionality</em>. Cambridge University Press.
</div>
<div id="ref-gray1997" class="csl-entry">
Gray, Jim, Surajit Chaudhuri, Adam Bosworth, Andrew Layman, Don Reichart, Murali Venkatrao, Frank Pellow, and Hamid Pirahesh. 1997. <span>“Data Cube: A Relational Aggregation Operator Generalizing Group-by, Cross-Tab, and Sub-Totals.”</span> <em>Data Mining and Knowledge Discovery</em> 1: 29–53.
</div>
<div id="ref-krzywinski2013" class="csl-entry">
Krzywinski, Martin. 2013. <span>“Axes, Ticks and Grids.”</span> <em>Nature Methods</em> 10 (February): 183. <a href="https://doi.org/10.1038/nmeth.2337">https://doi.org/10.1038/nmeth.2337</a>.
</div>
<div id="ref-lawvere2009" class="csl-entry">
Lawvere, F William, and Stephen H Schanuel. 2009. <em>Conceptual Mathematics: A First Introduction to Categories</em>. Cambridge University Press.
</div>
<div id="ref-michell1986" class="csl-entry">
Michell, Joel. 1986. <span>“Measurement Scales and Statistics: A Clash of Paradigms.”</span> <em>Psychological Bulletin</em> 100 (3): 398.
</div>
<div id="ref-murrell2005" class="csl-entry">
Murrell, Paul. 2005. <em>R Graphics</em>. Chapman; Hall/CRC.
</div>
<div id="ref-d3-scale2024" class="csl-entry">
Observable. 2024. <span>“D3-Scale <span><span class="math inline">\(\vert\)</span></span> D3 by Observable.”</span> <a href="https://d3js.org/d3-scale">https://d3js.org/d3-scale</a>.
</div>
<div id="ref-satyanarayan2015" class="csl-entry">
Satyanarayan, Arvind, Ryan Russell, Jane Hoffswell, and Jeffrey Heer. 2015. <span>“Reactive Vega: A Streaming Dataflow Architecture for Declarative Interactive Visualization.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 22 (1): 659–68.
</div>
<div id="ref-stevens1946" class="csl-entry">
Stevens, Stanley Smith. 1946. <span>“On the Theory of Scales of Measurement.”</span> <em>Science</em> 103 (2684): 677–80.
</div>
<div id="ref-wickham2013" class="csl-entry">
Wickham, Hadley. 2013. <span>“Bin-Summarise-Smooth: A Framework for Visualising Large Data.”</span> <em>Had. Co. Nz, Tech. Rep</em>.
</div>
<div id="ref-wickham2016" class="csl-entry">
———. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-wickham2023" class="csl-entry">
Wickham, Hadley, Thomas Lin Pedersen, and Dana Seidel. 2023. <em>Scales: Scale Functions for Visualization</em>. <a href="https://CRAN.R-project.org/package=scales">https://CRAN.R-project.org/package=scales</a>.
</div>
<div id="ref-wilkinson2012" class="csl-entry">
Wilkinson, Leland. 2012. <em>The Grammar of Graphics</em>. Springer.
</div>
<div id="ref-ziemkiewicz2009" class="csl-entry">
Ziemkiewicz, Caroline, and Robert Kosara. 2009. <span>“Embedding Information Visualization Within Visual Representation.”</span> In <em>Advances in Information and Intelligent Systems</em>, 307–26. Springer.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>The one exception may be panning barplots and histograms, where the y-axis upper y-axis limit may change but the lower should be fixed at 0, such that panning may shrink or stretch the bars, but not “lift” them up or move them down.<a href="system-description.html#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="design.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="glossary.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
