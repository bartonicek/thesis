<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>4 System description | Fluent Graphics</title>
  <meta name="description" content="4 System description | Fluent Graphics" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="4 System description | Fluent Graphics" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 System description | Fluent Graphics" />
  
  
  

<meta name="author" content="Adam Bartonicek" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="high-level-design.html"/>
<link rel="next" href="glossary.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#brief-history-of-interactive-data-visualization"><i class="fa fa-check"></i><b>2.1</b> Brief history of interactive data visualization</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="introduction.html"><a href="introduction.html#early-interactive-data-visualization-by-statisticians-for-statisticians"><i class="fa fa-check"></i><b>2.1.1</b> Early interactive data visualization: By statisticians for statisticians</a></li>
<li class="chapter" data-level="2.1.2" data-path="introduction.html"><a href="introduction.html#interactive-data-visualization-and-the-web-world-wide-interactivity"><i class="fa fa-check"></i><b>2.1.2</b> Interactive data visualization and the Web: World-wide interactivity</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#what-is-interactive-visualization"><i class="fa fa-check"></i><b>2.2</b> What even is interactive data visualization?</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="introduction.html"><a href="introduction.html#interactive-vs.-interacting-with"><i class="fa fa-check"></i><b>2.2.1</b> Interactive vs. interacting with</a></li>
<li class="chapter" data-level="2.2.2" data-path="introduction.html"><a href="introduction.html#what-counts-as-interactive-enough"><i class="fa fa-check"></i><b>2.2.2</b> What counts as “interactive enough”?</a></li>
<li class="chapter" data-level="2.2.3" data-path="introduction.html"><a href="introduction.html#complexity-of-interactive-features"><i class="fa fa-check"></i><b>2.2.3</b> Complexity of interactive features</a></li>
<li class="chapter" data-level="2.2.4" data-path="introduction.html"><a href="introduction.html#working-definition"><i class="fa fa-check"></i><b>2.2.4</b> Working definition</a></li>
<li class="chapter" data-level="2.2.5" data-path="introduction.html"><a href="introduction.html#list-of-common-interactive-features"><i class="fa fa-check"></i><b>2.2.5</b> List of common interactive features</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#the-highlighting-problem"><i class="fa fa-check"></i><b>2.3</b> The highlighting problem</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="introduction.html"><a href="introduction.html#linked-selection-and-stacking"><i class="fa fa-check"></i><b>2.3.1</b> Linked selection and stacking</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#mathematical-theory"><i class="fa fa-check"></i><b>2.4</b> Mathematical theory</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="introduction.html"><a href="introduction.html#relations"><i class="fa fa-check"></i><b>2.4.1</b> Relations</a></li>
<li class="chapter" data-level="2.4.2" data-path="introduction.html"><a href="introduction.html#functions"><i class="fa fa-check"></i><b>2.4.2</b> Functions</a></li>
<li class="chapter" data-level="2.4.3" data-path="introduction.html"><a href="introduction.html#partitions"><i class="fa fa-check"></i><b>2.4.3</b> Partitions</a></li>
<li class="chapter" data-level="2.4.4" data-path="introduction.html"><a href="introduction.html#preorders"><i class="fa fa-check"></i><b>2.4.4</b> Preorders</a></li>
<li class="chapter" data-level="2.4.5" data-path="introduction.html"><a href="introduction.html#monoids"><i class="fa fa-check"></i><b>2.4.5</b> Monoids</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="introduction.html"><a href="introduction.html#theory-of-data-visualization-systems"><i class="fa fa-check"></i><b>2.5</b> Theory of data visualization systems</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="introduction.html"><a href="introduction.html#scales"><i class="fa fa-check"></i><b>2.5.1</b> Scales</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="high-level-design.html"><a href="high-level-design.html"><i class="fa fa-check"></i><b>3</b> High-level design</a>
<ul>
<li class="chapter" data-level="3.0.1" data-path="high-level-design.html"><a href="high-level-design.html#user-profile"><i class="fa fa-check"></i><b>3.0.1</b> User profile</a></li>
<li class="chapter" data-level="3.1" data-path="high-level-design.html"><a href="high-level-design.html#programming-paradigm"><i class="fa fa-check"></i><b>3.1</b> Programming paradigm</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="high-level-design.html"><a href="high-level-design.html#imperative-programming"><i class="fa fa-check"></i><b>3.1.1</b> Imperative programming</a></li>
<li class="chapter" data-level="3.1.2" data-path="high-level-design.html"><a href="high-level-design.html#functional-programming"><i class="fa fa-check"></i><b>3.1.2</b> Functional programming</a></li>
<li class="chapter" data-level="3.1.3" data-path="high-level-design.html"><a href="high-level-design.html#object-oriented-programming"><i class="fa fa-check"></i><b>3.1.3</b> Object oriented programming</a></li>
<li class="chapter" data-level="3.1.4" data-path="high-level-design.html"><a href="high-level-design.html#data-oriented-programming"><i class="fa fa-check"></i><b>3.1.4</b> Data oriented programming</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="high-level-design.html"><a href="high-level-design.html#reactivity"><i class="fa fa-check"></i><b>3.2</b> Reactivity</a></li>
<li class="chapter" data-level="3.3" data-path="high-level-design.html"><a href="high-level-design.html#row-based-or-column-based"><i class="fa fa-check"></i><b>3.3</b> Row-based or column-based</a></li>
<li class="chapter" data-level="3.4" data-path="high-level-design.html"><a href="high-level-design.html#rendering-engine"><i class="fa fa-check"></i><b>3.4</b> Rendering engine</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="system-description.html"><a href="system-description.html"><i class="fa fa-check"></i><b>4</b> System description</a>
<ul>
<li class="chapter" data-level="4.1" data-path="system-description.html"><a href="system-description.html#core-requirements"><i class="fa fa-check"></i><b>4.1</b> Core requirements</a></li>
<li class="chapter" data-level="4.2" data-path="system-description.html"><a href="system-description.html#components"><i class="fa fa-check"></i><b>4.2</b> Components</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="system-description.html"><a href="system-description.html#Indexable"><i class="fa fa-check"></i><b>4.2.1</b> Indexable</a></li>
<li class="chapter" data-level="4.2.2" data-path="system-description.html"><a href="system-description.html#Getter"><i class="fa fa-check"></i><b>4.2.2</b> Getter</a></li>
<li class="chapter" data-level="4.2.3" data-path="system-description.html"><a href="system-description.html#reactive"><i class="fa fa-check"></i><b>4.2.3</b> Reactive</a></li>
<li class="chapter" data-level="4.2.4" data-path="system-description.html"><a href="system-description.html#dataframe"><i class="fa fa-check"></i><b>4.2.4</b> Dataframe</a></li>
<li class="chapter" data-level="4.2.5" data-path="system-description.html"><a href="system-description.html#factor"><i class="fa fa-check"></i><b>4.2.5</b> Factor</a></li>
<li class="chapter" data-level="4.2.6" data-path="system-description.html"><a href="system-description.html#reducers"><i class="fa fa-check"></i><b>4.2.6</b> Reducers</a></li>
<li class="chapter" data-level="4.2.7" data-path="system-description.html"><a href="system-description.html#scales-1"><i class="fa fa-check"></i><b>4.2.7</b> Scales</a></li>
<li class="chapter" data-level="4.2.8" data-path="system-description.html"><a href="system-description.html#expanses"><i class="fa fa-check"></i><b>4.2.8</b> Expanses</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>5</b> Glossary</a></li>
<li class="chapter" data-level="6" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>6</b> Appendix</a></li>
<li class="chapter" data-level="7" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>7</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fluent Graphics</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="system-description" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">4</span> System description<a href="system-description.html#system-description" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This section contains a description of the concrete system implementation (<a href="https://github.com/bartonicek/plotscape">plotscape</a> and <a href="https://github.com/bartonicek/plotscaper">plotscaper</a>).</p>
<div id="core-requirements" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Core requirements<a href="system-description.html#core-requirements" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The system needs to be able to:</p>
<ul>
<li>Split the raw data into a hierarchy of parts</li>
<li>Compute summary statistics on the parts</li>
<li>Further transform these summaries in a way that respects the hierarchy (e.g. stacking, normalizing by parent values)</li>
<li>Translate these summaries into visual attributes such as x- and y-position, width, height, area,…</li>
<li>Render geometric objects based on the visual attributes</li>
<li>Do all of the above reactively, in response to user input</li>
</ul>
</div>
<div id="components" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Components<a href="system-description.html#components" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This section contains a detailed listing of the system’s components.</p>
<div id="Indexable" class="section level3 hasAnchor" number="4.2.1">
<h3><span class="header-section-number">4.2.1</span> Indexable<a href="system-description.html#Indexable" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As discussed in Section <a href="high-level-design.html#row-based-or-column-based">3.3</a>, when it comes to representing data, the column-based model offer several advantages over the row-based model. In this model, data is stored in a dictionary of contiguous arrays (as in, for example, a CSV file). Thus, the fundamental unit of data is the column, a fixed-length array of values.</p>
<p>However, at times, it may be useful to have additional flexibility. Specifically, it may be useful to include in our definition of a “column” not only fixed-length arrays but also constants and callbacks.
This is where the <code>Indexable&lt;T&gt;</code> type comes in. It represents a single “column” of data, and is just a union of three primitive types:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb1-1"><a href="system-description.html#cb1-1" tabindex="-1"></a>Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> T <span class="op">|</span> T[] <span class="op">|</span> ((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T)</span></code></pre></div>
<p>In plain words, an <code>Indexable&lt;T&gt;</code> can be one of three things: a constant of type <code>T</code>, an array of <code>T</code>, or a callback that takes an index and returns a <code>T</code>. To extract values from <code>Indexable&lt;T&gt;</code>, we use a generalized form of subsetting by an index, which is implemented differently for each type. First, if the value is an array, we subset it using the usual square bracket notation. Second, if the value is a constant, we always return it regardless of the index (we can think of the value as being repeated across all rows). Third and finally, if the value is a callback, then we call it with the index and simply take the returned value. A uniform interface for doing this generalized form of subsetting is provided by <a href="#Getters"><code>Getters</code></a>.</p>
<p>The advantage of the <code>Indexable&lt;T&gt;</code> type is that, while the raw data will typically come in the form of arrays, there are many places further down the data visualization pipeline where constants and callbacks are convenient. For example, in a typical barplot, the base of the y-axis is set to a constant value, typically zero. While we could hypothetically append a new array filled with zeros to the rendering data, it is more convenient and memory efficient to instead use a constant (<code>0</code>) or a thunk (<code>() =&gt; 0</code>). As another example, often, if we have an array of repeated values, it may be convenient to instead represent it as an array of underlying unique values and an array of indices (similar to R’s <code>factor</code> class). We can then use a callback which takes an index and returns a position in the array of unique values.</p>
</div>
<div id="Getter" class="section level3 hasAnchor" number="4.2.2">
<h3><span class="header-section-number">4.2.2</span> Getter<a href="system-description.html#Getter" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A <code>Getter&lt;T&gt;</code> is a function which takes an <a href="system-description.html#Indexable"><code>Indexable&lt;T&gt;</code></a> as an argument and returns a new function, which, when given an index, returns a value of type <code>T</code>. For illustration, here is a slightly simplified implementation:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb2-1"><a href="system-description.html#cb2-1" tabindex="-1"></a><span class="co">// Getter.ts</span></span>
<span id="cb2-2"><a href="system-description.html#cb2-2" tabindex="-1"></a><span class="im">export type</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> T<span class="op">;</span></span>
<span id="cb2-3"><a href="system-description.html#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="system-description.html#cb2-4" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">Getter</span> {</span>
<span id="cb2-5"><a href="system-description.html#cb2-5" tabindex="-1"></a>  <span class="co">// Constructor</span></span>
<span id="cb2-6"><a href="system-description.html#cb2-6" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="kw">of</span><span class="op">&lt;</span>T<span class="op">&gt;</span>(x<span class="op">:</span> Indexable<span class="op">&lt;</span>T<span class="op">&gt;</span>)<span class="op">:</span> Getter<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb2-7"><a href="system-description.html#cb2-7" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">typeof</span> x <span class="op">===</span> <span class="vs">`function`</span>) <span class="cf">return</span> x<span class="op">;</span></span>
<span id="cb2-8"><a href="system-description.html#cb2-8" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(x)) <span class="cf">return</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> x[index]<span class="op">;</span></span>
<span id="cb2-9"><a href="system-description.html#cb2-9" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">return</span> () <span class="kw">=&gt;</span> x</span>
<span id="cb2-10"><a href="system-description.html#cb2-10" tabindex="-1"></a>  }</span>
<span id="cb2-11"><a href="system-description.html#cb2-11" tabindex="-1"></a>}</span></code></pre></div>
<p>we can then create and use <code>Getter</code>s like so:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb3-1"><a href="system-description.html#cb3-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb3-2"><a href="system-description.html#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="system-description.html#cb3-3" tabindex="-1"></a><span class="kw">const</span> getter1 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>([<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb3-4"><a href="system-description.html#cb3-4" tabindex="-1"></a><span class="kw">const</span> getter2 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>(<span class="dv">99</span>)<span class="op">;</span></span>
<span id="cb3-5"><a href="system-description.html#cb3-5" tabindex="-1"></a><span class="kw">const</span> getter3 <span class="op">=</span> Getter<span class="op">.</span><span class="fu">of</span>((index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> index <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-6"><a href="system-description.html#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="system-description.html#cb3-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter1</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-8"><a href="system-description.html#cb3-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter2</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-9"><a href="system-description.html#cb3-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">getter3</span>(<span class="dv">0</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 1
## 99
## -1</code></pre>
<p>Note that, by definition, every <code>Getter&lt;T&gt;</code> is also automatically an <code>Indexable&lt;T&gt;</code> (since it is a callback <code>(index: number) =&gt; T</code>). This means that we can create new getters out of other getters.</p>
<p>The <code>Getter</code> namespace also includes several utility functions. One example is <code>Getter.constant</code> which takes in a value <code>T</code> and returns a thunk which always returns <code>T</code> (i.e. <code>() =&gt; T</code>). This is useful, for example, when <code>T</code> is an array and we always want to return the whole array and not just a single indexed element. Another utility function is <code>Getter.proxy</code>, which takes a <code>Getter</code> and an array of indices, and returns a new <code>Getter</code> which proxies the access to the original values through the array of indices:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb5-1"><a href="system-description.html#cb5-1" tabindex="-1"></a><span class="im">import</span> { Getter } <span class="im">from</span> <span class="st">&quot;./Getter&quot;</span></span>
<span id="cb5-2"><a href="system-description.html#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="system-description.html#cb5-3" tabindex="-1"></a><span class="kw">const</span> proxyGetter <span class="op">=</span> Getter<span class="op">.</span><span class="fu">proxy</span>([<span class="vs">`A`</span><span class="op">,</span> <span class="vs">`B`</span><span class="op">,</span> <span class="vs">`C`</span>]<span class="op">,</span> [<span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb5-4"><a href="system-description.html#cb5-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">.</span><span class="fu">map</span>(proxyGetter))</span></code></pre></div>
<pre><code>## [ &quot;C&quot;, &quot;B&quot;, &quot;B&quot;, &quot;A&quot;, &quot;A&quot;, &quot;A&quot; ]</code></pre>
<p>The <code>Getter.proxy</code> function becomes particularly useful when implementing <code>Factor</code>s.</p>
</div>
<div id="reactive" class="section level3 hasAnchor" number="4.2.3">
<h3><span class="header-section-number">4.2.3</span> Reactive<a href="system-description.html#reactive" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><code>Reactive</code> is a fundamental mixin that is used throughout the system. It is essentially just an implementation of the Observer/EventEmitter pattern.</p>
</div>
<div id="dataframe" class="section level3 hasAnchor" number="4.2.4">
<h3><span class="header-section-number">4.2.4</span> Dataframe<a href="system-description.html#dataframe" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Another fundamental data structure is a <code>Dataframe</code>. A <code>Dataframe</code> is just a record of <a href="system-description.html#Indexable"><code>Indexable</code></a> values:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb7-1"><a href="system-description.html#cb7-1" tabindex="-1"></a><span class="kw">interface</span> Dataframe {</span>
<span id="cb7-2"><a href="system-description.html#cb7-2" tabindex="-1"></a>  [key<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">symbol</span>]<span class="op">:</span> Indexable</span>
<span id="cb7-3"><a href="system-description.html#cb7-3" tabindex="-1"></a>}</span></code></pre></div>
<p>In this way, a <code>Dataframe</code> is essentially just a <a href="glossary.html#SoA">SoA</a> with a bit of extra flexibility. Specifically, while in typical SoA data structures, all properties are usually arrays, in <code>Dataframe</code> they are instances of the <code>Indexable</code> type, so they may also be constants or functions. For example, the following is a valid instance of a <code>Dataframe</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb8-1"><a href="system-description.html#cb8-1" tabindex="-1"></a><span class="kw">const</span> data<span class="op">:</span> Dataframe <span class="op">=</span> {</span>
<span id="cb8-2"><a href="system-description.html#cb8-2" tabindex="-1"></a>  name<span class="op">:</span> [<span class="vs">`foo`</span><span class="op">,</span> <span class="vs">`bar`</span><span class="op">,</span> <span class="vs">`baz`</span>]<span class="op">,</span></span>
<span id="cb8-3"><a href="system-description.html#cb8-3" tabindex="-1"></a>  age<span class="op">:</span> <span class="dv">99</span><span class="op">,</span></span>
<span id="cb8-4"><a href="system-description.html#cb8-4" tabindex="-1"></a>  canDrive<span class="op">:</span> (index<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> index <span class="op">&lt;</span> <span class="dv">1</span></span>
<span id="cb8-5"><a href="system-description.html#cb8-5" tabindex="-1"></a>}</span></code></pre></div>
<p>The fact that the “columns” of a <code>Dataframe</code> can be constants and functions is useful, for example, when want every row to contain the same value (e.g. 0 for the base of a barplot), or when we want the value be lazily computed based on other values. This is also where the <a href="glossary.html#SoA">SoA</a> representation offers a unique advantage: to achieve the same behavior in <a href="glossary.html#SoA">AoS</a> layout, we would have to have a copy of the value or function pointer in every row.</p>
<p><code>Dataframe</code> should always contain at least one array and all arrays in a <code>Dataframe</code> should have the same length. This is because some operations are impossible if we do not know the length of the <code>Dataframe</code> (the number of rows). For example, when rendering a scatterplot, how do we decide how many points to draw if the x- and y-positions have length 19 and 20, or if they are both constants? Thus, at least of one the dataframe’s columns needs to have a fixed length (i.e. have an underlying array) and there should not be multiple different lengths.</p>
<p>In the current version of the system, these fixed-length constraints are not enforced via a static check (such as during a constructor call), but are instead checked dynamically during runtime, whenever the integrity of a dataframe’s length becomes a key concern (using utility functions such as <code>Dataframe.checkLength</code>). This is the case, for example, when initializing a <a href="#Scene"><code>Scene</code></a> or when rendering.</p>
<p>I found the dynamic fixed-length checks to be the better option, for several reasons. First, they allow us to represent data as a plain JavaScript object (POJO) rather than having to instantiate a class. Second, due to JavaScript’s dynamic nature, this approach is also safer: if, during runtime, the user adds a property to a <code>Dataframe</code> which violates the fixed-length constraints, this approach will catch the error. Third, and finally, for any data sets with typical dimensionality (more rows than columns, <span class="math inline">\(p &lt;&lt; n\)</span>), the tiny performance hit that may be incurred due to having to loop through the columns to find the length dynamically will be minuscule compared with the computational cost of looping through the data set’s rows and doing work such as rendering or computing statistics. For high-dimensional datasets (<span class="math inline">\(p &gt;&gt; n\)</span>), we could always extend the system to memoize the length/number of rows on the <code>Dataframe</code> object (although then we may lose the security of the dynamic runtime checks).</p>
</div>
<div id="factor" class="section level3 hasAnchor" number="4.2.5">
<h3><span class="header-section-number">4.2.5</span> Factor<a href="system-description.html#factor" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>When visualizing data, we often need to split our data into several disjoint parts and compute summaries on these parts. Together, these parts forms a <a href="#Partitions">partition</a> of the data, and these partitions may be organized in a hierarchy, such that one or more parts in a child partition “add up” to a part in the parent partition.</p>
<p>A <code>Factor</code> provides a way to represent such data partitions, as well as the associated metadata. In this way, it is similar to base R’s <code>factor</code> S3 class, although there are some differences. It has the following interface:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb9-1"><a href="system-description.html#cb9-1" tabindex="-1"></a><span class="kw">interface</span> Factor<span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span> <span class="kw">extends</span> Reactive {</span>
<span id="cb9-2"><a href="system-description.html#cb9-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb9-3"><a href="system-description.html#cb9-3" tabindex="-1"></a>  indices<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb9-4"><a href="system-description.html#cb9-4" tabindex="-1"></a>  data<span class="op">:</span> T</span>
<span id="cb9-5"><a href="system-description.html#cb9-5" tabindex="-1"></a>  parent<span class="op">?:</span> Factor<span class="op">;</span></span>
<span id="cb9-6"><a href="system-description.html#cb9-6" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>cardinality</code> of a factor represents the number of unique parts (indices) that the partition the factor represents has. For example, if the factor represents boolean partition of the data into two parts, the cardinality will be 2, if it represents a partition of the data into three parts (e.g. <code>"A"</code>, <code>"B"</code>, and <code>"C"</code>), the cardinality will be 3, if it represents a partition of the data between all countries in the world, the cardinality will be 195, and so on. Technically, the same information as <code>cardinality</code> is implicitly represented in the array of <code>indices</code>, however, for some operations, it is useful to be able to access <code>cardinality</code> directly instead of having to loop through <code>indices</code> to find the number of unique values each time.</p>
<p>Indices represent the actual assignment of cases (rows of the data) to the parts. For example, the array of indices <code>[1, 0, 1, 1, 2]</code> represents the first, third, and fourth case being assigned to part two, the second case being assigned to part one, and the fifth case being assigned to part three (keeping in mind JavaScript’s zero-based indexing). As was mentioned above, the number of unique values in <code>indices</code> has to match the factor’s <code>cardinality</code>, and the length of <code>indices</code> has to match the number of rows of the data that the factor partitions.</p>
<p>A factor may have metadata associated with each part, which stored in the <code>data</code> property of type <a href="#Dataframe"><code>Dataframe</code></a>. This is a departure from base R’s <code>factor</code> class, which represents all metadata as the vector of <code>levels</code>. For instance:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="system-description.html#cb10-1" tabindex="-1"></a><span class="fu">cut</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>))</span></code></pre></div>
<pre><code>##  [1] (0,5]  (0,5]  (0,5]  (0,5]  (0,5]  (5,10] (5,10] (5,10] (5,10] (5,10]
## Levels: (0,5] (5,10]</code></pre>
<p>In my system, the same information would be represented as:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb12-1"><a href="system-description.html#cb12-1" tabindex="-1"></a><span class="kw">const</span> factor<span class="op">:</span> Factor <span class="op">=</span> {</span>
<span id="cb12-2"><a href="system-description.html#cb12-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb12-3"><a href="system-description.html#cb12-3" tabindex="-1"></a>  indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span></span>
<span id="cb12-4"><a href="system-description.html#cb12-4" tabindex="-1"></a>  data<span class="op">:</span> {</span>
<span id="cb12-5"><a href="system-description.html#cb12-5" tabindex="-1"></a>    binMin<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">5</span>]<span class="op">,</span></span>
<span id="cb12-6"><a href="system-description.html#cb12-6" tabindex="-1"></a>    binMax<span class="op">:</span> [<span class="dv">5</span><span class="op">,</span> <span class="dv">10</span>]<span class="op">,</span></span>
<span id="cb12-7"><a href="system-description.html#cb12-7" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb12-8"><a href="system-description.html#cb12-8" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
<p>There are several reasons why it may be better to store <code>Factor</code> metadata in tables (<code>Dataframe</code>) as opposed to vectors. First, when partitioning data, we often want to associate several pieces of metadata with each part. For example, if we cut or bin some numeric variable, like in the example above, we want to store both the lower and upper bound of each part’s bin. We can store both pieces of information as a single element (tuple) in an array/vector, the way that <code>cut</code> does it, however, this works well with only few pieces of metadata: once we start storing longer tuples, it becomes hard to tell what each tuple element represents. We could alleviate the problem by naming the tuple elements, but then we are essentially storing the metadata in an array of dictionaries, i.e. the <a href="glossary.html#SoA">AoS</a> data structure. We can do better by storing the metadata in a table. Second, if we store metadata in tables, it will be easier to combine when we take <a href="#Product%20factors">a product of two or more factors</a>. Since taking the product of multiple factors is a fundamental operation in an interactive data visualization system, underpinning operations such as linked brushing, it makes sense to use data representation which makes it convenient.</p>
<p>There are several types of factors which differ semantically but are represented by the same underlying <code>Factor</code> data type. What differs are the constructor functions that are used to create these factors, and are exported by the <code>Factor</code> namespaces. These will be discussed in the following subsections.</p>
<div id="bijection-factors" class="section level4 hasAnchor" number="4.2.5.1">
<h4><span class="header-section-number">4.2.5.1</span> Bijection factors<a href="system-description.html#bijection-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><code>Factor.bijection</code> is the first of two trivial factor constructors. It assigns each case its individual part, such that the cardinality is simply equal to the number of cases. When we create a bijection factor, we need to specify the length of the data (the number of cases) it represents to create the array of <code>indices</code>. Technically, this is not strictly necessary: we could implement <code>indices</code> as a callback which simply takes an index and returns it (an indentity function). However, since the primary use of factors is for summarizing data, and we need to know how many data points to summarize, we do still need to store the length of the data somewhere. I found it convenient to simply create a dummy array of <code>indices</code>, as opposed to having to store a separate <code>length</code> property.</p>
<p><code>Factor.bijection</code> can also have associated metadata.</p>
<p>Thus, the function signature of <code>Factor.bijection</code> is simply:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb13-1"><a href="system-description.html#cb13-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bijection</span><span class="op">&lt;</span>T <span class="kw">extends</span> Dataframe<span class="op">&gt;</span>(n<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> data<span class="op">?:</span> T)<span class="op">:</span> Factor<span class="op">&lt;</span>T<span class="op">&gt;</span> </span></code></pre></div>
</div>
<div id="constant-factors" class="section level4 hasAnchor" number="4.2.5.2">
<h4><span class="header-section-number">4.2.5.2</span> Constant factors<a href="system-description.html#constant-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Constant factors, or <code>Factor.mono</code>, are the polar opposite of bijection factors. They assign all cases of the data to a single part (thus, the label function is a constant function, hence the name). The constructor signature is the same as for <a href="#Bijection%20factors">bijection factor</a>, so I will omit it here.</p>
</div>
<div id="string-factors" class="section level4 hasAnchor" number="4.2.5.3">
<h4><span class="header-section-number">4.2.5.3</span> String factors<a href="system-description.html#string-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>If we have an array of values which are either strings or objects that can be coerced to strings (using the <code>.toString()</code> method), we can turn this into a factor, and treat two values as the same factor level if the underlying string representations are the same. This is the basis of <code>Factor.from</code>.</p>
<p>The metadata associated with <code>Factor.from</code> simply contains an array of <code>labels</code>.</p>
</div>
<div id="binned-factors" class="section level4 hasAnchor" number="4.2.5.4">
<h4><span class="header-section-number">4.2.5.4</span> Binned factors<a href="system-description.html#binned-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><code>Factor.bin</code> takes an array of numeric values and partitions them among a number of (typically equal-sized) bins. As such, serves as the fundamental building block for histograms.</p>
<p>The constructor signature is the following:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb14-1"><a href="system-description.html#cb14-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">bin</span>(</span>
<span id="cb14-2"><a href="system-description.html#cb14-2" tabindex="-1"></a>  array<span class="op">:</span> <span class="dt">number</span>[]<span class="op">,</span></span>
<span id="cb14-3"><a href="system-description.html#cb14-3" tabindex="-1"></a>  options<span class="op">:</span> {</span>
<span id="cb14-4"><a href="system-description.html#cb14-4" tabindex="-1"></a>    breaks<span class="op">?:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb14-5"><a href="system-description.html#cb14-5" tabindex="-1"></a>    nBins<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb14-6"><a href="system-description.html#cb14-6" tabindex="-1"></a>    width<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb14-7"><a href="system-description.html#cb14-7" tabindex="-1"></a>    anchor<span class="op">?:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb14-8"><a href="system-description.html#cb14-8" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb14-9"><a href="system-description.html#cb14-9" tabindex="-1"></a>)<span class="op">:</span> Factor<span class="op">&lt;</span>{ binMin<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span> binMax<span class="op">:</span> <span class="dt">number</span>[] }<span class="op">&gt;;</span></span></code></pre></div>
<p>If <code>breaks</code> are provided, the constructor function uses those to construct the histogram. Otherwise it uses <code>nBins</code>, <code>width</code>, and <code>anchor</code> to determine the breaks, in the corresponding order of importance.</p>
<p><code>Factor.bin</code> produces metadata associated with the histogram bins, that is, the minimum and the maximum of each bin. That is, the result has the following shape:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb15-1"><a href="system-description.html#cb15-1" tabindex="-1"></a>{ </span>
<span id="cb15-2"><a href="system-description.html#cb15-2" tabindex="-1"></a>  cardinality<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> </span>
<span id="cb15-3"><a href="system-description.html#cb15-3" tabindex="-1"></a>  indices<span class="op">:</span> <span class="dt">number</span>[]<span class="op">,</span> </span>
<span id="cb15-4"><a href="system-description.html#cb15-4" tabindex="-1"></a>  data<span class="op">:</span> {</span>
<span id="cb15-5"><a href="system-description.html#cb15-5" tabindex="-1"></a>    binMin<span class="op">:</span> <span class="dt">number</span>[]<span class="op">,</span></span>
<span id="cb15-6"><a href="system-description.html#cb15-6" tabindex="-1"></a>    binMax<span class="op">:</span> <span class="dt">number</span>[]</span>
<span id="cb15-7"><a href="system-description.html#cb15-7" tabindex="-1"></a>  } </span>
<span id="cb15-8"><a href="system-description.html#cb15-8" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="product-factors" class="section level4 hasAnchor" number="4.2.5.5">
<h4><span class="header-section-number">4.2.5.5</span> Product factors<a href="system-description.html#product-factors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A fundamental operation that we need to be able to do with factors is to take their Cartesian product. That is, when we have two factors of same length, each with its corresponding array of indices, we need to be able to take the indices, combine them element-wise, and create a new factor that will have as its cardinality the number of unique pairwise combinations of indices.</p>
<p>For example, take two factors represented by the following data:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb16-1"><a href="system-description.html#cb16-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>] }<span class="op">;</span></span>
<span id="cb16-2"><a href="system-description.html#cb16-2" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">3</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>] }<span class="op">;</span></span></code></pre></div>
<p>If we take their product, we should end up with the following factor:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb17-1"><a href="system-description.html#cb17-1" tabindex="-1"></a>{ cardinality<span class="op">:</span> <span class="dv">4</span><span class="op">,</span> indices<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>] }<span class="op">;</span></span></code></pre></div>
<p>Notice that the cardinality of the new factor (<span class="math inline">\(4\)</span>) is greater than that of either of the two constituent factors (<span class="math inline">\(2\)</span>, <span class="math inline">\(3\)</span>) but less than then their combined product (<span class="math inline">\(2 \cdot 3 = 6\)</span>). This will be generally case: if the first factor has cardinality <span class="math inline">\(i\)</span> and the second cardinality <span class="math inline">\(j\)</span>, the product of the two factors will have cardinality <span class="math inline">\(k\)</span>, such that:</p>
<ul>
<li><span class="math inline">\(k \geq i\)</span> and <span class="math inline">\(k \geq j\)</span> (equality only if one or both of the factors are constant)</li>
<li><span class="math inline">\(k \leq i \cdot j\)</span> (equality only if all element-wise index combinations are unique).</li>
</ul>
<p>I’ve used a formula similar to one discussed in <span class="citation">(<a href="#ref-wickham2013">Wickham 2013</a>)</span>:</p>
<p><span class="math display">\[i_{\text{product}} = i_1 + i_2 \cdot \max(j, k)\]</span></p>
</div>
</div>
<div id="reducers" class="section level3 hasAnchor" number="4.2.6">
<h3><span class="header-section-number">4.2.6</span> Reducers<a href="system-description.html#reducers" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="scales-1" class="section level3 hasAnchor" number="4.2.7">
<h3><span class="header-section-number">4.2.7</span> Scales<a href="system-description.html#scales-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To visualize data, we need to be able to translate values from the space of the data to the space of the graphical device (computer screen). In most data visualization systems, this is done by specialized components called scales or coordinate systems <span class="citation">(see e.g. <a href="#ref-murrell2005">Murrell 2005</a>; <a href="#ref-wickham2016">Wickham 2016</a>; <a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>. Scales serve as a bridge between what we have (data) and what we see (visual attributes), allowing us to cross from one domain to the other.</p>
<p>There exists is a fair research on the theoretical properties of scales and how they relate to the mechanisms of visual perception <span class="citation">(see e.g. <a href="#ref-krzywinski2013">Krzywinski 2013</a>; <a href="#ref-michell1986">Michell 1986</a>; <a href="#ref-wilkinson2012">Wilkinson 2012</a>; <a href="#ref-stevens1946">Stevens 1946</a>)</span>. However, when it comes to applying this knowledge and implementing scales in concrete data visualization systems, a lot less information is available. And, even when such information is available, it is it is often quite high-level of abstract <span class="citation">(for some rare counter-examples, see e.g. <a href="#ref-murrell2005">Murrell 2005</a>; <a href="#ref-ziemkiewicz2009">Ziemkiewicz and Kosara 2009</a>)</span>. Thus, the following section is based largely on how scales have been implemented in existing data visualization codebases, such as the <code>ggplot2</code> R package <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span> or <code>d3-scale</code> module of D3 <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>; also used by Vega <a href="#ref-satyanarayan2015">Satyanarayan et al. 2015</a>)</span>, as well as on personal insights gained while implementing the package.</p>
<div id="overview" class="section level4 hasAnchor" number="4.2.7.1">
<h4><span class="header-section-number">4.2.7.1</span> Overview<a href="system-description.html#overview" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>From a high-level perspective, a scale is just a function <span class="math inline">\(s: D \to V\)</span> which translates values of the data <span class="math inline">\(d \in D\)</span> to values of some visual attribute <span class="math inline">\(v \in V\)</span>, such as the x- and y-position, length, area, radius, or color <span class="citation">(<a href="#ref-wilkinson2012">Wilkinson 2012</a>)</span>. This function may or may not be invertible, such that, at times, each value of the visual attribute may be identified with a unique data value (but this is not always the case).</p>
<p>One of the most common and typical cases is a scale where both <span class="math inline">\(D\)</span> and <span class="math inline">\(V\)</span> are subsets of the real numbers:</p>
<p><span class="math display">\[s: [d_{min}, d_{max}] \to [v_{min}, v_{max}] \qquad d_{min}, d_{max}, v_{min}, v_{max} \in \mathbb{R}\]</span></p>
<p>For example, suppose our data takes values in the range from 1 to 10 and we want to plot it along the x-axis, within a 800 pixels wide plotting region. Then, our scale is simply:</p>
<p><span class="math display">\[s_x: [1, 10] \to [0, 800]\]</span></p>
<p>Now, there is an infinite number of functions that fit this signature. However, one particularly nice and simple candidate is the following function:</p>
<div class="definition">
<p><span id="def:linear-mapping" class="definition"><strong>Definition 4.1  (Simple linear mapping) </strong></span><span class="math display">\[s(d) = v_{max} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
</div>
<p>if we substitute the concrete values into the formula, this becomes:</p>
<p><span class="math display">\[s_x(d) = 0 + \frac{d - 1}{10 - 1} \cdot (800 - 0) = [(d - 1) / 9] \cdot 800\]</span></p>
<p>The function acts on the data in the following way:</p>
<ul>
<li><span class="math inline">\(s_x(1) = (1 - 1) / 9 \cdot 800 = 0\)</span></li>
<li><span class="math inline">\(s_x(10) = (10 - 1) / 9 \cdot 800 = 800\)</span></li>
<li><span class="math inline">\(s_x(d) \in (0, 800)\)</span> for any <span class="math inline">\(d \in (1, 10)\)</span></li>
</ul>
<p>That is, the function maps the data value 1 to pixel 0 (left border of the plotting region), value 10 to to pixel 800 (right border of the plotting region), and any value in between 1 and 10 inside the interval 0 to 800, proportionally to where in the data range it is located.</p>
<p>It is relatively simple to translate the formula in <a href="system-description.html#def:linear-mapping">4.1</a> to code:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb18-1"><a href="system-description.html#cb18-1" tabindex="-1"></a><span class="co">// simpleScale.ts</span></span>
<span id="cb18-2"><a href="system-description.html#cb18-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale</span>(</span>
<span id="cb18-3"><a href="system-description.html#cb18-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb18-4"><a href="system-description.html#cb18-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb18-5"><a href="system-description.html#cb18-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb18-6"><a href="system-description.html#cb18-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb18-7"><a href="system-description.html#cb18-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb18-8"><a href="system-description.html#cb18-8" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb18-9"><a href="system-description.html#cb18-9" tabindex="-1"></a>  <span class="cf">return</span> vmin <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb18-10"><a href="system-description.html#cb18-10" tabindex="-1"></a>}</span></code></pre></div>
<p>And indeed, this function works the way we would expect:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb19-1"><a href="system-description.html#cb19-1" tabindex="-1"></a><span class="im">import</span> { simpleScale } <span class="im">from</span> <span class="st">&quot;./simpleScale.ts&quot;</span></span>
<span id="cb19-2"><a href="system-description.html#cb19-2" tabindex="-1"></a></span>
<span id="cb19-3"><a href="system-description.html#cb19-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb19-4"><a href="system-description.html#cb19-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb19-5"><a href="system-description.html#cb19-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0
## 400
## 800</code></pre>
</div>
<div id="simple-scale-limits" class="section level4 hasAnchor" number="4.2.7.2">
<h4><span class="header-section-number">4.2.7.2</span> Limits of modeling scales as simple functions<a href="system-description.html#simple-scale-limits" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Simple scale functions like the one above can work fine for basic data visualization systems. However, once we begin adding more features, this design becomes prohibitive. Consider, for example, what happens if we want to:</p>
<ul>
<li>Expand the scale limits</li>
<li>Scale discrete data</li>
<li>Apply non-linear transformations</li>
<li>Pan, zoom, reverse, reorder, or otherwise modify the scale interactively</li>
</ul>
<p>Let’s take the first point as a motivating example. Consider what happens to data points at the limits of the data range under the simple linear mapping:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="system-description.html#cb21-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb21-2"><a href="system-description.html#cb21-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb21-3"><a href="system-description.html#cb21-3" tabindex="-1"></a>col <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="st">&quot;indianred&quot;</span>, <span class="st">&quot;grey80&quot;</span>)</span>
<span id="cb21-4"><a href="system-description.html#cb21-4" tabindex="-1"></a></span>
<span id="cb21-5"><a href="system-description.html#cb21-5" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>, <span class="at">xaxs =</span> <span class="st">&quot;i&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-18-1.png" width="800px" style="display: block; margin: auto;" /></p>
<p>The plot above shows values scaled using the simple linear mapping along the x-axis, that is, <span class="math inline">\(s: [1, 10] \to [0, 800]\)</span> (effect of the <code>xaxs = "i"</code> argument). Notice that, since the position of the points representing the values 1 and 10 (highlighted in red) gets mapped to pixel values 0 and 800 (the left and right border of the plot), only half of each point is visible. This is quite undesirable - a fundamental principles of graphical integrity is that our graphics should not arbitrarily downplay or hide certain data points <span class="citation">(<a href="#ref-tufte2001">Tufte 2001</a>)</span>. The points at the axis limits are represented by only 1/2 of the area (or less, if at the limits of both axes), making them less salient, and this is especially pernicious since they are likely to be outliers.</p>
<p>To address this problem, most data visualization systems automatically expand the range of the domain by some pre-specified percentage:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="system-description.html#cb22-1" tabindex="-1"></a><span class="co"># By default, the plot() function automatically expands the x- and y-axis</span></span>
<span id="cb22-2"><a href="system-description.html#cb22-2" tabindex="-1"></a><span class="co"># limits by approximately 4% on each end, see `xaxs` in ?graphics::par</span></span>
<span id="cb22-3"><a href="system-description.html#cb22-3" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">col =</span> col, <span class="at">cex =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-19-1.png" width="800px" style="display: block; margin: auto;" /></p>
<p>We <em>could</em> achieve similar effect by modifying the simple linear mapping we have defined above and adding an additional argument:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb23-1"><a href="system-description.html#cb23-1" tabindex="-1"></a><span class="co">// simpleScale2.ts</span></span>
<span id="cb23-2"><a href="system-description.html#cb23-2" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">simpleScale2</span>(</span>
<span id="cb23-3"><a href="system-description.html#cb23-3" tabindex="-1"></a>  d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb23-4"><a href="system-description.html#cb23-4" tabindex="-1"></a>  dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb23-5"><a href="system-description.html#cb23-5" tabindex="-1"></a>  dmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb23-6"><a href="system-description.html#cb23-6" tabindex="-1"></a>  vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb23-7"><a href="system-description.html#cb23-7" tabindex="-1"></a>  vmax<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb23-8"><a href="system-description.html#cb23-8" tabindex="-1"></a>  exp<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> <span class="co">// Extra argument</span></span>
<span id="cb23-9"><a href="system-description.html#cb23-9" tabindex="-1"></a>)<span class="op">:</span> <span class="dt">number</span> {</span>
<span id="cb23-10"><a href="system-description.html#cb23-10" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb23-11"><a href="system-description.html#cb23-11" tabindex="-1"></a>    vmin <span class="op">+</span> (exp <span class="op">/</span> <span class="dv">2</span> <span class="op">+</span> ((d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)) <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> exp)) <span class="op">*</span> (vmax <span class="op">-</span> vmin)</span>
<span id="cb23-12"><a href="system-description.html#cb23-12" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb23-13"><a href="system-description.html#cb23-13" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, if we set the <code>exp</code> argument to some positive value, the scaled values get mapped closer to the center of the plotting region. For example, setting <code>exp</code> to 0.2 moves each of the data limits 10% closer to the center of the plotting region:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb24-1"><a href="system-description.html#cb24-1" tabindex="-1"></a><span class="im">import</span> { simpleScale2 } <span class="im">from</span> <span class="st">&quot;./simpleScale2.ts&quot;</span></span>
<span id="cb24-2"><a href="system-description.html#cb24-2" tabindex="-1"></a></span>
<span id="cb24-3"><a href="system-description.html#cb24-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span>
<span id="cb24-4"><a href="system-description.html#cb24-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span>
<span id="cb24-5"><a href="system-description.html#cb24-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">simpleScale2</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span><span class="op">,</span> <span class="fl">0.2</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 80
## 400
## 720</code></pre>
<p>However, notice that this argument is applied symmetrically. At times, we may want to apply a different margin to each end of the scale. We could solve this by adding two arguments instead of one, e.g. <code>expLeft</code> and <code>expRight</code>, however, at this point, the function signature starts to become unwieldy. If we have to call the function in multiple places, it may become difficult to remember what each individual argument represents. Further, note that by adding arguments, the logic inside the function’s body becomes denser and less readable. Finally, we may want to persist or modify some of the arguments during runtime (such as when panning or zooming). For all of these reasons, it may be a good idea to take a more structured approach and break the function down into several smaller components.</p>
</div>
<div id="two-component-scales" class="section level4 hasAnchor" number="4.2.7.3">
<h4><span class="header-section-number">4.2.7.3</span> Solution: Two-component scales<a href="system-description.html#two-component-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The linear mapping formula in <a href="system-description.html#def:linear-mapping">4.1</a> can guide us in decomposing the scale function into smaller, more manageable parts. Let’s look at it again:</p>
<p><span class="math display">\[s(d) = v_{min} + \frac{d - d_{min}}{d_{max} - d_{min}} \cdot (v_{max} - v_{min})\]</span></p>
<p>If we look closely, we may be able to see that there are two parts to the function:</p>
<p><span class="math display">\[s(d) = \color{steelblue}{v_{min} +} \color{indianred}{\frac{\color{black}{d} - d_{min}}{d_{max} - d_{min}}} \color{steelblue}{\cdot (v_{max} - v_{min})}\]</span></p>
<p>That is, the linear mapping is composed of two simpler functions:</p>
<ul>
<li><span class="math inline">\(\color{indianred}{n(d) = (d - d_{min}) / (d_{max} - d_{min})}\)</span> takes a data value <span class="math inline">\(d \in D\)</span> and maps it to the interval <span class="math inline">\([0, 1]\)</span></li>
<li><span class="math inline">\(\color{steelblue}{u(p) = v_{min} + p \cdot (v_{max} - v_{min})}\)</span> takes a value in <span class="math inline">\([0, 1]\)</span> and maps it to a visual attribute value <span class="math inline">\(v \in V\)</span></li>
</ul>
<p>This leads us to the following definition of a scale:</p>
<div class="definition">
<p><span id="def:scale" class="definition"><strong>Definition 4.2  (Scale as composition of two functions) </strong></span>A scale <span class="math inline">\(s\)</span> can be created by composing:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(n: D \to [0, 1]\)</span>, mapping data to the interval <span class="math inline">\([0, 1]\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(u: [0, 1] \to V\)</span>, mapping value in <span class="math inline">\([0, 1]\)</span> to the visual attribute codomain</li>
</ul>
<p>Such that:</p>
<p><span class="math display">\[s(d) = u(n(d))\]</span></p>
</div>
<p>Note that the terms <em>normalize</em> and <em>unnormalize</em> are arbitrary, however, I think they make for useful labels. They represent 1-D equivalent of vector normalization, mapping a value in the domain to and from a unit interval <span class="math inline">\([0, 1]\)</span>.</p>
<p>For the case of the linear mapping, we could rewrite this in code as follows:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb26-1"><a href="system-description.html#cb26-1" tabindex="-1"></a><span class="co">// LinearMap.ts</span></span>
<span id="cb26-2"><a href="system-description.html#cb26-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">LinearMap</span> {</span>
<span id="cb26-3"><a href="system-description.html#cb26-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb26-4"><a href="system-description.html#cb26-4" tabindex="-1"></a>    <span class="cf">return</span> (d <span class="op">-</span> dmin) <span class="op">/</span> (dmax <span class="op">-</span> dmin)<span class="op">;</span></span>
<span id="cb26-5"><a href="system-description.html#cb26-5" tabindex="-1"></a>  }</span>
<span id="cb26-6"><a href="system-description.html#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="system-description.html#cb26-7" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmin<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> vmax<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb26-8"><a href="system-description.html#cb26-8" tabindex="-1"></a>    <span class="cf">return</span> vmin <span class="op">+</span> p <span class="op">*</span> (vmax <span class="op">-</span> vmin)<span class="op">;</span></span>
<span id="cb26-9"><a href="system-description.html#cb26-9" tabindex="-1"></a>  }</span>
<span id="cb26-10"><a href="system-description.html#cb26-10" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb27-1"><a href="system-description.html#cb27-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb27-2"><a href="system-description.html#cb27-2" tabindex="-1"></a></span>
<span id="cb27-3"><a href="system-description.html#cb27-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>))</span>
<span id="cb27-4"><a href="system-description.html#cb27-4" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.5</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span>
<span id="cb27-5"><a href="system-description.html#cb27-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="fl">5.5</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))</span></code></pre></div>
<pre><code>## 0.5
## 400
## 400</code></pre>
<p>This two component system allows for a clean separation of concerns. Specifically, the normalize function only needs to know how to map the data values to <span class="math inline">\([0, 1]\)</span>. It does not need to be aware of where these normalized data values will be mapped to. Conversely, the unnormalize function only needs to understand how to translate values from <span class="math inline">\([0, 1]\)</span> to the space of the visual attribute (such as x-axis position).</p>
<div id="beyond-linear-maps" class="section level5 hasAnchor" number="4.2.7.3.1">
<h5><span class="header-section-number">4.2.7.3.1</span> Beyond linear maps<a href="system-description.html#beyond-linear-maps" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Another big advantage of the two-component scale system is that the functions <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> do not need to be a simple linear maps anymore. For example, suppose that our data <span class="math inline">\(D\)</span> takes form of a set of discrete labels, such as <span class="math inline">\(D = \{ Prague,  Vienna, Munich, Salzburg \}\)</span>. We can then replace <span class="math inline">\(n\)</span> with a surjective function <span class="math inline">\(n: D \to [0, 1]\)</span> such that:</p>
<p><span class="math display">\[n(d) = \begin{cases}  
0.2 &amp; \text{if } d = Munich
\\ 0.4 &amp; \text{if } d = Prague
\\ 0.6 &amp; \text{if } d = Salzburg
\\ 0.8 &amp; \text{if } d = Vienna
\end{cases}\]</span></p>
<p>In other words, <span class="math inline">\(n\)</span> will place values of <span class="math inline">\(D\)</span> at equidistant points along <span class="math inline">\([0, 1]\)</span>, ordered alphabetically. We can implement this function in code as follows:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb29-1"><a href="system-description.html#cb29-1" tabindex="-1"></a><span class="co">// PointMap.ts</span></span>
<span id="cb29-2"><a href="system-description.html#cb29-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">PointMap</span> {</span>
<span id="cb29-3"><a href="system-description.html#cb29-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb29-4"><a href="system-description.html#cb29-4" tabindex="-1"></a>    <span class="cf">return</span> (dlabels<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb29-5"><a href="system-description.html#cb29-5" tabindex="-1"></a>  }</span>
<span id="cb29-6"><a href="system-description.html#cb29-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Since the codomain of <span class="math inline">\(n\)</span> is still <span class="math inline">\([0, 1]\)</span>, we can compose it with a simple linear mapping <span class="math inline">\(u\)</span> just as easily as before:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb30-1"><a href="system-description.html#cb30-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb30-2"><a href="system-description.html#cb30-2" tabindex="-1"></a><span class="im">import</span> { PointMap } <span class="im">from</span> <span class="st">&quot;./PointMap.ts&quot;</span></span>
<span id="cb30-3"><a href="system-description.html#cb30-3" tabindex="-1"></a></span>
<span id="cb30-4"><a href="system-description.html#cb30-4" tabindex="-1"></a><span class="kw">const</span> labels <span class="op">=</span> [<span class="st">&quot;Munich&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Salzburg&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]<span class="op">;</span></span>
<span id="cb30-5"><a href="system-description.html#cb30-5" tabindex="-1"></a></span>
<span id="cb30-6"><a href="system-description.html#cb30-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Munich&quot;</span><span class="op">,</span> labels))<span class="op">;</span></span>
<span id="cb30-7"><a href="system-description.html#cb30-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Munich&quot;</span><span class="op">,</span> labels)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))<span class="op">;</span></span>
<span id="cb30-8"><a href="system-description.html#cb30-8" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(PointMap<span class="op">.</span><span class="fu">normalize</span>(<span class="st">&quot;Prague&quot;</span><span class="op">,</span> labels)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">800</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 0.2
## 160
## 320</code></pre>
</div>
<div id="inverses" class="section level5 hasAnchor" number="4.2.7.3.2">
<h5><span class="header-section-number">4.2.7.3.2</span> Inverses<a href="system-description.html#inverses" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Additionally, another property of the two-component scale system that can be useful is that, if both <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span> are invertible, then so is <span class="math inline">\(s\)</span>. That is, we can easily obtain the inverse scale function by inverting the definition from <a href="system-description.html#def:scale">4.2</a>:</p>
<div class="definition">
<p><span id="def:scale-inverse" class="definition"><strong>Definition 4.3  (Scale inverse) </strong></span>If a scale <span class="math inline">\(s\)</span> is composed of invertible functions <span class="math inline">\(n\)</span> and <span class="math inline">\(u\)</span>, then <span class="math inline">\(s\)</span> is invertible:</p>
<p><span class="math display">\[s^{-1}(v) = n^{-1}(u^{-1}(v))\]</span></p>
</div>
<p>This is the case for the simple linear map: the normalize and unnormalize functions are actually inverses of each other:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb32-1"><a href="system-description.html#cb32-1" tabindex="-1"></a><span class="im">import</span> { LinearMap } <span class="im">from</span> <span class="st">&quot;./LinearMap.ts&quot;</span></span>
<span id="cb32-2"><a href="system-description.html#cb32-2" tabindex="-1"></a></span>
<span id="cb32-3"><a href="system-description.html#cb32-3" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(LinearMap<span class="op">.</span><span class="fu">unnormalize</span>(LinearMap<span class="op">.</span><span class="fu">normalize</span>(<span class="dv">300</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">500</span>))</span></code></pre></div>
<pre><code>## 300</code></pre>
<p>However, the inverse may not always exist. In practice, this is often the case when the domain of the data <span class="math inline">\(D\)</span> is smaller than the codomain <span class="math inline">\([0, 1]\)</span>. Take, for example, the discrete point mapping. Since <span class="math inline">\(D\)</span> is finite but <span class="math inline">\([0, 1]\)</span> has infinitely many values, there will always be some values in <span class="math inline">\([0, 1]\)</span> that no <span class="math inline">\(d \in D\)</span> maps to. For example, if <span class="math inline">\(D = \{ Munich, Prague, Salzburg, Vienna \}\)</span> and <span class="math inline">\(Munich\)</span> maps to 0.2, <span class="math inline">\(Prague\)</span> maps to <span class="math inline">\(0.4\)</span>, and <span class="math inline">\(Salzburg\)</span> maps to <span class="math inline">\(0.8\)</span>, then there are no cities which map to 0.9, 0.444, or 0.123456789. Conversely, if we get given those numeric values, then there is no obvious way to map them back to the cities.</p>
<p>One thing we can do is to replace the inverse/unnormalize function with a weaker form of inverse, called retraction <span class="citation">(<a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>)</span>. Specifically, if we have a normalize function <span class="math inline">\(n: D \to [0, 1]\)</span>, then an unnormalize retraction <span class="math inline">\(u^*\)</span> will have the property that:</p>
<p><span class="math display">\[u^*(n(d)) = d \qquad \forall d \in D\]</span></p>
<p>However, the converse doesn’t necessarily hold:</p>
<p><span class="math display">\[\neg \big[ n(u^*(v)) = v \qquad \forall v \in V \big]\]</span></p>
<p>For example, for the discrete point mapping, a retraction may map a value in <span class="math inline">\([0, 1]\)</span> to the closest data value <span class="math inline">\(d \in D\)</span>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb34-1"><a href="system-description.html#cb34-1" tabindex="-1"></a><span class="co">// PointMap.ts</span></span>
<span id="cb34-2"><a href="system-description.html#cb34-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">PointMap</span> {</span>
<span id="cb34-3"><a href="system-description.html#cb34-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(d<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb34-4"><a href="system-description.html#cb34-4" tabindex="-1"></a>    <span class="cf">return</span> (dlabels<span class="op">.</span><span class="fu">indexOf</span>(d) <span class="op">+</span> <span class="dv">1</span>) <span class="op">/</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb34-5"><a href="system-description.html#cb34-5" tabindex="-1"></a>  }</span>
<span id="cb34-6"><a href="system-description.html#cb34-6" tabindex="-1"></a>  </span>
<span id="cb34-7"><a href="system-description.html#cb34-7" tabindex="-1"></a>  <span class="co">// Retraction - find the closest label</span></span>
<span id="cb34-8"><a href="system-description.html#cb34-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(p<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> dlabels<span class="op">:</span> <span class="dt">string</span>[]) {</span>
<span id="cb34-9"><a href="system-description.html#cb34-9" tabindex="-1"></a>    <span class="kw">const</span> k <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(p <span class="op">*</span> (dlabels<span class="op">.</span><span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb34-10"><a href="system-description.html#cb34-10" tabindex="-1"></a>    <span class="cf">return</span> dlabels[k]</span>
<span id="cb34-11"><a href="system-description.html#cb34-11" tabindex="-1"></a>  }</span>
<span id="cb34-12"><a href="system-description.html#cb34-12" tabindex="-1"></a>}</span>
<span id="cb34-13"><a href="system-description.html#cb34-13" tabindex="-1"></a></span>
<span id="cb34-14"><a href="system-description.html#cb34-14" tabindex="-1"></a><span class="kw">const</span> labels <span class="op">=</span> [<span class="st">&quot;Munich&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Salzburg&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]<span class="op">;</span></span>
<span id="cb34-15"><a href="system-description.html#cb34-15" tabindex="-1"></a></span>
<span id="cb34-16"><a href="system-description.html#cb34-16" tabindex="-1"></a><span class="kw">const</span> [prague<span class="op">,</span> munich] <span class="op">=</span> [<span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Munich&quot;</span>]<span class="op">.</span><span class="fu">map</span>(x <span class="kw">=&gt;</span> PointMap<span class="op">.</span><span class="fu">normalize</span>(x<span class="op">,</span> labels))</span>
<span id="cb34-17"><a href="system-description.html#cb34-17" tabindex="-1"></a><span class="kw">const</span> midpoint <span class="op">=</span> (prague <span class="op">+</span> munich) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb34-18"><a href="system-description.html#cb34-18" tabindex="-1"></a></span>
<span id="cb34-19"><a href="system-description.html#cb34-19" tabindex="-1"></a><span class="co">// Helper function for stripping away floating point error </span></span>
<span id="cb34-20"><a href="system-description.html#cb34-20" tabindex="-1"></a><span class="kw">const</span> strip <span class="op">=</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="pp">parseFloat</span>(x<span class="op">.</span><span class="fu">toPrecision</span>(<span class="dv">12</span>))</span>
<span id="cb34-21"><a href="system-description.html#cb34-21" tabindex="-1"></a></span>
<span id="cb34-22"><a href="system-description.html#cb34-22" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Midpoint between Munich and Prague: `</span><span class="op">,</span> <span class="fu">strip</span>(midpoint))</span>
<span id="cb34-23"><a href="system-description.html#cb34-23" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`unnormalize(0.2999): `</span><span class="op">,</span> PointMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.2999</span><span class="op">,</span> labels))</span>
<span id="cb34-24"><a href="system-description.html#cb34-24" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`unnormalize(3): `</span><span class="op">,</span> PointMap<span class="op">.</span><span class="fu">unnormalize</span>(<span class="fl">0.3</span><span class="op">,</span> labels))</span></code></pre></div>
<pre><code>## Midpoint between Munich and Prague:  0.3
## unnormalize(0.2999):  Munich
## unnormalize(3):  Prague</code></pre>
<p>While inverses are always unique <span class="citation">(<a href="#ref-lawvere2009">Lawvere and Schanuel 2009</a>; <a href="#ref-fong2019">Fong and Spivak 2019</a>)</span>, we may be able to come up with many different retractions for any given function. For example, with the discrete point map above, we could use the floor function instead of rounding and assign label to a value in <span class="math inline">\([0, 1]\)</span> if it is less than the value of the normalized label (but more than the preceding labels).</p>
<p>The non-uniqueness of retractions presents a bit of a dilemma. How do we decide which retraction to use? And, if a certain retractive implementation of <code>unnormalize</code> returns a value, how do we decide if it is the “correct one”?</p>
<p>However, in practice, this is not much of a problem. While developing the package, I found that I’ve only ever had to use the <code>unnormalize</code> function with continuous data (<code>LinearMap</code>), and so the inverse was always well-defined. This is probably also why packages like <code>ggplot2</code> and <code>D3</code> can get by without this functionality. However, I still find it helpful to include the <code>unnormalize</code> function as a first class citizen (instead of it being relegated to some special case), both in terms of the mental model and also for debugging.</p>
</div>
<div id="some-other-remarks-about-the-two-component-scale-system" class="section level5 hasAnchor" number="4.2.7.3.3">
<h5><span class="header-section-number">4.2.7.3.3</span> Some other remarks about the two-component scale system<a href="system-description.html#some-other-remarks-about-the-two-component-scale-system" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>It is worth noting that there is nothing inherently special about the interval <span class="math inline">\([0, 1]\)</span> as the intermediate domain: any finite subset of <span class="math inline">\(\mathbb{R}\)</span> would do. However, the interval <span class="math inline">\([0, 1]\)</span> is convenient, both in terms of interpretation as well as for implementation, as we will see later.</p>
<p>Finally, so far I have discussed scales as <em>functions</em>: the scale function, the normalize function, and unnormalize function. Framing scales as composition of functions leads to a nice correspondence between the mathematical definition and the code. However, in practice, it may be more convenient to implement the domain and codomain as <em>objects</em> or <em>classes</em>, as we will also see in the following section. The important point is that, no matter how the two components are represented, each is responsible for translating values from/to its domain and the interval <span class="math inline">\([0, 1]\)</span>.</p>
</div>
</div>
<div id="past-implementations-of-scales" class="section level4 hasAnchor" number="4.2.7.4">
<h4><span class="header-section-number">4.2.7.4</span> Past implementations of scales<a href="system-description.html#past-implementations-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Two-component scale systems such as the one sketched out above are fairly standard across data visualization libraries. For example, in <code>D3</code> <span class="citation">(<a href="#ref-bostock2011">Bostock, Ogievetsky, and Heer 2011</a>)</span>, scales are implemented in a functional style, such that the data domain and the visual attribute codomain are passed as tuples or arrays of values to a higher-order <code>scale*</code> function (such as <code>scaleLinear</code>, <code>scalePoint</code>, or <code>scaleBand</code>), which then returns a new function that can be used for scaling. The domain and codomain can also be changed at a later point, by using the <code>scale*.domain</code> and <code>scale*.range</code> methods respectively (JavaScript functions are objects and can have other functions/methods attached to them).</p>
<p>For illustration, here is an example from the official documentation <span class="citation">(<a href="#ref-d3-scale2024">Observable 2024</a>)</span>:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb36-1"><a href="system-description.html#cb36-1" tabindex="-1"></a><span class="kw">const</span> x <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">960</span>])<span class="op">;</span></span>
<span id="cb36-2"><a href="system-description.html#cb36-2" tabindex="-1"></a><span class="fu">x</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// 80</span></span>
<span id="cb36-3"><a href="system-description.html#cb36-3" tabindex="-1"></a><span class="kw">const</span> color <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span> [<span class="st">&quot;brown&quot;</span><span class="op">,</span> <span class="st">&quot;steelblue&quot;</span>])<span class="op">;</span></span>
<span id="cb36-4"><a href="system-description.html#cb36-4" tabindex="-1"></a><span class="fu">color</span>(<span class="dv">20</span>)<span class="op">;</span> <span class="co">// &quot;rgb(154, 52, 57)&quot;</span></span>
<span id="cb36-5"><a href="system-description.html#cb36-5" tabindex="-1"></a><span class="co">// The domain and codomain can be changed after initialization</span></span>
<span id="cb36-6"><a href="system-description.html#cb36-6" tabindex="-1"></a><span class="kw">const</span> y <span class="op">=</span> d3<span class="op">.</span><span class="fu">scaleLinear</span>()<span class="op">.</span><span class="fu">domain</span>([<span class="dv">10</span><span class="op">,</span> <span class="dv">130</span>])<span class="op">;</span> </span></code></pre></div>
<p>Internally, the <code>scale*</code> functions rely on other specialized functions to translate from its domain to the codomain (such as the <code>normalize()</code> and <code>scale()</code> functions for continuous and discrete/ordinal domains, respectively, and various <code>interpolate()</code> functions for codomains).</p>
<p>Similarly, in <code>ggplot2</code> <span class="citation">(<a href="#ref-wickham2016">Wickham 2016</a>)</span>, scales are built upon the <code>Scale</code> class, with each subtype implementing <code>limits</code> and <code>palette</code> properties. The <code>limits</code> property is a vector which corresponds to the data domain and the <code>palette</code> property is a function which corresponds roughly to the visual codomain (the x- and y-position behave slightly differently, due to being transformed via coordinate systems). Internally, the package uses the <code>rescale</code> function from the <code>scales</code> package <span class="citation">(<a href="#ref-wickham2023">Wickham, Pedersen, and Seidel 2023</a>)</span> to map data values to <span class="math inline">\([0, 1]\)</span> and then the <code>palette</code> function is responsible for mapping these normalized values to the visual attribute. For illustration, here’s the full definition of the <code>map</code> method on the <code>ScaleContinuous</code> class (I’ve added comments for clarity):</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="system-description.html#cb37-1" tabindex="-1"></a>map <span class="ot">=</span> <span class="cf">function</span>(self, x, <span class="at">limits =</span> self<span class="sc">$</span><span class="fu">get_limits</span>()) {</span>
<span id="cb37-2"><a href="system-description.html#cb37-2" tabindex="-1"></a>  <span class="co"># Limits are just a tuple, rescale maps x to [0, 1]</span></span>
<span id="cb37-3"><a href="system-description.html#cb37-3" tabindex="-1"></a>  x <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">rescale</span>(self<span class="sc">$</span><span class="fu">oob</span>(x, <span class="at">range =</span> limits), limits) </span>
<span id="cb37-4"><a href="system-description.html#cb37-4" tabindex="-1"></a></span>
<span id="cb37-5"><a href="system-description.html#cb37-5" tabindex="-1"></a>  uniq <span class="ot">&lt;-</span> <span class="fu">unique0</span>(x)</span>
<span id="cb37-6"><a href="system-description.html#cb37-6" tabindex="-1"></a>  <span class="co"># Palette is a function which returns a vector of attribute values</span></span>
<span id="cb37-7"><a href="system-description.html#cb37-7" tabindex="-1"></a>  pal <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">palette</span>(uniq) </span>
<span id="cb37-8"><a href="system-description.html#cb37-8" tabindex="-1"></a>  scaled <span class="ot">&lt;-</span> pal[<span class="fu">match</span>(x, uniq)]</span>
<span id="cb37-9"><a href="system-description.html#cb37-9" tabindex="-1"></a></span>
<span id="cb37-10"><a href="system-description.html#cb37-10" tabindex="-1"></a>  <span class="fu">ifelse</span>(<span class="sc">!</span><span class="fu">is.na</span>(scaled), scaled, self<span class="sc">$</span>na.value)</span>
<span id="cb37-11"><a href="system-description.html#cb37-11" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="proposed-model-of-scales" class="section level4 hasAnchor" number="4.2.7.5">
<h4><span class="header-section-number">4.2.7.5</span> Proposed model of scales<a href="system-description.html#proposed-model-of-scales" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>One feature that the models of scales that <code>D3</code> and <code>ggplot2</code> rely on is that they both treat the data domain and the visual attribute codomain as different types. In <code>D3</code>, fundamentally different functions are used to translate from <span class="math inline">\(D \to [0, 1]\)</span> and from <span class="math inline">\([0, 1] \to V\)</span>, and in <code>ggplot2</code>, <code>limits</code> is a simple vector/tuple whereas <code>palette</code> is a function. While these approaches may have some benefits, such as perhaps offering greater flexibility, they also add additional complexity. Specifically, we have to use two different mental models: one when considering the domain and another when considering the codomain. Further, these models of scales only work in one direction: mapping values <span class="math inline">\(D \to V\)</span>. For going the the other way, i.e. mapping <span class="math inline">\(V \to D\)</span>, other specialized functions have to be used.</p>
<p>I propose a model of scales which implements both the domain and the codomain as components of the same type: <code>Expanse</code>. Fundamentally, this makes it so that the only difference between the data domain and the visual attribute codomain is which property of the scale they are assigned to.</p>
<p>Here is a (slightly) simplified version of the <code>Scale</code> interface:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb38-1"><a href="system-description.html#cb38-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb38-2"><a href="system-description.html#cb38-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb38-3"><a href="system-description.html#cb38-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb38-4"><a href="system-description.html#cb38-4" tabindex="-1"></a>}</span></code></pre></div>
<p><code>D</code> and <code>V</code> represent the data domain and the visual attribute codomain, respectively.</p>
<p>The two fundamental functions connected to <code>Scale</code> are:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb39-1"><a href="system-description.html#cb39-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span></span>
<span id="cb39-2"><a href="system-description.html#cb39-2" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span></span></code></pre></div>
<p>The <code>pushforward</code> function <em>pushes values forward</em> through the scale, first through its domain and then its codomain, and the <code>pullback</code> function <em>pulls values back</em>, first through its codomain and then through its domain. The <code>ValueOf</code> type helper just identifies the type associated with the expanse’s data (e.g. <code>number</code> for a continuous <code>Expanse</code>, <code>string</code> for a discrete <code>Expanse</code>, etc…). I’ve omitted the generic type parameter constraint (<code>&lt;D extends Expanse, V extends Expanse&gt;</code>) for brevity.</p>
<p>Here is a simplified implementation of the two functions:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb40-1"><a href="system-description.html#cb40-1" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb40-2"><a href="system-description.html#cb40-2" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span> {</span>
<span id="cb40-3"><a href="system-description.html#cb40-3" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb40-4"><a href="system-description.html#cb40-4" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value))<span class="op">;</span></span>
<span id="cb40-5"><a href="system-description.html#cb40-5" tabindex="-1"></a>  }</span>
<span id="cb40-6"><a href="system-description.html#cb40-6" tabindex="-1"></a></span>
<span id="cb40-7"><a href="system-description.html#cb40-7" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">pullback</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> ValueOf<span class="op">&lt;</span>V<span class="op">&gt;</span>)<span class="op">:</span> ValueOf<span class="op">&lt;</span>D<span class="op">&gt;</span> {</span>
<span id="cb40-8"><a href="system-description.html#cb40-8" tabindex="-1"></a>    <span class="kw">const</span> { domain<span class="op">,</span> codomain } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb40-9"><a href="system-description.html#cb40-9" tabindex="-1"></a>    <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(domain<span class="op">,</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(codomain<span class="op">,</span> value))</span>
<span id="cb40-10"><a href="system-description.html#cb40-10" tabindex="-1"></a>  }</span>
<span id="cb40-11"><a href="system-description.html#cb40-11" tabindex="-1"></a>}</span></code></pre></div>
<p>We can see that most of the work is done by the two <code>Expanse</code> components: we use <code>domain</code> to translates <span class="math inline">\(D \to [0, 1]\)</span> and codomain to translate <span class="math inline">\([0, 1] \to V\)</span>. <code>Scale</code> only serves as plumbing, connecting the two together.</p>
<p>I argue that this model provides several benefits. First of all, it makes the code easier to reason about. Since both the <code>domain</code> and <code>codomain</code> are of the same type, we only need to keep a single mental model in mind. Second, if <code>domain</code> and <code>codomain</code> provide inverse functions (<code>unnormalize</code>), we get the inverse scale function <span class="math inline">\(V \to D\)</span> for free (this is just the <code>pullback</code> function).</p>
<p>However, before we discuss <code>Expanse</code>, there are also some important functionalities that we may want to implement on <code>Scale</code> directly. There are two main reasons for this. First, we may want these functionalities to apply generally, across the various <code>Expanse</code> subtypes. Second, by implementing them on <code>Scale</code>, we can keep the <code>Expanse</code> interface cleaner. These general functionalities will be the subject of the next few sections.</p>
<div id="zero-and-one" class="section level5 hasAnchor" number="4.2.7.5.1">
<h5><span class="header-section-number">4.2.7.5.1</span> Zero and one<a href="system-description.html#zero-and-one" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Recall how in Section <a href="system-description.html#simple-scale-limits">4.2.7.2</a>, we discussed the problem of expanding axis limits to display margins. Clearly, this is something that we also want to be able to do with our two-component scales. However, since we are designing an interactive data visualization system, we also want to be able to do more with axis limits: we want to be able to manipulate them dynamically during runtime, to implement features such as zooming and panning.</p>
<p>In Section <a href="system-description.html#simple-scale-limits">4.2.7.2</a>, we solved the problem of expanding axis limits by adding an additional argument to the <code>simpleScale</code> function. However, as was discussed previously, this approach does not scale well for more featureful implementations of scales. So how should we go about implementing dynamic axis limits in the context of the two-component scale system?</p>
<p>Suppose we want to add margins to a scale where both the domain or codomain are continuous, such as the x-axis in a typical scatterplot. To implement margins, we could either expand the range of the data (the domain) or shrink the range of the visual attribute (the codomain). However, expanding the domain seems like a bad idea - this only works if the domain is continuous, and, clearly, we may want to add margins to discrete scales too, such the the x-axis of a barplot. Shrinking the range of the codomain could work (most visual attributes are continuous), however, we would need to implement some custom logic for when the plot gets resized. Also, by treating codomain differently than the codomain, we would be breaking away from our intention of representing both with the same generic <code>Expanse</code> type.</p>
<p>So what can we do? As was foreshadowed at end of the previous section, we can put the functionality for expanding axis limits directly onto <code>Scale</code>. Specifically, notice that any values passing through a scale are first converted to the interval <span class="math inline">\([0, 1]\)</span> and then back to the space of either the domain or codomain:</p>
<p><span class="math display">\[D \to [0, 1] \to V\]</span></p>
<p>If we re-normalize these normalized values in <span class="math inline">\([0, 1]\)</span>, we effectively expand or shrink axis limits without having to touch either the domain or codomain. To give a metaphor, if we imagine <code>Scale</code> as a pipe connecting the <code>domain</code> and <code>codomain</code>, we can manipulate axis limits by stretching or squeezing this pipe, allowing more or less water to flow through.</p>
<p>To actually implement this, we can add two additional parameters to <code>Scale</code>, <code>zero</code> and <code>one</code>:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb41-1"><a href="system-description.html#cb41-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb41-2"><a href="system-description.html#cb41-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb41-3"><a href="system-description.html#cb41-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb41-4"><a href="system-description.html#cb41-4" tabindex="-1"></a>  props<span class="op">:</span> { <span class="co">// A dictionary of properties</span></span>
<span id="cb41-5"><a href="system-description.html#cb41-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb41-6"><a href="system-description.html#cb41-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb41-7"><a href="system-description.html#cb41-7" tabindex="-1"></a>  }</span>
<span id="cb41-8"><a href="system-description.html#cb41-8" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we can use these two parameters to implement a new version of the <code>pushforward</code> function:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb42-1"><a href="system-description.html#cb42-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;</span>(scale<span class="op">:</span> Scale<span class="op">&lt;</span>D<span class="op">,</span> V<span class="op">&gt;,</span> value<span class="op">:</span> D)<span class="op">:</span> V {</span>
<span id="cb42-2"><a href="system-description.html#cb42-2" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> props } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb42-3"><a href="system-description.html#cb42-3" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">,</span> one } <span class="op">=</span> props</span>
<span id="cb42-4"><a href="system-description.html#cb42-4" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)</span>
<span id="cb42-5"><a href="system-description.html#cb42-5" tabindex="-1"></a>  normalized <span class="op">=</span> zero <span class="op">+</span> normalized <span class="op">*</span> (one <span class="op">-</span> zero) <span class="co">// Re-normalize</span></span>
<span id="cb42-6"><a href="system-description.html#cb42-6" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)</span>
<span id="cb42-7"><a href="system-description.html#cb42-7" tabindex="-1"></a>}</span></code></pre></div>
<p>The new function’s body is a bit more dense, however, the only real change is in the line with the comment. When we re-normalize, we scale the normalized value by the <code>(zero - one)</code> range and increment it by <code>zero</code>. In other words, <code>zero</code> tells us the proportion of the codomain range that the minimum data value gets mapped to, and <code>one</code> tells us the proportion of the codomain range that the maximum data value gets mapped to.</p>
<p>For example, suppose we set <code>zero</code> to 0.1 and <code>one</code> to 0.9. Then we have effectively implemented 10% margins on either side of the scale. If our scale has a <span class="math inline">\([1, 10]\)</span> domain and <span class="math inline">\([0, 800]\)</span> codomain, this will result in the following mapping:</p>
<ul>
<li>The “minimum” data value (1) gets mapped to 10% of the codomain range (80)
<ul>
<li>Because <code>zero + 0 * (one - zero) = zero = 0.1</code></li>
</ul></li>
<li>The “maximum” data value (10) gets mapped to 90% of the codomain range (720)
<ul>
<li>Because <code>zero + 1 * (one - zero) = one = 0.9</code></li>
</ul></li>
</ul>
<p>Note the quotation marks around the words “minimum” and “maximum” - there is no requirement for the data to be continuous. For example, if the domain is a discrete <code>Expanse</code> which maps the string value <code>"A"</code> to zero, then the <code>pushforward</code> function will map <code>"A"</code> to 10% of the codomain range, just as it did in the case of the continuous domain. Likewise, the codomain could also be discrete - we could use this to implement scales for binned versions of visual attributes such as color or size.</p>
<p>Thus, we can use <code>zero</code> and <code>one</code> to implement margins. However, there is much more we can do with these parameters. First, despite the names, <code>zero</code> and <code>one</code> can both take values <em>less</em> than zero and <em>more</em> than one. For example, suppose we increment both <code>zero</code> and <code>one</code> by the same amount, e.g. we set <code>zero</code> to 0.1 and <code>one</code> to 1.1. Then, the minimum data value will get mapped to the 10% of the codomain range, and the maximum data value will get mapped to 110% of the codomain range (which may lie outside the space representable by the graphic device). If the codomain represents the x-axis position, then we have shifted all of the geometric objects 10% to the right. We have effectively implemented <em>panning</em>:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb43-1"><a href="system-description.html#cb43-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb43-2"><a href="system-description.html#cb43-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">zero</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb43-3"><a href="system-description.html#cb43-3" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">one</span> <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb43-4"><a href="system-description.html#cb43-4" tabindex="-1"></a>}</span></code></pre></div>
<p>That’s it. We have implemented a functionality for panning which will work no matter if <code>domain</code> translates numbers, strings, or some other more complex data types.</p>
<p>We can also stretch or shrink <code>zero</code> and <code>one</code> in opposite directions. For example, by setting <code>zero</code> to -0.5 and <code>one</code> to 1.5, then the minimum and maximum data values will get mapped 50% below and 50% above the limits of the codomain range, respectively, and the 25 and 75 data percentiles will get mapped to the minimum and maximum of the codomain range. If we apply this to the x- or y-axes, we’ve just implemented <em>zooming</em>.</p>
<p>To be perfectly honest, there’s a bit more ceremony involved with zooming. Specifically, if we don’t start from <code>zero = 0</code> and <code>one = 1</code> (e.g. if our plot already has margins or if we’re zooming in multiple levels deep), then we need to re-normalize within these values. This took me a bit of time to nail down, however, it’s just (highschool) algebra:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb44-1"><a href="system-description.html#cb44-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">rangeInverse</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb44-2"><a href="system-description.html#cb44-2" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">1</span> <span class="op">/</span> (max <span class="op">-</span> min)<span class="op">;</span></span>
<span id="cb44-3"><a href="system-description.html#cb44-3" tabindex="-1"></a>}</span>
<span id="cb44-4"><a href="system-description.html#cb44-4" tabindex="-1"></a></span>
<span id="cb44-5"><a href="system-description.html#cb44-5" tabindex="-1"></a><span class="kw">function</span> <span class="fu">invertRange</span>(min<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> max<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb44-6"><a href="system-description.html#cb44-6" tabindex="-1"></a>  <span class="kw">const</span> ri <span class="op">=</span> <span class="fu">rangeInverse</span>(min<span class="op">,</span> max)<span class="op">;</span></span>
<span id="cb44-7"><a href="system-description.html#cb44-7" tabindex="-1"></a>  <span class="cf">return</span> [<span class="op">-</span>min <span class="op">*</span> ri<span class="op">,</span> ri <span class="op">-</span> min <span class="op">*</span> ri]<span class="op">;</span></span>
<span id="cb44-8"><a href="system-description.html#cb44-8" tabindex="-1"></a>}</span>
<span id="cb44-9"><a href="system-description.html#cb44-9" tabindex="-1"></a></span>
<span id="cb44-10"><a href="system-description.html#cb44-10" tabindex="-1"></a><span class="im">namespace</span> <span class="dt">Scale</span> {</span>
<span id="cb44-11"><a href="system-description.html#cb44-11" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">expand</span>(</span>
<span id="cb44-12"><a href="system-description.html#cb44-12" tabindex="-1"></a>    scale<span class="op">:</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span> one<span class="op">:</span> <span class="dt">number</span> } }<span class="op">,</span></span>
<span id="cb44-13"><a href="system-description.html#cb44-13" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span><span class="op">,</span></span>
<span id="cb44-14"><a href="system-description.html#cb44-14" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb44-15"><a href="system-description.html#cb44-15" tabindex="-1"></a>  ) {</span>
<span id="cb44-16"><a href="system-description.html#cb44-16" tabindex="-1"></a>    <span class="kw">const</span> { zero<span class="op">:</span> currentZero<span class="op">,</span> one<span class="op">:</span> currentOne } <span class="op">=</span> scale<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb44-17"><a href="system-description.html#cb44-17" tabindex="-1"></a>    <span class="kw">const</span> currentRange <span class="op">=</span> currentOne <span class="op">-</span> currentZero<span class="op">;</span></span>
<span id="cb44-18"><a href="system-description.html#cb44-18" tabindex="-1"></a>    </span>
<span id="cb44-19"><a href="system-description.html#cb44-19" tabindex="-1"></a>    <span class="co">// Re-normalize within current values</span></span>
<span id="cb44-20"><a href="system-description.html#cb44-20" tabindex="-1"></a>    zero <span class="op">=</span> (zero <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb44-21"><a href="system-description.html#cb44-21" tabindex="-1"></a>    one <span class="op">=</span> (one <span class="op">-</span> currentZero) <span class="op">/</span> currentRange<span class="op">;</span></span>
<span id="cb44-22"><a href="system-description.html#cb44-22" tabindex="-1"></a></span>
<span id="cb44-23"><a href="system-description.html#cb44-23" tabindex="-1"></a>    <span class="co">// Invert</span></span>
<span id="cb44-24"><a href="system-description.html#cb44-24" tabindex="-1"></a>    [zero<span class="op">,</span> one] <span class="op">=</span> <span class="fu">invertRange</span>(zero<span class="op">,</span> one)<span class="op">;</span></span>
<span id="cb44-25"><a href="system-description.html#cb44-25" tabindex="-1"></a></span>
<span id="cb44-26"><a href="system-description.html#cb44-26" tabindex="-1"></a>    scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">zero</span> <span class="op">=</span> zero<span class="op">;</span></span>
<span id="cb44-27"><a href="system-description.html#cb44-27" tabindex="-1"></a>    scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">one</span> <span class="op">=</span> one<span class="op">;</span></span>
<span id="cb44-28"><a href="system-description.html#cb44-28" tabindex="-1"></a>  }</span>
<span id="cb44-29"><a href="system-description.html#cb44-29" tabindex="-1"></a>}</span>
<span id="cb44-30"><a href="system-description.html#cb44-30" tabindex="-1"></a></span>
<span id="cb44-31"><a href="system-description.html#cb44-31" tabindex="-1"></a><span class="kw">const</span> scale1 <span class="op">=</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> one<span class="op">:</span> <span class="dv">1</span> } }<span class="op">;</span> <span class="co">// Mock of default scale</span></span>
<span id="cb44-32"><a href="system-description.html#cb44-32" tabindex="-1"></a><span class="kw">const</span> scale2 <span class="op">=</span> { props<span class="op">:</span> { zero<span class="op">:</span> <span class="fl">0.1</span><span class="op">,</span> one<span class="op">:</span> <span class="fl">0.9</span> } }<span class="op">;</span> <span class="co">// Mock of scale with margins</span></span>
<span id="cb44-33"><a href="system-description.html#cb44-33" tabindex="-1"></a></span>
<span id="cb44-34"><a href="system-description.html#cb44-34" tabindex="-1"></a><span class="co">// Zoom into the middle 50% of either scale</span></span>
<span id="cb44-35"><a href="system-description.html#cb44-35" tabindex="-1"></a>Scale<span class="op">.</span><span class="fu">expand</span>(scale1<span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb44-36"><a href="system-description.html#cb44-36" tabindex="-1"></a>Scale<span class="op">.</span><span class="fu">expand</span>(scale2<span class="op">,</span> <span class="fl">0.25</span><span class="op">,</span> <span class="fl">0.75</span>)<span class="op">;</span></span>
<span id="cb44-37"><a href="system-description.html#cb44-37" tabindex="-1"></a></span>
<span id="cb44-38"><a href="system-description.html#cb44-38" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Zoomed in scale with no margins`</span><span class="op">,</span> scale1<span class="op">.</span><span class="at">props</span>)<span class="op">;</span></span>
<span id="cb44-39"><a href="system-description.html#cb44-39" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Zoomed in scale with 10% margins`</span><span class="op">,</span> scale2<span class="op">.</span><span class="at">props</span>)<span class="op">;</span></span></code></pre></div>
<pre><code>## Zoomed in scale with no margins {
##   zero: -0.5,
##   one: 1.5,
## }
## Zoomed in scale with 10% margins {
##   zero: -0.3,
##   one: 1.3,
## }</code></pre>
<p>As you can see, zooming into the middle 50% of a scale that already includes margins has a smaller effect on <code>zero</code> and <code>one</code>, since the margins have effectively expand the space we’re zooming into (i.e., a scale with margins is already <em>zoomed out</em>, in a way).</p>
</div>
<div id="direction" class="section level5 hasAnchor" number="4.2.7.5.2">
<h5><span class="header-section-number">4.2.7.5.2</span> Direction<a href="system-description.html#direction" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>In the same way we can think about expanding/shrinking axis limits in a way that is not coupled to any particular data representation or visual attribute, it may also be helpful to make direction a property of <code>Scale</code> rather than either of the <code>Expanse</code> components.</p>
<p>We <em>could</em> do this by manipulating the <code>zero</code> and <code>one</code> properties. For example, by setting <code>zero</code> to 1 and <code>one</code> to 0, we could effectively reverse the direction of the scale. However, in practice, this would complicate our logic and make it harder for someone to interpret the <code>Scale</code> properties. It is a better idea to add an explicit <code>direction</code> parameter instead:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb46-1"><a href="system-description.html#cb46-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb46-2"><a href="system-description.html#cb46-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb46-3"><a href="system-description.html#cb46-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb46-4"><a href="system-description.html#cb46-4" tabindex="-1"></a>  props<span class="op">:</span> {</span>
<span id="cb46-5"><a href="system-description.html#cb46-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb46-6"><a href="system-description.html#cb46-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb46-7"><a href="system-description.html#cb46-7" tabindex="-1"></a>    direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span> <span class="co">// Extra parameter</span></span>
<span id="cb46-8"><a href="system-description.html#cb46-8" tabindex="-1"></a>  }</span>
<span id="cb46-9"><a href="system-description.html#cb46-9" tabindex="-1"></a>}</span></code></pre></div>
<p>Like with <code>zero</code> and <code>one</code>, <code>direction</code> acts on the normalized values in <span class="math inline">\([0, 1]\)</span>. This means that we need to apply it in any transformations that use these values. For example, here’s an updated version of the <code>move</code> function:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb47-1"><a href="system-description.html#cb47-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">move</span>(scale<span class="op">:</span> Scale<span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb47-2"><a href="system-description.html#cb47-2" tabindex="-1"></a>  <span class="kw">let</span> { direction<span class="op">,</span> zero<span class="op">,</span> one } <span class="op">=</span> scale<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb47-3"><a href="system-description.html#cb47-3" tabindex="-1"></a>  zero <span class="op">+=</span> direction <span class="op">*</span> amount<span class="op">;</span></span>
<span id="cb47-4"><a href="system-description.html#cb47-4" tabindex="-1"></a>  one <span class="op">+=</span> direction <span class="op">*</span> amount<span class="op">;</span></span>
<span id="cb47-5"><a href="system-description.html#cb47-5" tabindex="-1"></a>}</span></code></pre></div>
<p>Likewise, the <code>pushforward</code>, <code>pullback</code>, and <code>expand</code> functions also need to take <code>direction</code> into account. Either way, with this functionality in place, it becomes trivial to flip or reverse a scale:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb48-1"><a href="system-description.html#cb48-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">function</span> <span class="fu">flip</span>(scale<span class="op">:</span> Scale) {</span>
<span id="cb48-2"><a href="system-description.html#cb48-2" tabindex="-1"></a>  scale<span class="op">.</span><span class="at">props</span><span class="op">.</span><span class="at">direction</span> <span class="op">-=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb48-3"><a href="system-description.html#cb48-3" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="multipliers" class="section level5 hasAnchor" number="4.2.7.5.3">
<h5><span class="header-section-number">4.2.7.5.3</span> Multipliers<a href="system-description.html#multipliers" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>Finally, it may also be helpful to have the ability to shrink/expand the normalized values by some constant without having to modify properties of either the <code>domain</code> or <code>codomain</code>. Again, this could be done by using the <code>zero</code> and <code>one</code> properties, however, it’s better to define separate properties instead. Specifically, we can add <em>two</em> additional parameters:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb49-1"><a href="system-description.html#cb49-1" tabindex="-1"></a><span class="kw">interface</span> Scale<span class="op">&lt;</span>D <span class="kw">extends</span> Expanse<span class="op">,</span> V <span class="kw">extends</span> Expanse<span class="op">&gt;</span> {</span>
<span id="cb49-2"><a href="system-description.html#cb49-2" tabindex="-1"></a>  domain<span class="op">:</span> D</span>
<span id="cb49-3"><a href="system-description.html#cb49-3" tabindex="-1"></a>  codomain<span class="op">:</span> V</span>
<span id="cb49-4"><a href="system-description.html#cb49-4" tabindex="-1"></a>  props<span class="op">:</span> {</span>
<span id="cb49-5"><a href="system-description.html#cb49-5" tabindex="-1"></a>    zero<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb49-6"><a href="system-description.html#cb49-6" tabindex="-1"></a>    one<span class="op">:</span> <span class="dt">number</span></span>
<span id="cb49-7"><a href="system-description.html#cb49-7" tabindex="-1"></a>    direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb49-8"><a href="system-description.html#cb49-8" tabindex="-1"></a>    scale<span class="op">:</span> <span class="dt">number</span> <span class="co">// Extra parameter</span></span>
<span id="cb49-9"><a href="system-description.html#cb49-9" tabindex="-1"></a>    mult<span class="op">:</span> <span class="dt">number</span> <span class="co">// And another one</span></span>
<span id="cb49-10"><a href="system-description.html#cb49-10" tabindex="-1"></a>  }</span>
<span id="cb49-11"><a href="system-description.html#cb49-11" tabindex="-1"></a>}</span></code></pre></div>
<p>The reason it is better to have two multiplier parameters instead of just one is that there are different reasons for why we may want to multiply values by a constant. First, we may want to multiply the values by some constant that remains fairly static throughout the lifetime of the program/visualization. That is the job of the <code>scale</code> parameter. Conversely, we may want to also dynamically manipulate the constant by which the values are multiplied. That is what <code>mult</code> is for. Having two multipliers makes it easier to reason about the scale’s behavior, as well as to apply changes such as restoring to defaults.</p>
<p>A good example of this is the barplot. In a typical barplot, all bars share the same width, which is some fraction of the width of the entire plotting region. Clearly, this fraction needs to depend on the number of bars in the plot, such that, with <span class="math inline">\(k\)</span> categories/bars, the bar width will be proportional to <span class="math inline">\(k\)</span>. However, we may also want to be able to make the bars wider/narrower interactively, e.g. by pressing the <code>+\-</code> keys. Thus, the width of the bars is proportional to <span class="math inline">\(c \cdot k\)</span> where <span class="math inline">\(k\)</span> is the static part of the constant (<code>scale</code>) and <span class="math inline">\(c\)</span> is the dynamic part of the constant (<code>mult</code>).</p>
<p>We apply the constant to the normalized value each time we push/pull a value through a scale:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb50-1"><a href="system-description.html#cb50-1" tabindex="-1"></a><span class="co">// This will be included in the body of pushforward(); see below for full example</span></span>
<span id="cb50-2"><a href="system-description.html#cb50-2" tabindex="-1"></a><span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)</span>
<span id="cb50-3"><a href="system-description.html#cb50-3" tabindex="-1"></a>normalized <span class="op">=</span> normalized <span class="op">*</span> scale <span class="op">*</span> mult</span></code></pre></div>
<p>Finally, we could hypothetically extend this idea to an entire array of different multipliers, that we could reduce into a single constant each time we push a value through a scale. This could be useful in some circumstances, however, in my application, I found that having two parameters was enough to solve all of my scaling problems. Additionally, having an array of multipliers might make the scaling functions slightly less performant, if we have to reduce the array each time we <code>pushforward</code>/<code>pullback</code>, or it might make keeping track of the state of the <code>Scale</code> object slightly more complicated, if we roll these multipliers into one constant each time we update the array. We would also lose the semantic distinction that we have with <code>scale</code> and <code>mult</code>. This might be a perfectly fine trade-off if our scales require more multipliers, however, I did not find this to be the case in my implementation.</p>
</div>
<div id="the-full-monty" class="section level5 hasAnchor" number="4.2.7.5.4">
<h5><span class="header-section-number">4.2.7.5.4</span> The Full Monty<a href="system-description.html#the-full-monty" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>With all of the pieces in place, we can put together the full implementation of the <code>pushforward</code> function.</p>
<p>It may be helpful to define two helper function for applying the <code>Scale</code> properties to a normalized value. First, the <code>applyDirection</code> function simply applies the <code>direction</code> property, such that <code>applyDirection(x, 1)</code> is simply the identity whereas <code>applyDirection(x, -1)</code> returns <code>1 - x</code> (i.e. moving from <code>one</code> down):</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb51-1"><a href="system-description.html#cb51-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyDirection</span>(x<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> direction<span class="op">:</span> <span class="dv">1</span> <span class="op">|</span> <span class="op">-</span><span class="dv">1</span>) {</span>
<span id="cb51-2"><a href="system-description.html#cb51-2" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.5</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> direction) <span class="op">+</span> direction <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb51-3"><a href="system-description.html#cb51-3" tabindex="-1"></a>}</span>
<span id="cb51-4"><a href="system-description.html#cb51-4" tabindex="-1"></a></span>
<span id="cb51-5"><a href="system-description.html#cb51-5" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">0.75</span><span class="op">,</span> <span class="dv">1</span>))</span>
<span id="cb51-6"><a href="system-description.html#cb51-6" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">0.75</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb51-7"><a href="system-description.html#cb51-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">applyDirection</span>(<span class="fl">1.25</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 0.75
## 0.25
## -0.25</code></pre>
<p>Second, we can define the <code>applyPropsForward</code> function which takes a normalized value and applies all of the <code>Scale</code> properties to it:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb53-1"><a href="system-description.html#cb53-1" tabindex="-1"></a><span class="kw">type</span> Props <span class="op">=</span> {</span>
<span id="cb53-2"><a href="system-description.html#cb53-2" tabindex="-1"></a>  zero<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb53-3"><a href="system-description.html#cb53-3" tabindex="-1"></a>  one<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb53-4"><a href="system-description.html#cb53-4" tabindex="-1"></a>  direction<span class="op">:</span> <span class="op">-</span><span class="dv">1</span> <span class="op">|</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb53-5"><a href="system-description.html#cb53-5" tabindex="-1"></a>  scale<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb53-6"><a href="system-description.html#cb53-6" tabindex="-1"></a>  mult<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb53-7"><a href="system-description.html#cb53-7" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb53-8"><a href="system-description.html#cb53-8" tabindex="-1"></a></span>
<span id="cb53-9"><a href="system-description.html#cb53-9" tabindex="-1"></a><span class="kw">function</span> <span class="fu">applyPropsForward</span>(x<span class="op">:</span> <span class="dt">number</span><span class="op">,</span> props<span class="op">:</span> Props) {</span>
<span id="cb53-10"><a href="system-description.html#cb53-10" tabindex="-1"></a>  <span class="kw">const</span> { zero<span class="op">,</span> one<span class="op">,</span> direction<span class="op">,</span> scale<span class="op">,</span> mult } <span class="op">=</span> props<span class="op">;</span></span>
<span id="cb53-11"><a href="system-description.html#cb53-11" tabindex="-1"></a>  x <span class="op">=</span> x <span class="op">*</span> scale <span class="op">*</span> mult<span class="op">;</span></span>
<span id="cb53-12"><a href="system-description.html#cb53-12" tabindex="-1"></a>  x <span class="op">=</span> zero <span class="op">+</span> x <span class="op">*</span> (one <span class="op">-</span> zero)<span class="op">;</span></span>
<span id="cb53-13"><a href="system-description.html#cb53-13" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">applyDirection</span>(x<span class="op">,</span> direction)<span class="op">;</span></span>
<span id="cb53-14"><a href="system-description.html#cb53-14" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we ready to define the full <code>pushforward</code> function. As one final note, we should probably be able to handle the case where the <code>domain</code> and <code>codomain</code> work on arrays of values rather than scalars (this can be helpful, for example, in the case of a parallel coordinates plot). As such, we can add an <code>if</code> block to check where the normalized value is an array and handle appropriately. In total:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb54-1"><a href="system-description.html#cb54-1" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pushforward</span><span class="op">&lt;</span>T <span class="kw">extends</span> Expanse<span class="op">,</span> U <span class="kw">extends</span> Expanse<span class="op">&gt;</span>(</span>
<span id="cb54-2"><a href="system-description.html#cb54-2" tabindex="-1"></a>  scale<span class="op">:</span> Scale<span class="op">&lt;</span>T<span class="op">,</span> U<span class="op">&gt;,</span></span>
<span id="cb54-3"><a href="system-description.html#cb54-3" tabindex="-1"></a>  value<span class="op">:</span> Expanse<span class="op">.</span><span class="at">Value</span><span class="op">&lt;</span>T<span class="op">&gt;,</span></span>
<span id="cb54-4"><a href="system-description.html#cb54-4" tabindex="-1"></a>)<span class="op">:</span> Expanse<span class="op">.</span><span class="at">Value</span><span class="op">&lt;</span>U<span class="op">&gt;</span> {</span>
<span id="cb54-5"><a href="system-description.html#cb54-5" tabindex="-1"></a>  <span class="kw">const</span> { domain<span class="op">,</span> codomain<span class="op">,</span> props } <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb54-6"><a href="system-description.html#cb54-6" tabindex="-1"></a>  <span class="kw">let</span> normalized <span class="op">=</span> Expanse<span class="op">.</span><span class="fu">normalize</span>(domain<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb54-7"><a href="system-description.html#cb54-7" tabindex="-1"></a></span>
<span id="cb54-8"><a href="system-description.html#cb54-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="bu">Array</span><span class="op">.</span><span class="fu">isArray</span>(normalized)) {</span>
<span id="cb54-9"><a href="system-description.html#cb54-9" tabindex="-1"></a>    normalized <span class="op">=</span> normalized<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> <span class="fu">applyPropsForward</span>(x<span class="op">,</span> props))<span class="op">;</span></span>
<span id="cb54-10"><a href="system-description.html#cb54-10" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb54-11"><a href="system-description.html#cb54-11" tabindex="-1"></a>    normalized <span class="op">=</span> <span class="fu">applyPropsForward</span>(normalized<span class="op">,</span> props)<span class="op">;</span></span>
<span id="cb54-12"><a href="system-description.html#cb54-12" tabindex="-1"></a>  }</span>
<span id="cb54-13"><a href="system-description.html#cb54-13" tabindex="-1"></a></span>
<span id="cb54-14"><a href="system-description.html#cb54-14" tabindex="-1"></a>  <span class="cf">return</span> Expanse<span class="op">.</span><span class="fu">unnormalize</span>(codomain<span class="op">,</span> normalized)<span class="op">;</span></span>
<span id="cb54-15"><a href="system-description.html#cb54-15" tabindex="-1"></a>}</span></code></pre></div>
<p>This is the full definition of the <code>pushforward</code> function in <code>plotscape</code> as of 2024-10-29. The implementation for <code>pullback</code> function is very similar, with the only differences being that the order of the <code>domain</code> and <code>codomain</code> arguments reversed, and it uses the <code>applyPropsBackward</code> function, which is not too difficult to derive.</p>
</div>
</div>
</div>
<div id="expanses" class="section level3 hasAnchor" number="4.2.8">
<h3><span class="header-section-number">4.2.8</span> Expanses<a href="system-description.html#expanses" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>So far, we have discussed scales, and described them as a sort of bridge between two properties of type <code>Expanse</code> - the domain and the codomain. However, we have left the precise nature of the <code>Expanse</code> type vague. Now it is finally time to discuss <code>Expanse</code> and its various subtypes concretely.</p>
<p>As mentioned previously, the job of the <code>Expanse&lt;T&gt;</code> is to translate values of type <code>T</code> (its domain) to and from the interval <span class="math inline">\([0, 1]^n\)</span>. This makes <code>Expanse</code> similar to the maps discussed in Section <a href="system-description.html#two-component-scales">4.2.7.3</a>. The reason why the normalized interval is identified as <span class="math inline">\([0, 1]^n\)</span> instead of the one-dimensional interval <span class="math inline">\([0, 1]\)</span> is because, sometimes, we may want to map multi-dimensional values. For example, in the parallel-coordinates plot, we want to map values of several different variables to the y-axis. Typically, the dimensionality of the normalized values will be the same as that of <code>T</code>, however, we could imagine a situation where it might not be so, for example, we could imagine mapping 3-dimensional vectors to their (normalized) length.</p>
<p>Most of the functionality is implemented by the specific subtypes of <code>Expanse</code>, however, there is also some shared behavior. The simplified interface of <code>Expanse</code> is:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb55-1"><a href="system-description.html#cb55-1" tabindex="-1"></a><span class="kw">interface</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb55-2"><a href="system-description.html#cb55-2" tabindex="-1"></a>  value<span class="op">:</span> T<span class="op">;</span></span>
<span id="cb55-3"><a href="system-description.html#cb55-3" tabindex="-1"></a>  normalized<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[]</span>
<span id="cb55-4"><a href="system-description.html#cb55-4" tabindex="-1"></a>}</span></code></pre></div>
<p>Here, the <code>value</code> and <code>normalized</code> properties are opaque types (used on type-level only), which simply indicate the domain type <code>T</code> and the dimensionality of the normalized values (<code>number | number[]</code>).</p>
<p>Each namespace corresponding to a subtype of <code>Expanse&lt;T&gt;</code> exports two important functions:</p>
<ul>
<li>A <em>normalize</em> function <span class="math inline">\(n: T \to [0, 1]^n\)</span>, mapping values from <span class="math inline">\(T\)</span> to <span class="math inline">\([0, 1]^n\)</span></li>
<li>An <em>unnormalize</em> function <span class="math inline">\(u: [0, 1]^n \to T\)</span>, mapping values from <span class="math inline">\([0, 1]^n\)</span> to <span class="math inline">\(T\)</span></li>
</ul>
<p>There are two other important methods that each <code>Expanse</code> subtype must export: <code>train</code> and <code>breaks</code>. The <code>train</code> function allows the expanse to train on new data (for example, after a histogram binwidth has been changed). The <code>breaks</code> function simply returns an array of breaks of type <code>T</code>. Thus, each subtype of <code>Expanse</code> implements the following polymorphic methods:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb56-1"><a href="system-description.html#cb56-1" tabindex="-1"></a><span class="kw">interface</span> ExpanseMethods<span class="op">&lt;</span>T<span class="op">&gt;</span> {</span>
<span id="cb56-2"><a href="system-description.html#cb56-2" tabindex="-1"></a>  <span class="fu">normalize</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> value<span class="op">:</span> T)<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb56-3"><a href="system-description.html#cb56-3" tabindex="-1"></a>  <span class="fu">unnormalize</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> value<span class="op">:</span> <span class="dt">number</span> <span class="op">|</span> <span class="dt">number</span>[])<span class="op">:</span> T<span class="op">;</span></span>
<span id="cb56-4"><a href="system-description.html#cb56-4" tabindex="-1"></a>  <span class="fu">train</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> values<span class="op">:</span> T[]<span class="op">,</span> options<span class="op">?:</span> <span class="bu">Record</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">,</span> <span class="dt">any</span><span class="op">&gt;</span>)<span class="op">:</span> <span class="dt">void</span><span class="op">;</span></span>
<span id="cb56-5"><a href="system-description.html#cb56-5" tabindex="-1"></a>  <span class="fu">breaks</span>(expanse<span class="op">:</span> Expanse<span class="op">&lt;</span>T<span class="op">&gt;,</span> zero<span class="op">?:</span> <span class="dt">number</span><span class="op">,</span> one<span class="op">?:</span> <span class="dt">number</span>)<span class="op">:</span> T[] <span class="op">|</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb56-6"><a href="system-description.html#cb56-6" tabindex="-1"></a>}</span></code></pre></div>
<div id="continuous-expanses" class="section level4 hasAnchor" number="4.2.8.1">
<h4><span class="header-section-number">4.2.8.1</span> Continuous expanses<a href="system-description.html#continuous-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A continuous expanse is a generalization of the linear mapping discussed in Section <a href="system-description.html#two-component-scales">4.2.7.3</a>. That is, it translates values to and from a continuous interval given (roughly) by <span class="math inline">\([\text{min}, \text{max}]\)</span>. Here is a simplified interface:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb57-1"><a href="system-description.html#cb57-1" tabindex="-1"></a><span class="kw">interface</span> ExpanseContinuous {</span>
<span id="cb57-2"><a href="system-description.html#cb57-2" tabindex="-1"></a>  min<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb57-3"><a href="system-description.html#cb57-3" tabindex="-1"></a>  max<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb57-4"><a href="system-description.html#cb57-4" tabindex="-1"></a>  offset<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb57-5"><a href="system-description.html#cb57-5" tabindex="-1"></a>  trans<span class="op">:</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb57-6"><a href="system-description.html#cb57-6" tabindex="-1"></a>  inv<span class="op">:</span> (x<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb57-7"><a href="system-description.html#cb57-7" tabindex="-1"></a>  ratio<span class="op">:</span> <span class="dt">boolean</span><span class="op">;</span></span>
<span id="cb57-8"><a href="system-description.html#cb57-8" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>min</code> and <code>max</code> properties are fairly self-explanatory - they denote the minimum and maximum of the data. The <code>offset</code> property allows us to move values by some constant, either before they have been normalized or after they have been unnormalized. This is useful, for example, when we want to ensure that the width of a spineplot bar is exactly 1 pixel less than the available space. The <code>trans</code> and <code>inv</code> properties allow us to perform non-linear transformations (they should, intuitively, be inverses of each other). By default, they are both set to the identity function (<code>(x) =&gt; x</code>). Finally, the <code>ratio</code> property is a simple boolean flag which indicates whether the expanse is part of a ratio scale. If this flag is set to <code>true</code>, then the <code>min</code> value of the expanse must always be zero and we cannot change it by, for example, training on new data.</p>
<p>The normalize and unnormalize functions in the <code>ExpanseContinuous</code> namespace are generalizations of the linear map:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb58-1"><a href="system-description.html#cb58-1" tabindex="-1"></a><span class="co">// ExpanseContinuous.ts</span></span>
<span id="cb58-2"><a href="system-description.html#cb58-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpanseContinuous</span> {</span>
<span id="cb58-3"><a href="system-description.html#cb58-3" tabindex="-1"></a>    <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpanseContinuous<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb58-4"><a href="system-description.html#cb58-4" tabindex="-1"></a>    <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> offset<span class="op">,</span> trans } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb58-5"><a href="system-description.html#cb58-5" tabindex="-1"></a>    <span class="cf">return</span> (<span class="fu">trans</span>(value <span class="op">-</span> offset) <span class="op">-</span> <span class="fu">trans</span>(min)) <span class="op">/</span> (<span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min))<span class="op">;</span></span>
<span id="cb58-6"><a href="system-description.html#cb58-6" tabindex="-1"></a>  }</span>
<span id="cb58-7"><a href="system-description.html#cb58-7" tabindex="-1"></a></span>
<span id="cb58-8"><a href="system-description.html#cb58-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpanseContinuous<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb58-9"><a href="system-description.html#cb58-9" tabindex="-1"></a>    <span class="kw">const</span> { min<span class="op">,</span> max<span class="op">,</span> offset<span class="op">,</span> trans<span class="op">,</span> inv } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb58-10"><a href="system-description.html#cb58-10" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">inv</span>(<span class="fu">trans</span>(min) <span class="op">+</span> value <span class="op">*</span> (<span class="fu">trans</span>(max) <span class="op">-</span> <span class="fu">trans</span>(min))) <span class="op">+</span> offset<span class="op">;</span></span>
<span id="cb58-11"><a href="system-description.html#cb58-11" tabindex="-1"></a>  }</span>
<span id="cb58-12"><a href="system-description.html#cb58-12" tabindex="-1"></a>}</span></code></pre></div>
<p>And these work as we would expect:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb59-1"><a href="system-description.html#cb59-1" tabindex="-1"></a><span class="im">import</span> { ExpanseContinuous } <span class="im">from</span> <span class="st">&quot;./ExpanseContinuous&quot;</span></span>
<span id="cb59-2"><a href="system-description.html#cb59-2" tabindex="-1"></a></span>
<span id="cb59-3"><a href="system-description.html#cb59-3" tabindex="-1"></a><span class="kw">const</span> identity <span class="op">=</span> (x) <span class="kw">=&gt;</span> x<span class="op">;</span></span>
<span id="cb59-4"><a href="system-description.html#cb59-4" tabindex="-1"></a><span class="co">// I could have defined a proper constructor above but opted not to to save lines</span></span>
<span id="cb59-5"><a href="system-description.html#cb59-5" tabindex="-1"></a><span class="kw">const</span> exp <span class="op">=</span> { min<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> max<span class="op">:</span> <span class="dv">16</span><span class="op">,</span> offset<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> trans<span class="op">:</span> identity<span class="op">,</span> inv<span class="op">:</span> identity }<span class="op">;</span></span>
<span id="cb59-6"><a href="system-description.html#cb59-6" tabindex="-1"></a></span>
<span id="cb59-7"><a href="system-description.html#cb59-7" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(ExpanseContinuous<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> <span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb59-8"><a href="system-description.html#cb59-8" tabindex="-1"></a>exp<span class="op">.</span><span class="at">trans</span> <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span><span class="op">;</span> <span class="co">// Technically, we should also set inverse to square</span></span>
<span id="cb59-9"><a href="system-description.html#cb59-9" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(ExpanseContinuous<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> <span class="dv">4</span>))<span class="op">;</span></span></code></pre></div>
<pre><code>## 0.2
## 0.3333333333333333</code></pre>
<p>Finally, the <code>ExpanseContinuous</code> namespace also export a <code>train</code> function, which goes through an array values and updates the min and max properties (max only if <code>ratio</code> is set to <code>true</code>), and a <code>breaks</code> function which returns a list of breaks, using an algorithm inspired by base R’s <code>pretty</code> function.</p>
</div>
<div id="point-expanses" class="section level4 hasAnchor" number="4.2.8.2">
<h4><span class="header-section-number">4.2.8.2</span> Point expanses<a href="system-description.html#point-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>A point expanse is the simplest type of discrete expanse. It simply places values at equidistant points along the <span class="math inline">\([0, 1]\)</span> interval, based on an ordered array of labels. Here is a simplified interface:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb61-1"><a href="system-description.html#cb61-1" tabindex="-1"></a><span class="kw">interface</span> ExpansePoint {</span>
<span id="cb61-2"><a href="system-description.html#cb61-2" tabindex="-1"></a>    labels<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb61-3"><a href="system-description.html#cb61-3" tabindex="-1"></a>    order<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb61-4"><a href="system-description.html#cb61-4" tabindex="-1"></a>}</span></code></pre></div>
<p>The <code>labels</code> array contains the all of the unique values that data take (strings). The <code>order</code> array is a simple array of indices which represent the order in which the labels get assigned to points in the <span class="math inline">\([0, 1]\)</span> interval.</p>
<p>The normalize and unnormalize functions in the <code>ExpansePoint</code> namespace simply use a label to find the corresponding point in <span class="math inline">\([0, 1]\)</span> or the use a point to find the closest label, while respecting the <code>order</code>:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb62-1"><a href="system-description.html#cb62-1" tabindex="-1"></a><span class="co">// ExpansePoint.ts</span></span>
<span id="cb62-2"><a href="system-description.html#cb62-2" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpansePoint</span> {</span>
<span id="cb62-3"><a href="system-description.html#cb62-3" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpansePoint<span class="op">,</span> value<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb62-4"><a href="system-description.html#cb62-4" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb62-5"><a href="system-description.html#cb62-5" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> order[labels<span class="op">.</span><span class="fu">indexOf</span>(value)]<span class="op">;</span></span>
<span id="cb62-6"><a href="system-description.html#cb62-6" tabindex="-1"></a>    <span class="cf">if</span> (index <span class="op">===</span> <span class="op">-</span><span class="dv">1</span>) <span class="cf">return</span> index<span class="op">;</span></span>
<span id="cb62-7"><a href="system-description.html#cb62-7" tabindex="-1"></a>    <span class="cf">return</span> index <span class="op">/</span> (labels<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb62-8"><a href="system-description.html#cb62-8" tabindex="-1"></a>  }</span>
<span id="cb62-9"><a href="system-description.html#cb62-9" tabindex="-1"></a></span>
<span id="cb62-10"><a href="system-description.html#cb62-10" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpansePoint<span class="op">,</span> index<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb62-11"><a href="system-description.html#cb62-11" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb62-12"><a href="system-description.html#cb62-12" tabindex="-1"></a>    index <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">round</span>(index <span class="op">*</span> (labels<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb62-13"><a href="system-description.html#cb62-13" tabindex="-1"></a>    <span class="cf">return</span> labels[order[index]]<span class="op">;</span></span>
<span id="cb62-14"><a href="system-description.html#cb62-14" tabindex="-1"></a>  }</span>
<span id="cb62-15"><a href="system-description.html#cb62-15" tabindex="-1"></a>}</span></code></pre></div>
<p>Again, these functions work as we would expect:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb63-1"><a href="system-description.html#cb63-1" tabindex="-1"></a><span class="im">import</span> { ExpansePoint } <span class="im">from</span> <span class="st">&quot;./ExpansePoint&quot;</span></span>
<span id="cb63-2"><a href="system-description.html#cb63-2" tabindex="-1"></a></span>
<span id="cb63-3"><a href="system-description.html#cb63-3" tabindex="-1"></a><span class="kw">const</span> cities <span class="op">=</span> [<span class="st">&quot;Berlin&quot;</span><span class="op">,</span> <span class="st">&quot;Prague&quot;</span><span class="op">,</span> <span class="st">&quot;Vienna&quot;</span>]</span>
<span id="cb63-4"><a href="system-description.html#cb63-4" tabindex="-1"></a></span>
<span id="cb63-5"><a href="system-description.html#cb63-5" tabindex="-1"></a><span class="kw">const</span> exp <span class="op">=</span> {</span>
<span id="cb63-6"><a href="system-description.html#cb63-6" tabindex="-1"></a>  labels<span class="op">:</span> cities<span class="op">,</span></span>
<span id="cb63-7"><a href="system-description.html#cb63-7" tabindex="-1"></a>  order<span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span>]<span class="op">,</span></span>
<span id="cb63-8"><a href="system-description.html#cb63-8" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb63-9"><a href="system-description.html#cb63-9" tabindex="-1"></a></span>
<span id="cb63-10"><a href="system-description.html#cb63-10" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cities<span class="op">.</span><span class="fu">map</span>(city <span class="kw">=&gt;</span> ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> city)))<span class="op">;</span></span>
<span id="cb63-11"><a href="system-description.html#cb63-11" tabindex="-1"></a>exp<span class="op">.</span><span class="at">order</span>[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// Swap the order of the first two values</span></span>
<span id="cb63-12"><a href="system-description.html#cb63-12" tabindex="-1"></a>exp<span class="op">.</span><span class="at">order</span>[<span class="dv">1</span>] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb63-13"><a href="system-description.html#cb63-13" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(cities<span class="op">.</span><span class="fu">map</span>(city <span class="kw">=&gt;</span> ExpansePoint<span class="op">.</span><span class="fu">normalize</span>(exp<span class="op">,</span> city)))<span class="op">;</span></span></code></pre></div>
<pre><code>## [ 0, 0.5, 1 ]
## [ 0.5, 0, 1 ]</code></pre>
<p>Like <code>ExpanseContinuous</code>, the <code>ExpansePoint</code> namespace also contains a <code>train</code> function, which loops through an array of labels and finds all of the unique values, as well as a <code>breaks</code> function, which simply returns ordered <code>labels</code>. Further, the namespace also contains a <code>reorder</code> function which mutates the <code>order</code> property based on an array of indices.</p>
</div>
<div id="band-expanses" class="section level4 hasAnchor" number="4.2.8.3">
<h4><span class="header-section-number">4.2.8.3</span> Band expanses<a href="system-description.html#band-expanses" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>While <code>ExpansePoint</code> places values at equidistant points along <span class="math inline">\([0, 1]\)</span>, <code>ExpanseBand</code> places values at the midpoints of corresponding bins or bands. These bands can have variable widths, which is useful, for example, when specifying the x-axis position in a barplot. The simplified interface of <code>ExpanseBand</code> is the following:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb65-1"><a href="system-description.html#cb65-1" tabindex="-1"></a><span class="im">export</span> <span class="kw">interface</span> ExpanseBand {</span>
<span id="cb65-2"><a href="system-description.html#cb65-2" tabindex="-1"></a>  labels<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb65-3"><a href="system-description.html#cb65-3" tabindex="-1"></a>  order<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb65-4"><a href="system-description.html#cb65-4" tabindex="-1"></a>  weights<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb65-5"><a href="system-description.html#cb65-5" tabindex="-1"></a>  cumulativeWeights<span class="op">:</span> <span class="dt">number</span>[]<span class="op">;</span></span>
<span id="cb65-6"><a href="system-description.html#cb65-6" tabindex="-1"></a>}</span></code></pre></div>
<p>Like <code>ExpansePoint</code>, <code>ExpanseBand</code> has the <code>labels</code> and <code>order</code> properties, which work exactly the same way as before. However, additionally, it also has the <code>weights</code> and <code>cumulativeWeights</code> properties, which are numeric arrays that define the width of each band. <code>weights</code> record the width of each band, and <code>cumulativeWeights</code> record the cumulative sums of the weights, which are used in the <code>normalize</code> and <code>unnormalize</code> functions. Thus, each time we update <code>weights</code>, we need to also update <code>cumulativeWeights</code> as well.</p>
<p>The normalize and unnormalize functions in the <code>ExpanseBand</code> namespace map labels to and from the midpoint of their corresponding bands:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb66-1"><a href="system-description.html#cb66-1" tabindex="-1"></a><span class="im">export</span> <span class="im">namespace</span> <span class="dt">ExpanseBand</span> {</span>
<span id="cb66-2"><a href="system-description.html#cb66-2" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">normalize</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> value<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb66-3"><a href="system-description.html#cb66-3" tabindex="-1"></a>    <span class="kw">const</span> { labels } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb66-4"><a href="system-description.html#cb66-4" tabindex="-1"></a>    <span class="kw">const</span> index <span class="op">=</span> labels<span class="op">.</span><span class="fu">indexOf</span>(value)<span class="op">;</span></span>
<span id="cb66-5"><a href="system-description.html#cb66-5" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">getMidpoint</span>(expanse<span class="op">,</span> index)<span class="op">;</span></span>
<span id="cb66-6"><a href="system-description.html#cb66-6" tabindex="-1"></a>  }</span>
<span id="cb66-7"><a href="system-description.html#cb66-7" tabindex="-1"></a></span>
<span id="cb66-8"><a href="system-description.html#cb66-8" tabindex="-1"></a>  <span class="im">export</span> <span class="kw">function</span> <span class="fu">unnormalize</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> value<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb66-9"><a href="system-description.html#cb66-9" tabindex="-1"></a>    <span class="kw">const</span> { labels<span class="op">,</span> order<span class="op">,</span> cumulativeWeights } <span class="op">=</span> expanse<span class="op">;</span></span>
<span id="cb66-10"><a href="system-description.html#cb66-10" tabindex="-1"></a></span>
<span id="cb66-11"><a href="system-description.html#cb66-11" tabindex="-1"></a>    <span class="kw">const</span> weight <span class="op">=</span> value <span class="op">*</span> <span class="fu">last</span>(cumulativeWeights)<span class="op">;</span></span>
<span id="cb66-12"><a href="system-description.html#cb66-12" tabindex="-1"></a>    <span class="kw">let</span> index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb66-13"><a href="system-description.html#cb66-13" tabindex="-1"></a></span>
<span id="cb66-14"><a href="system-description.html#cb66-14" tabindex="-1"></a>    <span class="cf">while</span> (index <span class="op">&lt;</span> cumulativeWeights<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>) {</span>
<span id="cb66-15"><a href="system-description.html#cb66-15" tabindex="-1"></a>      <span class="cf">if</span> (cumulativeWeights[index] <span class="op">&gt;=</span> weight) <span class="cf">break</span><span class="op">;</span></span>
<span id="cb66-16"><a href="system-description.html#cb66-16" tabindex="-1"></a>      index<span class="op">++;</span></span>
<span id="cb66-17"><a href="system-description.html#cb66-17" tabindex="-1"></a>    }</span>
<span id="cb66-18"><a href="system-description.html#cb66-18" tabindex="-1"></a></span>
<span id="cb66-19"><a href="system-description.html#cb66-19" tabindex="-1"></a>    <span class="cf">return</span> labels[order[index]]<span class="op">;</span></span>
<span id="cb66-20"><a href="system-description.html#cb66-20" tabindex="-1"></a>  }</span>
<span id="cb66-21"><a href="system-description.html#cb66-21" tabindex="-1"></a></span>
<span id="cb66-22"><a href="system-description.html#cb66-22" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">getMidpoint</span>(expanse<span class="op">:</span> ExpanseBand<span class="op">,</span> index<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb66-23"><a href="system-description.html#cb66-23" tabindex="-1"></a>    <span class="kw">const</span> { order<span class="op">,</span> cumulativeWeights } <span class="op">=</span> expanse<span class="op">.</span><span class="at">props</span><span class="op">;</span></span>
<span id="cb66-24"><a href="system-description.html#cb66-24" tabindex="-1"></a>    index <span class="op">=</span> order[index]<span class="op">;</span></span>
<span id="cb66-25"><a href="system-description.html#cb66-25" tabindex="-1"></a></span>
<span id="cb66-26"><a href="system-description.html#cb66-26" tabindex="-1"></a>    <span class="kw">const</span> lower <span class="op">=</span> cumulativeWeights[index <span class="op">-</span> <span class="dv">1</span>] <span class="op">??</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb66-27"><a href="system-description.html#cb66-27" tabindex="-1"></a>    <span class="kw">const</span> upper <span class="op">=</span> cumulativeWeights[index]<span class="op">;</span></span>
<span id="cb66-28"><a href="system-description.html#cb66-28" tabindex="-1"></a>    <span class="kw">const</span> max <span class="op">=</span> <span class="fu">last</span>(cumulativeWeights)<span class="op">;</span></span>
<span id="cb66-29"><a href="system-description.html#cb66-29" tabindex="-1"></a></span>
<span id="cb66-30"><a href="system-description.html#cb66-30" tabindex="-1"></a>    <span class="cf">return</span> (lower <span class="op">+</span> upper) <span class="op">/</span> <span class="dv">2</span> <span class="op">/</span> max<span class="op">;</span></span>
<span id="cb66-31"><a href="system-description.html#cb66-31" tabindex="-1"></a>  }</span>
<span id="cb66-32"><a href="system-description.html#cb66-32" tabindex="-1"></a>}</span></code></pre></div>
<p>Notice that, because of the cumulative nature of the bands, the logic in the functions’ bodies is a bit more complicated. First, to <code>normalize</code> a label, we need to first find the index of the label and then return the corresponding midpoint of the band, taking <code>weights</code> and <code>order</code> into account. Second, to <code>unnormalize</code>, we actually have to loop through the array of <code>cumulativeWeights</code> - there is no way to determine which bin a normalized value belongs to in <span class="math inline">\(O(1)\)</span> time (as far as I am aware). This is not much of a problem since the <code>ExpanseBand.unnormalize</code> is not used anywhere in the system (all scales implemented thus far use only <code>ExpanseBand.normalize</code>), however, it is important to be mindful of this.</p>
<!-- Notice that, whereas before we had considered *normalize* as mapping between $D \to [0, 1]$ and *unnormalize* as mapping between $[0, 1] \to V$, we now consider both as mapping between $[0, 1]$ and an arbitrary domain $X$. This domain can represent the data or the visual attribute - the expanse is agnostic about this. -->
<!-- Also, while before we have discussed domains as subsets of $\mathbb{R}$, we can now start thinking about them as arbitrary sets. While subsets of $\mathbb{R}$ and sets of strings are really the only types of domains used in `plotscaper`, the model should readily extends to other sets, as long as a mapping to and from $[0, 1]$ can be provided. -->
<!-- How `normalize` and `unnormalize` are implemented will depend largely on the subtype of `Expanse`, as well as on the desired behavior. For example, as will be discussed later, in `plotscaper`, the normalize and unnormalize methods implemented for `ExpanseContinuous` (subtype of `Expanse<number>`) work largely the same way as in section [SECTION]. However, while `ExpansePoint` and `ExpanseBand` are both subtypes of `Expanse<string>`, they behave differently - `ExpansePoint` maps strings (factor levels) to equidistant points along $[0, 1]$, whereas `ExpanseBand` maps the strings into the middle of "buckets" along $[0, 1]$.    -->
<!-- However, there is also some behavior that we may want to apply the same way across the different expanse subtypes. For example, it seems reasonable that the user should be able to zoom, pan, or reverse axes, regardless of whether a plot shows discrete or continuous data. As such, there may be some properties and functions common to the `Expanse` type. I will discuss these first. -->
<!-- #### Zero and one -->
<!-- The maps may also take in and return values outside of $D^*$ and $[0, 1]$, if adjustments have been made. For instance, in most data visualization packages, x- and y-axis limits are by default expanded some percentage beyond the range of the observed data to avoid the maximum and minimum datapoints from overlapping with the limits. For example, in base R: -->
<!-- ```{r} -->
<!-- #| fig-height: 4 -->
<!-- #| fig-cap: "Expanding axes. By default, axes in base R `plot()` function are expanded 4% beyond the range of the data (left). Otherwise, datapoints on the limits of their respective scales end up overlapping with the plot borders (right)." -->
<!-- set.seed(12345) -->
<!-- x <- rnorm(5) -->
<!-- y <- rnorm(5) -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(x, y)  -->
<!-- plot(x, y, xaxs = 'i', yaxs = 'i')  -->
<!-- ``` -->
<!-- Thus, upon normalizing the minimum and maximum data values, the expanse should return values other than $\{0, 1\}$. Likewise, to support user interactions such as zooming and panning, the expanses may accept and return values outside of $D^*$ and $[0, 1]$.  -->
<!-- Zooming and panning should be orthogonal to the underlying data type, such that user can interact with the plots the same way^[The one exception may be panning barplots and histograms, where the y-axis upper y-axis limit may change but the lower should be fixed at 0, such that panning may shrink or stretch the bars, but not "lift" them up or move them down.], no matter whether their axes are continuous, discrete, or some combination of the two. To this end, I introduce two parameters representing the normalized value ($p$) of the minimum and maximum data point, called *zero* and *one* respectively. These parameters are agnostic to the underlying data type, such that if we have the data type-specific maps $n'$ and $u'$, the complete normalize and unnormalize maps are: -->
<!-- $$n(d) = \text{zero} + n'(d) \cdot (\text{one} - \text{zero})$$ -->
<!-- $$u(p) = u' \bigg(\frac{p - \text{zero}}{\text{one} - \text{zero}} \bigg)$$ -->
<!-- To simplify, here's what effect setting the two parameters to specific values has: -->
<!-- ```{r} -->
<!-- #| echo: false -->
<!-- tab <- data.frame( -->
<!--   Zero = c(0.05, 0.05, -0.5), -->
<!--   One = c(0.95, 1.05, 1.5), -->
<!--   Effect = c("Expands the margins by ~5% (actually 5.555...% since 0.05 / 0.9 = 0.0555...)", -->
<!--              "Shifts the expanse 'up' by 5% (e.g. moves x-axis 5% right)", -->
<!--              "Zooms into the middle 50% of the expanse (25 percentile goes to 0 and 75th to one)") -->
<!-- ) -->
<!-- knitr::kable(tab) -->
<!-- ``` -->
<!-- #### Expanse Interface -->
<!-- There are also other behaviours that expanses should support. For instance, we may want to be able to reset the expanse to defaults, retrain when the underlying data changes, and return nicely formatted breaks. How these behaviours are implemented, as well as other types of behavior, may be specific to the underlying data type. Overall, expanse interface may look something like this: -->
<!-- ``` -->
<!-- interface Expanse<T> { -->
<!--   normalize(value: T): number -->
<!--   unnormalize(value: number): T -->
<!--   defaultize(): this -->
<!--   setZero(zero: number, default: boolean): this -->
<!--   setOne(one: number, default: boolean): this -->
<!--   freezeZero(): this -->
<!--   freezeOne(): this -->
<!--   move(amount: number): this -->
<!--   expand(zero: number, one: number): this -->
<!--   retrain(values: T[]): this -->
<!--   breaks(n?: number): T[]   -->
<!-- } -->
<!-- ``` -->
<!-- #### Continuous Expanses -->
<!-- The continuous expanse has as its underlying set $[\min, \max] \subseteq \mathbb{R}$. To understand how it works, let's build it step by step.  -->
<!-- We start with the basic normalizing function: -->
<!-- 1. $$n(d) = \frac{d - \min}{\max - \min}$$ -->
<!-- This function takes some data value $d \in [\min, \max]$ and transforms it to $[0, 1]$. Most data visualization systems use a function like this at some step of the scaling processs - see [`scales::rescale`](https://github.com/r-lib/scales/blob/84560bf54e02315477a05384ee67991e9e8fc52c/R/bounds.R#L85) and **D3** [`normalize`](https://github.com/d3/d3-scale/blob/d6904a4bde09e16005e0ad8ca3e25b10ce54fa0d/src/continuous.js#L122).    -->
<!-- This may work well for typical linear scales. However, we may also want to apply some transformation $f$, such as square root or log. Then, to ensure that the observed data values still get normalized to $[0, 1]$, we need to apply the transformation to both $d$ and the limits: -->
<!-- 2. $$\frac{f(d) - f(\min)}{f(\max) - f(\min)}$$ -->
<!-- Finally, as was discussed in [EXPANSES], we want to be able to incorporate the zero and one paramaters, leading to the final normalizing function: -->
<!-- $$n(d) = \text{zero} + \frac{f(d) - f(\min)}{f(\max) - f(\min)} \cdot (\text{zero} - \text{one})$$ -->
<!-- To obtain the unnormalizing function, we can simply invert the normalizing function: -->
<!-- $$u(p) = f^{-1} \bigg\{ f(\min) + \frac{p - \text{zero}}{\text{one} - \text{zero}} \cdot \big[ f(\max) - f(\min) \big] \bigg\}$$ -->
<!-- The function transforms $x$ to a percentage value $p \in [0, 1]$, provided $x$ is within $[\min, \max]$. The value $(\max - \min)$ is also sometimes called the *range* (not to be confused with **D3** `range`).  -->
<!-- We can invert the normalizing function and obtain the unnormalizing function, which is, for some percentage $p \in [0, 1]$: -->
<!-- $$u(p) = \min + p \cdot (\max - \min)$$ -->
<!-- returns a value within the $[\min, \max]$ range, corresponding to the proportion of the maximum possible distance (range) from the origin ($\min$). For example, $u(0.5)$, returns a value that is located halfway between the limits. -->
<!-- We can implement a simple continuous expanse like so: -->
<!-- ```{ts} -->
<!-- function identity<T>(x: T) { -->
<!--   return x; -->
<!-- } -->
<!-- function expanseContinuous(min = 0, max = 1) { -->
<!--   const [zero, one] = [0, 1] -->
<!--   const [trans, inv] = [identity, identity] -->
<!--   return { min, max, zero, one, trans, inv, -->
<!--     range() { -->
<!--       return this.max - this.min; -->
<!--     }, -->
<!--     transRange() { -->
<!--       const { min, max, trans } = this; -->
<!--       return trans(max) - trans(min); -->
<!--     }, -->
<!--     normalize(x: number) { -->
<!--       const { min, zero, one, trans } = this; -->
<!--       const normalized = (trans(x) - trans(min)) / this.transRange(); -->
<!--       return zero + normalized * (one - zero); -->
<!--     }, -->
<!--     unnormalize(p: number) { -->
<!--       const { min, zero, one, trans, inv } = this; -->
<!--       return inv(trans(min) + ((p - zero) / (one - zero)) * this.transRange()); -->
<!--     }, -->
<!--   }; -->
<!-- } -->
<!-- const expanse1 = expanseContinuous(1, 10); -->
<!-- console.log(expanse1.normalize(5)); -->
<!-- console.log(expanse1.unnormalize(0.5)) -->
<!-- ``` -->
<!-- The functions $n, u$ have several interesting properties. First off, they are inverses to each other and form an *isomorphism*, i.e. $u = n^{-1}$ and $n = u^{-1}$ such that $u(n(x)) = x$ and $n(u(p)) = p$. This also means that each function is a 1-to-1 mapping or *bijection*. In plain words, this means that we cannot get the same percentage by normalizing two different values and vice versa. As a result, we can keep switching between the normalized and unnormalized representations without losing any information:   -->
<!-- ```{r} -->
<!-- with(expanse, unnormalize(normalize(5))) -->
<!-- with(expanse, normalize(unnormalize(normalize(unnormalize(0.5))))) -->
<!-- ``` -->
<!-- ##### Linearity -->
<!-- Another important thing to note is that, while these types of normalizing functions are often called "linear" (e.g. `scaleLinear()` in **D3**), since their graphs form a straight line, they should not be confused with "linear functions", since they do not satisfy the properties of linear functions, namely: -->
<!-- - Additivity: $\text{normalize}(x + c) \neq \text{normalize}(x) + \text{normalize}(c)$ -->
<!-- - Homogeneity of degree 1: $\text{normalize}(c \cdot x) \neq c \cdot \text{normalize(x)}$. -->
<!-- To illustrate, additivity does not hold when $\min \neq 0$ because: -->
<!-- $$\frac{(x + c) - \min}{(\max - \min)}$$ -->
<!-- $$= \frac{x - \min}{\max - \min} + \frac{c}{\max - \min}$$ -->
<!-- $$\neq \frac{x - \min}{\max - min} + \frac{c - \min}{\max - \min}$$ -->
<!-- The same can be easily shown for the $\text{unnormalize}$ map and for homogeneity. -->
<!-- Technically, this is due to a confusion between the definition of a "linear function" and a "linear polynomial". The appropriate term to use would actually be "affine transformation."  -->
<!-- Either way, if the minimum is not 0, we cannot expect the following to be equal: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(3) + normalize(2))) -->
<!-- ``` -->
<!-- Or the following to be equal: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(2 * 5), 2 * normalize(5))) -->
<!-- ``` -->
<!-- However, if we keep in mind the fact that the normalizing function calculates the proportion of distance from the origin, we can see that the function in fact behaves linearly within the context of its limits. -->
<!-- For example, consider the range $[1, 10]$. The value $5$ is $4$ units away from the lower limit, i.e. $5 - 1 = 4$, so we can represent it, for example, as the sum of a value that is 3 units away and another that is one unit away, $n(5) = n(4) + n(2)$:  -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), normalize(4) + normalize(2))) -->
<!-- ``` -->
<!-- Likewise, again because $5$ represents the distance of $4$ units and $3$ of $2$, we can expect $n(5) = 2 \cdot n(3)$: -->
<!-- ```{r} -->
<!-- with(expanse, c(normalize(5), 2 * normalize(3))) -->
<!-- ``` -->
<!-- ##### Transformations -->
<!-- We can apply transformations to continuous expanses by transforming their limits. The outcome of this is that $\min$ and $\max$ still get mapped to $0$ and $1$ however, the graph of the function is no longer linear. Suppose we have non-linear function $f$, along with an inverse $f^{-1}$. Then: -->
<!-- $$n(x) = \frac{f(x) - f(\min)}{f(\max) - f(\min)}$$ -->
<!-- $$u(p) = f^{-1} \bigg\{f(\min) + p \cdot \big[ f(\max) - f(\min) \big] \bigg\}$$ -->
<!-- For example, here's how we could apply the transformation $\bigg( f(x) = \sqrt{x}, \; f^{-1}(x) = x^2 \bigg)$ in code:  -->
<!-- ```{r} -->
<!-- expanse$trans <- sqrt -->
<!-- expanse$inv <- function(x) x^2 -->
<!-- # Need to redefine normalize and unnormalize -->
<!-- expanse$trans_range <- function() with(expanse, trans(max) - trans(min)) -->
<!-- expanse$normalize <- function(x) { -->
<!--   with(expanse, (trans(x) - trans(min)) / trans_range()) -->
<!-- } -->
<!-- expanse$unnormalize <- function(p) { -->
<!--   with(expanse, inv(trans(min) + p * trans_range())) -->
<!-- } -->
<!-- # Normalizing limits still returns c(0, 1) -->
<!-- c(expanse$normalize(c(1, 10))) -->
<!-- # Notice that these return different values from before though -->
<!-- expanse$normalize(5) -->
<!-- expanse$unnormalize(0.5) -->
<!-- x <- seq(1, 10, length = 100) -->
<!-- p <- seq(0, 1, length = 100) -->
<!-- # The graphs are no longer linear -->
<!-- par(mfrow = c(1, 2)) -->
<!-- plot(x, expanse$normalize(x), type = "l", ylab = "normalize(x)") -->
<!-- plot(p, expanse$unnormalize(p), type = "l", ylab = "unnormalize(p)") -->
<!-- ``` -->
<!-- Transformations such as these can be useful in two ways. First, sometimes we may be able to better see trends in the data when the data has been appropriately transformed. This is the case, for example, when plotting data which varies across orders of magnitude. In this case it may be useful to apply $\log$-transformation. Second, transformations can also be helpful in situations where some graphical attributes are not perceived linearly. For example, when judging differently sized objects, viewers tend judge magnitude based on area rather than side or radius. As such, when drawing objects such as points or squares it can be helpful to apply square root as the inverse transformation. The idea is that, if one point has a data value that is $c$ times bigger than another, it will have $\sqrt{c}$ times bigger radius and $c$ times bigger area. Note that we are talking about the inverse transformation here, i.e. the transformation affecting the unnormalizing function. -->
<!-- One thing to note is that the proportionality of the square-root transformation holds only when $\min = 0$. Otherwise: -->
<!-- $$\sqrt{(\min)^2 + cp \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- $$= \sqrt{c} \cdot \sqrt{(\min)^2/c + p \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- $$\neq \sqrt{c} \cdot \sqrt{(\min)^2 + p \cdot [(\max)^2 - (\min)^2]}$$ -->
<!-- This is a problem in the existing packages. For example: -->
<!-- ```{r} -->
<!-- library(scales) -->
<!-- pal <- area_pal(c(1, 5)) -->
<!-- # Comparing cscale to naive implementation -->
<!-- all.equal(cscale(1:5, pal), sqrt((1:5 - 1) / 4) * 4 + 1) -->
<!-- # Should be equal since 3 is twice as far from 1 as 2 is -->
<!-- c(cscale(1:5, pal)[3] / cscale(1:5, pal)[2], -->
<!--   sqrt(2)) -->
<!-- expanse$min <- 1 -->
<!-- expanse$max <- 5 -->
<!-- cscale(1:5, pal) -->
<!-- expanse$unnormalize(1:5 / 5) -->
<!-- expanse -->
<!-- plot(1:5, expanse$unnormalize(1:5 / 5)) -->
<!-- plot(1:5, cscale(1:5, pal)) -->
<!-- ``` -->
<!-- ##  -->

</div>
</div>
</div>
</div>
<h3> References<a href="references.html#references" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bostock2011" class="csl-entry">
Bostock, Michael, Vadim Ogievetsky, and Jeffrey Heer. 2011. <span>“D<span class="math inline">\(^3\)</span> Data-Driven Documents.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 17 (12): 2301–9.
</div>
<div id="ref-fong2019" class="csl-entry">
Fong, Brendan, and David I Spivak. 2019. <em>An Invitation to Applied Category Theory: Seven Sketches in Compositionality</em>. Cambridge University Press.
</div>
<div id="ref-krzywinski2013" class="csl-entry">
Krzywinski, Martin. 2013. <span>“Axes, Ticks and Grids.”</span> <em>Nature Methods</em> 10 (February): 183. <a href="https://doi.org/10.1038/nmeth.2337">https://doi.org/10.1038/nmeth.2337</a>.
</div>
<div id="ref-lawvere2009" class="csl-entry">
Lawvere, F William, and Stephen H Schanuel. 2009. <em>Conceptual Mathematics: A First Introduction to Categories</em>. Cambridge University Press.
</div>
<div id="ref-michell1986" class="csl-entry">
Michell, Joel. 1986. <span>“Measurement Scales and Statistics: A Clash of Paradigms.”</span> <em>Psychological Bulletin</em> 100 (3): 398.
</div>
<div id="ref-murrell2005" class="csl-entry">
Murrell, Paul. 2005. <em>R Graphics</em>. Chapman; Hall/CRC.
</div>
<div id="ref-d3-scale2024" class="csl-entry">
Observable. 2024. <span>“D3-Scale <span><span class="math inline">\(\vert\)</span></span> D3 by Observable.”</span> <a href="https://d3js.org/d3-scale">https://d3js.org/d3-scale</a>.
</div>
<div id="ref-satyanarayan2015" class="csl-entry">
Satyanarayan, Arvind, Ryan Russell, Jane Hoffswell, and Jeffrey Heer. 2015. <span>“Reactive Vega: A Streaming Dataflow Architecture for Declarative Interactive Visualization.”</span> <em>IEEE Transactions on Visualization and Computer Graphics</em> 22 (1): 659–68.
</div>
<div id="ref-stevens1946" class="csl-entry">
Stevens, Stanley Smith. 1946. <span>“On the Theory of Scales of Measurement.”</span> <em>Science</em> 103 (2684): 677–80.
</div>
<div id="ref-tufte2001" class="csl-entry">
Tufte, Edward R. 2001. <em>The Visual Display of Quantitative Information</em>. Cheshire, Connecticut: Graphics Press LLC.
</div>
<div id="ref-wickham2013" class="csl-entry">
Wickham, Hadley. 2013. <span>“Bin-Summarise-Smooth: A Framework for Visualising Large Data.”</span> <em>Had. Co. Nz, Tech. Rep</em>.
</div>
<div id="ref-wickham2016" class="csl-entry">
———. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-wickham2023" class="csl-entry">
Wickham, Hadley, Thomas Lin Pedersen, and Dana Seidel. 2023. <em>Scales: Scale Functions for Visualization</em>. <a href="https://CRAN.R-project.org/package=scales">https://CRAN.R-project.org/package=scales</a>.
</div>
<div id="ref-wilkinson2012" class="csl-entry">
Wilkinson, Leland. 2012. <em>The Grammar of Graphics</em>. Springer.
</div>
<div id="ref-ziemkiewicz2009" class="csl-entry">
Ziemkiewicz, Caroline, and Robert Kosara. 2009. <span>“Embedding Information Visualization Within Visual Representation.”</span> In <em>Advances in Information and Intelligent Systems</em>, 307–26. Springer.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="high-level-design.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="glossary.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
